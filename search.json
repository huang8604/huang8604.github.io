[{"categories":null,"collections":null,"content":"å¾ˆé«˜å…´èƒ½å¸®ä½ è§£å†³é—®é¢˜ï¼è¿™æ®µç»å†éå¸¸å…¸å‹ï¼Œæ¶µç›–äº† Gerrit å‘½ä»¤è¡Œæ“ä½œã€SSH äº¤äº’æœºåˆ¶ä»¥åŠ Shell è„šæœ¬ç¼–ç¨‹çš„å‡ ä¸ªæ ¸å¿ƒå‘ç‚¹ã€‚ ä»¥ä¸‹æ˜¯æ•´ä¸ªè¿‡ç¨‹çš„å¤ç›˜ä¸æŠ€æœ¯æ€»ç»“ï¼Œæ–¹ä¾¿ä½ æ—¥åæŸ¥é˜…ï¼š ","date":"2025-11-27","objectID":"/posts/gerrit-%E6%89%B9%E9%87%8F-1-add-reviewer/:0:0","tags":["blog","å·¥å…·","å®æˆ˜"],"title":"Gerrit æ‰¹é‡+1 Add reviewer","uri":"/posts/gerrit-%E6%89%B9%E9%87%8F-1-add-reviewer/#"},{"categories":null,"collections":null,"content":"ğŸš€ æœ€ç»ˆå¯è¿è¡Œçš„å®Œæ•´å‘½ä»¤ username æ›¿æ¢è‡ªå·±çš„ç”¨æˆ·å,éœ€è¦sshæäº¤å…¬é’¥ æè®®é€šè¿‡ä¸‹é¢æŸ¥çœ‹æ˜¯å¦å¯ä»¥ ssh -p 29418 username@172.17.2.20 gerrit query \"owner:self status:open\" --format=JSON æœ€ç»ˆå‘½ä»¤ ssh -p 29418 username@172.17.2.20 gerrit query \\ \"owner:self status:open NOT label:Code-Review\u003c=-1\" \\ --current-patch-set --format=JSON \\ | jq -r 'select(.currentPatchSet) | \"\\(.id) \\(.currentPatchSet.revision)\"' \\ | while read -r changeId commitSha; do echo \"æ­£åœ¨å¤„ç†: $changeId\" # 1. æ‰“åˆ† (ä½¿ç”¨ Commit SHA ç¡®ä¿å”¯ä¸€å®šä½) ssh -n -p 29418 username@172.17.2.20 gerrit review --code-review +1 \"$commitSha\" # 2. åŠ äºº (ä½¿ç”¨ Change-Id ç¡®ä¿å…¼å®¹æ€§) ssh -n -p 29418 username@172.17.2.20 gerrit set-reviewers \\ -a xxx@AAA.com \\ -a yyy@AAA.com \\ -a zzz@AAA.com \\ \"$changeId\" done ","date":"2025-11-27","objectID":"/posts/gerrit-%E6%89%B9%E9%87%8F-1-add-reviewer/:0:1","tags":["blog","å·¥å…·","å®æˆ˜"],"title":"Gerrit æ‰¹é‡+1 Add reviewer","uri":"/posts/gerrit-%E6%89%B9%E9%87%8F-1-add-reviewer/#-æœ€ç»ˆå¯è¿è¡Œçš„å®Œæ•´å‘½ä»¤"},{"categories":null,"collections":null,"content":"ğŸ’¡ é‡åˆ°çš„å‘ä¸è§£å†³æ–¹æ¡ˆ (Technical Retrospective) æˆ‘ä»¬åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­è§£å†³äº†ä»¥ä¸‹ä¸‰ä¸ªä¸»è¦æŠ€æœ¯éšœç¢ï¼š 1. æŸ¥è¯¢è¯­æ³•çš„å‚æ•°å†²çª é—®é¢˜ï¼šä½¿ç”¨ -label:Code-Review\u003c=-1 æ—¶æŠ¥é”™ fatal: is not a valid optionã€‚ åŸå› ï¼šSSH è¿œç¨‹æ‰§è¡Œå‘½ä»¤æ—¶ï¼Œä¼šå°†ä»¥ - å¼€å¤´çš„å­—ç¬¦ä¸²è¯¯åˆ¤ä¸ºå‘½ä»¤è¡Œé€‰é¡¹ï¼ˆOptionsï¼‰ï¼Œè€Œä¸æ˜¯æŸ¥è¯¢è¯­å¥ã€‚ âœ… è§£å†³ï¼šå°† - æ›¿æ¢ä¸ºå¤§å†™çš„ NOT å…³é”®å­—ï¼ˆGerrit æŸ¥è¯¢è¯­è¨€æ”¯æŒï¼‰ï¼Œé¿å…æ­§ä¹‰ã€‚ 2. Gerrit ç‰ˆæœ¬å…¼å®¹æ€§ä¸ ID å®šä½ é—®é¢˜ï¼š Gerrit v2.16 çš„ gerrit review å‘½ä»¤ä¸æ”¯æŒåŒæ—¶åŠ  Reviewer (--reviewer å‚æ•°æ— æ•ˆ)ã€‚ ä½¿ç”¨æ•°å­— ID (å¦‚ 83376) æˆ– ID,PatchSet æ ¼å¼æ—¶ï¼ŒæŠ¥ no such change/patch setã€‚ åŸå› ï¼šæ—§ç‰ˆæœ¬ API é™åˆ¶ï¼›ä¸”æ•°å­— ID åœ¨æŸäº›æƒ…å†µä¸‹æ— æ³•ç²¾å‡†æ˜ å°„åˆ°å½“å‰çš„ Patch Setã€‚ âœ… è§£å†³ï¼š æ‹†åˆ†åŠ¨ä½œï¼šå°†æ“ä½œæ‹†åˆ†ä¸º gerrit review (æ‰“åˆ†) å’Œ gerrit set-reviewers (åŠ äºº)ã€‚ ç²¾å‡†å®šä½ï¼šæ‰“åˆ†æ—¶ä½¿ç”¨ Commit SHAï¼ˆç‰©ç†å”¯ä¸€ï¼‰ï¼ŒåŠ äººæ—¶ä½¿ç”¨ Change-Idï¼ˆé€»è¾‘å”¯ä¸€ï¼‰ã€‚ 3. SSH åå™¬æ ‡å‡†è¾“å…¥ (The SSH Loop Trap) é—®é¢˜ï¼šè„šæœ¬åªå¤„ç†äº†åˆ—è¡¨ä¸­çš„ç¬¬ä¸€æ¡è®°å½•å°±åœæ­¢äº†ã€‚ åŸå› ï¼šåœ¨ while å¾ªç¯å†…éƒ¨æ‰§è¡Œ ssh æ—¶ï¼ŒSSH é»˜è®¤ä¼šè¯»å–æ‰€æœ‰çš„ Standard Input (stdin)ã€‚è¿™æ„å‘³ç€å¾ªç¯é‡Œçš„ç¬¬ä¸€ä¸ª ssh æŠŠç®¡é“é‡Œå‰©ä¸‹çš„ Change åˆ—è¡¨å…¨â€œåƒâ€å…‰äº†ï¼Œå¯¼è‡´ while å¾ªç¯ä»¥ä¸ºæ²¡æœ‰æ•°æ®äº†ã€‚ âœ… è§£å†³ï¼šç»™å¾ªç¯å†…éƒ¨çš„ ssh å‘½ä»¤æ·»åŠ  -n å‚æ•°ã€‚è¿™å‘Šè¯‰ SSHï¼šâ€œä¸è¦è¯»å–æ ‡å‡†è¾“å…¥ï¼Œåªç®¡æ‰§è¡Œå‘½ä»¤â€ã€‚è¿™æ · stdin é‡Œçš„æ•°æ®å°±èƒ½ä¿ç•™ç»™ while å¾ªç¯ç»§ç»­è¯»å–ã€‚ 4. æ•°æ®è§£æéƒ¨åˆ† (| jq ...)ï¼š é—®é¢˜ï¼š jq -r 'select(.number) | .number'ï¼šgerrit query æœ€åä¼šè¾“å‡ºä¸€è¡Œç»Ÿè®¡ä¿¡æ¯ï¼ˆstatsï¼‰ï¼Œè¿™è¡Œæ²¡æœ‰ number å­—æ®µã€‚è¿™æ®µä»£ç ä¼šè¿‡æ»¤æ‰ç»Ÿè®¡è¡Œï¼Œåªæå–å‡ºå˜æ›´ç¼–å· (Change Number)ã€‚ æ³¨æ„ï¼šå¦‚æœæ²¡æœ‰å®‰è£… jqï¼Œä½ éœ€è¦å…ˆå®‰è£…å®ƒ (å¦‚ sudo apt-get install jq æˆ– brew install jq)ï¼Œæˆ–è€…ä½¿ç”¨å¤æ‚çš„ grep/awk æ›¿æ¢ã€‚ ","date":"2025-11-27","objectID":"/posts/gerrit-%E6%89%B9%E9%87%8F-1-add-reviewer/:0:2","tags":["blog","å·¥å…·","å®æˆ˜"],"title":"Gerrit æ‰¹é‡+1 Add reviewer","uri":"/posts/gerrit-%E6%89%B9%E9%87%8F-1-add-reviewer/#-é‡åˆ°çš„å‘ä¸è§£å†³æ–¹æ¡ˆ-technical-retrospective"},{"categories":null,"collections":null,"content":"ğŸ’¡ é‡åˆ°çš„å‘ä¸è§£å†³æ–¹æ¡ˆ (Technical Retrospective) æˆ‘ä»¬åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­è§£å†³äº†ä»¥ä¸‹ä¸‰ä¸ªä¸»è¦æŠ€æœ¯éšœç¢ï¼š 1. æŸ¥è¯¢è¯­æ³•çš„å‚æ•°å†²çª é—®é¢˜ï¼šä½¿ç”¨ -label:Code-Review\u003c=-1 æ—¶æŠ¥é”™ fatal: is not a valid optionã€‚ åŸå› ï¼šSSH è¿œç¨‹æ‰§è¡Œå‘½ä»¤æ—¶ï¼Œä¼šå°†ä»¥ - å¼€å¤´çš„å­—ç¬¦ä¸²è¯¯åˆ¤ä¸ºå‘½ä»¤è¡Œé€‰é¡¹ï¼ˆOptionsï¼‰ï¼Œè€Œä¸æ˜¯æŸ¥è¯¢è¯­å¥ã€‚ âœ… è§£å†³ï¼šå°† - æ›¿æ¢ä¸ºå¤§å†™çš„ NOT å…³é”®å­—ï¼ˆGerrit æŸ¥è¯¢è¯­è¨€æ”¯æŒï¼‰ï¼Œé¿å…æ­§ä¹‰ã€‚ 2. Gerrit ç‰ˆæœ¬å…¼å®¹æ€§ä¸ ID å®šä½ é—®é¢˜ï¼š Gerrit v2.16 çš„ gerrit review å‘½ä»¤ä¸æ”¯æŒåŒæ—¶åŠ  Reviewer (--reviewer å‚æ•°æ— æ•ˆ)ã€‚ ä½¿ç”¨æ•°å­— ID (å¦‚ 83376) æˆ– ID,PatchSet æ ¼å¼æ—¶ï¼ŒæŠ¥ no such change/patch setã€‚ åŸå› ï¼šæ—§ç‰ˆæœ¬ API é™åˆ¶ï¼›ä¸”æ•°å­— ID åœ¨æŸäº›æƒ…å†µä¸‹æ— æ³•ç²¾å‡†æ˜ å°„åˆ°å½“å‰çš„ Patch Setã€‚ âœ… è§£å†³ï¼š æ‹†åˆ†åŠ¨ä½œï¼šå°†æ“ä½œæ‹†åˆ†ä¸º gerrit review (æ‰“åˆ†) å’Œ gerrit set-reviewers (åŠ äºº)ã€‚ ç²¾å‡†å®šä½ï¼šæ‰“åˆ†æ—¶ä½¿ç”¨ Commit SHAï¼ˆç‰©ç†å”¯ä¸€ï¼‰ï¼ŒåŠ äººæ—¶ä½¿ç”¨ Change-Idï¼ˆé€»è¾‘å”¯ä¸€ï¼‰ã€‚ 3. SSH åå™¬æ ‡å‡†è¾“å…¥ (The SSH Loop Trap) é—®é¢˜ï¼šè„šæœ¬åªå¤„ç†äº†åˆ—è¡¨ä¸­çš„ç¬¬ä¸€æ¡è®°å½•å°±åœæ­¢äº†ã€‚ åŸå› ï¼šåœ¨ while å¾ªç¯å†…éƒ¨æ‰§è¡Œ ssh æ—¶ï¼ŒSSH é»˜è®¤ä¼šè¯»å–æ‰€æœ‰çš„ Standard Input (stdin)ã€‚è¿™æ„å‘³ç€å¾ªç¯é‡Œçš„ç¬¬ä¸€ä¸ª ssh æŠŠç®¡é“é‡Œå‰©ä¸‹çš„ Change åˆ—è¡¨å…¨â€œåƒâ€å…‰äº†ï¼Œå¯¼è‡´ while å¾ªç¯ä»¥ä¸ºæ²¡æœ‰æ•°æ®äº†ã€‚ âœ… è§£å†³ï¼šç»™å¾ªç¯å†…éƒ¨çš„ ssh å‘½ä»¤æ·»åŠ  -n å‚æ•°ã€‚è¿™å‘Šè¯‰ SSHï¼šâ€œä¸è¦è¯»å–æ ‡å‡†è¾“å…¥ï¼Œåªç®¡æ‰§è¡Œå‘½ä»¤â€ã€‚è¿™æ · stdin é‡Œçš„æ•°æ®å°±èƒ½ä¿ç•™ç»™ while å¾ªç¯ç»§ç»­è¯»å–ã€‚ 4. æ•°æ®è§£æéƒ¨åˆ† (| jq ...)ï¼š é—®é¢˜ï¼š jq -r 'select(.number) | .number'ï¼šgerrit query æœ€åä¼šè¾“å‡ºä¸€è¡Œç»Ÿè®¡ä¿¡æ¯ï¼ˆstatsï¼‰ï¼Œè¿™è¡Œæ²¡æœ‰ number å­—æ®µã€‚è¿™æ®µä»£ç ä¼šè¿‡æ»¤æ‰ç»Ÿè®¡è¡Œï¼Œåªæå–å‡ºå˜æ›´ç¼–å· (Change Number)ã€‚ æ³¨æ„ï¼šå¦‚æœæ²¡æœ‰å®‰è£… jqï¼Œä½ éœ€è¦å…ˆå®‰è£…å®ƒ (å¦‚ sudo apt-get install jq æˆ– brew install jq)ï¼Œæˆ–è€…ä½¿ç”¨å¤æ‚çš„ grep/awk æ›¿æ¢ã€‚ ","date":"2025-11-27","objectID":"/posts/gerrit-%E6%89%B9%E9%87%8F-1-add-reviewer/:0:2","tags":["blog","å·¥å…·","å®æˆ˜"],"title":"Gerrit æ‰¹é‡+1 Add reviewer","uri":"/posts/gerrit-%E6%89%B9%E9%87%8F-1-add-reviewer/#1-æŸ¥è¯¢è¯­æ³•çš„å‚æ•°å†²çª"},{"categories":null,"collections":null,"content":"ğŸ’¡ é‡åˆ°çš„å‘ä¸è§£å†³æ–¹æ¡ˆ (Technical Retrospective) æˆ‘ä»¬åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­è§£å†³äº†ä»¥ä¸‹ä¸‰ä¸ªä¸»è¦æŠ€æœ¯éšœç¢ï¼š 1. æŸ¥è¯¢è¯­æ³•çš„å‚æ•°å†²çª é—®é¢˜ï¼šä½¿ç”¨ -label:Code-Review\u003c=-1 æ—¶æŠ¥é”™ fatal: is not a valid optionã€‚ åŸå› ï¼šSSH è¿œç¨‹æ‰§è¡Œå‘½ä»¤æ—¶ï¼Œä¼šå°†ä»¥ - å¼€å¤´çš„å­—ç¬¦ä¸²è¯¯åˆ¤ä¸ºå‘½ä»¤è¡Œé€‰é¡¹ï¼ˆOptionsï¼‰ï¼Œè€Œä¸æ˜¯æŸ¥è¯¢è¯­å¥ã€‚ âœ… è§£å†³ï¼šå°† - æ›¿æ¢ä¸ºå¤§å†™çš„ NOT å…³é”®å­—ï¼ˆGerrit æŸ¥è¯¢è¯­è¨€æ”¯æŒï¼‰ï¼Œé¿å…æ­§ä¹‰ã€‚ 2. Gerrit ç‰ˆæœ¬å…¼å®¹æ€§ä¸ ID å®šä½ é—®é¢˜ï¼š Gerrit v2.16 çš„ gerrit review å‘½ä»¤ä¸æ”¯æŒåŒæ—¶åŠ  Reviewer (--reviewer å‚æ•°æ— æ•ˆ)ã€‚ ä½¿ç”¨æ•°å­— ID (å¦‚ 83376) æˆ– ID,PatchSet æ ¼å¼æ—¶ï¼ŒæŠ¥ no such change/patch setã€‚ åŸå› ï¼šæ—§ç‰ˆæœ¬ API é™åˆ¶ï¼›ä¸”æ•°å­— ID åœ¨æŸäº›æƒ…å†µä¸‹æ— æ³•ç²¾å‡†æ˜ å°„åˆ°å½“å‰çš„ Patch Setã€‚ âœ… è§£å†³ï¼š æ‹†åˆ†åŠ¨ä½œï¼šå°†æ“ä½œæ‹†åˆ†ä¸º gerrit review (æ‰“åˆ†) å’Œ gerrit set-reviewers (åŠ äºº)ã€‚ ç²¾å‡†å®šä½ï¼šæ‰“åˆ†æ—¶ä½¿ç”¨ Commit SHAï¼ˆç‰©ç†å”¯ä¸€ï¼‰ï¼ŒåŠ äººæ—¶ä½¿ç”¨ Change-Idï¼ˆé€»è¾‘å”¯ä¸€ï¼‰ã€‚ 3. SSH åå™¬æ ‡å‡†è¾“å…¥ (The SSH Loop Trap) é—®é¢˜ï¼šè„šæœ¬åªå¤„ç†äº†åˆ—è¡¨ä¸­çš„ç¬¬ä¸€æ¡è®°å½•å°±åœæ­¢äº†ã€‚ åŸå› ï¼šåœ¨ while å¾ªç¯å†…éƒ¨æ‰§è¡Œ ssh æ—¶ï¼ŒSSH é»˜è®¤ä¼šè¯»å–æ‰€æœ‰çš„ Standard Input (stdin)ã€‚è¿™æ„å‘³ç€å¾ªç¯é‡Œçš„ç¬¬ä¸€ä¸ª ssh æŠŠç®¡é“é‡Œå‰©ä¸‹çš„ Change åˆ—è¡¨å…¨â€œåƒâ€å…‰äº†ï¼Œå¯¼è‡´ while å¾ªç¯ä»¥ä¸ºæ²¡æœ‰æ•°æ®äº†ã€‚ âœ… è§£å†³ï¼šç»™å¾ªç¯å†…éƒ¨çš„ ssh å‘½ä»¤æ·»åŠ  -n å‚æ•°ã€‚è¿™å‘Šè¯‰ SSHï¼šâ€œä¸è¦è¯»å–æ ‡å‡†è¾“å…¥ï¼Œåªç®¡æ‰§è¡Œå‘½ä»¤â€ã€‚è¿™æ · stdin é‡Œçš„æ•°æ®å°±èƒ½ä¿ç•™ç»™ while å¾ªç¯ç»§ç»­è¯»å–ã€‚ 4. æ•°æ®è§£æéƒ¨åˆ† (| jq ...)ï¼š é—®é¢˜ï¼š jq -r 'select(.number) | .number'ï¼šgerrit query æœ€åä¼šè¾“å‡ºä¸€è¡Œç»Ÿè®¡ä¿¡æ¯ï¼ˆstatsï¼‰ï¼Œè¿™è¡Œæ²¡æœ‰ number å­—æ®µã€‚è¿™æ®µä»£ç ä¼šè¿‡æ»¤æ‰ç»Ÿè®¡è¡Œï¼Œåªæå–å‡ºå˜æ›´ç¼–å· (Change Number)ã€‚ æ³¨æ„ï¼šå¦‚æœæ²¡æœ‰å®‰è£… jqï¼Œä½ éœ€è¦å…ˆå®‰è£…å®ƒ (å¦‚ sudo apt-get install jq æˆ– brew install jq)ï¼Œæˆ–è€…ä½¿ç”¨å¤æ‚çš„ grep/awk æ›¿æ¢ã€‚ ","date":"2025-11-27","objectID":"/posts/gerrit-%E6%89%B9%E9%87%8F-1-add-reviewer/:0:2","tags":["blog","å·¥å…·","å®æˆ˜"],"title":"Gerrit æ‰¹é‡+1 Add reviewer","uri":"/posts/gerrit-%E6%89%B9%E9%87%8F-1-add-reviewer/#2-gerrit-ç‰ˆæœ¬å…¼å®¹æ€§ä¸-id-å®šä½"},{"categories":null,"collections":null,"content":"ğŸ’¡ é‡åˆ°çš„å‘ä¸è§£å†³æ–¹æ¡ˆ (Technical Retrospective) æˆ‘ä»¬åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­è§£å†³äº†ä»¥ä¸‹ä¸‰ä¸ªä¸»è¦æŠ€æœ¯éšœç¢ï¼š 1. æŸ¥è¯¢è¯­æ³•çš„å‚æ•°å†²çª é—®é¢˜ï¼šä½¿ç”¨ -label:Code-Review\u003c=-1 æ—¶æŠ¥é”™ fatal: is not a valid optionã€‚ åŸå› ï¼šSSH è¿œç¨‹æ‰§è¡Œå‘½ä»¤æ—¶ï¼Œä¼šå°†ä»¥ - å¼€å¤´çš„å­—ç¬¦ä¸²è¯¯åˆ¤ä¸ºå‘½ä»¤è¡Œé€‰é¡¹ï¼ˆOptionsï¼‰ï¼Œè€Œä¸æ˜¯æŸ¥è¯¢è¯­å¥ã€‚ âœ… è§£å†³ï¼šå°† - æ›¿æ¢ä¸ºå¤§å†™çš„ NOT å…³é”®å­—ï¼ˆGerrit æŸ¥è¯¢è¯­è¨€æ”¯æŒï¼‰ï¼Œé¿å…æ­§ä¹‰ã€‚ 2. Gerrit ç‰ˆæœ¬å…¼å®¹æ€§ä¸ ID å®šä½ é—®é¢˜ï¼š Gerrit v2.16 çš„ gerrit review å‘½ä»¤ä¸æ”¯æŒåŒæ—¶åŠ  Reviewer (--reviewer å‚æ•°æ— æ•ˆ)ã€‚ ä½¿ç”¨æ•°å­— ID (å¦‚ 83376) æˆ– ID,PatchSet æ ¼å¼æ—¶ï¼ŒæŠ¥ no such change/patch setã€‚ åŸå› ï¼šæ—§ç‰ˆæœ¬ API é™åˆ¶ï¼›ä¸”æ•°å­— ID åœ¨æŸäº›æƒ…å†µä¸‹æ— æ³•ç²¾å‡†æ˜ å°„åˆ°å½“å‰çš„ Patch Setã€‚ âœ… è§£å†³ï¼š æ‹†åˆ†åŠ¨ä½œï¼šå°†æ“ä½œæ‹†åˆ†ä¸º gerrit review (æ‰“åˆ†) å’Œ gerrit set-reviewers (åŠ äºº)ã€‚ ç²¾å‡†å®šä½ï¼šæ‰“åˆ†æ—¶ä½¿ç”¨ Commit SHAï¼ˆç‰©ç†å”¯ä¸€ï¼‰ï¼ŒåŠ äººæ—¶ä½¿ç”¨ Change-Idï¼ˆé€»è¾‘å”¯ä¸€ï¼‰ã€‚ 3. SSH åå™¬æ ‡å‡†è¾“å…¥ (The SSH Loop Trap) é—®é¢˜ï¼šè„šæœ¬åªå¤„ç†äº†åˆ—è¡¨ä¸­çš„ç¬¬ä¸€æ¡è®°å½•å°±åœæ­¢äº†ã€‚ åŸå› ï¼šåœ¨ while å¾ªç¯å†…éƒ¨æ‰§è¡Œ ssh æ—¶ï¼ŒSSH é»˜è®¤ä¼šè¯»å–æ‰€æœ‰çš„ Standard Input (stdin)ã€‚è¿™æ„å‘³ç€å¾ªç¯é‡Œçš„ç¬¬ä¸€ä¸ª ssh æŠŠç®¡é“é‡Œå‰©ä¸‹çš„ Change åˆ—è¡¨å…¨â€œåƒâ€å…‰äº†ï¼Œå¯¼è‡´ while å¾ªç¯ä»¥ä¸ºæ²¡æœ‰æ•°æ®äº†ã€‚ âœ… è§£å†³ï¼šç»™å¾ªç¯å†…éƒ¨çš„ ssh å‘½ä»¤æ·»åŠ  -n å‚æ•°ã€‚è¿™å‘Šè¯‰ SSHï¼šâ€œä¸è¦è¯»å–æ ‡å‡†è¾“å…¥ï¼Œåªç®¡æ‰§è¡Œå‘½ä»¤â€ã€‚è¿™æ · stdin é‡Œçš„æ•°æ®å°±èƒ½ä¿ç•™ç»™ while å¾ªç¯ç»§ç»­è¯»å–ã€‚ 4. æ•°æ®è§£æéƒ¨åˆ† (| jq ...)ï¼š é—®é¢˜ï¼š jq -r 'select(.number) | .number'ï¼šgerrit query æœ€åä¼šè¾“å‡ºä¸€è¡Œç»Ÿè®¡ä¿¡æ¯ï¼ˆstatsï¼‰ï¼Œè¿™è¡Œæ²¡æœ‰ number å­—æ®µã€‚è¿™æ®µä»£ç ä¼šè¿‡æ»¤æ‰ç»Ÿè®¡è¡Œï¼Œåªæå–å‡ºå˜æ›´ç¼–å· (Change Number)ã€‚ æ³¨æ„ï¼šå¦‚æœæ²¡æœ‰å®‰è£… jqï¼Œä½ éœ€è¦å…ˆå®‰è£…å®ƒ (å¦‚ sudo apt-get install jq æˆ– brew install jq)ï¼Œæˆ–è€…ä½¿ç”¨å¤æ‚çš„ grep/awk æ›¿æ¢ã€‚ ","date":"2025-11-27","objectID":"/posts/gerrit-%E6%89%B9%E9%87%8F-1-add-reviewer/:0:2","tags":["blog","å·¥å…·","å®æˆ˜"],"title":"Gerrit æ‰¹é‡+1 Add reviewer","uri":"/posts/gerrit-%E6%89%B9%E9%87%8F-1-add-reviewer/#3-ssh-åå™¬æ ‡å‡†è¾“å…¥-the-ssh-loop-trap"},{"categories":null,"collections":null,"content":"ğŸ’¡ é‡åˆ°çš„å‘ä¸è§£å†³æ–¹æ¡ˆ (Technical Retrospective) æˆ‘ä»¬åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­è§£å†³äº†ä»¥ä¸‹ä¸‰ä¸ªä¸»è¦æŠ€æœ¯éšœç¢ï¼š 1. æŸ¥è¯¢è¯­æ³•çš„å‚æ•°å†²çª é—®é¢˜ï¼šä½¿ç”¨ -label:Code-Review\u003c=-1 æ—¶æŠ¥é”™ fatal: is not a valid optionã€‚ åŸå› ï¼šSSH è¿œç¨‹æ‰§è¡Œå‘½ä»¤æ—¶ï¼Œä¼šå°†ä»¥ - å¼€å¤´çš„å­—ç¬¦ä¸²è¯¯åˆ¤ä¸ºå‘½ä»¤è¡Œé€‰é¡¹ï¼ˆOptionsï¼‰ï¼Œè€Œä¸æ˜¯æŸ¥è¯¢è¯­å¥ã€‚ âœ… è§£å†³ï¼šå°† - æ›¿æ¢ä¸ºå¤§å†™çš„ NOT å…³é”®å­—ï¼ˆGerrit æŸ¥è¯¢è¯­è¨€æ”¯æŒï¼‰ï¼Œé¿å…æ­§ä¹‰ã€‚ 2. Gerrit ç‰ˆæœ¬å…¼å®¹æ€§ä¸ ID å®šä½ é—®é¢˜ï¼š Gerrit v2.16 çš„ gerrit review å‘½ä»¤ä¸æ”¯æŒåŒæ—¶åŠ  Reviewer (--reviewer å‚æ•°æ— æ•ˆ)ã€‚ ä½¿ç”¨æ•°å­— ID (å¦‚ 83376) æˆ– ID,PatchSet æ ¼å¼æ—¶ï¼ŒæŠ¥ no such change/patch setã€‚ åŸå› ï¼šæ—§ç‰ˆæœ¬ API é™åˆ¶ï¼›ä¸”æ•°å­— ID åœ¨æŸäº›æƒ…å†µä¸‹æ— æ³•ç²¾å‡†æ˜ å°„åˆ°å½“å‰çš„ Patch Setã€‚ âœ… è§£å†³ï¼š æ‹†åˆ†åŠ¨ä½œï¼šå°†æ“ä½œæ‹†åˆ†ä¸º gerrit review (æ‰“åˆ†) å’Œ gerrit set-reviewers (åŠ äºº)ã€‚ ç²¾å‡†å®šä½ï¼šæ‰“åˆ†æ—¶ä½¿ç”¨ Commit SHAï¼ˆç‰©ç†å”¯ä¸€ï¼‰ï¼ŒåŠ äººæ—¶ä½¿ç”¨ Change-Idï¼ˆé€»è¾‘å”¯ä¸€ï¼‰ã€‚ 3. SSH åå™¬æ ‡å‡†è¾“å…¥ (The SSH Loop Trap) é—®é¢˜ï¼šè„šæœ¬åªå¤„ç†äº†åˆ—è¡¨ä¸­çš„ç¬¬ä¸€æ¡è®°å½•å°±åœæ­¢äº†ã€‚ åŸå› ï¼šåœ¨ while å¾ªç¯å†…éƒ¨æ‰§è¡Œ ssh æ—¶ï¼ŒSSH é»˜è®¤ä¼šè¯»å–æ‰€æœ‰çš„ Standard Input (stdin)ã€‚è¿™æ„å‘³ç€å¾ªç¯é‡Œçš„ç¬¬ä¸€ä¸ª ssh æŠŠç®¡é“é‡Œå‰©ä¸‹çš„ Change åˆ—è¡¨å…¨â€œåƒâ€å…‰äº†ï¼Œå¯¼è‡´ while å¾ªç¯ä»¥ä¸ºæ²¡æœ‰æ•°æ®äº†ã€‚ âœ… è§£å†³ï¼šç»™å¾ªç¯å†…éƒ¨çš„ ssh å‘½ä»¤æ·»åŠ  -n å‚æ•°ã€‚è¿™å‘Šè¯‰ SSHï¼šâ€œä¸è¦è¯»å–æ ‡å‡†è¾“å…¥ï¼Œåªç®¡æ‰§è¡Œå‘½ä»¤â€ã€‚è¿™æ · stdin é‡Œçš„æ•°æ®å°±èƒ½ä¿ç•™ç»™ while å¾ªç¯ç»§ç»­è¯»å–ã€‚ 4. æ•°æ®è§£æéƒ¨åˆ† (| jq ...)ï¼š é—®é¢˜ï¼š jq -r 'select(.number) | .number'ï¼šgerrit query æœ€åä¼šè¾“å‡ºä¸€è¡Œç»Ÿè®¡ä¿¡æ¯ï¼ˆstatsï¼‰ï¼Œè¿™è¡Œæ²¡æœ‰ number å­—æ®µã€‚è¿™æ®µä»£ç ä¼šè¿‡æ»¤æ‰ç»Ÿè®¡è¡Œï¼Œåªæå–å‡ºå˜æ›´ç¼–å· (Change Number)ã€‚ æ³¨æ„ï¼šå¦‚æœæ²¡æœ‰å®‰è£… jqï¼Œä½ éœ€è¦å…ˆå®‰è£…å®ƒ (å¦‚ sudo apt-get install jq æˆ– brew install jq)ï¼Œæˆ–è€…ä½¿ç”¨å¤æ‚çš„ grep/awk æ›¿æ¢ã€‚ ","date":"2025-11-27","objectID":"/posts/gerrit-%E6%89%B9%E9%87%8F-1-add-reviewer/:0:2","tags":["blog","å·¥å…·","å®æˆ˜"],"title":"Gerrit æ‰¹é‡+1 Add reviewer","uri":"/posts/gerrit-%E6%89%B9%E9%87%8F-1-add-reviewer/#4-æ•°æ®è§£æéƒ¨åˆ†-"},{"categories":null,"collections":null,"content":"ğŸ“š æ ¸å¿ƒé€»è¾‘æµç¨‹å›¾ Query: ç­›é€‰å‡º Owner æ˜¯ä½ ã€Open çŠ¶æ€ã€ä¸”æ²¡æœ‰è´Ÿåˆ†çš„æäº¤ã€‚ å‚æ•° --current-patch-set æ‹¿åˆ°äº†å…³é”®çš„ Commit SHAã€‚ Parse (jq): æå–å‡ºæ¯ä¸€è¡Œçš„ Change-Id (Ixxxxâ€¦) å’Œ Commit SHA (9e36â€¦)ã€‚ Loop: Step A: ssh -n ... review -\u003e é’ˆå¯¹ SHA æ‰“ +1ã€‚ Step B: ssh -n ... set-reviewers -\u003e é’ˆå¯¹ Change-Id åŠ äººã€‚ è¿™æ¡å‘½ä»¤ç°åœ¨éå¸¸å¥å£®ï¼Œå³ä½¿ä»¥åä½ è¦æ‰¹é‡æ“ä½œå‡ ç™¾ä¸ªæäº¤ï¼Œå®ƒä¹Ÿèƒ½ç¨³å®šè¿è¡Œï¼ ","date":"2025-11-27","objectID":"/posts/gerrit-%E6%89%B9%E9%87%8F-1-add-reviewer/:0:3","tags":["blog","å·¥å…·","å®æˆ˜"],"title":"Gerrit æ‰¹é‡+1 Add reviewer","uri":"/posts/gerrit-%E6%89%B9%E9%87%8F-1-add-reviewer/#-æ ¸å¿ƒé€»è¾‘æµç¨‹å›¾"},{"categories":["Android"],"collections":["WMS"],"content":" é«˜é€šå›å¤å®¹é‡ç–‘é—® caseä¸­æåˆ°çš„resize/recoveryï¼Œå°±æ˜¯æˆ‘ä»¬ä¹‹å‰æåˆ°çš„æ¢å¤å‡ºå‚è®¾ç½®åuserdataæ‹“å±•åˆ°å‰©ä½™ç©ºé—´ï¼Œ16Gå˜32Gçš„åŠ¨ä½œã€‚ æŒ‰é«˜é€šçš„å›å¤æˆªå›¾ï¼Œresize/recoveryä¹‹å‰ uiä¸Šé¢æ˜¾ç¤ºçš„æ€»ç©ºé—´/å·²ç”¨ç©ºé—´å¤§å°æ²¡æœ‰ä»»ä½•å‚è€ƒæ„ä¹‰ï¼ˆå‚è€ƒæˆªå›¾ç¬¬å››æ®µè½æœ€åä¸€è¡Œã€‚è¿™é‡Œæåˆ°çš„ä¸å¯ä¿¡å¤§å°å°±æ˜¯ä¹‹å‰ä½ ä»¬çœ‹åˆ°çš„ä¸‹è½½è½¯ä»¶åå¼€æœºï¼Œç³»ç»Ÿå ç”¨16Gï¼Œæ€»å®¹é‡32Gï¼‰ é«˜é€šè®¤ä¸ºresizeä¹‹åï¼Œæ­¤æ—¶UIä¸Šæ˜¾ç¤ºçš„å­˜å‚¨ç©ºé—´æ•°æ®æ˜¯å¯ä¿¡çš„ï¼ˆå‚è€ƒæˆªå›¾å€’æ•°ç¬¬ä¸‰è¡Œï¼Œè¿™é‡Œæåˆ°çš„å¯ä¿¡å¤§å°å°±æ˜¯ä½ ä»¬äº†è§£çš„æ¢å¤å‡ºå‚è®¾ç½®åç³»ç»Ÿå ç”¨32Gï¼Œæ€»å®¹é‡64Gã€‚æˆ‘ä»¬å’Œé«˜é€šåœ¨caseä¸Šæ²Ÿé€šæ—¶æä¾›çš„æœºå™¨æ•°æ®æ˜¯åŸºäº128Gçš„ï¼Œæ‰€ä»¥é«˜é€šåœ¨å¼•ç”¨æ•°æ®æ—¶å†™çš„æ˜¯128Gï¼‰ å¦å¤–ï¼Œç›®å‰PNC560æˆ‘ä»¬å·²ä¿®æ”¹ä¸ºä¸‹è½½è½¯ä»¶åå¼€æœºæ—¶è‡ªåŠ¨æ‹“å±•ï¼Œæ— éœ€å†æ¬¡æ¢å¤å‡ºå‚è®¾ç½®äº†ï¼Œæ‰€ä»¥ç”¨æˆ·æ˜¯çœ‹ä¸åˆ°16Gç³»ç»Ÿå ç”¨è¿™ä¸ªresizeä¹‹å‰çš„æ•°æ®çš„ã€‚ é«˜é€šçš„è¡¥å…… New Comment from Qualcomm engineer: â€œDear Customer, æˆ‘æƒ³ä½ æˆ‘éƒ½æ¼è€ƒè™‘äº†ä¸€ç‚¹ï¼Œæ‰€æœ‰ufsçš„å®é™…å®¹é‡éƒ½ä¸æ˜¯æ ‡ç§°å®¹é‡ï¼Œå¤§çº¦ç›¸å½“äºæ ‡ç§°å®¹é‡çš„93%å·¦å³ï¼ˆè¿™ä¸€ç‚¹åœ¨vendoræä¾›çš„ specificationæ–‡æ¡£ä¸­åº”è¯¥æœ‰å†™ï¼Œä½ å¯ä»¥è‡ªè¡ŒæŸ¥é˜…æˆ–å‘vendoræ±‚è¯ï¼‰ æ¯”å¦‚ä¸€ä¸ªæ ‡ç§°å®¹é‡64Gçš„Hynix UFSï¼Œ å®ƒçš„å®é™…å®¹é‡å…¶å®æ˜¯59G LUN0 çš„å®é™…å®¹é‡æ˜¯ 59 - 6 = 53G userdata ç†è®ºä¸Šå‰©ä¸‹çš„å®¹é‡æ˜¯ 53 - 15 = 38G å¹¶æ²¡æœ‰ä½ è¯´çš„é‚£ä¹ˆå¤¸å¼ ï¼Œè€Œä¸”æˆ‘ä»¬çš„è®¡ç®—å¹¶æ²¡æœ‰è€ƒè™‘å› ä¸ºç‰©ç†blockå¯¹é½è€Œæ²¡æœ‰è¢«åˆ†é…çš„éƒ¨åˆ†ç©ºé—´ï¼Œä»¥åŠaptåˆ†åŒºè¡¨ï¼ˆmain + backï¼‰æ‰€å ç”¨çš„ç©ºé—´ï¼Œè¿™éƒ¨åˆ†åœ¨partition.xml å’Œ æ“ä½œç³»ç»Ÿä¸­éƒ½æ˜¯ä¸å¯è§çš„ã€‚ æµ·èƒ½è¾¾ç–‘é—® ","date":"2025-11-21","objectID":"/posts/android-%E8%AE%B0%E5%BD%95%E7%B3%BB%E7%BB%9F%E7%A9%BA%E9%97%B4%E7%9A%84%E9%AB%98%E9%80%9A%E7%AD%94%E7%96%91/:0:0","tags":["blog"],"title":"Android è®°å½•ç³»ç»Ÿç©ºé—´çš„é«˜é€šç­”ç–‘","uri":"/posts/android-%E8%AE%B0%E5%BD%95%E7%B3%BB%E7%BB%9F%E7%A9%BA%E9%97%B4%E7%9A%84%E9%AB%98%E9%80%9A%E7%AD%94%E7%96%91/#"},{"categories":["Android"],"collections":["WMS"],"content":"New Comment: â€œä½ å¥½ï¼ æˆ‘ä»¬æŠŠä½ ç»™çš„è¯´æ˜(4/8/2022 1:58 AM)åé¦ˆç»™å®¢æˆ·äº†ï¼Œä¸‹é¢æ˜¯å®¢æˆ·çš„å›å¤ï¼š ","date":"2025-11-21","objectID":"/posts/android-%E8%AE%B0%E5%BD%95%E7%B3%BB%E7%BB%9F%E7%A9%BA%E9%97%B4%E7%9A%84%E9%AB%98%E9%80%9A%E7%AD%94%E7%96%91/:0:0","tags":["blog"],"title":"Android è®°å½•ç³»ç»Ÿç©ºé—´çš„é«˜é€šç­”ç–‘","uri":"/posts/android-%E8%AE%B0%E5%BD%95%E7%B3%BB%E7%BB%9F%E7%A9%BA%E9%97%B4%E7%9A%84%E9%AB%98%E9%80%9A%E7%AD%94%E7%96%91/#æˆ‘ä»¬æŠŠä½ ç»™çš„è¯´æ˜482022-158-amåé¦ˆç»™å®¢æˆ·äº†ä¸‹é¢æ˜¯å®¢æˆ·çš„å›å¤"},{"categories":["Android"],"collections":["WMS"],"content":"é«˜é€šçš„å›å¤æœ‰äº›ç»•å£ï¼Œæˆ‘ç¡®è®¤ä¸‹æ˜¯ä¸æ˜¯è¿™æ ·ï¼š å®‰å“12çš„å›ºä»¶å¤§å°è¶…è¿‡äº†16Gï¼Œå½“å‰è½¯ä»¶çš„å¤§å°ç»Ÿè®¡æ˜¯æŒ‰ç…§2çš„å¹‚æ•°æ¥å–æ•´ï¼Œæ‰€ä»¥æ˜¾ç¤ºä¸º32Gï¼Œè€Œå®é™…ä¸Šè¿™32Gä¸­æœ‰10å¤šGæ˜¯ç©ºçš„ï¼› æˆ‘çœ‹äº†ä¸‹ä¸ªäººæ‰‹æœºå®‰å“11çš„å›ºä»¶å¤§å°æ˜¯åœ¨11Gå·¦å³ï¼Œå†æ€ä¹ˆå¢åŠ åŠŸèƒ½ï¼Œä¹Ÿä¸å¯èƒ½åˆ°32Gå§ï¼Ÿ è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæ˜¯æ˜¾ç¤ºé—®é¢˜ï¼Œè¿™éƒ¨åˆ†æœ‰åŠæ³•è°ƒæ•´ä¹ˆï¼Ÿè¦ä¸ç„¶æ¯ä¸ªç”¨æˆ·éƒ½ä¼šæœ‰ç–‘é—®çš„ã€‚ è¿™ä¸ªäº›é—®é¢˜æ˜¯å¦å¯ä»¥ååŠ©ç¡®è®¤ä¸€ä¸‹ï¼Ÿ è°¢è°¢ï¼â€ é«˜é€šå›å¤å®¢æˆ·ç­”ç–‘ â€œDear Customer, å®‰å“12çš„å›ºä»¶å¤§å°è¶…è¿‡äº†16Gï¼Œå½“å‰è½¯ä»¶çš„å¤§å°ç»Ÿè®¡æ˜¯æŒ‰ç…§2çš„å¹‚æ•°æ¥å–æ•´ï¼Œæ‰€ä»¥æ˜¾ç¤ºä¸º32Gï¼Œè€Œå®é™…ä¸Šè¿™32Gä¸­æœ‰10å¤šGæ˜¯ç©ºçš„ï¼› --\u003e è¿™ä¸ªç†è§£æ˜¯æ­£ç¡®çš„ æˆ‘çœ‹äº†ä¸‹ä¸ªäººæ‰‹æœºå®‰å“11çš„å›ºä»¶å¤§å°æ˜¯åœ¨11Gå·¦å³ï¼Œå†æ€ä¹ˆå¢åŠ åŠŸèƒ½ï¼Œä¹Ÿä¸å¯èƒ½åˆ°32Gå§ï¼Ÿ --\u003e userdataåˆ†åŒºæ˜¯ç”¨æ¥å­˜æ”¾ç”¨æˆ·æ•°æ®çš„ï¼Œä¸æ˜¯Androidå›ºä»¶ï¼Œä½ å¯ä»¥ç®€å•ç†è§£ï¼šandroidå›ºä»¶å­˜æ”¾åœ¨userdataä¹‹å¤–çš„åˆ†åŒºä¸­ ä»partition.xmlå¯ä»¥çœ‹å‡º LUN0ä¸­é™¤äº†usdataä¹‹å¤–çš„åˆ†åŒºå ç”¨å¤§çº¦14Gï¼Œuserdataåˆ†åŒºåˆå§‹ç©ºé—´15G æ‰€ä»¥ä¸å­˜åœ¨â€œ32Gâ€çš„androidå›ºä»¶ è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœæ˜¯æ˜¾ç¤ºé—®é¢˜ï¼Œè¿™éƒ¨åˆ†æœ‰åŠæ³•è°ƒæ•´ä¹ˆï¼Ÿè¦ä¸ç„¶æ¯ä¸ªç”¨æˆ·éƒ½ä¼šæœ‰ç–‘é—®çš„ã€‚ --\u003e å‘å¸ƒåˆ°ç»ˆç«¯ç”¨æˆ·æ‰‹ä¸­çš„è®¾å¤‡åº”è¯¥æ˜¯å·²ç»resizeè¿‡çš„ï¼Œç”¨æˆ·çœ‹åˆ°çš„storageç©ºé—´å¤§å°åº”è¯¥æ˜¯64G/128G,è¿™å·²ç»ä¸å­˜åœ¨æ­§ä¹‰äº†ã€‚ Title æ–‡éŸ¬ï¼Œå é£ï¼Œ 3 .å·²ç”¨ç©ºé—´æ˜¯ä¸å‡†ç¡®çš„ï¼Œæ˜¯é€šè¿‡2çš„å¹‚æ•°å¯¹é½åå‡å»å¯ç”¨ç©ºé—´ æ˜¾ç¤ºå¯ç”¨ 64-33 = 31G, ä½¿ç”¨æ‰‹æœºå·²ç”¨ç©ºé—´ï¼š 59-6-33 =20Gï¼Œé‡Œé¢åŒ…æ‹¬å·²ç”¨çš„ç©ºé—´å’Œæœªå¯¹é½çš„ç©ºé—´ã€‚ æ‰€ä»¥é‡Œé¢è™šæ ‡äº† æ€»å®¹é‡ è™šæ ‡äº† 5G è¿˜æœ‰LUN4 6G æˆ‘çœ‹äº†ä¸‹QFILè¯»å–å‡ºæ¥çš„åˆ†åŒºè¡¨ï¼Œlun4é‡Œå­˜æ”¾çš„ä¸»è¦æ˜¯modemï¼Œdspç­‰åˆ†åŒºï¼Œæ˜¯å±äºä¸‹è½½é•œåƒå†…å®¹ï¼Œæ˜¯æˆ‘ä»¬ä¼ ç»Ÿç†è§£çš„ç³»ç»Ÿå®¹é‡ä¸€éƒ¨åˆ†ã€‚è™šæ ‡åªèƒ½ç®—5Gå§ã€‚ å€’æ˜¯lun0ä¸­çš„backupåˆ†åŒºæ˜¯åº”ç”¨ä¿æŠ¤åˆ†åŒºï¼Œè¿™éƒ¨åˆ†æ˜¯ç®—åˆ°ç³»ç»Ÿé‡Œçš„ï¼Œæœ‰5Gã€‚è¿™ä¸ªæ˜¯æ¯”æ ‡å‡†Android12å ç”¨å¤šå‡ºæ¥çš„ã€‚ æˆ‘æŠŠqfil dumpå‡ºæ¥çš„åˆ†åŒºè¡¨è´´åœ¨é™„ä»¶é‡Œäº†ï¼Œæ¯ä¸ªåˆ†åŒºçš„num_partition_sectorså»ä¹˜ä»¥4å°±æ˜¯è¯¥åˆ†åŒºçš„æ€»å­—èŠ‚æ•°ã€‚å é£è¦ä¸æŠŠæ¯ä¸ªåˆ†åŒºå¤§å°ç”¨excelè½¬æ¢ä¸ºå­—èŠ‚æ•°å’Œå¯¹åº”çš„GBæ•°ï¼Œä¼šæ¯”è¾ƒç›´è§‚ï¼Œç„¶åå†åŠ æ€»ä¸€ä¸‹ï¼Œè¯¯å·®å°±æ¯”è¾ƒæ¸…æ¥šäº†ã€‚ å¦å¤–æˆ‘æ¯”è¾ƒäº†64Gå’Œ128Gçš„æœºå™¨ï¼Œç³»ç»Ÿå ç”¨éƒ½æ˜¯32Gï¼Œä¼¼ä¹é«˜é€šè¯´çš„ä¹Ÿæ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œå…³é”®è¿˜æ˜¯å®¢æˆ·è¿™è¾¹ã€‚ Title å é£ï¼Œ æˆ‘ç†äº†ä¸€ä¸‹é«˜é€šçš„å›å¤ã€‚ä»¥æˆ‘æ‰‹é‡Œçš„pnc560çš„æ‰‹æœºä¸ºä¾‹ï¼Œæˆ‘æ‰‹é‡Œçš„æ˜¯64Gçš„æ‰‹æœºã€‚ åœ¨è®¾ç½®é‡Œé¢æ˜¾ç¤ºå·²ä½¿ç”¨31Gï¼Œå‰©ä½™33Gçš„ç©ºé—´ã€‚ å®‰è£…é«˜é€šçš„è¯´æ³•å’Œè®¾ç½®ç•Œé¢æ˜¾ç¤ºçš„è§„åˆ™ï¼š å‰©ä½™å¯ç”¨ç©ºé—´33Gæ˜¯å‡†ç¡®çš„ï¼Œä»£è¡¨å‰©ä½™çš„userdate ç©ºé—´æœ‰33Gã€‚ æ€»å®¹é‡æ˜¯ä¸å‡†ç¡®çš„ï¼Œç›¸å½“äºæ ‡ç§°çš„93%ï¼Œå¤§çº¦59G ä½†ç³»ç»Ÿä¼šä»¥2çš„å¹‚æ•°æ¥å–æ•´ å·²ç”¨ç©ºé—´æ˜¯ä¸å‡†ç¡®çš„ï¼Œæ˜¯é€šè¿‡2çš„å¹‚æ•°å¯¹é½åå‡å»å¯ç”¨ç©ºé—´ æ˜¾ç¤ºå¯ç”¨ 64-33 = 31G, ä½¿ç”¨æ‰‹æœºå·²ç”¨ç©ºé—´ï¼š 59-6-33 =20Gï¼Œé‡Œé¢åŒ…æ‹¬å·²ç”¨çš„ç©ºé—´å’Œæœªå¯¹é½çš„ç©ºé—´ã€‚ æ‰€ä»¥é‡Œé¢è™šæ ‡äº† æ€»å®¹é‡ è™šæ ‡äº† 5G è¿˜æœ‰LUN4 6G æŒ‰ç…§ç›®å‰çš„è§„åˆ™ï¼Œå¯ç”¨ç©ºé—´è‚¯å®šå¿…é¡»è¦å‡†ç¡®æ— è¯¯çš„ï¼Œé‚£ä¹ˆåœ¨å¯ç”¨ç©ºé—´è®¡ç®—æ²¡æœ‰é—®é¢˜çš„æƒ…å†µä¸‹ï¼Œå·²ç”¨ç©ºé—´åªèƒ½æ˜¯31G ","date":"2025-11-21","objectID":"/posts/android-%E8%AE%B0%E5%BD%95%E7%B3%BB%E7%BB%9F%E7%A9%BA%E9%97%B4%E7%9A%84%E9%AB%98%E9%80%9A%E7%AD%94%E7%96%91/:0:0","tags":["blog"],"title":"Android è®°å½•ç³»ç»Ÿç©ºé—´çš„é«˜é€šç­”ç–‘","uri":"/posts/android-%E8%AE%B0%E5%BD%95%E7%B3%BB%E7%BB%9F%E7%A9%BA%E9%97%B4%E7%9A%84%E9%AB%98%E9%80%9A%E7%AD%94%E7%96%91/#è¿˜æœ‰ä¸€ä¸ªé—®é¢˜å¦‚æœæ˜¯æ˜¾ç¤ºé—®é¢˜è¿™éƒ¨åˆ†æœ‰åŠæ³•è°ƒæ•´ä¹ˆè¦ä¸ç„¶æ¯ä¸ªç”¨æˆ·éƒ½ä¼šæœ‰ç–‘é—®çš„"},{"categories":["AMS","Android"],"collections":["AMS"],"content":"ActivityRecordã€TaskRecordã€ActivityStackã€ActivityDisplayã€ActivityStackSupervisor çš„å…³ç³» ","date":"2025-11-21","objectID":"/posts/ams--activityrecordtaskrecordactivitystackactivitydisplayactivitystacksupervisor/:0:0","tags":["AMS","blog","Framework"],"title":"AMS   -- ActivityRecordã€TaskRecordã€ActivityStackã€ActivityDisplayã€ActivityStackSupervisor","uri":"/posts/ams--activityrecordtaskrecordactivitystackactivitydisplayactivitystacksupervisor/#"},{"categories":["AMS","Android"],"collections":["AMS"],"content":"ActivityManagerService Activityæ ˆç®¡ç† ","date":"2025-11-21","objectID":"/posts/ams--activityrecordtaskrecordactivitystackactivitydisplayactivitystacksupervisor/:0:0","tags":["AMS","blog","Framework"],"title":"AMS   -- ActivityRecordã€TaskRecordã€ActivityStackã€ActivityDisplayã€ActivityStackSupervisor","uri":"/posts/ams--activityrecordtaskrecordactivitystackactivitydisplayactivitystacksupervisor/#activitymanagerservice-activityæ ˆç®¡ç†"},{"categories":["AMS","Android"],"collections":["AMS"],"content":"ActivityRecord è®°å½•Activityçš„ä¿¡æ¯ï¼Œå¹¶é€šè¿‡æˆå‘˜å˜é‡taskæŒ‡å‘TaskRecordã€‚ ç±»å‹ åç§° è¯´æ˜ ProcessRecord app è·‘åœ¨å“ªä¸ªè¿›ç¨‹ TaskRecord task è·‘åœ¨å“ªä¸ªtask ActivityInfo info Activityä¿¡æ¯ int mActivityType Activityç±»å‹ ActivityState state ActivityçŠ¶æ€ ApplicationInfo appInfo è·‘åœ¨å“ªä¸ªapp ComponentName realActivity ç»„ä»¶å String packageName åŒ…å String processName è¿›ç¨‹å int launchMode å¯åŠ¨æ¨¡å¼ int userId è¯¥Activityè¿è¡Œåœ¨å“ªä¸ªç”¨æˆ·Id ","date":"2025-11-21","objectID":"/posts/ams--activityrecordtaskrecordactivitystackactivitydisplayactivitystacksupervisor/:1:0","tags":["AMS","blog","Framework"],"title":"AMS   -- ActivityRecordã€TaskRecordã€ActivityStackã€ActivityDisplayã€ActivityStackSupervisor","uri":"/posts/ams--activityrecordtaskrecordactivitystackactivitydisplayactivitystacksupervisor/#activityrecord"},{"categories":["AMS","Android"],"collections":["AMS"],"content":"TaskRecord æè¿°Activityçš„Affinityæ‰€å±çš„æ ˆã€‚ ç±»å‹ åç§° è¯´æ˜ ActivityStack stack å½“å‰æ‰€å±çš„stack ArrayList mActivities å½“å‰taskçš„æ‰€æœ‰Activityåˆ—è¡¨ int taskId TaskRecordçš„Id String affinity root activityçš„affinityï¼Œå³è¯¥Taskä¸­ç¬¬ä¸€ä¸ªActivity int mCallingUid è°ƒç”¨è€…çš„UserId String mCallingPackage è°ƒç”¨è€…çš„åŒ…å ","date":"2025-11-21","objectID":"/posts/ams--activityrecordtaskrecordactivitystackactivitydisplayactivitystacksupervisor/:2:0","tags":["AMS","blog","Framework"],"title":"AMS   -- ActivityRecordã€TaskRecordã€ActivityStackã€ActivityDisplayã€ActivityStackSupervisor","uri":"/posts/ams--activityrecordtaskrecordactivitystackactivitydisplayactivitystacksupervisor/#taskrecord"},{"categories":["AMS","Android"],"collections":["AMS"],"content":"ActivityStack ç®¡ç†ç€TaskRecordï¼Œå†…éƒ¨ç»´æŠ¤Activityæ‰€æœ‰çŠ¶æ€ã€ç‰¹æ®ŠçŠ¶æ€çš„Activityå’ŒActivityç›¸å…³çš„åˆ—è¡¨æ•°æ®ã€‚ ç±»å‹ åç§° è¯´æ˜ ArrayList mTaskHistory ä¿å­˜æ‰€æœ‰çš„Taskåˆ—è¡¨ ArrayList mStacks æ‰€æœ‰çš„stackåˆ—è¡¨ int mStackId ActivityStackvisorçš„mActivityContainersçš„keyå€¼Id int mDisplayId ActivityStackSupervisorçš„mActivityDisplaysçš„keyå€¼Id ActivityRecord mPauseingActivity æ­£åœ¨æš‚åœçš„Activity ActivityRecord mLastPausedActivity ä¸Šä¸€ä¸ªå·²æš‚åœçš„Activity ActivityRecord mResumedActivity å·²ç»Resumedçš„Activity ActivityRecord mLastStartedActivity æœ€è¿‘ä¸€æ¬¡å¯åŠ¨çš„Activity ","date":"2025-11-21","objectID":"/posts/ams--activityrecordtaskrecordactivitystackactivitydisplayactivitystacksupervisor/:3:0","tags":["AMS","blog","Framework"],"title":"AMS   -- ActivityRecordã€TaskRecordã€ActivityStackã€ActivityDisplayã€ActivityStackSupervisor","uri":"/posts/ams--activityrecordtaskrecordactivitystackactivitydisplayactivitystacksupervisor/#activitystack"},{"categories":["AMS","Android"],"collections":["AMS"],"content":"ActivityStackSupervisor ç®¡ç†æ‰€æœ‰çš„ActivityStackã€‚ ç±»å‹ åç§° è¯´æ˜ ActivityStack mHomeStack æ¡Œé¢çš„stack ActivityStack mFocusedStack å½“å‰èšç„¦çš„stack ActivityStack mLastFocusedStack æ­£åœ¨åˆ‡æ¢åˆ°èšç„¦çš„stack SparseArray mActivityDisplays displayIdä¸ºkey SparseArray mActivityContainers mStackIdä¸ºkey ","date":"2025-11-21","objectID":"/posts/ams--activityrecordtaskrecordactivitystackactivitydisplayactivitystacksupervisor/:4:0","tags":["AMS","blog","Framework"],"title":"AMS   -- ActivityRecordã€TaskRecordã€ActivityStackã€ActivityDisplayã€ActivityStackSupervisor","uri":"/posts/ams--activityrecordtaskrecordactivitystackactivitydisplayactivitystacksupervisor/#activitystacksupervisor"},{"categories":["AMS","Android"],"collections":["AMS"],"content":"ActivityDisplay è¡¨ç¤ºä¸€ä¸ªå±å¹•ï¼ŒAndroidæ”¯æŒä¸‰ç§å±å¹•ï¼šä¸»å±å¹•ï¼Œå¤–æ¥å±å¹•ï¼ˆHDMIç­‰ï¼‰ï¼Œè™šæ‹Ÿå±å¹•ï¼ˆæŠ•å±ï¼‰ä¸€èˆ¬åœ°ï¼Œå¯¹äºæ²¡æœ‰åˆ†å±åŠŸèƒ½ä»¥åŠè™šæ‹Ÿå±çš„æƒ…å†µä¸‹ï¼ŒActivityStackSupervisorä¸ActivityDisplayéƒ½æ˜¯ç³»ç»Ÿå”¯ä¸€ï¼›ActivityDisplayä¸»è¦æœ‰Home Stackå’ŒApp Stackè¿™ä¸¤ä¸ªæ ˆã€‚ ","date":"2025-11-21","objectID":"/posts/ams--activityrecordtaskrecordactivitystackactivitydisplayactivitystacksupervisor/:5:0","tags":["AMS","blog","Framework"],"title":"AMS   -- ActivityRecordã€TaskRecordã€ActivityStackã€ActivityDisplayã€ActivityStackSupervisor","uri":"/posts/ams--activityrecordtaskrecordactivitystackactivitydisplayactivitystacksupervisor/#activitydisplay"},{"categories":["AMS","Android"],"collections":["AMS"],"content":"è®°å¿†å…³ç³»é“¾ æ¯ä¸ªActivityStackä¸­å¯ä»¥æœ‰è‹¥å¹²ä¸ªTaskRecordå¯¹è±¡ï¼›æ¯ä¸ªTaskRecordä¸­å¯ä»¥æœ‰è‹¥å¹²ä¸ªActivityRecordå¯¹è±¡ï¼›æ¯ä¸ªActivityRecordè®°å½•ä¸€ä¸ªActivityä¿¡æ¯ã€‚ æ­£å‘å…³ç³»é“¾è¡¨ï¼š java ä»£ç è§£è¯» å¤åˆ¶ä»£ç ActivityStackSupervisor.mActivityDisplays -\u003e ActivityDisplay.mStack -\u003e ActivityStack.mTaskHistory -\u003e TaskRecord.mActivities -\u003e ActivityRecord åå‘å…³ç³»é“¾ java ä»£ç è§£è¯» å¤åˆ¶ä»£ç ActivityRecord.task -\u003e TaskRecord.mStack -\u003e ActivityStack.mStackSupervisor -\u003e ActivityStackSupervisor ActivityStack.mDisplayIdå¯ä»¥æ‰¾åˆ°å¯¹åº”çš„ActivityDisplayï¼ŒHOME_STACK_ID=0å¯ä»¥åœ¨ActivityStackSupervisor.mActivityDisplaysæ‰¾åˆ°æ¡Œé¢çš„ActivityStackã€‚ å¼•ç”¨ï¼š ä½œè€…ï¼šå½­å°é“­ é“¾æ¥ï¼šhttps://juejin.cn/post/7267554771540049957 æ¥æºï¼šç¨€åœŸæ˜é‡‘ ","date":"2025-11-21","objectID":"/posts/ams--activityrecordtaskrecordactivitystackactivitydisplayactivitystacksupervisor/:6:0","tags":["AMS","blog","Framework"],"title":"AMS   -- ActivityRecordã€TaskRecordã€ActivityStackã€ActivityDisplayã€ActivityStackSupervisor","uri":"/posts/ams--activityrecordtaskrecordactivitystackactivitydisplayactivitystacksupervisor/#è®°å¿†å…³ç³»é“¾"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"onComposerHalRefreshæ–¹æ³•æ˜¯SurfaceFlingerä¸­çš„ä¸€ä¸ªå‡½æ•°ã€‚è¯¥æ–¹æ³•çš„ä½œç”¨æ˜¯åœ¨Composer HALåˆ·æ–°æ—¶è¢«è°ƒç”¨ï¼Œç”¨äºæ›´æ–°æ˜¾ç¤ºå†…å®¹ã€‚onComposerHalRefreshæ–¹æ³•ä¼šåœ¨SurfaceFlingeræ¥æ”¶åˆ°Composer HALåˆ·æ–°äº‹ä»¶æ—¶è¢«è°ƒç”¨ã€‚Composer HALæ˜¯ç¡¬ä»¶æŠ½è±¡å±‚çš„ä¸€éƒ¨åˆ†ï¼Œè´Ÿè´£ä¸ç¡¬ä»¶æ˜¾ç¤ºè®¾å¤‡è¿›è¡Œé€šä¿¡ã€‚å½“Composer HALå®Œæˆä¸€æ¬¡åˆ·æ–°æ“ä½œåï¼Œä¼šé€šçŸ¥SurfaceFlingerè¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚ åœ¨onComposerHalRefreshæ–¹æ³•ä¸­ï¼ŒSurfaceFlingerä¼šæ‰§è¡Œä¸€ç³»åˆ—æ“ä½œï¼ŒåŒ…æ‹¬æ›´æ–°å±å¹•ä¸Šçš„å›¾åƒå†…å®¹ã€å¤„ç†æ˜¾ç¤ºå±‚çš„åˆæˆå’Œæ··åˆç­‰ã€‚é€šè¿‡è¿™äº›æ“ä½œï¼ŒSurfaceFlingerèƒ½å¤Ÿå°†åº”ç”¨ç¨‹åºçš„å›¾åƒå†…å®¹æ­£ç¡®åœ°æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚ SurfaceFlingerçš„onComposerHalRefreshæ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::onComposerHalRefresh(hal::HWDisplayId) { Mutex::Autolock lock(mStateLock); scheduleComposite(FrameHint::kNone); } ","date":"2025-11-21","objectID":"/posts/android13-surfaceflinger-oncomposerhalrefresh%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger onComposerHalRefreshæµç¨‹åˆ†æ_android 13 surfaceflingeå˜åŒ–-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-oncomposerhalrefresh%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"SurfaceFlinger scheduleComposite è°ƒç”¨SurfaceFlingerçš„scheduleCompositeæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::scheduleComposite(FrameHint hint) { mMustComposite = true; scheduleCommit(hint); } è°ƒç”¨scheduleCommitæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp std::unique_ptr\u003cscheduler::Scheduler\u003e mScheduler; void SurfaceFlinger::scheduleCommit(FrameHint hint) { if (hint == FrameHint::kActive) { mScheduler-\u003eresetIdleTimer(); } mPowerAdvisor-\u003enotifyDisplayUpdateImminent(); mScheduler-\u003escheduleFrame(); } ","date":"2025-11-21","objectID":"/posts/android13-surfaceflinger-oncomposerhalrefresh%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger onComposerHalRefreshæµç¨‹åˆ†æ_android 13 surfaceflingeå˜åŒ–-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-oncomposerhalrefresh%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-schedulecomposite"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"MessageQueue scheduleFrame è°ƒç”¨Schedulerçš„scheduleFrameæ–¹æ³•ï¼ŒSchedulerç»§æ‰¿MessageQueueï¼Œè°ƒç”¨MessageQueueçš„scheduleFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Scheduler/MessageQueue.cpp void MessageQueue::scheduleFrame() { ATRACE_CALL(); { std::lock_guard lock(mInjector.mutex); if (CC_UNLIKELY(mInjector.connection)) { ALOGD(\"%s while injecting VSYNC\", __FUNCTION__); //è¯·æ±‚ä¸‹ä¸€ä¸ª VSync ä¿¡å· mInjector.connection-\u003erequestNextVsync(); return; } } std::lock_guard lock(mVsync.mutex); mVsync.scheduledFrameTime = mVsync.registration-\u003eschedule({.workDuration = mVsync.workDuration.get().count(), .readyDuration = 0, .earliestVsync = mVsync.lastCallbackTime.count()}); } è°ƒç”¨äº†VSyncCallbackRegistrationçš„scheduleæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Scheduler/VSyncCallbackRegistration.cpp std::reference_wrapper\u003cVSyncDispatch\u003e mDispatch; ScheduleResult VSyncCallbackRegistration::schedule(VSyncDispatch::ScheduleTiming scheduleTiming) { if (!mValidToken) { return std::nullopt; } return mDispatch.get().schedule(mToken, scheduleTiming); } VSyncDispatchTimerQueue schedule è°ƒç”¨mDispatch(VSyncDispatch)çš„scheduleæ–¹æ³•ï¼Œå®é™…è°ƒç”¨çš„æ˜¯VSyncDispatchTimerQueueçš„scheduleæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Scheduler/VSyncDispatchTimerQueue.cpp ScheduleResult VSyncDispatchTimerQueueEntry::schedule(VSyncDispatch::ScheduleTiming timing, VSyncTracker\u0026 tracker, nsecs_t now) { auto nextVsyncTime = tracker.nextAnticipatedVSyncTimeFrom( std::max(timing.earliestVsync, now + timing.workDuration + timing.readyDuration)); auto nextWakeupTime = nextVsyncTime - timing.workDuration - timing.readyDuration; bool const wouldSkipAVsyncTarget = mArmedInfo \u0026\u0026 (nextVsyncTime \u003e (mArmedInfo-\u003emActualVsyncTime + mMinVsyncDistance)); bool const wouldSkipAWakeup = mArmedInfo \u0026\u0026 ((nextWakeupTime \u003e (mArmedInfo-\u003emActualWakeupTime + mMinVsyncDistance))); if (wouldSkipAVsyncTarget \u0026\u0026 wouldSkipAWakeup) { return getExpectedCallbackTime(nextVsyncTime, timing); } bool const alreadyDispatchedForVsync = mLastDispatchTime \u0026\u0026 ((*mLastDispatchTime + mMinVsyncDistance) \u003e= nextVsyncTime \u0026\u0026 (*mLastDispatchTime - mMinVsyncDistance) \u003c= nextVsyncTime); if (alreadyDispatchedForVsync) { nextVsyncTime = tracker.nextAnticipatedVSyncTimeFrom(*mLastDispatchTime + mMinVsyncDistance); nextWakeupTime = nextVsyncTime - timing.workDuration - timing.readyDuration; } // å¦‚æœè®¡æ—¶å™¨çº¿ç¨‹å³å°†è¿è¡Œï¼Œé€šè¿‡å›è°ƒè®¡æ—¶å™¨é‡æ–°è®¡ç®—åº”ç”¨æ­¤å·¥ä½œæ›´æ–°ï¼Œä»¥é¿å…å–æ¶ˆå³å°†è§¦å‘çš„å›è°ƒã€‚ auto const nextReadyTime = nextVsyncTime - timing.readyDuration; mScheduleTiming = timing; mArmedInfo = {nextWakeupTime, nextVsyncTime, nextReadyTime}; return getExpectedCallbackTime(nextVsyncTime, timing); } ","date":"2025-11-21","objectID":"/posts/android13-surfaceflinger-oncomposerhalrefresh%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger onComposerHalRefreshæµç¨‹åˆ†æ_android 13 surfaceflingeå˜åŒ–-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-oncomposerhalrefresh%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#messagequeue-scheduleframe"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"MessageQueue scheduleFrame è°ƒç”¨Schedulerçš„scheduleFrameæ–¹æ³•ï¼ŒSchedulerç»§æ‰¿MessageQueueï¼Œè°ƒç”¨MessageQueueçš„scheduleFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Scheduler/MessageQueue.cpp void MessageQueue::scheduleFrame() { ATRACE_CALL(); { std::lock_guard lock(mInjector.mutex); if (CC_UNLIKELY(mInjector.connection)) { ALOGD(\"%s while injecting VSYNC\", __FUNCTION__); //è¯·æ±‚ä¸‹ä¸€ä¸ª VSync ä¿¡å· mInjector.connection-\u003erequestNextVsync(); return; } } std::lock_guard lock(mVsync.mutex); mVsync.scheduledFrameTime = mVsync.registration-\u003eschedule({.workDuration = mVsync.workDuration.get().count(), .readyDuration = 0, .earliestVsync = mVsync.lastCallbackTime.count()}); } è°ƒç”¨äº†VSyncCallbackRegistrationçš„scheduleæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Scheduler/VSyncCallbackRegistration.cpp std::reference_wrapper mDispatch; ScheduleResult VSyncCallbackRegistration::schedule(VSyncDispatch::ScheduleTiming scheduleTiming) { if (!mValidToken) { return std::nullopt; } return mDispatch.get().schedule(mToken, scheduleTiming); } VSyncDispatchTimerQueue schedule è°ƒç”¨mDispatch(VSyncDispatch)çš„scheduleæ–¹æ³•ï¼Œå®é™…è°ƒç”¨çš„æ˜¯VSyncDispatchTimerQueueçš„scheduleæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Scheduler/VSyncDispatchTimerQueue.cpp ScheduleResult VSyncDispatchTimerQueueEntry::schedule(VSyncDispatch::ScheduleTiming timing, VSyncTracker\u0026 tracker, nsecs_t now) { auto nextVsyncTime = tracker.nextAnticipatedVSyncTimeFrom( std::max(timing.earliestVsync, now + timing.workDuration + timing.readyDuration)); auto nextWakeupTime = nextVsyncTime - timing.workDuration - timing.readyDuration; bool const wouldSkipAVsyncTarget = mArmedInfo \u0026\u0026 (nextVsyncTime \u003e (mArmedInfo-\u003emActualVsyncTime + mMinVsyncDistance)); bool const wouldSkipAWakeup = mArmedInfo \u0026\u0026 ((nextWakeupTime \u003e (mArmedInfo-\u003emActualWakeupTime + mMinVsyncDistance))); if (wouldSkipAVsyncTarget \u0026\u0026 wouldSkipAWakeup) { return getExpectedCallbackTime(nextVsyncTime, timing); } bool const alreadyDispatchedForVsync = mLastDispatchTime \u0026\u0026 ((*mLastDispatchTime + mMinVsyncDistance) \u003e= nextVsyncTime \u0026\u0026 (*mLastDispatchTime - mMinVsyncDistance) \u003c= nextVsyncTime); if (alreadyDispatchedForVsync) { nextVsyncTime = tracker.nextAnticipatedVSyncTimeFrom(*mLastDispatchTime + mMinVsyncDistance); nextWakeupTime = nextVsyncTime - timing.workDuration - timing.readyDuration; } // å¦‚æœè®¡æ—¶å™¨çº¿ç¨‹å³å°†è¿è¡Œï¼Œé€šè¿‡å›è°ƒè®¡æ—¶å™¨é‡æ–°è®¡ç®—åº”ç”¨æ­¤å·¥ä½œæ›´æ–°ï¼Œä»¥é¿å…å–æ¶ˆå³å°†è§¦å‘çš„å›è°ƒã€‚ auto const nextReadyTime = nextVsyncTime - timing.readyDuration; mScheduleTiming = timing; mArmedInfo = {nextWakeupTime, nextVsyncTime, nextReadyTime}; return getExpectedCallbackTime(nextVsyncTime, timing); } ","date":"2025-11-21","objectID":"/posts/android13-surfaceflinger-oncomposerhalrefresh%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger onComposerHalRefreshæµç¨‹åˆ†æ_android 13 surfaceflingeå˜åŒ–-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-oncomposerhalrefresh%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#vsyncdispatchtimerqueue-schedule"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"FH20GMS-120 [VTS][MR1]vts_generic_boot_image_test ä»æŠ¥é”™ä¿¡æ¯æ¥çœ‹ramdiskç¼ºå°‘ system/bin/e2fsckï¼Œä½†è®¾å¤‡ä¸Šæ˜¯æœ‰è¿™ä¸ªbinæ–‡ä»¶çš„ï¼Œå¦‚ä¸‹ï¼š Ramdiskï¼ˆå†…å­˜ç£ç›˜ï¼‰æ˜¯Androidå¯åŠ¨è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªå…³é”®ç»„ä»¶ï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸´æ—¶æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œåœ¨å¯åŠ¨åˆæœŸè¢«åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œç”¨äºåˆå§‹åŒ–ç³»ç»Ÿå¹¶æŒ‚è½½çœŸæ­£çš„æ ¹æ–‡ä»¶ç³»ç»Ÿã€‚ ","date":"2025-11-21","objectID":"/posts/fh20gms-120-vtsmr1vts_generic_boot_image_test-gms-confluence/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"FH20GMS-120    [VTS][MR1]vts_generic_boot_image_test - GMS - Confluence","uri":"/posts/fh20gms-120-vtsmr1vts_generic_boot_image_test-gms-confluence/#fh20gms-120-vtsmr1vts_generic_boot_image_test"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Ramdiskçš„ä½œç”¨ åˆå§‹åŒ–ç³»ç»Ÿç¯å¢ƒ ï¼š è¿è¡Œinitè¿›ç¨‹ï¼Œå®ƒæ˜¯æ‰€æœ‰è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ã€‚ è§£æinit.rcè„šæœ¬ï¼Œè®¾ç½®ç³»ç»Ÿå±æ€§ã€åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹ã€æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿç­‰ã€‚ æŒ‚è½½å¿…è¦çš„æ–‡ä»¶ç³»ç»Ÿ ï¼š æŒ‚è½½systemã€vendorã€dataç­‰åˆ†åŒºã€‚ è®¾ç½®æ–‡ä»¶ç³»ç»Ÿçš„æƒé™å’ŒSELinuxå®‰å…¨ä¸Šä¸‹æ–‡ã€‚ å¯åŠ¨å…³é”®ç³»ç»ŸæœåŠ¡ ï¼š å¯åŠ¨å®ˆæŠ¤è¿›ç¨‹ï¼ˆå¦‚ueventdã€logdç­‰ï¼‰ã€‚ å‡†å¤‡Androidè¿è¡Œæ—¶ç¯å¢ƒã€‚ è¿‡æ¸¡åˆ°çœŸæ­£çš„æ ¹æ–‡ä»¶ç³»ç»Ÿ ï¼š åœ¨Androidç³»ç»Ÿä¸­ï¼Œramdiské€šå¸¸ç”¨äºå¯åŠ¨åˆ°recoveryæ¨¡å¼æˆ–ä½œä¸ºbooté•œåƒçš„ä¸€éƒ¨åˆ†ï¼Œåœ¨æ­£å¸¸å¯åŠ¨æ—¶ï¼Œå®ƒä¼šå°†æ§åˆ¶æƒäº¤ç»™systemåˆ†åŒºã€‚ ","date":"2025-11-21","objectID":"/posts/fh20gms-120-vtsmr1vts_generic_boot_image_test-gms-confluence/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"FH20GMS-120    [VTS][MR1]vts_generic_boot_image_test - GMS - Confluence","uri":"/posts/fh20gms-120-vtsmr1vts_generic_boot_image_test-gms-confluence/#ramdiskçš„ä½œç”¨"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Ramdiskåœ¨Androidå¯åŠ¨æµç¨‹ä¸­çš„ä½ç½® BootloaderåŠ è½½å†…æ ¸å’Œramdisk ï¼šBootloaderå°†å†…æ ¸å’Œramdiské•œåƒåŠ è½½åˆ°å†…å­˜ä¸­ã€‚ å†…æ ¸å¯åŠ¨ ï¼šå†…æ ¸è§£å‹ramdiskå¹¶å°†å…¶ä½œä¸ºæ ¹æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ã€‚ initè¿›ç¨‹å¯åŠ¨ ï¼šramdiskä¸­çš„initç¨‹åºå¼€å§‹æ‰§è¡Œï¼Œè§£æinit.rcæ–‡ä»¶ã€‚ æ‰§è¡Œå¯åŠ¨è„šæœ¬ ï¼šæ ¹æ®init.rcä¸­çš„å‘½ä»¤ï¼ŒæŒ‚è½½ç³»ç»Ÿåˆ†åŒºã€å¯åŠ¨æœåŠ¡ç­‰ã€‚ åˆ‡æ¢æ ¹æ–‡ä»¶ç³»ç»Ÿ ï¼šåœ¨æŸäº›é…ç½®ä¸­ï¼Œramdiskå¯èƒ½ä¼šè¢«åˆ‡æ¢ä¸ºsystemä½œä¸ºæ ¹æ–‡ä»¶ç³»ç»Ÿï¼ˆä¾‹å¦‚åœ¨system-as-rooté…ç½®ä¸­ï¼‰ã€‚ ","date":"2025-11-21","objectID":"/posts/fh20gms-120-vtsmr1vts_generic_boot_image_test-gms-confluence/:3:0","tags":["clippings","è½¬è½½","blog"],"title":"FH20GMS-120    [VTS][MR1]vts_generic_boot_image_test - GMS - Confluence","uri":"/posts/fh20gms-120-vtsmr1vts_generic_boot_image_test-gms-confluence/#ramdiskåœ¨androidå¯åŠ¨æµç¨‹ä¸­çš„ä½ç½®"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Ramdiskçš„å†…å®¹ ä¸€ä¸ªå…¸å‹çš„ramdiskåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š init ï¼šåˆå§‹åŒ–ç¨‹åºã€‚ init.rc ï¼šåˆå§‹åŒ–è„šæœ¬ã€‚ system/ ã€ vendor/ ã€ data/ ç­‰ç›®å½•çš„æŒ‚è½½ç‚¹ã€‚ ä¸€äº›å¿…è¦çš„å·¥å…·å’Œåº“ï¼ˆå¦‚ e2fsck ç”¨äºæ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿï¼‰ã€‚ å®‰å…¨ç­–ç•¥æ–‡ä»¶ï¼ˆå¦‚SELinuxç­–ç•¥ï¼‰ã€‚ ","date":"2025-11-21","objectID":"/posts/fh20gms-120-vtsmr1vts_generic_boot_image_test-gms-confluence/:4:0","tags":["clippings","è½¬è½½","blog"],"title":"FH20GMS-120    [VTS][MR1]vts_generic_boot_image_test - GMS - Confluence","uri":"/posts/fh20gms-120-vtsmr1vts_generic_boot_image_test-gms-confluence/#ramdiskçš„å†…å®¹"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"è°ƒè¯•Ramdiské—®é¢˜ å½“é‡åˆ°ramdiskç›¸å…³çš„é—®é¢˜æ—¶ï¼ˆå¦‚ç¼ºå°‘æ–‡ä»¶ã€å¤šä½™æ–‡ä»¶ç­‰ï¼‰ï¼Œå¯ä»¥ï¼š æ£€æŸ¥æ„å»ºé…ç½® ï¼šç¡®ä¿æ„å»ºç±»å‹ï¼ˆuser/userdebug/engï¼‰æ­£ç¡®ï¼Œå¹¶ä¸”æ²¡æœ‰æ„å¤–åŒ…å«è°ƒè¯•æ–‡ä»¶ã€‚ æ£€æŸ¥è®¾å¤‡é…ç½® ï¼šåœ¨è®¾å¤‡Makefileä¸­ï¼Œç¡®ä¿åªåŒ…å«äº†å¿…è¦çš„åŒ…å’Œæ–‡ä»¶ã€‚ æ£€æŸ¥GKIè¦æ±‚ ï¼šå¦‚æœä½¿ç”¨GKIï¼Œç¡®ä¿ramdiskç¬¦åˆé€šç”¨å†…æ ¸æ˜ åƒçš„è¦æ±‚ã€‚ ","date":"2025-11-21","objectID":"/posts/fh20gms-120-vtsmr1vts_generic_boot_image_test-gms-confluence/:5:0","tags":["clippings","è½¬è½½","blog"],"title":"FH20GMS-120    [VTS][MR1]vts_generic_boot_image_test - GMS - Confluence","uri":"/posts/fh20gms-120-vtsmr1vts_generic_boot_image_test-gms-confluence/#è°ƒè¯•ramdiské—®é¢˜"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"æ€»ç»“ Ramdiskæ˜¯Androidå¯åŠ¨è¿‡ç¨‹ä¸­çš„ä¸€ä¸ªä¸´æ—¶æ ¹æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒè´Ÿè´£åˆå§‹åŒ–ç³»ç»Ÿå¹¶æŒ‚è½½çœŸæ­£çš„æ–‡ä»¶ç³»ç»Ÿã€‚ç¡®ä¿ramdiskåŒ…å«æ­£ç¡®çš„æ–‡ä»¶å’Œä¸åŒ…å«å¤šä½™çš„æ–‡ä»¶å¯¹äºç³»ç»Ÿæ­£å¸¸å¯åŠ¨å’Œé€šè¿‡æµ‹è¯•ï¼ˆå¦‚GKIæµ‹è¯•ï¼‰è‡³å…³é‡è¦ã€‚ å‚è€ƒé™„ä»¶æ–‡æ¡£ï¼Œå¯ä»¥ç§»é™¤e2fsckï¼Œä¿®æ”¹å¦‚ä¸‹ è¿™ä¸ªé—®é¢˜å°±æ˜¯google åˆ©ç”¨æ‰‹é‡Œgmsçš„æ æ†æ¥æ’¬åŠ¨å‚å®¶æŒ‰ç…§æŒ‡æŒ¥æ£’æ¥è¿åŠ¨. é€šè¿‡ä¿®æ”¹VTSçš„æ¡ä»¶,è®©å‚å®¶å¿…é¡»æ ¹æ®VTSçš„è¦æ±‚æ¥åš ","date":"2025-11-21","objectID":"/posts/fh20gms-120-vtsmr1vts_generic_boot_image_test-gms-confluence/:6:0","tags":["clippings","è½¬è½½","blog"],"title":"FH20GMS-120    [VTS][MR1]vts_generic_boot_image_test - GMS - Confluence","uri":"/posts/fh20gms-120-vtsmr1vts_generic_boot_image_test-gms-confluence/#æ€»ç»“"},{"categories":null,"collections":null,"content":"æ–‡ç« è¯¦ç»†é˜è¿°äº†Linuxç³»ç»Ÿåœ¨å¯åŠ¨è¿‡ç¨‹ä¸­é’ˆå¯¹å—è®¾å¤‡çš„æ ¡éªŒæµç¨‹ï¼Œæ¶‰åŠåˆ°VerifiedBoot.cå’ŒLinuxLoader.cç­‰å…³é”®ç»„ä»¶ã€‚é€šç”¨å—è®¾å¤‡å±‚å¤„ç†I/Oè¯·æ±‚ï¼ŒåŒ…æ‹¬æ‰‡åŒºã€å—ã€æ®µå’Œæ•°æ®é¡µçš„æ¦‚å¿µã€‚åŠ¨æ€æ ¡éªŒæµç¨‹ä¸­ï¼Œverity_end_ioå‡½æ•°ç”¨äºå¤„ç†é”™è¯¯å¹¶è§¦å‘å·¥ä½œé˜Ÿåˆ—è¿›è¡Œæ ¡éªŒã€‚dm-verityç”¨äºä¿è¯æ•°æ®å®Œæ•´æ€§ï¼Œé€šè¿‡åˆ›å»ºå“ˆå¸Œæ ‘å¹¶é…ç½®ç›®æ ‡è¡¨æ¥éªŒè¯å—è®¾å¤‡ä¸Šçš„æ•°æ®ã€‚æ­¤å¤–ï¼Œæ–‡ç« è¿˜æåˆ°äº†initç”¨æˆ·æ€æµç¨‹å’Œæ¸…é™¤panicæ ‡è¯†çš„æ–¹æ³•ã€‚ ","date":"2025-11-04","objectID":"/posts/avb%E6%A0%A1%E9%AA%8C%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%9D%97%E6%A0%A1%E9%AA%8C%E5%8E%9F%E7%90%86/:0:0","tags":["clippings","blog","è½¬è½½"],"title":"avbæ ¡éªŒç›¸å…³ä¸å—æ ¡éªŒåŸç†","uri":"/posts/avb%E6%A0%A1%E9%AA%8C%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%9D%97%E6%A0%A1%E9%AA%8C%E5%8E%9F%E7%90%86/#"},{"categories":null,"collections":null,"content":"ä¸€ã€å¯åŠ¨æ ¡éªŒæµç¨‹ edk2/QcomModulePkg/Library/avb/VerifiedBoot.c DEBUG ((EFI_D_ERROR, \"LoadImageAndAuth failed %r\\n\", Status)); in LoadImageAndAuth() edk2/QcomModulePkg/Application/LinuxLoader/LinuxLoader.c DEBUG ((EFI_D_ERROR, \"LoadImageAndAuth failed: %r\\n\", Status)); BootLib/PartitionTableUpdate.c /QcomModulePkg/Library/avb/libavb/avb_slot_verify.c LinuxLoaderEntry Status = GetRebootReason (\u0026BootReason); æ ¡éªŒå¯åŠ¨åŸå›  EnumeratePartitions() FindPtnActiveSlot UpdatePartitionEntries() ----- åŠ è½½avbåˆ†åŒº LoadImageAndAuth --------------- VerifiedBoot.c FindBootableSlot -------------- PartitionTableUpdate.c//error GetBootPartitionEntry HandleActiveSlotUnbootable //ä¸€ç›´è¿”å›é”™è¯¯ GetBootPartitionEntry // BootEntry æ£€æµ‹æ²¡è¿‡ GetActiveSlot //success GetBootPartitionEntry ----- for() LoadImageAndAuthVB2 --------------- VerifiedBoot.c avb_should_update_rollback IsCurrentSlotBootable avb_slot_verify ------------------ avb_slot_verify.c load_and_verify_vbmeta ops-\u003eread_from_partition(ops, AvbReadFromPartition \"Load Image %a total time: %lu ms \\n\" avb_vbmeta_image_verify avb_rsa_verify iavb_parse_key_data //Unexpected key length avb_manage_hashtree_error_mode avb_append_options //avb æ ¹æ®resolved_hashtree_error_mode è®¾ç½®verity_mode cmdline_append_option //è®¾ç½®verity_modeåˆ°slot_data-\u003ecmdline avb_sub_cmdline HandleActiveSlotUnbootable //å½“å‰æ§½ç½®ä¸ºunbootable AppendVBCmdLine //cmdlineèµ‹å€¼åˆ°VBCmdLine DisplayVerifiedBootScreen DisplayVerifiedBootMenu BootLinux (\u0026Info); UpdateCmdLine AddtoBootConfigList //gBS = SystemTable-\u003eBootServices;è¿™é‡Œä¼šåˆ©ç”¨uefi bootæœåŠ¡è®°å½•map c12345678910111213141516171819202122232425262728293031323334353637383940414243 ","date":"2025-11-04","objectID":"/posts/avb%E6%A0%A1%E9%AA%8C%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%9D%97%E6%A0%A1%E9%AA%8C%E5%8E%9F%E7%90%86/:0:1","tags":["clippings","blog","è½¬è½½"],"title":"avbæ ¡éªŒç›¸å…³ä¸å—æ ¡éªŒåŸç†","uri":"/posts/avb%E6%A0%A1%E9%AA%8C%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%9D%97%E6%A0%A1%E9%AA%8C%E5%8E%9F%E7%90%86/#ä¸€å¯åŠ¨æ ¡éªŒæµç¨‹"},{"categories":null,"collections":null,"content":"äºŒã€é€šç”¨å—è®¾å¤‡å±‚å¯¹è¯·æ±‚çš„å¤„ç† 2.1 å—è®¾å¤‡æ¦‚è¿° â€¢ å—è®¾å¤‡çš„ æ§åˆ¶å™¨ ä¼ è¾“çš„å›ºå®šæ•°æ®å•å…ƒå¤§å°ç§°ä¸ºæ‰‡åŒºï¼ˆsectorï¼‰ã€‚å› æ­¤I/Oè°ƒåº¦å™¨ å’Œå— è®¾å¤‡é©±åŠ¨ å¿…é¡»ä»¥æ‰‡åŒºä¸ºå•ä½ç®¡ç†æ•°æ®ã€‚ â€¢ è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ ã€æ˜ å°„å±‚ï¼ˆmapping layerï¼‰ç®¡ç†ç£ç›˜æ•°æ®çš„é€»è¾‘å•å…ƒå¤§å°ç§°ä¸ºå— ï¼ˆblockï¼‰ã€‚å¯¹äºæ–‡ä»¶ç³»ç»Ÿæ¥è¯´ï¼Œå—æ˜¯æœ€å°çš„ç£ç›˜æ•°æ®å­˜å‚¨å•å…ƒã€‚ â€¢ å‰é¢åœ¨åˆ†æ•£/èšåˆDMAä¸­ï¼Œæˆ‘ä»¬æåˆ°å—è®¾å¤‡é©±åŠ¨åº”è¯¥èƒ½å¤Ÿå¤„ç†ç§°ä¸ºâ€œæ®µâ€çš„æ•°æ® å•å…ƒï¼›æ¯ä¸ªâ€œæ®µâ€æ˜¯å†…å­˜ä¸­çš„ä¸€é¡µæˆ–é¡µçš„ä¸€éƒ¨åˆ†ï¼Œâ€œæ®µâ€ä¸­çš„æ•°æ®åœ¨ç£ç›˜ä¸Šæ˜¯ è¿ç»­çš„ã€‚ â€¢ ç£ç›˜ç¼“å†²åŒºå¤„ç†çš„æ•°æ®å•å…ƒå¤§å°ä¸ºâ€œé¡µâ€ï¼Œæ¯ä¸ªå¯¹åº”ä¸€ä¸ªé¡µå¸§ã€‚ï¼ˆæ³¨1ï¼‰ â€¢ é€šç”¨å—è®¾å¤‡å±‚ç²˜åˆæ‰€æœ‰ä¸Šå±‚å’Œåº•å±‚çš„éƒ¨åˆ†ï¼Œè¿™æ ·å®ƒå°±çŸ¥é“æ‰‡åŒºã€å—ã€æ®µå’Œæ•°æ® é¡µã€‚ bi_io_vecsæŒ‡å‘ä¸€ä¸ªbio_vec ç»“æ„ä½“ æ•°ç»„ï¼Œè¯¥ç»“æ„ä½“é“¾è¡¨åŒ…å«äº†ä¸€ä¸ªç‰¹å®šI/Oæ“ä½œæ‰€éœ€è¦ ä½¿ç”¨åˆ°çš„æ‰€æœ‰æ®µï¼ˆsegmentï¼‰ã€‚æ¯ä¸ªbio_vecç»“æ„éƒ½æ˜¯ä¸€ä¸ªå½¢å¼ä¸º\u003cpage, offset, len\u003eçš„å‘é‡ï¼Œ å®ƒæè¿°çš„æ˜¯ä¸€ä¸ªç‰¹å®šçš„æ®µï¼šæ®µæ‰€åœ¨çš„ç‰©ç†é¡µã€å—åœ¨ç‰©ç†é¡µä¸­çš„åç§»é‡ã€ä»ç»™å®šåç§»é‡å¼€å§‹çš„ å—é•¿åº¦ã€‚æ•´ä¸ªbio_io_vecç»“æ„ä½“æ•°ç»„è¡¨ç¤ºäº†ä¸€ä¸ªå®Œæ•´çš„ç¼“å†²åŒºã€‚bio_vecç»“æ„ä½“å®šä¹‰åœ¨æ–‡ä»¶ include/linux/bio.hä¸­ã€‚ å†…æ ¸ä½¿ç”¨gendiskç»“æ„ï¼Œå®šä¹‰åœ¨include/linux/genhd.hä¸­ï¼Œæ¥è¡¨ç¤ºä¸€ä¸ªç‹¬ç«‹çš„ç£ç›˜è®¾å¤‡ã€‚ å®é™…ä¸Šå†…æ ¸è¿˜ä½¿ç”¨gendiskè¡¨ç¤ºåˆ†åŒºï¼Œä½†æ˜¯é©±åŠ¨ç¨‹åºä¸éœ€è¦äº†è§£è¿™äº›ã€‚åœ¨gendiskç»“æ„ä¸­çš„è®¸ å¤šæˆå‘˜å¿…é¡»ç”±é©±åŠ¨ç¨‹åºè¿›è¡Œåˆå§‹åŒ–ã€‚ ç‰©ç†ç£ç›˜é€šå¸¸è¢«åˆ†æˆå¤šä¸ªé€»è¾‘åˆ†åŒºã€‚æ¯ä¸ªå—è®¾å¤‡æ–‡ä»¶å¯ä»¥è¡¨ç¤ºä¸€ä¸ªæ•´ä¸ªç‰©ç†ç£ç›˜æˆ–è€…å…¶ ä¸­çš„ä¸€ä¸ªåˆ†åŒºã€‚å¦‚/dev/sdaã€/dev/sda1ã€/dev/sda2ç­‰ã€‚è‹¥ä¸€ä¸ªç‰©ç†ç£ç›˜æœ‰å¤šä¸ªåˆ†åŒºï¼Œåˆ™ç£ ç›˜çš„å¸ƒå±€ä¿å­˜åœ¨hd_structæ•°æ®ç»“æ„æ•°ç»„ä¸­ï¼Œæ•°ç»„çš„åœ°å€ç”±gendiskç»“æ„ä½“ä¸­çš„partæˆå‘˜ä¿å­˜ã€‚ hd_structæ•°æ®ç»“æ„çš„å®šä¹‰åœ¨æ–‡ä»¶include/linux/genhd.hä¸­ã€‚ å½“å†…æ ¸åœ¨ç³»ç»Ÿä¸­å‘ç°ä¸€ä¸ªæ–°ç£ç›˜æ—¶ï¼Œè°ƒç”¨alloc_diskï¼ˆï¼‰åˆ†é…ç›¸å…³æ•°æ®ç»“æ„ï¼Œå¦‚gendiskï¼Œ hd_structç­‰ï¼Œç„¶åè°ƒç”¨add_diskï¼ˆï¼‰å°†ç£ç›˜æ·»åŠ åˆ°ç³»ç»Ÿä¸­ã€‚æ³¨æ„ï¼šä¸€æ—¦è°ƒç”¨äº†add_diskï¼Œ ç£ç›˜è®¾å¤‡å°±è¢«â€œæ¿€æ´»â€œï¼Œè¡¨ç¤ºå¯ä»¥ä½¿ç”¨ï¼Œå¹¶éšæ—¶ä¼šè°ƒç”¨å®ƒä»¬æä¾›çš„æ–¹æ³•ã€‚ 2.2å‘é€šç”¨å—è®¾å¤‡å±‚å‘é€è¯·æ±‚ ä¸Šå±‚ä¸‹å‘ç£ç›˜æ•°æ®è¯·æ±‚ é€šç”¨å—å±‚ç”³è¯·bioç»“æ„ï¼Œå°†è¯·æ±‚çš„æ•°æ®åˆ†æ®µè®°å½•åˆ°bioä¸­ å¦‚æœè¯·æ±‚çš„æ•°æ®å¤§äºä¸€ä¸ªbioå…è®¸çš„æœ€å¤§æ•°æ®é‡ï¼Œåˆ™å°†è¯·æ±‚åˆ†æˆå¤šä¸ªbio è°ƒç”¨submit_bioæäº¤bioè¯·æ±‚ submit_bioå‡½æ•°ç»è¿‡å±‚å±‚è°ƒç”¨ï¼Œæœ€ç»ˆè°ƒç”¨å—è®¾å¤‡è¯·æ±‚é˜Ÿåˆ—ä¸­çš„make_request_fnæˆå‘˜å‡½æ•°å°†bioæäº¤ç»™I/Oè°ƒåº¦å±‚è¿›è¡Œå¤„ç† generic_make_requestå‡½æ•°å°†bioè¿æ¥åˆ°current-\u003ebio_listé“¾è¡¨ä¸­ï¼Œå¹¶è°ƒç”¨__generic_make_requestå‡½æ•°æäº¤é“¾è¡¨ä¸­æ‰€æœ‰çš„bioã€‚ __generic_make_requestå‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨å—è®¾å¤‡çš„è¯·æ±‚é˜Ÿåˆ—ä¸­çš„make_request_fnæˆå‘˜å‡½æ•°å°†bioè¯·æ±‚å‘é€ç»™I/Oè°ƒåº¦å±‚ï¼Œè‡³æ­¤å¯¹ç£ç›˜çš„æ•°æ®è¯·æ±‚ç¦»å¼€é€šç”¨å—å±‚ï¼Œè¿›å…¥ä¸‹ä¸€å±‚â€”â€”I/Oè°ƒåº¦å±‚ 2.3 åŠ¨æ€æ ¡éªŒæµç¨‹ verity_map bio-\u003ebi_end_io = verity_end_io; verity_end_io INIT_WORK(\u0026io-\u003ework, verity_work); queue_work(io-\u003ev-\u003everify_wq, \u0026io-\u003ework); verity_work verity_finish_io verity_verify_io struct bio *bio = dm_bio_from_per_bio_data for (b = 0; b \u003c io-\u003en_blocks; b++) verity_fec_decode DMWARN_LIMIT(\"%s: FEC: recursion too deep\", v-\u003edata_dev-\u003ename); verity_handle_err DMERR_LIMIT(\"%s: %s block %llu is corrupted\", v-\u003edata_dev-\u003ename, type_str, block); __submit_bio blk_mq_submit_bio bio_endio ///kernel_platform/msm-kernel/block/bio.c bio-\u003ebi_end_io c12345678910111213141516171819202122 struct dm_verity_io { 72 struct dm_verity *v; 73 74 /* original value of bio-\u003ebi_end_io */ 75 bio_end_io_t *orig_bi_end_io; 76 77 sector_t block; 78 unsigned n_blocks; 79 80 struct bvec_iter iter; 81 82 struct work_struct work; 83 84 /* 85 * Three variably-size fields follow this struct: 86 * 87 * u8 hash_req[v-\u003eahash_reqsize]; 88 * u8 real_digest[v-\u003edigest_size]; 89 * u8 want_digest[v-\u003edigest_size]; 90 * 91 * To access them use: verity_io_hash_req(), verity_io_real_digest() 92 * and verity_io_want_digest(). 93 */ 94 }; c123456789101112131415161718192021222324 int verity_hash_for_block(struct dm_verity *v, struct dm_verity_io *io, 335 sector_t block, u8 *digest, bool *is_zero) 336 { 337 int r = 0, i; 339 if (likely(v-\u003elevels)) { 340 /* 341 * First, we try to get the requested hash for 342 * the current block. If the hash block itself is 343 * verified, zero is returned. If it isn't, this 344 * function returns 1 and we fall back to whole 345 * chain verification. 346 */ 347 r = verity_verify_level(v, io, block, 0, true, digest); 348 if (likely(r \u003c= 0)) 349 goto out; 350 } 352 memcpy(digest, v-\u003eroot_digest, v-\u003edigest_size); 354 for (i = v-\u003elevels - 1; i \u003e= 0; i--) { 355 r = verity_verify_level(v, io, block, i, false, digest); 356 if (unlikely(r)) 357 goto out; 358 } 359 out: 360 if (!r \u0026\u0026 v-\u003ezero_digest) 361 *is_zero = !memcmp(v-\u003ezero_digest, digest, v-\u003edigest_size); 362 else 363 *is_zero = false; 364 365 return r; 366 } c123456789101112131415161718192021222324252627282930 2.4 æ ¸å¿ƒæ ¡éªŒæ•°æ® struct dm_verity { 35 struct dm_dev *data_dev; 36 struct dm_dev *hash_dev; 37 struct dm_target *ti; 38 struct dm_bufio_client *bufio; 39 char *alg_name; 40 struct crypto_ahash *tfm; 41 u8 *root_digest; /* digest of the root block */ 42 u8 *salt; /* salt: its size is salt_size */ 43 u8 *zero_digest; /* digest for a zero block */ 44 unsigned salt_size; 45 sector_t data_start; /* data offset in 512-byte sectors */ 46 sector_t hash_start; /* hash start in blocks */ 47 sector_t data_blocks; /* the number of data blocks */ 48 sector_t hash_blocks;","date":"2025-11-04","objectID":"/posts/avb%E6%A0%A1%E9%AA%8C%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%9D%97%E6%A0%A1%E9%AA%8C%E5%8E%9F%E7%90%86/:0:2","tags":["clippings","blog","è½¬è½½"],"title":"avbæ ¡éªŒç›¸å…³ä¸å—æ ¡éªŒåŸç†","uri":"/posts/avb%E6%A0%A1%E9%AA%8C%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%9D%97%E6%A0%A1%E9%AA%8C%E5%8E%9F%E7%90%86/#äºŒé€šç”¨å—è®¾å¤‡å±‚å¯¹è¯·æ±‚çš„å¤„ç†"},{"categories":null,"collections":null,"content":"äºŒã€é€šç”¨å—è®¾å¤‡å±‚å¯¹è¯·æ±‚çš„å¤„ç† 2.1 å—è®¾å¤‡æ¦‚è¿° â€¢ å—è®¾å¤‡çš„ æ§åˆ¶å™¨ ä¼ è¾“çš„å›ºå®šæ•°æ®å•å…ƒå¤§å°ç§°ä¸ºæ‰‡åŒºï¼ˆsectorï¼‰ã€‚å› æ­¤I/Oè°ƒåº¦å™¨ å’Œå— è®¾å¤‡é©±åŠ¨ å¿…é¡»ä»¥æ‰‡åŒºä¸ºå•ä½ç®¡ç†æ•°æ®ã€‚ â€¢ è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ ã€æ˜ å°„å±‚ï¼ˆmapping layerï¼‰ç®¡ç†ç£ç›˜æ•°æ®çš„é€»è¾‘å•å…ƒå¤§å°ç§°ä¸ºå— ï¼ˆblockï¼‰ã€‚å¯¹äºæ–‡ä»¶ç³»ç»Ÿæ¥è¯´ï¼Œå—æ˜¯æœ€å°çš„ç£ç›˜æ•°æ®å­˜å‚¨å•å…ƒã€‚ â€¢ å‰é¢åœ¨åˆ†æ•£/èšåˆDMAä¸­ï¼Œæˆ‘ä»¬æåˆ°å—è®¾å¤‡é©±åŠ¨åº”è¯¥èƒ½å¤Ÿå¤„ç†ç§°ä¸ºâ€œæ®µâ€çš„æ•°æ® å•å…ƒï¼›æ¯ä¸ªâ€œæ®µâ€æ˜¯å†…å­˜ä¸­çš„ä¸€é¡µæˆ–é¡µçš„ä¸€éƒ¨åˆ†ï¼Œâ€œæ®µâ€ä¸­çš„æ•°æ®åœ¨ç£ç›˜ä¸Šæ˜¯ è¿ç»­çš„ã€‚ â€¢ ç£ç›˜ç¼“å†²åŒºå¤„ç†çš„æ•°æ®å•å…ƒå¤§å°ä¸ºâ€œé¡µâ€ï¼Œæ¯ä¸ªå¯¹åº”ä¸€ä¸ªé¡µå¸§ã€‚ï¼ˆæ³¨1ï¼‰ â€¢ é€šç”¨å—è®¾å¤‡å±‚ç²˜åˆæ‰€æœ‰ä¸Šå±‚å’Œåº•å±‚çš„éƒ¨åˆ†ï¼Œè¿™æ ·å®ƒå°±çŸ¥é“æ‰‡åŒºã€å—ã€æ®µå’Œæ•°æ® é¡µã€‚ bi_io_vecsæŒ‡å‘ä¸€ä¸ªbio_vec ç»“æ„ä½“ æ•°ç»„ï¼Œè¯¥ç»“æ„ä½“é“¾è¡¨åŒ…å«äº†ä¸€ä¸ªç‰¹å®šI/Oæ“ä½œæ‰€éœ€è¦ ä½¿ç”¨åˆ°çš„æ‰€æœ‰æ®µï¼ˆsegmentï¼‰ã€‚æ¯ä¸ªbio_vecç»“æ„éƒ½æ˜¯ä¸€ä¸ªå½¢å¼ä¸ºçš„å‘é‡ï¼Œ å®ƒæè¿°çš„æ˜¯ä¸€ä¸ªç‰¹å®šçš„æ®µï¼šæ®µæ‰€åœ¨çš„ç‰©ç†é¡µã€å—åœ¨ç‰©ç†é¡µä¸­çš„åç§»é‡ã€ä»ç»™å®šåç§»é‡å¼€å§‹çš„ å—é•¿åº¦ã€‚æ•´ä¸ªbio_io_vecç»“æ„ä½“æ•°ç»„è¡¨ç¤ºäº†ä¸€ä¸ªå®Œæ•´çš„ç¼“å†²åŒºã€‚bio_vecç»“æ„ä½“å®šä¹‰åœ¨æ–‡ä»¶ include/linux/bio.hä¸­ã€‚ å†…æ ¸ä½¿ç”¨gendiskç»“æ„ï¼Œå®šä¹‰åœ¨include/linux/genhd.hä¸­ï¼Œæ¥è¡¨ç¤ºä¸€ä¸ªç‹¬ç«‹çš„ç£ç›˜è®¾å¤‡ã€‚ å®é™…ä¸Šå†…æ ¸è¿˜ä½¿ç”¨gendiskè¡¨ç¤ºåˆ†åŒºï¼Œä½†æ˜¯é©±åŠ¨ç¨‹åºä¸éœ€è¦äº†è§£è¿™äº›ã€‚åœ¨gendiskç»“æ„ä¸­çš„è®¸ å¤šæˆå‘˜å¿…é¡»ç”±é©±åŠ¨ç¨‹åºè¿›è¡Œåˆå§‹åŒ–ã€‚ ç‰©ç†ç£ç›˜é€šå¸¸è¢«åˆ†æˆå¤šä¸ªé€»è¾‘åˆ†åŒºã€‚æ¯ä¸ªå—è®¾å¤‡æ–‡ä»¶å¯ä»¥è¡¨ç¤ºä¸€ä¸ªæ•´ä¸ªç‰©ç†ç£ç›˜æˆ–è€…å…¶ ä¸­çš„ä¸€ä¸ªåˆ†åŒºã€‚å¦‚/dev/sdaã€/dev/sda1ã€/dev/sda2ç­‰ã€‚è‹¥ä¸€ä¸ªç‰©ç†ç£ç›˜æœ‰å¤šä¸ªåˆ†åŒºï¼Œåˆ™ç£ ç›˜çš„å¸ƒå±€ä¿å­˜åœ¨hd_structæ•°æ®ç»“æ„æ•°ç»„ä¸­ï¼Œæ•°ç»„çš„åœ°å€ç”±gendiskç»“æ„ä½“ä¸­çš„partæˆå‘˜ä¿å­˜ã€‚ hd_structæ•°æ®ç»“æ„çš„å®šä¹‰åœ¨æ–‡ä»¶include/linux/genhd.hä¸­ã€‚ å½“å†…æ ¸åœ¨ç³»ç»Ÿä¸­å‘ç°ä¸€ä¸ªæ–°ç£ç›˜æ—¶ï¼Œè°ƒç”¨alloc_diskï¼ˆï¼‰åˆ†é…ç›¸å…³æ•°æ®ç»“æ„ï¼Œå¦‚gendiskï¼Œ hd_structç­‰ï¼Œç„¶åè°ƒç”¨add_diskï¼ˆï¼‰å°†ç£ç›˜æ·»åŠ åˆ°ç³»ç»Ÿä¸­ã€‚æ³¨æ„ï¼šä¸€æ—¦è°ƒç”¨äº†add_diskï¼Œ ç£ç›˜è®¾å¤‡å°±è¢«â€œæ¿€æ´»â€œï¼Œè¡¨ç¤ºå¯ä»¥ä½¿ç”¨ï¼Œå¹¶éšæ—¶ä¼šè°ƒç”¨å®ƒä»¬æä¾›çš„æ–¹æ³•ã€‚ 2.2å‘é€šç”¨å—è®¾å¤‡å±‚å‘é€è¯·æ±‚ ä¸Šå±‚ä¸‹å‘ç£ç›˜æ•°æ®è¯·æ±‚ é€šç”¨å—å±‚ç”³è¯·bioç»“æ„ï¼Œå°†è¯·æ±‚çš„æ•°æ®åˆ†æ®µè®°å½•åˆ°bioä¸­ å¦‚æœè¯·æ±‚çš„æ•°æ®å¤§äºä¸€ä¸ªbioå…è®¸çš„æœ€å¤§æ•°æ®é‡ï¼Œåˆ™å°†è¯·æ±‚åˆ†æˆå¤šä¸ªbio è°ƒç”¨submit_bioæäº¤bioè¯·æ±‚ submit_bioå‡½æ•°ç»è¿‡å±‚å±‚è°ƒç”¨ï¼Œæœ€ç»ˆè°ƒç”¨å—è®¾å¤‡è¯·æ±‚é˜Ÿåˆ—ä¸­çš„make_request_fnæˆå‘˜å‡½æ•°å°†bioæäº¤ç»™I/Oè°ƒåº¦å±‚è¿›è¡Œå¤„ç† generic_make_requestå‡½æ•°å°†bioè¿æ¥åˆ°current-\u003ebio_listé“¾è¡¨ä¸­ï¼Œå¹¶è°ƒç”¨__generic_make_requestå‡½æ•°æäº¤é“¾è¡¨ä¸­æ‰€æœ‰çš„bioã€‚ __generic_make_requestå‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨å—è®¾å¤‡çš„è¯·æ±‚é˜Ÿåˆ—ä¸­çš„make_request_fnæˆå‘˜å‡½æ•°å°†bioè¯·æ±‚å‘é€ç»™I/Oè°ƒåº¦å±‚ï¼Œè‡³æ­¤å¯¹ç£ç›˜çš„æ•°æ®è¯·æ±‚ç¦»å¼€é€šç”¨å—å±‚ï¼Œè¿›å…¥ä¸‹ä¸€å±‚â€”â€”I/Oè°ƒåº¦å±‚ 2.3 åŠ¨æ€æ ¡éªŒæµç¨‹ verity_map bio-\u003ebi_end_io = verity_end_io; verity_end_io INIT_WORK(\u0026io-\u003ework, verity_work); queue_work(io-\u003ev-\u003everify_wq, \u0026io-\u003ework); verity_work verity_finish_io verity_verify_io struct bio *bio = dm_bio_from_per_bio_data for (b = 0; b \u003c io-\u003en_blocks; b++) verity_fec_decode DMWARN_LIMIT(\"%s: FEC: recursion too deep\", v-\u003edata_dev-\u003ename); verity_handle_err DMERR_LIMIT(\"%s: %s block %llu is corrupted\", v-\u003edata_dev-\u003ename, type_str, block); __submit_bio blk_mq_submit_bio bio_endio ///kernel_platform/msm-kernel/block/bio.c bio-\u003ebi_end_io c12345678910111213141516171819202122 struct dm_verity_io { 72 struct dm_verity *v; 73 74 /* original value of bio-\u003ebi_end_io */ 75 bio_end_io_t *orig_bi_end_io; 76 77 sector_t block; 78 unsigned n_blocks; 79 80 struct bvec_iter iter; 81 82 struct work_struct work; 83 84 /* 85 * Three variably-size fields follow this struct: 86 * 87 * u8 hash_req[v-\u003eahash_reqsize]; 88 * u8 real_digest[v-\u003edigest_size]; 89 * u8 want_digest[v-\u003edigest_size]; 90 * 91 * To access them use: verity_io_hash_req(), verity_io_real_digest() 92 * and verity_io_want_digest(). 93 */ 94 }; c123456789101112131415161718192021222324 int verity_hash_for_block(struct dm_verity *v, struct dm_verity_io *io, 335 sector_t block, u8 *digest, bool *is_zero) 336 { 337 int r = 0, i; 339 if (likely(v-\u003elevels)) { 340 /* 341 * First, we try to get the requested hash for 342 * the current block. If the hash block itself is 343 * verified, zero is returned. If it isn't, this 344 * function returns 1 and we fall back to whole 345 * chain verification. 346 */ 347 r = verity_verify_level(v, io, block, 0, true, digest); 348 if (likely(r \u003c= 0)) 349 goto out; 350 } 352 memcpy(digest, v-\u003eroot_digest, v-\u003edigest_size); 354 for (i = v-\u003elevels - 1; i \u003e= 0; i--) { 355 r = verity_verify_level(v, io, block, i, false, digest); 356 if (unlikely(r)) 357 goto out; 358 } 359 out: 360 if (!r \u0026\u0026 v-\u003ezero_digest) 361 *is_zero = !memcmp(v-\u003ezero_digest, digest, v-\u003edigest_size); 362 else 363 *is_zero = false; 364 365 return r; 366 } c123456789101112131415161718192021222324252627282930 2.4 æ ¸å¿ƒæ ¡éªŒæ•°æ® struct dm_verity { 35 struct dm_dev *data_dev; 36 struct dm_dev *hash_dev; 37 struct dm_target *ti; 38 struct dm_bufio_client *bufio; 39 char *alg_name; 40 struct crypto_ahash *tfm; 41 u8 *root_digest; /* digest of the root block */ 42 u8 *salt; /* salt: its size is salt_size */ 43 u8 *zero_digest; /* digest for a zero block */ 44 unsigned salt_size; 45 sector_t data_start; /* data offset in 512-byte sectors */ 46 sector_t hash_start; /* hash start in blocks */ 47 sector_t data_blocks; /* the number of data blocks */ 48 sector_t hash_blocks;","date":"2025-11-04","objectID":"/posts/avb%E6%A0%A1%E9%AA%8C%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%9D%97%E6%A0%A1%E9%AA%8C%E5%8E%9F%E7%90%86/:0:2","tags":["clippings","blog","è½¬è½½"],"title":"avbæ ¡éªŒç›¸å…³ä¸å—æ ¡éªŒåŸç†","uri":"/posts/avb%E6%A0%A1%E9%AA%8C%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%9D%97%E6%A0%A1%E9%AA%8C%E5%8E%9F%E7%90%86/#21-å—è®¾å¤‡æ¦‚è¿°"},{"categories":null,"collections":null,"content":"äºŒã€é€šç”¨å—è®¾å¤‡å±‚å¯¹è¯·æ±‚çš„å¤„ç† 2.1 å—è®¾å¤‡æ¦‚è¿° â€¢ å—è®¾å¤‡çš„ æ§åˆ¶å™¨ ä¼ è¾“çš„å›ºå®šæ•°æ®å•å…ƒå¤§å°ç§°ä¸ºæ‰‡åŒºï¼ˆsectorï¼‰ã€‚å› æ­¤I/Oè°ƒåº¦å™¨ å’Œå— è®¾å¤‡é©±åŠ¨ å¿…é¡»ä»¥æ‰‡åŒºä¸ºå•ä½ç®¡ç†æ•°æ®ã€‚ â€¢ è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ ã€æ˜ å°„å±‚ï¼ˆmapping layerï¼‰ç®¡ç†ç£ç›˜æ•°æ®çš„é€»è¾‘å•å…ƒå¤§å°ç§°ä¸ºå— ï¼ˆblockï¼‰ã€‚å¯¹äºæ–‡ä»¶ç³»ç»Ÿæ¥è¯´ï¼Œå—æ˜¯æœ€å°çš„ç£ç›˜æ•°æ®å­˜å‚¨å•å…ƒã€‚ â€¢ å‰é¢åœ¨åˆ†æ•£/èšåˆDMAä¸­ï¼Œæˆ‘ä»¬æåˆ°å—è®¾å¤‡é©±åŠ¨åº”è¯¥èƒ½å¤Ÿå¤„ç†ç§°ä¸ºâ€œæ®µâ€çš„æ•°æ® å•å…ƒï¼›æ¯ä¸ªâ€œæ®µâ€æ˜¯å†…å­˜ä¸­çš„ä¸€é¡µæˆ–é¡µçš„ä¸€éƒ¨åˆ†ï¼Œâ€œæ®µâ€ä¸­çš„æ•°æ®åœ¨ç£ç›˜ä¸Šæ˜¯ è¿ç»­çš„ã€‚ â€¢ ç£ç›˜ç¼“å†²åŒºå¤„ç†çš„æ•°æ®å•å…ƒå¤§å°ä¸ºâ€œé¡µâ€ï¼Œæ¯ä¸ªå¯¹åº”ä¸€ä¸ªé¡µå¸§ã€‚ï¼ˆæ³¨1ï¼‰ â€¢ é€šç”¨å—è®¾å¤‡å±‚ç²˜åˆæ‰€æœ‰ä¸Šå±‚å’Œåº•å±‚çš„éƒ¨åˆ†ï¼Œè¿™æ ·å®ƒå°±çŸ¥é“æ‰‡åŒºã€å—ã€æ®µå’Œæ•°æ® é¡µã€‚ bi_io_vecsæŒ‡å‘ä¸€ä¸ªbio_vec ç»“æ„ä½“ æ•°ç»„ï¼Œè¯¥ç»“æ„ä½“é“¾è¡¨åŒ…å«äº†ä¸€ä¸ªç‰¹å®šI/Oæ“ä½œæ‰€éœ€è¦ ä½¿ç”¨åˆ°çš„æ‰€æœ‰æ®µï¼ˆsegmentï¼‰ã€‚æ¯ä¸ªbio_vecç»“æ„éƒ½æ˜¯ä¸€ä¸ªå½¢å¼ä¸ºçš„å‘é‡ï¼Œ å®ƒæè¿°çš„æ˜¯ä¸€ä¸ªç‰¹å®šçš„æ®µï¼šæ®µæ‰€åœ¨çš„ç‰©ç†é¡µã€å—åœ¨ç‰©ç†é¡µä¸­çš„åç§»é‡ã€ä»ç»™å®šåç§»é‡å¼€å§‹çš„ å—é•¿åº¦ã€‚æ•´ä¸ªbio_io_vecç»“æ„ä½“æ•°ç»„è¡¨ç¤ºäº†ä¸€ä¸ªå®Œæ•´çš„ç¼“å†²åŒºã€‚bio_vecç»“æ„ä½“å®šä¹‰åœ¨æ–‡ä»¶ include/linux/bio.hä¸­ã€‚ å†…æ ¸ä½¿ç”¨gendiskç»“æ„ï¼Œå®šä¹‰åœ¨include/linux/genhd.hä¸­ï¼Œæ¥è¡¨ç¤ºä¸€ä¸ªç‹¬ç«‹çš„ç£ç›˜è®¾å¤‡ã€‚ å®é™…ä¸Šå†…æ ¸è¿˜ä½¿ç”¨gendiskè¡¨ç¤ºåˆ†åŒºï¼Œä½†æ˜¯é©±åŠ¨ç¨‹åºä¸éœ€è¦äº†è§£è¿™äº›ã€‚åœ¨gendiskç»“æ„ä¸­çš„è®¸ å¤šæˆå‘˜å¿…é¡»ç”±é©±åŠ¨ç¨‹åºè¿›è¡Œåˆå§‹åŒ–ã€‚ ç‰©ç†ç£ç›˜é€šå¸¸è¢«åˆ†æˆå¤šä¸ªé€»è¾‘åˆ†åŒºã€‚æ¯ä¸ªå—è®¾å¤‡æ–‡ä»¶å¯ä»¥è¡¨ç¤ºä¸€ä¸ªæ•´ä¸ªç‰©ç†ç£ç›˜æˆ–è€…å…¶ ä¸­çš„ä¸€ä¸ªåˆ†åŒºã€‚å¦‚/dev/sdaã€/dev/sda1ã€/dev/sda2ç­‰ã€‚è‹¥ä¸€ä¸ªç‰©ç†ç£ç›˜æœ‰å¤šä¸ªåˆ†åŒºï¼Œåˆ™ç£ ç›˜çš„å¸ƒå±€ä¿å­˜åœ¨hd_structæ•°æ®ç»“æ„æ•°ç»„ä¸­ï¼Œæ•°ç»„çš„åœ°å€ç”±gendiskç»“æ„ä½“ä¸­çš„partæˆå‘˜ä¿å­˜ã€‚ hd_structæ•°æ®ç»“æ„çš„å®šä¹‰åœ¨æ–‡ä»¶include/linux/genhd.hä¸­ã€‚ å½“å†…æ ¸åœ¨ç³»ç»Ÿä¸­å‘ç°ä¸€ä¸ªæ–°ç£ç›˜æ—¶ï¼Œè°ƒç”¨alloc_diskï¼ˆï¼‰åˆ†é…ç›¸å…³æ•°æ®ç»“æ„ï¼Œå¦‚gendiskï¼Œ hd_structç­‰ï¼Œç„¶åè°ƒç”¨add_diskï¼ˆï¼‰å°†ç£ç›˜æ·»åŠ åˆ°ç³»ç»Ÿä¸­ã€‚æ³¨æ„ï¼šä¸€æ—¦è°ƒç”¨äº†add_diskï¼Œ ç£ç›˜è®¾å¤‡å°±è¢«â€œæ¿€æ´»â€œï¼Œè¡¨ç¤ºå¯ä»¥ä½¿ç”¨ï¼Œå¹¶éšæ—¶ä¼šè°ƒç”¨å®ƒä»¬æä¾›çš„æ–¹æ³•ã€‚ 2.2å‘é€šç”¨å—è®¾å¤‡å±‚å‘é€è¯·æ±‚ ä¸Šå±‚ä¸‹å‘ç£ç›˜æ•°æ®è¯·æ±‚ é€šç”¨å—å±‚ç”³è¯·bioç»“æ„ï¼Œå°†è¯·æ±‚çš„æ•°æ®åˆ†æ®µè®°å½•åˆ°bioä¸­ å¦‚æœè¯·æ±‚çš„æ•°æ®å¤§äºä¸€ä¸ªbioå…è®¸çš„æœ€å¤§æ•°æ®é‡ï¼Œåˆ™å°†è¯·æ±‚åˆ†æˆå¤šä¸ªbio è°ƒç”¨submit_bioæäº¤bioè¯·æ±‚ submit_bioå‡½æ•°ç»è¿‡å±‚å±‚è°ƒç”¨ï¼Œæœ€ç»ˆè°ƒç”¨å—è®¾å¤‡è¯·æ±‚é˜Ÿåˆ—ä¸­çš„make_request_fnæˆå‘˜å‡½æ•°å°†bioæäº¤ç»™I/Oè°ƒåº¦å±‚è¿›è¡Œå¤„ç† generic_make_requestå‡½æ•°å°†bioè¿æ¥åˆ°current-\u003ebio_listé“¾è¡¨ä¸­ï¼Œå¹¶è°ƒç”¨__generic_make_requestå‡½æ•°æäº¤é“¾è¡¨ä¸­æ‰€æœ‰çš„bioã€‚ __generic_make_requestå‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨å—è®¾å¤‡çš„è¯·æ±‚é˜Ÿåˆ—ä¸­çš„make_request_fnæˆå‘˜å‡½æ•°å°†bioè¯·æ±‚å‘é€ç»™I/Oè°ƒåº¦å±‚ï¼Œè‡³æ­¤å¯¹ç£ç›˜çš„æ•°æ®è¯·æ±‚ç¦»å¼€é€šç”¨å—å±‚ï¼Œè¿›å…¥ä¸‹ä¸€å±‚â€”â€”I/Oè°ƒåº¦å±‚ 2.3 åŠ¨æ€æ ¡éªŒæµç¨‹ verity_map bio-\u003ebi_end_io = verity_end_io; verity_end_io INIT_WORK(\u0026io-\u003ework, verity_work); queue_work(io-\u003ev-\u003everify_wq, \u0026io-\u003ework); verity_work verity_finish_io verity_verify_io struct bio *bio = dm_bio_from_per_bio_data for (b = 0; b \u003c io-\u003en_blocks; b++) verity_fec_decode DMWARN_LIMIT(\"%s: FEC: recursion too deep\", v-\u003edata_dev-\u003ename); verity_handle_err DMERR_LIMIT(\"%s: %s block %llu is corrupted\", v-\u003edata_dev-\u003ename, type_str, block); __submit_bio blk_mq_submit_bio bio_endio ///kernel_platform/msm-kernel/block/bio.c bio-\u003ebi_end_io c12345678910111213141516171819202122 struct dm_verity_io { 72 struct dm_verity *v; 73 74 /* original value of bio-\u003ebi_end_io */ 75 bio_end_io_t *orig_bi_end_io; 76 77 sector_t block; 78 unsigned n_blocks; 79 80 struct bvec_iter iter; 81 82 struct work_struct work; 83 84 /* 85 * Three variably-size fields follow this struct: 86 * 87 * u8 hash_req[v-\u003eahash_reqsize]; 88 * u8 real_digest[v-\u003edigest_size]; 89 * u8 want_digest[v-\u003edigest_size]; 90 * 91 * To access them use: verity_io_hash_req(), verity_io_real_digest() 92 * and verity_io_want_digest(). 93 */ 94 }; c123456789101112131415161718192021222324 int verity_hash_for_block(struct dm_verity *v, struct dm_verity_io *io, 335 sector_t block, u8 *digest, bool *is_zero) 336 { 337 int r = 0, i; 339 if (likely(v-\u003elevels)) { 340 /* 341 * First, we try to get the requested hash for 342 * the current block. If the hash block itself is 343 * verified, zero is returned. If it isn't, this 344 * function returns 1 and we fall back to whole 345 * chain verification. 346 */ 347 r = verity_verify_level(v, io, block, 0, true, digest); 348 if (likely(r \u003c= 0)) 349 goto out; 350 } 352 memcpy(digest, v-\u003eroot_digest, v-\u003edigest_size); 354 for (i = v-\u003elevels - 1; i \u003e= 0; i--) { 355 r = verity_verify_level(v, io, block, i, false, digest); 356 if (unlikely(r)) 357 goto out; 358 } 359 out: 360 if (!r \u0026\u0026 v-\u003ezero_digest) 361 *is_zero = !memcmp(v-\u003ezero_digest, digest, v-\u003edigest_size); 362 else 363 *is_zero = false; 364 365 return r; 366 } c123456789101112131415161718192021222324252627282930 2.4 æ ¸å¿ƒæ ¡éªŒæ•°æ® struct dm_verity { 35 struct dm_dev *data_dev; 36 struct dm_dev *hash_dev; 37 struct dm_target *ti; 38 struct dm_bufio_client *bufio; 39 char *alg_name; 40 struct crypto_ahash *tfm; 41 u8 *root_digest; /* digest of the root block */ 42 u8 *salt; /* salt: its size is salt_size */ 43 u8 *zero_digest; /* digest for a zero block */ 44 unsigned salt_size; 45 sector_t data_start; /* data offset in 512-byte sectors */ 46 sector_t hash_start; /* hash start in blocks */ 47 sector_t data_blocks; /* the number of data blocks */ 48 sector_t hash_blocks;","date":"2025-11-04","objectID":"/posts/avb%E6%A0%A1%E9%AA%8C%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%9D%97%E6%A0%A1%E9%AA%8C%E5%8E%9F%E7%90%86/:0:2","tags":["clippings","blog","è½¬è½½"],"title":"avbæ ¡éªŒç›¸å…³ä¸å—æ ¡éªŒåŸç†","uri":"/posts/avb%E6%A0%A1%E9%AA%8C%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%9D%97%E6%A0%A1%E9%AA%8C%E5%8E%9F%E7%90%86/#22å‘é€šç”¨å—è®¾å¤‡å±‚å‘é€è¯·æ±‚"},{"categories":null,"collections":null,"content":"äºŒã€é€šç”¨å—è®¾å¤‡å±‚å¯¹è¯·æ±‚çš„å¤„ç† 2.1 å—è®¾å¤‡æ¦‚è¿° â€¢ å—è®¾å¤‡çš„ æ§åˆ¶å™¨ ä¼ è¾“çš„å›ºå®šæ•°æ®å•å…ƒå¤§å°ç§°ä¸ºæ‰‡åŒºï¼ˆsectorï¼‰ã€‚å› æ­¤I/Oè°ƒåº¦å™¨ å’Œå— è®¾å¤‡é©±åŠ¨ å¿…é¡»ä»¥æ‰‡åŒºä¸ºå•ä½ç®¡ç†æ•°æ®ã€‚ â€¢ è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ ã€æ˜ å°„å±‚ï¼ˆmapping layerï¼‰ç®¡ç†ç£ç›˜æ•°æ®çš„é€»è¾‘å•å…ƒå¤§å°ç§°ä¸ºå— ï¼ˆblockï¼‰ã€‚å¯¹äºæ–‡ä»¶ç³»ç»Ÿæ¥è¯´ï¼Œå—æ˜¯æœ€å°çš„ç£ç›˜æ•°æ®å­˜å‚¨å•å…ƒã€‚ â€¢ å‰é¢åœ¨åˆ†æ•£/èšåˆDMAä¸­ï¼Œæˆ‘ä»¬æåˆ°å—è®¾å¤‡é©±åŠ¨åº”è¯¥èƒ½å¤Ÿå¤„ç†ç§°ä¸ºâ€œæ®µâ€çš„æ•°æ® å•å…ƒï¼›æ¯ä¸ªâ€œæ®µâ€æ˜¯å†…å­˜ä¸­çš„ä¸€é¡µæˆ–é¡µçš„ä¸€éƒ¨åˆ†ï¼Œâ€œæ®µâ€ä¸­çš„æ•°æ®åœ¨ç£ç›˜ä¸Šæ˜¯ è¿ç»­çš„ã€‚ â€¢ ç£ç›˜ç¼“å†²åŒºå¤„ç†çš„æ•°æ®å•å…ƒå¤§å°ä¸ºâ€œé¡µâ€ï¼Œæ¯ä¸ªå¯¹åº”ä¸€ä¸ªé¡µå¸§ã€‚ï¼ˆæ³¨1ï¼‰ â€¢ é€šç”¨å—è®¾å¤‡å±‚ç²˜åˆæ‰€æœ‰ä¸Šå±‚å’Œåº•å±‚çš„éƒ¨åˆ†ï¼Œè¿™æ ·å®ƒå°±çŸ¥é“æ‰‡åŒºã€å—ã€æ®µå’Œæ•°æ® é¡µã€‚ bi_io_vecsæŒ‡å‘ä¸€ä¸ªbio_vec ç»“æ„ä½“ æ•°ç»„ï¼Œè¯¥ç»“æ„ä½“é“¾è¡¨åŒ…å«äº†ä¸€ä¸ªç‰¹å®šI/Oæ“ä½œæ‰€éœ€è¦ ä½¿ç”¨åˆ°çš„æ‰€æœ‰æ®µï¼ˆsegmentï¼‰ã€‚æ¯ä¸ªbio_vecç»“æ„éƒ½æ˜¯ä¸€ä¸ªå½¢å¼ä¸ºçš„å‘é‡ï¼Œ å®ƒæè¿°çš„æ˜¯ä¸€ä¸ªç‰¹å®šçš„æ®µï¼šæ®µæ‰€åœ¨çš„ç‰©ç†é¡µã€å—åœ¨ç‰©ç†é¡µä¸­çš„åç§»é‡ã€ä»ç»™å®šåç§»é‡å¼€å§‹çš„ å—é•¿åº¦ã€‚æ•´ä¸ªbio_io_vecç»“æ„ä½“æ•°ç»„è¡¨ç¤ºäº†ä¸€ä¸ªå®Œæ•´çš„ç¼“å†²åŒºã€‚bio_vecç»“æ„ä½“å®šä¹‰åœ¨æ–‡ä»¶ include/linux/bio.hä¸­ã€‚ å†…æ ¸ä½¿ç”¨gendiskç»“æ„ï¼Œå®šä¹‰åœ¨include/linux/genhd.hä¸­ï¼Œæ¥è¡¨ç¤ºä¸€ä¸ªç‹¬ç«‹çš„ç£ç›˜è®¾å¤‡ã€‚ å®é™…ä¸Šå†…æ ¸è¿˜ä½¿ç”¨gendiskè¡¨ç¤ºåˆ†åŒºï¼Œä½†æ˜¯é©±åŠ¨ç¨‹åºä¸éœ€è¦äº†è§£è¿™äº›ã€‚åœ¨gendiskç»“æ„ä¸­çš„è®¸ å¤šæˆå‘˜å¿…é¡»ç”±é©±åŠ¨ç¨‹åºè¿›è¡Œåˆå§‹åŒ–ã€‚ ç‰©ç†ç£ç›˜é€šå¸¸è¢«åˆ†æˆå¤šä¸ªé€»è¾‘åˆ†åŒºã€‚æ¯ä¸ªå—è®¾å¤‡æ–‡ä»¶å¯ä»¥è¡¨ç¤ºä¸€ä¸ªæ•´ä¸ªç‰©ç†ç£ç›˜æˆ–è€…å…¶ ä¸­çš„ä¸€ä¸ªåˆ†åŒºã€‚å¦‚/dev/sdaã€/dev/sda1ã€/dev/sda2ç­‰ã€‚è‹¥ä¸€ä¸ªç‰©ç†ç£ç›˜æœ‰å¤šä¸ªåˆ†åŒºï¼Œåˆ™ç£ ç›˜çš„å¸ƒå±€ä¿å­˜åœ¨hd_structæ•°æ®ç»“æ„æ•°ç»„ä¸­ï¼Œæ•°ç»„çš„åœ°å€ç”±gendiskç»“æ„ä½“ä¸­çš„partæˆå‘˜ä¿å­˜ã€‚ hd_structæ•°æ®ç»“æ„çš„å®šä¹‰åœ¨æ–‡ä»¶include/linux/genhd.hä¸­ã€‚ å½“å†…æ ¸åœ¨ç³»ç»Ÿä¸­å‘ç°ä¸€ä¸ªæ–°ç£ç›˜æ—¶ï¼Œè°ƒç”¨alloc_diskï¼ˆï¼‰åˆ†é…ç›¸å…³æ•°æ®ç»“æ„ï¼Œå¦‚gendiskï¼Œ hd_structç­‰ï¼Œç„¶åè°ƒç”¨add_diskï¼ˆï¼‰å°†ç£ç›˜æ·»åŠ åˆ°ç³»ç»Ÿä¸­ã€‚æ³¨æ„ï¼šä¸€æ—¦è°ƒç”¨äº†add_diskï¼Œ ç£ç›˜è®¾å¤‡å°±è¢«â€œæ¿€æ´»â€œï¼Œè¡¨ç¤ºå¯ä»¥ä½¿ç”¨ï¼Œå¹¶éšæ—¶ä¼šè°ƒç”¨å®ƒä»¬æä¾›çš„æ–¹æ³•ã€‚ 2.2å‘é€šç”¨å—è®¾å¤‡å±‚å‘é€è¯·æ±‚ ä¸Šå±‚ä¸‹å‘ç£ç›˜æ•°æ®è¯·æ±‚ é€šç”¨å—å±‚ç”³è¯·bioç»“æ„ï¼Œå°†è¯·æ±‚çš„æ•°æ®åˆ†æ®µè®°å½•åˆ°bioä¸­ å¦‚æœè¯·æ±‚çš„æ•°æ®å¤§äºä¸€ä¸ªbioå…è®¸çš„æœ€å¤§æ•°æ®é‡ï¼Œåˆ™å°†è¯·æ±‚åˆ†æˆå¤šä¸ªbio è°ƒç”¨submit_bioæäº¤bioè¯·æ±‚ submit_bioå‡½æ•°ç»è¿‡å±‚å±‚è°ƒç”¨ï¼Œæœ€ç»ˆè°ƒç”¨å—è®¾å¤‡è¯·æ±‚é˜Ÿåˆ—ä¸­çš„make_request_fnæˆå‘˜å‡½æ•°å°†bioæäº¤ç»™I/Oè°ƒåº¦å±‚è¿›è¡Œå¤„ç† generic_make_requestå‡½æ•°å°†bioè¿æ¥åˆ°current-\u003ebio_listé“¾è¡¨ä¸­ï¼Œå¹¶è°ƒç”¨__generic_make_requestå‡½æ•°æäº¤é“¾è¡¨ä¸­æ‰€æœ‰çš„bioã€‚ __generic_make_requestå‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨å—è®¾å¤‡çš„è¯·æ±‚é˜Ÿåˆ—ä¸­çš„make_request_fnæˆå‘˜å‡½æ•°å°†bioè¯·æ±‚å‘é€ç»™I/Oè°ƒåº¦å±‚ï¼Œè‡³æ­¤å¯¹ç£ç›˜çš„æ•°æ®è¯·æ±‚ç¦»å¼€é€šç”¨å—å±‚ï¼Œè¿›å…¥ä¸‹ä¸€å±‚â€”â€”I/Oè°ƒåº¦å±‚ 2.3 åŠ¨æ€æ ¡éªŒæµç¨‹ verity_map bio-\u003ebi_end_io = verity_end_io; verity_end_io INIT_WORK(\u0026io-\u003ework, verity_work); queue_work(io-\u003ev-\u003everify_wq, \u0026io-\u003ework); verity_work verity_finish_io verity_verify_io struct bio *bio = dm_bio_from_per_bio_data for (b = 0; b \u003c io-\u003en_blocks; b++) verity_fec_decode DMWARN_LIMIT(\"%s: FEC: recursion too deep\", v-\u003edata_dev-\u003ename); verity_handle_err DMERR_LIMIT(\"%s: %s block %llu is corrupted\", v-\u003edata_dev-\u003ename, type_str, block); __submit_bio blk_mq_submit_bio bio_endio ///kernel_platform/msm-kernel/block/bio.c bio-\u003ebi_end_io c12345678910111213141516171819202122 struct dm_verity_io { 72 struct dm_verity *v; 73 74 /* original value of bio-\u003ebi_end_io */ 75 bio_end_io_t *orig_bi_end_io; 76 77 sector_t block; 78 unsigned n_blocks; 79 80 struct bvec_iter iter; 81 82 struct work_struct work; 83 84 /* 85 * Three variably-size fields follow this struct: 86 * 87 * u8 hash_req[v-\u003eahash_reqsize]; 88 * u8 real_digest[v-\u003edigest_size]; 89 * u8 want_digest[v-\u003edigest_size]; 90 * 91 * To access them use: verity_io_hash_req(), verity_io_real_digest() 92 * and verity_io_want_digest(). 93 */ 94 }; c123456789101112131415161718192021222324 int verity_hash_for_block(struct dm_verity *v, struct dm_verity_io *io, 335 sector_t block, u8 *digest, bool *is_zero) 336 { 337 int r = 0, i; 339 if (likely(v-\u003elevels)) { 340 /* 341 * First, we try to get the requested hash for 342 * the current block. If the hash block itself is 343 * verified, zero is returned. If it isn't, this 344 * function returns 1 and we fall back to whole 345 * chain verification. 346 */ 347 r = verity_verify_level(v, io, block, 0, true, digest); 348 if (likely(r \u003c= 0)) 349 goto out; 350 } 352 memcpy(digest, v-\u003eroot_digest, v-\u003edigest_size); 354 for (i = v-\u003elevels - 1; i \u003e= 0; i--) { 355 r = verity_verify_level(v, io, block, i, false, digest); 356 if (unlikely(r)) 357 goto out; 358 } 359 out: 360 if (!r \u0026\u0026 v-\u003ezero_digest) 361 *is_zero = !memcmp(v-\u003ezero_digest, digest, v-\u003edigest_size); 362 else 363 *is_zero = false; 364 365 return r; 366 } c123456789101112131415161718192021222324252627282930 2.4 æ ¸å¿ƒæ ¡éªŒæ•°æ® struct dm_verity { 35 struct dm_dev *data_dev; 36 struct dm_dev *hash_dev; 37 struct dm_target *ti; 38 struct dm_bufio_client *bufio; 39 char *alg_name; 40 struct crypto_ahash *tfm; 41 u8 *root_digest; /* digest of the root block */ 42 u8 *salt; /* salt: its size is salt_size */ 43 u8 *zero_digest; /* digest for a zero block */ 44 unsigned salt_size; 45 sector_t data_start; /* data offset in 512-byte sectors */ 46 sector_t hash_start; /* hash start in blocks */ 47 sector_t data_blocks; /* the number of data blocks */ 48 sector_t hash_blocks;","date":"2025-11-04","objectID":"/posts/avb%E6%A0%A1%E9%AA%8C%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%9D%97%E6%A0%A1%E9%AA%8C%E5%8E%9F%E7%90%86/:0:2","tags":["clippings","blog","è½¬è½½"],"title":"avbæ ¡éªŒç›¸å…³ä¸å—æ ¡éªŒåŸç†","uri":"/posts/avb%E6%A0%A1%E9%AA%8C%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%9D%97%E6%A0%A1%E9%AA%8C%E5%8E%9F%E7%90%86/#23-åŠ¨æ€æ ¡éªŒæµç¨‹"},{"categories":null,"collections":null,"content":"äºŒã€é€šç”¨å—è®¾å¤‡å±‚å¯¹è¯·æ±‚çš„å¤„ç† 2.1 å—è®¾å¤‡æ¦‚è¿° â€¢ å—è®¾å¤‡çš„ æ§åˆ¶å™¨ ä¼ è¾“çš„å›ºå®šæ•°æ®å•å…ƒå¤§å°ç§°ä¸ºæ‰‡åŒºï¼ˆsectorï¼‰ã€‚å› æ­¤I/Oè°ƒåº¦å™¨ å’Œå— è®¾å¤‡é©±åŠ¨ å¿…é¡»ä»¥æ‰‡åŒºä¸ºå•ä½ç®¡ç†æ•°æ®ã€‚ â€¢ è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ ã€æ˜ å°„å±‚ï¼ˆmapping layerï¼‰ç®¡ç†ç£ç›˜æ•°æ®çš„é€»è¾‘å•å…ƒå¤§å°ç§°ä¸ºå— ï¼ˆblockï¼‰ã€‚å¯¹äºæ–‡ä»¶ç³»ç»Ÿæ¥è¯´ï¼Œå—æ˜¯æœ€å°çš„ç£ç›˜æ•°æ®å­˜å‚¨å•å…ƒã€‚ â€¢ å‰é¢åœ¨åˆ†æ•£/èšåˆDMAä¸­ï¼Œæˆ‘ä»¬æåˆ°å—è®¾å¤‡é©±åŠ¨åº”è¯¥èƒ½å¤Ÿå¤„ç†ç§°ä¸ºâ€œæ®µâ€çš„æ•°æ® å•å…ƒï¼›æ¯ä¸ªâ€œæ®µâ€æ˜¯å†…å­˜ä¸­çš„ä¸€é¡µæˆ–é¡µçš„ä¸€éƒ¨åˆ†ï¼Œâ€œæ®µâ€ä¸­çš„æ•°æ®åœ¨ç£ç›˜ä¸Šæ˜¯ è¿ç»­çš„ã€‚ â€¢ ç£ç›˜ç¼“å†²åŒºå¤„ç†çš„æ•°æ®å•å…ƒå¤§å°ä¸ºâ€œé¡µâ€ï¼Œæ¯ä¸ªå¯¹åº”ä¸€ä¸ªé¡µå¸§ã€‚ï¼ˆæ³¨1ï¼‰ â€¢ é€šç”¨å—è®¾å¤‡å±‚ç²˜åˆæ‰€æœ‰ä¸Šå±‚å’Œåº•å±‚çš„éƒ¨åˆ†ï¼Œè¿™æ ·å®ƒå°±çŸ¥é“æ‰‡åŒºã€å—ã€æ®µå’Œæ•°æ® é¡µã€‚ bi_io_vecsæŒ‡å‘ä¸€ä¸ªbio_vec ç»“æ„ä½“ æ•°ç»„ï¼Œè¯¥ç»“æ„ä½“é“¾è¡¨åŒ…å«äº†ä¸€ä¸ªç‰¹å®šI/Oæ“ä½œæ‰€éœ€è¦ ä½¿ç”¨åˆ°çš„æ‰€æœ‰æ®µï¼ˆsegmentï¼‰ã€‚æ¯ä¸ªbio_vecç»“æ„éƒ½æ˜¯ä¸€ä¸ªå½¢å¼ä¸ºçš„å‘é‡ï¼Œ å®ƒæè¿°çš„æ˜¯ä¸€ä¸ªç‰¹å®šçš„æ®µï¼šæ®µæ‰€åœ¨çš„ç‰©ç†é¡µã€å—åœ¨ç‰©ç†é¡µä¸­çš„åç§»é‡ã€ä»ç»™å®šåç§»é‡å¼€å§‹çš„ å—é•¿åº¦ã€‚æ•´ä¸ªbio_io_vecç»“æ„ä½“æ•°ç»„è¡¨ç¤ºäº†ä¸€ä¸ªå®Œæ•´çš„ç¼“å†²åŒºã€‚bio_vecç»“æ„ä½“å®šä¹‰åœ¨æ–‡ä»¶ include/linux/bio.hä¸­ã€‚ å†…æ ¸ä½¿ç”¨gendiskç»“æ„ï¼Œå®šä¹‰åœ¨include/linux/genhd.hä¸­ï¼Œæ¥è¡¨ç¤ºä¸€ä¸ªç‹¬ç«‹çš„ç£ç›˜è®¾å¤‡ã€‚ å®é™…ä¸Šå†…æ ¸è¿˜ä½¿ç”¨gendiskè¡¨ç¤ºåˆ†åŒºï¼Œä½†æ˜¯é©±åŠ¨ç¨‹åºä¸éœ€è¦äº†è§£è¿™äº›ã€‚åœ¨gendiskç»“æ„ä¸­çš„è®¸ å¤šæˆå‘˜å¿…é¡»ç”±é©±åŠ¨ç¨‹åºè¿›è¡Œåˆå§‹åŒ–ã€‚ ç‰©ç†ç£ç›˜é€šå¸¸è¢«åˆ†æˆå¤šä¸ªé€»è¾‘åˆ†åŒºã€‚æ¯ä¸ªå—è®¾å¤‡æ–‡ä»¶å¯ä»¥è¡¨ç¤ºä¸€ä¸ªæ•´ä¸ªç‰©ç†ç£ç›˜æˆ–è€…å…¶ ä¸­çš„ä¸€ä¸ªåˆ†åŒºã€‚å¦‚/dev/sdaã€/dev/sda1ã€/dev/sda2ç­‰ã€‚è‹¥ä¸€ä¸ªç‰©ç†ç£ç›˜æœ‰å¤šä¸ªåˆ†åŒºï¼Œåˆ™ç£ ç›˜çš„å¸ƒå±€ä¿å­˜åœ¨hd_structæ•°æ®ç»“æ„æ•°ç»„ä¸­ï¼Œæ•°ç»„çš„åœ°å€ç”±gendiskç»“æ„ä½“ä¸­çš„partæˆå‘˜ä¿å­˜ã€‚ hd_structæ•°æ®ç»“æ„çš„å®šä¹‰åœ¨æ–‡ä»¶include/linux/genhd.hä¸­ã€‚ å½“å†…æ ¸åœ¨ç³»ç»Ÿä¸­å‘ç°ä¸€ä¸ªæ–°ç£ç›˜æ—¶ï¼Œè°ƒç”¨alloc_diskï¼ˆï¼‰åˆ†é…ç›¸å…³æ•°æ®ç»“æ„ï¼Œå¦‚gendiskï¼Œ hd_structç­‰ï¼Œç„¶åè°ƒç”¨add_diskï¼ˆï¼‰å°†ç£ç›˜æ·»åŠ åˆ°ç³»ç»Ÿä¸­ã€‚æ³¨æ„ï¼šä¸€æ—¦è°ƒç”¨äº†add_diskï¼Œ ç£ç›˜è®¾å¤‡å°±è¢«â€œæ¿€æ´»â€œï¼Œè¡¨ç¤ºå¯ä»¥ä½¿ç”¨ï¼Œå¹¶éšæ—¶ä¼šè°ƒç”¨å®ƒä»¬æä¾›çš„æ–¹æ³•ã€‚ 2.2å‘é€šç”¨å—è®¾å¤‡å±‚å‘é€è¯·æ±‚ ä¸Šå±‚ä¸‹å‘ç£ç›˜æ•°æ®è¯·æ±‚ é€šç”¨å—å±‚ç”³è¯·bioç»“æ„ï¼Œå°†è¯·æ±‚çš„æ•°æ®åˆ†æ®µè®°å½•åˆ°bioä¸­ å¦‚æœè¯·æ±‚çš„æ•°æ®å¤§äºä¸€ä¸ªbioå…è®¸çš„æœ€å¤§æ•°æ®é‡ï¼Œåˆ™å°†è¯·æ±‚åˆ†æˆå¤šä¸ªbio è°ƒç”¨submit_bioæäº¤bioè¯·æ±‚ submit_bioå‡½æ•°ç»è¿‡å±‚å±‚è°ƒç”¨ï¼Œæœ€ç»ˆè°ƒç”¨å—è®¾å¤‡è¯·æ±‚é˜Ÿåˆ—ä¸­çš„make_request_fnæˆå‘˜å‡½æ•°å°†bioæäº¤ç»™I/Oè°ƒåº¦å±‚è¿›è¡Œå¤„ç† generic_make_requestå‡½æ•°å°†bioè¿æ¥åˆ°current-\u003ebio_listé“¾è¡¨ä¸­ï¼Œå¹¶è°ƒç”¨__generic_make_requestå‡½æ•°æäº¤é“¾è¡¨ä¸­æ‰€æœ‰çš„bioã€‚ __generic_make_requestå‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨å—è®¾å¤‡çš„è¯·æ±‚é˜Ÿåˆ—ä¸­çš„make_request_fnæˆå‘˜å‡½æ•°å°†bioè¯·æ±‚å‘é€ç»™I/Oè°ƒåº¦å±‚ï¼Œè‡³æ­¤å¯¹ç£ç›˜çš„æ•°æ®è¯·æ±‚ç¦»å¼€é€šç”¨å—å±‚ï¼Œè¿›å…¥ä¸‹ä¸€å±‚â€”â€”I/Oè°ƒåº¦å±‚ 2.3 åŠ¨æ€æ ¡éªŒæµç¨‹ verity_map bio-\u003ebi_end_io = verity_end_io; verity_end_io INIT_WORK(\u0026io-\u003ework, verity_work); queue_work(io-\u003ev-\u003everify_wq, \u0026io-\u003ework); verity_work verity_finish_io verity_verify_io struct bio *bio = dm_bio_from_per_bio_data for (b = 0; b \u003c io-\u003en_blocks; b++) verity_fec_decode DMWARN_LIMIT(\"%s: FEC: recursion too deep\", v-\u003edata_dev-\u003ename); verity_handle_err DMERR_LIMIT(\"%s: %s block %llu is corrupted\", v-\u003edata_dev-\u003ename, type_str, block); __submit_bio blk_mq_submit_bio bio_endio ///kernel_platform/msm-kernel/block/bio.c bio-\u003ebi_end_io c12345678910111213141516171819202122 struct dm_verity_io { 72 struct dm_verity *v; 73 74 /* original value of bio-\u003ebi_end_io */ 75 bio_end_io_t *orig_bi_end_io; 76 77 sector_t block; 78 unsigned n_blocks; 79 80 struct bvec_iter iter; 81 82 struct work_struct work; 83 84 /* 85 * Three variably-size fields follow this struct: 86 * 87 * u8 hash_req[v-\u003eahash_reqsize]; 88 * u8 real_digest[v-\u003edigest_size]; 89 * u8 want_digest[v-\u003edigest_size]; 90 * 91 * To access them use: verity_io_hash_req(), verity_io_real_digest() 92 * and verity_io_want_digest(). 93 */ 94 }; c123456789101112131415161718192021222324 int verity_hash_for_block(struct dm_verity *v, struct dm_verity_io *io, 335 sector_t block, u8 *digest, bool *is_zero) 336 { 337 int r = 0, i; 339 if (likely(v-\u003elevels)) { 340 /* 341 * First, we try to get the requested hash for 342 * the current block. If the hash block itself is 343 * verified, zero is returned. If it isn't, this 344 * function returns 1 and we fall back to whole 345 * chain verification. 346 */ 347 r = verity_verify_level(v, io, block, 0, true, digest); 348 if (likely(r \u003c= 0)) 349 goto out; 350 } 352 memcpy(digest, v-\u003eroot_digest, v-\u003edigest_size); 354 for (i = v-\u003elevels - 1; i \u003e= 0; i--) { 355 r = verity_verify_level(v, io, block, i, false, digest); 356 if (unlikely(r)) 357 goto out; 358 } 359 out: 360 if (!r \u0026\u0026 v-\u003ezero_digest) 361 *is_zero = !memcmp(v-\u003ezero_digest, digest, v-\u003edigest_size); 362 else 363 *is_zero = false; 364 365 return r; 366 } c123456789101112131415161718192021222324252627282930 2.4 æ ¸å¿ƒæ ¡éªŒæ•°æ® struct dm_verity { 35 struct dm_dev *data_dev; 36 struct dm_dev *hash_dev; 37 struct dm_target *ti; 38 struct dm_bufio_client *bufio; 39 char *alg_name; 40 struct crypto_ahash *tfm; 41 u8 *root_digest; /* digest of the root block */ 42 u8 *salt; /* salt: its size is salt_size */ 43 u8 *zero_digest; /* digest for a zero block */ 44 unsigned salt_size; 45 sector_t data_start; /* data offset in 512-byte sectors */ 46 sector_t hash_start; /* hash start in blocks */ 47 sector_t data_blocks; /* the number of data blocks */ 48 sector_t hash_blocks;","date":"2025-11-04","objectID":"/posts/avb%E6%A0%A1%E9%AA%8C%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%9D%97%E6%A0%A1%E9%AA%8C%E5%8E%9F%E7%90%86/:0:2","tags":["clippings","blog","è½¬è½½"],"title":"avbæ ¡éªŒç›¸å…³ä¸å—æ ¡éªŒåŸç†","uri":"/posts/avb%E6%A0%A1%E9%AA%8C%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%9D%97%E6%A0%A1%E9%AA%8C%E5%8E%9F%E7%90%86/#24-æ ¸å¿ƒæ ¡éªŒæ•°æ®"},{"categories":null,"collections":null,"content":"ä¸‰ã€initç”¨æˆ·æ€æµç¨‹ FirstStageMain FirstStageMount::DoFirstStageMount FirstStageMount::MountPartitions FirstStageMount::MountPartition FirstStageMountVBootV2::SetUpDmVerity AvbHandle::LoadAndVerifyVbmeta Failed to load offline vbmeta for c1234567 ","date":"2025-11-04","objectID":"/posts/avb%E6%A0%A1%E9%AA%8C%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%9D%97%E6%A0%A1%E9%AA%8C%E5%8E%9F%E7%90%86/:0:3","tags":["clippings","blog","è½¬è½½"],"title":"avbæ ¡éªŒç›¸å…³ä¸å—æ ¡éªŒåŸç†","uri":"/posts/avb%E6%A0%A1%E9%AA%8C%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%9D%97%E6%A0%A1%E9%AA%8C%E5%8E%9F%E7%90%86/#ä¸‰initç”¨æˆ·æ€æµç¨‹"},{"categories":null,"collections":null,"content":"å›› æ¸…é™¤panicæ ‡è¯† adb shell reboot \"dm-verity enforcing\" reboot \"dm-verity device corrupted\" c123 ","date":"2025-11-04","objectID":"/posts/avb%E6%A0%A1%E9%AA%8C%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%9D%97%E6%A0%A1%E9%AA%8C%E5%8E%9F%E7%90%86/:0:4","tags":["clippings","blog","è½¬è½½"],"title":"avbæ ¡éªŒç›¸å…³ä¸å—æ ¡éªŒåŸç†","uri":"/posts/avb%E6%A0%A1%E9%AA%8C%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%9D%97%E6%A0%A1%E9%AA%8C%E5%8E%9F%E7%90%86/#å››-æ¸…é™¤panicæ ‡è¯†"},{"categories":null,"collections":null,"content":"äº” dm-verityå»ºç«‹è¿‡ç¨‹ åœ¨Device Mapper ï¼ˆDMï¼‰ä¸­ä½¿ç”¨dm-verityæ—¶ï¼Œéœ€è¦é…ç½®ä¸€ä¸ªå“ˆå¸Œæ ‘ï¼ˆhash treeï¼‰ï¼Œä»¥ä¾¿éªŒè¯å—è®¾å¤‡ä¸Šçš„æ•°æ®çš„å®Œæ•´æ€§ã€‚è¿™é€šå¸¸é€šè¿‡åœ¨dmsetupå‘½ä»¤ä¸­çš„ç›®æ ‡è¡¨ï¼ˆtarget tableï¼‰å‚æ•°ä¸­æŒ‡å®šç›¸å…³å‚æ•°æ¥å®Œæˆã€‚ä»¥ä¸‹æ˜¯å¦‚ä½•ä¸ºdm-mapperä¸­çš„dm-verityæ„å»ºä¸€ä¸ªå“ˆå¸Œæ ‘é…ç½®è¡¨çš„ä¸€èˆ¬æ­¥éª¤ï¼š åˆ›å»ºæºå—è®¾å¤‡ ï¼šé¦–å…ˆï¼Œä½ éœ€è¦åˆ›å»ºä¸€ä¸ªæ™®é€šçš„å—è®¾å¤‡ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªå·²ç»å­˜åœ¨çš„å—è®¾å¤‡ï¼Œä¾‹å¦‚ç¡¬ç›˜åˆ†åŒºæˆ–è€…ä¸€ä¸ªé•œåƒæ–‡ä»¶ã€‚ é€‰æ‹©å“ˆå¸Œç®—æ³• ï¼šç¡®å®šè¦ä½¿ç”¨çš„å“ˆå¸Œç®—æ³•ã€‚dm-verityæ”¯æŒå¤šç§å“ˆå¸Œç®—æ³•ï¼ŒåŒ…æ‹¬SHA-256ã€SHA-1ã€SHA-512ç­‰ã€‚ä½ éœ€è¦é€‰æ‹©ä¸€ä¸ªé€‚åˆä½ çš„éœ€æ±‚çš„å“ˆå¸Œç®—æ³•ã€‚ ç”Ÿæˆå“ˆå¸Œè¡¨ ï¼šä½¿ç”¨ç”Ÿæˆ å“ˆå¸Œè¡¨ çš„å·¥å…·ï¼Œä¾‹å¦‚veritysetupå·¥å…·ï¼Œæ¥ä¸ºæºå—è®¾å¤‡ç”Ÿæˆå“ˆå¸Œè¡¨ã€‚è¿™ä¸ªå“ˆå¸Œè¡¨åŒ…å«äº†å—è®¾å¤‡ä¸­æ¯ä¸ªå—çš„å“ˆå¸Œå€¼ã€‚é€šå¸¸ï¼Œä½ å¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥ç”Ÿæˆå“ˆå¸Œè¡¨ï¼š veritysetup format /dev/source_device /dev/mapper/verity_device c1 å…¶ä¸­ï¼Œ/dev/source_device æ˜¯æºå—è®¾å¤‡ï¼Œ/dev/mapper/verity_device æ˜¯dm-verityè®¾å¤‡ã€‚è¿™ä¸ªå‘½ä»¤å°†ç”Ÿæˆå“ˆå¸Œè¡¨å¹¶å°†å…¶å­˜å‚¨åœ¨dm-verityè®¾å¤‡ä¸Šã€‚ é…ç½®dm-verityç›®æ ‡ ï¼šä½¿ç”¨dmsetupå‘½ä»¤é…ç½®dm-verityç›®æ ‡ã€‚ä½ éœ€è¦æä¾›å“ˆå¸Œæ ‘çš„æ ¹å“ˆå¸Œå€¼ã€å—å¤§å°ã€æºå—è®¾å¤‡å’Œdm-verityè®¾å¤‡çš„åç§°ã€‚é€šå¸¸ï¼Œé…ç½®è¡¨çœ‹èµ·æ¥åƒè¿™æ ·ï¼š dmsetup create verity_device --table '0 \u003cblock_size\u003e verity \u003croot_hash\u003e /dev/source_device /dev/mapper/verity_device' c1 å…¶ä¸­ï¼Œ\u003cblock_size\u003e æ˜¯å—çš„å¤§å°ï¼Œ\u003croot_hash\u003e æ˜¯å“ˆå¸Œæ ‘çš„æ ¹å“ˆå¸Œå€¼ã€‚ ä½¿ç”¨dm-verityè®¾å¤‡ ï¼šä¸€æ—¦dm-verityè®¾å¤‡è¢«åˆ›å»ºï¼Œä½ å¯ä»¥åƒä½¿ç”¨ä»»ä½•å…¶ä»–å—è®¾å¤‡ä¸€æ ·ä½¿ç”¨å®ƒã€‚æ•°æ®å°†åœ¨è¯»å–æ—¶è¢«éªŒè¯ï¼Œä»¥ç¡®ä¿å…¶å®Œæ•´æ€§ã€‚ è¿™é‡Œçš„å…³é”®æ˜¯ç”Ÿæˆå“ˆå¸Œè¡¨å¹¶é…ç½®dm-verityç›®æ ‡ï¼Œä»¥ä¾¿éªŒè¯æ•°æ®çš„å®Œæ•´æ€§ã€‚å“ˆå¸Œè¡¨æ˜¯dm-verityéªŒè¯æ•°æ®å®Œæ•´æ€§æ‰€å¿…éœ€çš„ï¼Œå› ä¸ºå®ƒåŒ…å«äº†æºæ•°æ®å—çš„å“ˆå¸Œå€¼ï¼Œç”¨äºéªŒè¯æ•°æ®æ˜¯å¦è¢«ç¯¡æ”¹ã€‚é…ç½®è¡¨æŒ‡å®šäº†å¦‚ä½•ä½¿ç”¨å“ˆå¸Œè¡¨ä»¥åŠå…¶ä»–ç›¸å…³å‚æ•°ã€‚é…ç½®è¡¨çš„æ ¼å¼å–å†³äºdm-verityç›®æ ‡çš„å®ç°å’Œä½ çš„éœ€æ±‚ï¼Œä½†é€šå¸¸æ˜¯ä¸€ä¸ªåŒ…å«æ‰€éœ€å‚æ•°çš„æ–‡æœ¬å­—ç¬¦ä¸²ã€‚ ubuntu ä¸Šdm-mapperç›¸å…³ä¿¡æ¯ï¼š astro@astrox:~/code/test$ sudo lvdisplay --maps /dev/mapper/ubuntu--vg-ubuntu--lv --- Logical volume --- LV Path /dev/ubuntu-vg/ubuntu-lv LV Name ubuntu-lv VG Name ubuntu-vg LV UUID fSgsCj-fCWR-JeiN-WWQL-xPdv-T1gZ-QO9f9M LV Write Access read/write LV Creation host, time ubuntu-server, 2023-05-09 09:07:38 +0000 LV Status available # open 1 LV Size 49.25 GiB Current LE 12608 Segments 1 Allocation inherit Read ahead sectors auto - currently set to 256 Block device 253:0 --- Segments --- Logical extents 0 to 12607: Type linear Physical volume /dev/sda3 Physical extents 0 to 12607 c123456789101112131415161718192021222324 å‚è€ƒï¼š https://aliez22.github.io/posts/11537/ https://www.shili8.cn/article/detail_20000194464.html ","date":"2025-11-04","objectID":"/posts/avb%E6%A0%A1%E9%AA%8C%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%9D%97%E6%A0%A1%E9%AA%8C%E5%8E%9F%E7%90%86/:0:5","tags":["clippings","blog","è½¬è½½"],"title":"avbæ ¡éªŒç›¸å…³ä¸å—æ ¡éªŒåŸç†","uri":"/posts/avb%E6%A0%A1%E9%AA%8C%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%9D%97%E6%A0%A1%E9%AA%8C%E5%8E%9F%E7%90%86/#äº”-dm-verityå»ºç«‹è¿‡ç¨‹"},{"categories":null,"collections":null,"content":"å®ç”¨å‘½ä»¤æ±‡æ€» ä»»åŠ¡ å‘½ä»¤ å¤šæ ¸å‹ç¼©ç›®å½• `tar -cvf - /data å¤šæ ¸è§£å‹æ–‡ä»¶ `pigz -dc -p 4 /backup/data.tar.gz ç®€å†™å‹ç¼©å‘½ä»¤ tar --use-compress-program=\"pigz -p 4\" -cvf data.tar.gz /data ç®€å†™è§£å‹å‘½ä»¤ tar --use-compress-program=\"pigz -dp 4\" -xvf data.tar.gz å‹ç¼©å‘½ä»¤ tar -cvf - /data | pigz -p $(nproc)-2 \u003e /backup/backup.tar.gz è§£å‹ pigz -dc -p $(nproc)-2 /backup/backup.tar.gz | tar -xvf - -p $(nproc)-1 ","date":"2025-10-28","objectID":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/:1:0","tags":["clippings","blog","å·¥å…·"],"title":"Linux ä¸‹ä½¿ç”¨ tar ä¸ pigz è¿›è¡Œå¤šæ ¸å‹ç¼©","uri":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/#å®ç”¨å‘½ä»¤æ±‡æ€»"},{"categories":null,"collections":null,"content":"ğŸ“˜ Linux ä¸‹ä½¿ç”¨ tar ä¸ pigz è¿›è¡Œå¤šæ ¸å‹ç¼© ","date":"2025-10-28","objectID":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/:2:0","tags":["clippings","blog","å·¥å…·"],"title":"Linux ä¸‹ä½¿ç”¨ tar ä¸ pigz è¿›è¡Œå¤šæ ¸å‹ç¼©","uri":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/#-linux-ä¸‹ä½¿ç”¨-tar-ä¸-pigz-è¿›è¡Œå¤šæ ¸å‹ç¼©"},{"categories":null,"collections":null,"content":"ä¸€ã€æ¦‚è¿° åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œ tar æ˜¯æœ€å¸¸ç”¨çš„å½’æ¡£ï¼ˆæ‰“åŒ…ï¼‰å·¥å…·ä¹‹ä¸€ï¼Œç”¨äºå°†å¤šä¸ªæ–‡ä»¶æˆ–ç›®å½•åˆå¹¶ä¸ºä¸€ä¸ªæ–‡ä»¶ã€‚ è€Œ gzip æ˜¯å¸¸ç”¨çš„å‹ç¼©å·¥å…·ï¼Œç”¨äºå¯¹æ–‡ä»¶å†…å®¹è¿›è¡Œå‹ç¼©ã€‚ tar ä¸ gzip å¸¸æ­é…ä½¿ç”¨å½¢æˆå‘½ä»¤ï¼š tar -czf backup.tar.gz /data ä½†è¿™ç§æ–¹å¼çš„ä¸€ä¸ªæ˜æ˜¾é™åˆ¶æ˜¯ï¼š âš ï¸ tar ä¸ gzip å‡ä¸ºå•çº¿ç¨‹ç¨‹åºï¼Œåªèƒ½ä½¿ç”¨ä¸€ä¸ª CPU æ ¸å¿ƒã€‚ å½“ç³»ç»Ÿ CPU è¾ƒå¤šã€æ–‡ä»¶è¾ƒå¤§æ—¶ï¼ˆå¦‚ 10GB ä»¥ä¸Šï¼‰ï¼Œè¿™ç§å•çº¿ç¨‹å‹ç¼©ä¼šæˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚ ä¸ºè§£å†³è¿™ä¸€é—®é¢˜ï¼Œæ¨èä½¿ç”¨ **pigz** ï¼ˆParallel Implementation of GZipï¼‰ ï¼Œ å®ƒæ˜¯ gzip çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ï¼Œå¯ä»¥å……åˆ†åˆ©ç”¨å¤šæ ¸ CPU è¿›è¡Œå‹ç¼©ã€‚ ","date":"2025-10-28","objectID":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/:3:0","tags":["clippings","blog","å·¥å…·"],"title":"Linux ä¸‹ä½¿ç”¨ tar ä¸ pigz è¿›è¡Œå¤šæ ¸å‹ç¼©","uri":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/#ä¸€æ¦‚è¿°"},{"categories":null,"collections":null,"content":"äºŒã€tar ä¸ pigz çš„å…³ç³»ä¸å·¥ä½œæ–¹å¼ tar ä¸ pigz å®é™…æ˜¯ä¸¤ä¸ªç‹¬ç«‹ç¨‹åºï¼š ç¨‹åº åŠŸèƒ½ æ˜¯å¦å¤šçº¿ç¨‹ tar è´Ÿè´£æ‰“åŒ…ï¼ˆå°†å¤šä¸ªæ–‡ä»¶åˆå¹¶ä¸ºä¸€ä¸ªæ•°æ®æµï¼‰ âŒ å•çº¿ç¨‹ pigz è´Ÿè´£å‹ç¼©ï¼ˆå°†æ•°æ®æµå‹ç¼©æˆ gzip æ ¼å¼ï¼‰ âœ… å¤šçº¿ç¨‹ ","date":"2025-10-28","objectID":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/:4:0","tags":["clippings","blog","å·¥å…·"],"title":"Linux ä¸‹ä½¿ç”¨ tar ä¸ pigz è¿›è¡Œå¤šæ ¸å‹ç¼©","uri":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/#äºŒtar-ä¸-pigz-çš„å…³ç³»ä¸å·¥ä½œæ–¹å¼"},{"categories":null,"collections":null,"content":"1ï¸âƒ£ tar çš„èŒè´£ tar çš„ä»»åŠ¡æ˜¯è¯»å–æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ•°æ®ï¼Œç„¶åè¾“å‡ºä¸€ä¸ª æœªå‹ç¼©çš„æ•°æ®æµ ã€‚ è¿™ä¸ªè¿‡ç¨‹å‡ ä¹ä¸æ¶‰åŠå¤æ‚è®¡ç®—ï¼Œä¸»è¦æ˜¯ I/O æ“ä½œã€‚ ç¤ºä¾‹ï¼š tar -cvf - /data è¿™æ¡å‘½ä»¤ä¸ä¼šç”Ÿæˆæ–‡ä»¶ï¼Œè€Œæ˜¯å°†å½’æ¡£å†…å®¹è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼ˆstdoutï¼‰ã€‚ - è¡¨ç¤ºâ€œå†™åˆ°æ ‡å‡†è¾“å‡ºâ€ã€‚ ","date":"2025-10-28","objectID":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/:4:1","tags":["clippings","blog","å·¥å…·"],"title":"Linux ä¸‹ä½¿ç”¨ tar ä¸ pigz è¿›è¡Œå¤šæ ¸å‹ç¼©","uri":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/#1-tar-çš„èŒè´£"},{"categories":null,"collections":null,"content":"2ï¸âƒ£ pigz çš„èŒè´£ pigz ä»æ ‡å‡†è¾“å…¥ï¼ˆstdinï¼‰æ¥æ”¶æ•°æ®æµï¼Œå¹¶å¯¹å…¶è¿›è¡Œå¹¶è¡Œå‹ç¼©ã€‚ ç¤ºä¾‹ï¼š pigz -p 4 \u003e backup.tar.gz -p 4 è¡¨ç¤ºä½¿ç”¨ 4 ä¸ªçº¿ç¨‹è¿›è¡Œå‹ç¼©ã€‚ å®ƒä¼šæ ¹æ® CPU æ ¸å¿ƒæ•°é‡è‡ªåŠ¨åˆ’åˆ†å‹ç¼©å—å¹¶å¹¶è¡Œè®¡ç®—ã€‚ ","date":"2025-10-28","objectID":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/:4:2","tags":["clippings","blog","å·¥å…·"],"title":"Linux ä¸‹ä½¿ç”¨ tar ä¸ pigz è¿›è¡Œå¤šæ ¸å‹ç¼©","uri":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/#2-pigz-çš„èŒè´£"},{"categories":null,"collections":null,"content":"3ï¸âƒ£ äºŒè€…çš„ç»„åˆï¼šæµå¼ç®¡é“å‹ç¼© é€šè¿‡ Linux ç®¡é“ï¼ˆ | ï¼‰æœºåˆ¶ï¼Œå¯ä»¥è®© tar ä¸ pigz åŒæ—¶å·¥ä½œï¼š tar -cvf - /data | pigz -p 4 \u003e /backup/backup.tar.gz æ‰§è¡Œæ—¶çš„å¹¶è¡Œæµç¨‹å¦‚ä¸‹ï¼š â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ tar: è¯»å–æ–‡ä»¶å¹¶æ‰“åŒ…æµå¼è¾“å‡º â”‚ ---\u003e â”‚ pigz: å¤šçº¿ç¨‹å‹ç¼©æ•°æ®æµ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ (å•çº¿ç¨‹) (å¤šçº¿ç¨‹)1.2.3.4. è¿è¡Œç»“æœï¼š tar ä¾ç„¶æ˜¯å•çº¿ç¨‹ï¼› pigz ä½¿ç”¨ 4 ä¸ª CPU æ ¸ï¼› ç®¡é“æœºåˆ¶ä¿è¯ä¸¤è€…è¾¹è¯»è¾¹å‹ç¼©ã€æ— é¡»ä¸­é—´æ–‡ä»¶ï¼› æ•´ä½“ CPU åˆ©ç”¨ç‡é«˜ã€å†…å­˜å ç”¨ä½ã€å‹ç¼©é€Ÿåº¦æ˜¾è‘—æå‡ã€‚ ","date":"2025-10-28","objectID":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/:4:3","tags":["clippings","blog","å·¥å…·"],"title":"Linux ä¸‹ä½¿ç”¨ tar ä¸ pigz è¿›è¡Œå¤šæ ¸å‹ç¼©","uri":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/#3-äºŒè€…çš„ç»„åˆæµå¼ç®¡é“å‹ç¼©"},{"categories":null,"collections":null,"content":"ä¸‰ã€ä¸ºä»€ä¹ˆ tar åªèƒ½ä½¿ç”¨ä¸€ä¸ª CPUï¼Ÿ tar æ˜¯ä¸€ç§å…¸å‹çš„â€œæµå¼å½’æ¡£â€å·¥å…·ï¼Œå®ƒé¡ºåºåœ°éå†æ–‡ä»¶ç³»ç»Ÿã€è¯»å–æ–‡ä»¶å¹¶å†™å…¥è¾“å‡ºæµã€‚ è¿™ç§é¡ºåºå¤„ç†æ¨¡å¼çš„æ ¸å¿ƒç‰¹ç‚¹æ˜¯ï¼š æ¯æ¬¡åªå¤„ç†ä¸€ä¸ªæ–‡ä»¶ï¼› ä¸è¿›è¡Œå¤æ‚è¿ç®—ï¼› ä¸å…·å¤‡æ•°æ®å—åˆ’åˆ†ä¸å¹¶å‘å¤„ç†æœºåˆ¶ï¼› å¹¶å‘è¯»å–æ–‡ä»¶è¿˜å¯èƒ½ç ´åå½’æ¡£çš„é¡ºåºä¸€è‡´æ€§ã€‚ å› æ­¤ï¼š ğŸ§  ç»“è®ºï¼š tar çš„æ ¸å¿ƒç“¶é¢ˆä¸æ˜¯ CPUï¼Œè€Œæ˜¯ç£ç›˜ I/Oã€‚ å³ä½¿æœºå™¨æœ‰ 8 æ ¸ã€16 æ ¸ï¼Œ tar è‡ªèº«ä»ç„¶åªä½¿ç”¨ 1 ä¸ªæ ¸å¿ƒã€‚ ","date":"2025-10-28","objectID":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/:5:0","tags":["clippings","blog","å·¥å…·"],"title":"Linux ä¸‹ä½¿ç”¨ tar ä¸ pigz è¿›è¡Œå¤šæ ¸å‹ç¼©","uri":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/#ä¸‰ä¸ºä»€ä¹ˆ-tar-åªèƒ½ä½¿ç”¨ä¸€ä¸ª-cpu"},{"categories":null,"collections":null,"content":"å››ã€å¦‚ä½•ä½¿ç”¨å¤šæ ¸è¿›è¡Œå‹ç¼© ","date":"2025-10-28","objectID":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/:6:0","tags":["clippings","blog","å·¥å…·"],"title":"Linux ä¸‹ä½¿ç”¨ tar ä¸ pigz è¿›è¡Œå¤šæ ¸å‹ç¼©","uri":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/#å››å¦‚ä½•ä½¿ç”¨å¤šæ ¸è¿›è¡Œå‹ç¼©"},{"categories":null,"collections":null,"content":"âœ… æ–¹æ¡ˆä¸€ï¼štar + pigzï¼ˆæ¨èï¼‰ tar -cvf - /data | pigz -p 4 \u003e /backup/backup.tar.gz è¯´æ˜ï¼š å‚æ•° å«ä¹‰ -cvf - æ‰“åŒ…å¹¶è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡º pigz -p 4 ä½¿ç”¨ 4 ä¸ªçº¿ç¨‹å‹ç¼© \u003e å°†å‹ç¼©åçš„æ•°æ®å†™å…¥ç›®æ ‡æ–‡ä»¶ æ€§èƒ½ç‰¹å¾ï¼š tar å ç”¨çº¦ 1 æ ¸ï¼› pigz å ç”¨ 4 æ ¸ï¼› æ€»å…±åˆ©ç”¨ 5 æ ¸ï¼› å‹ç¼©é€Ÿåº¦é€šå¸¸æ˜¯å•çº¿ç¨‹ gzip çš„ 3~5 å€ã€‚ ","date":"2025-10-28","objectID":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/:6:1","tags":["clippings","blog","å·¥å…·"],"title":"Linux ä¸‹ä½¿ç”¨ tar ä¸ pigz è¿›è¡Œå¤šæ ¸å‹ç¼©","uri":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/#-æ–¹æ¡ˆä¸€tar--pigzæ¨è"},{"categories":null,"collections":null,"content":"âœ… æ–¹æ¡ˆäºŒï¼štar å†…ç½®è°ƒç”¨ pigzï¼ˆæ›´ç®€æ´ï¼‰ è®¸å¤š Linux å‘è¡Œç‰ˆçš„ tar å·²æ”¯æŒç›´æ¥ä½¿ç”¨ pigz æ›¿ä»£ gzip ï¼š tar --use-compress-program=\"pigz -p 4\" -cvf /backup/backup.tar.gz /data ç­‰ä»·äºï¼š tar -cvf - /data | pigz -p 4 \u003e /backup/backup.tar.gz ä¼˜ç‚¹ï¼š å‘½ä»¤æ›´ç®€æ´ï¼› å½’æ¡£å’Œå‹ç¼©ç”± tar ç®¡ç†ï¼› åŒæ ·æ”¯æŒå¤šæ ¸ã€‚ ","date":"2025-10-28","objectID":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/:6:2","tags":["clippings","blog","å·¥å…·"],"title":"Linux ä¸‹ä½¿ç”¨ tar ä¸ pigz è¿›è¡Œå¤šæ ¸å‹ç¼©","uri":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/#-æ–¹æ¡ˆäºŒtar-å†…ç½®è°ƒç”¨-pigzæ›´ç®€æ´"},{"categories":null,"collections":null,"content":"âœ… æ–¹æ¡ˆä¸‰ï¼šè§£å‹æ—¶å¤šæ ¸è§£å‹ åŒæ ·ï¼Œè§£å‹æ—¶ä¹Ÿå¯ä»¥åˆ©ç”¨å¤šæ ¸ï¼š pigz -dc -p 4 /backup/backup.tar.gz | tar -xvf - æˆ–è€…æ›´ç®€æ´çš„å½¢å¼ï¼š tar --use-compress-program=\"pigz -dp 4\" -xvf /backup/backup.tar.gz ","date":"2025-10-28","objectID":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/:6:3","tags":["clippings","blog","å·¥å…·"],"title":"Linux ä¸‹ä½¿ç”¨ tar ä¸ pigz è¿›è¡Œå¤šæ ¸å‹ç¼©","uri":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/#-æ–¹æ¡ˆä¸‰è§£å‹æ—¶å¤šæ ¸è§£å‹"},{"categories":null,"collections":null,"content":"äº”ã€æ€§èƒ½å¯¹æ¯”ç¤ºä¾‹ï¼ˆ8 æ ¸ CPUï¼‰ å·¥å…· å‹ç¼©æ–¹å¼ CPUä½¿ç”¨ å‹ç¼©æ—¶é—´(18GBæ–‡ä»¶) `tar gzip` å•çº¿ç¨‹ 100% of 1 CPU `tar pigz -p 4` å¤šçº¿ç¨‹ï¼ˆ4æ ¸ï¼‰ ~400% `tar pigz -p 8` å¤šçº¿ç¨‹ï¼ˆ8æ ¸ï¼‰ ~800% ï¼ˆå®é™…é€Ÿåº¦å–å†³äºç£ç›˜ I/Oã€æ–‡ä»¶ç±»å‹ã€å‹ç¼©æ¯”ç­‰å› ç´ ï¼‰ ","date":"2025-10-28","objectID":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/:7:0","tags":["clippings","blog","å·¥å…·"],"title":"Linux ä¸‹ä½¿ç”¨ tar ä¸ pigz è¿›è¡Œå¤šæ ¸å‹ç¼©","uri":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/#äº”æ€§èƒ½å¯¹æ¯”ç¤ºä¾‹8-æ ¸-cpu"},{"categories":null,"collections":null,"content":"å…­ã€åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„æœ€ä½³å®è·µ åœºæ™¯ æ¨èå‘½ä»¤ è¯´æ˜ 4 æ ¸æœºå™¨ `tar -cvf - /data pigz -p 3 \u003e /backup/data.tar.gz` 8 æ ¸æœºå™¨ `tar -cvf - /data pigz -p 6 \u003e /backup/data.tar.gz` è‡ªåŠ¨æ£€æµ‹ CPU pigz -p $(($(nproc)-1)) è‡ªåŠ¨ä½¿ç”¨é™¤ 1 å¤–çš„å…¨éƒ¨ CPU ","date":"2025-10-28","objectID":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/:8:0","tags":["clippings","blog","å·¥å…·"],"title":"Linux ä¸‹ä½¿ç”¨ tar ä¸ pigz è¿›è¡Œå¤šæ ¸å‹ç¼©","uri":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/#å…­åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„æœ€ä½³å®è·µ"},{"categories":null,"collections":null,"content":"ä¸ƒã€æ€»ç»“ é¡¹ç›® tar gzip pigz åŠŸèƒ½ æ‰“åŒ… å‹ç¼© å¤šçº¿ç¨‹å‹ç¼© æ˜¯å¦å¤šçº¿ç¨‹ âŒ âŒ âœ… å¯æ›¿ä»£ gzip âŒ âœ… âœ… æ¨èç”¨é€” æ‰“åŒ…æ–‡ä»¶ å…¼å®¹è€ç³»ç»Ÿå‹ç¼© ç°ä»£å¤šæ ¸ç¯å¢ƒå‹ç¼© ä¸ tar é…åˆæ–¹å¼ è¾“å‡ºåˆ°ç®¡é“ tar -czf `tar ","date":"2025-10-28","objectID":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/:9:0","tags":["clippings","blog","å·¥å…·"],"title":"Linux ä¸‹ä½¿ç”¨ tar ä¸ pigz è¿›è¡Œå¤šæ ¸å‹ç¼©","uri":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/#ä¸ƒæ€»ç»“"},{"categories":null,"collections":null,"content":"ä¹ã€ç»“è¯­ tar çš„ç“¶é¢ˆæ˜¯ I/Oï¼Œè€Œé CPUï¼› pigz èƒ½æ˜¾è‘—æé«˜å‹ç¼©æ€§èƒ½ï¼› tar + pigz çš„ç»„åˆæ˜¯å¤§æ–‡ä»¶å¤‡ä»½çš„ä¸šç•Œæœ€ä½³å®è·µï¼› åˆç†æ§åˆ¶çº¿ç¨‹æ•°é‡ï¼ˆå¦‚ -p 3 æˆ– -p $(nproc)-1 ï¼‰å¯ä»¥åœ¨æ€§èƒ½ä¸ç³»ç»Ÿç¨³å®šæ€§é—´å–å¾—æœ€ä½³å¹³è¡¡ã€‚ ","date":"2025-10-28","objectID":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/:10:0","tags":["clippings","blog","å·¥å…·"],"title":"Linux ä¸‹ä½¿ç”¨ tar ä¸ pigz è¿›è¡Œå¤šæ ¸å‹ç¼©","uri":"/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/#ä¹ç»“è¯­"},{"categories":null,"collections":null,"content":"ä½œä¸ºä¸€ç§è‹±è¯­çš„ä½¿ç”¨å·¥å…·,ç¬¬ä¸€è¦å¬æ‡‚,ç¬¬äºŒè¦ä¼šè¯´.ç¬¬ä¸‰è¦çœ‹æ‡‚ ","date":"2025-10-23","objectID":"/posts/%E5%AD%A6%E4%B9%A0%E8%8B%B1%E8%AF%AD%E6%89%93%E5%8D%A1/:0:0","tags":["blog"],"title":"å­¦ä¹ è‹±è¯­æ‰“å¡","uri":"/posts/%E5%AD%A6%E4%B9%A0%E8%8B%B1%E8%AF%AD%E6%89%93%E5%8D%A1/#"},{"categories":null,"collections":null,"content":"èƒŒå•è¯ ä¸‡ä¸ˆé«˜æ¥¼å¹³åœ°èµ·,èƒŒå•è¯.4-6çº§æ—¥å¸¸è¶³å¤Ÿ. ç™¾è¯æ–©ç”¨èµ·æ¥ ","date":"2025-10-23","objectID":"/posts/%E5%AD%A6%E4%B9%A0%E8%8B%B1%E8%AF%AD%E6%89%93%E5%8D%A1/:0:1","tags":["blog"],"title":"å­¦ä¹ è‹±è¯­æ‰“å¡","uri":"/posts/%E5%AD%A6%E4%B9%A0%E8%8B%B1%E8%AF%AD%E6%89%93%E5%8D%A1/#èƒŒå•è¯"},{"categories":null,"collections":null,"content":"å¬ èµ°éç¾å›½ å¤šå¬ ","date":"2025-10-23","objectID":"/posts/%E5%AD%A6%E4%B9%A0%E8%8B%B1%E8%AF%AD%E6%89%93%E5%8D%A1/:0:2","tags":["blog"],"title":"å­¦ä¹ è‹±è¯­æ‰“å¡","uri":"/posts/%E5%AD%A6%E4%B9%A0%E8%8B%B1%E8%AF%AD%E6%89%93%E5%8D%A1/#å¬"},{"categories":null,"collections":null,"content":"è¯´ AI Chart ","date":"2025-10-23","objectID":"/posts/%E5%AD%A6%E4%B9%A0%E8%8B%B1%E8%AF%AD%E6%89%93%E5%8D%A1/:0:3","tags":["blog"],"title":"å­¦ä¹ è‹±è¯­æ‰“å¡","uri":"/posts/%E5%AD%A6%E4%B9%A0%E8%8B%B1%E8%AF%AD%E6%89%93%E5%8D%A1/#è¯´"},{"categories":null,"collections":null,"content":"è¯» ","date":"2025-10-23","objectID":"/posts/%E5%AD%A6%E4%B9%A0%E8%8B%B1%E8%AF%AD%E6%89%93%E5%8D%A1/:0:4","tags":["blog"],"title":"å­¦ä¹ è‹±è¯­æ‰“å¡","uri":"/posts/%E5%AD%A6%E4%B9%A0%E8%8B%B1%E8%AF%AD%E6%89%93%E5%8D%A1/#è¯»"},{"categories":null,"collections":null,"content":"å†™ è‹±è¯­è§„åˆ’ èƒŒå•è¯ ç™¾è¯æ–© â€“ ç†Ÿæ‚‰å•è¯ 100å¤© -â€“ ç™¾è¯æ–©ä¸€è½®å,ä½¿ç”¨å¢¨å¢¨èƒŒå•è¯,åŠ æ·±è®°å¿†. -â€“ å¢¨å¢¨ä¸€è½®å,ç»§ç»­ä½¿ç”¨å¢¨å¢¨èƒŒ6çº§å•è¯ å¬è¯´ æŠ¥ç™¾è¯æ–©çš„å¬è¯´è¯¾ å¬èµ°éç¾å›½ å†™å•è¯ ","date":"2025-10-23","objectID":"/posts/%E5%AD%A6%E4%B9%A0%E8%8B%B1%E8%AF%AD%E6%89%93%E5%8D%A1/:0:5","tags":["blog"],"title":"å­¦ä¹ è‹±è¯­æ‰“å¡","uri":"/posts/%E5%AD%A6%E4%B9%A0%E8%8B%B1%E8%AF%AD%E6%89%93%E5%8D%A1/#å†™"},{"categories":null,"collections":null,"content":"æœ‰ä¸€ä¸ªé—®é¢˜,å°±æ˜¯é…ç½®äº†uwb,å¦‚æœåœ¨æ²¡æœ‰uwbçš„æœºå™¨ä¸Š,ä¼šä¸åœçš„å¯åŠ¨uwbçš„æœåŠ¡. 09-29 10:19:45.885 1 1 E init : Control message: Could not find 'aidl/android.hardware.uwb.IUwb/default' for ctl.interface_start from pid: 441 (/system/bin/servicemanager) 09-29 10:19:45.942 441 29301 W libc : Unable to set property \"ctl.interface_start\" to \"aidl/android.hardware.uwb.IUwb/default\": PROP_ERROR_HANDLE_CONTROL_MESSAGE (0x20) 09-29 10:19:45.948 1725 4002 W ServiceManagerCppClient: Waited one second for android.hardware.uwb.IUwb/default (is service started? Number of threads started in the threadpool: 32. Are binder threads started and available?) ç½‘ç»œä¸Šçš„ä¸€ä¸ªç±»ä¼¼çš„æ–¹æ¡ˆ: static bool HandleControlMessage(std::string_view message, const std::string\u0026 name,pid_t from_pid) { + if(\"aidl/android.hardware.biometrics.fingerprint.IFingerprint/default\" == name){ + return true; + } std::string cmdline_path = StringPrintf(\"proc/%d/cmdline\", from_pid); std::string process_cmdline; if (ReadFileToString(cmdline_path, \u0026process_cmdline)) { std::replace(process_cmdline.begin(), process_cmdline.end(), '\\0', ' '); process_cmdline = Trim(process_cmdline); } else { process_cmdline = \"unknown process\"; } } é‚£ä¹ˆè¿›è¿‡éªŒè¯,å¯¹uwbæ²¡æœ‰ä½œç”¨. è¿›è¿‡è°ƒè¯•,å¦‚æœæŠŠæ”¯æŒuwb çš„featureåˆ é™¤, ç¡®è®¤æœåŠ¡æ˜¯ä¸ä¼šå¯åŠ¨çš„.æ‰€ä»¥æˆ‘ä»¬åœ¨pmsé‡Œå¢åŠ çš„æ‰“å°å †æ ˆ é€šè¿‡å †æ ˆ,æˆ‘ä»¬å‘ç°æ˜¯åœ¨SystemServerä¸­ /** * Starts a miscellaneous grab bag of stuff that has yet to be refactored and organized. */ private void startOtherServices(@NonNull TimingsTraceAndSlog t) { t.traceBegin(\"startOtherServices\"); if (context.getPackageManager().hasSystemFeature(PackageManager.FEATURE_UWB)) { t.traceBegin(\"UwbService\"); mSystemServiceManager.startServiceFromJar(UWB_SERVICE_CLASS, UWB_APEX_SERVICE_JAR_PATH); t.traceEnd(); } æ‰€ä»¥æˆ‘ä»¬çš„ä¿®æ”¹æ–¹æ¡ˆå°±æ˜¯åœ¨æ²¡æœ‰uwbçš„æœºå™¨ä¸Š,å¦‚æœéœ€è¦è·å–hasSystemFeatureçš„åœ°æ–¹,ç»™è¿”å›false. frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java public boolean hasSystemFeature(String name, int version) { // allow instant applications if(\"android.hardware.uwb\".equals(name)) { //Log.d(\"PackageManagerService wentao\", \"wentao hasSystemFeature uwb\" +Log.getStackTraceString(new Throwable())); //getprop ro.hw.mcu.mac String mcuMac = SystemProperties.get(\"ro.hw.mcu.mac\", \"(unknown)\"); Log.d(\"PackageManagerService\", \"mcuMac: \" + mcuMac); if(\"(unknown)\".equals(mcuMac)) { return false; }else{ return true; } } è¿™ä¸ªåˆ¤æ–­uwbçš„åˆ¤æ–­æ¡ä»¶ä¸€å®šè¦åœ¨systemserver startOtherServices ä¹‹å‰,ä¸ç„¶æ—¶åºä¸å¯¹. ","date":"2025-10-23","objectID":"/posts/%E6%80%BB%E7%BB%93-%E5%88%A4%E6%96%ADuwb%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E9%97%AE%E9%A2%98/:0:0","tags":["blog","å®æˆ˜"],"title":"æ€»ç»“  åˆ¤æ–­uwbæœåŠ¡å¯åŠ¨é—®é¢˜","uri":"/posts/%E6%80%BB%E7%BB%93-%E5%88%A4%E6%96%ADuwb%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E9%97%AE%E9%A2%98/#"},{"categories":null,"collections":null,"content":"avbæ ¡éªŒç›¸å…³ä¸å—æ ¡éªŒåŸç† adb reboot recovery adb root adb shell reboot \"dm-verity enforcing\" ","date":"2025-09-11","objectID":"/posts/%E5%BC%80%E6%9C%BA%E6%97%B6%E6%8F%90%E7%A4%BA-your-device-is-corrupt/:0:0","tags":["blog","Framework"],"title":"å¼€æœºæ—¶æç¤º your device is corruptï¼Ÿ","uri":"/posts/%E5%BC%80%E6%9C%BA%E6%97%B6%E6%8F%90%E7%A4%BA-your-device-is-corrupt/#"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"æœ¬æ–‡åŸºäºå·¥ä½œä¸­è‡ªåŠ¨èƒŒå…‰ç¬”è®°æ‰©å……äº†ä¸‹ï¼Œè®°å½•ä¸‹è‡ªåŠ¨èƒŒå…‰ç®—æ³•ã€‚ åŸºäºAndroid 8.1, ä»£ç å¯å‚çœ‹ http://androidxref.com/8.1.0_â€¦ Android 9åŠ å…¥äº†æ‰€è°“çš„æœºå™¨å­¦ä¹ ç®—æ³•ï¼Œæ ¹æ®ç”¨æˆ·è°ƒèŠ‚æ—¶äº®åº¦å’Œå…‰æ„Ÿé‡æ–°ç”Ÿæˆæ›²çº¿ï¼Œ è‡ªåŠ¨èƒŒå…‰æ—¶çš„æ»‘åŠ¨æ¡ä¸å†æ˜¯è°ƒèŠ‚adjustmentå€¼ï¼Œæš‚æ—¶ä¸æƒ³å†™äº†ã€‚ã€‚ã€‚ Android 10ç®€å•çœ‹äº†ä¸‹ï¼ŒåŠ å…¥äº†å¯¹foregroundåº”ç”¨çš„å¾®è°ƒæ”¯æŒï¼Œæš‚æ—¶ä¸æƒ³å†™äº†ã€‚ã€‚ã€‚ ","date":"2025-08-21","objectID":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"è‡ªåŠ¨èƒŒå…‰ç®—æ³•-Android 8.1","uri":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/#"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"ä¸€ã€ç®€å•è¯´è¯´ ç®€å•çš„è¯´ï¼Œå…¶å®èƒŒå…‰è°ƒèŠ‚å°±ä¸‰å¤§æ­¥ï¼Œå»ºæ›²çº¿ï¼Œé‡‡æ ·å»æŠ–ï¼Œè®¡ç®—äº®åº¦ ","date":"2025-08-21","objectID":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"è‡ªåŠ¨èƒŒå…‰ç®—æ³•-Android 8.1","uri":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/#ä¸€ç®€å•è¯´è¯´"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"1. å»ºæ›²çº¿ Brightness 1 ^ | | | ã€‚ | ã€‚ | ã€‚ + ã€‚ min+ ã€‚ | 0---+---+-------------------\u003e lux min å»ºæ›²çº¿è¿™ä¸ªå…¶å®å°±æ˜¯å»ºç«‹ä¸€ä¸ªluxå¯¹åº”çš„brightnessçš„æ›²çº¿ï¼Œè¿™æ ·å°±å¯ä»¥æ ¹æ®å…‰æ„Ÿä¼ æ¥çš„luxå€¼ï¼Œè®¡ç®—å‡ºå¯¹åº”çš„äº®åº¦ä¸ºå¤šå°‘ã€‚ ï¼ˆå®‰å“çš„ç®—æ³•éœ€è¦Brightnessæ¯”luxå¤šä¸€ä¸ªå€¼ï¼Œæ‰€ä»¥ä¸Šå›¾æ›²çº¿ä¸¤è€…çš„minå€¼ä¸å¯¹åº”ã€‚å¦å¤–éœ€è¦ä¸¥æ ¼å•è°ƒé€’å¢ï¼Œç»„æ•°çœ‹éœ€è¦ï¼Œä¸Šå›¾åªæ˜¯ä¸ªç¤ºæ„ï¼‰ ","date":"2025-08-21","objectID":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"è‡ªåŠ¨èƒŒå…‰ç®—æ³•-Android 8.1","uri":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/#1-å»ºæ›²çº¿"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"2. é‡‡æ ·å»æŠ– è¿™ä¸ªå°±æ˜¯é‡‡é›†ä¸€æ®µæ—¶é—´å†…çš„luxå€¼ï¼Œç„¶åæ ¹æ®è¿™æ®µæ—¶é—´çš„lux,ç®—å‡ºè¿™æ®µæ—¶é—´çš„luxå€¼ã€‚ å½“ç„¶è€ƒè™‘åˆ°æŠ–åŠ¨(å¦‚æœ‰é—ªç”µç­‰çªç„¶å˜åŒ–å¾ˆå¤§ï¼Œç„¶ååˆæ¢å¤çš„æƒ…å†µ;æˆ–è€…å‘¨æœŸæ€§çš„æ˜æš—æ˜æš—å˜åŒ–ç­‰æƒ…å†µï¼‰ï¼Œæ‰€ä»¥éœ€è¦å»æŠ–ï¼Œ é»˜è®¤å®‰å“æ˜¯è¦æ±‚å…‰ç…§ç¨³å®šåœ¨0.8~1.1å€ä¹‹é—´ï¼Œå¹¶ä¸”æŒç»­ä¸€æ®µæ—¶é—´ï¼ˆç”±æš—åˆ°äº®æ˜¯4ç§’ï¼Œç”±äº®åˆ°æš—æ˜¯8sï¼‰ ","date":"2025-08-21","objectID":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/:1:2","tags":["clippings","è½¬è½½","blog"],"title":"è‡ªåŠ¨èƒŒå…‰ç®—æ³•-Android 8.1","uri":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/#2-é‡‡æ ·å»æŠ–"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"3. è®¡ç®—äº®åº¦ å®‰å“çš„ç®—æ³•æµç¨‹ 1). å¼€è‡ªåŠ¨èƒŒå…‰æ—¶ï¼Œä¸‹æ‹‰é€šçŸ¥æ¡ä¸ºä¸€ç³»æ•°ï¼Œå‡è®¾ä¸ºx,å…¶åŒºé—´ä¸º[-1.0, 1.0], åº”ç”¨å±‚ä¸ºé™¤ä»¥1024,æµ®ç‚¹ç²¾åº¦ 2). è®¡ç®—èƒŒå…‰æ—¶ï¼Œå…ˆè®¡ç®—å‡ºluxå¯¹åº”çš„äº®åº¦ï¼Œå‡è®¾ä¸ºy,å…¶åŒºé—´ä¸º[0.0, 1.0], è€ƒè™‘ä¸ºç”¨æˆ·ä¼šå¾®è°ƒï¼Œæ‰€ä»¥ç„¶åå†å¤„ç†ç”¨æˆ·å¾®è°ƒ(1ä¸­çš„x) 3). æœ€ç»ˆè®¡ç®—å±å¹•äº®åº¦zå‘ä¸‹å–æ•´ 4). ç„¶åå†å¤„ç†zçš„æå€¼åŒºé—´ï¼Œä¾‹å¦‚æˆ‘ä»¬è®¾ç½®çš„11255, 18255 ç”¨å…¬å¼è¡¨ç¤ºå³ä¸º $$ \\mathbf{z = y^{3^{-x}}*255, x\\in[-1.0, 1.0], y\\in[0.0, 1.0], z\\in[min, 255]} $$ å…¬å¼ä¸­3è¡¨ç¤ºä¸ºgamma3.0,åé¢æ˜¯3çš„-xæ¬¡æ–¹,å³$3^{-x}$ ä¸¾ä¸ªä¾‹å­ï¼Œ / å‡ºåœ°åº“ å…‰ç…§ç¨³å®šåœ¨0.8~1.1å€ä¹‹é—´4S / | | |/ +---------+-----------------------+-------------- 10lux 5000lux å¼€å§‹æ”¹å˜å±å¹•ï¼Œå‡è®¾å±å¹•äº®åº¦ä»55 -\u003e 255, é‚£ä¹ˆäº®åº¦è°ƒèŠ‚å®Œéœ€è¦æ—¶é—´ä¸º((255-55)/rampRate)*16.6ms, çº¦3.3S (16.6msæ˜¯ä¸€ä¸ªvsyncæ—¶é—´ï¼ŒrampRateé»˜è®¤ä¸º1ï¼Œå¯ä»¥æ›´æ”¹è¿›è¡Œé€Ÿç‡è°ƒèŠ‚) ","date":"2025-08-21","objectID":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/:1:3","tags":["clippings","è½¬è½½","blog"],"title":"è‡ªåŠ¨èƒŒå…‰ç®—æ³•-Android 8.1","uri":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/#3-è®¡ç®—äº®åº¦"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"äºŒã€è¯´ç‚¹ä»£ç  ä»£ç åˆ†æå…¶å®åŸºæœ¬ä¹Ÿæ˜¯æŒ‰ç…§å‰é¢çš„ä¸‰ç‚¹æ¥è¯´çš„ï¼Œ ","date":"2025-08-21","objectID":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"è‡ªåŠ¨èƒŒå…‰ç®—æ³•-Android 8.1","uri":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/#äºŒè¯´ç‚¹ä»£ç "},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"1. å»ºæ›²çº¿é…ç½® frameworks/base/core/res/res/values/config.xml \u003cbool name=\"config_automatic_brightness_available\"\u003efalse\u003c/bool\u003e \u003c!-- è‡ªåŠ¨èƒŒå…‰åŠŸèƒ½æ˜¯å¦å¯ç”¨å¼€å…³ --\u003e \u003cinteger-array name=\"config_autoBrightnessLevels\"\u003e \u003c!-- lux æ•°ç»„ --\u003e \u003c/integer-array\u003e \u003cinteger-array name=\"config_autoBrightnessLcdBacklightValues\"\u003e \u003c!-- å¯¹åº”lcd brightness æ•°ç»„ --\u003e \u003c/integer-array\u003e æ›²çº¿çš„é…ç½®ä¸ºå¦‚ä¸Šé¢çš„ä»£ç é‡Œï¼Œé»˜è®¤å®‰å“æ˜¯æ²¡æœ‰é…ç½®çš„ï¼Œéœ€è¦è‡ªå·±ä¿®æ”¹æˆ–è€…overlay, å¦å¤–è¿˜æœ‰ä¸ªæ˜¯å¦ä½¿ç”¨è‡ªåŠ¨èƒŒå…‰çš„å¼€å…³ config_automatic_brightness_availableï¼Œé»˜è®¤å…³çš„ï¼Œéœ€è¦æ‰“å¼€ã€‚ ä»£ç é‡Œéƒ½æœ‰è¯¦ç»†çš„æ³¨é‡Šå’Œè¯´æ˜å¯çœ‹çœ‹ï¼Œæˆ‘è¿™å„¿å°±æ²¡è´´å‡ºæ¥äº†ã€‚ config_autoBrightnessLevelsä¸ºluxæ•°ç»„ config_autoBrightnessLcdBacklightValuesä¸ºå¯¹åº”çš„lcdäº®åº¦å€¼ï¼Œ æ¯”luxæ•°ç»„å¤šä¸€ä¸ªï¼Œç»„æˆå’Œæ›²çº¿éœ€è¦ä¸¥æ ¼å•è°ƒé€’å¢ã€‚ config_autoBrightnessLevels -\u003e lux config_autoBrightnessLcdBacklightValues -\u003e brightness --\u003e brightness[0] lux[0] --\u003e brightness[1] lux[1] --\u003e brightness[2] lux[2] --\u003e brightness[3] ..... ","date":"2025-08-21","objectID":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/:2:1","tags":["clippings","è½¬è½½","blog"],"title":"è‡ªåŠ¨èƒŒå…‰ç®—æ³•-Android 8.1","uri":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/#1-å»ºæ›²çº¿é…ç½®"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"2. æ›²çº¿åˆå§‹åŒ– æ›²çº¿è®¾ç½®å¥½äº†ï¼Œå°±åº”è¯¥æ‰”ä»£ç é‡Œè·‘èµ·æ¥ï¼Œæ¨¡å‹å»ºèµ·æ¥äº†ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯å’‹æ ·çš„å‘¢ï¼Ÿ é€šè¿‡æœç´¢é…ç½®å…³é”®è¯( config_automatic_brightness_available config_autoBrightnessLevels config_autoBrightnessLcdBacklightValues ) æˆ–çŸ¥é“å…¶åœ¨DisplayPowerController()æ„é€ çš„æ—¶å€™åˆå§‹åŒ–çš„ã€‚ frameworks/base/services/core/java/com/android/server/display/DisplayPowerController.java public DisplayPowerController(......) { ...... // ä½¿èƒ½å¼€å…³ mUseSoftwareAutoBrightnessConfig = resources.getBoolean( com.android.internal.R.bool.config_automatic_brightness_available); ...... if (mUseSoftwareAutoBrightnessConfig) { // å…‰æ„Ÿæ•°ç»„ int[] lux = resources.getIntArray( com.android.internal.R.array.config_autoBrightnessLevels); // èƒŒå…‰äº®åº¦æ•°ç»„ int[] screenBrightness = resources.getIntArray( com.android.internal.R.array.config_autoBrightnessLcdBacklightValues); // å…¶å®ƒä¸€äº›é…ç½® int lightSensorWarmUpTimeConfig = resources.getInteger( com.android.internal.R.integer.config_lightSensorWarmupTime); final float dozeScaleFactor = resources.getFraction( com.android.internal.R.fraction.config_screenAutoBrightnessDozeScaleFactor, 1, 1); // åˆ›å»ºè‡ªåŠ¨èƒŒå…‰æ ·æ¡ Spline screenAutoBrightnessSpline = createAutoBrightnessSpline(lux, screenBrightness); if (screenAutoBrightnessSpline == null) { // å¦‚æœlux, brightnessä¸åˆè¦æ±‚ï¼Œç¦ç”¨è‡ªåŠ¨èƒŒå…‰ Slog.e(TAG, \"Error in config.xml. config_autoBrightnessLcdBacklightValues \" + \"(size \" + screenBrightness.length + \") \" + \"must be monotic and have exactly one more entry than \" + \"config_autoBrightnessLevels (size \" + lux.length + \") \" + \"which must be strictly increasing. \" + \"Auto-brightness will be disabled.\"); mUseSoftwareAutoBrightnessConfig = false; } else { ...... mAutomaticBrightnessController = new AutomaticBrightnessController(this, handler.getLooper(), sensorManager, screenAutoBrightnessSpline, ...// gamma, æœ€å¤§æœ€å°å€¼ç­‰å…¶ä»–é…ç½® } } å¦‚æœæ‰“å¼€äº†è‡ªåŠ¨èƒŒå…‰åŠŸèƒ½ï¼Œä¼šæ ¹æ®luxå’Œbrightnessæ•°ç»„ï¼Œåˆ›å»ºæ ·æ¡æ›²çº¿ï¼ˆä»¥å¾—åˆ°ä¸€æ¡å…‰æ»‘æ›²çº¿ï¼Œå®‰å“é‡‡ç”¨çš„æ˜¯ä¸‰æ¬¡æ ·æ¡æ’å€¼ï¼Œæœ‰å…´è¶£çš„å¯ä»¥æœç´¢ä¸‹å­¦ä¹ å­¦ä¹ ï¼‰ï¼Œ å¦‚æœæ•°ç»„ä¸æ»¡è¶³è¦æ±‚ï¼Œä¼šç¦ç”¨è‡ªåŠ¨èƒŒå…‰åŠŸèƒ½ã€‚ åˆ›å»ºæ ·æ¡æ›²çº¿æˆåŠŸåèµ‹å€¼ç»™ AutomaticBrightnessController(),åé¢èƒŒå…‰æ§åˆ¶çš„ä¸»ä½“é€»è¾‘å°±è½¬åˆ° AutomaticBrightnessControllerç±»é‡Œäº†ã€‚ AutomaticBrightnessController()æ„é€ å°±ä¸€äº›èµ‹å€¼ï¼Œæ²¡å•¥å¯çœ‹çš„ï¼Œé‡ç‚¹çœ‹ä¸‹ createAutoBrightnessSpline() private static Spline createAutoBrightnessSpline(int[] lux, int[] brightness) { ...... // å½’ä¸€åŒ–brightness[0]ä½œä¸ºy[0] y[0] = normalizeAbsoluteBrightness(brightness[0]); // å¤„ç†å¯¹åº”çš„luxå’Œbrightness for (int i = 1; i \u003c n; i++) { x[i] = lux[i - 1]; y[i] = normalizeAbsoluteBrightness(brightness[i]); } Spline spline = Spline.createSpline(x, y); ...... } åˆ›å»ºæ ·æ¡æ—¶ä¼šåšbrightnesså½’ä¸€åŒ–ï¼Œå³é™¤ä»¥255,å°†èƒŒå…‰å€¼0255é™å®šåœ¨01ä¹‹é—´ï¼Œ luxä¸ºæ¨ªåæ ‡xè½´, å½’ä¸€åŒ–çš„äº®åº¦ä¸ºyè½´ï¼Œ ä¹‹åå†è°ƒç”¨createSpline()åˆ›å»ºæ ·æ¡ã€‚ frameworks/base/core/java/android/util/Spline.java public static Spline createSpline(float[] x, float[] y) { // æ˜¯å¦ä¸¥æ ¼å•è°ƒé€’å¢ if (!isStrictlyIncreasing(x)) { throw new IllegalArgumentException(\"The control points must all have strictly \" + \"increasing X values.\"); } // å•è°ƒçš„è¿˜æ˜¯çº¿æ€§çš„ if (isMonotonic(y)) { // åˆ›å»ºå•è°ƒä¸‰æ¬¡æ ·æ¡æ’å€¼ return createMonotoneCubicSpline(x, y); } else { return createLinearSpline(x, y); } } createSpline()å…ˆæ£€æŸ¥æ˜¯å¦ä¸¥æ ¼å•è°ƒé€’å¢ï¼Œç„¶åçœ‹æ˜¯å•è°ƒçš„è¿˜æ˜¯çº¿æ€§çš„ï¼Œå¦‚æœæ˜¯çº¿æ€§çš„ï¼Œé‚£è¿™å¥½è¯´ï¼Œå°±ä¸€æ¡ç›´çº¿ï¼Œè®¡ç®—ä¹Ÿæ–¹ä¾¿ï¼Œ æ²¡å•¥å¯çœ‹çš„ï¼Œæ‰€ä»¥å¯ä»¥ç»§ç»­çœ‹ä¸‹ createMonotoneCubicSpline()ã€‚ public static Spline createMonotoneCubicSpline(float[] x, float[] y) { return new MonotoneCubicSpline(x, y); } public static class MonotoneCubicSpline extends Spline { // ä¸»è¦çš„å°±æ˜¯è¿™ä¸‰ä¸ªæ•°ç»„ï¼Œæ¨ªåæ ‡x,çºµåæ ‡y,ä»¥åŠç›¸é‚»ç‚¹çš„æ–œç‡ private float[] mX; private float[] mY; private float[] mM; public MonotoneCubicSpline(float[] x, float[] y) { .... // då­˜æ”¾ç›¸é‚»ç‚¹çš„æ–œç‡ï¼Œmå­˜æ”¾ç›¸é‚»ä¸¤æ–œç‡çš„å¹³å‡å€¼ float[] d = new float[n - 1]; // could optimize this out float[] m = new float[n]; // Compute slopes of secant lines between successive points. for (int i = 0; i \u003c n - 1; i++) { float h = x[i + 1] - x[i]; ... // ç›¸é‚»ç‚¹æ–œç‡ d[i] = (y[i + 1] - y[i]) / h; } // Initialize the tangents as the average of the secants. m[0] = d[0]; for (int i = 1; i \u003c n - 1; i++) { // ç›¸é‚»ä¸¤æ–œç‡çš„å¹³å‡å€¼ m[i] = (d[i - 1] + d[i]) * 0.5f; } m[n - 1] = d[n - 2]; // Update the tangents to preserve monotonicity. // å†æ¬¡æ›´æ–°mä»¥ä¿æŒå•è°ƒæ€§ for (int i = 0; i \u003c n - 1; i++) { if (d[i] == 0f) { // successive Y values are equal m[i] = 0f; m[i + 1] = 0f; } else { float a = m[i] / d[i]; float b = m[i + 1] / d[i]; if (a \u003c 0f || b \u003c 0f) { throw new IllegalArgumentException(\"T","date":"2025-08-21","objectID":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/:2:2","tags":["clippings","è½¬è½½","blog"],"title":"è‡ªåŠ¨èƒŒå…‰ç®—æ³•-Android 8.1","uri":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/#2-æ›²çº¿åˆå§‹åŒ–"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"3. é‡‡æ ·å»æŠ– å‰é¢çœ‹äº†æ ·æ¡æ›²çº¿çš„å»ºç«‹è¿‡ç¨‹ï¼Œè¿™èŠ‚æˆ‘ä»¬å…ˆçœ‹ä¸‹luxé‡‡é›†å¤„ç†è¿‡ç¨‹ã€‚ 3.1 é‡‡æ · è¦æœ‰æ•°æ®è‚¯å®šå…ˆæŠŠsensoræ‰“é€šï¼Œ frameworks/base/services/core/java/com/android/server/display/DisplayPowerController.java private void updatePowerState() { int brightness = PowerManager.BRIGHTNESS_DEFAULT; ...... // æ£€æŸ¥æ˜¯å¦ä½¿èƒ½è‡ªåŠ¨èƒŒå…‰ autoBrightnessEnabled = mPowerRequest.useAutoBrightness \u0026\u0026 (state == Display.STATE_ON || autoBrightnessEnabledInDoze) // è¿™ä¸ªbrightnessä¸Dozeæ¨¡å¼æ˜¯å¦å…è®¸ä½¿ç”¨è‡ªåŠ¨èƒŒå…‰é…ç½®æœ‰å…³ï¼Œä¸æ˜¯è¡¨ç¤ºå±å¹•äº®åº¦\u003c0,é»˜è®¤æ˜¯BRIGHTNESS_DEFAULTä¸º-1 \u0026\u0026 brightness \u003c 0; mAutomaticBrightnessController.configure(autoBrightnessEnabled, mPowerRequest.screenAutoBrightnessAdjustment, state != Display.STATE_ON, userInitiatedChange); å…¶ä¸­updatePowerState()æ—¶ä¼šæ ¹æ®çŠ¶æ€å’Œæ¡ä»¶çœ‹æ˜¯å¦ä½¿èƒ½è‡ªåŠ¨èƒŒå…‰ï¼Œ è¿™æ¡æ¡ä»¶æ˜¯ ç”µæºè¯·æ±‚æ˜¯å¦ä½¿ç”¨è‡ªåŠ¨èƒŒå…‰ï¼Œæ˜¾ç¤ºçŠ¶æ€æ˜¯å¦ä¸ºå¼€ï¼ŒDozeæ¨¡å¼æ˜¯å¦å…è®¸ frameworks/base/services/core/java/com/android/server/display/AutomaticBrightnessController.java public void configure(boolean enable, float adjustment, boolean dozing, boolean userInitiatedChange) { ...... boolean changed = setLightSensorEnabled(enable \u0026\u0026 !dozing); ...... } å¦‚æœè‡ªåŠ¨èƒŒå…‰ä½¿èƒ½äº†ä¸”édozingä¸­ï¼Œä¼šå°†å…‰æ„Ÿä½¿èƒ½ï¼Œè¿™é‡Œé¢å°±æ˜¯sensor listenerçš„æ³¨å†Œï¼Œä¹‹åæœ‰å°±å¯ä»¥å¾—åˆ°luxæ•°æ®äº†, setLightSensorEnabled() æ³¨å†Œlistenerå°±ä¸è´´ä»£ç äº†ï¼Œè´´ä¸‹æ•°æ®å›è°ƒ private final SensorEventListener mLightSensorListener = new SensorEventListener() { @Override public void onSensorChanged(SensorEvent event) { if (mLightSensorEnabled) { final long time = SystemClock.uptimeMillis(); final float lux = event.values[0]; handleLightSensorEvent(time, lux); } } ...... }; private void handleLightSensorEvent(long time, float lux) { // å¦‚æœæœ‰ MSG_UPDATE_AMBIENT_LUX æ¶ˆæ¯ï¼Œåˆ™ç§»é™¤ mHandler.removeMessages(MSG_UPDATE_AMBIENT_LUX); ...... // æ›´æ–°ç¼“å†²åŒº applyLightSensorMeasurement(time, lux); // æ›´æ–°æ•°æ® updateAmbientLux(time); } private void applyLightSensorMeasurement(long time, float lux) { ...... // å°†å¤šå°‘å‘¨æœŸ(é»˜è®¤10s)å‰çš„æ•°æ®åˆ æ‰ mAmbientLightRingBuffer.prune(time - mAmbientLightHorizon); // å°†å½“å‰æ•°æ®æ”¾åˆ°ç¼“å†²ä¸­ mAmbientLightRingBuffer.push(time, lux); ..... } handleLightSensorEvent()é¦–å…ˆå–æ¶ˆäº† MSG_UPDATE_AMBIENT_LUX æ¶ˆæ¯ï¼Œ è¯¥æ¶ˆæ¯çš„ä½œç”¨æ˜¯å½“ä¼ æ„Ÿå™¨é•¿æ—¶é—´æ²¡æœ‰æ•°æ®ä¸ŠæŠ¥æ—¶ï¼Œå‘¨æœŸæ€§çš„æ›´æ–°ä¸€æŠŠç¼“å†²åŒºï¼Œ æŠŠè¿‡æœŸçš„æ•°æ®åˆ é™¤(ä½†éœ€è¦ä¿ç•™æœ€åä¸ªå€¼ï¼Œå¹¶æŠŠæ—¶é—´æ›´æ–°ä¸ºå½“å‰æ—¶é—´)(è¿™éƒ¨åˆ†æ˜¯ä¸æ˜¯å¯ä»¥ä¼˜åŒ–ä¸‹) ç„¶åè°ƒç”¨ applyLightSensorMeasurement()å°†è¿‡æœŸçš„æ•°æ®åˆ æ‰ï¼Œå¹¶å°†å½“å‰çš„å€¼åŠ å…¥åˆ°ç¼“å†²ä¸­ã€‚ é»˜è®¤çš„å‘¨æœŸä¸º10s \u003cinteger name=\"config_autoBrightnessAmbientLightHorizon\"\u003e10000\u003c/integer\u003e å³ç¼“å†²åªæœ€å¤šä¿ç•™10ç§’çš„æ•°æ®ï¼Œ æ³¨æ„è¿™é‡Œè¿˜åªæ˜¯æ•°æ®çš„ä¸€ä¸ªç®€å•è®°å½• ä¹‹åå†è°ƒç”¨updateAmbientLux() æ›´æ–°å€¼ï¼Œ æ³¨æ„è¯¥å‡½æ•°å·²ç»è¿›å…¥åˆ°é˜²æŠ–è¿‡ç¨‹äº† 3.1 é˜²æŠ– é˜²æŠ–çš„æµç¨‹éƒ½åœ¨updateAmbientLux()å‡½æ•°é‡Œï¼Œ ç„¶åç”¨HysteresisLevelsç±»è¾…åŠ©è®¡ç®—æ˜æš—å…‰æ„Ÿçš„é˜€å€¼ã€‚ private void updateAmbientLux(long time) { // If the light sensor was just turned on then immediately update our initial // estimate of the current ambient light level. if (!mAmbientLuxValid) { ...... // æ‰“å¼€sensoråç¬¬ä¸€æ¬¡æ›´æ–°æ•°æ®æƒ…å†µï¼Œç•¥è¿‡... } // è®¡ç®—æ˜æš—å˜åŒ–çš„æ—¶é—´ç‚¹ long nextBrightenTransition = nextAmbientLightBrighteningTransition(time); long nextDarkenTransition = nextAmbientLightDarkeningTransition(time); // è®¡ç®—10så’Œ2så†…çš„lux float slowAmbientLux = calculateAmbientLux(time, AMBIENT_LIGHT_LONG_HORIZON_MILLIS); float fastAmbientLux = calculateAmbientLux(time, AMBIENT_LIGHT_SHORT_HORIZON_MILLIS); // å¦‚æœæ»¡è¶³å»æŠ–çš„è¦æ±‚ï¼Œä¼šè¿›è¡Œluxå’Œäº®åº¦çš„è®¡ç®—æ›´æ–° if (slowAmbientLux \u003e= mBrighteningLuxThreshold \u0026\u0026 fastAmbientLux \u003e= mBrighteningLuxThreshold \u0026\u0026 nextBrightenTransition \u003c= time || slowAmbientLux \u003c= mDarkeningLuxThreshold \u0026\u0026 fastAmbientLux \u003c= mDarkeningLuxThreshold \u0026\u0026 nextDarkenTransition \u003c= time) { // æ›´æ–°luxå’Œæ˜æš—luxé˜€å€¼ setAmbientLux(fastAmbientLux); // è¿™ä¸ªlogåº”è¯¥æ”¾åœ¨setAmbientLux()å‰é¢ï¼Œä¸ç„¶ fastAmbientLux \u003e mAmbientLuxæ°¸è¿œä¸ºfalse if (DEBUG) { Slog.d(TAG, \"updateAmbientLux: \" + ((fastAmbientLux \u003e mAmbientLux) ? \"Brightened\" : \"Darkened\") + \": \" + \"mBrighteningLuxThreshold=\" + mBrighteningLuxThreshold + \", mAmbientLightRingBuffer=\" + mAmbientLightRingBuffer + \", mAmbientLux=\" + mAmbientLux); } // æ›´æ–°äº®åº¦ updateAutoBrightness(true); ...... mHandler.sendEmptyMessageAtTime(MSG_UPDATE_AMBIENT_LUX, nextTransitionTime); } æ•´ä¸ªæµç¨‹å¤§ä½“ä¸º è®¡ç®—æ˜æš—å˜åŒ–çš„æ—¶é—´ç‚¹ é˜²æ­¢å‘¨æœŸæ€§çš„å¤§å¹…åº¦æŠ–åŠ¨ è®¡ç®—2så’Œ10så†…çš„lux ç”¨äºå»æŠ–æ¯”è¾ƒï¼Œä½¿å…‰ç…§ç¨³å®šåœ¨0.8~1.1å€ä¹‹é—´ å¦‚æœæ»¡è¶³å»æŠ–çš„è¦æ±‚ï¼Œä¼šè¿›è¡Œluxã€æ˜æš—é˜€å€¼å’Œäº®åº¦çš„è®¡ç®—æ›´æ–° ä¸Šé¢ä»£ç éƒ½æœ‰æ³¨é‡Šï¼Œä¸‹é¢æˆ‘ä»¬çœ‹ä¸€äº›æ–¹æ³•çš„å…·ä½“ä»£ç  è®¡ç®—æ˜æš—å˜åŒ–(ç”±æš—åˆ°äº®åœºæ™¯ï¼Œç”±äº®åˆ°æš—åœºæ™¯)æ—¶é—´ç‚¹ private long nextAmbientLightBrighteningTransition(long time) { final int N = mAmbientLightRingBuffer.size(); long earliestValidTime = time; // ä»åå¾€å‰æ‰¾åˆ°ç¦»å½“å‰æ—¶é—´ç¬¬ä¸€ä¸ªå¤§äºé˜€å€¼çš„ç‚¹ for (int i = N - 1; i \u003e= 0; i--) { if (mAmbien","date":"2025-08-21","objectID":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/:2:3","tags":["clippings","è½¬è½½","blog"],"title":"è‡ªåŠ¨èƒŒå…‰ç®—æ³•-Android 8.1","uri":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/#3-é‡‡æ ·å»æŠ–"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"3. é‡‡æ ·å»æŠ– å‰é¢çœ‹äº†æ ·æ¡æ›²çº¿çš„å»ºç«‹è¿‡ç¨‹ï¼Œè¿™èŠ‚æˆ‘ä»¬å…ˆçœ‹ä¸‹luxé‡‡é›†å¤„ç†è¿‡ç¨‹ã€‚ 3.1 é‡‡æ · è¦æœ‰æ•°æ®è‚¯å®šå…ˆæŠŠsensoræ‰“é€šï¼Œ frameworks/base/services/core/java/com/android/server/display/DisplayPowerController.java private void updatePowerState() { int brightness = PowerManager.BRIGHTNESS_DEFAULT; ...... // æ£€æŸ¥æ˜¯å¦ä½¿èƒ½è‡ªåŠ¨èƒŒå…‰ autoBrightnessEnabled = mPowerRequest.useAutoBrightness \u0026\u0026 (state == Display.STATE_ON || autoBrightnessEnabledInDoze) // è¿™ä¸ªbrightnessä¸Dozeæ¨¡å¼æ˜¯å¦å…è®¸ä½¿ç”¨è‡ªåŠ¨èƒŒå…‰é…ç½®æœ‰å…³ï¼Œä¸æ˜¯è¡¨ç¤ºå±å¹•äº®åº¦\u003c0,é»˜è®¤æ˜¯BRIGHTNESS_DEFAULTä¸º-1 \u0026\u0026 brightness \u003c 0; mAutomaticBrightnessController.configure(autoBrightnessEnabled, mPowerRequest.screenAutoBrightnessAdjustment, state != Display.STATE_ON, userInitiatedChange); å…¶ä¸­updatePowerState()æ—¶ä¼šæ ¹æ®çŠ¶æ€å’Œæ¡ä»¶çœ‹æ˜¯å¦ä½¿èƒ½è‡ªåŠ¨èƒŒå…‰ï¼Œ è¿™æ¡æ¡ä»¶æ˜¯ ç”µæºè¯·æ±‚æ˜¯å¦ä½¿ç”¨è‡ªåŠ¨èƒŒå…‰ï¼Œæ˜¾ç¤ºçŠ¶æ€æ˜¯å¦ä¸ºå¼€ï¼ŒDozeæ¨¡å¼æ˜¯å¦å…è®¸ frameworks/base/services/core/java/com/android/server/display/AutomaticBrightnessController.java public void configure(boolean enable, float adjustment, boolean dozing, boolean userInitiatedChange) { ...... boolean changed = setLightSensorEnabled(enable \u0026\u0026 !dozing); ...... } å¦‚æœè‡ªåŠ¨èƒŒå…‰ä½¿èƒ½äº†ä¸”édozingä¸­ï¼Œä¼šå°†å…‰æ„Ÿä½¿èƒ½ï¼Œè¿™é‡Œé¢å°±æ˜¯sensor listenerçš„æ³¨å†Œï¼Œä¹‹åæœ‰å°±å¯ä»¥å¾—åˆ°luxæ•°æ®äº†, setLightSensorEnabled() æ³¨å†Œlistenerå°±ä¸è´´ä»£ç äº†ï¼Œè´´ä¸‹æ•°æ®å›è°ƒ private final SensorEventListener mLightSensorListener = new SensorEventListener() { @Override public void onSensorChanged(SensorEvent event) { if (mLightSensorEnabled) { final long time = SystemClock.uptimeMillis(); final float lux = event.values[0]; handleLightSensorEvent(time, lux); } } ...... }; private void handleLightSensorEvent(long time, float lux) { // å¦‚æœæœ‰ MSG_UPDATE_AMBIENT_LUX æ¶ˆæ¯ï¼Œåˆ™ç§»é™¤ mHandler.removeMessages(MSG_UPDATE_AMBIENT_LUX); ...... // æ›´æ–°ç¼“å†²åŒº applyLightSensorMeasurement(time, lux); // æ›´æ–°æ•°æ® updateAmbientLux(time); } private void applyLightSensorMeasurement(long time, float lux) { ...... // å°†å¤šå°‘å‘¨æœŸ(é»˜è®¤10s)å‰çš„æ•°æ®åˆ æ‰ mAmbientLightRingBuffer.prune(time - mAmbientLightHorizon); // å°†å½“å‰æ•°æ®æ”¾åˆ°ç¼“å†²ä¸­ mAmbientLightRingBuffer.push(time, lux); ..... } handleLightSensorEvent()é¦–å…ˆå–æ¶ˆäº† MSG_UPDATE_AMBIENT_LUX æ¶ˆæ¯ï¼Œ è¯¥æ¶ˆæ¯çš„ä½œç”¨æ˜¯å½“ä¼ æ„Ÿå™¨é•¿æ—¶é—´æ²¡æœ‰æ•°æ®ä¸ŠæŠ¥æ—¶ï¼Œå‘¨æœŸæ€§çš„æ›´æ–°ä¸€æŠŠç¼“å†²åŒºï¼Œ æŠŠè¿‡æœŸçš„æ•°æ®åˆ é™¤(ä½†éœ€è¦ä¿ç•™æœ€åä¸ªå€¼ï¼Œå¹¶æŠŠæ—¶é—´æ›´æ–°ä¸ºå½“å‰æ—¶é—´)(è¿™éƒ¨åˆ†æ˜¯ä¸æ˜¯å¯ä»¥ä¼˜åŒ–ä¸‹) ç„¶åè°ƒç”¨ applyLightSensorMeasurement()å°†è¿‡æœŸçš„æ•°æ®åˆ æ‰ï¼Œå¹¶å°†å½“å‰çš„å€¼åŠ å…¥åˆ°ç¼“å†²ä¸­ã€‚ é»˜è®¤çš„å‘¨æœŸä¸º10s 10000 å³ç¼“å†²åªæœ€å¤šä¿ç•™10ç§’çš„æ•°æ®ï¼Œ æ³¨æ„è¿™é‡Œè¿˜åªæ˜¯æ•°æ®çš„ä¸€ä¸ªç®€å•è®°å½• ä¹‹åå†è°ƒç”¨updateAmbientLux() æ›´æ–°å€¼ï¼Œ æ³¨æ„è¯¥å‡½æ•°å·²ç»è¿›å…¥åˆ°é˜²æŠ–è¿‡ç¨‹äº† 3.1 é˜²æŠ– é˜²æŠ–çš„æµç¨‹éƒ½åœ¨updateAmbientLux()å‡½æ•°é‡Œï¼Œ ç„¶åç”¨HysteresisLevelsç±»è¾…åŠ©è®¡ç®—æ˜æš—å…‰æ„Ÿçš„é˜€å€¼ã€‚ private void updateAmbientLux(long time) { // If the light sensor was just turned on then immediately update our initial // estimate of the current ambient light level. if (!mAmbientLuxValid) { ...... // æ‰“å¼€sensoråç¬¬ä¸€æ¬¡æ›´æ–°æ•°æ®æƒ…å†µï¼Œç•¥è¿‡... } // è®¡ç®—æ˜æš—å˜åŒ–çš„æ—¶é—´ç‚¹ long nextBrightenTransition = nextAmbientLightBrighteningTransition(time); long nextDarkenTransition = nextAmbientLightDarkeningTransition(time); // è®¡ç®—10så’Œ2så†…çš„lux float slowAmbientLux = calculateAmbientLux(time, AMBIENT_LIGHT_LONG_HORIZON_MILLIS); float fastAmbientLux = calculateAmbientLux(time, AMBIENT_LIGHT_SHORT_HORIZON_MILLIS); // å¦‚æœæ»¡è¶³å»æŠ–çš„è¦æ±‚ï¼Œä¼šè¿›è¡Œluxå’Œäº®åº¦çš„è®¡ç®—æ›´æ–° if (slowAmbientLux \u003e= mBrighteningLuxThreshold \u0026\u0026 fastAmbientLux \u003e= mBrighteningLuxThreshold \u0026\u0026 nextBrightenTransition \u003c= time || slowAmbientLux \u003c= mDarkeningLuxThreshold \u0026\u0026 fastAmbientLux \u003c= mDarkeningLuxThreshold \u0026\u0026 nextDarkenTransition \u003c= time) { // æ›´æ–°luxå’Œæ˜æš—luxé˜€å€¼ setAmbientLux(fastAmbientLux); // è¿™ä¸ªlogåº”è¯¥æ”¾åœ¨setAmbientLux()å‰é¢ï¼Œä¸ç„¶ fastAmbientLux \u003e mAmbientLuxæ°¸è¿œä¸ºfalse if (DEBUG) { Slog.d(TAG, \"updateAmbientLux: \" + ((fastAmbientLux \u003e mAmbientLux) ? \"Brightened\" : \"Darkened\") + \": \" + \"mBrighteningLuxThreshold=\" + mBrighteningLuxThreshold + \", mAmbientLightRingBuffer=\" + mAmbientLightRingBuffer + \", mAmbientLux=\" + mAmbientLux); } // æ›´æ–°äº®åº¦ updateAutoBrightness(true); ...... mHandler.sendEmptyMessageAtTime(MSG_UPDATE_AMBIENT_LUX, nextTransitionTime); } æ•´ä¸ªæµç¨‹å¤§ä½“ä¸º è®¡ç®—æ˜æš—å˜åŒ–çš„æ—¶é—´ç‚¹ é˜²æ­¢å‘¨æœŸæ€§çš„å¤§å¹…åº¦æŠ–åŠ¨ è®¡ç®—2så’Œ10så†…çš„lux ç”¨äºå»æŠ–æ¯”è¾ƒï¼Œä½¿å…‰ç…§ç¨³å®šåœ¨0.8~1.1å€ä¹‹é—´ å¦‚æœæ»¡è¶³å»æŠ–çš„è¦æ±‚ï¼Œä¼šè¿›è¡Œluxã€æ˜æš—é˜€å€¼å’Œäº®åº¦çš„è®¡ç®—æ›´æ–° ä¸Šé¢ä»£ç éƒ½æœ‰æ³¨é‡Šï¼Œä¸‹é¢æˆ‘ä»¬çœ‹ä¸€äº›æ–¹æ³•çš„å…·ä½“ä»£ç  è®¡ç®—æ˜æš—å˜åŒ–(ç”±æš—åˆ°äº®åœºæ™¯ï¼Œç”±äº®åˆ°æš—åœºæ™¯)æ—¶é—´ç‚¹ private long nextAmbientLightBrighteningTransition(long time) { final int N = mAmbientLightRingBuffer.size(); long earliestValidTime = time; // ä»åå¾€å‰æ‰¾åˆ°ç¦»å½“å‰æ—¶é—´ç¬¬ä¸€ä¸ªå¤§äºé˜€å€¼çš„ç‚¹ for (int i = N - 1; i \u003e= 0; i--) { if (mAmbien","date":"2025-08-21","objectID":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/:2:3","tags":["clippings","è½¬è½½","blog"],"title":"è‡ªåŠ¨èƒŒå…‰ç®—æ³•-Android 8.1","uri":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/#31-é‡‡æ ·"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"3. é‡‡æ ·å»æŠ– å‰é¢çœ‹äº†æ ·æ¡æ›²çº¿çš„å»ºç«‹è¿‡ç¨‹ï¼Œè¿™èŠ‚æˆ‘ä»¬å…ˆçœ‹ä¸‹luxé‡‡é›†å¤„ç†è¿‡ç¨‹ã€‚ 3.1 é‡‡æ · è¦æœ‰æ•°æ®è‚¯å®šå…ˆæŠŠsensoræ‰“é€šï¼Œ frameworks/base/services/core/java/com/android/server/display/DisplayPowerController.java private void updatePowerState() { int brightness = PowerManager.BRIGHTNESS_DEFAULT; ...... // æ£€æŸ¥æ˜¯å¦ä½¿èƒ½è‡ªåŠ¨èƒŒå…‰ autoBrightnessEnabled = mPowerRequest.useAutoBrightness \u0026\u0026 (state == Display.STATE_ON || autoBrightnessEnabledInDoze) // è¿™ä¸ªbrightnessä¸Dozeæ¨¡å¼æ˜¯å¦å…è®¸ä½¿ç”¨è‡ªåŠ¨èƒŒå…‰é…ç½®æœ‰å…³ï¼Œä¸æ˜¯è¡¨ç¤ºå±å¹•äº®åº¦\u003c0,é»˜è®¤æ˜¯BRIGHTNESS_DEFAULTä¸º-1 \u0026\u0026 brightness \u003c 0; mAutomaticBrightnessController.configure(autoBrightnessEnabled, mPowerRequest.screenAutoBrightnessAdjustment, state != Display.STATE_ON, userInitiatedChange); å…¶ä¸­updatePowerState()æ—¶ä¼šæ ¹æ®çŠ¶æ€å’Œæ¡ä»¶çœ‹æ˜¯å¦ä½¿èƒ½è‡ªåŠ¨èƒŒå…‰ï¼Œ è¿™æ¡æ¡ä»¶æ˜¯ ç”µæºè¯·æ±‚æ˜¯å¦ä½¿ç”¨è‡ªåŠ¨èƒŒå…‰ï¼Œæ˜¾ç¤ºçŠ¶æ€æ˜¯å¦ä¸ºå¼€ï¼ŒDozeæ¨¡å¼æ˜¯å¦å…è®¸ frameworks/base/services/core/java/com/android/server/display/AutomaticBrightnessController.java public void configure(boolean enable, float adjustment, boolean dozing, boolean userInitiatedChange) { ...... boolean changed = setLightSensorEnabled(enable \u0026\u0026 !dozing); ...... } å¦‚æœè‡ªåŠ¨èƒŒå…‰ä½¿èƒ½äº†ä¸”édozingä¸­ï¼Œä¼šå°†å…‰æ„Ÿä½¿èƒ½ï¼Œè¿™é‡Œé¢å°±æ˜¯sensor listenerçš„æ³¨å†Œï¼Œä¹‹åæœ‰å°±å¯ä»¥å¾—åˆ°luxæ•°æ®äº†, setLightSensorEnabled() æ³¨å†Œlistenerå°±ä¸è´´ä»£ç äº†ï¼Œè´´ä¸‹æ•°æ®å›è°ƒ private final SensorEventListener mLightSensorListener = new SensorEventListener() { @Override public void onSensorChanged(SensorEvent event) { if (mLightSensorEnabled) { final long time = SystemClock.uptimeMillis(); final float lux = event.values[0]; handleLightSensorEvent(time, lux); } } ...... }; private void handleLightSensorEvent(long time, float lux) { // å¦‚æœæœ‰ MSG_UPDATE_AMBIENT_LUX æ¶ˆæ¯ï¼Œåˆ™ç§»é™¤ mHandler.removeMessages(MSG_UPDATE_AMBIENT_LUX); ...... // æ›´æ–°ç¼“å†²åŒº applyLightSensorMeasurement(time, lux); // æ›´æ–°æ•°æ® updateAmbientLux(time); } private void applyLightSensorMeasurement(long time, float lux) { ...... // å°†å¤šå°‘å‘¨æœŸ(é»˜è®¤10s)å‰çš„æ•°æ®åˆ æ‰ mAmbientLightRingBuffer.prune(time - mAmbientLightHorizon); // å°†å½“å‰æ•°æ®æ”¾åˆ°ç¼“å†²ä¸­ mAmbientLightRingBuffer.push(time, lux); ..... } handleLightSensorEvent()é¦–å…ˆå–æ¶ˆäº† MSG_UPDATE_AMBIENT_LUX æ¶ˆæ¯ï¼Œ è¯¥æ¶ˆæ¯çš„ä½œç”¨æ˜¯å½“ä¼ æ„Ÿå™¨é•¿æ—¶é—´æ²¡æœ‰æ•°æ®ä¸ŠæŠ¥æ—¶ï¼Œå‘¨æœŸæ€§çš„æ›´æ–°ä¸€æŠŠç¼“å†²åŒºï¼Œ æŠŠè¿‡æœŸçš„æ•°æ®åˆ é™¤(ä½†éœ€è¦ä¿ç•™æœ€åä¸ªå€¼ï¼Œå¹¶æŠŠæ—¶é—´æ›´æ–°ä¸ºå½“å‰æ—¶é—´)(è¿™éƒ¨åˆ†æ˜¯ä¸æ˜¯å¯ä»¥ä¼˜åŒ–ä¸‹) ç„¶åè°ƒç”¨ applyLightSensorMeasurement()å°†è¿‡æœŸçš„æ•°æ®åˆ æ‰ï¼Œå¹¶å°†å½“å‰çš„å€¼åŠ å…¥åˆ°ç¼“å†²ä¸­ã€‚ é»˜è®¤çš„å‘¨æœŸä¸º10s 10000 å³ç¼“å†²åªæœ€å¤šä¿ç•™10ç§’çš„æ•°æ®ï¼Œ æ³¨æ„è¿™é‡Œè¿˜åªæ˜¯æ•°æ®çš„ä¸€ä¸ªç®€å•è®°å½• ä¹‹åå†è°ƒç”¨updateAmbientLux() æ›´æ–°å€¼ï¼Œ æ³¨æ„è¯¥å‡½æ•°å·²ç»è¿›å…¥åˆ°é˜²æŠ–è¿‡ç¨‹äº† 3.1 é˜²æŠ– é˜²æŠ–çš„æµç¨‹éƒ½åœ¨updateAmbientLux()å‡½æ•°é‡Œï¼Œ ç„¶åç”¨HysteresisLevelsç±»è¾…åŠ©è®¡ç®—æ˜æš—å…‰æ„Ÿçš„é˜€å€¼ã€‚ private void updateAmbientLux(long time) { // If the light sensor was just turned on then immediately update our initial // estimate of the current ambient light level. if (!mAmbientLuxValid) { ...... // æ‰“å¼€sensoråç¬¬ä¸€æ¬¡æ›´æ–°æ•°æ®æƒ…å†µï¼Œç•¥è¿‡... } // è®¡ç®—æ˜æš—å˜åŒ–çš„æ—¶é—´ç‚¹ long nextBrightenTransition = nextAmbientLightBrighteningTransition(time); long nextDarkenTransition = nextAmbientLightDarkeningTransition(time); // è®¡ç®—10så’Œ2så†…çš„lux float slowAmbientLux = calculateAmbientLux(time, AMBIENT_LIGHT_LONG_HORIZON_MILLIS); float fastAmbientLux = calculateAmbientLux(time, AMBIENT_LIGHT_SHORT_HORIZON_MILLIS); // å¦‚æœæ»¡è¶³å»æŠ–çš„è¦æ±‚ï¼Œä¼šè¿›è¡Œluxå’Œäº®åº¦çš„è®¡ç®—æ›´æ–° if (slowAmbientLux \u003e= mBrighteningLuxThreshold \u0026\u0026 fastAmbientLux \u003e= mBrighteningLuxThreshold \u0026\u0026 nextBrightenTransition \u003c= time || slowAmbientLux \u003c= mDarkeningLuxThreshold \u0026\u0026 fastAmbientLux \u003c= mDarkeningLuxThreshold \u0026\u0026 nextDarkenTransition \u003c= time) { // æ›´æ–°luxå’Œæ˜æš—luxé˜€å€¼ setAmbientLux(fastAmbientLux); // è¿™ä¸ªlogåº”è¯¥æ”¾åœ¨setAmbientLux()å‰é¢ï¼Œä¸ç„¶ fastAmbientLux \u003e mAmbientLuxæ°¸è¿œä¸ºfalse if (DEBUG) { Slog.d(TAG, \"updateAmbientLux: \" + ((fastAmbientLux \u003e mAmbientLux) ? \"Brightened\" : \"Darkened\") + \": \" + \"mBrighteningLuxThreshold=\" + mBrighteningLuxThreshold + \", mAmbientLightRingBuffer=\" + mAmbientLightRingBuffer + \", mAmbientLux=\" + mAmbientLux); } // æ›´æ–°äº®åº¦ updateAutoBrightness(true); ...... mHandler.sendEmptyMessageAtTime(MSG_UPDATE_AMBIENT_LUX, nextTransitionTime); } æ•´ä¸ªæµç¨‹å¤§ä½“ä¸º è®¡ç®—æ˜æš—å˜åŒ–çš„æ—¶é—´ç‚¹ é˜²æ­¢å‘¨æœŸæ€§çš„å¤§å¹…åº¦æŠ–åŠ¨ è®¡ç®—2så’Œ10så†…çš„lux ç”¨äºå»æŠ–æ¯”è¾ƒï¼Œä½¿å…‰ç…§ç¨³å®šåœ¨0.8~1.1å€ä¹‹é—´ å¦‚æœæ»¡è¶³å»æŠ–çš„è¦æ±‚ï¼Œä¼šè¿›è¡Œluxã€æ˜æš—é˜€å€¼å’Œäº®åº¦çš„è®¡ç®—æ›´æ–° ä¸Šé¢ä»£ç éƒ½æœ‰æ³¨é‡Šï¼Œä¸‹é¢æˆ‘ä»¬çœ‹ä¸€äº›æ–¹æ³•çš„å…·ä½“ä»£ç  è®¡ç®—æ˜æš—å˜åŒ–(ç”±æš—åˆ°äº®åœºæ™¯ï¼Œç”±äº®åˆ°æš—åœºæ™¯)æ—¶é—´ç‚¹ private long nextAmbientLightBrighteningTransition(long time) { final int N = mAmbientLightRingBuffer.size(); long earliestValidTime = time; // ä»åå¾€å‰æ‰¾åˆ°ç¦»å½“å‰æ—¶é—´ç¬¬ä¸€ä¸ªå¤§äºé˜€å€¼çš„ç‚¹ for (int i = N - 1; i \u003e= 0; i--) { if (mAmbien","date":"2025-08-21","objectID":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/:2:3","tags":["clippings","è½¬è½½","blog"],"title":"è‡ªåŠ¨èƒŒå…‰ç®—æ³•-Android 8.1","uri":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/#31-é˜²æŠ–"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"4. æ›´æ–°äº®åº¦ updateAutoBrightness() setAmbientLux()å®Œæˆåå°±è¯¥updateAutoBrightness(true)äº†ï¼Œ å‚æ•°trueè¡¨ç¤ºæœ€ç»ˆä¼šè°ƒç”¨ DisplayPowerController è¿›è¡Œå®é™…çš„äº®åº¦æ›´æ–° private void updateAutoBrightness(boolean sendUpdate) { // å¦‚æœè‡ªåŠ¨å…‰æ„Ÿæ²¡æ•°æ®ï¼Œç›´æ¥è¿”å›äº†ã€‚ if (!mAmbientLuxValid) { return; } // ä»å»ºæ¨¡çš„æ›²çº¿ä¸­ç®—å‡ºå¯¹åº”çš„brightnessï¼Œè¿™åªæ˜¯åˆæ­¥çš„äº®åº¦å€¼ float value = mScreenAutoBrightnessSpline.interpolate(mAmbientLux); float gamma = 1.0f; // å¦‚æœç”¨æˆ·æœ‰è°ƒæ•´ï¼Œå¤„ç†ç”¨æˆ·çš„adjustment if (USE_SCREEN_AUTO_BRIGHTNESS_ADJUSTMENT \u0026\u0026 mScreenAutoBrightnessAdjustment != 0.0f) { // mScreenAutoBrightnessAdjustmentMaxGamma é…ç½®é‡Œç”¨çš„æ˜¯300% // å³æˆ‘ä»¬å‰é¢åˆ—çš„å…¬å¼çš„ 3^(-x) xä¸º-1.0~1.0ä¹‹é—´ final float adjGamma = MathUtils.pow(mScreenAutoBrightnessAdjustmentMaxGamma, Math.min(1.0f, Math.max(-1.0f, -mScreenAutoBrightnessAdjustment))); gamma *= adjGamma; ..... } // gammaä¸ä¸º1.0fè¡¨ç¤ºç”¨æˆ·æœ‰è°ƒæ•´ if (gamma != 1.0f) { final float in = value; // value^gamma value = MathUtils.pow(value, gamma); .... } // value*255å‘ä¸‹å–æ•´å¹¶ä½¿å€¼åœ¨mScreenBrightnessRangeMinimumï½mScreenBrightnessRangeMaximumåŒºé—´ // è¿™æ ·å°±å¾—å‡ºäº†æœ€ç»ˆäº®åº¦ int newScreenAutoBrightness = clampScreenBrightness(Math.round(value * PowerManager.BRIGHTNESS_ON)); if (mScreenAutoBrightness != newScreenAutoBrightness) { ...... if (sendUpdate) { // é€šçŸ¥æ›´æ–° mCallbacks.updateBrightness(); } } } æ›´æ–°äº®åº¦çš„æµç¨‹ä¹ŸæŒºç®€å•çš„ï¼Œå°±æ˜¯ ä»å»ºæ¨¡çš„æ›²çº¿ä¸­ç®—å‡ºå¯¹åº”çš„åˆæ­¥äº®åº¦å€¼ å¦‚æœç”¨æˆ·æœ‰è°ƒæ•´ï¼Œè¿›ä¸€æ­¥å¤„ç†ç”¨æˆ·è°ƒæ•´ å¤„ç†æœ€ç»ˆçš„äº®åº¦å€¼ï¼Œä½¿å…¶åœ¨æå€¼åŒºé—´é‡Œ å¯¹åº”çš„å°±æ˜¯æˆ‘ä»¬å‰é¢åˆ—çš„å…¬å¼ $$ \\mathbf{z = y^{3^{-x}}*255, x\\in[-1.0, 1.0], y\\in[0.0, 1.0], z\\in[min, 255]} $$ å…·ä½“çš„å°±ä¸åˆ†æ­¥è®²äº†ï¼Œå¯çœ‹ä¸‹æˆ‘çš„æ³¨é‡Šï¼Œè¿™é‡Œåªè´´ä¸‹Spline interpolate()ä»£ç  æˆ‘ä»¬ä¹‹å‰å»ºæ¨¡æ—¶è®²äº†ï¼Œåˆ›å»ºsplineå¯èƒ½æ˜¯çº¿æ€§çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯MonotoneCubicSplineï¼Œ æˆ‘ä»¬è¿™åªçœ‹çœ‹MonotoneCubicSplineçš„ï¼Œæ‰€ä»¥å¯¹åº”ä»£ç ä¸º frameworks/base/core/java/android/util/Spline.java public static class MonotoneCubicSpline extends Spline { ...... @Override public float interpolate(float x) { ...... // å°äºæœ€å°luxï¼Œç›´æ¥åå›brightness[0] if (x \u003c= mX[0]) { return mY[0]; } // å¤§äºæœ€å¤§çš„lux, ç›´æ¥è¿”å›æœ€å¤§çš„ if (x \u003e= mX[n - 1]) { return mY[n - 1]; } // Find the index 'i' of the last point with smaller X. // We know this will be within the spline due to the boundary tests. int i = 0; // åˆšå¥½è½åœ¨é‡‡æ ·ç‚¹ä¸Š while (x \u003e= mX[i + 1]) { i += 1; if (x == mX[i]) { return mY[i]; } } // Perform cubic Hermite spline interpolation. float h = mX[i + 1] - mX[i]; float t = (x - mX[i]) / h; // ä¸‰æ¬¡æ’å€¼è®¡ç®— return (mY[i] * (1 + 2 * t) + h * mM[i] * t) * (1 - t) * (1 - t) + (mY[i + 1] * (3 - 2 * t) + h * mM[i + 1] * (t - 1)) * t * t; } æ’å€¼æ—¶ï¼Œå¤§äºæœ€å¤§å°äºæœ€å°æˆ–è€…è½åœ¨ç‚¹ä¸Šçš„æƒ…å†µéƒ½å¥½è¯´ï¼Œç›´æ¥è¿”å›å°±è¡Œäº† æ³¨æ„ mX[0] å¹¶ä¸æ˜¯ config_autoBrightnessLevels ä¸­çš„ç¬¬ä¸€ä¸ªlux, å®é™…ä¸Š createAutoBrightnessSpline() æ—¶ float[] x = new float[n]; å…¶å®mX[0] = 0; è‹¥ç‚¹éƒ½ä¸åœ¨æå€¼å’Œé‡‡æ ·ç‚¹ä¸Šï¼Œé‚£å°±å¾—æ’å€¼è®¡ç®—äº†ï¼Œè¿™ä¸ªå…·ä½“çš„ç®—æ³•åŸç†æˆ‘ä¹Ÿæ²¡äº†è§£ã€‚ å…³äºèƒŒå…‰ç®—æ³•å°±è¯´åˆ°è¿™å„¿å§ï¼Œå¤§ä½“ä¸Šå°±è¿™ä¹ˆå¤šä¸œè¥¿ã€‚ ä¹‹åçš„DisplayPowerControlleræ›´æ–°äº®åº¦ä¹Ÿä¸è¯´äº†ï¼Œéœ€è¦äº†è§£æœ‰ä¸ª mBrightnessRampRateSlow //è‡ªåŠ¨èƒŒå…‰ç”¨çš„è¿™ä¸ª mBrightnessRampRateFast å¯ä»¥æ§åˆ¶èƒŒå…‰å¼€å§‹å˜åŒ–æ—¶çš„å˜åŒ–å¿«æ…¢å°±è¡Œäº† \u003c!-- Fast brightness animation ramp rate in brightness units per second--\u003e \u003cinteger translatable=\"false\" name=\"config_brightness_ramp_rate_fast\"\u003e180\u003c/integer\u003e \u003c!-- Slow brightness animation ramp rate in brightness units per second--\u003e \u003cinteger translatable=\"false\" name=\"config_brightness_ramp_rate_slow\"\u003e60\u003c/integer\u003e ","date":"2025-08-21","objectID":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/:2:4","tags":["clippings","è½¬è½½","blog"],"title":"è‡ªåŠ¨èƒŒå…‰ç®—æ³•-Android 8.1","uri":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/#4-æ›´æ–°äº®åº¦-updateautobrightness"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"5. ç”¨æˆ·å¾®è°ƒ å½“è‡ªåŠ¨èƒŒå…‰å¼€æ—¶ï¼ŒèƒŒå…‰äº®åº¦æ¡å˜æˆäº†ä¸ªè°ƒèŠ‚ç³»æ•°ï¼Œå€¼åœ¨[-1.0f, 1.0f], é»˜è®¤åœ¨0.0f, å½“ç”¨æˆ·æ‹–åŠ¨è¿™ä¸ªæ¡æ—¶ï¼Œæœ€ç»ˆä¼šå†™åˆ° Settings.System.SCREEN_AUTO_BRIGHTNESS_ADJ æ•°æ®åº“é‡Œï¼Œ ç„¶å PowerManagerService ç›‘æµ‹åˆ°æ•°æ®åº“å˜æ›´ï¼Œæœ€ç»ˆç»™äº† mPowerRequest.screenAutoBrightnessAdjustmentï¼Œ DisplayPowerController.java updatePowerState() æ—¶ mAutomaticBrightnessController.configure(.... mPowerRequest.screenAutoBrightnessAdjustment.... æœ€ç»ˆèµ‹å€¼ç»™äº† mScreenAutoBrightnessAdjustmentï¼Œè®¡ç®—äº®åº¦æ—¶å°±ç”¨åˆ°äº†è¯¥å€¼ AutomaticBrightnessController.java public void configure(boolean enable, float adjustment, boolean dozing, .... changed |= setScreenAutoBrightnessAdjustment(adjustment); private boolean setScreenAutoBrightnessAdjustment(float adjustment) { .... mScreenAutoBrightnessAdjustment = adjustment; ","date":"2025-08-21","objectID":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/:2:5","tags":["clippings","è½¬è½½","blog"],"title":"è‡ªåŠ¨èƒŒå…‰ç®—æ³•-Android 8.1","uri":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/#5-ç”¨æˆ·å¾®è°ƒ"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"6. æ€»ç»“: æ¶‰åŠåˆ°çš„ä¸€äº›é…ç½® frameworks/base/core/res/res/values/config.xml // è‡ªåŠ¨èƒŒå…‰åŠŸèƒ½æ˜¯å¦å¯ç”¨å¼€å…³, é»˜è®¤å…³ï¼Œéœ€è¦æ‰“å¼€ config_automatic_brightness_available // lux æ•°ç»„ config_autoBrightnessLevels // å¯¹åº”lcd brightness æ•°ç»„ config_autoBrightnessLcdBacklightValues // å…‰æ„Ÿæ•°æ®ç¼“å†²åŒºå‘¨æœŸï¼Œå³é‡‡é›†å¤šå°‘æ—¶é—´å†…çš„æ•°æ® config_autoBrightnessAmbientLightHorizon // ç”±æš—åˆ°äº®åœºæ™¯é˜²æŠ–æ—¶é—´ï¼Œæ³¨æ„ä¸è¦è¶…è¿‡ config_autoBrightnessAmbientLightHorizon config_autoBrightnessBrighteningLightDebounce // ç”±äº®åˆ°æš—åœºæ™¯é˜²æŠ–æ—¶é—´ï¼Œæ³¨æ„ä¸è¦è¶…è¿‡ config_autoBrightnessAmbientLightHorizon config_autoBrightnessDarkeningLightDebounce // è®¡ç®—å˜äº®å˜æš—åœºæ™¯é˜€å€¼æ—¶çš„Constant config_dynamicHysteresisBrightLevels config_dynamicHysteresisDarkLevels config_dynamicHysteresisLuxLevels // å±å¹•äº®åº¦å˜åŒ–æ—¶çš„ramp rate config_brightness_ramp_rate_slow åˆ›å»º Spline DisplayPowerController.java public DisplayPowerController() + Spline screenAutoBrightnessSpline = createAutoBrightnessSpline(lux, screenBrightness); | + normalize | + createSpline() | + createMonotoneCubicSpline() | + new MonotoneCubicSpline(x, y) | + mX = x; | + mY = y; | + mM = m; + mAutomaticBrightnessController = new AutomaticBrightnessController(...screenAutoBrightnessSpline,...) ä½¿èƒ½è‡ªåŠ¨èƒŒå…‰åŠŸèƒ½å¹¶æ³¨å†Œå…‰æ„Ÿlistener updatePowerState() DisplayPowerController.java + mAutomaticBrightnessController.configure(autoBrightnessEnabled, + configure() AutomaticBrightnessController.java + setLightSensorEnabled() + registerListener(mLightSensorListener å½“æœ‰å…‰æ„Ÿæ•°æ®ä¸Šæ¥æ—¶, å¤„ç†æ•°æ®ï¼Œåˆ æ‰è¿‡æœŸæ•°æ®ï¼Œå¹¶å°†æ•°æ®åŠ å…¥åˆ°ç¼“å†²ä¸­ï¼Œç„¶åå»æŠ–ï¼Œæ›´æ–°lux, æ›´æ–°äº®åº¦ å½“ç„¶ï¼Œå¦‚æœæ²¡æ–°æ•°æ®è¿˜ä¸Šï¼Œè¿˜ä¼šå‘¨æœŸæ€§çš„ MSG_UPDATE_AMBIENT_LUX mLightSensorListener onSensorChanged() + handleLightSensorEvent() | + applyLightSensorMeasurement() | | + mAmbientLightRingBuffer.prune(time - mAmbientLightHorizon); | | + mAmbientLightRingBuffer.push(time, lux); | + updateAmbientLux(time) | | + long nextBrightenTransition = nextAmbientLightBrighteningTransition(time); | | + long nextDarkenTransition = nextAmbientLightDarkeningTransition(time); | | + float slowAmbientLux = calculateAmbientLux(time, AMBIENT_LIGHT_LONG_HORIZON_MILLIS); | | + float fastAmbientLux = calculateAmbientLux(time, AMBIENT_LIGHT_SHORT_HORIZON_MILLIS); | | + if (slowAmbientLux \u003e= mBrighteningLuxThreshold \u0026\u0026... | | | + setAmbientLux(fastAmbientLux); | | | | + mAmbientLux = lux; | | | | + mBrighteningLuxThreshold = mDynamicHysteresis.getBrighteningThreshold(lux); | | | | | + lux * (1.0f + brightConstant); // 1.1lux | | | | + mDarkeningLuxThreshold = mDynamicHysteresis.getDarkeningThreshold(lux); | | | | + lux * (1.0f - brightConstant); // 0.8lux | | | + updateAutoBrightness(true); | | | | + mScreenAutoBrightnessSpline.interpolate(mAmbientLux) // è®¡ç®—å‡ºy | | | | + MathUtils.pow(mScreenAutoBrightnessAdjustmentMaxGamma... -mScreenAutoBrightnessAdjustment) // 3^(-x) | | | | + MathUtils.pow(value, gamma); // y^{3^{-x}} | | | | + clampScreenBrightness(Math.round(value * PowerManager.BRIGHTNESS_ON)); // y^{3^{-x}} * 255 + + + + + mCallbacks.updateBrightness() ","date":"2025-08-21","objectID":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/:2:6","tags":["clippings","è½¬è½½","blog"],"title":"è‡ªåŠ¨èƒŒå…‰ç®—æ³•-Android 8.1","uri":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/#6-æ€»ç»“"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"ä¸‰ã€ä¸€äº›è°ƒè¯•å‘½ä»¤ æ‰“å¼€è‡ªåŠ¨èƒŒå…‰ adb shell settings put system screen_brightness_mode 1 èƒŒå…‰ç³»æ•°è°ƒæ•´ adb shell settings put system screen_auto_brightness_adj 0.0 dump display, å¯æŸ¥çœ‹dumpä¿¡æ¯ï¼ŒåŒ…æ‹¬å»ºæ¨¡çš„ä¸€äº›ç‚¹å€¼ç­‰â€¦ adb shell dumpsys display ","date":"2025-08-21","objectID":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/:3:0","tags":["clippings","è½¬è½½","blog"],"title":"è‡ªåŠ¨èƒŒå…‰ç®—æ³•-Android 8.1","uri":"/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/#ä¸‰ä¸€äº›è°ƒè¯•å‘½ä»¤"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"å•ç¼–æ¨¡å—å‘½ä»¤ï¼šåœ¨SYSTEM/VENDORç›®å½•ä¸‹ source build/envsetup.sh lunch (é€‰ç¼–å·ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è¾“å…¥åç§°+\"-\"+user/userdebugï¼Œè¿™ä¸ªä¸çŸ¥é“å¯ä»¥çœ‹ç¼–è¯‘å¥½çš„out/target/productä¸‹çš„ç›®å½•åï¼Œæˆ–è€…ç›´æ¥çœ‹build_android.shè„šæœ¬é‡Œå®šä¹‰çš„ ) make module_name ä¸€èˆ¬éƒ½æ˜¯åœ¨å¯¹åº”ä»£ç æ¨¡å—ç›®å½•ä¸‹çš„Android.bpå°±æ˜¯ android_app java_library cc_library cc_binary apexç­‰å­—æ®µ Android.bpä¸­å¸¸è§çš„module_name: android_app APK Settings SystemUI framework-res system/app system/priv-app system_ext/app system_ext/priv-app java_libraryJaråŒ…framework-minus-apex servicessystem/frameworkcc_librarysoåº“libaudiomanager libbatterysystem/lib system/lib64cc_binarybinvold bugreportsystem/binapexapexcom.android.wifi com.android.vndk.currentsystem/apex adb root;adb remount;adb push xxx xxx;adb reboot æœ‰äº›æ˜¯ Android.mk æ–‡ä»¶ä¸­å®šä¹‰çš„LOCAL_MODULEå­—æ®µï¼Œæ¯”å¦‚ï¼š selinux make selinux_policy system/etc/selinux vendor/etc/selinux ","date":"2025-07-16","objectID":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"å¼€å‘ä¸­å¸¸ç”¨åˆ°çš„ä¸€äº›è°ƒè¯•å‘½ä»¤","uri":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/#å•ç¼–æ¨¡å—å‘½ä»¤åœ¨systemvendorç›®å½•ä¸‹"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"é¢„ç¼–è¯‘çš„ SELinux æ”¿ç­–ï¼šsepolicy_and_mapping.sha256ä¹Ÿéœ€è¦push https://source.android.google.cn/docs/security/features/selinux/build?hl=zh-cn#precompiled-policy ","date":"2025-07-16","objectID":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"å¼€å‘ä¸­å¸¸ç”¨åˆ°çš„ä¸€äº›è°ƒè¯•å‘½ä»¤","uri":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/#é¢„ç¼–è¯‘çš„-selinux-æ”¿ç­–sepolicy_and_mappingsha256ä¹Ÿéœ€è¦push"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"adb settingså‘½ä»¤ï¼š settings å‘½ä»¤é€šè¿‡ Binder IPC ä¸ Android çš„ Settings Provider ï¼ˆä½äº com.android.providers.settings ï¼‰äº¤äº’ï¼Œæ“ä½œä¸‰ä¸ªæ ¸å¿ƒå‘½åç©ºé—´çš„é…ç½®æ•°æ®åº“ï¼š system å­˜å‚¨è®¾å¤‡ç³»ç»Ÿçº§é…ç½®ï¼ˆå¦‚å±å¹•è¶…æ—¶ã€äº®åº¦ï¼‰ï¼Œè·¯å¾„ä¸º /data/system/users/0/settings_system.xml æƒé™ ï¼šæ™®é€šåº”ç”¨å¯è¯»ï¼Œä¿®æ”¹éœ€ WRITE_SETTINGS æƒé™ã€‚ secure å­˜å‚¨æ•æ„Ÿé…ç½®ï¼ˆå¦‚å¯†ç ã€é»˜è®¤è¾“å…¥æ³•ï¼‰ï¼Œè·¯å¾„ä¸º /data/system/users/0/settings_secure.xml æƒé™ ï¼šä»…ç³»ç»Ÿåº”ç”¨æˆ–ç‰¹æƒè¿›ç¨‹å¯ä¿®æ”¹ã€‚ global å­˜å‚¨å…¨å±€é…ç½®ï¼ˆå¦‚é£è¡Œæ¨¡å¼ã€ADB çŠ¶æ€ï¼‰ï¼Œè·¯å¾„ä¸º /data/system/users/0/settings_global.xml æƒé™ ï¼šéœ€ç³»ç»Ÿç­¾åæˆ– WRITE_SECURE_SETTINGS æƒé™ã€‚ âš ï¸ æ³¨æ„ï¼šä¸åŒ Android ç‰ˆæœ¬å¯èƒ½å¯¹é…ç½®é¡¹æœ‰å®šåˆ¶ï¼Œéƒ¨åˆ†å‘½ä»¤éœ€ Root æƒé™ ã€‚ åŸºç¡€æ“ä½œ å‘½ä»¤ ç”¨é€” ç¤ºä¾‹ list åˆ—å‡ºå‘½åç©ºé—´æ‰€æœ‰é”® adb shell settings list global get è·å–é”®å€¼ adb shell settings get system screen_brightness ï¼ˆè¿”å›äº®åº¦å€¼ï¼‰ put è®¾ç½®é”®å€¼ adb shell settings put system screen_brightness 150 ï¼ˆè®¾ç½®äº®åº¦ï¼‰ delete åˆ é™¤é”®å€¼ adb shell settings delete secure test_ke reset é‡ç½®é…ç½® adb shell settings reset global com.example.app ï¼ˆé‡ç½®é…ç½®ï¼‰ è·³è¿‡å¼€æœºå‘å¯¼ï¼šadb shell settings put global device_provisioned 1;adb shell settings put secure user_setup_complete 1 è®¾ç½®ä¸æ£€æŸ¥äº’è”ç½‘è¿æ¥ adb shell settings put global captive_portal_mode 0/1 ä¿®æ”¹é•¿äº®æ—¶é—´ï¼šadb shell settings put system screen_off_timeout 60000 # 60 ç§’ å¼€å‘è¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°éœ€è¦ä¸´æ—¶æ€§çš„å…³é—­æŸä¸ªåŠŸèƒ½è¿›è¡ŒéªŒè¯æˆ–æµ‹è¯•çš„æƒ…å†µï¼Œä¿®æ”¹ä»£ç æ—¶å¯ä»¥é€šè¿‡æ·»åŠ è¿™ä¸ªå¼€å…³çš„æ–¹å¼åŠ¨æ€çš„æ§åˆ¶ï¼š privatevoidsetCpuPerformance(booleanenable) { booleanneedPerformance = Settings.Global.getInt(mContext.getContentResolver(), \"wifi_cpu_performance_enable\", 1) == 1; if(!needPerformance) { return; } android.os.SystemProperties.set(\"sys.cpu.performance\",enable?\"1\":\"0\"); } setprop getprop ","date":"2025-07-16","objectID":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/:3:0","tags":["clippings","è½¬è½½","blog"],"title":"å¼€å‘ä¸­å¸¸ç”¨åˆ°çš„ä¸€äº›è°ƒè¯•å‘½ä»¤","uri":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/#adb-settingså‘½ä»¤"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"adb settingså‘½ä»¤ï¼š settings å‘½ä»¤é€šè¿‡ Binder IPC ä¸ Android çš„ Settings Provider ï¼ˆä½äº com.android.providers.settings ï¼‰äº¤äº’ï¼Œæ“ä½œä¸‰ä¸ªæ ¸å¿ƒå‘½åç©ºé—´çš„é…ç½®æ•°æ®åº“ï¼š system å­˜å‚¨è®¾å¤‡ç³»ç»Ÿçº§é…ç½®ï¼ˆå¦‚å±å¹•è¶…æ—¶ã€äº®åº¦ï¼‰ï¼Œè·¯å¾„ä¸º /data/system/users/0/settings_system.xml æƒé™ ï¼šæ™®é€šåº”ç”¨å¯è¯»ï¼Œä¿®æ”¹éœ€ WRITE_SETTINGS æƒé™ã€‚ secure å­˜å‚¨æ•æ„Ÿé…ç½®ï¼ˆå¦‚å¯†ç ã€é»˜è®¤è¾“å…¥æ³•ï¼‰ï¼Œè·¯å¾„ä¸º /data/system/users/0/settings_secure.xml æƒé™ ï¼šä»…ç³»ç»Ÿåº”ç”¨æˆ–ç‰¹æƒè¿›ç¨‹å¯ä¿®æ”¹ã€‚ global å­˜å‚¨å…¨å±€é…ç½®ï¼ˆå¦‚é£è¡Œæ¨¡å¼ã€ADB çŠ¶æ€ï¼‰ï¼Œè·¯å¾„ä¸º /data/system/users/0/settings_global.xml æƒé™ ï¼šéœ€ç³»ç»Ÿç­¾åæˆ– WRITE_SECURE_SETTINGS æƒé™ã€‚ âš ï¸ æ³¨æ„ï¼šä¸åŒ Android ç‰ˆæœ¬å¯èƒ½å¯¹é…ç½®é¡¹æœ‰å®šåˆ¶ï¼Œéƒ¨åˆ†å‘½ä»¤éœ€ Root æƒé™ ã€‚ åŸºç¡€æ“ä½œ å‘½ä»¤ ç”¨é€” ç¤ºä¾‹ list åˆ—å‡ºå‘½åç©ºé—´æ‰€æœ‰é”® adb shell settings list global get è·å–é”®å€¼ adb shell settings get system screen_brightness ï¼ˆè¿”å›äº®åº¦å€¼ï¼‰ put è®¾ç½®é”®å€¼ adb shell settings put system screen_brightness 150 ï¼ˆè®¾ç½®äº®åº¦ï¼‰ delete åˆ é™¤é”®å€¼ adb shell settings delete secure test_ke reset é‡ç½®é…ç½® adb shell settings reset global com.example.app ï¼ˆé‡ç½®é…ç½®ï¼‰ è·³è¿‡å¼€æœºå‘å¯¼ï¼šadb shell settings put global device_provisioned 1;adb shell settings put secure user_setup_complete 1 è®¾ç½®ä¸æ£€æŸ¥äº’è”ç½‘è¿æ¥ adb shell settings put global captive_portal_mode 0/1 ä¿®æ”¹é•¿äº®æ—¶é—´ï¼šadb shell settings put system screen_off_timeout 60000 # 60 ç§’ å¼€å‘è¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°éœ€è¦ä¸´æ—¶æ€§çš„å…³é—­æŸä¸ªåŠŸèƒ½è¿›è¡ŒéªŒè¯æˆ–æµ‹è¯•çš„æƒ…å†µï¼Œä¿®æ”¹ä»£ç æ—¶å¯ä»¥é€šè¿‡æ·»åŠ è¿™ä¸ªå¼€å…³çš„æ–¹å¼åŠ¨æ€çš„æ§åˆ¶ï¼š privatevoidsetCpuPerformance(booleanenable) { booleanneedPerformance = Settings.Global.getInt(mContext.getContentResolver(), \"wifi_cpu_performance_enable\", 1) == 1; if(!needPerformance) { return; } android.os.SystemProperties.set(\"sys.cpu.performance\",enable?\"1\":\"0\"); } setprop getprop ","date":"2025-07-16","objectID":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/:3:0","tags":["clippings","è½¬è½½","blog"],"title":"å¼€å‘ä¸­å¸¸ç”¨åˆ°çš„ä¸€äº›è°ƒè¯•å‘½ä»¤","uri":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/#åŸºç¡€æ“ä½œ"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"æˆªå›¾å’Œå½•å±å‘½ä»¤ adb shell screencap /sdcard/screenshot.png adb shell screenrecord /sdcard/screenrecord.mp4 adb pull /sdcard/xxx Window å‘½ä»¤è¡Œæ”¯æŒç›´æ¥ä¿å­˜æˆªå›¾ adb exec-out screencap -p \u003e screenshot.png ","date":"2025-07-16","objectID":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/:4:0","tags":["clippings","è½¬è½½","blog"],"title":"å¼€å‘ä¸­å¸¸ç”¨åˆ°çš„ä¸€äº›è°ƒè¯•å‘½ä»¤","uri":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/#æˆªå›¾å’Œå½•å±å‘½ä»¤"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"bugreportå‘½ä»¤ æŠ“å–ç³»ç»Ÿæ—¥å¿—ï¼Œæ‰“åŒ…æˆbugreport-xxxx-xxxx.zipï¼ŒåŒ…å«çš„æ•°æ®æœ‰ ï¼š ç³»ç»Ÿå±æ€§ ï¼ˆ getprop è¾“å‡ºï¼‰ å†…æ ¸æ—¥å¿— ï¼ˆ dmesg ã€ /proc æ–‡ä»¶ï¼‰ æœåŠ¡çŠ¶æ€ ï¼ˆ dumpsys è¾“å‡ºï¼Œé€šè¿‡ Binder è°ƒç”¨æœåŠ¡çš„ dump() æ–¹æ³•ï¼‰ æ—¥å¿—æ–‡ä»¶ ï¼ˆlogcatã€ANRã€tombstonesï¼‰ ç¡¬ä»¶ä¿¡æ¯ ï¼ˆ lshal è¾“å‡ºï¼‰ ","date":"2025-07-16","objectID":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/:5:0","tags":["clippings","è½¬è½½","blog"],"title":"å¼€å‘ä¸­å¸¸ç”¨åˆ°çš„ä¸€äº›è°ƒè¯•å‘½ä»¤","uri":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/#bugreportå‘½ä»¤"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"dumpsys å‘½ä»¤ dumpsys é€šè¿‡ Binder IPC ä¸ Android çš„æ ¸å¿ƒç»„ä»¶ ServiceManager é€šä¿¡ï¼Œè·å–æ‰€æœ‰å·²æ³¨å†Œç³»ç»ŸæœåŠ¡çš„åˆ—è¡¨ã€‚æ¯ä¸ªæœåŠ¡ï¼ˆå¦‚ activity ã€ window ã€ power ï¼‰å‡å®ç° dump() æ¥å£ï¼Œç”¨äºè¿”å›è‡ªèº«çŠ¶æ€ä¿¡æ¯ åŸºç¡€å‘½ä»¤ å‘½ä»¤ ä½œç”¨ ç¤ºä¾‹è¾“å‡ºå†…å®¹ adb shell dumpsys -l åˆ—å‡ºæ‰€æœ‰æ”¯æŒçš„æœåŠ¡ï¼ˆçº¦ 100+ é¡¹ï¼‰ activity,Â window,Â power,Â battery ç­‰ adb shell dumpsys \u003cæœåŠ¡å\u003e è·å–ç‰¹å®šæœåŠ¡çš„è¯¦ç»†ä¿¡æ¯ å¦‚ dumpsys activity è¾“å‡ºä»»åŠ¡æ ˆã€Broadcast é˜Ÿåˆ—ç­‰ adb shell dumpsys \u003cæœåŠ¡å\u003e -h æŸ¥çœ‹æœåŠ¡çš„å¸®åŠ©æ–‡æ¡£åŠå­å‘½ä»¤ dumpsys activity -h æ˜¾ç¤º a[ctivities] ã€ b[roadcasts] ç­‰å­å‘½ä»¤é€‰ 2. é«˜é¢‘æœåŠ¡è¯¦è§£ æœåŠ¡å å…³é”®ä¿¡æ¯ å®ç”¨åœºæ™¯ activityä»»åŠ¡æ ˆã€Activity ç”Ÿå‘½å‘¨æœŸã€Broadcast é˜Ÿåˆ—åˆ†æ ANRã€æ’æŸ¥é¡µé¢è·³è½¬å¼‚å¸¸settingssettings è®¾ç½®çš„æ•°æ®ï¼Œä¿®æ”¹å†å²ç­‰åˆ†æç”¨æˆ·æ“ä½œè¡Œä¸ºï¼Œæœºå™¨å¼€å…³çŠ¶æ€batteryç”µé‡ç™¾åˆ†æ¯”ã€å……ç”µçŠ¶æ€ã€æ¸©åº¦ç›‘æ§ç”µæ± å¥åº·çŠ¶æ€windowçª—å£ç„¦ç‚¹ã€Surface çŠ¶æ€ã€Display ä¿¡æ¯è°ƒè¯•æ‚¬æµ®çª—ã€åˆ†å±å¼‚å¸¸inputè¾“å…¥è®¾å¤‡ä¿¡æ¯ï¼ŒæŒ‰é”®äº‹ä»¶è®°å½•åˆ†æinputè¾“å…¥äº‹ä»¶packageåº”ç”¨å®‰è£…ä¿¡æ¯ï¼Œæƒé™ç­‰ä¿¡æ¯åˆ†æå·²å®‰è£…åº”ç”¨è¡Œä¸ºwifiwifiä¿¡æ¯åˆ†æwifiè¿è¡Œæƒ…å†µoverlayç³»ç»Ÿçš„overlayä¿¡æ¯åˆ†æç³»ç»Ÿoverlayé…ç½®æƒ…å†µ æ¯”å¦‚ï¼š æ‰“å°systemuiåº”ç”¨çš„ä¿¡æ¯ï¼šadb shell dumpsys activity service com.android.systemui æŸ¥çœ‹å½“å‰é¡µé¢æŠ¥åï¼šadb shell â€˜dumpsys window | grep mFocusâ€™ ","date":"2025-07-16","objectID":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/:6:0","tags":["clippings","è½¬è½½","blog"],"title":"å¼€å‘ä¸­å¸¸ç”¨åˆ°çš„ä¸€äº›è°ƒè¯•å‘½ä»¤","uri":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/#dumpsys-å‘½ä»¤"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"dumpsys å‘½ä»¤ dumpsys é€šè¿‡ Binder IPC ä¸ Android çš„æ ¸å¿ƒç»„ä»¶ ServiceManager é€šä¿¡ï¼Œè·å–æ‰€æœ‰å·²æ³¨å†Œç³»ç»ŸæœåŠ¡çš„åˆ—è¡¨ã€‚æ¯ä¸ªæœåŠ¡ï¼ˆå¦‚ activity ã€ window ã€ power ï¼‰å‡å®ç° dump() æ¥å£ï¼Œç”¨äºè¿”å›è‡ªèº«çŠ¶æ€ä¿¡æ¯ åŸºç¡€å‘½ä»¤ å‘½ä»¤ ä½œç”¨ ç¤ºä¾‹è¾“å‡ºå†…å®¹ adb shell dumpsys -l åˆ—å‡ºæ‰€æœ‰æ”¯æŒçš„æœåŠ¡ï¼ˆçº¦ 100+ é¡¹ï¼‰ activity,Â window,Â power,Â battery ç­‰ adb shell dumpsys \u003cæœåŠ¡å\u003e è·å–ç‰¹å®šæœåŠ¡çš„è¯¦ç»†ä¿¡æ¯ å¦‚ dumpsys activity è¾“å‡ºä»»åŠ¡æ ˆã€Broadcast é˜Ÿåˆ—ç­‰ adb shell dumpsys \u003cæœåŠ¡å\u003e -h æŸ¥çœ‹æœåŠ¡çš„å¸®åŠ©æ–‡æ¡£åŠå­å‘½ä»¤ dumpsys activity -h æ˜¾ç¤º a[ctivities] ã€ b[roadcasts] ç­‰å­å‘½ä»¤é€‰ 2. é«˜é¢‘æœåŠ¡è¯¦è§£ æœåŠ¡å å…³é”®ä¿¡æ¯ å®ç”¨åœºæ™¯ activityä»»åŠ¡æ ˆã€Activity ç”Ÿå‘½å‘¨æœŸã€Broadcast é˜Ÿåˆ—åˆ†æ ANRã€æ’æŸ¥é¡µé¢è·³è½¬å¼‚å¸¸settingssettings è®¾ç½®çš„æ•°æ®ï¼Œä¿®æ”¹å†å²ç­‰åˆ†æç”¨æˆ·æ“ä½œè¡Œä¸ºï¼Œæœºå™¨å¼€å…³çŠ¶æ€batteryç”µé‡ç™¾åˆ†æ¯”ã€å……ç”µçŠ¶æ€ã€æ¸©åº¦ç›‘æ§ç”µæ± å¥åº·çŠ¶æ€windowçª—å£ç„¦ç‚¹ã€Surface çŠ¶æ€ã€Display ä¿¡æ¯è°ƒè¯•æ‚¬æµ®çª—ã€åˆ†å±å¼‚å¸¸inputè¾“å…¥è®¾å¤‡ä¿¡æ¯ï¼ŒæŒ‰é”®äº‹ä»¶è®°å½•åˆ†æinputè¾“å…¥äº‹ä»¶packageåº”ç”¨å®‰è£…ä¿¡æ¯ï¼Œæƒé™ç­‰ä¿¡æ¯åˆ†æå·²å®‰è£…åº”ç”¨è¡Œä¸ºwifiwifiä¿¡æ¯åˆ†æwifiè¿è¡Œæƒ…å†µoverlayç³»ç»Ÿçš„overlayä¿¡æ¯åˆ†æç³»ç»Ÿoverlayé…ç½®æƒ…å†µ æ¯”å¦‚ï¼š æ‰“å°systemuiåº”ç”¨çš„ä¿¡æ¯ï¼šadb shell dumpsys activity service com.android.systemui æŸ¥çœ‹å½“å‰é¡µé¢æŠ¥åï¼šadb shell â€˜dumpsys window | grep mFocusâ€™ ","date":"2025-07-16","objectID":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/:6:0","tags":["clippings","è½¬è½½","blog"],"title":"å¼€å‘ä¸­å¸¸ç”¨åˆ°çš„ä¸€äº›è°ƒè¯•å‘½ä»¤","uri":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/#åŸºç¡€å‘½ä»¤"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"dumpsys å‘½ä»¤ dumpsys é€šè¿‡ Binder IPC ä¸ Android çš„æ ¸å¿ƒç»„ä»¶ ServiceManager é€šä¿¡ï¼Œè·å–æ‰€æœ‰å·²æ³¨å†Œç³»ç»ŸæœåŠ¡çš„åˆ—è¡¨ã€‚æ¯ä¸ªæœåŠ¡ï¼ˆå¦‚ activity ã€ window ã€ power ï¼‰å‡å®ç° dump() æ¥å£ï¼Œç”¨äºè¿”å›è‡ªèº«çŠ¶æ€ä¿¡æ¯ åŸºç¡€å‘½ä»¤ å‘½ä»¤ ä½œç”¨ ç¤ºä¾‹è¾“å‡ºå†…å®¹ adb shell dumpsys -l åˆ—å‡ºæ‰€æœ‰æ”¯æŒçš„æœåŠ¡ï¼ˆçº¦ 100+ é¡¹ï¼‰ activity,Â window,Â power,Â battery ç­‰ adb shell dumpsys \u003cæœåŠ¡å\u003e è·å–ç‰¹å®šæœåŠ¡çš„è¯¦ç»†ä¿¡æ¯ å¦‚ dumpsys activity è¾“å‡ºä»»åŠ¡æ ˆã€Broadcast é˜Ÿåˆ—ç­‰ adb shell dumpsys \u003cæœåŠ¡å\u003e -h æŸ¥çœ‹æœåŠ¡çš„å¸®åŠ©æ–‡æ¡£åŠå­å‘½ä»¤ dumpsys activity -h æ˜¾ç¤º a[ctivities] ã€ b[roadcasts] ç­‰å­å‘½ä»¤é€‰ 2. é«˜é¢‘æœåŠ¡è¯¦è§£ æœåŠ¡å å…³é”®ä¿¡æ¯ å®ç”¨åœºæ™¯ activityä»»åŠ¡æ ˆã€Activity ç”Ÿå‘½å‘¨æœŸã€Broadcast é˜Ÿåˆ—åˆ†æ ANRã€æ’æŸ¥é¡µé¢è·³è½¬å¼‚å¸¸settingssettings è®¾ç½®çš„æ•°æ®ï¼Œä¿®æ”¹å†å²ç­‰åˆ†æç”¨æˆ·æ“ä½œè¡Œä¸ºï¼Œæœºå™¨å¼€å…³çŠ¶æ€batteryç”µé‡ç™¾åˆ†æ¯”ã€å……ç”µçŠ¶æ€ã€æ¸©åº¦ç›‘æ§ç”µæ± å¥åº·çŠ¶æ€windowçª—å£ç„¦ç‚¹ã€Surface çŠ¶æ€ã€Display ä¿¡æ¯è°ƒè¯•æ‚¬æµ®çª—ã€åˆ†å±å¼‚å¸¸inputè¾“å…¥è®¾å¤‡ä¿¡æ¯ï¼ŒæŒ‰é”®äº‹ä»¶è®°å½•åˆ†æinputè¾“å…¥äº‹ä»¶packageåº”ç”¨å®‰è£…ä¿¡æ¯ï¼Œæƒé™ç­‰ä¿¡æ¯åˆ†æå·²å®‰è£…åº”ç”¨è¡Œä¸ºwifiwifiä¿¡æ¯åˆ†æwifiè¿è¡Œæƒ…å†µoverlayç³»ç»Ÿçš„overlayä¿¡æ¯åˆ†æç³»ç»Ÿoverlayé…ç½®æƒ…å†µ æ¯”å¦‚ï¼š æ‰“å°systemuiåº”ç”¨çš„ä¿¡æ¯ï¼šadb shell dumpsys activity service com.android.systemui æŸ¥çœ‹å½“å‰é¡µé¢æŠ¥åï¼šadb shell â€˜dumpsys window | grep mFocusâ€™ ","date":"2025-07-16","objectID":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/:6:0","tags":["clippings","è½¬è½½","blog"],"title":"å¼€å‘ä¸­å¸¸ç”¨åˆ°çš„ä¸€äº›è°ƒè¯•å‘½ä»¤","uri":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/#2-é«˜é¢‘æœåŠ¡è¯¦è§£"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"cmd cmd æ˜¯ Android ç³»ç»Ÿæä¾›çš„ä¸€ä¸ª é«˜çº§ç³»ç»Ÿç®¡ç†å‘½ä»¤ ï¼Œç”¨äºç›´æ¥è°ƒç”¨è®¾å¤‡å†…ç½®çš„ç³»ç»ŸæœåŠ¡ï¼ˆSystem Servicesï¼‰ï¼Œå®ç°å¯¹ç¡¬ä»¶ã€è½¯ä»¶é…ç½®çš„æ·±åº¦æ§åˆ¶ã€‚å…¶æ ¸å¿ƒé€»è¾‘æ˜¯é€šè¿‡ cmd å‘½ä»¤çš„å­å‘½ä»¤ï¼ˆå¦‚ battery ã€ wifi ç­‰ï¼‰è®¿é—® Android çš„ Binder IPC æ¥å£ï¼Œä¸ç³»ç»ŸæœåŠ¡ï¼ˆå¦‚ BatteryService ã€ WifiService ï¼‰äº¤äº’ adb shell cmd \u003cæœåŠ¡å\u003e \u003cå­å‘½ä»¤\u003e [å‚æ•°] ","date":"2025-07-16","objectID":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/:7:0","tags":["clippings","è½¬è½½","blog"],"title":"å¼€å‘ä¸­å¸¸ç”¨åˆ°çš„ä¸€äº›è°ƒè¯•å‘½ä»¤","uri":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/#cmd"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"ğŸ”‹ ","date":"2025-07-16","objectID":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/:7:1","tags":["clippings","è½¬è½½","blog"],"title":"å¼€å‘ä¸­å¸¸ç”¨åˆ°çš„ä¸€äº›è°ƒè¯•å‘½ä»¤","uri":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/#heading"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"ä¸€ã€ç”µæ± ç®¡ç† (battery) ç”¨äºè·å–æˆ–æ¨¡æ‹Ÿç”µæ± çŠ¶æ€ï¼ˆ éœ€ Android 6.0+ ï¼‰ï¼š å‘½ä»¤ åŠŸèƒ½ ç¤ºä¾‹ set level \u003cç™¾åˆ†æ¯”\u003e è®¾ç½®ç”µæ± ç”µé‡ cmd battery set level 20 (ç”µé‡è®¾ä¸º20%) set status \u003cçŠ¶æ€ç \u003e ä¿®æ”¹å……ç”µçŠ¶æ€ï¼ˆ1:æ”¾ç”µ, 2:å……ç”µï¼‰ cmd battery set status 2 (æ¨¡æ‹Ÿå……ç”µ) set usb \u003c0/1\u003e ç¦ç”¨/å¯ç”¨USBå……ç”µ cmd battery set usb 0 (ç¦ç”¨USBå……ç”µ) unplug æ¨¡æ‹Ÿæ–­å¼€å……ç”µï¼ˆä»…é™è½¯ä»¶å±‚é¢ï¼‰ cmd battery unplug reset æ¢å¤å®é™…ç”µæ± çŠ¶æ€ cmd battery reset æ³¨æ„ ï¼šä¿®æ”¹åéœ€é€šè¿‡ adb shell dumpsys battery éªŒè¯çŠ¶æ€ ","date":"2025-07-16","objectID":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/:7:2","tags":["clippings","è½¬è½½","blog"],"title":"å¼€å‘ä¸­å¸¸ç”¨åˆ°çš„ä¸€äº›è°ƒè¯•å‘½ä»¤","uri":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/#ä¸€ç”µæ± ç®¡ç†-battery"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"âš¡ äºŒã€ç”µæºç®¡ç† (power) æ§åˆ¶è®¾å¤‡ä¼‘çœ ã€å”¤é†’ç­‰ç”µæºç­–ç•¥ï¼š å‘½ä»¤ åŠŸèƒ½ ç¤ºä¾‹ set-mode \u003cæ¨¡å¼\u003e è®¾ç½®ç”µæºæ¨¡å¼ï¼ˆ0-3ï¼‰ cmd power set-mode 2 (ä½åŠŸè€—æ¨¡å¼) set-adaptive-power-saver \u003con/off\u003e å¯ç”¨/ç¦ç”¨è‡ªé€‚åº”çœç”µ cmd power set-adaptive-power-saver on go-to-sleep ç«‹å³ä¼‘çœ å±å¹• cmd power go-to-sleep wakeup å”¤é†’è®¾å¤‡ cmd power wakeup ","date":"2025-07-16","objectID":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/:7:3","tags":["clippings","è½¬è½½","blog"],"title":"å¼€å‘ä¸­å¸¸ç”¨åˆ°çš„ä¸€äº›è°ƒè¯•å‘½ä»¤","uri":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/#-äºŒç”µæºç®¡ç†-power"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"ğŸ“± ä¸‰ã€Activityç®¡ç† (activity) å¯åŠ¨/åœæ­¢åº”ç”¨ç»„ä»¶ï¼š å‘½ä»¤ åŠŸèƒ½ ç¤ºä¾‹ start-foreground-service å¯åŠ¨å‰å°æœåŠ¡ cmd activity start-foreground-service com.example/.MyService broadcast å‘é€å¹¿æ’­ cmd activity broadcast -a android.intent.action.BOOT_COMPLETED force-stop å¼ºåˆ¶åœæ­¢åº”ç”¨ cmd activity force-stop com.example.app å¯åŠ¨Activityæ›´å¸¸ç”¨ adb shell am start ï¼ˆé cmd å­å‘½ä»¤ï¼‰ ","date":"2025-07-16","objectID":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/:7:4","tags":["clippings","è½¬è½½","blog"],"title":"å¼€å‘ä¸­å¸¸ç”¨åˆ°çš„ä¸€äº›è°ƒè¯•å‘½ä»¤","uri":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/#-ä¸‰activityç®¡ç†-activity"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"ğŸ“¦ å››ã€åŒ…ç®¡ç† (package) åº”ç”¨å®‰è£…ã€æƒé™æ§åˆ¶ï¼š å‘½ä»¤ åŠŸèƒ½ ç¤ºä¾‹ install \u003capkè·¯å¾„\u003e å®‰è£…åº”ç”¨ cmd package install /sdcard/test.apk uninstall \u003cåŒ…å\u003e å¸è½½åº”ç”¨ cmd package uninstall com.example.app grant/revoke \u003cåŒ…å\u003e \u003cæƒé™\u003e æˆäºˆ/å–æ¶ˆæƒé™ cmd package grant com.example.app android.permission.CAMERA clear \u003cåŒ…å\u003e æ¸…æ¥šåº”ç”¨ç¼“å­˜ cmd package clear com.example.app æŸ¥è¯¢åº”ç”¨åˆ—è¡¨å»ºè®®ç”¨ adb shell pm list packages ","date":"2025-07-16","objectID":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/:7:5","tags":["clippings","è½¬è½½","blog"],"title":"å¼€å‘ä¸­å¸¸ç”¨åˆ°çš„ä¸€äº›è°ƒè¯•å‘½ä»¤","uri":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/#-å››åŒ…ç®¡ç†-package"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"ğŸ“¶ äº”ã€Wi-Fiç®¡ç† (wifi) æ§åˆ¶ç½‘ç»œæ‰«æã€çƒ­ç‚¹ç­‰ï¼š å‘½ä»¤ åŠŸèƒ½ ç¤ºä¾‹ get-country-codeè·å–å½“å‰å›½å®¶ç cmd wifi get-country-codeforce-country-code enabled \u003ctwo-letter code\u003e | disabledè®¾ç½®å›½å®¶ç cmd wifi force-country-code enabled USset-wifi-enabled enabled|disabledå¯ç”¨/ç¦ç”¨WIFIcmd wifi set-wifi-enabled disabledstart-scanè¿›è¡Œä¸€æ¬¡æ‰«æcmd wifi start-scan å¤§éƒ¨åˆ†å­å‘½ä»¤éƒ½å¯ä»¥é€šè¿‡-hè·å–å¸®åŠ© å…¶ä»–ä¸€äº›å¸¸ç”¨çš„å‘½ä»¤amã€pmã€wm æ¢å¤å‡ºå‚è®¾ç½®è®¾ç½®ï¼šadb root;adb shell am broadcast -a android.intent.action.FACTORY_RESET -p android â€“receiver-foreground â€“es android.intent.extra.REASON MainClearConfirm â€“ez android.intent.extra.WIPE_EXTERNAL_STORAGE true â€“ez com.android.internal.intent.extra.WIPE_ESIMS true å¿«é€Ÿè°ƒèµ·å·¥æ¨¡ï¼šadb shell am start -a android.intent.action.FACTORY_TEST å¿«é€Ÿè°ƒèµ·è®¾ç½®ï¼šadb shell am start -a android.settings.SETTINGS æ˜¾ç¤ºå½“å‰Activityå †æ ˆï¼šadb shell am stack list åˆ—å‡ºå·²å®‰è£…åº”ç”¨æŠ¥åï¼šadb shell pm list packages ï¼ˆ-f æ˜¾ç¤ºè·¯å¾„ -såªæ˜¾ç¤ºç³»ç»Ÿåº”ç”¨ -3åªæ˜¾ç¤ºä¸‰æ–¹åº”ç”¨ï¼‰ å‚çœ‹å·²çŸ¥æŠ¥åçš„è·¯å¾„ï¼šadb shell pm -p xxx.xxx.xxx æ‰“å°åº”ç”¨çš„ç›¸å…³ä¿¡æ¯ï¼šadb shell pm dump-package xxx.xxx.xxx ä¿®æ”¹å±å¹•å°ºå¯¸ï¼šadb shell wm size ä¿®æ”¹å±å¹•åˆ†è¾¨ç‡ï¼šadb shell wm density nohup ","date":"2025-07-16","objectID":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/:7:6","tags":["clippings","è½¬è½½","blog"],"title":"å¼€å‘ä¸­å¸¸ç”¨åˆ°çš„ä¸€äº›è°ƒè¯•å‘½ä»¤","uri":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/#-äº”wi-fiç®¡ç†-wifi"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"âš™ï¸ æ ¸å¿ƒç”¨æ³• 1. åŸºç¡€åå°æ‰§è¡Œ å°†å‘½ä»¤é€šè¿‡ nohup åœ¨è®¾å¤‡åå°è¿è¡Œï¼š adb shell \"nohup \u003ccommand\u003e \u0026\" # \u0026 è¡¨ç¤ºåå°æ‰§è¡Œ ç¤ºä¾‹ ï¼šåå°æŒç»­æ”¶é›†æ—¥å¿— adb shell \"nohup logcat -f /sdcard/log.txt \u0026\" æ•ˆæœ ï¼šæ–­å¼€ USB æˆ–å…³é—­ç»ˆç«¯åï¼Œæ—¥å¿—ä»æŒç»­å†™å…¥ /sdcard/log.txt 2. é‡å®šå‘è¾“å‡º é»˜è®¤è¾“å‡ºåˆ° nohup.out ï¼Œå¯é€šè¿‡é‡å®šå‘ä¿å­˜åˆ°è‡ªå®šä¹‰æ–‡ä»¶ï¼š adb shell \"nohup \u003ccommand\u003e \u003e /sdcard/output.log 2\u003e\u00261 \u0026\" 2\u003e\u00261 ï¼šå°†é”™è¯¯è¾“å‡ºåˆå¹¶åˆ°æ ‡å‡†è¾“å‡º ç¤ºä¾‹ ï¼š adb shell \"nohup top -b \u003e /sdcard/top.log 2\u003e\u00261 \u0026\" ","date":"2025-07-16","objectID":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/:7:7","tags":["clippings","è½¬è½½","blog"],"title":"å¼€å‘ä¸­å¸¸ç”¨åˆ°çš„ä¸€äº›è°ƒè¯•å‘½ä»¤","uri":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/#-æ ¸å¿ƒç”¨æ³•"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"âš™ï¸ æ ¸å¿ƒç”¨æ³• 1. åŸºç¡€åå°æ‰§è¡Œ å°†å‘½ä»¤é€šè¿‡ nohup åœ¨è®¾å¤‡åå°è¿è¡Œï¼š adb shell \"nohup \u0026\" # \u0026 è¡¨ç¤ºåå°æ‰§è¡Œ ç¤ºä¾‹ ï¼šåå°æŒç»­æ”¶é›†æ—¥å¿— adb shell \"nohup logcat -f /sdcard/log.txt \u0026\" æ•ˆæœ ï¼šæ–­å¼€ USB æˆ–å…³é—­ç»ˆç«¯åï¼Œæ—¥å¿—ä»æŒç»­å†™å…¥ /sdcard/log.txt 2. é‡å®šå‘è¾“å‡º é»˜è®¤è¾“å‡ºåˆ° nohup.out ï¼Œå¯é€šè¿‡é‡å®šå‘ä¿å­˜åˆ°è‡ªå®šä¹‰æ–‡ä»¶ï¼š adb shell \"nohup \u003e /sdcard/output.log 2\u003e\u00261 \u0026\" 2\u003e\u00261 ï¼šå°†é”™è¯¯è¾“å‡ºåˆå¹¶åˆ°æ ‡å‡†è¾“å‡º ç¤ºä¾‹ ï¼š adb shell \"nohup top -b \u003e /sdcard/top.log 2\u003e\u00261 \u0026\" ","date":"2025-07-16","objectID":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/:7:7","tags":["clippings","è½¬è½½","blog"],"title":"å¼€å‘ä¸­å¸¸ç”¨åˆ°çš„ä¸€äº›è°ƒè¯•å‘½ä»¤","uri":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/#1-åŸºç¡€åå°æ‰§è¡Œ"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"âš™ï¸ æ ¸å¿ƒç”¨æ³• 1. åŸºç¡€åå°æ‰§è¡Œ å°†å‘½ä»¤é€šè¿‡ nohup åœ¨è®¾å¤‡åå°è¿è¡Œï¼š adb shell \"nohup \u0026\" # \u0026 è¡¨ç¤ºåå°æ‰§è¡Œ ç¤ºä¾‹ ï¼šåå°æŒç»­æ”¶é›†æ—¥å¿— adb shell \"nohup logcat -f /sdcard/log.txt \u0026\" æ•ˆæœ ï¼šæ–­å¼€ USB æˆ–å…³é—­ç»ˆç«¯åï¼Œæ—¥å¿—ä»æŒç»­å†™å…¥ /sdcard/log.txt 2. é‡å®šå‘è¾“å‡º é»˜è®¤è¾“å‡ºåˆ° nohup.out ï¼Œå¯é€šè¿‡é‡å®šå‘ä¿å­˜åˆ°è‡ªå®šä¹‰æ–‡ä»¶ï¼š adb shell \"nohup \u003e /sdcard/output.log 2\u003e\u00261 \u0026\" 2\u003e\u00261 ï¼šå°†é”™è¯¯è¾“å‡ºåˆå¹¶åˆ°æ ‡å‡†è¾“å‡º ç¤ºä¾‹ ï¼š adb shell \"nohup top -b \u003e /sdcard/top.log 2\u003e\u00261 \u0026\" ","date":"2025-07-16","objectID":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/:7:7","tags":["clippings","è½¬è½½","blog"],"title":"å¼€å‘ä¸­å¸¸ç”¨åˆ°çš„ä¸€äº›è°ƒè¯•å‘½ä»¤","uri":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/#2-é‡å®šå‘è¾“å‡º"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"âš¡ è¿›é˜¶åœºæ™¯ 1. æ‰§è¡Œå¤æ‚è„šæœ¬ è‹¥éœ€è¿è¡Œå¤šè¡Œè„šæœ¬ï¼ˆå¦‚å¾ªç¯æˆ–æ¡ä»¶åˆ¤æ–­ï¼‰ï¼š adb shell \"nohup sh -c 'while true; do dumpsys battery; sleep 10; done \u003e /sdcard/battery.log 2\u003e\u00261' \u0026\" ä½¿ç”¨ sh -c åŒ…è£¹å¤šè¡Œå‘½ä»¤ apkç­¾åå‘½ä»¤ï¼ˆéœ€è¦ä»£ç ç¼–è¯‘è¿‡ä¸€æ¬¡ï¼‰ï¼šjava -jar out/host/linux-x86/framework/apksigner.jar sign -key build/make/target/product/security/platform.pk8 -cert build/make/target/product/security/platform.x509.pem â€“in unsigned.apk â€“out signed.apk ä½¿ç”¨Android Studio ç›´æ¥ç¼–è¯‘ç­¾å openssl pkcs8 -inform DER -nocrypt -in platform.pk8 -out private.pem;openssl pkcs12 -export -in platform.x509.pem -inkey private.pem -out platform.p12 -password pass:android -name platform android { signingConfigs { create(\"platform\") { storeFile = file(\"C:\\\\Users\\\\zhangtisheng\\\\AndroidStudioProjects\\\\Demo\\\\app\\\\platform.p12\") storePassword = \"android\" keyAlias = \"platform\" keyPassword = \"android\" } } buildTypes { create(\"platform\") { signingConfig = signingConfigs.getByName(\"platform\") } } } æ¯”å¦‚æˆ‘ä»¬éœ€è¦å¯¹æŸä¸ªç•Œé¢å¸ƒå±€åšå‡ºè°ƒæ•´ï¼š 1.ä½¿ç”¨adb shell â€˜dumpsys window | grep mFocusâ€™è·å–æ­¤ç•Œé¢çš„åŒ…åå’ŒActivityå 2.ä½¿ç”¨ adb shell pm -p xxx.xxx.xxxé€šè¿‡åŒ…åè·å–åº”ç”¨çš„æ¨¡å—å 3.æ ¹æ®æ¨¡å—ååˆ°ç›¸åº”çš„ä»£ç ç›®å½•ä¸‹ï¼Œä¸€èˆ¬åŸç”Ÿåº”ç”¨åœ¨packages/appsæˆ–è€…modulesæˆ–è€…servicesä¸‹ï¼Œé«˜é€šçš„å®šåˆ¶åº”ç”¨å¯èƒ½åœ¨vendor/codeauroraæˆ–è€…vendor/qcomä¸‹ 4.æ ¹æ®Activityåï¼Œæ‰¾åˆ°å¯¹åº”çš„ç•Œé¢ä»£ç ï¼Œå†å®šä½åˆ°å¯¹åº”çš„xmlè¿›è¡Œè°ƒæ•´ 5.æ­¤æ—¶è¿˜å¯ä»¥ä½¿ç”¨monitorï¼ˆSdk\\tools\\lib\\monitor-x86_64ï¼‰å·¥å…·ï¼Œè¿›ä¸€æ­¥è·å–ç•Œé¢çš„å¸ƒå±€çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ ¹æ®è¿™äº›idæ¥è¿›ä¸€æ­¥ç¡®è®¤å¯¹åº”çš„æ§ä»¶ ","date":"2025-07-16","objectID":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/:7:8","tags":["clippings","è½¬è½½","blog"],"title":"å¼€å‘ä¸­å¸¸ç”¨åˆ°çš„ä¸€äº›è°ƒè¯•å‘½ä»¤","uri":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/#-è¿›é˜¶åœºæ™¯"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"âš¡ è¿›é˜¶åœºæ™¯ 1. æ‰§è¡Œå¤æ‚è„šæœ¬ è‹¥éœ€è¿è¡Œå¤šè¡Œè„šæœ¬ï¼ˆå¦‚å¾ªç¯æˆ–æ¡ä»¶åˆ¤æ–­ï¼‰ï¼š adb shell \"nohup sh -c 'while true; do dumpsys battery; sleep 10; done \u003e /sdcard/battery.log 2\u003e\u00261' \u0026\" ä½¿ç”¨ sh -c åŒ…è£¹å¤šè¡Œå‘½ä»¤ apkç­¾åå‘½ä»¤ï¼ˆéœ€è¦ä»£ç ç¼–è¯‘è¿‡ä¸€æ¬¡ï¼‰ï¼šjava -jar out/host/linux-x86/framework/apksigner.jar sign -key build/make/target/product/security/platform.pk8 -cert build/make/target/product/security/platform.x509.pem â€“in unsigned.apk â€“out signed.apk ä½¿ç”¨Android Studio ç›´æ¥ç¼–è¯‘ç­¾å openssl pkcs8 -inform DER -nocrypt -in platform.pk8 -out private.pem;openssl pkcs12 -export -in platform.x509.pem -inkey private.pem -out platform.p12 -password pass:android -name platform android { signingConfigs { create(\"platform\") { storeFile = file(\"C:\\\\Users\\\\zhangtisheng\\\\AndroidStudioProjects\\\\Demo\\\\app\\\\platform.p12\") storePassword = \"android\" keyAlias = \"platform\" keyPassword = \"android\" } } buildTypes { create(\"platform\") { signingConfig = signingConfigs.getByName(\"platform\") } } } æ¯”å¦‚æˆ‘ä»¬éœ€è¦å¯¹æŸä¸ªç•Œé¢å¸ƒå±€åšå‡ºè°ƒæ•´ï¼š 1.ä½¿ç”¨adb shell â€˜dumpsys window | grep mFocusâ€™è·å–æ­¤ç•Œé¢çš„åŒ…åå’ŒActivityå 2.ä½¿ç”¨ adb shell pm -p xxx.xxx.xxxé€šè¿‡åŒ…åè·å–åº”ç”¨çš„æ¨¡å—å 3.æ ¹æ®æ¨¡å—ååˆ°ç›¸åº”çš„ä»£ç ç›®å½•ä¸‹ï¼Œä¸€èˆ¬åŸç”Ÿåº”ç”¨åœ¨packages/appsæˆ–è€…modulesæˆ–è€…servicesä¸‹ï¼Œé«˜é€šçš„å®šåˆ¶åº”ç”¨å¯èƒ½åœ¨vendor/codeauroraæˆ–è€…vendor/qcomä¸‹ 4.æ ¹æ®Activityåï¼Œæ‰¾åˆ°å¯¹åº”çš„ç•Œé¢ä»£ç ï¼Œå†å®šä½åˆ°å¯¹åº”çš„xmlè¿›è¡Œè°ƒæ•´ 5.æ­¤æ—¶è¿˜å¯ä»¥ä½¿ç”¨monitorï¼ˆSdk\\tools\\lib\\monitor-x86_64ï¼‰å·¥å…·ï¼Œè¿›ä¸€æ­¥è·å–ç•Œé¢çš„å¸ƒå±€çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ ¹æ®è¿™äº›idæ¥è¿›ä¸€æ­¥ç¡®è®¤å¯¹åº”çš„æ§ä»¶ ","date":"2025-07-16","objectID":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/:7:8","tags":["clippings","è½¬è½½","blog"],"title":"å¼€å‘ä¸­å¸¸ç”¨åˆ°çš„ä¸€äº›è°ƒè¯•å‘½ä»¤","uri":"/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/#1-æ‰§è¡Œå¤æ‚è„šæœ¬"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"èƒŒå…‰æ›²çº¿ ","date":"2025-06-30","objectID":"/posts/%E8%83%8C%E5%85%89%E6%9B%B2%E7%BA%BF%E7%9A%84%E5%88%9B%E5%BB%BA/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"èƒŒå…‰æ›²çº¿çš„åˆ›å»º","uri":"/posts/%E8%83%8C%E5%85%89%E6%9B%B2%E7%BA%BF%E7%9A%84%E5%88%9B%E5%BB%BA/#èƒŒå…‰æ›²çº¿"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"åŸºæœ¬æ¦‚å¿µ ç¯å¢ƒå…‰ï¼ˆAmbient Lightï¼‰ çœŸå®ç¯å¢ƒçš„å…‰ç…§å¼ºåº¦ï¼Œå•ä½ Lux ï¼ˆå¦‚ç™½å¤©å®¤å¤–çº¦ 10,000 Luxï¼Œå¤œé—´å®¤å†…çº¦ 50 Luxï¼‰ã€‚ æ‰‹æœºé€šè¿‡ å…‰æ„Ÿä¼ æ„Ÿå™¨ï¼ˆsensorï¼‰ æ£€æµ‹ç¯å¢ƒå…‰ï¼Œä½† sensor ä¸ŠæŠ¥å€¼ â‰¤ çœŸå®ç¯å¢ƒå…‰å€¼ï¼ˆå—ç¡¬ä»¶ç²¾åº¦é™åˆ¶ï¼‰ã€‚ Lux: å…‰ç…§åº¦å•ä½ï¼Œä»å…‰æºç…§å°„åˆ°å•ä½é¢ç§¯ä¸Šçš„å…‰é€šé‡ åœ¨èƒŒå…‰æµç¨‹ä¸­ï¼ŒLux é€šå¸¸æŒ‡çš„æ˜¯ç¯å¢ƒå…‰ ä¼ æ„Ÿå™¨ æ£€æµ‹åˆ°çš„ç¯å¢ƒå…‰å¼ºåº¦ã€‚ èƒŒå…‰ï¼ˆBacklight, BLï¼‰ å±å¹•èƒŒåçš„å…‰æºå¼ºåº¦ï¼Œç”±ç³»ç»Ÿé€šè¿‡é©±åŠ¨æ§åˆ¶ï¼Œå–å€¼èŒƒå›´é€šå¸¸ä¸º 0-255 ï¼ˆå¦‚ 0 ä¸ºæœ€ä½èƒŒå…‰ï¼Œ255 ä¸ºæœ€é«˜èƒŒå…‰ï¼‰ã€‚ èƒŒå…‰æ˜¯ç¡¬ä»¶å‚æ•°ï¼Œç›´æ¥å½±å“å±å¹•äº®åº¦ï¼Œä½†éœ€é€šè¿‡å±å¹•æè´¨ï¼ˆåå°„ç³»æ•° Rï¼‰æ‰èƒ½ä½“ç°ä¸ºç”¨æˆ·æ„ŸçŸ¥çš„äº®åº¦ã€‚ æ‰‹æœºå±å¹•äº®åº¦ï¼ˆNitï¼‰ ç”¨æˆ·å®é™…æ„ŸçŸ¥çš„å±å¹•äº®åº¦ï¼Œå•ä½ Nit ï¼ˆå¦‚ 100 Nit é€‚åˆå®¤å†…ä½¿ç”¨ï¼Œ500 Nit é€‚åˆæˆ·å¤–å¼ºå…‰ï¼‰ã€‚ ç”±èƒŒå…‰å¼ºåº¦å’Œå±å¹•æè´¨å…±åŒå†³å®šï¼Œå…¬å¼ä¸ºï¼š Nit = RÃ— èƒŒå…‰å¼ºåº¦ï¼ˆBLï¼‰ å…¶ä¸­ï¼Œ R ä¸ºåå°„ç³»æ•° ï¼ˆç”±å±å¹•æè´¨å†³å®šï¼Œå¦‚ OLED å’Œ LCD çš„ R å€¼ä¸åŒï¼‰ éœ€æ±‚ç›®æ ‡ åŠŸèƒ½éœ€æ±‚ å»ºç«‹ä» ç¯å¢ƒå…‰ï¼ˆLuxï¼‰ åˆ° æ‰‹æœºå±å¹•äº®åº¦ï¼ˆNitï¼‰ çš„æ˜ å°„å…³ç³»ï¼ˆå³èƒŒå…‰æ›²çº¿ï¼‰ã€‚ ç”±äºå±å¹•æè´¨å›ºå®šï¼ˆR æ’å®šï¼‰ï¼Œä»£ç å®ç°æ—¶éœ€ç®€åŒ–ä¸ºï¼š sensor ä¸ŠæŠ¥çš„ Luxâ†’ èƒŒå…‰ç­‰çº§ï¼ˆBLï¼‰ ç®€åŒ–é€»è¾‘ å¿½ç•¥ç¯å¢ƒå…‰åˆ° sensor ä¸ŠæŠ¥å€¼çš„è½¬æ¢è¯¯å·®ï¼Œè®¤ä¸º sensor ä¸ŠæŠ¥çš„ Lux = ç¯å¢ƒå…‰ Lux ã€‚ æœ€ç»ˆä»£ç éœ€å®ç°ï¼š sensor ä¸ŠæŠ¥ Lux â†’ ç›®æ ‡å±å¹•äº®åº¦ï¼ˆNitï¼‰ â†’ èƒŒå…‰ç­‰çº§ï¼ˆBLï¼‰ ã€‚ ä¸ä¹‹å¯¹åº”çš„ç³»ç»Ÿç»™å‡ºæ¥çš„é…ç½®æ¥å£ï¼š config_autoBrightnessLevels ----Lux config_autoBrightnessDisplayValuesNits ---- DisplayNitï¼ˆç›®æ ‡å±å¹•äº®åº¦ï¼‰ config_screenBrightnessNits â€”\u003e Nit config_screenBrightnessBacklight â€”\u003e BL è§£é‡Šä¸€ä¸‹è¿™å‡ ä¸ªå‚æ•° config_screenBrightnessNits å’Œ config_screenBrightnessBacklight ååº”çš„åº”è¯¥æ˜¯å±å¹•æè´¨ï¼Œä¹Ÿå°±æ˜¯èƒŒå…‰å’Œå±å¹•äº®åº¦çš„å…³ç³»ï¼ˆL = R*Eï¼‰ä¸­çš„ Rï¼Œåœ¨ç¡¬ä»¶ä¸å˜çš„æƒ…å†µä¸‹è¿™ä¸¤ä¸ªå‚æ•°é…ç½®å¥½åä¸åº”è¯¥å»æ”¹å˜ï¼Œè¿™ä¸¤ä¸ªå‚æ•°å®šä¹‰çš„æ˜¯èƒŒå…‰ç­‰çº§åˆ°å±å¹•äº®åº¦çš„ç¡¬ä»¶ç‰¹æ€§ã€‚ config_autoBrightnessLevels å’Œ config_autoBrightnessDisplayValuesNits ã€‚ä¸€èˆ¬ä¿®æ”¹èƒŒå…‰æ›²çº¿é…ç½®çš„æ˜¯è¿™ä¸¤ä¸ªå€¼ï¼Œè¿™ä¸¤ä¸ªå±æ€§å®šä¹‰çš„æ˜¯ç¯å¢ƒå…‰åˆ°å±å¹•äº®åº¦ï¼ˆèƒŒå…‰ç­‰çº§ï¼‰çš„ç­–ç•¥ã€‚ ","date":"2025-06-30","objectID":"/posts/%E8%83%8C%E5%85%89%E6%9B%B2%E7%BA%BF%E7%9A%84%E5%88%9B%E5%BB%BA/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"èƒŒå…‰æ›²çº¿çš„åˆ›å»º","uri":"/posts/%E8%83%8C%E5%85%89%E6%9B%B2%E7%BA%BF%E7%9A%84%E5%88%9B%E5%BB%BA/#åŸºæœ¬æ¦‚å¿µ"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"èƒŒå…‰æ›²çº¿çš„åˆ›å»º è¿™é‡Œå‡è®¾é…ç½®çš„æ•°æ®éƒ½æ˜¯æœ‰æ•ˆçš„è¿‡ä¸€éåˆ›å»ºæµç¨‹: åˆ›å»º Nit-Backlight å’Œ Backlight-Nit æ›²çº¿ç”¨äºååº”å±å¹•çš„Råå°„ç³»æ•°å±æ€§ è¾“å…¥ ï¼š config_screenBrightnessNits ï¼šå±å¹•äº®åº¦ï¼ˆNitï¼‰çš„é…ç½®å€¼ã€‚ config_screenBrightnessBacklight ï¼šèƒŒå…‰äº®åº¦ï¼ˆBacklightï¼‰çš„é…ç½®å€¼ã€‚ è¿‡ç¨‹ ï¼š æ ¹æ® config_screenBrightnessNits å’Œ config_screenBrightnessBacklight åˆ›å»ºä¸¤æ¡æ˜ å°„æ›²çº¿ï¼š Nit-Backlight æ›²çº¿ ï¼šå°†å±å¹•äº®åº¦ï¼ˆNitï¼‰æ˜ å°„åˆ°èƒŒå…‰äº®åº¦ï¼ˆBacklightï¼‰ã€‚ Backlight-Nit æ›²çº¿ ï¼šå°†èƒŒå…‰äº®åº¦ï¼ˆBacklightï¼‰æ˜ å°„åˆ°å±å¹•äº®åº¦ï¼ˆNitï¼‰ã€‚ è¿™ä¸¤æ¡æ›²çº¿æ˜¯äº’é€†çš„ï¼Œç”¨äºåœ¨ Nit å’Œ Backlight ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚ è¾“å‡ºï¼š Nit-Backlight æ›²çº¿å’Œ Backlight-Nit æ›²çº¿ã€‚ åˆ›å»º Lux-Nit æ›²çº¿ è¾“å…¥ ï¼š config_autoBrightnessDisplayValuesNit ï¼šè‡ªåŠ¨äº®åº¦è°ƒèŠ‚çš„ç›®æ ‡å±å¹•äº®åº¦ï¼ˆNitï¼‰é…ç½®å€¼ã€‚ config_autoBrightnessLevels ï¼šè‡ªåŠ¨äº®åº¦è°ƒèŠ‚çš„ç¯å¢ƒå…‰ç…§åº¦ï¼ˆLuxï¼‰é…ç½®å€¼ã€‚ ç”¨æˆ·è®¾ç½®çš„ï¼ˆLuxï¼ŒBacklightï¼‰å¯¹ï¼šç”¨æˆ·æ‰‹åŠ¨è°ƒæ•´äº®åº¦æ—¶ä¿å­˜çš„ï¼ˆLux ï¼ŒBacklightï¼‰ å¯¹ è¿‡ç¨‹ï¼š å°† config_autoBrightnessDisplayValuesNit æ˜ å°„ä¸º Backlight ï¼š ä½¿ç”¨ Nit-Backlight æ›²çº¿ï¼Œå°† config_autoBrightnessDisplayValuesNit ä¸­çš„ Nit å€¼æ˜ å°„ä¸ºå¯¹åº”çš„ Backlight å€¼ã€‚ å¾—åˆ°ä¸€ä¸ª Backlight æ•°ç»„ï¼Œä¸ config_autoBrightnessLevels ä¸­çš„ Lux æ•°ç»„ä¸€ä¸€å¯¹åº”ã€‚ æ’å…¥ç”¨æˆ·è®¾ç½®çš„ï¼ˆLuxï¼ŒBacklightï¼‰å¯¹ ï¼š å°†ç”¨æˆ·æ‰‹åŠ¨è®¾ç½®çš„ï¼ˆLuxï¼ŒBacklightï¼‰å¯¹æ’å…¥åˆ° config_autoBrightnessLevels å’Œ Backlight æ•°ç»„ä¸­ã€‚ æ’å…¥é€»è¾‘é€šå¸¸æ˜¯æ ¹æ® Lux å€¼çš„å¤§å°è¿›è¡Œæ’åºï¼Œå¹¶ç¡®ä¿ Lux å’Œ Backlight çš„å¯¹åº”å…³ç³»æ­£ç¡® åœ¨å®é™…æ“ä½œä¸­æ’å…¥æ•°æ®æ—¶æ¶‰åŠåˆ°æ‰€æœ‰ Backlight çš„è°ƒæ•´ï¼Œæ¶‰åŠ adjustment è‡ªåŠ¨èƒŒå…‰è°ƒæ•´å€¼.ã€‚å…·ä½“é€»è¾‘åœ¨æºç ä¸­åˆ†æ ç”Ÿæˆ Lux-Nit æ›²çº¿ ï¼š ä½¿ç”¨ Backlight-Nit æ›²çº¿ï¼Œå°† Backlight æ•°ç»„è½¬æ¢ä¸º Nit å€¼ã€‚ æœ€ç»ˆç”Ÿæˆ Lux-Nit æ›²çº¿ï¼Œè¡¨ç¤ºä»ç¯å¢ƒå…‰ç…§åº¦ï¼ˆLuxï¼‰åˆ°ç›®æ ‡å±å¹•äº®åº¦ï¼ˆNitï¼‰çš„æ˜ å°„å…³ç³»ã€‚ è¾“å‡º ï¼š Lux-Nit æ›²çº¿ã€‚ ä½¿ç”¨ Lux-Nit æ›²çº¿è¿›è¡Œè‡ªåŠ¨äº®åº¦è°ƒèŠ‚ å½“ç¯å¢ƒå…‰ä¼ æ„Ÿå™¨æ£€æµ‹åˆ°å½“å‰çš„ Lux å€¼æ—¶ï¼š æ ¹æ® Lux-Nit æ›²çº¿ï¼ŒæŸ¥æ‰¾å¯¹åº”çš„ ç›®æ ‡Nit å€¼ã€‚ ä½¿ç”¨ Nit-Backlight æ›²çº¿ï¼Œå°† Nit å€¼è½¬æ¢ä¸º Backlight å€¼ã€‚ï¼ˆèƒŒå…‰å¼ºåº¦=L/Rï¼‰ å°† Backlight å€¼ä¼ é€’ç»™åº•å±‚ç¡¬ä»¶ï¼Œè°ƒæ•´å±å¹•èƒŒå…‰äº®åº¦ã€‚ ","date":"2025-06-30","objectID":"/posts/%E8%83%8C%E5%85%89%E6%9B%B2%E7%BA%BF%E7%9A%84%E5%88%9B%E5%BB%BA/:1:2","tags":["clippings","è½¬è½½","blog"],"title":"èƒŒå…‰æ›²çº¿çš„åˆ›å»º","uri":"/posts/%E8%83%8C%E5%85%89%E6%9B%B2%E7%BA%BF%E7%9A%84%E5%88%9B%E5%BB%BA/#èƒŒå…‰æ›²çº¿çš„åˆ›å»º"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"èƒŒå…‰æ›²çº¿çš„åˆ›å»º è¿™é‡Œå‡è®¾é…ç½®çš„æ•°æ®éƒ½æ˜¯æœ‰æ•ˆçš„è¿‡ä¸€éåˆ›å»ºæµç¨‹: åˆ›å»º Nit-Backlight å’Œ Backlight-Nit æ›²çº¿ç”¨äºååº”å±å¹•çš„Råå°„ç³»æ•°å±æ€§ è¾“å…¥ ï¼š config_screenBrightnessNits ï¼šå±å¹•äº®åº¦ï¼ˆNitï¼‰çš„é…ç½®å€¼ã€‚ config_screenBrightnessBacklight ï¼šèƒŒå…‰äº®åº¦ï¼ˆBacklightï¼‰çš„é…ç½®å€¼ã€‚ è¿‡ç¨‹ ï¼š æ ¹æ® config_screenBrightnessNits å’Œ config_screenBrightnessBacklight åˆ›å»ºä¸¤æ¡æ˜ å°„æ›²çº¿ï¼š Nit-Backlight æ›²çº¿ ï¼šå°†å±å¹•äº®åº¦ï¼ˆNitï¼‰æ˜ å°„åˆ°èƒŒå…‰äº®åº¦ï¼ˆBacklightï¼‰ã€‚ Backlight-Nit æ›²çº¿ ï¼šå°†èƒŒå…‰äº®åº¦ï¼ˆBacklightï¼‰æ˜ å°„åˆ°å±å¹•äº®åº¦ï¼ˆNitï¼‰ã€‚ è¿™ä¸¤æ¡æ›²çº¿æ˜¯äº’é€†çš„ï¼Œç”¨äºåœ¨ Nit å’Œ Backlight ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚ è¾“å‡ºï¼š Nit-Backlight æ›²çº¿å’Œ Backlight-Nit æ›²çº¿ã€‚ åˆ›å»º Lux-Nit æ›²çº¿ è¾“å…¥ ï¼š config_autoBrightnessDisplayValuesNit ï¼šè‡ªåŠ¨äº®åº¦è°ƒèŠ‚çš„ç›®æ ‡å±å¹•äº®åº¦ï¼ˆNitï¼‰é…ç½®å€¼ã€‚ config_autoBrightnessLevels ï¼šè‡ªåŠ¨äº®åº¦è°ƒèŠ‚çš„ç¯å¢ƒå…‰ç…§åº¦ï¼ˆLuxï¼‰é…ç½®å€¼ã€‚ ç”¨æˆ·è®¾ç½®çš„ï¼ˆLuxï¼ŒBacklightï¼‰å¯¹ï¼šç”¨æˆ·æ‰‹åŠ¨è°ƒæ•´äº®åº¦æ—¶ä¿å­˜çš„ï¼ˆLux ï¼ŒBacklightï¼‰ å¯¹ è¿‡ç¨‹ï¼š å°† config_autoBrightnessDisplayValuesNit æ˜ å°„ä¸º Backlight ï¼š ä½¿ç”¨ Nit-Backlight æ›²çº¿ï¼Œå°† config_autoBrightnessDisplayValuesNit ä¸­çš„ Nit å€¼æ˜ å°„ä¸ºå¯¹åº”çš„ Backlight å€¼ã€‚ å¾—åˆ°ä¸€ä¸ª Backlight æ•°ç»„ï¼Œä¸ config_autoBrightnessLevels ä¸­çš„ Lux æ•°ç»„ä¸€ä¸€å¯¹åº”ã€‚ æ’å…¥ç”¨æˆ·è®¾ç½®çš„ï¼ˆLuxï¼ŒBacklightï¼‰å¯¹ ï¼š å°†ç”¨æˆ·æ‰‹åŠ¨è®¾ç½®çš„ï¼ˆLuxï¼ŒBacklightï¼‰å¯¹æ’å…¥åˆ° config_autoBrightnessLevels å’Œ Backlight æ•°ç»„ä¸­ã€‚ æ’å…¥é€»è¾‘é€šå¸¸æ˜¯æ ¹æ® Lux å€¼çš„å¤§å°è¿›è¡Œæ’åºï¼Œå¹¶ç¡®ä¿ Lux å’Œ Backlight çš„å¯¹åº”å…³ç³»æ­£ç¡® åœ¨å®é™…æ“ä½œä¸­æ’å…¥æ•°æ®æ—¶æ¶‰åŠåˆ°æ‰€æœ‰ Backlight çš„è°ƒæ•´ï¼Œæ¶‰åŠ adjustment è‡ªåŠ¨èƒŒå…‰è°ƒæ•´å€¼.ã€‚å…·ä½“é€»è¾‘åœ¨æºç ä¸­åˆ†æ ç”Ÿæˆ Lux-Nit æ›²çº¿ ï¼š ä½¿ç”¨ Backlight-Nit æ›²çº¿ï¼Œå°† Backlight æ•°ç»„è½¬æ¢ä¸º Nit å€¼ã€‚ æœ€ç»ˆç”Ÿæˆ Lux-Nit æ›²çº¿ï¼Œè¡¨ç¤ºä»ç¯å¢ƒå…‰ç…§åº¦ï¼ˆLuxï¼‰åˆ°ç›®æ ‡å±å¹•äº®åº¦ï¼ˆNitï¼‰çš„æ˜ å°„å…³ç³»ã€‚ è¾“å‡º ï¼š Lux-Nit æ›²çº¿ã€‚ ä½¿ç”¨ Lux-Nit æ›²çº¿è¿›è¡Œè‡ªåŠ¨äº®åº¦è°ƒèŠ‚ å½“ç¯å¢ƒå…‰ä¼ æ„Ÿå™¨æ£€æµ‹åˆ°å½“å‰çš„ Lux å€¼æ—¶ï¼š æ ¹æ® Lux-Nit æ›²çº¿ï¼ŒæŸ¥æ‰¾å¯¹åº”çš„ ç›®æ ‡Nit å€¼ã€‚ ä½¿ç”¨ Nit-Backlight æ›²çº¿ï¼Œå°† Nit å€¼è½¬æ¢ä¸º Backlight å€¼ã€‚ï¼ˆèƒŒå…‰å¼ºåº¦=L/Rï¼‰ å°† Backlight å€¼ä¼ é€’ç»™åº•å±‚ç¡¬ä»¶ï¼Œè°ƒæ•´å±å¹•èƒŒå…‰äº®åº¦ã€‚ ","date":"2025-06-30","objectID":"/posts/%E8%83%8C%E5%85%89%E6%9B%B2%E7%BA%BF%E7%9A%84%E5%88%9B%E5%BB%BA/:1:2","tags":["clippings","è½¬è½½","blog"],"title":"èƒŒå…‰æ›²çº¿çš„åˆ›å»º","uri":"/posts/%E8%83%8C%E5%85%89%E6%9B%B2%E7%BA%BF%E7%9A%84%E5%88%9B%E5%BB%BA/#åˆ›å»º-nit-backlight-å’Œ-backlight-nit-æ›²çº¿ç”¨äºååº”å±å¹•çš„råå°„ç³»æ•°å±æ€§"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"èƒŒå…‰æ›²çº¿çš„åˆ›å»º è¿™é‡Œå‡è®¾é…ç½®çš„æ•°æ®éƒ½æ˜¯æœ‰æ•ˆçš„è¿‡ä¸€éåˆ›å»ºæµç¨‹: åˆ›å»º Nit-Backlight å’Œ Backlight-Nit æ›²çº¿ç”¨äºååº”å±å¹•çš„Råå°„ç³»æ•°å±æ€§ è¾“å…¥ ï¼š config_screenBrightnessNits ï¼šå±å¹•äº®åº¦ï¼ˆNitï¼‰çš„é…ç½®å€¼ã€‚ config_screenBrightnessBacklight ï¼šèƒŒå…‰äº®åº¦ï¼ˆBacklightï¼‰çš„é…ç½®å€¼ã€‚ è¿‡ç¨‹ ï¼š æ ¹æ® config_screenBrightnessNits å’Œ config_screenBrightnessBacklight åˆ›å»ºä¸¤æ¡æ˜ å°„æ›²çº¿ï¼š Nit-Backlight æ›²çº¿ ï¼šå°†å±å¹•äº®åº¦ï¼ˆNitï¼‰æ˜ å°„åˆ°èƒŒå…‰äº®åº¦ï¼ˆBacklightï¼‰ã€‚ Backlight-Nit æ›²çº¿ ï¼šå°†èƒŒå…‰äº®åº¦ï¼ˆBacklightï¼‰æ˜ å°„åˆ°å±å¹•äº®åº¦ï¼ˆNitï¼‰ã€‚ è¿™ä¸¤æ¡æ›²çº¿æ˜¯äº’é€†çš„ï¼Œç”¨äºåœ¨ Nit å’Œ Backlight ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚ è¾“å‡ºï¼š Nit-Backlight æ›²çº¿å’Œ Backlight-Nit æ›²çº¿ã€‚ åˆ›å»º Lux-Nit æ›²çº¿ è¾“å…¥ ï¼š config_autoBrightnessDisplayValuesNit ï¼šè‡ªåŠ¨äº®åº¦è°ƒèŠ‚çš„ç›®æ ‡å±å¹•äº®åº¦ï¼ˆNitï¼‰é…ç½®å€¼ã€‚ config_autoBrightnessLevels ï¼šè‡ªåŠ¨äº®åº¦è°ƒèŠ‚çš„ç¯å¢ƒå…‰ç…§åº¦ï¼ˆLuxï¼‰é…ç½®å€¼ã€‚ ç”¨æˆ·è®¾ç½®çš„ï¼ˆLuxï¼ŒBacklightï¼‰å¯¹ï¼šç”¨æˆ·æ‰‹åŠ¨è°ƒæ•´äº®åº¦æ—¶ä¿å­˜çš„ï¼ˆLux ï¼ŒBacklightï¼‰ å¯¹ è¿‡ç¨‹ï¼š å°† config_autoBrightnessDisplayValuesNit æ˜ å°„ä¸º Backlight ï¼š ä½¿ç”¨ Nit-Backlight æ›²çº¿ï¼Œå°† config_autoBrightnessDisplayValuesNit ä¸­çš„ Nit å€¼æ˜ å°„ä¸ºå¯¹åº”çš„ Backlight å€¼ã€‚ å¾—åˆ°ä¸€ä¸ª Backlight æ•°ç»„ï¼Œä¸ config_autoBrightnessLevels ä¸­çš„ Lux æ•°ç»„ä¸€ä¸€å¯¹åº”ã€‚ æ’å…¥ç”¨æˆ·è®¾ç½®çš„ï¼ˆLuxï¼ŒBacklightï¼‰å¯¹ ï¼š å°†ç”¨æˆ·æ‰‹åŠ¨è®¾ç½®çš„ï¼ˆLuxï¼ŒBacklightï¼‰å¯¹æ’å…¥åˆ° config_autoBrightnessLevels å’Œ Backlight æ•°ç»„ä¸­ã€‚ æ’å…¥é€»è¾‘é€šå¸¸æ˜¯æ ¹æ® Lux å€¼çš„å¤§å°è¿›è¡Œæ’åºï¼Œå¹¶ç¡®ä¿ Lux å’Œ Backlight çš„å¯¹åº”å…³ç³»æ­£ç¡® åœ¨å®é™…æ“ä½œä¸­æ’å…¥æ•°æ®æ—¶æ¶‰åŠåˆ°æ‰€æœ‰ Backlight çš„è°ƒæ•´ï¼Œæ¶‰åŠ adjustment è‡ªåŠ¨èƒŒå…‰è°ƒæ•´å€¼.ã€‚å…·ä½“é€»è¾‘åœ¨æºç ä¸­åˆ†æ ç”Ÿæˆ Lux-Nit æ›²çº¿ ï¼š ä½¿ç”¨ Backlight-Nit æ›²çº¿ï¼Œå°† Backlight æ•°ç»„è½¬æ¢ä¸º Nit å€¼ã€‚ æœ€ç»ˆç”Ÿæˆ Lux-Nit æ›²çº¿ï¼Œè¡¨ç¤ºä»ç¯å¢ƒå…‰ç…§åº¦ï¼ˆLuxï¼‰åˆ°ç›®æ ‡å±å¹•äº®åº¦ï¼ˆNitï¼‰çš„æ˜ å°„å…³ç³»ã€‚ è¾“å‡º ï¼š Lux-Nit æ›²çº¿ã€‚ ä½¿ç”¨ Lux-Nit æ›²çº¿è¿›è¡Œè‡ªåŠ¨äº®åº¦è°ƒèŠ‚ å½“ç¯å¢ƒå…‰ä¼ æ„Ÿå™¨æ£€æµ‹åˆ°å½“å‰çš„ Lux å€¼æ—¶ï¼š æ ¹æ® Lux-Nit æ›²çº¿ï¼ŒæŸ¥æ‰¾å¯¹åº”çš„ ç›®æ ‡Nit å€¼ã€‚ ä½¿ç”¨ Nit-Backlight æ›²çº¿ï¼Œå°† Nit å€¼è½¬æ¢ä¸º Backlight å€¼ã€‚ï¼ˆèƒŒå…‰å¼ºåº¦=L/Rï¼‰ å°† Backlight å€¼ä¼ é€’ç»™åº•å±‚ç¡¬ä»¶ï¼Œè°ƒæ•´å±å¹•èƒŒå…‰äº®åº¦ã€‚ ","date":"2025-06-30","objectID":"/posts/%E8%83%8C%E5%85%89%E6%9B%B2%E7%BA%BF%E7%9A%84%E5%88%9B%E5%BB%BA/:1:2","tags":["clippings","è½¬è½½","blog"],"title":"èƒŒå…‰æ›²çº¿çš„åˆ›å»º","uri":"/posts/%E8%83%8C%E5%85%89%E6%9B%B2%E7%BA%BF%E7%9A%84%E5%88%9B%E5%BB%BA/#åˆ›å»º-lux-nit-æ›²çº¿"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"èƒŒå…‰æ›²çº¿çš„åˆ›å»º è¿™é‡Œå‡è®¾é…ç½®çš„æ•°æ®éƒ½æ˜¯æœ‰æ•ˆçš„è¿‡ä¸€éåˆ›å»ºæµç¨‹: åˆ›å»º Nit-Backlight å’Œ Backlight-Nit æ›²çº¿ç”¨äºååº”å±å¹•çš„Råå°„ç³»æ•°å±æ€§ è¾“å…¥ ï¼š config_screenBrightnessNits ï¼šå±å¹•äº®åº¦ï¼ˆNitï¼‰çš„é…ç½®å€¼ã€‚ config_screenBrightnessBacklight ï¼šèƒŒå…‰äº®åº¦ï¼ˆBacklightï¼‰çš„é…ç½®å€¼ã€‚ è¿‡ç¨‹ ï¼š æ ¹æ® config_screenBrightnessNits å’Œ config_screenBrightnessBacklight åˆ›å»ºä¸¤æ¡æ˜ å°„æ›²çº¿ï¼š Nit-Backlight æ›²çº¿ ï¼šå°†å±å¹•äº®åº¦ï¼ˆNitï¼‰æ˜ å°„åˆ°èƒŒå…‰äº®åº¦ï¼ˆBacklightï¼‰ã€‚ Backlight-Nit æ›²çº¿ ï¼šå°†èƒŒå…‰äº®åº¦ï¼ˆBacklightï¼‰æ˜ å°„åˆ°å±å¹•äº®åº¦ï¼ˆNitï¼‰ã€‚ è¿™ä¸¤æ¡æ›²çº¿æ˜¯äº’é€†çš„ï¼Œç”¨äºåœ¨ Nit å’Œ Backlight ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚ è¾“å‡ºï¼š Nit-Backlight æ›²çº¿å’Œ Backlight-Nit æ›²çº¿ã€‚ åˆ›å»º Lux-Nit æ›²çº¿ è¾“å…¥ ï¼š config_autoBrightnessDisplayValuesNit ï¼šè‡ªåŠ¨äº®åº¦è°ƒèŠ‚çš„ç›®æ ‡å±å¹•äº®åº¦ï¼ˆNitï¼‰é…ç½®å€¼ã€‚ config_autoBrightnessLevels ï¼šè‡ªåŠ¨äº®åº¦è°ƒèŠ‚çš„ç¯å¢ƒå…‰ç…§åº¦ï¼ˆLuxï¼‰é…ç½®å€¼ã€‚ ç”¨æˆ·è®¾ç½®çš„ï¼ˆLuxï¼ŒBacklightï¼‰å¯¹ï¼šç”¨æˆ·æ‰‹åŠ¨è°ƒæ•´äº®åº¦æ—¶ä¿å­˜çš„ï¼ˆLux ï¼ŒBacklightï¼‰ å¯¹ è¿‡ç¨‹ï¼š å°† config_autoBrightnessDisplayValuesNit æ˜ å°„ä¸º Backlight ï¼š ä½¿ç”¨ Nit-Backlight æ›²çº¿ï¼Œå°† config_autoBrightnessDisplayValuesNit ä¸­çš„ Nit å€¼æ˜ å°„ä¸ºå¯¹åº”çš„ Backlight å€¼ã€‚ å¾—åˆ°ä¸€ä¸ª Backlight æ•°ç»„ï¼Œä¸ config_autoBrightnessLevels ä¸­çš„ Lux æ•°ç»„ä¸€ä¸€å¯¹åº”ã€‚ æ’å…¥ç”¨æˆ·è®¾ç½®çš„ï¼ˆLuxï¼ŒBacklightï¼‰å¯¹ ï¼š å°†ç”¨æˆ·æ‰‹åŠ¨è®¾ç½®çš„ï¼ˆLuxï¼ŒBacklightï¼‰å¯¹æ’å…¥åˆ° config_autoBrightnessLevels å’Œ Backlight æ•°ç»„ä¸­ã€‚ æ’å…¥é€»è¾‘é€šå¸¸æ˜¯æ ¹æ® Lux å€¼çš„å¤§å°è¿›è¡Œæ’åºï¼Œå¹¶ç¡®ä¿ Lux å’Œ Backlight çš„å¯¹åº”å…³ç³»æ­£ç¡® åœ¨å®é™…æ“ä½œä¸­æ’å…¥æ•°æ®æ—¶æ¶‰åŠåˆ°æ‰€æœ‰ Backlight çš„è°ƒæ•´ï¼Œæ¶‰åŠ adjustment è‡ªåŠ¨èƒŒå…‰è°ƒæ•´å€¼.ã€‚å…·ä½“é€»è¾‘åœ¨æºç ä¸­åˆ†æ ç”Ÿæˆ Lux-Nit æ›²çº¿ ï¼š ä½¿ç”¨ Backlight-Nit æ›²çº¿ï¼Œå°† Backlight æ•°ç»„è½¬æ¢ä¸º Nit å€¼ã€‚ æœ€ç»ˆç”Ÿæˆ Lux-Nit æ›²çº¿ï¼Œè¡¨ç¤ºä»ç¯å¢ƒå…‰ç…§åº¦ï¼ˆLuxï¼‰åˆ°ç›®æ ‡å±å¹•äº®åº¦ï¼ˆNitï¼‰çš„æ˜ å°„å…³ç³»ã€‚ è¾“å‡º ï¼š Lux-Nit æ›²çº¿ã€‚ ä½¿ç”¨ Lux-Nit æ›²çº¿è¿›è¡Œè‡ªåŠ¨äº®åº¦è°ƒèŠ‚ å½“ç¯å¢ƒå…‰ä¼ æ„Ÿå™¨æ£€æµ‹åˆ°å½“å‰çš„ Lux å€¼æ—¶ï¼š æ ¹æ® Lux-Nit æ›²çº¿ï¼ŒæŸ¥æ‰¾å¯¹åº”çš„ ç›®æ ‡Nit å€¼ã€‚ ä½¿ç”¨ Nit-Backlight æ›²çº¿ï¼Œå°† Nit å€¼è½¬æ¢ä¸º Backlight å€¼ã€‚ï¼ˆèƒŒå…‰å¼ºåº¦=L/Rï¼‰ å°† Backlight å€¼ä¼ é€’ç»™åº•å±‚ç¡¬ä»¶ï¼Œè°ƒæ•´å±å¹•èƒŒå…‰äº®åº¦ã€‚ ","date":"2025-06-30","objectID":"/posts/%E8%83%8C%E5%85%89%E6%9B%B2%E7%BA%BF%E7%9A%84%E5%88%9B%E5%BB%BA/:1:2","tags":["clippings","è½¬è½½","blog"],"title":"èƒŒå…‰æ›²çº¿çš„åˆ›å»º","uri":"/posts/%E8%83%8C%E5%85%89%E6%9B%B2%E7%BA%BF%E7%9A%84%E5%88%9B%E5%BB%BA/#ä½¿ç”¨-lux-nit-æ›²çº¿è¿›è¡Œè‡ªåŠ¨äº®åº¦è°ƒèŠ‚"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"æ’å…¥ç”¨æˆ·è®¾ç½®çš„ï¼ˆLuxï¼ŒBacklightï¼‰å¯¹æ—¶ adjustment è‡ªåŠ¨èƒŒå…‰è°ƒæ•´å€¼çš„è®¾ç½®åŠä½¿ç”¨ åœ¨ä¸Šè¿°æµç¨‹ä¸­æ’å…¥ç”¨æˆ·è®¾ç½®çš„ï¼ˆLuxï¼ŒBacklightï¼‰å¯¹æ—¶å¹¶ä¸åªæ˜¯åœ¨æ›²çº¿ä¸­æ”¹å˜ç‚¹å³å¯ï¼Œè€Œæ˜¯è¦è°ƒæ•´æ•´ä¸ªlux â€”backlightå¯¹åº”å…³ç³»ã€‚ä¹Ÿå°±æ˜¯è¦è°ƒæ•´æ•´ä¸ªbacklightæ•°ç»„ã€‚è¿™é‡Œçš„è°ƒæ•´é€»è¾‘å°±æ˜¯é€šè¿‡adjustment å®ç° adjustment: è‡ªåŠ¨èƒŒå…‰è°ƒæ•´å€¼ï¼ŒèŒƒå›´ï¼ˆ-1,1ï¼‰ å…·ä½“è°ƒæ•´é€»è¾‘ï¼š è®¡ç®—gamma gamma = log [current] desired current: å½“å‰å€¼ï¼ˆé€šè¿‡å½“å‰å·²ç»å­˜åœ¨çš„æ›²çº¿ç”±luxå¾—åˆ°çš„BLï¼‰ ï¼Œdesired: æœŸæœ›å€¼ï¼ˆç”¨æˆ·è®¾ç½®ï¼‰ èŒƒå›´ 0 åˆ° 1 0 æœ€æš—ï¼Œ1 æœ€äº® è®¡ç®—adjustment adjustment =-log [maxGamma] gamma maxGamma æ˜¯ä¸€ä¸ªç”¨äºæè¿°å±å¹•äº®åº¦æ›²çº¿çš„å‚æ•°ï¼Œå®ƒå½±å“å±å¹•äº®åº¦çš„éçº¿æ€§æ˜ å°„.ç®€è€Œè¨€ä¹‹æ˜¯ä¸€ä¸ªé…ç½®å±æ€§ ä¸­é—´å½“ current å’Œ desired æ˜¯ä¸€äº›ç‰¹æ®Šå€¼æ—¶ adjustment ç›´æ¥è®¾ç½®ï¼Œè¿™ä¹Ÿæ˜¯adjustmentå­˜åœ¨çš„æ„ä¹‰. current \u003c=0.1f || current\u003e = 0.9f æ—¶ adjustment = desired-current; desired = 0 æ—¶ adjustment =-1 desired = 1 æ—¶ adjustment = 1 é‡æ–°è®¡ç®—gamma gamma = maxGamma^(-adjustment) è®¡ç®—æ–°çš„èƒŒå…‰æ•°ç»„ newBacklight = oldBacklight^gamma y = a^x (0\u003c a \u003c 1) x è¶Šå¤§ y è¶Šå° æœ€ç»ˆæ˜ å°„å…³ç³», adjustment åªæ˜¯ä¸€ä¸ªä¸­é—´å€¼,æœ€ç»ˆç”¨äºè¯¥è¡¨Backlightçš„æ˜¯ gammaã€‚ desired = 0 æ—¶ adjustment =-1 ï¼Œæ­¤æ—¶ gamma = maxGamma æœ€å¤§ï¼ŒnewBacklight = oldBacklight^maxGamma æœ€å°ï¼Œç¬¦åˆæœŸæœ› desired = 1 æ—¶ adjustment = 1 ï¼Œæ­¤æ—¶ gamma = maxGamma^-1 æœ€å°ï¼ŒnewBacklight = oldBacklight^maxGamma æœ€å¤§ï¼Œç¬¦åˆæœŸæœ› ","date":"2025-06-30","objectID":"/posts/%E8%83%8C%E5%85%89%E6%9B%B2%E7%BA%BF%E7%9A%84%E5%88%9B%E5%BB%BA/:1:3","tags":["clippings","è½¬è½½","blog"],"title":"èƒŒå…‰æ›²çº¿çš„åˆ›å»º","uri":"/posts/%E8%83%8C%E5%85%89%E6%9B%B2%E7%BA%BF%E7%9A%84%E5%88%9B%E5%BB%BA/#æ’å…¥ç”¨æˆ·è®¾ç½®çš„luxbacklightå¯¹æ—¶-adjustment-è‡ªåŠ¨èƒŒå…‰è°ƒæ•´å€¼çš„è®¾ç½®åŠä½¿ç”¨"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"æ’å…¥ç”¨æˆ·è®¾ç½®çš„ï¼ˆLuxï¼ŒBacklightï¼‰å¯¹æ—¶ adjustment è‡ªåŠ¨èƒŒå…‰è°ƒæ•´å€¼çš„è®¾ç½®åŠä½¿ç”¨ åœ¨ä¸Šè¿°æµç¨‹ä¸­æ’å…¥ç”¨æˆ·è®¾ç½®çš„ï¼ˆLuxï¼ŒBacklightï¼‰å¯¹æ—¶å¹¶ä¸åªæ˜¯åœ¨æ›²çº¿ä¸­æ”¹å˜ç‚¹å³å¯ï¼Œè€Œæ˜¯è¦è°ƒæ•´æ•´ä¸ªlux â€”backlightå¯¹åº”å…³ç³»ã€‚ä¹Ÿå°±æ˜¯è¦è°ƒæ•´æ•´ä¸ªbacklightæ•°ç»„ã€‚è¿™é‡Œçš„è°ƒæ•´é€»è¾‘å°±æ˜¯é€šè¿‡adjustment å®ç° adjustment: è‡ªåŠ¨èƒŒå…‰è°ƒæ•´å€¼ï¼ŒèŒƒå›´ï¼ˆ-1,1ï¼‰ å…·ä½“è°ƒæ•´é€»è¾‘ï¼š è®¡ç®—gamma gamma = log [current] desired current: å½“å‰å€¼ï¼ˆé€šè¿‡å½“å‰å·²ç»å­˜åœ¨çš„æ›²çº¿ç”±luxå¾—åˆ°çš„BLï¼‰ ï¼Œdesired: æœŸæœ›å€¼ï¼ˆç”¨æˆ·è®¾ç½®ï¼‰ èŒƒå›´ 0 åˆ° 1 0 æœ€æš—ï¼Œ1 æœ€äº® è®¡ç®—adjustment adjustment =-log [maxGamma] gamma maxGamma æ˜¯ä¸€ä¸ªç”¨äºæè¿°å±å¹•äº®åº¦æ›²çº¿çš„å‚æ•°ï¼Œå®ƒå½±å“å±å¹•äº®åº¦çš„éçº¿æ€§æ˜ å°„.ç®€è€Œè¨€ä¹‹æ˜¯ä¸€ä¸ªé…ç½®å±æ€§ ä¸­é—´å½“ current å’Œ desired æ˜¯ä¸€äº›ç‰¹æ®Šå€¼æ—¶ adjustment ç›´æ¥è®¾ç½®ï¼Œè¿™ä¹Ÿæ˜¯adjustmentå­˜åœ¨çš„æ„ä¹‰. current \u003c=0.1f || current\u003e = 0.9f æ—¶ adjustment = desired-current; desired = 0 æ—¶ adjustment =-1 desired = 1 æ—¶ adjustment = 1 é‡æ–°è®¡ç®—gamma gamma = maxGamma^(-adjustment) è®¡ç®—æ–°çš„èƒŒå…‰æ•°ç»„ newBacklight = oldBacklight^gamma y = a^x (0\u003c a \u003c 1) x è¶Šå¤§ y è¶Šå° æœ€ç»ˆæ˜ å°„å…³ç³», adjustment åªæ˜¯ä¸€ä¸ªä¸­é—´å€¼,æœ€ç»ˆç”¨äºè¯¥è¡¨Backlightçš„æ˜¯ gammaã€‚ desired = 0 æ—¶ adjustment =-1 ï¼Œæ­¤æ—¶ gamma = maxGamma æœ€å¤§ï¼ŒnewBacklight = oldBacklight^maxGamma æœ€å°ï¼Œç¬¦åˆæœŸæœ› desired = 1 æ—¶ adjustment = 1 ï¼Œæ­¤æ—¶ gamma = maxGamma^-1 æœ€å°ï¼ŒnewBacklight = oldBacklight^maxGamma æœ€å¤§ï¼Œç¬¦åˆæœŸæœ› ","date":"2025-06-30","objectID":"/posts/%E8%83%8C%E5%85%89%E6%9B%B2%E7%BA%BF%E7%9A%84%E5%88%9B%E5%BB%BA/:1:3","tags":["clippings","è½¬è½½","blog"],"title":"èƒŒå…‰æ›²çº¿çš„åˆ›å»º","uri":"/posts/%E8%83%8C%E5%85%89%E6%9B%B2%E7%BA%BF%E7%9A%84%E5%88%9B%E5%BB%BA/#å…·ä½“è°ƒæ•´é€»è¾‘"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"æ’å…¥ç”¨æˆ·è®¾ç½®çš„ï¼ˆLuxï¼ŒBacklightï¼‰å¯¹æ—¶ adjustment è‡ªåŠ¨èƒŒå…‰è°ƒæ•´å€¼çš„è®¾ç½®åŠä½¿ç”¨ åœ¨ä¸Šè¿°æµç¨‹ä¸­æ’å…¥ç”¨æˆ·è®¾ç½®çš„ï¼ˆLuxï¼ŒBacklightï¼‰å¯¹æ—¶å¹¶ä¸åªæ˜¯åœ¨æ›²çº¿ä¸­æ”¹å˜ç‚¹å³å¯ï¼Œè€Œæ˜¯è¦è°ƒæ•´æ•´ä¸ªlux â€”backlightå¯¹åº”å…³ç³»ã€‚ä¹Ÿå°±æ˜¯è¦è°ƒæ•´æ•´ä¸ªbacklightæ•°ç»„ã€‚è¿™é‡Œçš„è°ƒæ•´é€»è¾‘å°±æ˜¯é€šè¿‡adjustment å®ç° adjustment: è‡ªåŠ¨èƒŒå…‰è°ƒæ•´å€¼ï¼ŒèŒƒå›´ï¼ˆ-1,1ï¼‰ å…·ä½“è°ƒæ•´é€»è¾‘ï¼š è®¡ç®—gamma gamma = log [current] desired current: å½“å‰å€¼ï¼ˆé€šè¿‡å½“å‰å·²ç»å­˜åœ¨çš„æ›²çº¿ç”±luxå¾—åˆ°çš„BLï¼‰ ï¼Œdesired: æœŸæœ›å€¼ï¼ˆç”¨æˆ·è®¾ç½®ï¼‰ èŒƒå›´ 0 åˆ° 1 0 æœ€æš—ï¼Œ1 æœ€äº® è®¡ç®—adjustment adjustment =-log [maxGamma] gamma maxGamma æ˜¯ä¸€ä¸ªç”¨äºæè¿°å±å¹•äº®åº¦æ›²çº¿çš„å‚æ•°ï¼Œå®ƒå½±å“å±å¹•äº®åº¦çš„éçº¿æ€§æ˜ å°„.ç®€è€Œè¨€ä¹‹æ˜¯ä¸€ä¸ªé…ç½®å±æ€§ ä¸­é—´å½“ current å’Œ desired æ˜¯ä¸€äº›ç‰¹æ®Šå€¼æ—¶ adjustment ç›´æ¥è®¾ç½®ï¼Œè¿™ä¹Ÿæ˜¯adjustmentå­˜åœ¨çš„æ„ä¹‰. current \u003c=0.1f || current\u003e = 0.9f æ—¶ adjustment = desired-current; desired = 0 æ—¶ adjustment =-1 desired = 1 æ—¶ adjustment = 1 é‡æ–°è®¡ç®—gamma gamma = maxGamma^(-adjustment) è®¡ç®—æ–°çš„èƒŒå…‰æ•°ç»„ newBacklight = oldBacklight^gamma y = a^x (0\u003c a \u003c 1) x è¶Šå¤§ y è¶Šå° æœ€ç»ˆæ˜ å°„å…³ç³», adjustment åªæ˜¯ä¸€ä¸ªä¸­é—´å€¼,æœ€ç»ˆç”¨äºè¯¥è¡¨Backlightçš„æ˜¯ gammaã€‚ desired = 0 æ—¶ adjustment =-1 ï¼Œæ­¤æ—¶ gamma = maxGamma æœ€å¤§ï¼ŒnewBacklight = oldBacklight^maxGamma æœ€å°ï¼Œç¬¦åˆæœŸæœ› desired = 1 æ—¶ adjustment = 1 ï¼Œæ­¤æ—¶ gamma = maxGamma^-1 æœ€å°ï¼ŒnewBacklight = oldBacklight^maxGamma æœ€å¤§ï¼Œç¬¦åˆæœŸæœ› ","date":"2025-06-30","objectID":"/posts/%E8%83%8C%E5%85%89%E6%9B%B2%E7%BA%BF%E7%9A%84%E5%88%9B%E5%BB%BA/:1:3","tags":["clippings","è½¬è½½","blog"],"title":"èƒŒå…‰æ›²çº¿çš„åˆ›å»º","uri":"/posts/%E8%83%8C%E5%85%89%E6%9B%B2%E7%BA%BF%E7%9A%84%E5%88%9B%E5%BB%BA/#è®¡ç®—gamma"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"æ’å…¥ç”¨æˆ·è®¾ç½®çš„ï¼ˆLuxï¼ŒBacklightï¼‰å¯¹æ—¶ adjustment è‡ªåŠ¨èƒŒå…‰è°ƒæ•´å€¼çš„è®¾ç½®åŠä½¿ç”¨ åœ¨ä¸Šè¿°æµç¨‹ä¸­æ’å…¥ç”¨æˆ·è®¾ç½®çš„ï¼ˆLuxï¼ŒBacklightï¼‰å¯¹æ—¶å¹¶ä¸åªæ˜¯åœ¨æ›²çº¿ä¸­æ”¹å˜ç‚¹å³å¯ï¼Œè€Œæ˜¯è¦è°ƒæ•´æ•´ä¸ªlux â€”backlightå¯¹åº”å…³ç³»ã€‚ä¹Ÿå°±æ˜¯è¦è°ƒæ•´æ•´ä¸ªbacklightæ•°ç»„ã€‚è¿™é‡Œçš„è°ƒæ•´é€»è¾‘å°±æ˜¯é€šè¿‡adjustment å®ç° adjustment: è‡ªåŠ¨èƒŒå…‰è°ƒæ•´å€¼ï¼ŒèŒƒå›´ï¼ˆ-1,1ï¼‰ å…·ä½“è°ƒæ•´é€»è¾‘ï¼š è®¡ç®—gamma gamma = log [current] desired current: å½“å‰å€¼ï¼ˆé€šè¿‡å½“å‰å·²ç»å­˜åœ¨çš„æ›²çº¿ç”±luxå¾—åˆ°çš„BLï¼‰ ï¼Œdesired: æœŸæœ›å€¼ï¼ˆç”¨æˆ·è®¾ç½®ï¼‰ èŒƒå›´ 0 åˆ° 1 0 æœ€æš—ï¼Œ1 æœ€äº® è®¡ç®—adjustment adjustment =-log [maxGamma] gamma maxGamma æ˜¯ä¸€ä¸ªç”¨äºæè¿°å±å¹•äº®åº¦æ›²çº¿çš„å‚æ•°ï¼Œå®ƒå½±å“å±å¹•äº®åº¦çš„éçº¿æ€§æ˜ å°„.ç®€è€Œè¨€ä¹‹æ˜¯ä¸€ä¸ªé…ç½®å±æ€§ ä¸­é—´å½“ current å’Œ desired æ˜¯ä¸€äº›ç‰¹æ®Šå€¼æ—¶ adjustment ç›´æ¥è®¾ç½®ï¼Œè¿™ä¹Ÿæ˜¯adjustmentå­˜åœ¨çš„æ„ä¹‰. current \u003c=0.1f || current\u003e = 0.9f æ—¶ adjustment = desired-current; desired = 0 æ—¶ adjustment =-1 desired = 1 æ—¶ adjustment = 1 é‡æ–°è®¡ç®—gamma gamma = maxGamma^(-adjustment) è®¡ç®—æ–°çš„èƒŒå…‰æ•°ç»„ newBacklight = oldBacklight^gamma y = a^x (0\u003c a \u003c 1) x è¶Šå¤§ y è¶Šå° æœ€ç»ˆæ˜ å°„å…³ç³», adjustment åªæ˜¯ä¸€ä¸ªä¸­é—´å€¼,æœ€ç»ˆç”¨äºè¯¥è¡¨Backlightçš„æ˜¯ gammaã€‚ desired = 0 æ—¶ adjustment =-1 ï¼Œæ­¤æ—¶ gamma = maxGamma æœ€å¤§ï¼ŒnewBacklight = oldBacklight^maxGamma æœ€å°ï¼Œç¬¦åˆæœŸæœ› desired = 1 æ—¶ adjustment = 1 ï¼Œæ­¤æ—¶ gamma = maxGamma^-1 æœ€å°ï¼ŒnewBacklight = oldBacklight^maxGamma æœ€å¤§ï¼Œç¬¦åˆæœŸæœ› ","date":"2025-06-30","objectID":"/posts/%E8%83%8C%E5%85%89%E6%9B%B2%E7%BA%BF%E7%9A%84%E5%88%9B%E5%BB%BA/:1:3","tags":["clippings","è½¬è½½","blog"],"title":"èƒŒå…‰æ›²çº¿çš„åˆ›å»º","uri":"/posts/%E8%83%8C%E5%85%89%E6%9B%B2%E7%BA%BF%E7%9A%84%E5%88%9B%E5%BB%BA/#è®¡ç®—adjustment"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"æ’å…¥ç”¨æˆ·è®¾ç½®çš„ï¼ˆLuxï¼ŒBacklightï¼‰å¯¹æ—¶ adjustment è‡ªåŠ¨èƒŒå…‰è°ƒæ•´å€¼çš„è®¾ç½®åŠä½¿ç”¨ åœ¨ä¸Šè¿°æµç¨‹ä¸­æ’å…¥ç”¨æˆ·è®¾ç½®çš„ï¼ˆLuxï¼ŒBacklightï¼‰å¯¹æ—¶å¹¶ä¸åªæ˜¯åœ¨æ›²çº¿ä¸­æ”¹å˜ç‚¹å³å¯ï¼Œè€Œæ˜¯è¦è°ƒæ•´æ•´ä¸ªlux â€”backlightå¯¹åº”å…³ç³»ã€‚ä¹Ÿå°±æ˜¯è¦è°ƒæ•´æ•´ä¸ªbacklightæ•°ç»„ã€‚è¿™é‡Œçš„è°ƒæ•´é€»è¾‘å°±æ˜¯é€šè¿‡adjustment å®ç° adjustment: è‡ªåŠ¨èƒŒå…‰è°ƒæ•´å€¼ï¼ŒèŒƒå›´ï¼ˆ-1,1ï¼‰ å…·ä½“è°ƒæ•´é€»è¾‘ï¼š è®¡ç®—gamma gamma = log [current] desired current: å½“å‰å€¼ï¼ˆé€šè¿‡å½“å‰å·²ç»å­˜åœ¨çš„æ›²çº¿ç”±luxå¾—åˆ°çš„BLï¼‰ ï¼Œdesired: æœŸæœ›å€¼ï¼ˆç”¨æˆ·è®¾ç½®ï¼‰ èŒƒå›´ 0 åˆ° 1 0 æœ€æš—ï¼Œ1 æœ€äº® è®¡ç®—adjustment adjustment =-log [maxGamma] gamma maxGamma æ˜¯ä¸€ä¸ªç”¨äºæè¿°å±å¹•äº®åº¦æ›²çº¿çš„å‚æ•°ï¼Œå®ƒå½±å“å±å¹•äº®åº¦çš„éçº¿æ€§æ˜ å°„.ç®€è€Œè¨€ä¹‹æ˜¯ä¸€ä¸ªé…ç½®å±æ€§ ä¸­é—´å½“ current å’Œ desired æ˜¯ä¸€äº›ç‰¹æ®Šå€¼æ—¶ adjustment ç›´æ¥è®¾ç½®ï¼Œè¿™ä¹Ÿæ˜¯adjustmentå­˜åœ¨çš„æ„ä¹‰. current \u003c=0.1f || current\u003e = 0.9f æ—¶ adjustment = desired-current; desired = 0 æ—¶ adjustment =-1 desired = 1 æ—¶ adjustment = 1 é‡æ–°è®¡ç®—gamma gamma = maxGamma^(-adjustment) è®¡ç®—æ–°çš„èƒŒå…‰æ•°ç»„ newBacklight = oldBacklight^gamma y = a^x (0\u003c a \u003c 1) x è¶Šå¤§ y è¶Šå° æœ€ç»ˆæ˜ å°„å…³ç³», adjustment åªæ˜¯ä¸€ä¸ªä¸­é—´å€¼,æœ€ç»ˆç”¨äºè¯¥è¡¨Backlightçš„æ˜¯ gammaã€‚ desired = 0 æ—¶ adjustment =-1 ï¼Œæ­¤æ—¶ gamma = maxGamma æœ€å¤§ï¼ŒnewBacklight = oldBacklight^maxGamma æœ€å°ï¼Œç¬¦åˆæœŸæœ› desired = 1 æ—¶ adjustment = 1 ï¼Œæ­¤æ—¶ gamma = maxGamma^-1 æœ€å°ï¼ŒnewBacklight = oldBacklight^maxGamma æœ€å¤§ï¼Œç¬¦åˆæœŸæœ› ","date":"2025-06-30","objectID":"/posts/%E8%83%8C%E5%85%89%E6%9B%B2%E7%BA%BF%E7%9A%84%E5%88%9B%E5%BB%BA/:1:3","tags":["clippings","è½¬è½½","blog"],"title":"èƒŒå…‰æ›²çº¿çš„åˆ›å»º","uri":"/posts/%E8%83%8C%E5%85%89%E6%9B%B2%E7%BA%BF%E7%9A%84%E5%88%9B%E5%BB%BA/#é‡æ–°è®¡ç®—gamma"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"æ’å…¥ç”¨æˆ·è®¾ç½®çš„ï¼ˆLuxï¼ŒBacklightï¼‰å¯¹æ—¶ adjustment è‡ªåŠ¨èƒŒå…‰è°ƒæ•´å€¼çš„è®¾ç½®åŠä½¿ç”¨ åœ¨ä¸Šè¿°æµç¨‹ä¸­æ’å…¥ç”¨æˆ·è®¾ç½®çš„ï¼ˆLuxï¼ŒBacklightï¼‰å¯¹æ—¶å¹¶ä¸åªæ˜¯åœ¨æ›²çº¿ä¸­æ”¹å˜ç‚¹å³å¯ï¼Œè€Œæ˜¯è¦è°ƒæ•´æ•´ä¸ªlux â€”backlightå¯¹åº”å…³ç³»ã€‚ä¹Ÿå°±æ˜¯è¦è°ƒæ•´æ•´ä¸ªbacklightæ•°ç»„ã€‚è¿™é‡Œçš„è°ƒæ•´é€»è¾‘å°±æ˜¯é€šè¿‡adjustment å®ç° adjustment: è‡ªåŠ¨èƒŒå…‰è°ƒæ•´å€¼ï¼ŒèŒƒå›´ï¼ˆ-1,1ï¼‰ å…·ä½“è°ƒæ•´é€»è¾‘ï¼š è®¡ç®—gamma gamma = log [current] desired current: å½“å‰å€¼ï¼ˆé€šè¿‡å½“å‰å·²ç»å­˜åœ¨çš„æ›²çº¿ç”±luxå¾—åˆ°çš„BLï¼‰ ï¼Œdesired: æœŸæœ›å€¼ï¼ˆç”¨æˆ·è®¾ç½®ï¼‰ èŒƒå›´ 0 åˆ° 1 0 æœ€æš—ï¼Œ1 æœ€äº® è®¡ç®—adjustment adjustment =-log [maxGamma] gamma maxGamma æ˜¯ä¸€ä¸ªç”¨äºæè¿°å±å¹•äº®åº¦æ›²çº¿çš„å‚æ•°ï¼Œå®ƒå½±å“å±å¹•äº®åº¦çš„éçº¿æ€§æ˜ å°„.ç®€è€Œè¨€ä¹‹æ˜¯ä¸€ä¸ªé…ç½®å±æ€§ ä¸­é—´å½“ current å’Œ desired æ˜¯ä¸€äº›ç‰¹æ®Šå€¼æ—¶ adjustment ç›´æ¥è®¾ç½®ï¼Œè¿™ä¹Ÿæ˜¯adjustmentå­˜åœ¨çš„æ„ä¹‰. current \u003c=0.1f || current\u003e = 0.9f æ—¶ adjustment = desired-current; desired = 0 æ—¶ adjustment =-1 desired = 1 æ—¶ adjustment = 1 é‡æ–°è®¡ç®—gamma gamma = maxGamma^(-adjustment) è®¡ç®—æ–°çš„èƒŒå…‰æ•°ç»„ newBacklight = oldBacklight^gamma y = a^x (0\u003c a \u003c 1) x è¶Šå¤§ y è¶Šå° æœ€ç»ˆæ˜ å°„å…³ç³», adjustment åªæ˜¯ä¸€ä¸ªä¸­é—´å€¼,æœ€ç»ˆç”¨äºè¯¥è¡¨Backlightçš„æ˜¯ gammaã€‚ desired = 0 æ—¶ adjustment =-1 ï¼Œæ­¤æ—¶ gamma = maxGamma æœ€å¤§ï¼ŒnewBacklight = oldBacklight^maxGamma æœ€å°ï¼Œç¬¦åˆæœŸæœ› desired = 1 æ—¶ adjustment = 1 ï¼Œæ­¤æ—¶ gamma = maxGamma^-1 æœ€å°ï¼ŒnewBacklight = oldBacklight^maxGamma æœ€å¤§ï¼Œç¬¦åˆæœŸæœ› ","date":"2025-06-30","objectID":"/posts/%E8%83%8C%E5%85%89%E6%9B%B2%E7%BA%BF%E7%9A%84%E5%88%9B%E5%BB%BA/:1:3","tags":["clippings","è½¬è½½","blog"],"title":"èƒŒå…‰æ›²çº¿çš„åˆ›å»º","uri":"/posts/%E8%83%8C%E5%85%89%E6%9B%B2%E7%BA%BF%E7%9A%84%E5%88%9B%E5%BB%BA/#è®¡ç®—æ–°çš„èƒŒå…‰æ•°ç»„"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"å±•é”å…‰æ„Ÿè‡ªåŠ¨è°ƒèŠ‚äº®åº¦åŠŸèƒ½ï¼Œå…‰æ„Ÿæ•°æ®ä¸ŠæŠ¥å¯¹åº”çš„èƒŒå…‰äº®åº¦è®¾ç½®ï¼Œå…¶å®å…¶ä»–å¹³å°åƒ MTK ï¼Œé«˜é€šä¹Ÿå·®ä¸å¤šï¼Œå¤§åŒå°å¼‚ï¼Œä¸»è¦æ˜¯æœç´¢å…³é”®å­—ï¼šconfig_autoBrightnessLevelsã€config_screenBrightnessBacklightï¼Œå°±ä¼šå‘ç°åªæ˜¯æ–‡ä»¶è·¯å¾„ä¸å¤ªä¸€æ ·ã€‚ é€šè¿‡ä¿®æ”¹sensorhubä¸‹å…‰æ„ŸåŸå§‹æ•°æ®ä¸ŠæŠ¥ï¼Œæˆ–è€…æ ¹æ®å®é™…æƒ…å†µå»è°ƒèŠ‚brightness leveléƒ½èƒ½å®ç°è‡ªåŠ¨è°ƒèŠ‚äº®åº¦åŠŸèƒ½çš„ çµæ•åº¦ ï¼Œçœ‹ä¸ªäººå–œæ¬¢ã€‚ å±•é”çš„ä»£ç è·¯å¾„å¦‚ä¸‹ï¼š device\\sprd\\roc1\\common\\overlay\\frameworks\\base\\core\\res\\res\\values\\config.xml \u003c!-- Array of light sensor LUX values to define our levels for auto backlight brightness support. The N entries of this array define N 1 zones as follows: Zone 0: 0 \u003c= LUX \u003c array[0] Zone 1: array[0] \u003c= LUX \u003c array[1] ... Zone N: array[N - 1] \u003c= LUX \u003c array[N] Zone N + 1 array[N] \u003c= LUX \u003c infinity Must be overridden in platform specific overlays --\u003e \u003cinteger-array name=\"config_autoBrightnessLevels\"\u003e \u003citem\u003e16\u003c/item\u003e \u003citem\u003e32\u003c/item\u003e \u003citem\u003e50\u003c/item\u003e \u003citem\u003e100\u003c/item\u003e \u003citem\u003e140\u003c/item\u003e \u003citem\u003e180\u003c/item\u003e \u003citem\u003e240\u003c/item\u003e \u003citem\u003e300\u003c/item\u003e \u003citem\u003e600\u003c/item\u003e \u003citem\u003e800\u003c/item\u003e \u003citem\u003e1000\u003c/item\u003e \u003citem\u003e2000\u003c/item\u003e \u003citem\u003e3000\u003c/item\u003e \u003citem\u003e4000\u003c/item\u003e \u003citem\u003e5000\u003c/item\u003e \u003citem\u003e6000\u003c/item\u003e \u003citem\u003e8000\u003c/item\u003e \u003citem\u003e10000\u003c/item\u003e \u003citem\u003e20000\u003c/item\u003e \u003citem\u003e30000\u003c/item\u003e \u003c/integer-array\u003e \u003c!-- Array of desired screen brightness in nits corresponding to the lux values in the config_autoBrightnessLevels array. As with config_screenBrightnessMinimumNits and config_screenBrightnessMaximumNits, the display brightness is defined as the measured brightness of an all-white image. If this is defined then: - config_autoBrightnessLcdBacklightValues should not be defined - config_screenBrightnessNits must be defined - config_screenBrightnessBacklight must be defined This array should have size one greater than the size of the config_autoBrightnessLevels array. The brightness values must be non-negative and non-decreasing. This must be overridden in platform specific overlays --\u003e \u003carray name=\"config_autoBrightnessDisplayValuesNits\"\u003e \u003citem\u003e10.45935\u003c/item\u003e \u003c!-- 0-16 --\u003e \u003citem\u003e29.25559\u003c/item\u003e \u003c!-- 16-32 --\u003e \u003citem\u003e34.240692\u003c/item\u003e \u003c!-- 32-50 --\u003e \u003citem\u003e37.514347\u003c/item\u003e \u003c!-- 50-100 --\u003e \u003citem\u003e40.018696\u003c/item\u003e \u003c!-- 100-140 --\u003e \u003citem\u003e46.885098\u003c/item\u003e \u003c!-- 140-180 --\u003e \u003citem\u003e51.626434\u003c/item\u003e \u003c!-- 180-240 --\u003e \u003citem\u003e58.610405\u003c/item\u003e \u003c!-- 240-300 --\u003e \u003citem\u003e66.890915\u003c/item\u003e \u003c!-- 300-600 --\u003e \u003citem\u003e77.61644\u003c/item\u003e \u003c!-- 600-800 --\u003e \u003citem\u003e90.221886\u003c/item\u003e \u003c!-- 800-1000 --\u003e \u003citem\u003e105.80314\u003c/item\u003e \u003c!-- 1000-2000 --\u003e \u003citem\u003e126.073845\u003c/item\u003e \u003c!-- 2000-3000 --\u003e \u003citem\u003e154.16931\u003c/item\u003e \u003c!-- 3000-4000 --\u003e \u003citem\u003e191.83717\u003c/item\u003e \u003c!-- 4000-5000 --\u003e \u003citem\u003e240.74442\u003c/item\u003e \u003c!-- 5000-6000 --\u003e \u003citem\u003e294.84857\u003c/item\u003e \u003c!-- 6000-8000 --\u003e \u003citem\u003e348.05453\u003c/item\u003e \u003c!-- 8000-10000 --\u003e \u003citem\u003e394.98703\u003c/item\u003e \u003c!-- 10000-20000 --\u003e \u003citem\u003e405.2315\u003c/item\u003e \u003c!-- 20000-30000 --\u003e \u003citem\u003e410.3658\u003c/item\u003e \u003c!-- 30000+ --\u003e \u003c/array\u003e \u003c!-- An array describing the screen's backlight values corresponding to the brightness values in the config_screenBrightnessNits array. This array should be equal in size to config_screenBrightnessBacklight. --\u003e \u003cinteger-array name=\"config_screenBrightnessBacklight\"\u003e \u003citem\u003e0\u003c/item\u003e \u003citem\u003e5\u003c/item\u003e \u003citem\u003e10\u003c/item\u003e \u003citem\u003e15\u003c/item\u003e \u003citem\u003e20\u003c/item\u003e \u003citem\u003e25\u003c/item\u003e \u003citem\u003e30\u003c/item\u003e \u003citem\u003e35\u003c/item\u003e \u003citem\u003e40\u003c/item\u003e \u003citem\u003e45\u003c/item\u003e \u003citem\u003e60\u003c/item\u003e \u003citem\u003e75\u003c/item\u003e \u003citem\u003e90\u003c/item\u003e \u003citem\u003e105\u003c/item\u003e \u003citem\u003e120\u003c/item\u003e \u003citem\u003e135\u003c/item\u003e \u003citem\u003e150\u003c/item\u003e \u003citem\u003e165\u003c/item\u003e \u003citem\u003e180\u003c/item\u003e \u003citem\u003e195\u003c/item\u003e \u003citem\u003e210\u003c/item\u003e \u003citem\u003e225\u003c/item\u003e \u003citem\u003e240\u003c/item\u003e \u003citem\u003e255\u003c/item\u003e \u003c/integer-array\u003e æŸ¥çœ‹å…‰æ„Ÿæ•°æ®ä¸ŠæŠ¥åŸå§‹å€¼èŠ‚ç‚¹ï¼š cat /sys/devices/virtual/sprd_sensorhub/sensor_hub/raw_data_als å¯ä»¥è·Ÿä¸€ä¸‹ä»£ç å°±ä¼šå‘ç°åœ¨ kernel ä¸‹ï¼š kernel4.14\\drivers\\iio\\sprd_hub\\shub_core.c static ssize_t raw_data_als_show(struct device *dev, struct device_attribute *attr, char *buf) { struct shub_data *sensor = dev_get_drvdata(dev); u8 data[2]; u16 *ptr; int err; ptr = (u16 *)data; if (sensor-\u003emcu_mode \u003c= SHUB_OPDOWNLOAD) { dev_err(dev, \"mcu_mode == SHUB_BOOT!\\n\"); return -EINVAL; } err = shub_sipc_read(sensor, SHUB_GET_LIGHT_RAWDATA_SUBTYPE, data, sizeof(data)); if (err \u003c 0) { dev_err(dev, \"read RegMapR_GetLightRawData failed!\\n\"); return err; } return sprintf(buf, \"%d\\n\", ","date":"2025-06-30","objectID":"/posts/android%E5%85%89%E6%84%9F%E8%87%AA%E5%8A%A8%E8%B0%83%E8%8A%82%E4%BA%AE%E5%BA%A6_%E9%AB%98%E9%80%9A-%E5%85%89%E6%84%9F%E8%87%AA%E5%8A%A8%E8%B0%83%E8%8A%82%E9%85%8D%E7%BD%AE-xml-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Androidï¼šå…‰æ„Ÿè‡ªåŠ¨è°ƒèŠ‚äº®åº¦_é«˜é€š å…‰æ„Ÿè‡ªåŠ¨è°ƒèŠ‚é…ç½® xml-CSDNåšå®¢","uri":"/posts/android%E5%85%89%E6%84%9F%E8%87%AA%E5%8A%A8%E8%B0%83%E8%8A%82%E4%BA%AE%E5%BA%A6_%E9%AB%98%E9%80%9A-%E5%85%89%E6%84%9F%E8%87%AA%E5%8A%A8%E8%B0%83%E8%8A%82%E9%85%8D%E7%BD%AE-xml-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":null,"content":"REPO ","date":"2025-01-06","objectID":"/posts/%E7%BC%96%E8%AF%91-repo-%E8%B0%83%E8%AF%95-%E5%B7%A5%E7%A8%8B%E7%9B%B8%E5%85%B3/:1:0","tags":["blog","å·¥å…·"],"title":"ç¼–è¯‘ repo è°ƒè¯• å·¥ç¨‹ç›¸å…³","uri":"/posts/%E7%BC%96%E8%AF%91-repo-%E8%B0%83%E8%AF%95-%E5%B7%A5%E7%A8%8B%E7%9B%B8%E5%85%B3/#repo"},{"categories":null,"collections":null,"content":"ç¼–è¯‘ ç¼–è¯‘framework service make services -j16 push adb root; adb remount ; adb push out/target/product/qssi/system/framework/services.jar /system/framework/ adb root; adb remount ;adb push out/target/product/qssi/system/framework/services.jar /system/framework/; adb push out/target/product/qssi/system/framework/services.jar.bprof /system/framework/;adb push out/target/product/qssi/system/framework/services.jar.prof /system/framework/ ;adb push out/target/product/qssi/system/framework/oat/arm64/services.art /system/framework/oat/arm64/ ;adb push out/target/product/qssi/system/framework/oat/arm64/services.odex /system/framework/oat/arm64/ ; adb push out/target/product/qssi/system/framework/oat/arm64/services.vdex /system/framework/oat/arm64/ ; ç¼–è¯‘SystemUI make SystemUI -j16 surfaceflinger make surfaceflinger -j16 åªéœ€è¦æŠŠ system/bin/surfaceflinger push è¿›å»ï¼Œç„¶å kill surfaceflinger è¿›ç¨‹å°±å¯ä»¥ç”Ÿæ•ˆäº† ç¼–è¯‘frameworkä¸‹çš„jni cppæ–‡ä»¶éœ€è¦ç¼–è¯‘ï¼š # make libservices.core -j16 make libandroid_servers -j16 make services -j16 adb root; adb remount; adb push out/target/product/qssi/system/lib64/libandroid_servers.so /system/lib64/ ; adb push out/target/product/qssi/system/lib/libandroid_servers.so /system/lib/ ; adb push out/target/product/qssi/system/framework/services.jar /system/framework/ ; adb reboot ","date":"2025-01-06","objectID":"/posts/%E7%BC%96%E8%AF%91-repo-%E8%B0%83%E8%AF%95-%E5%B7%A5%E7%A8%8B%E7%9B%B8%E5%85%B3/:2:0","tags":["blog","å·¥å…·"],"title":"ç¼–è¯‘ repo è°ƒè¯• å·¥ç¨‹ç›¸å…³","uri":"/posts/%E7%BC%96%E8%AF%91-repo-%E8%B0%83%E8%AF%95-%E5%B7%A5%E7%A8%8B%E7%9B%B8%E5%85%B3/#ç¼–è¯‘"},{"categories":null,"collections":null,"content":"ç¼–è¯‘ ç¼–è¯‘framework service make services -j16 push adb root; adb remount ; adb push out/target/product/qssi/system/framework/services.jar /system/framework/ adb root; adb remount ;adb push out/target/product/qssi/system/framework/services.jar /system/framework/; adb push out/target/product/qssi/system/framework/services.jar.bprof /system/framework/;adb push out/target/product/qssi/system/framework/services.jar.prof /system/framework/ ;adb push out/target/product/qssi/system/framework/oat/arm64/services.art /system/framework/oat/arm64/ ;adb push out/target/product/qssi/system/framework/oat/arm64/services.odex /system/framework/oat/arm64/ ; adb push out/target/product/qssi/system/framework/oat/arm64/services.vdex /system/framework/oat/arm64/ ; ç¼–è¯‘SystemUI make SystemUI -j16 surfaceflinger make surfaceflinger -j16 åªéœ€è¦æŠŠ system/bin/surfaceflinger push è¿›å»ï¼Œç„¶å kill surfaceflinger è¿›ç¨‹å°±å¯ä»¥ç”Ÿæ•ˆäº† ç¼–è¯‘frameworkä¸‹çš„jni cppæ–‡ä»¶éœ€è¦ç¼–è¯‘ï¼š # make libservices.core -j16 make libandroid_servers -j16 make services -j16 adb root; adb remount; adb push out/target/product/qssi/system/lib64/libandroid_servers.so /system/lib64/ ; adb push out/target/product/qssi/system/lib/libandroid_servers.so /system/lib/ ; adb push out/target/product/qssi/system/framework/services.jar /system/framework/ ; adb reboot ","date":"2025-01-06","objectID":"/posts/%E7%BC%96%E8%AF%91-repo-%E8%B0%83%E8%AF%95-%E5%B7%A5%E7%A8%8B%E7%9B%B8%E5%85%B3/:2:0","tags":["blog","å·¥å…·"],"title":"ç¼–è¯‘ repo è°ƒè¯• å·¥ç¨‹ç›¸å…³","uri":"/posts/%E7%BC%96%E8%AF%91-repo-%E8%B0%83%E8%AF%95-%E5%B7%A5%E7%A8%8B%E7%9B%B8%E5%85%B3/#ç¼–è¯‘framework-service"},{"categories":null,"collections":null,"content":"ç¼–è¯‘ ç¼–è¯‘framework service make services -j16 push adb root; adb remount ; adb push out/target/product/qssi/system/framework/services.jar /system/framework/ adb root; adb remount ;adb push out/target/product/qssi/system/framework/services.jar /system/framework/; adb push out/target/product/qssi/system/framework/services.jar.bprof /system/framework/;adb push out/target/product/qssi/system/framework/services.jar.prof /system/framework/ ;adb push out/target/product/qssi/system/framework/oat/arm64/services.art /system/framework/oat/arm64/ ;adb push out/target/product/qssi/system/framework/oat/arm64/services.odex /system/framework/oat/arm64/ ; adb push out/target/product/qssi/system/framework/oat/arm64/services.vdex /system/framework/oat/arm64/ ; ç¼–è¯‘SystemUI make SystemUI -j16 surfaceflinger make surfaceflinger -j16 åªéœ€è¦æŠŠ system/bin/surfaceflinger push è¿›å»ï¼Œç„¶å kill surfaceflinger è¿›ç¨‹å°±å¯ä»¥ç”Ÿæ•ˆäº† ç¼–è¯‘frameworkä¸‹çš„jni cppæ–‡ä»¶éœ€è¦ç¼–è¯‘ï¼š # make libservices.core -j16 make libandroid_servers -j16 make services -j16 adb root; adb remount; adb push out/target/product/qssi/system/lib64/libandroid_servers.so /system/lib64/ ; adb push out/target/product/qssi/system/lib/libandroid_servers.so /system/lib/ ; adb push out/target/product/qssi/system/framework/services.jar /system/framework/ ; adb reboot ","date":"2025-01-06","objectID":"/posts/%E7%BC%96%E8%AF%91-repo-%E8%B0%83%E8%AF%95-%E5%B7%A5%E7%A8%8B%E7%9B%B8%E5%85%B3/:2:0","tags":["blog","å·¥å…·"],"title":"ç¼–è¯‘ repo è°ƒè¯• å·¥ç¨‹ç›¸å…³","uri":"/posts/%E7%BC%96%E8%AF%91-repo-%E8%B0%83%E8%AF%95-%E5%B7%A5%E7%A8%8B%E7%9B%B8%E5%85%B3/#ç¼–è¯‘systemui"},{"categories":null,"collections":null,"content":"ç¼–è¯‘ ç¼–è¯‘framework service make services -j16 push adb root; adb remount ; adb push out/target/product/qssi/system/framework/services.jar /system/framework/ adb root; adb remount ;adb push out/target/product/qssi/system/framework/services.jar /system/framework/; adb push out/target/product/qssi/system/framework/services.jar.bprof /system/framework/;adb push out/target/product/qssi/system/framework/services.jar.prof /system/framework/ ;adb push out/target/product/qssi/system/framework/oat/arm64/services.art /system/framework/oat/arm64/ ;adb push out/target/product/qssi/system/framework/oat/arm64/services.odex /system/framework/oat/arm64/ ; adb push out/target/product/qssi/system/framework/oat/arm64/services.vdex /system/framework/oat/arm64/ ; ç¼–è¯‘SystemUI make SystemUI -j16 surfaceflinger make surfaceflinger -j16 åªéœ€è¦æŠŠ system/bin/surfaceflinger push è¿›å»ï¼Œç„¶å kill surfaceflinger è¿›ç¨‹å°±å¯ä»¥ç”Ÿæ•ˆäº† ç¼–è¯‘frameworkä¸‹çš„jni cppæ–‡ä»¶éœ€è¦ç¼–è¯‘ï¼š # make libservices.core -j16 make libandroid_servers -j16 make services -j16 adb root; adb remount; adb push out/target/product/qssi/system/lib64/libandroid_servers.so /system/lib64/ ; adb push out/target/product/qssi/system/lib/libandroid_servers.so /system/lib/ ; adb push out/target/product/qssi/system/framework/services.jar /system/framework/ ; adb reboot ","date":"2025-01-06","objectID":"/posts/%E7%BC%96%E8%AF%91-repo-%E8%B0%83%E8%AF%95-%E5%B7%A5%E7%A8%8B%E7%9B%B8%E5%85%B3/:2:0","tags":["blog","å·¥å…·"],"title":"ç¼–è¯‘ repo è°ƒè¯• å·¥ç¨‹ç›¸å…³","uri":"/posts/%E7%BC%96%E8%AF%91-repo-%E8%B0%83%E8%AF%95-%E5%B7%A5%E7%A8%8B%E7%9B%B8%E5%85%B3/#surfaceflinger"},{"categories":null,"collections":null,"content":"ç¼–è¯‘ ç¼–è¯‘framework service make services -j16 push adb root; adb remount ; adb push out/target/product/qssi/system/framework/services.jar /system/framework/ adb root; adb remount ;adb push out/target/product/qssi/system/framework/services.jar /system/framework/; adb push out/target/product/qssi/system/framework/services.jar.bprof /system/framework/;adb push out/target/product/qssi/system/framework/services.jar.prof /system/framework/ ;adb push out/target/product/qssi/system/framework/oat/arm64/services.art /system/framework/oat/arm64/ ;adb push out/target/product/qssi/system/framework/oat/arm64/services.odex /system/framework/oat/arm64/ ; adb push out/target/product/qssi/system/framework/oat/arm64/services.vdex /system/framework/oat/arm64/ ; ç¼–è¯‘SystemUI make SystemUI -j16 surfaceflinger make surfaceflinger -j16 åªéœ€è¦æŠŠ system/bin/surfaceflinger push è¿›å»ï¼Œç„¶å kill surfaceflinger è¿›ç¨‹å°±å¯ä»¥ç”Ÿæ•ˆäº† ç¼–è¯‘frameworkä¸‹çš„jni cppæ–‡ä»¶éœ€è¦ç¼–è¯‘ï¼š # make libservices.core -j16 make libandroid_servers -j16 make services -j16 adb root; adb remount; adb push out/target/product/qssi/system/lib64/libandroid_servers.so /system/lib64/ ; adb push out/target/product/qssi/system/lib/libandroid_servers.so /system/lib/ ; adb push out/target/product/qssi/system/framework/services.jar /system/framework/ ; adb reboot ","date":"2025-01-06","objectID":"/posts/%E7%BC%96%E8%AF%91-repo-%E8%B0%83%E8%AF%95-%E5%B7%A5%E7%A8%8B%E7%9B%B8%E5%85%B3/:2:0","tags":["blog","å·¥å…·"],"title":"ç¼–è¯‘ repo è°ƒè¯• å·¥ç¨‹ç›¸å…³","uri":"/posts/%E7%BC%96%E8%AF%91-repo-%E8%B0%83%E8%AF%95-%E5%B7%A5%E7%A8%8B%E7%9B%B8%E5%85%B3/#ç¼–è¯‘frameworkä¸‹çš„jni"},{"categories":null,"collections":null,"content":"è°ƒè¯• è®¾ç½®ç”µé‡æ¸©åº¦ ,æ¸©åº¦æŠ¥è­¦åœ¨BatteryServiceï¼Œä½†æ˜¯ä½ç”µé‡ç°åœ¨ä¸åœ¨è¿™é‡Œã€‚ adb shell dumpsys battery set level 13 adb shell dumpsys battery set temp 551 2047 adb shell \"pm install-create\" 2048 adb shell \"pm install-write 2012419093 CtsSplitApp.apk /data/local/tmp/0_CtsSplitApp.apk\" 2049 adb push CtsSplitApp.apk /data/local/tmp/0_CtsSplitApp.apk 2050 adb shell \"pm install-write 2012419093 CtsSplitApp.apk /data/local/tmp/0_CtsSplitApp.apk\" 2051 adb shell \"pm install-commit 2021419093\" 2052 adb shell \"pm install-commit 2012419093\" 2053 adb shell \"pm list instrumentation\" 2054 adb shell \"pm set-app-links-user-selection\" 2055 adb shell \"pm list instrumentation\" 2056 adb shell \"pm set-app-links-user-selection\" repo forall -c \"pwd;git clean -df;git checkout -f\";repo sync -j4; ","date":"2025-01-06","objectID":"/posts/%E7%BC%96%E8%AF%91-repo-%E8%B0%83%E8%AF%95-%E5%B7%A5%E7%A8%8B%E7%9B%B8%E5%85%B3/:3:0","tags":["blog","å·¥å…·"],"title":"ç¼–è¯‘ repo è°ƒè¯• å·¥ç¨‹ç›¸å…³","uri":"/posts/%E7%BC%96%E8%AF%91-repo-%E8%B0%83%E8%AF%95-%E5%B7%A5%E7%A8%8B%E7%9B%B8%E5%85%B3/#è°ƒè¯•"},{"categories":null,"collections":null,"content":"èƒŒæ™¯ï¼š æµ‹è¯•æ­¥éª¤: 1ã€æ’å…¥sdå¡ 2ã€è§‚å¯Ÿsdå¡åå­— ï¼ˆSamsungï¼‰ 3ã€æ ¼å¼åŒ–sdå¡ å®æµ‹ç»“æœ: æ ¼å¼åŒ–SDcardå åå­—å˜æˆAndroid é¢„æœŸç»“æœ: æ ¼å¼åŒ–SDcardå åå­—ä¸ä¼šæ”¹å˜ æ ¼å¼åŒ–SDåï¼Œsdå¡æ˜¾ç¤ºçš„åç§°ä¼šå˜åŒ–ã€‚ è¿™ä¸ªé—®é¢˜è·Ÿè¸ªäº†ä¸€ä¸‹æ ¼å¼åŒ–çš„æµç¨‹ï¼š //SYSTEM/packages/apps/Settings/src/com/android/settings/deviceinfo/StorageWizardFormatConfirm.java builder.setPositiveButton( TextUtils.expandTemplate(getText(R.string.storage_menu_format_option), disk.getShortDescription()), (dialog, which) -\u003e { final Intent intent = new Intent(context, StorageWizardFormatProgress.class); intent.putExtra(EXTRA_DISK_ID, diskId); intent.putExtra(EXTRA_FORMAT_FORGET_UUID, formatForgetUuid); intent.putExtra(EXTRA_FORMAT_PRIVATE, formatPrivate); context.startActivity(intent); }); ///mnt/media/FH22/AP/SYSTEM/packages/apps/Settings/src/com/android/settings/deviceinfo/StorageWizardFormatProgress.java setHeaderText(R.string.storage_wizard_format_progress_title, getDiskShortDescription()); setBodyText(R.string.storage_wizard_format_progress_body, getDiskDescription()); setBackButtonVisibility(View.INVISIBLE); setNextButtonVisibility(View.INVISIBLE); mTask = (PartitionTask) getLastCustomNonConfigurationInstance(); if (mTask == null) { mTask = new PartitionTask(); mTask.setActivity(this); mTask.execute(); } else { mTask.setActivity(this); } @Override protected Exception doInBackground(Void... params) { final StorageWizardFormatProgress activity = mActivity; final StorageManager storage = mActivity.mStorage; try { if (activity.mFormatPrivate) { storage.partitionPrivate(activity.mDisk.getId()); publishProgress(40); final VolumeInfo privateVol = activity.findFirstVolume(TYPE_PRIVATE, 50); final CompletableFuture\u003cPersistableBundle\u003e result = new CompletableFuture\u003c\u003e(); if(null != privateVol) { storage.benchmark(privateVol.getId(), new IVoldTaskListener.Stub() { @Override public void onStatus(int status, PersistableBundle extras) { // Map benchmark 0-100% progress onto 40-80% publishProgress(40 + ((status * 40) / 100)); } @Override public void onFinished(int status, PersistableBundle extras) { result.complete(extras); } }); mPrivateBench = result.get(60, TimeUnit.SECONDS).getLong(\"run\", Long.MAX_VALUE); } // If we just adopted the device that had been providing // physical storage, then automatically move storage to the // new emulated volume. if (activity.mDisk.isDefaultPrimary() \u0026\u0026 Objects.equals(storage.getPrimaryStorageUuid(), StorageManager.UUID_PRIMARY_PHYSICAL)) { Log.d(TAG, \"Just formatted primary physical; silently moving \" + \"storage to new emulated volume\"); storage.setPrimaryStorageUuid(privateVol.getFsUuid(), new SilentObserver()); } } else { storage.partitionPublic(activity.mDisk.getId()); } return null; } catch (Exception e) { return e; } } storage.partitionPublic(activity.mDisk.getId()); ///mnt/media/FH22/AP/SYSTEM/frameworks/base/core/java/android/os/storage/StorageManager.java public void partitionPublic(String diskId) { try { mStorageManager.partitionPublic(diskId); } catch (RemoteException e) { throw e.rethrowFromSystemServer(); } } ///mnt/media/FH22/AP/SYSTEM/frameworks/base/services/core/java/com/android/server/StorageManagerService.java public void partitionPublic(String diskId) { super.partitionPublic_enforcePermission(); final CountDownLatch latch = findOrCreateDiskScanLatch(diskId); try { mVold.partition(diskId, IVold.PARTITION_TYPE_PUBLIC, -1); waitForLatch(latch, \"partitionPublic\", 3 * DateUtils.MINUTE_IN_MILLIS); } catch (Exception e) { Slog.wtf(TAG, e); } } æˆ‘ä»¬æ ¹æ®sdka çš„exfatæ ¼å¼ï¼Œæœ‰ä¸ªaidl è°ƒç”¨ï¼Œç„¶åä¼šè°ƒç”¨åˆ°exfat çš„voldé‡Œé¢æ¥å‡ºæ¥format ///mnt/media/FH22/AP/SYSTEM/system/vold/fs/Exfat.cpp static const char* kMkfsPath = \"/system/bin/mkfs.exfat\"; static const char* kFsckPath = \"/system/bin/fsck.exfat\"; status_t Format(const std::string\u0026 source) { std::vector\u003cstd::string\u003e cmd; cmd.push_back(kMkfsPath); cmd.push_back(\"-n\"); cmd.push_back(\"android\"); cmd.push_back(source); int rc = ForkExecvp(cmd); if (rc == 0) { LOG(INFO) \u003c\u003c \"Format OK\"; return 0; } else { LOG(ERROR) \u003c\u003c \"Format failed (code \" \u003c\u003c rc \u003c\u003c \")\"; errno = EIO; return -1; } return 0; } cmd.push_back(\"-n\"); cmd.push_","date":"2025-01-02","objectID":"/posts/sd-%E5%8D%A1-%E5%AD%98%E5%82%A8-%E6%8C%82%E8%BD%BD%E7%9B%B8%E5%85%B3/:0:0","tags":["blog","æ¡ˆä¾‹åˆ†æ"],"title":"SD å¡ å­˜å‚¨ æŒ‚è½½ç›¸å…³","uri":"/posts/sd-%E5%8D%A1-%E5%AD%98%E5%82%A8-%E6%8C%82%E8%BD%BD%E7%9B%B8%E5%85%B3/#"},{"categories":["ç”Ÿæ´»"],"collections":null,"content":"FPR å†…ç½‘ç©¿é€ éœ€è¦å†…ç½‘çš„æœºå™¨çš„å¼ºå¤§çš„CPU ç»™AIè¯†åˆ«æä¾›åŠ©åŠ› å€Ÿç”¨äº†è…¾è®¯äº‘å†…ç½‘ç©¿é€æ¥è”é€š è…¾è®¯äº‘æœåŠ¡å™¨è¿è¡Œçš„ä¸ºæœåŠ¡ç«¯ï¼Œ å±€åŸŸç½‘å†…æœºå­è¿è¡Œçš„ä¸ºå®¢æˆ·ç«¯ NASæœºå™¨ç§°ä¸ºè®¿é—®ç«¯ ä¸€ ä¸‹è½½ frpåŒ… æŒ‰æ¨èlinuxä¸‹è½½äº† 0.37æˆ–è€…0.38 è¯•éªŒä¸‹æ¥ä½¿ç”¨ç¨³å®š wget https://github.com/fatedier/frp/releases/download/v0.38.0/frp_0.38.0_linux_amd64.tar.gz äºŒ æœåŠ¡ç«¯å®‰è£… æ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ æ‰§è¡ŒÂ cd frp_0.38.0_linux_amd64/è¿›å…¥æ–‡ä»¶å¤¹ ä¿®æ”¹é…ç½®æ–‡ä»¶#ä¸‰ æœåŠ¡ç«¯é…ç½® sudo chmod 755 ./frps èµ‹äºˆ å¯åŠ¨è¿è¡Œ åœ¨å®‰è£…å¥½çš„ç›®å½•å†… æ‰§è¡Œ./frps -c ./frps.iniå‰å°å¯åŠ¨å‘½ä»¤ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frps -c ./frps.ini \u0026Â åå°ä¿æŒå¯åŠ¨ _åæœŸè¿˜å¯ä»¥è®¾ç½®è‡ªåŠ¨è¿è¡Œ #TODOï¼š ä¸‰ æœåŠ¡ç«¯é…ç½® [common] bind_addr=0.0.0.0 bind_port = 7000 token=12345678 dashboard_port = 7500 dashboard_user = admin dashboard_pwd = admin123 é…ç½®è¯´æ˜ï¼š â€œbind_addr\"æ˜¯æœåŠ¡å™¨æœ¬åœ°IPï¼Œä¸æ”¹ã€‚ â€œbind_port\"æ˜¯frpç›‘å¬ç«¯å£ã€‚ â€œtoken\"æ˜¯éªŒè¯tokenå»ºè®®è®¾ç½®ä¸Šã€‚ â€œdashboard_port\"æ˜¯frpé¢æ¿ç«¯å£ã€‚ â€œdashboard_user\"â€œdashboard_pwd\"æ˜¯é¢æ¿çš„è´¦æˆ·å¯†ç ã€‚ token å»ºè®®å¤æ‚ä¸€äº›ï¼Œå±è”½ä¸€äº›æ‰«æè®¿é—® å›› è®¿é—®frpæ§åˆ¶é¢æ¿ é¢æ¿ä»…ä¾›å‚è€ƒï¼Œå¯ç”¨å¯ä¸ç”¨ã€‚è®¿é—®Â http://æœåŠ¡å™¨ip:7500 ä¸Šé¢é…ç½®çš„7500ç«¯å£ï¼Œä½¿ç”¨ä¸Šé¢é…ç½®çš„ç”¨æˆ·åå’Œå¯†ç  admin/admin123 äº” å®¢æˆ·ç«¯é…ç½®ä¿®æ”¹ å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¸‹è½½åŒæ ·çš„æ–‡ä»¶ frp_0.38.0_linux_amd64.tar.gz åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ ç„¶åè¿›å…¥ï¼Œ ç¼–è¾‘å®¢æˆ·ç«¯é…ç½®\"frpc.ini\"æ–‡ä»¶ [common] server_addr = å…¬ç½‘IP è…¾è®¯æœåŠ¡å™¨çš„åœ°å€ server_port = 7000 ä¸Šé¢æœåŠ¡ç«¯é…ç½®çš„ç«¯å£ token=1235678 ç›¸å½“äºå¯†ç  [RDP] type = tcp local_ip = 127.0.0.1 æœ¬åœ°å›ç¯åœ°å€ local_port = 8060 å±€åŸŸç½‘å®¢æˆ·ç«¯çš„ç«¯å£ remote_port = 6000 æœåŠ¡ç«¯çš„ç«¯å£ï¼Œç”¨äºç»™è®¿é—®ç«¯ä½¿ç”¨ è¯´æ˜ï¼š å®¢æˆ·ç«¯è¿æ¥è…¾è®¯äº‘çš„åœ°å€ å…¬ç½‘IP ç«¯å£7000 token è®¿é—®ç«¯è¿æ¥è…¾è®¯äº‘çš„å…¬ç½‘IP 6000 ï¼Œä¼šfrpsè½¬åˆ° å®¢æˆ·ç«¯çš„8060ç«¯å£ å…­ å®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯ æ‰§è¡Œ./frpc -c ./frpc.iniå‰å°å¯åŠ¨å‘½ä»¤ è¿æ¥æœåŠ¡ç«¯ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frpc -c ./frpc.ini \u0026Â åå°ä¿æŒå¯åŠ¨ ä¸ƒ MT Photo AI è·‘ aiçš„æœºå™¨ä½¿ç”¨çš„ubuntuç³»ç»Ÿ å®‰è£…docker ä¸‹è½½é•œåƒ sudo docker pull mtphotos/mt-photos-ai è¿è¡Œè„šæœ¬ #API_AUTH_KEYè‡ªè¡Œè®¾ç½® sudo docker run -i -p 8060:8000 -e API_AUTH_KEY=mt_photos_ai_extra_secret --name mt-photos-ai2 mtphotos/mt-photos-ai:latest ä¼šç›‘å¬ 8060ç«¯å£ å¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤æ¥çœ‹çœ‹é€šä¸é€š curl --location --request POST 'http://127.0.0.1:8060/check' \\ --header 'api-key: mt_photos_ai_extra_secret' å…« è·‘é€šæ•´ä¸ªé“¾è·¯ MT Photo è°ƒç”¨ å…¬ç½‘IP:6000 ç«¯å£ api-key FRPS ä¼šå»è°ƒç”¨ å®¢æˆ·ç«¯çš„ 8060ç«¯å£ ä¹ æ˜¯å¦éœ€è¦å¼€æœºå¯åŠ¨ ç›®å‰ä½¿ç”¨çš„åŠŸèƒ½æ˜¯ä¸€ä¸ªä¸å¸¸ç”¨çš„åŠŸèƒ½ï¼ŒFRPSè¿æ¥æ²¡æœ‰è¯†åˆ«æ¥æºæ‰€ä»¥è®¡åˆ’éšç”¨éš‹å¼€ï¼Œä¸è‡ªåŠ¨å¯åŠ¨ã€‚ 9.1 è®¾ç½®äº‘æœåŠ¡å™¨ç«¯å¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frps.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frps daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/etc/frps/frp_0.38.0_linux_amd64/frps -c /etc/frps/frp_0.38.0_linux_amd64/frps.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpsçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frps systemctl daemon-reload systemctl start frps #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ systemctl enable frps 9.2 è®¾ç½®å±€åŸŸç½‘æœºå­frpcå¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frpc.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frpc daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/home/wentao/frps/frp_0.37.0_linux_amd64/frpc -c /home/wentao/frps/frp_0.37.0_linux_amd64/frpc.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpcçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frpc sudo systemctl daemon-reload sudo systemctl start frpc #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ sudo systemctl enable frpc åã€å¤æ‚é…ç½® ä»¥ä¸‹é…ç½®ä¸­å¯†ç å’Œå…¬ç½‘IPéƒ½ä½¿ç”¨XXè¿›è¡Œäº†ä»£æ›¿ï¼Œå¤åˆ¶ä½¿ç”¨æ—¶è¯·æ³¨æ„ä¿®æ”¹ è¿œç¨‹æœåŠ¡ç«¯frps.ini [common] # frpç›‘å¬çš„ç«¯å£ï¼Œé»˜è®¤æ˜¯7000 bind_port = 7000 # æˆæƒç ,è¯·è‡ªå®šä¹‰æ›´æ”¹ token = XXXXX # è¿™ä¸ªtokenä¹‹ååœ¨å®¢æˆ·ç«¯ä¼šç”¨åˆ° # frpç®¡ç†åå°ç«¯å£ï¼Œè¯·æŒ‰è‡ªå·±éœ€æ±‚æ›´æ”¹ dashboard_port = 7500 # frpç®¡ç†åå°ç”¨æˆ·åå’Œå¯†ç ï¼Œè¯·æ”¹æˆè‡ªå·±çš„ dashboard_user = admin dashboard_pwd = XXXXX enable_prometheus = true # frpæ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frps.log log_level = info log_max_days = 7 å®¢æˆ·ç«¯çš„frpc.iniæ–‡ä»¶ [common] # è¿œç¨‹æœåŠ¡å™¨ipï¼Œè¿œç¨‹frpæœåŠ¡ç«¯å£ä»¥åŠè¿œç¨‹ç™»å½•å¯†ç  server_addr = 119.XX.XX.119 server_port = 7000 token = XXXXX # æ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frpc.log log_level = info log_max_days = 7 # å°†æœ¬åœ°æœºçš„22ç«¯å£æ˜ å°„è‡³è¿œç¨‹20022ç«¯å£ ä¸­æ‹¬å·å†…[ssh]åªä½œä¸ºæ ‡è¯†ï¼Œå¯è‡ªå®šä¹‰ [ssh] type = tcp local_ip = 127.0.0.1 local_port = 8060 remote_port = 6000 # å°†æœ¬æœºçš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹25901ç«¯å£ [vnc] type = tcp local_ip = 127.0.0.1 local_port = 8000 remote_port = 6001 # å°†æœ¬æœºæ‰€åœ¨å±€åŸŸç½‘å†…çš„192.168.0.129æœºå­çš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹55901ç«¯å£ [tsj-vnc] type = tcp local_ip = 192.168.0.129 local_port = 5901 remote_port = 55901 # ä»£ç†æœ¬æœºæ‰€åœ¨çš„å†…ç½‘ï¼Œå³è‹¥ç”¨æˆ·è®¾ç½®ä»£ç†ä¸ºå…¬ç½‘IP+ç«¯å£å³å¯è®¿é—®æœ¬æœºæ‰€åœ¨å†…ç½‘ï¼Œä½¿ç”¨çš„æ˜¯socks5ä»£ç†åè®®ï¼Œplugin_useråŠåé¢çš„å¯è®¾ç½®å¯ä¸è®¾ï¼Œä½†ä¸è®¾çš„é£é™©è¾ƒå¤§ [socks5_proxy] type = tcp remote_port = 7890 plugin = socks5 plugin = socks5 plugin_user = name plugin_passwd = password use_encryption = true use_compression = true é‡å¯frpæœåŠ¡ ","date":"2024-11-06","objectID":"/posts/mt-photos/:0:0","tags":["blog","ç½‘ç»œé…ç½®"],"title":"MT-Photos","uri":"/posts/mt-photos/#"},{"categories":["ç”Ÿæ´»"],"collections":null,"content":"FPR å†…ç½‘ç©¿é€ éœ€è¦å†…ç½‘çš„æœºå™¨çš„å¼ºå¤§çš„CPU ç»™AIè¯†åˆ«æä¾›åŠ©åŠ› å€Ÿç”¨äº†è…¾è®¯äº‘å†…ç½‘ç©¿é€æ¥è”é€š è…¾è®¯äº‘æœåŠ¡å™¨è¿è¡Œçš„ä¸ºæœåŠ¡ç«¯ï¼Œ å±€åŸŸç½‘å†…æœºå­è¿è¡Œçš„ä¸ºå®¢æˆ·ç«¯ NASæœºå™¨ç§°ä¸ºè®¿é—®ç«¯ ä¸€ ä¸‹è½½ frpåŒ… æŒ‰æ¨èlinuxä¸‹è½½äº† 0.37æˆ–è€…0.38 è¯•éªŒä¸‹æ¥ä½¿ç”¨ç¨³å®š wget https://github.com/fatedier/frp/releases/download/v0.38.0/frp_0.38.0_linux_amd64.tar.gz äºŒ æœåŠ¡ç«¯å®‰è£… æ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ æ‰§è¡ŒÂ cd frp_0.38.0_linux_amd64/è¿›å…¥æ–‡ä»¶å¤¹ ä¿®æ”¹é…ç½®æ–‡ä»¶#ä¸‰ æœåŠ¡ç«¯é…ç½® sudo chmod 755 ./frps èµ‹äºˆ å¯åŠ¨è¿è¡Œ åœ¨å®‰è£…å¥½çš„ç›®å½•å†… æ‰§è¡Œ./frps -c ./frps.iniå‰å°å¯åŠ¨å‘½ä»¤ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frps -c ./frps.ini \u0026Â åå°ä¿æŒå¯åŠ¨ _åæœŸè¿˜å¯ä»¥è®¾ç½®è‡ªåŠ¨è¿è¡Œ #TODOï¼š ä¸‰ æœåŠ¡ç«¯é…ç½® [common] bind_addr=0.0.0.0 bind_port = 7000 token=12345678 dashboard_port = 7500 dashboard_user = admin dashboard_pwd = admin123 é…ç½®è¯´æ˜ï¼š â€œbind_addr\"æ˜¯æœåŠ¡å™¨æœ¬åœ°IPï¼Œä¸æ”¹ã€‚ â€œbind_port\"æ˜¯frpç›‘å¬ç«¯å£ã€‚ â€œtoken\"æ˜¯éªŒè¯tokenå»ºè®®è®¾ç½®ä¸Šã€‚ â€œdashboard_port\"æ˜¯frpé¢æ¿ç«¯å£ã€‚ â€œdashboard_user\"â€œdashboard_pwd\"æ˜¯é¢æ¿çš„è´¦æˆ·å¯†ç ã€‚ token å»ºè®®å¤æ‚ä¸€äº›ï¼Œå±è”½ä¸€äº›æ‰«æè®¿é—® å›› è®¿é—®frpæ§åˆ¶é¢æ¿ é¢æ¿ä»…ä¾›å‚è€ƒï¼Œå¯ç”¨å¯ä¸ç”¨ã€‚è®¿é—®Â http://æœåŠ¡å™¨ip:7500 ä¸Šé¢é…ç½®çš„7500ç«¯å£ï¼Œä½¿ç”¨ä¸Šé¢é…ç½®çš„ç”¨æˆ·åå’Œå¯†ç  admin/admin123 äº” å®¢æˆ·ç«¯é…ç½®ä¿®æ”¹ å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¸‹è½½åŒæ ·çš„æ–‡ä»¶ frp_0.38.0_linux_amd64.tar.gz åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ ç„¶åè¿›å…¥ï¼Œ ç¼–è¾‘å®¢æˆ·ç«¯é…ç½®\"frpc.ini\"æ–‡ä»¶ [common] server_addr = å…¬ç½‘IP è…¾è®¯æœåŠ¡å™¨çš„åœ°å€ server_port = 7000 ä¸Šé¢æœåŠ¡ç«¯é…ç½®çš„ç«¯å£ token=1235678 ç›¸å½“äºå¯†ç  [RDP] type = tcp local_ip = 127.0.0.1 æœ¬åœ°å›ç¯åœ°å€ local_port = 8060 å±€åŸŸç½‘å®¢æˆ·ç«¯çš„ç«¯å£ remote_port = 6000 æœåŠ¡ç«¯çš„ç«¯å£ï¼Œç”¨äºç»™è®¿é—®ç«¯ä½¿ç”¨ è¯´æ˜ï¼š å®¢æˆ·ç«¯è¿æ¥è…¾è®¯äº‘çš„åœ°å€ å…¬ç½‘IP ç«¯å£7000 token è®¿é—®ç«¯è¿æ¥è…¾è®¯äº‘çš„å…¬ç½‘IP 6000 ï¼Œä¼šfrpsè½¬åˆ° å®¢æˆ·ç«¯çš„8060ç«¯å£ å…­ å®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯ æ‰§è¡Œ./frpc -c ./frpc.iniå‰å°å¯åŠ¨å‘½ä»¤ è¿æ¥æœåŠ¡ç«¯ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frpc -c ./frpc.ini \u0026Â åå°ä¿æŒå¯åŠ¨ ä¸ƒ MT Photo AI è·‘ aiçš„æœºå™¨ä½¿ç”¨çš„ubuntuç³»ç»Ÿ å®‰è£…docker ä¸‹è½½é•œåƒ sudo docker pull mtphotos/mt-photos-ai è¿è¡Œè„šæœ¬ #API_AUTH_KEYè‡ªè¡Œè®¾ç½® sudo docker run -i -p 8060:8000 -e API_AUTH_KEY=mt_photos_ai_extra_secret --name mt-photos-ai2 mtphotos/mt-photos-ai:latest ä¼šç›‘å¬ 8060ç«¯å£ å¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤æ¥çœ‹çœ‹é€šä¸é€š curl --location --request POST 'http://127.0.0.1:8060/check' \\ --header 'api-key: mt_photos_ai_extra_secret' å…« è·‘é€šæ•´ä¸ªé“¾è·¯ MT Photo è°ƒç”¨ å…¬ç½‘IP:6000 ç«¯å£ api-key FRPS ä¼šå»è°ƒç”¨ å®¢æˆ·ç«¯çš„ 8060ç«¯å£ ä¹ æ˜¯å¦éœ€è¦å¼€æœºå¯åŠ¨ ç›®å‰ä½¿ç”¨çš„åŠŸèƒ½æ˜¯ä¸€ä¸ªä¸å¸¸ç”¨çš„åŠŸèƒ½ï¼ŒFRPSè¿æ¥æ²¡æœ‰è¯†åˆ«æ¥æºæ‰€ä»¥è®¡åˆ’éšç”¨éš‹å¼€ï¼Œä¸è‡ªåŠ¨å¯åŠ¨ã€‚ 9.1 è®¾ç½®äº‘æœåŠ¡å™¨ç«¯å¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frps.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frps daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/etc/frps/frp_0.38.0_linux_amd64/frps -c /etc/frps/frp_0.38.0_linux_amd64/frps.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpsçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frps systemctl daemon-reload systemctl start frps #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ systemctl enable frps 9.2 è®¾ç½®å±€åŸŸç½‘æœºå­frpcå¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frpc.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frpc daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/home/wentao/frps/frp_0.37.0_linux_amd64/frpc -c /home/wentao/frps/frp_0.37.0_linux_amd64/frpc.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpcçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frpc sudo systemctl daemon-reload sudo systemctl start frpc #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ sudo systemctl enable frpc åã€å¤æ‚é…ç½® ä»¥ä¸‹é…ç½®ä¸­å¯†ç å’Œå…¬ç½‘IPéƒ½ä½¿ç”¨XXè¿›è¡Œäº†ä»£æ›¿ï¼Œå¤åˆ¶ä½¿ç”¨æ—¶è¯·æ³¨æ„ä¿®æ”¹ è¿œç¨‹æœåŠ¡ç«¯frps.ini [common] # frpç›‘å¬çš„ç«¯å£ï¼Œé»˜è®¤æ˜¯7000 bind_port = 7000 # æˆæƒç ,è¯·è‡ªå®šä¹‰æ›´æ”¹ token = XXXXX # è¿™ä¸ªtokenä¹‹ååœ¨å®¢æˆ·ç«¯ä¼šç”¨åˆ° # frpç®¡ç†åå°ç«¯å£ï¼Œè¯·æŒ‰è‡ªå·±éœ€æ±‚æ›´æ”¹ dashboard_port = 7500 # frpç®¡ç†åå°ç”¨æˆ·åå’Œå¯†ç ï¼Œè¯·æ”¹æˆè‡ªå·±çš„ dashboard_user = admin dashboard_pwd = XXXXX enable_prometheus = true # frpæ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frps.log log_level = info log_max_days = 7 å®¢æˆ·ç«¯çš„frpc.iniæ–‡ä»¶ [common] # è¿œç¨‹æœåŠ¡å™¨ipï¼Œè¿œç¨‹frpæœåŠ¡ç«¯å£ä»¥åŠè¿œç¨‹ç™»å½•å¯†ç  server_addr = 119.XX.XX.119 server_port = 7000 token = XXXXX # æ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frpc.log log_level = info log_max_days = 7 # å°†æœ¬åœ°æœºçš„22ç«¯å£æ˜ å°„è‡³è¿œç¨‹20022ç«¯å£ ä¸­æ‹¬å·å†…[ssh]åªä½œä¸ºæ ‡è¯†ï¼Œå¯è‡ªå®šä¹‰ [ssh] type = tcp local_ip = 127.0.0.1 local_port = 8060 remote_port = 6000 # å°†æœ¬æœºçš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹25901ç«¯å£ [vnc] type = tcp local_ip = 127.0.0.1 local_port = 8000 remote_port = 6001 # å°†æœ¬æœºæ‰€åœ¨å±€åŸŸç½‘å†…çš„192.168.0.129æœºå­çš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹55901ç«¯å£ [tsj-vnc] type = tcp local_ip = 192.168.0.129 local_port = 5901 remote_port = 55901 # ä»£ç†æœ¬æœºæ‰€åœ¨çš„å†…ç½‘ï¼Œå³è‹¥ç”¨æˆ·è®¾ç½®ä»£ç†ä¸ºå…¬ç½‘IP+ç«¯å£å³å¯è®¿é—®æœ¬æœºæ‰€åœ¨å†…ç½‘ï¼Œä½¿ç”¨çš„æ˜¯socks5ä»£ç†åè®®ï¼Œplugin_useråŠåé¢çš„å¯è®¾ç½®å¯ä¸è®¾ï¼Œä½†ä¸è®¾çš„é£é™©è¾ƒå¤§ [socks5_proxy] type = tcp remote_port = 7890 plugin = socks5 plugin = socks5 plugin_user = name plugin_passwd = password use_encryption = true use_compression = true é‡å¯frpæœåŠ¡ ","date":"2024-11-06","objectID":"/posts/mt-photos/:0:0","tags":["blog","ç½‘ç»œé…ç½®"],"title":"MT-Photos","uri":"/posts/mt-photos/#fpr-å†…ç½‘ç©¿é€"},{"categories":["ç”Ÿæ´»"],"collections":null,"content":"FPR å†…ç½‘ç©¿é€ éœ€è¦å†…ç½‘çš„æœºå™¨çš„å¼ºå¤§çš„CPU ç»™AIè¯†åˆ«æä¾›åŠ©åŠ› å€Ÿç”¨äº†è…¾è®¯äº‘å†…ç½‘ç©¿é€æ¥è”é€š è…¾è®¯äº‘æœåŠ¡å™¨è¿è¡Œçš„ä¸ºæœåŠ¡ç«¯ï¼Œ å±€åŸŸç½‘å†…æœºå­è¿è¡Œçš„ä¸ºå®¢æˆ·ç«¯ NASæœºå™¨ç§°ä¸ºè®¿é—®ç«¯ ä¸€ ä¸‹è½½ frpåŒ… æŒ‰æ¨èlinuxä¸‹è½½äº† 0.37æˆ–è€…0.38 è¯•éªŒä¸‹æ¥ä½¿ç”¨ç¨³å®š wget https://github.com/fatedier/frp/releases/download/v0.38.0/frp_0.38.0_linux_amd64.tar.gz äºŒ æœåŠ¡ç«¯å®‰è£… æ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ æ‰§è¡ŒÂ cd frp_0.38.0_linux_amd64/è¿›å…¥æ–‡ä»¶å¤¹ ä¿®æ”¹é…ç½®æ–‡ä»¶#ä¸‰ æœåŠ¡ç«¯é…ç½® sudo chmod 755 ./frps èµ‹äºˆ å¯åŠ¨è¿è¡Œ åœ¨å®‰è£…å¥½çš„ç›®å½•å†… æ‰§è¡Œ./frps -c ./frps.iniå‰å°å¯åŠ¨å‘½ä»¤ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frps -c ./frps.ini \u0026Â åå°ä¿æŒå¯åŠ¨ _åæœŸè¿˜å¯ä»¥è®¾ç½®è‡ªåŠ¨è¿è¡Œ #TODOï¼š ä¸‰ æœåŠ¡ç«¯é…ç½® [common] bind_addr=0.0.0.0 bind_port = 7000 token=12345678 dashboard_port = 7500 dashboard_user = admin dashboard_pwd = admin123 é…ç½®è¯´æ˜ï¼š â€œbind_addr\"æ˜¯æœåŠ¡å™¨æœ¬åœ°IPï¼Œä¸æ”¹ã€‚ â€œbind_port\"æ˜¯frpç›‘å¬ç«¯å£ã€‚ â€œtoken\"æ˜¯éªŒè¯tokenå»ºè®®è®¾ç½®ä¸Šã€‚ â€œdashboard_port\"æ˜¯frpé¢æ¿ç«¯å£ã€‚ â€œdashboard_user\"â€œdashboard_pwd\"æ˜¯é¢æ¿çš„è´¦æˆ·å¯†ç ã€‚ token å»ºè®®å¤æ‚ä¸€äº›ï¼Œå±è”½ä¸€äº›æ‰«æè®¿é—® å›› è®¿é—®frpæ§åˆ¶é¢æ¿ é¢æ¿ä»…ä¾›å‚è€ƒï¼Œå¯ç”¨å¯ä¸ç”¨ã€‚è®¿é—®Â http://æœåŠ¡å™¨ip:7500 ä¸Šé¢é…ç½®çš„7500ç«¯å£ï¼Œä½¿ç”¨ä¸Šé¢é…ç½®çš„ç”¨æˆ·åå’Œå¯†ç  admin/admin123 äº” å®¢æˆ·ç«¯é…ç½®ä¿®æ”¹ å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¸‹è½½åŒæ ·çš„æ–‡ä»¶ frp_0.38.0_linux_amd64.tar.gz åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ ç„¶åè¿›å…¥ï¼Œ ç¼–è¾‘å®¢æˆ·ç«¯é…ç½®\"frpc.ini\"æ–‡ä»¶ [common] server_addr = å…¬ç½‘IP è…¾è®¯æœåŠ¡å™¨çš„åœ°å€ server_port = 7000 ä¸Šé¢æœåŠ¡ç«¯é…ç½®çš„ç«¯å£ token=1235678 ç›¸å½“äºå¯†ç  [RDP] type = tcp local_ip = 127.0.0.1 æœ¬åœ°å›ç¯åœ°å€ local_port = 8060 å±€åŸŸç½‘å®¢æˆ·ç«¯çš„ç«¯å£ remote_port = 6000 æœåŠ¡ç«¯çš„ç«¯å£ï¼Œç”¨äºç»™è®¿é—®ç«¯ä½¿ç”¨ è¯´æ˜ï¼š å®¢æˆ·ç«¯è¿æ¥è…¾è®¯äº‘çš„åœ°å€ å…¬ç½‘IP ç«¯å£7000 token è®¿é—®ç«¯è¿æ¥è…¾è®¯äº‘çš„å…¬ç½‘IP 6000 ï¼Œä¼šfrpsè½¬åˆ° å®¢æˆ·ç«¯çš„8060ç«¯å£ å…­ å®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯ æ‰§è¡Œ./frpc -c ./frpc.iniå‰å°å¯åŠ¨å‘½ä»¤ è¿æ¥æœåŠ¡ç«¯ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frpc -c ./frpc.ini \u0026Â åå°ä¿æŒå¯åŠ¨ ä¸ƒ MT Photo AI è·‘ aiçš„æœºå™¨ä½¿ç”¨çš„ubuntuç³»ç»Ÿ å®‰è£…docker ä¸‹è½½é•œåƒ sudo docker pull mtphotos/mt-photos-ai è¿è¡Œè„šæœ¬ #API_AUTH_KEYè‡ªè¡Œè®¾ç½® sudo docker run -i -p 8060:8000 -e API_AUTH_KEY=mt_photos_ai_extra_secret --name mt-photos-ai2 mtphotos/mt-photos-ai:latest ä¼šç›‘å¬ 8060ç«¯å£ å¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤æ¥çœ‹çœ‹é€šä¸é€š curl --location --request POST 'http://127.0.0.1:8060/check' \\ --header 'api-key: mt_photos_ai_extra_secret' å…« è·‘é€šæ•´ä¸ªé“¾è·¯ MT Photo è°ƒç”¨ å…¬ç½‘IP:6000 ç«¯å£ api-key FRPS ä¼šå»è°ƒç”¨ å®¢æˆ·ç«¯çš„ 8060ç«¯å£ ä¹ æ˜¯å¦éœ€è¦å¼€æœºå¯åŠ¨ ç›®å‰ä½¿ç”¨çš„åŠŸèƒ½æ˜¯ä¸€ä¸ªä¸å¸¸ç”¨çš„åŠŸèƒ½ï¼ŒFRPSè¿æ¥æ²¡æœ‰è¯†åˆ«æ¥æºæ‰€ä»¥è®¡åˆ’éšç”¨éš‹å¼€ï¼Œä¸è‡ªåŠ¨å¯åŠ¨ã€‚ 9.1 è®¾ç½®äº‘æœåŠ¡å™¨ç«¯å¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frps.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frps daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/etc/frps/frp_0.38.0_linux_amd64/frps -c /etc/frps/frp_0.38.0_linux_amd64/frps.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpsçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frps systemctl daemon-reload systemctl start frps #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ systemctl enable frps 9.2 è®¾ç½®å±€åŸŸç½‘æœºå­frpcå¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frpc.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frpc daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/home/wentao/frps/frp_0.37.0_linux_amd64/frpc -c /home/wentao/frps/frp_0.37.0_linux_amd64/frpc.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpcçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frpc sudo systemctl daemon-reload sudo systemctl start frpc #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ sudo systemctl enable frpc åã€å¤æ‚é…ç½® ä»¥ä¸‹é…ç½®ä¸­å¯†ç å’Œå…¬ç½‘IPéƒ½ä½¿ç”¨XXè¿›è¡Œäº†ä»£æ›¿ï¼Œå¤åˆ¶ä½¿ç”¨æ—¶è¯·æ³¨æ„ä¿®æ”¹ è¿œç¨‹æœåŠ¡ç«¯frps.ini [common] # frpç›‘å¬çš„ç«¯å£ï¼Œé»˜è®¤æ˜¯7000 bind_port = 7000 # æˆæƒç ,è¯·è‡ªå®šä¹‰æ›´æ”¹ token = XXXXX # è¿™ä¸ªtokenä¹‹ååœ¨å®¢æˆ·ç«¯ä¼šç”¨åˆ° # frpç®¡ç†åå°ç«¯å£ï¼Œè¯·æŒ‰è‡ªå·±éœ€æ±‚æ›´æ”¹ dashboard_port = 7500 # frpç®¡ç†åå°ç”¨æˆ·åå’Œå¯†ç ï¼Œè¯·æ”¹æˆè‡ªå·±çš„ dashboard_user = admin dashboard_pwd = XXXXX enable_prometheus = true # frpæ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frps.log log_level = info log_max_days = 7 å®¢æˆ·ç«¯çš„frpc.iniæ–‡ä»¶ [common] # è¿œç¨‹æœåŠ¡å™¨ipï¼Œè¿œç¨‹frpæœåŠ¡ç«¯å£ä»¥åŠè¿œç¨‹ç™»å½•å¯†ç  server_addr = 119.XX.XX.119 server_port = 7000 token = XXXXX # æ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frpc.log log_level = info log_max_days = 7 # å°†æœ¬åœ°æœºçš„22ç«¯å£æ˜ å°„è‡³è¿œç¨‹20022ç«¯å£ ä¸­æ‹¬å·å†…[ssh]åªä½œä¸ºæ ‡è¯†ï¼Œå¯è‡ªå®šä¹‰ [ssh] type = tcp local_ip = 127.0.0.1 local_port = 8060 remote_port = 6000 # å°†æœ¬æœºçš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹25901ç«¯å£ [vnc] type = tcp local_ip = 127.0.0.1 local_port = 8000 remote_port = 6001 # å°†æœ¬æœºæ‰€åœ¨å±€åŸŸç½‘å†…çš„192.168.0.129æœºå­çš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹55901ç«¯å£ [tsj-vnc] type = tcp local_ip = 192.168.0.129 local_port = 5901 remote_port = 55901 # ä»£ç†æœ¬æœºæ‰€åœ¨çš„å†…ç½‘ï¼Œå³è‹¥ç”¨æˆ·è®¾ç½®ä»£ç†ä¸ºå…¬ç½‘IP+ç«¯å£å³å¯è®¿é—®æœ¬æœºæ‰€åœ¨å†…ç½‘ï¼Œä½¿ç”¨çš„æ˜¯socks5ä»£ç†åè®®ï¼Œplugin_useråŠåé¢çš„å¯è®¾ç½®å¯ä¸è®¾ï¼Œä½†ä¸è®¾çš„é£é™©è¾ƒå¤§ [socks5_proxy] type = tcp remote_port = 7890 plugin = socks5 plugin = socks5 plugin_user = name plugin_passwd = password use_encryption = true use_compression = true é‡å¯frpæœåŠ¡ ","date":"2024-11-06","objectID":"/posts/mt-photos/:0:0","tags":["blog","ç½‘ç»œé…ç½®"],"title":"MT-Photos","uri":"/posts/mt-photos/#ä¸€-ä¸‹è½½-frpåŒ…"},{"categories":["ç”Ÿæ´»"],"collections":null,"content":"FPR å†…ç½‘ç©¿é€ éœ€è¦å†…ç½‘çš„æœºå™¨çš„å¼ºå¤§çš„CPU ç»™AIè¯†åˆ«æä¾›åŠ©åŠ› å€Ÿç”¨äº†è…¾è®¯äº‘å†…ç½‘ç©¿é€æ¥è”é€š è…¾è®¯äº‘æœåŠ¡å™¨è¿è¡Œçš„ä¸ºæœåŠ¡ç«¯ï¼Œ å±€åŸŸç½‘å†…æœºå­è¿è¡Œçš„ä¸ºå®¢æˆ·ç«¯ NASæœºå™¨ç§°ä¸ºè®¿é—®ç«¯ ä¸€ ä¸‹è½½ frpåŒ… æŒ‰æ¨èlinuxä¸‹è½½äº† 0.37æˆ–è€…0.38 è¯•éªŒä¸‹æ¥ä½¿ç”¨ç¨³å®š wget https://github.com/fatedier/frp/releases/download/v0.38.0/frp_0.38.0_linux_amd64.tar.gz äºŒ æœåŠ¡ç«¯å®‰è£… æ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ æ‰§è¡ŒÂ cd frp_0.38.0_linux_amd64/è¿›å…¥æ–‡ä»¶å¤¹ ä¿®æ”¹é…ç½®æ–‡ä»¶#ä¸‰ æœåŠ¡ç«¯é…ç½® sudo chmod 755 ./frps èµ‹äºˆ å¯åŠ¨è¿è¡Œ åœ¨å®‰è£…å¥½çš„ç›®å½•å†… æ‰§è¡Œ./frps -c ./frps.iniå‰å°å¯åŠ¨å‘½ä»¤ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frps -c ./frps.ini \u0026Â åå°ä¿æŒå¯åŠ¨ _åæœŸè¿˜å¯ä»¥è®¾ç½®è‡ªåŠ¨è¿è¡Œ #TODOï¼š ä¸‰ æœåŠ¡ç«¯é…ç½® [common] bind_addr=0.0.0.0 bind_port = 7000 token=12345678 dashboard_port = 7500 dashboard_user = admin dashboard_pwd = admin123 é…ç½®è¯´æ˜ï¼š â€œbind_addr\"æ˜¯æœåŠ¡å™¨æœ¬åœ°IPï¼Œä¸æ”¹ã€‚ â€œbind_port\"æ˜¯frpç›‘å¬ç«¯å£ã€‚ â€œtoken\"æ˜¯éªŒè¯tokenå»ºè®®è®¾ç½®ä¸Šã€‚ â€œdashboard_port\"æ˜¯frpé¢æ¿ç«¯å£ã€‚ â€œdashboard_user\"â€œdashboard_pwd\"æ˜¯é¢æ¿çš„è´¦æˆ·å¯†ç ã€‚ token å»ºè®®å¤æ‚ä¸€äº›ï¼Œå±è”½ä¸€äº›æ‰«æè®¿é—® å›› è®¿é—®frpæ§åˆ¶é¢æ¿ é¢æ¿ä»…ä¾›å‚è€ƒï¼Œå¯ç”¨å¯ä¸ç”¨ã€‚è®¿é—®Â http://æœåŠ¡å™¨ip:7500 ä¸Šé¢é…ç½®çš„7500ç«¯å£ï¼Œä½¿ç”¨ä¸Šé¢é…ç½®çš„ç”¨æˆ·åå’Œå¯†ç  admin/admin123 äº” å®¢æˆ·ç«¯é…ç½®ä¿®æ”¹ å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¸‹è½½åŒæ ·çš„æ–‡ä»¶ frp_0.38.0_linux_amd64.tar.gz åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ ç„¶åè¿›å…¥ï¼Œ ç¼–è¾‘å®¢æˆ·ç«¯é…ç½®\"frpc.ini\"æ–‡ä»¶ [common] server_addr = å…¬ç½‘IP è…¾è®¯æœåŠ¡å™¨çš„åœ°å€ server_port = 7000 ä¸Šé¢æœåŠ¡ç«¯é…ç½®çš„ç«¯å£ token=1235678 ç›¸å½“äºå¯†ç  [RDP] type = tcp local_ip = 127.0.0.1 æœ¬åœ°å›ç¯åœ°å€ local_port = 8060 å±€åŸŸç½‘å®¢æˆ·ç«¯çš„ç«¯å£ remote_port = 6000 æœåŠ¡ç«¯çš„ç«¯å£ï¼Œç”¨äºç»™è®¿é—®ç«¯ä½¿ç”¨ è¯´æ˜ï¼š å®¢æˆ·ç«¯è¿æ¥è…¾è®¯äº‘çš„åœ°å€ å…¬ç½‘IP ç«¯å£7000 token è®¿é—®ç«¯è¿æ¥è…¾è®¯äº‘çš„å…¬ç½‘IP 6000 ï¼Œä¼šfrpsè½¬åˆ° å®¢æˆ·ç«¯çš„8060ç«¯å£ å…­ å®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯ æ‰§è¡Œ./frpc -c ./frpc.iniå‰å°å¯åŠ¨å‘½ä»¤ è¿æ¥æœåŠ¡ç«¯ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frpc -c ./frpc.ini \u0026Â åå°ä¿æŒå¯åŠ¨ ä¸ƒ MT Photo AI è·‘ aiçš„æœºå™¨ä½¿ç”¨çš„ubuntuç³»ç»Ÿ å®‰è£…docker ä¸‹è½½é•œåƒ sudo docker pull mtphotos/mt-photos-ai è¿è¡Œè„šæœ¬ #API_AUTH_KEYè‡ªè¡Œè®¾ç½® sudo docker run -i -p 8060:8000 -e API_AUTH_KEY=mt_photos_ai_extra_secret --name mt-photos-ai2 mtphotos/mt-photos-ai:latest ä¼šç›‘å¬ 8060ç«¯å£ å¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤æ¥çœ‹çœ‹é€šä¸é€š curl --location --request POST 'http://127.0.0.1:8060/check' \\ --header 'api-key: mt_photos_ai_extra_secret' å…« è·‘é€šæ•´ä¸ªé“¾è·¯ MT Photo è°ƒç”¨ å…¬ç½‘IP:6000 ç«¯å£ api-key FRPS ä¼šå»è°ƒç”¨ å®¢æˆ·ç«¯çš„ 8060ç«¯å£ ä¹ æ˜¯å¦éœ€è¦å¼€æœºå¯åŠ¨ ç›®å‰ä½¿ç”¨çš„åŠŸèƒ½æ˜¯ä¸€ä¸ªä¸å¸¸ç”¨çš„åŠŸèƒ½ï¼ŒFRPSè¿æ¥æ²¡æœ‰è¯†åˆ«æ¥æºæ‰€ä»¥è®¡åˆ’éšç”¨éš‹å¼€ï¼Œä¸è‡ªåŠ¨å¯åŠ¨ã€‚ 9.1 è®¾ç½®äº‘æœåŠ¡å™¨ç«¯å¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frps.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frps daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/etc/frps/frp_0.38.0_linux_amd64/frps -c /etc/frps/frp_0.38.0_linux_amd64/frps.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpsçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frps systemctl daemon-reload systemctl start frps #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ systemctl enable frps 9.2 è®¾ç½®å±€åŸŸç½‘æœºå­frpcå¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frpc.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frpc daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/home/wentao/frps/frp_0.37.0_linux_amd64/frpc -c /home/wentao/frps/frp_0.37.0_linux_amd64/frpc.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpcçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frpc sudo systemctl daemon-reload sudo systemctl start frpc #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ sudo systemctl enable frpc åã€å¤æ‚é…ç½® ä»¥ä¸‹é…ç½®ä¸­å¯†ç å’Œå…¬ç½‘IPéƒ½ä½¿ç”¨XXè¿›è¡Œäº†ä»£æ›¿ï¼Œå¤åˆ¶ä½¿ç”¨æ—¶è¯·æ³¨æ„ä¿®æ”¹ è¿œç¨‹æœåŠ¡ç«¯frps.ini [common] # frpç›‘å¬çš„ç«¯å£ï¼Œé»˜è®¤æ˜¯7000 bind_port = 7000 # æˆæƒç ,è¯·è‡ªå®šä¹‰æ›´æ”¹ token = XXXXX # è¿™ä¸ªtokenä¹‹ååœ¨å®¢æˆ·ç«¯ä¼šç”¨åˆ° # frpç®¡ç†åå°ç«¯å£ï¼Œè¯·æŒ‰è‡ªå·±éœ€æ±‚æ›´æ”¹ dashboard_port = 7500 # frpç®¡ç†åå°ç”¨æˆ·åå’Œå¯†ç ï¼Œè¯·æ”¹æˆè‡ªå·±çš„ dashboard_user = admin dashboard_pwd = XXXXX enable_prometheus = true # frpæ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frps.log log_level = info log_max_days = 7 å®¢æˆ·ç«¯çš„frpc.iniæ–‡ä»¶ [common] # è¿œç¨‹æœåŠ¡å™¨ipï¼Œè¿œç¨‹frpæœåŠ¡ç«¯å£ä»¥åŠè¿œç¨‹ç™»å½•å¯†ç  server_addr = 119.XX.XX.119 server_port = 7000 token = XXXXX # æ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frpc.log log_level = info log_max_days = 7 # å°†æœ¬åœ°æœºçš„22ç«¯å£æ˜ å°„è‡³è¿œç¨‹20022ç«¯å£ ä¸­æ‹¬å·å†…[ssh]åªä½œä¸ºæ ‡è¯†ï¼Œå¯è‡ªå®šä¹‰ [ssh] type = tcp local_ip = 127.0.0.1 local_port = 8060 remote_port = 6000 # å°†æœ¬æœºçš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹25901ç«¯å£ [vnc] type = tcp local_ip = 127.0.0.1 local_port = 8000 remote_port = 6001 # å°†æœ¬æœºæ‰€åœ¨å±€åŸŸç½‘å†…çš„192.168.0.129æœºå­çš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹55901ç«¯å£ [tsj-vnc] type = tcp local_ip = 192.168.0.129 local_port = 5901 remote_port = 55901 # ä»£ç†æœ¬æœºæ‰€åœ¨çš„å†…ç½‘ï¼Œå³è‹¥ç”¨æˆ·è®¾ç½®ä»£ç†ä¸ºå…¬ç½‘IP+ç«¯å£å³å¯è®¿é—®æœ¬æœºæ‰€åœ¨å†…ç½‘ï¼Œä½¿ç”¨çš„æ˜¯socks5ä»£ç†åè®®ï¼Œplugin_useråŠåé¢çš„å¯è®¾ç½®å¯ä¸è®¾ï¼Œä½†ä¸è®¾çš„é£é™©è¾ƒå¤§ [socks5_proxy] type = tcp remote_port = 7890 plugin = socks5 plugin = socks5 plugin_user = name plugin_passwd = password use_encryption = true use_compression = true é‡å¯frpæœåŠ¡ ","date":"2024-11-06","objectID":"/posts/mt-photos/:0:0","tags":["blog","ç½‘ç»œé…ç½®"],"title":"MT-Photos","uri":"/posts/mt-photos/#äºŒ--æœåŠ¡ç«¯å®‰è£…"},{"categories":["ç”Ÿæ´»"],"collections":null,"content":"FPR å†…ç½‘ç©¿é€ éœ€è¦å†…ç½‘çš„æœºå™¨çš„å¼ºå¤§çš„CPU ç»™AIè¯†åˆ«æä¾›åŠ©åŠ› å€Ÿç”¨äº†è…¾è®¯äº‘å†…ç½‘ç©¿é€æ¥è”é€š è…¾è®¯äº‘æœåŠ¡å™¨è¿è¡Œçš„ä¸ºæœåŠ¡ç«¯ï¼Œ å±€åŸŸç½‘å†…æœºå­è¿è¡Œçš„ä¸ºå®¢æˆ·ç«¯ NASæœºå™¨ç§°ä¸ºè®¿é—®ç«¯ ä¸€ ä¸‹è½½ frpåŒ… æŒ‰æ¨èlinuxä¸‹è½½äº† 0.37æˆ–è€…0.38 è¯•éªŒä¸‹æ¥ä½¿ç”¨ç¨³å®š wget https://github.com/fatedier/frp/releases/download/v0.38.0/frp_0.38.0_linux_amd64.tar.gz äºŒ æœåŠ¡ç«¯å®‰è£… æ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ æ‰§è¡ŒÂ cd frp_0.38.0_linux_amd64/è¿›å…¥æ–‡ä»¶å¤¹ ä¿®æ”¹é…ç½®æ–‡ä»¶#ä¸‰ æœåŠ¡ç«¯é…ç½® sudo chmod 755 ./frps èµ‹äºˆ å¯åŠ¨è¿è¡Œ åœ¨å®‰è£…å¥½çš„ç›®å½•å†… æ‰§è¡Œ./frps -c ./frps.iniå‰å°å¯åŠ¨å‘½ä»¤ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frps -c ./frps.ini \u0026Â åå°ä¿æŒå¯åŠ¨ _åæœŸè¿˜å¯ä»¥è®¾ç½®è‡ªåŠ¨è¿è¡Œ #TODOï¼š ä¸‰ æœåŠ¡ç«¯é…ç½® [common] bind_addr=0.0.0.0 bind_port = 7000 token=12345678 dashboard_port = 7500 dashboard_user = admin dashboard_pwd = admin123 é…ç½®è¯´æ˜ï¼š â€œbind_addr\"æ˜¯æœåŠ¡å™¨æœ¬åœ°IPï¼Œä¸æ”¹ã€‚ â€œbind_port\"æ˜¯frpç›‘å¬ç«¯å£ã€‚ â€œtoken\"æ˜¯éªŒè¯tokenå»ºè®®è®¾ç½®ä¸Šã€‚ â€œdashboard_port\"æ˜¯frpé¢æ¿ç«¯å£ã€‚ â€œdashboard_user\"â€œdashboard_pwd\"æ˜¯é¢æ¿çš„è´¦æˆ·å¯†ç ã€‚ token å»ºè®®å¤æ‚ä¸€äº›ï¼Œå±è”½ä¸€äº›æ‰«æè®¿é—® å›› è®¿é—®frpæ§åˆ¶é¢æ¿ é¢æ¿ä»…ä¾›å‚è€ƒï¼Œå¯ç”¨å¯ä¸ç”¨ã€‚è®¿é—®Â http://æœåŠ¡å™¨ip:7500 ä¸Šé¢é…ç½®çš„7500ç«¯å£ï¼Œä½¿ç”¨ä¸Šé¢é…ç½®çš„ç”¨æˆ·åå’Œå¯†ç  admin/admin123 äº” å®¢æˆ·ç«¯é…ç½®ä¿®æ”¹ å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¸‹è½½åŒæ ·çš„æ–‡ä»¶ frp_0.38.0_linux_amd64.tar.gz åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ ç„¶åè¿›å…¥ï¼Œ ç¼–è¾‘å®¢æˆ·ç«¯é…ç½®\"frpc.ini\"æ–‡ä»¶ [common] server_addr = å…¬ç½‘IP è…¾è®¯æœåŠ¡å™¨çš„åœ°å€ server_port = 7000 ä¸Šé¢æœåŠ¡ç«¯é…ç½®çš„ç«¯å£ token=1235678 ç›¸å½“äºå¯†ç  [RDP] type = tcp local_ip = 127.0.0.1 æœ¬åœ°å›ç¯åœ°å€ local_port = 8060 å±€åŸŸç½‘å®¢æˆ·ç«¯çš„ç«¯å£ remote_port = 6000 æœåŠ¡ç«¯çš„ç«¯å£ï¼Œç”¨äºç»™è®¿é—®ç«¯ä½¿ç”¨ è¯´æ˜ï¼š å®¢æˆ·ç«¯è¿æ¥è…¾è®¯äº‘çš„åœ°å€ å…¬ç½‘IP ç«¯å£7000 token è®¿é—®ç«¯è¿æ¥è…¾è®¯äº‘çš„å…¬ç½‘IP 6000 ï¼Œä¼šfrpsè½¬åˆ° å®¢æˆ·ç«¯çš„8060ç«¯å£ å…­ å®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯ æ‰§è¡Œ./frpc -c ./frpc.iniå‰å°å¯åŠ¨å‘½ä»¤ è¿æ¥æœåŠ¡ç«¯ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frpc -c ./frpc.ini \u0026Â åå°ä¿æŒå¯åŠ¨ ä¸ƒ MT Photo AI è·‘ aiçš„æœºå™¨ä½¿ç”¨çš„ubuntuç³»ç»Ÿ å®‰è£…docker ä¸‹è½½é•œåƒ sudo docker pull mtphotos/mt-photos-ai è¿è¡Œè„šæœ¬ #API_AUTH_KEYè‡ªè¡Œè®¾ç½® sudo docker run -i -p 8060:8000 -e API_AUTH_KEY=mt_photos_ai_extra_secret --name mt-photos-ai2 mtphotos/mt-photos-ai:latest ä¼šç›‘å¬ 8060ç«¯å£ å¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤æ¥çœ‹çœ‹é€šä¸é€š curl --location --request POST 'http://127.0.0.1:8060/check' \\ --header 'api-key: mt_photos_ai_extra_secret' å…« è·‘é€šæ•´ä¸ªé“¾è·¯ MT Photo è°ƒç”¨ å…¬ç½‘IP:6000 ç«¯å£ api-key FRPS ä¼šå»è°ƒç”¨ å®¢æˆ·ç«¯çš„ 8060ç«¯å£ ä¹ æ˜¯å¦éœ€è¦å¼€æœºå¯åŠ¨ ç›®å‰ä½¿ç”¨çš„åŠŸèƒ½æ˜¯ä¸€ä¸ªä¸å¸¸ç”¨çš„åŠŸèƒ½ï¼ŒFRPSè¿æ¥æ²¡æœ‰è¯†åˆ«æ¥æºæ‰€ä»¥è®¡åˆ’éšç”¨éš‹å¼€ï¼Œä¸è‡ªåŠ¨å¯åŠ¨ã€‚ 9.1 è®¾ç½®äº‘æœåŠ¡å™¨ç«¯å¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frps.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frps daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/etc/frps/frp_0.38.0_linux_amd64/frps -c /etc/frps/frp_0.38.0_linux_amd64/frps.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpsçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frps systemctl daemon-reload systemctl start frps #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ systemctl enable frps 9.2 è®¾ç½®å±€åŸŸç½‘æœºå­frpcå¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frpc.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frpc daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/home/wentao/frps/frp_0.37.0_linux_amd64/frpc -c /home/wentao/frps/frp_0.37.0_linux_amd64/frpc.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpcçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frpc sudo systemctl daemon-reload sudo systemctl start frpc #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ sudo systemctl enable frpc åã€å¤æ‚é…ç½® ä»¥ä¸‹é…ç½®ä¸­å¯†ç å’Œå…¬ç½‘IPéƒ½ä½¿ç”¨XXè¿›è¡Œäº†ä»£æ›¿ï¼Œå¤åˆ¶ä½¿ç”¨æ—¶è¯·æ³¨æ„ä¿®æ”¹ è¿œç¨‹æœåŠ¡ç«¯frps.ini [common] # frpç›‘å¬çš„ç«¯å£ï¼Œé»˜è®¤æ˜¯7000 bind_port = 7000 # æˆæƒç ,è¯·è‡ªå®šä¹‰æ›´æ”¹ token = XXXXX # è¿™ä¸ªtokenä¹‹ååœ¨å®¢æˆ·ç«¯ä¼šç”¨åˆ° # frpç®¡ç†åå°ç«¯å£ï¼Œè¯·æŒ‰è‡ªå·±éœ€æ±‚æ›´æ”¹ dashboard_port = 7500 # frpç®¡ç†åå°ç”¨æˆ·åå’Œå¯†ç ï¼Œè¯·æ”¹æˆè‡ªå·±çš„ dashboard_user = admin dashboard_pwd = XXXXX enable_prometheus = true # frpæ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frps.log log_level = info log_max_days = 7 å®¢æˆ·ç«¯çš„frpc.iniæ–‡ä»¶ [common] # è¿œç¨‹æœåŠ¡å™¨ipï¼Œè¿œç¨‹frpæœåŠ¡ç«¯å£ä»¥åŠè¿œç¨‹ç™»å½•å¯†ç  server_addr = 119.XX.XX.119 server_port = 7000 token = XXXXX # æ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frpc.log log_level = info log_max_days = 7 # å°†æœ¬åœ°æœºçš„22ç«¯å£æ˜ å°„è‡³è¿œç¨‹20022ç«¯å£ ä¸­æ‹¬å·å†…[ssh]åªä½œä¸ºæ ‡è¯†ï¼Œå¯è‡ªå®šä¹‰ [ssh] type = tcp local_ip = 127.0.0.1 local_port = 8060 remote_port = 6000 # å°†æœ¬æœºçš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹25901ç«¯å£ [vnc] type = tcp local_ip = 127.0.0.1 local_port = 8000 remote_port = 6001 # å°†æœ¬æœºæ‰€åœ¨å±€åŸŸç½‘å†…çš„192.168.0.129æœºå­çš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹55901ç«¯å£ [tsj-vnc] type = tcp local_ip = 192.168.0.129 local_port = 5901 remote_port = 55901 # ä»£ç†æœ¬æœºæ‰€åœ¨çš„å†…ç½‘ï¼Œå³è‹¥ç”¨æˆ·è®¾ç½®ä»£ç†ä¸ºå…¬ç½‘IP+ç«¯å£å³å¯è®¿é—®æœ¬æœºæ‰€åœ¨å†…ç½‘ï¼Œä½¿ç”¨çš„æ˜¯socks5ä»£ç†åè®®ï¼Œplugin_useråŠåé¢çš„å¯è®¾ç½®å¯ä¸è®¾ï¼Œä½†ä¸è®¾çš„é£é™©è¾ƒå¤§ [socks5_proxy] type = tcp remote_port = 7890 plugin = socks5 plugin = socks5 plugin_user = name plugin_passwd = password use_encryption = true use_compression = true é‡å¯frpæœåŠ¡ ","date":"2024-11-06","objectID":"/posts/mt-photos/:0:0","tags":["blog","ç½‘ç»œé…ç½®"],"title":"MT-Photos","uri":"/posts/mt-photos/#ä¸‰-æœåŠ¡ç«¯é…ç½®"},{"categories":["ç”Ÿæ´»"],"collections":null,"content":"FPR å†…ç½‘ç©¿é€ éœ€è¦å†…ç½‘çš„æœºå™¨çš„å¼ºå¤§çš„CPU ç»™AIè¯†åˆ«æä¾›åŠ©åŠ› å€Ÿç”¨äº†è…¾è®¯äº‘å†…ç½‘ç©¿é€æ¥è”é€š è…¾è®¯äº‘æœåŠ¡å™¨è¿è¡Œçš„ä¸ºæœåŠ¡ç«¯ï¼Œ å±€åŸŸç½‘å†…æœºå­è¿è¡Œçš„ä¸ºå®¢æˆ·ç«¯ NASæœºå™¨ç§°ä¸ºè®¿é—®ç«¯ ä¸€ ä¸‹è½½ frpåŒ… æŒ‰æ¨èlinuxä¸‹è½½äº† 0.37æˆ–è€…0.38 è¯•éªŒä¸‹æ¥ä½¿ç”¨ç¨³å®š wget https://github.com/fatedier/frp/releases/download/v0.38.0/frp_0.38.0_linux_amd64.tar.gz äºŒ æœåŠ¡ç«¯å®‰è£… æ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ æ‰§è¡ŒÂ cd frp_0.38.0_linux_amd64/è¿›å…¥æ–‡ä»¶å¤¹ ä¿®æ”¹é…ç½®æ–‡ä»¶#ä¸‰ æœåŠ¡ç«¯é…ç½® sudo chmod 755 ./frps èµ‹äºˆ å¯åŠ¨è¿è¡Œ åœ¨å®‰è£…å¥½çš„ç›®å½•å†… æ‰§è¡Œ./frps -c ./frps.iniå‰å°å¯åŠ¨å‘½ä»¤ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frps -c ./frps.ini \u0026Â åå°ä¿æŒå¯åŠ¨ _åæœŸè¿˜å¯ä»¥è®¾ç½®è‡ªåŠ¨è¿è¡Œ #TODOï¼š ä¸‰ æœåŠ¡ç«¯é…ç½® [common] bind_addr=0.0.0.0 bind_port = 7000 token=12345678 dashboard_port = 7500 dashboard_user = admin dashboard_pwd = admin123 é…ç½®è¯´æ˜ï¼š â€œbind_addr\"æ˜¯æœåŠ¡å™¨æœ¬åœ°IPï¼Œä¸æ”¹ã€‚ â€œbind_port\"æ˜¯frpç›‘å¬ç«¯å£ã€‚ â€œtoken\"æ˜¯éªŒè¯tokenå»ºè®®è®¾ç½®ä¸Šã€‚ â€œdashboard_port\"æ˜¯frpé¢æ¿ç«¯å£ã€‚ â€œdashboard_user\"â€œdashboard_pwd\"æ˜¯é¢æ¿çš„è´¦æˆ·å¯†ç ã€‚ token å»ºè®®å¤æ‚ä¸€äº›ï¼Œå±è”½ä¸€äº›æ‰«æè®¿é—® å›› è®¿é—®frpæ§åˆ¶é¢æ¿ é¢æ¿ä»…ä¾›å‚è€ƒï¼Œå¯ç”¨å¯ä¸ç”¨ã€‚è®¿é—®Â http://æœåŠ¡å™¨ip:7500 ä¸Šé¢é…ç½®çš„7500ç«¯å£ï¼Œä½¿ç”¨ä¸Šé¢é…ç½®çš„ç”¨æˆ·åå’Œå¯†ç  admin/admin123 äº” å®¢æˆ·ç«¯é…ç½®ä¿®æ”¹ å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¸‹è½½åŒæ ·çš„æ–‡ä»¶ frp_0.38.0_linux_amd64.tar.gz åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ ç„¶åè¿›å…¥ï¼Œ ç¼–è¾‘å®¢æˆ·ç«¯é…ç½®\"frpc.ini\"æ–‡ä»¶ [common] server_addr = å…¬ç½‘IP è…¾è®¯æœåŠ¡å™¨çš„åœ°å€ server_port = 7000 ä¸Šé¢æœåŠ¡ç«¯é…ç½®çš„ç«¯å£ token=1235678 ç›¸å½“äºå¯†ç  [RDP] type = tcp local_ip = 127.0.0.1 æœ¬åœ°å›ç¯åœ°å€ local_port = 8060 å±€åŸŸç½‘å®¢æˆ·ç«¯çš„ç«¯å£ remote_port = 6000 æœåŠ¡ç«¯çš„ç«¯å£ï¼Œç”¨äºç»™è®¿é—®ç«¯ä½¿ç”¨ è¯´æ˜ï¼š å®¢æˆ·ç«¯è¿æ¥è…¾è®¯äº‘çš„åœ°å€ å…¬ç½‘IP ç«¯å£7000 token è®¿é—®ç«¯è¿æ¥è…¾è®¯äº‘çš„å…¬ç½‘IP 6000 ï¼Œä¼šfrpsè½¬åˆ° å®¢æˆ·ç«¯çš„8060ç«¯å£ å…­ å®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯ æ‰§è¡Œ./frpc -c ./frpc.iniå‰å°å¯åŠ¨å‘½ä»¤ è¿æ¥æœåŠ¡ç«¯ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frpc -c ./frpc.ini \u0026Â åå°ä¿æŒå¯åŠ¨ ä¸ƒ MT Photo AI è·‘ aiçš„æœºå™¨ä½¿ç”¨çš„ubuntuç³»ç»Ÿ å®‰è£…docker ä¸‹è½½é•œåƒ sudo docker pull mtphotos/mt-photos-ai è¿è¡Œè„šæœ¬ #API_AUTH_KEYè‡ªè¡Œè®¾ç½® sudo docker run -i -p 8060:8000 -e API_AUTH_KEY=mt_photos_ai_extra_secret --name mt-photos-ai2 mtphotos/mt-photos-ai:latest ä¼šç›‘å¬ 8060ç«¯å£ å¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤æ¥çœ‹çœ‹é€šä¸é€š curl --location --request POST 'http://127.0.0.1:8060/check' \\ --header 'api-key: mt_photos_ai_extra_secret' å…« è·‘é€šæ•´ä¸ªé“¾è·¯ MT Photo è°ƒç”¨ å…¬ç½‘IP:6000 ç«¯å£ api-key FRPS ä¼šå»è°ƒç”¨ å®¢æˆ·ç«¯çš„ 8060ç«¯å£ ä¹ æ˜¯å¦éœ€è¦å¼€æœºå¯åŠ¨ ç›®å‰ä½¿ç”¨çš„åŠŸèƒ½æ˜¯ä¸€ä¸ªä¸å¸¸ç”¨çš„åŠŸèƒ½ï¼ŒFRPSè¿æ¥æ²¡æœ‰è¯†åˆ«æ¥æºæ‰€ä»¥è®¡åˆ’éšç”¨éš‹å¼€ï¼Œä¸è‡ªåŠ¨å¯åŠ¨ã€‚ 9.1 è®¾ç½®äº‘æœåŠ¡å™¨ç«¯å¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frps.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frps daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/etc/frps/frp_0.38.0_linux_amd64/frps -c /etc/frps/frp_0.38.0_linux_amd64/frps.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpsçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frps systemctl daemon-reload systemctl start frps #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ systemctl enable frps 9.2 è®¾ç½®å±€åŸŸç½‘æœºå­frpcå¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frpc.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frpc daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/home/wentao/frps/frp_0.37.0_linux_amd64/frpc -c /home/wentao/frps/frp_0.37.0_linux_amd64/frpc.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpcçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frpc sudo systemctl daemon-reload sudo systemctl start frpc #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ sudo systemctl enable frpc åã€å¤æ‚é…ç½® ä»¥ä¸‹é…ç½®ä¸­å¯†ç å’Œå…¬ç½‘IPéƒ½ä½¿ç”¨XXè¿›è¡Œäº†ä»£æ›¿ï¼Œå¤åˆ¶ä½¿ç”¨æ—¶è¯·æ³¨æ„ä¿®æ”¹ è¿œç¨‹æœåŠ¡ç«¯frps.ini [common] # frpç›‘å¬çš„ç«¯å£ï¼Œé»˜è®¤æ˜¯7000 bind_port = 7000 # æˆæƒç ,è¯·è‡ªå®šä¹‰æ›´æ”¹ token = XXXXX # è¿™ä¸ªtokenä¹‹ååœ¨å®¢æˆ·ç«¯ä¼šç”¨åˆ° # frpç®¡ç†åå°ç«¯å£ï¼Œè¯·æŒ‰è‡ªå·±éœ€æ±‚æ›´æ”¹ dashboard_port = 7500 # frpç®¡ç†åå°ç”¨æˆ·åå’Œå¯†ç ï¼Œè¯·æ”¹æˆè‡ªå·±çš„ dashboard_user = admin dashboard_pwd = XXXXX enable_prometheus = true # frpæ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frps.log log_level = info log_max_days = 7 å®¢æˆ·ç«¯çš„frpc.iniæ–‡ä»¶ [common] # è¿œç¨‹æœåŠ¡å™¨ipï¼Œè¿œç¨‹frpæœåŠ¡ç«¯å£ä»¥åŠè¿œç¨‹ç™»å½•å¯†ç  server_addr = 119.XX.XX.119 server_port = 7000 token = XXXXX # æ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frpc.log log_level = info log_max_days = 7 # å°†æœ¬åœ°æœºçš„22ç«¯å£æ˜ å°„è‡³è¿œç¨‹20022ç«¯å£ ä¸­æ‹¬å·å†…[ssh]åªä½œä¸ºæ ‡è¯†ï¼Œå¯è‡ªå®šä¹‰ [ssh] type = tcp local_ip = 127.0.0.1 local_port = 8060 remote_port = 6000 # å°†æœ¬æœºçš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹25901ç«¯å£ [vnc] type = tcp local_ip = 127.0.0.1 local_port = 8000 remote_port = 6001 # å°†æœ¬æœºæ‰€åœ¨å±€åŸŸç½‘å†…çš„192.168.0.129æœºå­çš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹55901ç«¯å£ [tsj-vnc] type = tcp local_ip = 192.168.0.129 local_port = 5901 remote_port = 55901 # ä»£ç†æœ¬æœºæ‰€åœ¨çš„å†…ç½‘ï¼Œå³è‹¥ç”¨æˆ·è®¾ç½®ä»£ç†ä¸ºå…¬ç½‘IP+ç«¯å£å³å¯è®¿é—®æœ¬æœºæ‰€åœ¨å†…ç½‘ï¼Œä½¿ç”¨çš„æ˜¯socks5ä»£ç†åè®®ï¼Œplugin_useråŠåé¢çš„å¯è®¾ç½®å¯ä¸è®¾ï¼Œä½†ä¸è®¾çš„é£é™©è¾ƒå¤§ [socks5_proxy] type = tcp remote_port = 7890 plugin = socks5 plugin = socks5 plugin_user = name plugin_passwd = password use_encryption = true use_compression = true é‡å¯frpæœåŠ¡ ","date":"2024-11-06","objectID":"/posts/mt-photos/:0:0","tags":["blog","ç½‘ç»œé…ç½®"],"title":"MT-Photos","uri":"/posts/mt-photos/#å››-è®¿é—®frpæ§åˆ¶é¢æ¿"},{"categories":["ç”Ÿæ´»"],"collections":null,"content":"FPR å†…ç½‘ç©¿é€ éœ€è¦å†…ç½‘çš„æœºå™¨çš„å¼ºå¤§çš„CPU ç»™AIè¯†åˆ«æä¾›åŠ©åŠ› å€Ÿç”¨äº†è…¾è®¯äº‘å†…ç½‘ç©¿é€æ¥è”é€š è…¾è®¯äº‘æœåŠ¡å™¨è¿è¡Œçš„ä¸ºæœåŠ¡ç«¯ï¼Œ å±€åŸŸç½‘å†…æœºå­è¿è¡Œçš„ä¸ºå®¢æˆ·ç«¯ NASæœºå™¨ç§°ä¸ºè®¿é—®ç«¯ ä¸€ ä¸‹è½½ frpåŒ… æŒ‰æ¨èlinuxä¸‹è½½äº† 0.37æˆ–è€…0.38 è¯•éªŒä¸‹æ¥ä½¿ç”¨ç¨³å®š wget https://github.com/fatedier/frp/releases/download/v0.38.0/frp_0.38.0_linux_amd64.tar.gz äºŒ æœåŠ¡ç«¯å®‰è£… æ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ æ‰§è¡ŒÂ cd frp_0.38.0_linux_amd64/è¿›å…¥æ–‡ä»¶å¤¹ ä¿®æ”¹é…ç½®æ–‡ä»¶#ä¸‰ æœåŠ¡ç«¯é…ç½® sudo chmod 755 ./frps èµ‹äºˆ å¯åŠ¨è¿è¡Œ åœ¨å®‰è£…å¥½çš„ç›®å½•å†… æ‰§è¡Œ./frps -c ./frps.iniå‰å°å¯åŠ¨å‘½ä»¤ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frps -c ./frps.ini \u0026Â åå°ä¿æŒå¯åŠ¨ _åæœŸè¿˜å¯ä»¥è®¾ç½®è‡ªåŠ¨è¿è¡Œ #TODOï¼š ä¸‰ æœåŠ¡ç«¯é…ç½® [common] bind_addr=0.0.0.0 bind_port = 7000 token=12345678 dashboard_port = 7500 dashboard_user = admin dashboard_pwd = admin123 é…ç½®è¯´æ˜ï¼š â€œbind_addr\"æ˜¯æœåŠ¡å™¨æœ¬åœ°IPï¼Œä¸æ”¹ã€‚ â€œbind_port\"æ˜¯frpç›‘å¬ç«¯å£ã€‚ â€œtoken\"æ˜¯éªŒè¯tokenå»ºè®®è®¾ç½®ä¸Šã€‚ â€œdashboard_port\"æ˜¯frpé¢æ¿ç«¯å£ã€‚ â€œdashboard_user\"â€œdashboard_pwd\"æ˜¯é¢æ¿çš„è´¦æˆ·å¯†ç ã€‚ token å»ºè®®å¤æ‚ä¸€äº›ï¼Œå±è”½ä¸€äº›æ‰«æè®¿é—® å›› è®¿é—®frpæ§åˆ¶é¢æ¿ é¢æ¿ä»…ä¾›å‚è€ƒï¼Œå¯ç”¨å¯ä¸ç”¨ã€‚è®¿é—®Â http://æœåŠ¡å™¨ip:7500 ä¸Šé¢é…ç½®çš„7500ç«¯å£ï¼Œä½¿ç”¨ä¸Šé¢é…ç½®çš„ç”¨æˆ·åå’Œå¯†ç  admin/admin123 äº” å®¢æˆ·ç«¯é…ç½®ä¿®æ”¹ å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¸‹è½½åŒæ ·çš„æ–‡ä»¶ frp_0.38.0_linux_amd64.tar.gz åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ ç„¶åè¿›å…¥ï¼Œ ç¼–è¾‘å®¢æˆ·ç«¯é…ç½®\"frpc.ini\"æ–‡ä»¶ [common] server_addr = å…¬ç½‘IP è…¾è®¯æœåŠ¡å™¨çš„åœ°å€ server_port = 7000 ä¸Šé¢æœåŠ¡ç«¯é…ç½®çš„ç«¯å£ token=1235678 ç›¸å½“äºå¯†ç  [RDP] type = tcp local_ip = 127.0.0.1 æœ¬åœ°å›ç¯åœ°å€ local_port = 8060 å±€åŸŸç½‘å®¢æˆ·ç«¯çš„ç«¯å£ remote_port = 6000 æœåŠ¡ç«¯çš„ç«¯å£ï¼Œç”¨äºç»™è®¿é—®ç«¯ä½¿ç”¨ è¯´æ˜ï¼š å®¢æˆ·ç«¯è¿æ¥è…¾è®¯äº‘çš„åœ°å€ å…¬ç½‘IP ç«¯å£7000 token è®¿é—®ç«¯è¿æ¥è…¾è®¯äº‘çš„å…¬ç½‘IP 6000 ï¼Œä¼šfrpsè½¬åˆ° å®¢æˆ·ç«¯çš„8060ç«¯å£ å…­ å®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯ æ‰§è¡Œ./frpc -c ./frpc.iniå‰å°å¯åŠ¨å‘½ä»¤ è¿æ¥æœåŠ¡ç«¯ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frpc -c ./frpc.ini \u0026Â åå°ä¿æŒå¯åŠ¨ ä¸ƒ MT Photo AI è·‘ aiçš„æœºå™¨ä½¿ç”¨çš„ubuntuç³»ç»Ÿ å®‰è£…docker ä¸‹è½½é•œåƒ sudo docker pull mtphotos/mt-photos-ai è¿è¡Œè„šæœ¬ #API_AUTH_KEYè‡ªè¡Œè®¾ç½® sudo docker run -i -p 8060:8000 -e API_AUTH_KEY=mt_photos_ai_extra_secret --name mt-photos-ai2 mtphotos/mt-photos-ai:latest ä¼šç›‘å¬ 8060ç«¯å£ å¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤æ¥çœ‹çœ‹é€šä¸é€š curl --location --request POST 'http://127.0.0.1:8060/check' \\ --header 'api-key: mt_photos_ai_extra_secret' å…« è·‘é€šæ•´ä¸ªé“¾è·¯ MT Photo è°ƒç”¨ å…¬ç½‘IP:6000 ç«¯å£ api-key FRPS ä¼šå»è°ƒç”¨ å®¢æˆ·ç«¯çš„ 8060ç«¯å£ ä¹ æ˜¯å¦éœ€è¦å¼€æœºå¯åŠ¨ ç›®å‰ä½¿ç”¨çš„åŠŸèƒ½æ˜¯ä¸€ä¸ªä¸å¸¸ç”¨çš„åŠŸèƒ½ï¼ŒFRPSè¿æ¥æ²¡æœ‰è¯†åˆ«æ¥æºæ‰€ä»¥è®¡åˆ’éšç”¨éš‹å¼€ï¼Œä¸è‡ªåŠ¨å¯åŠ¨ã€‚ 9.1 è®¾ç½®äº‘æœåŠ¡å™¨ç«¯å¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frps.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frps daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/etc/frps/frp_0.38.0_linux_amd64/frps -c /etc/frps/frp_0.38.0_linux_amd64/frps.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpsçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frps systemctl daemon-reload systemctl start frps #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ systemctl enable frps 9.2 è®¾ç½®å±€åŸŸç½‘æœºå­frpcå¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frpc.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frpc daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/home/wentao/frps/frp_0.37.0_linux_amd64/frpc -c /home/wentao/frps/frp_0.37.0_linux_amd64/frpc.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpcçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frpc sudo systemctl daemon-reload sudo systemctl start frpc #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ sudo systemctl enable frpc åã€å¤æ‚é…ç½® ä»¥ä¸‹é…ç½®ä¸­å¯†ç å’Œå…¬ç½‘IPéƒ½ä½¿ç”¨XXè¿›è¡Œäº†ä»£æ›¿ï¼Œå¤åˆ¶ä½¿ç”¨æ—¶è¯·æ³¨æ„ä¿®æ”¹ è¿œç¨‹æœåŠ¡ç«¯frps.ini [common] # frpç›‘å¬çš„ç«¯å£ï¼Œé»˜è®¤æ˜¯7000 bind_port = 7000 # æˆæƒç ,è¯·è‡ªå®šä¹‰æ›´æ”¹ token = XXXXX # è¿™ä¸ªtokenä¹‹ååœ¨å®¢æˆ·ç«¯ä¼šç”¨åˆ° # frpç®¡ç†åå°ç«¯å£ï¼Œè¯·æŒ‰è‡ªå·±éœ€æ±‚æ›´æ”¹ dashboard_port = 7500 # frpç®¡ç†åå°ç”¨æˆ·åå’Œå¯†ç ï¼Œè¯·æ”¹æˆè‡ªå·±çš„ dashboard_user = admin dashboard_pwd = XXXXX enable_prometheus = true # frpæ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frps.log log_level = info log_max_days = 7 å®¢æˆ·ç«¯çš„frpc.iniæ–‡ä»¶ [common] # è¿œç¨‹æœåŠ¡å™¨ipï¼Œè¿œç¨‹frpæœåŠ¡ç«¯å£ä»¥åŠè¿œç¨‹ç™»å½•å¯†ç  server_addr = 119.XX.XX.119 server_port = 7000 token = XXXXX # æ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frpc.log log_level = info log_max_days = 7 # å°†æœ¬åœ°æœºçš„22ç«¯å£æ˜ å°„è‡³è¿œç¨‹20022ç«¯å£ ä¸­æ‹¬å·å†…[ssh]åªä½œä¸ºæ ‡è¯†ï¼Œå¯è‡ªå®šä¹‰ [ssh] type = tcp local_ip = 127.0.0.1 local_port = 8060 remote_port = 6000 # å°†æœ¬æœºçš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹25901ç«¯å£ [vnc] type = tcp local_ip = 127.0.0.1 local_port = 8000 remote_port = 6001 # å°†æœ¬æœºæ‰€åœ¨å±€åŸŸç½‘å†…çš„192.168.0.129æœºå­çš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹55901ç«¯å£ [tsj-vnc] type = tcp local_ip = 192.168.0.129 local_port = 5901 remote_port = 55901 # ä»£ç†æœ¬æœºæ‰€åœ¨çš„å†…ç½‘ï¼Œå³è‹¥ç”¨æˆ·è®¾ç½®ä»£ç†ä¸ºå…¬ç½‘IP+ç«¯å£å³å¯è®¿é—®æœ¬æœºæ‰€åœ¨å†…ç½‘ï¼Œä½¿ç”¨çš„æ˜¯socks5ä»£ç†åè®®ï¼Œplugin_useråŠåé¢çš„å¯è®¾ç½®å¯ä¸è®¾ï¼Œä½†ä¸è®¾çš„é£é™©è¾ƒå¤§ [socks5_proxy] type = tcp remote_port = 7890 plugin = socks5 plugin = socks5 plugin_user = name plugin_passwd = password use_encryption = true use_compression = true é‡å¯frpæœåŠ¡ ","date":"2024-11-06","objectID":"/posts/mt-photos/:0:0","tags":["blog","ç½‘ç»œé…ç½®"],"title":"MT-Photos","uri":"/posts/mt-photos/#äº”-å®¢æˆ·ç«¯é…ç½®ä¿®æ”¹"},{"categories":["ç”Ÿæ´»"],"collections":null,"content":"FPR å†…ç½‘ç©¿é€ éœ€è¦å†…ç½‘çš„æœºå™¨çš„å¼ºå¤§çš„CPU ç»™AIè¯†åˆ«æä¾›åŠ©åŠ› å€Ÿç”¨äº†è…¾è®¯äº‘å†…ç½‘ç©¿é€æ¥è”é€š è…¾è®¯äº‘æœåŠ¡å™¨è¿è¡Œçš„ä¸ºæœåŠ¡ç«¯ï¼Œ å±€åŸŸç½‘å†…æœºå­è¿è¡Œçš„ä¸ºå®¢æˆ·ç«¯ NASæœºå™¨ç§°ä¸ºè®¿é—®ç«¯ ä¸€ ä¸‹è½½ frpåŒ… æŒ‰æ¨èlinuxä¸‹è½½äº† 0.37æˆ–è€…0.38 è¯•éªŒä¸‹æ¥ä½¿ç”¨ç¨³å®š wget https://github.com/fatedier/frp/releases/download/v0.38.0/frp_0.38.0_linux_amd64.tar.gz äºŒ æœåŠ¡ç«¯å®‰è£… æ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ æ‰§è¡ŒÂ cd frp_0.38.0_linux_amd64/è¿›å…¥æ–‡ä»¶å¤¹ ä¿®æ”¹é…ç½®æ–‡ä»¶#ä¸‰ æœåŠ¡ç«¯é…ç½® sudo chmod 755 ./frps èµ‹äºˆ å¯åŠ¨è¿è¡Œ åœ¨å®‰è£…å¥½çš„ç›®å½•å†… æ‰§è¡Œ./frps -c ./frps.iniå‰å°å¯åŠ¨å‘½ä»¤ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frps -c ./frps.ini \u0026Â åå°ä¿æŒå¯åŠ¨ _åæœŸè¿˜å¯ä»¥è®¾ç½®è‡ªåŠ¨è¿è¡Œ #TODOï¼š ä¸‰ æœåŠ¡ç«¯é…ç½® [common] bind_addr=0.0.0.0 bind_port = 7000 token=12345678 dashboard_port = 7500 dashboard_user = admin dashboard_pwd = admin123 é…ç½®è¯´æ˜ï¼š â€œbind_addr\"æ˜¯æœåŠ¡å™¨æœ¬åœ°IPï¼Œä¸æ”¹ã€‚ â€œbind_port\"æ˜¯frpç›‘å¬ç«¯å£ã€‚ â€œtoken\"æ˜¯éªŒè¯tokenå»ºè®®è®¾ç½®ä¸Šã€‚ â€œdashboard_port\"æ˜¯frpé¢æ¿ç«¯å£ã€‚ â€œdashboard_user\"â€œdashboard_pwd\"æ˜¯é¢æ¿çš„è´¦æˆ·å¯†ç ã€‚ token å»ºè®®å¤æ‚ä¸€äº›ï¼Œå±è”½ä¸€äº›æ‰«æè®¿é—® å›› è®¿é—®frpæ§åˆ¶é¢æ¿ é¢æ¿ä»…ä¾›å‚è€ƒï¼Œå¯ç”¨å¯ä¸ç”¨ã€‚è®¿é—®Â http://æœåŠ¡å™¨ip:7500 ä¸Šé¢é…ç½®çš„7500ç«¯å£ï¼Œä½¿ç”¨ä¸Šé¢é…ç½®çš„ç”¨æˆ·åå’Œå¯†ç  admin/admin123 äº” å®¢æˆ·ç«¯é…ç½®ä¿®æ”¹ å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¸‹è½½åŒæ ·çš„æ–‡ä»¶ frp_0.38.0_linux_amd64.tar.gz åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ ç„¶åè¿›å…¥ï¼Œ ç¼–è¾‘å®¢æˆ·ç«¯é…ç½®\"frpc.ini\"æ–‡ä»¶ [common] server_addr = å…¬ç½‘IP è…¾è®¯æœåŠ¡å™¨çš„åœ°å€ server_port = 7000 ä¸Šé¢æœåŠ¡ç«¯é…ç½®çš„ç«¯å£ token=1235678 ç›¸å½“äºå¯†ç  [RDP] type = tcp local_ip = 127.0.0.1 æœ¬åœ°å›ç¯åœ°å€ local_port = 8060 å±€åŸŸç½‘å®¢æˆ·ç«¯çš„ç«¯å£ remote_port = 6000 æœåŠ¡ç«¯çš„ç«¯å£ï¼Œç”¨äºç»™è®¿é—®ç«¯ä½¿ç”¨ è¯´æ˜ï¼š å®¢æˆ·ç«¯è¿æ¥è…¾è®¯äº‘çš„åœ°å€ å…¬ç½‘IP ç«¯å£7000 token è®¿é—®ç«¯è¿æ¥è…¾è®¯äº‘çš„å…¬ç½‘IP 6000 ï¼Œä¼šfrpsè½¬åˆ° å®¢æˆ·ç«¯çš„8060ç«¯å£ å…­ å®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯ æ‰§è¡Œ./frpc -c ./frpc.iniå‰å°å¯åŠ¨å‘½ä»¤ è¿æ¥æœåŠ¡ç«¯ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frpc -c ./frpc.ini \u0026Â åå°ä¿æŒå¯åŠ¨ ä¸ƒ MT Photo AI è·‘ aiçš„æœºå™¨ä½¿ç”¨çš„ubuntuç³»ç»Ÿ å®‰è£…docker ä¸‹è½½é•œåƒ sudo docker pull mtphotos/mt-photos-ai è¿è¡Œè„šæœ¬ #API_AUTH_KEYè‡ªè¡Œè®¾ç½® sudo docker run -i -p 8060:8000 -e API_AUTH_KEY=mt_photos_ai_extra_secret --name mt-photos-ai2 mtphotos/mt-photos-ai:latest ä¼šç›‘å¬ 8060ç«¯å£ å¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤æ¥çœ‹çœ‹é€šä¸é€š curl --location --request POST 'http://127.0.0.1:8060/check' \\ --header 'api-key: mt_photos_ai_extra_secret' å…« è·‘é€šæ•´ä¸ªé“¾è·¯ MT Photo è°ƒç”¨ å…¬ç½‘IP:6000 ç«¯å£ api-key FRPS ä¼šå»è°ƒç”¨ å®¢æˆ·ç«¯çš„ 8060ç«¯å£ ä¹ æ˜¯å¦éœ€è¦å¼€æœºå¯åŠ¨ ç›®å‰ä½¿ç”¨çš„åŠŸèƒ½æ˜¯ä¸€ä¸ªä¸å¸¸ç”¨çš„åŠŸèƒ½ï¼ŒFRPSè¿æ¥æ²¡æœ‰è¯†åˆ«æ¥æºæ‰€ä»¥è®¡åˆ’éšç”¨éš‹å¼€ï¼Œä¸è‡ªåŠ¨å¯åŠ¨ã€‚ 9.1 è®¾ç½®äº‘æœåŠ¡å™¨ç«¯å¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frps.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frps daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/etc/frps/frp_0.38.0_linux_amd64/frps -c /etc/frps/frp_0.38.0_linux_amd64/frps.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpsçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frps systemctl daemon-reload systemctl start frps #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ systemctl enable frps 9.2 è®¾ç½®å±€åŸŸç½‘æœºå­frpcå¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frpc.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frpc daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/home/wentao/frps/frp_0.37.0_linux_amd64/frpc -c /home/wentao/frps/frp_0.37.0_linux_amd64/frpc.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpcçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frpc sudo systemctl daemon-reload sudo systemctl start frpc #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ sudo systemctl enable frpc åã€å¤æ‚é…ç½® ä»¥ä¸‹é…ç½®ä¸­å¯†ç å’Œå…¬ç½‘IPéƒ½ä½¿ç”¨XXè¿›è¡Œäº†ä»£æ›¿ï¼Œå¤åˆ¶ä½¿ç”¨æ—¶è¯·æ³¨æ„ä¿®æ”¹ è¿œç¨‹æœåŠ¡ç«¯frps.ini [common] # frpç›‘å¬çš„ç«¯å£ï¼Œé»˜è®¤æ˜¯7000 bind_port = 7000 # æˆæƒç ,è¯·è‡ªå®šä¹‰æ›´æ”¹ token = XXXXX # è¿™ä¸ªtokenä¹‹ååœ¨å®¢æˆ·ç«¯ä¼šç”¨åˆ° # frpç®¡ç†åå°ç«¯å£ï¼Œè¯·æŒ‰è‡ªå·±éœ€æ±‚æ›´æ”¹ dashboard_port = 7500 # frpç®¡ç†åå°ç”¨æˆ·åå’Œå¯†ç ï¼Œè¯·æ”¹æˆè‡ªå·±çš„ dashboard_user = admin dashboard_pwd = XXXXX enable_prometheus = true # frpæ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frps.log log_level = info log_max_days = 7 å®¢æˆ·ç«¯çš„frpc.iniæ–‡ä»¶ [common] # è¿œç¨‹æœåŠ¡å™¨ipï¼Œè¿œç¨‹frpæœåŠ¡ç«¯å£ä»¥åŠè¿œç¨‹ç™»å½•å¯†ç  server_addr = 119.XX.XX.119 server_port = 7000 token = XXXXX # æ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frpc.log log_level = info log_max_days = 7 # å°†æœ¬åœ°æœºçš„22ç«¯å£æ˜ å°„è‡³è¿œç¨‹20022ç«¯å£ ä¸­æ‹¬å·å†…[ssh]åªä½œä¸ºæ ‡è¯†ï¼Œå¯è‡ªå®šä¹‰ [ssh] type = tcp local_ip = 127.0.0.1 local_port = 8060 remote_port = 6000 # å°†æœ¬æœºçš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹25901ç«¯å£ [vnc] type = tcp local_ip = 127.0.0.1 local_port = 8000 remote_port = 6001 # å°†æœ¬æœºæ‰€åœ¨å±€åŸŸç½‘å†…çš„192.168.0.129æœºå­çš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹55901ç«¯å£ [tsj-vnc] type = tcp local_ip = 192.168.0.129 local_port = 5901 remote_port = 55901 # ä»£ç†æœ¬æœºæ‰€åœ¨çš„å†…ç½‘ï¼Œå³è‹¥ç”¨æˆ·è®¾ç½®ä»£ç†ä¸ºå…¬ç½‘IP+ç«¯å£å³å¯è®¿é—®æœ¬æœºæ‰€åœ¨å†…ç½‘ï¼Œä½¿ç”¨çš„æ˜¯socks5ä»£ç†åè®®ï¼Œplugin_useråŠåé¢çš„å¯è®¾ç½®å¯ä¸è®¾ï¼Œä½†ä¸è®¾çš„é£é™©è¾ƒå¤§ [socks5_proxy] type = tcp remote_port = 7890 plugin = socks5 plugin = socks5 plugin_user = name plugin_passwd = password use_encryption = true use_compression = true é‡å¯frpæœåŠ¡ ","date":"2024-11-06","objectID":"/posts/mt-photos/:0:0","tags":["blog","ç½‘ç»œé…ç½®"],"title":"MT-Photos","uri":"/posts/mt-photos/#å…­-å®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯"},{"categories":["ç”Ÿæ´»"],"collections":null,"content":"FPR å†…ç½‘ç©¿é€ éœ€è¦å†…ç½‘çš„æœºå™¨çš„å¼ºå¤§çš„CPU ç»™AIè¯†åˆ«æä¾›åŠ©åŠ› å€Ÿç”¨äº†è…¾è®¯äº‘å†…ç½‘ç©¿é€æ¥è”é€š è…¾è®¯äº‘æœåŠ¡å™¨è¿è¡Œçš„ä¸ºæœåŠ¡ç«¯ï¼Œ å±€åŸŸç½‘å†…æœºå­è¿è¡Œçš„ä¸ºå®¢æˆ·ç«¯ NASæœºå™¨ç§°ä¸ºè®¿é—®ç«¯ ä¸€ ä¸‹è½½ frpåŒ… æŒ‰æ¨èlinuxä¸‹è½½äº† 0.37æˆ–è€…0.38 è¯•éªŒä¸‹æ¥ä½¿ç”¨ç¨³å®š wget https://github.com/fatedier/frp/releases/download/v0.38.0/frp_0.38.0_linux_amd64.tar.gz äºŒ æœåŠ¡ç«¯å®‰è£… æ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ æ‰§è¡ŒÂ cd frp_0.38.0_linux_amd64/è¿›å…¥æ–‡ä»¶å¤¹ ä¿®æ”¹é…ç½®æ–‡ä»¶#ä¸‰ æœåŠ¡ç«¯é…ç½® sudo chmod 755 ./frps èµ‹äºˆ å¯åŠ¨è¿è¡Œ åœ¨å®‰è£…å¥½çš„ç›®å½•å†… æ‰§è¡Œ./frps -c ./frps.iniå‰å°å¯åŠ¨å‘½ä»¤ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frps -c ./frps.ini \u0026Â åå°ä¿æŒå¯åŠ¨ _åæœŸè¿˜å¯ä»¥è®¾ç½®è‡ªåŠ¨è¿è¡Œ #TODOï¼š ä¸‰ æœåŠ¡ç«¯é…ç½® [common] bind_addr=0.0.0.0 bind_port = 7000 token=12345678 dashboard_port = 7500 dashboard_user = admin dashboard_pwd = admin123 é…ç½®è¯´æ˜ï¼š â€œbind_addr\"æ˜¯æœåŠ¡å™¨æœ¬åœ°IPï¼Œä¸æ”¹ã€‚ â€œbind_port\"æ˜¯frpç›‘å¬ç«¯å£ã€‚ â€œtoken\"æ˜¯éªŒè¯tokenå»ºè®®è®¾ç½®ä¸Šã€‚ â€œdashboard_port\"æ˜¯frpé¢æ¿ç«¯å£ã€‚ â€œdashboard_user\"â€œdashboard_pwd\"æ˜¯é¢æ¿çš„è´¦æˆ·å¯†ç ã€‚ token å»ºè®®å¤æ‚ä¸€äº›ï¼Œå±è”½ä¸€äº›æ‰«æè®¿é—® å›› è®¿é—®frpæ§åˆ¶é¢æ¿ é¢æ¿ä»…ä¾›å‚è€ƒï¼Œå¯ç”¨å¯ä¸ç”¨ã€‚è®¿é—®Â http://æœåŠ¡å™¨ip:7500 ä¸Šé¢é…ç½®çš„7500ç«¯å£ï¼Œä½¿ç”¨ä¸Šé¢é…ç½®çš„ç”¨æˆ·åå’Œå¯†ç  admin/admin123 äº” å®¢æˆ·ç«¯é…ç½®ä¿®æ”¹ å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¸‹è½½åŒæ ·çš„æ–‡ä»¶ frp_0.38.0_linux_amd64.tar.gz åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ ç„¶åè¿›å…¥ï¼Œ ç¼–è¾‘å®¢æˆ·ç«¯é…ç½®\"frpc.ini\"æ–‡ä»¶ [common] server_addr = å…¬ç½‘IP è…¾è®¯æœåŠ¡å™¨çš„åœ°å€ server_port = 7000 ä¸Šé¢æœåŠ¡ç«¯é…ç½®çš„ç«¯å£ token=1235678 ç›¸å½“äºå¯†ç  [RDP] type = tcp local_ip = 127.0.0.1 æœ¬åœ°å›ç¯åœ°å€ local_port = 8060 å±€åŸŸç½‘å®¢æˆ·ç«¯çš„ç«¯å£ remote_port = 6000 æœåŠ¡ç«¯çš„ç«¯å£ï¼Œç”¨äºç»™è®¿é—®ç«¯ä½¿ç”¨ è¯´æ˜ï¼š å®¢æˆ·ç«¯è¿æ¥è…¾è®¯äº‘çš„åœ°å€ å…¬ç½‘IP ç«¯å£7000 token è®¿é—®ç«¯è¿æ¥è…¾è®¯äº‘çš„å…¬ç½‘IP 6000 ï¼Œä¼šfrpsè½¬åˆ° å®¢æˆ·ç«¯çš„8060ç«¯å£ å…­ å®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯ æ‰§è¡Œ./frpc -c ./frpc.iniå‰å°å¯åŠ¨å‘½ä»¤ è¿æ¥æœåŠ¡ç«¯ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frpc -c ./frpc.ini \u0026Â åå°ä¿æŒå¯åŠ¨ ä¸ƒ MT Photo AI è·‘ aiçš„æœºå™¨ä½¿ç”¨çš„ubuntuç³»ç»Ÿ å®‰è£…docker ä¸‹è½½é•œåƒ sudo docker pull mtphotos/mt-photos-ai è¿è¡Œè„šæœ¬ #API_AUTH_KEYè‡ªè¡Œè®¾ç½® sudo docker run -i -p 8060:8000 -e API_AUTH_KEY=mt_photos_ai_extra_secret --name mt-photos-ai2 mtphotos/mt-photos-ai:latest ä¼šç›‘å¬ 8060ç«¯å£ å¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤æ¥çœ‹çœ‹é€šä¸é€š curl --location --request POST 'http://127.0.0.1:8060/check' \\ --header 'api-key: mt_photos_ai_extra_secret' å…« è·‘é€šæ•´ä¸ªé“¾è·¯ MT Photo è°ƒç”¨ å…¬ç½‘IP:6000 ç«¯å£ api-key FRPS ä¼šå»è°ƒç”¨ å®¢æˆ·ç«¯çš„ 8060ç«¯å£ ä¹ æ˜¯å¦éœ€è¦å¼€æœºå¯åŠ¨ ç›®å‰ä½¿ç”¨çš„åŠŸèƒ½æ˜¯ä¸€ä¸ªä¸å¸¸ç”¨çš„åŠŸèƒ½ï¼ŒFRPSè¿æ¥æ²¡æœ‰è¯†åˆ«æ¥æºæ‰€ä»¥è®¡åˆ’éšç”¨éš‹å¼€ï¼Œä¸è‡ªåŠ¨å¯åŠ¨ã€‚ 9.1 è®¾ç½®äº‘æœåŠ¡å™¨ç«¯å¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frps.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frps daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/etc/frps/frp_0.38.0_linux_amd64/frps -c /etc/frps/frp_0.38.0_linux_amd64/frps.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpsçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frps systemctl daemon-reload systemctl start frps #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ systemctl enable frps 9.2 è®¾ç½®å±€åŸŸç½‘æœºå­frpcå¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frpc.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frpc daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/home/wentao/frps/frp_0.37.0_linux_amd64/frpc -c /home/wentao/frps/frp_0.37.0_linux_amd64/frpc.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpcçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frpc sudo systemctl daemon-reload sudo systemctl start frpc #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ sudo systemctl enable frpc åã€å¤æ‚é…ç½® ä»¥ä¸‹é…ç½®ä¸­å¯†ç å’Œå…¬ç½‘IPéƒ½ä½¿ç”¨XXè¿›è¡Œäº†ä»£æ›¿ï¼Œå¤åˆ¶ä½¿ç”¨æ—¶è¯·æ³¨æ„ä¿®æ”¹ è¿œç¨‹æœåŠ¡ç«¯frps.ini [common] # frpç›‘å¬çš„ç«¯å£ï¼Œé»˜è®¤æ˜¯7000 bind_port = 7000 # æˆæƒç ,è¯·è‡ªå®šä¹‰æ›´æ”¹ token = XXXXX # è¿™ä¸ªtokenä¹‹ååœ¨å®¢æˆ·ç«¯ä¼šç”¨åˆ° # frpç®¡ç†åå°ç«¯å£ï¼Œè¯·æŒ‰è‡ªå·±éœ€æ±‚æ›´æ”¹ dashboard_port = 7500 # frpç®¡ç†åå°ç”¨æˆ·åå’Œå¯†ç ï¼Œè¯·æ”¹æˆè‡ªå·±çš„ dashboard_user = admin dashboard_pwd = XXXXX enable_prometheus = true # frpæ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frps.log log_level = info log_max_days = 7 å®¢æˆ·ç«¯çš„frpc.iniæ–‡ä»¶ [common] # è¿œç¨‹æœåŠ¡å™¨ipï¼Œè¿œç¨‹frpæœåŠ¡ç«¯å£ä»¥åŠè¿œç¨‹ç™»å½•å¯†ç  server_addr = 119.XX.XX.119 server_port = 7000 token = XXXXX # æ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frpc.log log_level = info log_max_days = 7 # å°†æœ¬åœ°æœºçš„22ç«¯å£æ˜ å°„è‡³è¿œç¨‹20022ç«¯å£ ä¸­æ‹¬å·å†…[ssh]åªä½œä¸ºæ ‡è¯†ï¼Œå¯è‡ªå®šä¹‰ [ssh] type = tcp local_ip = 127.0.0.1 local_port = 8060 remote_port = 6000 # å°†æœ¬æœºçš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹25901ç«¯å£ [vnc] type = tcp local_ip = 127.0.0.1 local_port = 8000 remote_port = 6001 # å°†æœ¬æœºæ‰€åœ¨å±€åŸŸç½‘å†…çš„192.168.0.129æœºå­çš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹55901ç«¯å£ [tsj-vnc] type = tcp local_ip = 192.168.0.129 local_port = 5901 remote_port = 55901 # ä»£ç†æœ¬æœºæ‰€åœ¨çš„å†…ç½‘ï¼Œå³è‹¥ç”¨æˆ·è®¾ç½®ä»£ç†ä¸ºå…¬ç½‘IP+ç«¯å£å³å¯è®¿é—®æœ¬æœºæ‰€åœ¨å†…ç½‘ï¼Œä½¿ç”¨çš„æ˜¯socks5ä»£ç†åè®®ï¼Œplugin_useråŠåé¢çš„å¯è®¾ç½®å¯ä¸è®¾ï¼Œä½†ä¸è®¾çš„é£é™©è¾ƒå¤§ [socks5_proxy] type = tcp remote_port = 7890 plugin = socks5 plugin = socks5 plugin_user = name plugin_passwd = password use_encryption = true use_compression = true é‡å¯frpæœåŠ¡ ","date":"2024-11-06","objectID":"/posts/mt-photos/:0:0","tags":["blog","ç½‘ç»œé…ç½®"],"title":"MT-Photos","uri":"/posts/mt-photos/#ä¸ƒ-mt-photo-ai"},{"categories":["ç”Ÿæ´»"],"collections":null,"content":"FPR å†…ç½‘ç©¿é€ éœ€è¦å†…ç½‘çš„æœºå™¨çš„å¼ºå¤§çš„CPU ç»™AIè¯†åˆ«æä¾›åŠ©åŠ› å€Ÿç”¨äº†è…¾è®¯äº‘å†…ç½‘ç©¿é€æ¥è”é€š è…¾è®¯äº‘æœåŠ¡å™¨è¿è¡Œçš„ä¸ºæœåŠ¡ç«¯ï¼Œ å±€åŸŸç½‘å†…æœºå­è¿è¡Œçš„ä¸ºå®¢æˆ·ç«¯ NASæœºå™¨ç§°ä¸ºè®¿é—®ç«¯ ä¸€ ä¸‹è½½ frpåŒ… æŒ‰æ¨èlinuxä¸‹è½½äº† 0.37æˆ–è€…0.38 è¯•éªŒä¸‹æ¥ä½¿ç”¨ç¨³å®š wget https://github.com/fatedier/frp/releases/download/v0.38.0/frp_0.38.0_linux_amd64.tar.gz äºŒ æœåŠ¡ç«¯å®‰è£… æ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ æ‰§è¡ŒÂ cd frp_0.38.0_linux_amd64/è¿›å…¥æ–‡ä»¶å¤¹ ä¿®æ”¹é…ç½®æ–‡ä»¶#ä¸‰ æœåŠ¡ç«¯é…ç½® sudo chmod 755 ./frps èµ‹äºˆ å¯åŠ¨è¿è¡Œ åœ¨å®‰è£…å¥½çš„ç›®å½•å†… æ‰§è¡Œ./frps -c ./frps.iniå‰å°å¯åŠ¨å‘½ä»¤ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frps -c ./frps.ini \u0026Â åå°ä¿æŒå¯åŠ¨ _åæœŸè¿˜å¯ä»¥è®¾ç½®è‡ªåŠ¨è¿è¡Œ #TODOï¼š ä¸‰ æœåŠ¡ç«¯é…ç½® [common] bind_addr=0.0.0.0 bind_port = 7000 token=12345678 dashboard_port = 7500 dashboard_user = admin dashboard_pwd = admin123 é…ç½®è¯´æ˜ï¼š â€œbind_addr\"æ˜¯æœåŠ¡å™¨æœ¬åœ°IPï¼Œä¸æ”¹ã€‚ â€œbind_port\"æ˜¯frpç›‘å¬ç«¯å£ã€‚ â€œtoken\"æ˜¯éªŒè¯tokenå»ºè®®è®¾ç½®ä¸Šã€‚ â€œdashboard_port\"æ˜¯frpé¢æ¿ç«¯å£ã€‚ â€œdashboard_user\"â€œdashboard_pwd\"æ˜¯é¢æ¿çš„è´¦æˆ·å¯†ç ã€‚ token å»ºè®®å¤æ‚ä¸€äº›ï¼Œå±è”½ä¸€äº›æ‰«æè®¿é—® å›› è®¿é—®frpæ§åˆ¶é¢æ¿ é¢æ¿ä»…ä¾›å‚è€ƒï¼Œå¯ç”¨å¯ä¸ç”¨ã€‚è®¿é—®Â http://æœåŠ¡å™¨ip:7500 ä¸Šé¢é…ç½®çš„7500ç«¯å£ï¼Œä½¿ç”¨ä¸Šé¢é…ç½®çš„ç”¨æˆ·åå’Œå¯†ç  admin/admin123 äº” å®¢æˆ·ç«¯é…ç½®ä¿®æ”¹ å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¸‹è½½åŒæ ·çš„æ–‡ä»¶ frp_0.38.0_linux_amd64.tar.gz åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ ç„¶åè¿›å…¥ï¼Œ ç¼–è¾‘å®¢æˆ·ç«¯é…ç½®\"frpc.ini\"æ–‡ä»¶ [common] server_addr = å…¬ç½‘IP è…¾è®¯æœåŠ¡å™¨çš„åœ°å€ server_port = 7000 ä¸Šé¢æœåŠ¡ç«¯é…ç½®çš„ç«¯å£ token=1235678 ç›¸å½“äºå¯†ç  [RDP] type = tcp local_ip = 127.0.0.1 æœ¬åœ°å›ç¯åœ°å€ local_port = 8060 å±€åŸŸç½‘å®¢æˆ·ç«¯çš„ç«¯å£ remote_port = 6000 æœåŠ¡ç«¯çš„ç«¯å£ï¼Œç”¨äºç»™è®¿é—®ç«¯ä½¿ç”¨ è¯´æ˜ï¼š å®¢æˆ·ç«¯è¿æ¥è…¾è®¯äº‘çš„åœ°å€ å…¬ç½‘IP ç«¯å£7000 token è®¿é—®ç«¯è¿æ¥è…¾è®¯äº‘çš„å…¬ç½‘IP 6000 ï¼Œä¼šfrpsè½¬åˆ° å®¢æˆ·ç«¯çš„8060ç«¯å£ å…­ å®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯ æ‰§è¡Œ./frpc -c ./frpc.iniå‰å°å¯åŠ¨å‘½ä»¤ è¿æ¥æœåŠ¡ç«¯ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frpc -c ./frpc.ini \u0026Â åå°ä¿æŒå¯åŠ¨ ä¸ƒ MT Photo AI è·‘ aiçš„æœºå™¨ä½¿ç”¨çš„ubuntuç³»ç»Ÿ å®‰è£…docker ä¸‹è½½é•œåƒ sudo docker pull mtphotos/mt-photos-ai è¿è¡Œè„šæœ¬ #API_AUTH_KEYè‡ªè¡Œè®¾ç½® sudo docker run -i -p 8060:8000 -e API_AUTH_KEY=mt_photos_ai_extra_secret --name mt-photos-ai2 mtphotos/mt-photos-ai:latest ä¼šç›‘å¬ 8060ç«¯å£ å¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤æ¥çœ‹çœ‹é€šä¸é€š curl --location --request POST 'http://127.0.0.1:8060/check' \\ --header 'api-key: mt_photos_ai_extra_secret' å…« è·‘é€šæ•´ä¸ªé“¾è·¯ MT Photo è°ƒç”¨ å…¬ç½‘IP:6000 ç«¯å£ api-key FRPS ä¼šå»è°ƒç”¨ å®¢æˆ·ç«¯çš„ 8060ç«¯å£ ä¹ æ˜¯å¦éœ€è¦å¼€æœºå¯åŠ¨ ç›®å‰ä½¿ç”¨çš„åŠŸèƒ½æ˜¯ä¸€ä¸ªä¸å¸¸ç”¨çš„åŠŸèƒ½ï¼ŒFRPSè¿æ¥æ²¡æœ‰è¯†åˆ«æ¥æºæ‰€ä»¥è®¡åˆ’éšç”¨éš‹å¼€ï¼Œä¸è‡ªåŠ¨å¯åŠ¨ã€‚ 9.1 è®¾ç½®äº‘æœåŠ¡å™¨ç«¯å¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frps.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frps daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/etc/frps/frp_0.38.0_linux_amd64/frps -c /etc/frps/frp_0.38.0_linux_amd64/frps.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpsçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frps systemctl daemon-reload systemctl start frps #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ systemctl enable frps 9.2 è®¾ç½®å±€åŸŸç½‘æœºå­frpcå¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frpc.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frpc daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/home/wentao/frps/frp_0.37.0_linux_amd64/frpc -c /home/wentao/frps/frp_0.37.0_linux_amd64/frpc.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpcçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frpc sudo systemctl daemon-reload sudo systemctl start frpc #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ sudo systemctl enable frpc åã€å¤æ‚é…ç½® ä»¥ä¸‹é…ç½®ä¸­å¯†ç å’Œå…¬ç½‘IPéƒ½ä½¿ç”¨XXè¿›è¡Œäº†ä»£æ›¿ï¼Œå¤åˆ¶ä½¿ç”¨æ—¶è¯·æ³¨æ„ä¿®æ”¹ è¿œç¨‹æœåŠ¡ç«¯frps.ini [common] # frpç›‘å¬çš„ç«¯å£ï¼Œé»˜è®¤æ˜¯7000 bind_port = 7000 # æˆæƒç ,è¯·è‡ªå®šä¹‰æ›´æ”¹ token = XXXXX # è¿™ä¸ªtokenä¹‹ååœ¨å®¢æˆ·ç«¯ä¼šç”¨åˆ° # frpç®¡ç†åå°ç«¯å£ï¼Œè¯·æŒ‰è‡ªå·±éœ€æ±‚æ›´æ”¹ dashboard_port = 7500 # frpç®¡ç†åå°ç”¨æˆ·åå’Œå¯†ç ï¼Œè¯·æ”¹æˆè‡ªå·±çš„ dashboard_user = admin dashboard_pwd = XXXXX enable_prometheus = true # frpæ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frps.log log_level = info log_max_days = 7 å®¢æˆ·ç«¯çš„frpc.iniæ–‡ä»¶ [common] # è¿œç¨‹æœåŠ¡å™¨ipï¼Œè¿œç¨‹frpæœåŠ¡ç«¯å£ä»¥åŠè¿œç¨‹ç™»å½•å¯†ç  server_addr = 119.XX.XX.119 server_port = 7000 token = XXXXX # æ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frpc.log log_level = info log_max_days = 7 # å°†æœ¬åœ°æœºçš„22ç«¯å£æ˜ å°„è‡³è¿œç¨‹20022ç«¯å£ ä¸­æ‹¬å·å†…[ssh]åªä½œä¸ºæ ‡è¯†ï¼Œå¯è‡ªå®šä¹‰ [ssh] type = tcp local_ip = 127.0.0.1 local_port = 8060 remote_port = 6000 # å°†æœ¬æœºçš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹25901ç«¯å£ [vnc] type = tcp local_ip = 127.0.0.1 local_port = 8000 remote_port = 6001 # å°†æœ¬æœºæ‰€åœ¨å±€åŸŸç½‘å†…çš„192.168.0.129æœºå­çš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹55901ç«¯å£ [tsj-vnc] type = tcp local_ip = 192.168.0.129 local_port = 5901 remote_port = 55901 # ä»£ç†æœ¬æœºæ‰€åœ¨çš„å†…ç½‘ï¼Œå³è‹¥ç”¨æˆ·è®¾ç½®ä»£ç†ä¸ºå…¬ç½‘IP+ç«¯å£å³å¯è®¿é—®æœ¬æœºæ‰€åœ¨å†…ç½‘ï¼Œä½¿ç”¨çš„æ˜¯socks5ä»£ç†åè®®ï¼Œplugin_useråŠåé¢çš„å¯è®¾ç½®å¯ä¸è®¾ï¼Œä½†ä¸è®¾çš„é£é™©è¾ƒå¤§ [socks5_proxy] type = tcp remote_port = 7890 plugin = socks5 plugin = socks5 plugin_user = name plugin_passwd = password use_encryption = true use_compression = true é‡å¯frpæœåŠ¡ ","date":"2024-11-06","objectID":"/posts/mt-photos/:0:0","tags":["blog","ç½‘ç»œé…ç½®"],"title":"MT-Photos","uri":"/posts/mt-photos/#å…«-è·‘é€šæ•´ä¸ªé“¾è·¯"},{"categories":["ç”Ÿæ´»"],"collections":null,"content":"FPR å†…ç½‘ç©¿é€ éœ€è¦å†…ç½‘çš„æœºå™¨çš„å¼ºå¤§çš„CPU ç»™AIè¯†åˆ«æä¾›åŠ©åŠ› å€Ÿç”¨äº†è…¾è®¯äº‘å†…ç½‘ç©¿é€æ¥è”é€š è…¾è®¯äº‘æœåŠ¡å™¨è¿è¡Œçš„ä¸ºæœåŠ¡ç«¯ï¼Œ å±€åŸŸç½‘å†…æœºå­è¿è¡Œçš„ä¸ºå®¢æˆ·ç«¯ NASæœºå™¨ç§°ä¸ºè®¿é—®ç«¯ ä¸€ ä¸‹è½½ frpåŒ… æŒ‰æ¨èlinuxä¸‹è½½äº† 0.37æˆ–è€…0.38 è¯•éªŒä¸‹æ¥ä½¿ç”¨ç¨³å®š wget https://github.com/fatedier/frp/releases/download/v0.38.0/frp_0.38.0_linux_amd64.tar.gz äºŒ æœåŠ¡ç«¯å®‰è£… æ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ æ‰§è¡ŒÂ cd frp_0.38.0_linux_amd64/è¿›å…¥æ–‡ä»¶å¤¹ ä¿®æ”¹é…ç½®æ–‡ä»¶#ä¸‰ æœåŠ¡ç«¯é…ç½® sudo chmod 755 ./frps èµ‹äºˆ å¯åŠ¨è¿è¡Œ åœ¨å®‰è£…å¥½çš„ç›®å½•å†… æ‰§è¡Œ./frps -c ./frps.iniå‰å°å¯åŠ¨å‘½ä»¤ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frps -c ./frps.ini \u0026Â åå°ä¿æŒå¯åŠ¨ _åæœŸè¿˜å¯ä»¥è®¾ç½®è‡ªåŠ¨è¿è¡Œ #TODOï¼š ä¸‰ æœåŠ¡ç«¯é…ç½® [common] bind_addr=0.0.0.0 bind_port = 7000 token=12345678 dashboard_port = 7500 dashboard_user = admin dashboard_pwd = admin123 é…ç½®è¯´æ˜ï¼š â€œbind_addr\"æ˜¯æœåŠ¡å™¨æœ¬åœ°IPï¼Œä¸æ”¹ã€‚ â€œbind_port\"æ˜¯frpç›‘å¬ç«¯å£ã€‚ â€œtoken\"æ˜¯éªŒè¯tokenå»ºè®®è®¾ç½®ä¸Šã€‚ â€œdashboard_port\"æ˜¯frpé¢æ¿ç«¯å£ã€‚ â€œdashboard_user\"â€œdashboard_pwd\"æ˜¯é¢æ¿çš„è´¦æˆ·å¯†ç ã€‚ token å»ºè®®å¤æ‚ä¸€äº›ï¼Œå±è”½ä¸€äº›æ‰«æè®¿é—® å›› è®¿é—®frpæ§åˆ¶é¢æ¿ é¢æ¿ä»…ä¾›å‚è€ƒï¼Œå¯ç”¨å¯ä¸ç”¨ã€‚è®¿é—®Â http://æœåŠ¡å™¨ip:7500 ä¸Šé¢é…ç½®çš„7500ç«¯å£ï¼Œä½¿ç”¨ä¸Šé¢é…ç½®çš„ç”¨æˆ·åå’Œå¯†ç  admin/admin123 äº” å®¢æˆ·ç«¯é…ç½®ä¿®æ”¹ å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¸‹è½½åŒæ ·çš„æ–‡ä»¶ frp_0.38.0_linux_amd64.tar.gz åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ ç„¶åè¿›å…¥ï¼Œ ç¼–è¾‘å®¢æˆ·ç«¯é…ç½®\"frpc.ini\"æ–‡ä»¶ [common] server_addr = å…¬ç½‘IP è…¾è®¯æœåŠ¡å™¨çš„åœ°å€ server_port = 7000 ä¸Šé¢æœåŠ¡ç«¯é…ç½®çš„ç«¯å£ token=1235678 ç›¸å½“äºå¯†ç  [RDP] type = tcp local_ip = 127.0.0.1 æœ¬åœ°å›ç¯åœ°å€ local_port = 8060 å±€åŸŸç½‘å®¢æˆ·ç«¯çš„ç«¯å£ remote_port = 6000 æœåŠ¡ç«¯çš„ç«¯å£ï¼Œç”¨äºç»™è®¿é—®ç«¯ä½¿ç”¨ è¯´æ˜ï¼š å®¢æˆ·ç«¯è¿æ¥è…¾è®¯äº‘çš„åœ°å€ å…¬ç½‘IP ç«¯å£7000 token è®¿é—®ç«¯è¿æ¥è…¾è®¯äº‘çš„å…¬ç½‘IP 6000 ï¼Œä¼šfrpsè½¬åˆ° å®¢æˆ·ç«¯çš„8060ç«¯å£ å…­ å®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯ æ‰§è¡Œ./frpc -c ./frpc.iniå‰å°å¯åŠ¨å‘½ä»¤ è¿æ¥æœåŠ¡ç«¯ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frpc -c ./frpc.ini \u0026Â åå°ä¿æŒå¯åŠ¨ ä¸ƒ MT Photo AI è·‘ aiçš„æœºå™¨ä½¿ç”¨çš„ubuntuç³»ç»Ÿ å®‰è£…docker ä¸‹è½½é•œåƒ sudo docker pull mtphotos/mt-photos-ai è¿è¡Œè„šæœ¬ #API_AUTH_KEYè‡ªè¡Œè®¾ç½® sudo docker run -i -p 8060:8000 -e API_AUTH_KEY=mt_photos_ai_extra_secret --name mt-photos-ai2 mtphotos/mt-photos-ai:latest ä¼šç›‘å¬ 8060ç«¯å£ å¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤æ¥çœ‹çœ‹é€šä¸é€š curl --location --request POST 'http://127.0.0.1:8060/check' \\ --header 'api-key: mt_photos_ai_extra_secret' å…« è·‘é€šæ•´ä¸ªé“¾è·¯ MT Photo è°ƒç”¨ å…¬ç½‘IP:6000 ç«¯å£ api-key FRPS ä¼šå»è°ƒç”¨ å®¢æˆ·ç«¯çš„ 8060ç«¯å£ ä¹ æ˜¯å¦éœ€è¦å¼€æœºå¯åŠ¨ ç›®å‰ä½¿ç”¨çš„åŠŸèƒ½æ˜¯ä¸€ä¸ªä¸å¸¸ç”¨çš„åŠŸèƒ½ï¼ŒFRPSè¿æ¥æ²¡æœ‰è¯†åˆ«æ¥æºæ‰€ä»¥è®¡åˆ’éšç”¨éš‹å¼€ï¼Œä¸è‡ªåŠ¨å¯åŠ¨ã€‚ 9.1 è®¾ç½®äº‘æœåŠ¡å™¨ç«¯å¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frps.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frps daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/etc/frps/frp_0.38.0_linux_amd64/frps -c /etc/frps/frp_0.38.0_linux_amd64/frps.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpsçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frps systemctl daemon-reload systemctl start frps #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ systemctl enable frps 9.2 è®¾ç½®å±€åŸŸç½‘æœºå­frpcå¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frpc.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frpc daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/home/wentao/frps/frp_0.37.0_linux_amd64/frpc -c /home/wentao/frps/frp_0.37.0_linux_amd64/frpc.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpcçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frpc sudo systemctl daemon-reload sudo systemctl start frpc #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ sudo systemctl enable frpc åã€å¤æ‚é…ç½® ä»¥ä¸‹é…ç½®ä¸­å¯†ç å’Œå…¬ç½‘IPéƒ½ä½¿ç”¨XXè¿›è¡Œäº†ä»£æ›¿ï¼Œå¤åˆ¶ä½¿ç”¨æ—¶è¯·æ³¨æ„ä¿®æ”¹ è¿œç¨‹æœåŠ¡ç«¯frps.ini [common] # frpç›‘å¬çš„ç«¯å£ï¼Œé»˜è®¤æ˜¯7000 bind_port = 7000 # æˆæƒç ,è¯·è‡ªå®šä¹‰æ›´æ”¹ token = XXXXX # è¿™ä¸ªtokenä¹‹ååœ¨å®¢æˆ·ç«¯ä¼šç”¨åˆ° # frpç®¡ç†åå°ç«¯å£ï¼Œè¯·æŒ‰è‡ªå·±éœ€æ±‚æ›´æ”¹ dashboard_port = 7500 # frpç®¡ç†åå°ç”¨æˆ·åå’Œå¯†ç ï¼Œè¯·æ”¹æˆè‡ªå·±çš„ dashboard_user = admin dashboard_pwd = XXXXX enable_prometheus = true # frpæ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frps.log log_level = info log_max_days = 7 å®¢æˆ·ç«¯çš„frpc.iniæ–‡ä»¶ [common] # è¿œç¨‹æœåŠ¡å™¨ipï¼Œè¿œç¨‹frpæœåŠ¡ç«¯å£ä»¥åŠè¿œç¨‹ç™»å½•å¯†ç  server_addr = 119.XX.XX.119 server_port = 7000 token = XXXXX # æ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frpc.log log_level = info log_max_days = 7 # å°†æœ¬åœ°æœºçš„22ç«¯å£æ˜ å°„è‡³è¿œç¨‹20022ç«¯å£ ä¸­æ‹¬å·å†…[ssh]åªä½œä¸ºæ ‡è¯†ï¼Œå¯è‡ªå®šä¹‰ [ssh] type = tcp local_ip = 127.0.0.1 local_port = 8060 remote_port = 6000 # å°†æœ¬æœºçš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹25901ç«¯å£ [vnc] type = tcp local_ip = 127.0.0.1 local_port = 8000 remote_port = 6001 # å°†æœ¬æœºæ‰€åœ¨å±€åŸŸç½‘å†…çš„192.168.0.129æœºå­çš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹55901ç«¯å£ [tsj-vnc] type = tcp local_ip = 192.168.0.129 local_port = 5901 remote_port = 55901 # ä»£ç†æœ¬æœºæ‰€åœ¨çš„å†…ç½‘ï¼Œå³è‹¥ç”¨æˆ·è®¾ç½®ä»£ç†ä¸ºå…¬ç½‘IP+ç«¯å£å³å¯è®¿é—®æœ¬æœºæ‰€åœ¨å†…ç½‘ï¼Œä½¿ç”¨çš„æ˜¯socks5ä»£ç†åè®®ï¼Œplugin_useråŠåé¢çš„å¯è®¾ç½®å¯ä¸è®¾ï¼Œä½†ä¸è®¾çš„é£é™©è¾ƒå¤§ [socks5_proxy] type = tcp remote_port = 7890 plugin = socks5 plugin = socks5 plugin_user = name plugin_passwd = password use_encryption = true use_compression = true é‡å¯frpæœåŠ¡ ","date":"2024-11-06","objectID":"/posts/mt-photos/:0:0","tags":["blog","ç½‘ç»œé…ç½®"],"title":"MT-Photos","uri":"/posts/mt-photos/#ä¹--æ˜¯å¦éœ€è¦å¼€æœºå¯åŠ¨"},{"categories":["ç”Ÿæ´»"],"collections":null,"content":"FPR å†…ç½‘ç©¿é€ éœ€è¦å†…ç½‘çš„æœºå™¨çš„å¼ºå¤§çš„CPU ç»™AIè¯†åˆ«æä¾›åŠ©åŠ› å€Ÿç”¨äº†è…¾è®¯äº‘å†…ç½‘ç©¿é€æ¥è”é€š è…¾è®¯äº‘æœåŠ¡å™¨è¿è¡Œçš„ä¸ºæœåŠ¡ç«¯ï¼Œ å±€åŸŸç½‘å†…æœºå­è¿è¡Œçš„ä¸ºå®¢æˆ·ç«¯ NASæœºå™¨ç§°ä¸ºè®¿é—®ç«¯ ä¸€ ä¸‹è½½ frpåŒ… æŒ‰æ¨èlinuxä¸‹è½½äº† 0.37æˆ–è€…0.38 è¯•éªŒä¸‹æ¥ä½¿ç”¨ç¨³å®š wget https://github.com/fatedier/frp/releases/download/v0.38.0/frp_0.38.0_linux_amd64.tar.gz äºŒ æœåŠ¡ç«¯å®‰è£… æ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ æ‰§è¡ŒÂ cd frp_0.38.0_linux_amd64/è¿›å…¥æ–‡ä»¶å¤¹ ä¿®æ”¹é…ç½®æ–‡ä»¶#ä¸‰ æœåŠ¡ç«¯é…ç½® sudo chmod 755 ./frps èµ‹äºˆ å¯åŠ¨è¿è¡Œ åœ¨å®‰è£…å¥½çš„ç›®å½•å†… æ‰§è¡Œ./frps -c ./frps.iniå‰å°å¯åŠ¨å‘½ä»¤ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frps -c ./frps.ini \u0026Â åå°ä¿æŒå¯åŠ¨ _åæœŸè¿˜å¯ä»¥è®¾ç½®è‡ªåŠ¨è¿è¡Œ #TODOï¼š ä¸‰ æœåŠ¡ç«¯é…ç½® [common] bind_addr=0.0.0.0 bind_port = 7000 token=12345678 dashboard_port = 7500 dashboard_user = admin dashboard_pwd = admin123 é…ç½®è¯´æ˜ï¼š â€œbind_addr\"æ˜¯æœåŠ¡å™¨æœ¬åœ°IPï¼Œä¸æ”¹ã€‚ â€œbind_port\"æ˜¯frpç›‘å¬ç«¯å£ã€‚ â€œtoken\"æ˜¯éªŒè¯tokenå»ºè®®è®¾ç½®ä¸Šã€‚ â€œdashboard_port\"æ˜¯frpé¢æ¿ç«¯å£ã€‚ â€œdashboard_user\"â€œdashboard_pwd\"æ˜¯é¢æ¿çš„è´¦æˆ·å¯†ç ã€‚ token å»ºè®®å¤æ‚ä¸€äº›ï¼Œå±è”½ä¸€äº›æ‰«æè®¿é—® å›› è®¿é—®frpæ§åˆ¶é¢æ¿ é¢æ¿ä»…ä¾›å‚è€ƒï¼Œå¯ç”¨å¯ä¸ç”¨ã€‚è®¿é—®Â http://æœåŠ¡å™¨ip:7500 ä¸Šé¢é…ç½®çš„7500ç«¯å£ï¼Œä½¿ç”¨ä¸Šé¢é…ç½®çš„ç”¨æˆ·åå’Œå¯†ç  admin/admin123 äº” å®¢æˆ·ç«¯é…ç½®ä¿®æ”¹ å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¸‹è½½åŒæ ·çš„æ–‡ä»¶ frp_0.38.0_linux_amd64.tar.gz åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ ç„¶åè¿›å…¥ï¼Œ ç¼–è¾‘å®¢æˆ·ç«¯é…ç½®\"frpc.ini\"æ–‡ä»¶ [common] server_addr = å…¬ç½‘IP è…¾è®¯æœåŠ¡å™¨çš„åœ°å€ server_port = 7000 ä¸Šé¢æœåŠ¡ç«¯é…ç½®çš„ç«¯å£ token=1235678 ç›¸å½“äºå¯†ç  [RDP] type = tcp local_ip = 127.0.0.1 æœ¬åœ°å›ç¯åœ°å€ local_port = 8060 å±€åŸŸç½‘å®¢æˆ·ç«¯çš„ç«¯å£ remote_port = 6000 æœåŠ¡ç«¯çš„ç«¯å£ï¼Œç”¨äºç»™è®¿é—®ç«¯ä½¿ç”¨ è¯´æ˜ï¼š å®¢æˆ·ç«¯è¿æ¥è…¾è®¯äº‘çš„åœ°å€ å…¬ç½‘IP ç«¯å£7000 token è®¿é—®ç«¯è¿æ¥è…¾è®¯äº‘çš„å…¬ç½‘IP 6000 ï¼Œä¼šfrpsè½¬åˆ° å®¢æˆ·ç«¯çš„8060ç«¯å£ å…­ å®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯ æ‰§è¡Œ./frpc -c ./frpc.iniå‰å°å¯åŠ¨å‘½ä»¤ è¿æ¥æœåŠ¡ç«¯ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frpc -c ./frpc.ini \u0026Â åå°ä¿æŒå¯åŠ¨ ä¸ƒ MT Photo AI è·‘ aiçš„æœºå™¨ä½¿ç”¨çš„ubuntuç³»ç»Ÿ å®‰è£…docker ä¸‹è½½é•œåƒ sudo docker pull mtphotos/mt-photos-ai è¿è¡Œè„šæœ¬ #API_AUTH_KEYè‡ªè¡Œè®¾ç½® sudo docker run -i -p 8060:8000 -e API_AUTH_KEY=mt_photos_ai_extra_secret --name mt-photos-ai2 mtphotos/mt-photos-ai:latest ä¼šç›‘å¬ 8060ç«¯å£ å¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤æ¥çœ‹çœ‹é€šä¸é€š curl --location --request POST 'http://127.0.0.1:8060/check' \\ --header 'api-key: mt_photos_ai_extra_secret' å…« è·‘é€šæ•´ä¸ªé“¾è·¯ MT Photo è°ƒç”¨ å…¬ç½‘IP:6000 ç«¯å£ api-key FRPS ä¼šå»è°ƒç”¨ å®¢æˆ·ç«¯çš„ 8060ç«¯å£ ä¹ æ˜¯å¦éœ€è¦å¼€æœºå¯åŠ¨ ç›®å‰ä½¿ç”¨çš„åŠŸèƒ½æ˜¯ä¸€ä¸ªä¸å¸¸ç”¨çš„åŠŸèƒ½ï¼ŒFRPSè¿æ¥æ²¡æœ‰è¯†åˆ«æ¥æºæ‰€ä»¥è®¡åˆ’éšç”¨éš‹å¼€ï¼Œä¸è‡ªåŠ¨å¯åŠ¨ã€‚ 9.1 è®¾ç½®äº‘æœåŠ¡å™¨ç«¯å¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frps.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frps daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/etc/frps/frp_0.38.0_linux_amd64/frps -c /etc/frps/frp_0.38.0_linux_amd64/frps.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpsçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frps systemctl daemon-reload systemctl start frps #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ systemctl enable frps 9.2 è®¾ç½®å±€åŸŸç½‘æœºå­frpcå¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frpc.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frpc daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/home/wentao/frps/frp_0.37.0_linux_amd64/frpc -c /home/wentao/frps/frp_0.37.0_linux_amd64/frpc.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpcçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frpc sudo systemctl daemon-reload sudo systemctl start frpc #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ sudo systemctl enable frpc åã€å¤æ‚é…ç½® ä»¥ä¸‹é…ç½®ä¸­å¯†ç å’Œå…¬ç½‘IPéƒ½ä½¿ç”¨XXè¿›è¡Œäº†ä»£æ›¿ï¼Œå¤åˆ¶ä½¿ç”¨æ—¶è¯·æ³¨æ„ä¿®æ”¹ è¿œç¨‹æœåŠ¡ç«¯frps.ini [common] # frpç›‘å¬çš„ç«¯å£ï¼Œé»˜è®¤æ˜¯7000 bind_port = 7000 # æˆæƒç ,è¯·è‡ªå®šä¹‰æ›´æ”¹ token = XXXXX # è¿™ä¸ªtokenä¹‹ååœ¨å®¢æˆ·ç«¯ä¼šç”¨åˆ° # frpç®¡ç†åå°ç«¯å£ï¼Œè¯·æŒ‰è‡ªå·±éœ€æ±‚æ›´æ”¹ dashboard_port = 7500 # frpç®¡ç†åå°ç”¨æˆ·åå’Œå¯†ç ï¼Œè¯·æ”¹æˆè‡ªå·±çš„ dashboard_user = admin dashboard_pwd = XXXXX enable_prometheus = true # frpæ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frps.log log_level = info log_max_days = 7 å®¢æˆ·ç«¯çš„frpc.iniæ–‡ä»¶ [common] # è¿œç¨‹æœåŠ¡å™¨ipï¼Œè¿œç¨‹frpæœåŠ¡ç«¯å£ä»¥åŠè¿œç¨‹ç™»å½•å¯†ç  server_addr = 119.XX.XX.119 server_port = 7000 token = XXXXX # æ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frpc.log log_level = info log_max_days = 7 # å°†æœ¬åœ°æœºçš„22ç«¯å£æ˜ å°„è‡³è¿œç¨‹20022ç«¯å£ ä¸­æ‹¬å·å†…[ssh]åªä½œä¸ºæ ‡è¯†ï¼Œå¯è‡ªå®šä¹‰ [ssh] type = tcp local_ip = 127.0.0.1 local_port = 8060 remote_port = 6000 # å°†æœ¬æœºçš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹25901ç«¯å£ [vnc] type = tcp local_ip = 127.0.0.1 local_port = 8000 remote_port = 6001 # å°†æœ¬æœºæ‰€åœ¨å±€åŸŸç½‘å†…çš„192.168.0.129æœºå­çš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹55901ç«¯å£ [tsj-vnc] type = tcp local_ip = 192.168.0.129 local_port = 5901 remote_port = 55901 # ä»£ç†æœ¬æœºæ‰€åœ¨çš„å†…ç½‘ï¼Œå³è‹¥ç”¨æˆ·è®¾ç½®ä»£ç†ä¸ºå…¬ç½‘IP+ç«¯å£å³å¯è®¿é—®æœ¬æœºæ‰€åœ¨å†…ç½‘ï¼Œä½¿ç”¨çš„æ˜¯socks5ä»£ç†åè®®ï¼Œplugin_useråŠåé¢çš„å¯è®¾ç½®å¯ä¸è®¾ï¼Œä½†ä¸è®¾çš„é£é™©è¾ƒå¤§ [socks5_proxy] type = tcp remote_port = 7890 plugin = socks5 plugin = socks5 plugin_user = name plugin_passwd = password use_encryption = true use_compression = true é‡å¯frpæœåŠ¡ ","date":"2024-11-06","objectID":"/posts/mt-photos/:0:0","tags":["blog","ç½‘ç»œé…ç½®"],"title":"MT-Photos","uri":"/posts/mt-photos/#91-è®¾ç½®äº‘æœåŠ¡å™¨ç«¯å¼€æœºè‡ªå¯åŠ¨"},{"categories":["ç”Ÿæ´»"],"collections":null,"content":"FPR å†…ç½‘ç©¿é€ éœ€è¦å†…ç½‘çš„æœºå™¨çš„å¼ºå¤§çš„CPU ç»™AIè¯†åˆ«æä¾›åŠ©åŠ› å€Ÿç”¨äº†è…¾è®¯äº‘å†…ç½‘ç©¿é€æ¥è”é€š è…¾è®¯äº‘æœåŠ¡å™¨è¿è¡Œçš„ä¸ºæœåŠ¡ç«¯ï¼Œ å±€åŸŸç½‘å†…æœºå­è¿è¡Œçš„ä¸ºå®¢æˆ·ç«¯ NASæœºå™¨ç§°ä¸ºè®¿é—®ç«¯ ä¸€ ä¸‹è½½ frpåŒ… æŒ‰æ¨èlinuxä¸‹è½½äº† 0.37æˆ–è€…0.38 è¯•éªŒä¸‹æ¥ä½¿ç”¨ç¨³å®š wget https://github.com/fatedier/frp/releases/download/v0.38.0/frp_0.38.0_linux_amd64.tar.gz äºŒ æœåŠ¡ç«¯å®‰è£… æ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ æ‰§è¡ŒÂ cd frp_0.38.0_linux_amd64/è¿›å…¥æ–‡ä»¶å¤¹ ä¿®æ”¹é…ç½®æ–‡ä»¶#ä¸‰ æœåŠ¡ç«¯é…ç½® sudo chmod 755 ./frps èµ‹äºˆ å¯åŠ¨è¿è¡Œ åœ¨å®‰è£…å¥½çš„ç›®å½•å†… æ‰§è¡Œ./frps -c ./frps.iniå‰å°å¯åŠ¨å‘½ä»¤ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frps -c ./frps.ini \u0026Â åå°ä¿æŒå¯åŠ¨ _åæœŸè¿˜å¯ä»¥è®¾ç½®è‡ªåŠ¨è¿è¡Œ #TODOï¼š ä¸‰ æœåŠ¡ç«¯é…ç½® [common] bind_addr=0.0.0.0 bind_port = 7000 token=12345678 dashboard_port = 7500 dashboard_user = admin dashboard_pwd = admin123 é…ç½®è¯´æ˜ï¼š â€œbind_addr\"æ˜¯æœåŠ¡å™¨æœ¬åœ°IPï¼Œä¸æ”¹ã€‚ â€œbind_port\"æ˜¯frpç›‘å¬ç«¯å£ã€‚ â€œtoken\"æ˜¯éªŒè¯tokenå»ºè®®è®¾ç½®ä¸Šã€‚ â€œdashboard_port\"æ˜¯frpé¢æ¿ç«¯å£ã€‚ â€œdashboard_user\"â€œdashboard_pwd\"æ˜¯é¢æ¿çš„è´¦æˆ·å¯†ç ã€‚ token å»ºè®®å¤æ‚ä¸€äº›ï¼Œå±è”½ä¸€äº›æ‰«æè®¿é—® å›› è®¿é—®frpæ§åˆ¶é¢æ¿ é¢æ¿ä»…ä¾›å‚è€ƒï¼Œå¯ç”¨å¯ä¸ç”¨ã€‚è®¿é—®Â http://æœåŠ¡å™¨ip:7500 ä¸Šé¢é…ç½®çš„7500ç«¯å£ï¼Œä½¿ç”¨ä¸Šé¢é…ç½®çš„ç”¨æˆ·åå’Œå¯†ç  admin/admin123 äº” å®¢æˆ·ç«¯é…ç½®ä¿®æ”¹ å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¸‹è½½åŒæ ·çš„æ–‡ä»¶ frp_0.38.0_linux_amd64.tar.gz åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ ç„¶åè¿›å…¥ï¼Œ ç¼–è¾‘å®¢æˆ·ç«¯é…ç½®\"frpc.ini\"æ–‡ä»¶ [common] server_addr = å…¬ç½‘IP è…¾è®¯æœåŠ¡å™¨çš„åœ°å€ server_port = 7000 ä¸Šé¢æœåŠ¡ç«¯é…ç½®çš„ç«¯å£ token=1235678 ç›¸å½“äºå¯†ç  [RDP] type = tcp local_ip = 127.0.0.1 æœ¬åœ°å›ç¯åœ°å€ local_port = 8060 å±€åŸŸç½‘å®¢æˆ·ç«¯çš„ç«¯å£ remote_port = 6000 æœåŠ¡ç«¯çš„ç«¯å£ï¼Œç”¨äºç»™è®¿é—®ç«¯ä½¿ç”¨ è¯´æ˜ï¼š å®¢æˆ·ç«¯è¿æ¥è…¾è®¯äº‘çš„åœ°å€ å…¬ç½‘IP ç«¯å£7000 token è®¿é—®ç«¯è¿æ¥è…¾è®¯äº‘çš„å…¬ç½‘IP 6000 ï¼Œä¼šfrpsè½¬åˆ° å®¢æˆ·ç«¯çš„8060ç«¯å£ å…­ å®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯ æ‰§è¡Œ./frpc -c ./frpc.iniå‰å°å¯åŠ¨å‘½ä»¤ è¿æ¥æœåŠ¡ç«¯ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frpc -c ./frpc.ini \u0026Â åå°ä¿æŒå¯åŠ¨ ä¸ƒ MT Photo AI è·‘ aiçš„æœºå™¨ä½¿ç”¨çš„ubuntuç³»ç»Ÿ å®‰è£…docker ä¸‹è½½é•œåƒ sudo docker pull mtphotos/mt-photos-ai è¿è¡Œè„šæœ¬ #API_AUTH_KEYè‡ªè¡Œè®¾ç½® sudo docker run -i -p 8060:8000 -e API_AUTH_KEY=mt_photos_ai_extra_secret --name mt-photos-ai2 mtphotos/mt-photos-ai:latest ä¼šç›‘å¬ 8060ç«¯å£ å¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤æ¥çœ‹çœ‹é€šä¸é€š curl --location --request POST 'http://127.0.0.1:8060/check' \\ --header 'api-key: mt_photos_ai_extra_secret' å…« è·‘é€šæ•´ä¸ªé“¾è·¯ MT Photo è°ƒç”¨ å…¬ç½‘IP:6000 ç«¯å£ api-key FRPS ä¼šå»è°ƒç”¨ å®¢æˆ·ç«¯çš„ 8060ç«¯å£ ä¹ æ˜¯å¦éœ€è¦å¼€æœºå¯åŠ¨ ç›®å‰ä½¿ç”¨çš„åŠŸèƒ½æ˜¯ä¸€ä¸ªä¸å¸¸ç”¨çš„åŠŸèƒ½ï¼ŒFRPSè¿æ¥æ²¡æœ‰è¯†åˆ«æ¥æºæ‰€ä»¥è®¡åˆ’éšç”¨éš‹å¼€ï¼Œä¸è‡ªåŠ¨å¯åŠ¨ã€‚ 9.1 è®¾ç½®äº‘æœåŠ¡å™¨ç«¯å¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frps.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frps daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/etc/frps/frp_0.38.0_linux_amd64/frps -c /etc/frps/frp_0.38.0_linux_amd64/frps.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpsçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frps systemctl daemon-reload systemctl start frps #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ systemctl enable frps 9.2 è®¾ç½®å±€åŸŸç½‘æœºå­frpcå¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frpc.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frpc daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/home/wentao/frps/frp_0.37.0_linux_amd64/frpc -c /home/wentao/frps/frp_0.37.0_linux_amd64/frpc.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpcçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frpc sudo systemctl daemon-reload sudo systemctl start frpc #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ sudo systemctl enable frpc åã€å¤æ‚é…ç½® ä»¥ä¸‹é…ç½®ä¸­å¯†ç å’Œå…¬ç½‘IPéƒ½ä½¿ç”¨XXè¿›è¡Œäº†ä»£æ›¿ï¼Œå¤åˆ¶ä½¿ç”¨æ—¶è¯·æ³¨æ„ä¿®æ”¹ è¿œç¨‹æœåŠ¡ç«¯frps.ini [common] # frpç›‘å¬çš„ç«¯å£ï¼Œé»˜è®¤æ˜¯7000 bind_port = 7000 # æˆæƒç ,è¯·è‡ªå®šä¹‰æ›´æ”¹ token = XXXXX # è¿™ä¸ªtokenä¹‹ååœ¨å®¢æˆ·ç«¯ä¼šç”¨åˆ° # frpç®¡ç†åå°ç«¯å£ï¼Œè¯·æŒ‰è‡ªå·±éœ€æ±‚æ›´æ”¹ dashboard_port = 7500 # frpç®¡ç†åå°ç”¨æˆ·åå’Œå¯†ç ï¼Œè¯·æ”¹æˆè‡ªå·±çš„ dashboard_user = admin dashboard_pwd = XXXXX enable_prometheus = true # frpæ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frps.log log_level = info log_max_days = 7 å®¢æˆ·ç«¯çš„frpc.iniæ–‡ä»¶ [common] # è¿œç¨‹æœåŠ¡å™¨ipï¼Œè¿œç¨‹frpæœåŠ¡ç«¯å£ä»¥åŠè¿œç¨‹ç™»å½•å¯†ç  server_addr = 119.XX.XX.119 server_port = 7000 token = XXXXX # æ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frpc.log log_level = info log_max_days = 7 # å°†æœ¬åœ°æœºçš„22ç«¯å£æ˜ å°„è‡³è¿œç¨‹20022ç«¯å£ ä¸­æ‹¬å·å†…[ssh]åªä½œä¸ºæ ‡è¯†ï¼Œå¯è‡ªå®šä¹‰ [ssh] type = tcp local_ip = 127.0.0.1 local_port = 8060 remote_port = 6000 # å°†æœ¬æœºçš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹25901ç«¯å£ [vnc] type = tcp local_ip = 127.0.0.1 local_port = 8000 remote_port = 6001 # å°†æœ¬æœºæ‰€åœ¨å±€åŸŸç½‘å†…çš„192.168.0.129æœºå­çš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹55901ç«¯å£ [tsj-vnc] type = tcp local_ip = 192.168.0.129 local_port = 5901 remote_port = 55901 # ä»£ç†æœ¬æœºæ‰€åœ¨çš„å†…ç½‘ï¼Œå³è‹¥ç”¨æˆ·è®¾ç½®ä»£ç†ä¸ºå…¬ç½‘IP+ç«¯å£å³å¯è®¿é—®æœ¬æœºæ‰€åœ¨å†…ç½‘ï¼Œä½¿ç”¨çš„æ˜¯socks5ä»£ç†åè®®ï¼Œplugin_useråŠåé¢çš„å¯è®¾ç½®å¯ä¸è®¾ï¼Œä½†ä¸è®¾çš„é£é™©è¾ƒå¤§ [socks5_proxy] type = tcp remote_port = 7890 plugin = socks5 plugin = socks5 plugin_user = name plugin_passwd = password use_encryption = true use_compression = true é‡å¯frpæœåŠ¡ ","date":"2024-11-06","objectID":"/posts/mt-photos/:0:0","tags":["blog","ç½‘ç»œé…ç½®"],"title":"MT-Photos","uri":"/posts/mt-photos/#åå¤æ‚é…ç½®"},{"categories":["ç”Ÿæ´»"],"collections":null,"content":"FPR å†…ç½‘ç©¿é€ éœ€è¦å†…ç½‘çš„æœºå™¨çš„å¼ºå¤§çš„CPU ç»™AIè¯†åˆ«æä¾›åŠ©åŠ› å€Ÿç”¨äº†è…¾è®¯äº‘å†…ç½‘ç©¿é€æ¥è”é€š è…¾è®¯äº‘æœåŠ¡å™¨è¿è¡Œçš„ä¸ºæœåŠ¡ç«¯ï¼Œ å±€åŸŸç½‘å†…æœºå­è¿è¡Œçš„ä¸ºå®¢æˆ·ç«¯ NASæœºå™¨ç§°ä¸ºè®¿é—®ç«¯ ä¸€ ä¸‹è½½ frpåŒ… æŒ‰æ¨èlinuxä¸‹è½½äº† 0.37æˆ–è€…0.38 è¯•éªŒä¸‹æ¥ä½¿ç”¨ç¨³å®š wget https://github.com/fatedier/frp/releases/download/v0.38.0/frp_0.38.0_linux_amd64.tar.gz äºŒ æœåŠ¡ç«¯å®‰è£… æ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ æ‰§è¡ŒÂ cd frp_0.38.0_linux_amd64/è¿›å…¥æ–‡ä»¶å¤¹ ä¿®æ”¹é…ç½®æ–‡ä»¶#ä¸‰ æœåŠ¡ç«¯é…ç½® sudo chmod 755 ./frps èµ‹äºˆ å¯åŠ¨è¿è¡Œ åœ¨å®‰è£…å¥½çš„ç›®å½•å†… æ‰§è¡Œ./frps -c ./frps.iniå‰å°å¯åŠ¨å‘½ä»¤ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frps -c ./frps.ini \u0026Â åå°ä¿æŒå¯åŠ¨ _åæœŸè¿˜å¯ä»¥è®¾ç½®è‡ªåŠ¨è¿è¡Œ #TODOï¼š ä¸‰ æœåŠ¡ç«¯é…ç½® [common] bind_addr=0.0.0.0 bind_port = 7000 token=12345678 dashboard_port = 7500 dashboard_user = admin dashboard_pwd = admin123 é…ç½®è¯´æ˜ï¼š â€œbind_addr\"æ˜¯æœåŠ¡å™¨æœ¬åœ°IPï¼Œä¸æ”¹ã€‚ â€œbind_port\"æ˜¯frpç›‘å¬ç«¯å£ã€‚ â€œtoken\"æ˜¯éªŒè¯tokenå»ºè®®è®¾ç½®ä¸Šã€‚ â€œdashboard_port\"æ˜¯frpé¢æ¿ç«¯å£ã€‚ â€œdashboard_user\"â€œdashboard_pwd\"æ˜¯é¢æ¿çš„è´¦æˆ·å¯†ç ã€‚ token å»ºè®®å¤æ‚ä¸€äº›ï¼Œå±è”½ä¸€äº›æ‰«æè®¿é—® å›› è®¿é—®frpæ§åˆ¶é¢æ¿ é¢æ¿ä»…ä¾›å‚è€ƒï¼Œå¯ç”¨å¯ä¸ç”¨ã€‚è®¿é—®Â http://æœåŠ¡å™¨ip:7500 ä¸Šé¢é…ç½®çš„7500ç«¯å£ï¼Œä½¿ç”¨ä¸Šé¢é…ç½®çš„ç”¨æˆ·åå’Œå¯†ç  admin/admin123 äº” å®¢æˆ·ç«¯é…ç½®ä¿®æ”¹ å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ä¸‹è½½åŒæ ·çš„æ–‡ä»¶ frp_0.38.0_linux_amd64.tar.gz åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œæ‰§è¡Œtar -zxvf frp_0.38.0_linux_amd64.tar.gzè§£å‹ ç„¶åè¿›å…¥ï¼Œ ç¼–è¾‘å®¢æˆ·ç«¯é…ç½®\"frpc.ini\"æ–‡ä»¶ [common] server_addr = å…¬ç½‘IP è…¾è®¯æœåŠ¡å™¨çš„åœ°å€ server_port = 7000 ä¸Šé¢æœåŠ¡ç«¯é…ç½®çš„ç«¯å£ token=1235678 ç›¸å½“äºå¯†ç  [RDP] type = tcp local_ip = 127.0.0.1 æœ¬åœ°å›ç¯åœ°å€ local_port = 8060 å±€åŸŸç½‘å®¢æˆ·ç«¯çš„ç«¯å£ remote_port = 6000 æœåŠ¡ç«¯çš„ç«¯å£ï¼Œç”¨äºç»™è®¿é—®ç«¯ä½¿ç”¨ è¯´æ˜ï¼š å®¢æˆ·ç«¯è¿æ¥è…¾è®¯äº‘çš„åœ°å€ å…¬ç½‘IP ç«¯å£7000 token è®¿é—®ç«¯è¿æ¥è…¾è®¯äº‘çš„å…¬ç½‘IP 6000 ï¼Œä¼šfrpsè½¬åˆ° å®¢æˆ·ç«¯çš„8060ç«¯å£ å…­ å®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯ æ‰§è¡Œ./frpc -c ./frpc.iniå‰å°å¯åŠ¨å‘½ä»¤ è¿æ¥æœåŠ¡ç«¯ åæœŸå¯ä»¥ctrl+c ç»ˆæ­¢ç¨‹åºï¼Œå†æ‰§è¡Œnohup ./frpc -c ./frpc.ini \u0026Â åå°ä¿æŒå¯åŠ¨ ä¸ƒ MT Photo AI è·‘ aiçš„æœºå™¨ä½¿ç”¨çš„ubuntuç³»ç»Ÿ å®‰è£…docker ä¸‹è½½é•œåƒ sudo docker pull mtphotos/mt-photos-ai è¿è¡Œè„šæœ¬ #API_AUTH_KEYè‡ªè¡Œè®¾ç½® sudo docker run -i -p 8060:8000 -e API_AUTH_KEY=mt_photos_ai_extra_secret --name mt-photos-ai2 mtphotos/mt-photos-ai:latest ä¼šç›‘å¬ 8060ç«¯å£ å¯ä»¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤æ¥çœ‹çœ‹é€šä¸é€š curl --location --request POST 'http://127.0.0.1:8060/check' \\ --header 'api-key: mt_photos_ai_extra_secret' å…« è·‘é€šæ•´ä¸ªé“¾è·¯ MT Photo è°ƒç”¨ å…¬ç½‘IP:6000 ç«¯å£ api-key FRPS ä¼šå»è°ƒç”¨ å®¢æˆ·ç«¯çš„ 8060ç«¯å£ ä¹ æ˜¯å¦éœ€è¦å¼€æœºå¯åŠ¨ ç›®å‰ä½¿ç”¨çš„åŠŸèƒ½æ˜¯ä¸€ä¸ªä¸å¸¸ç”¨çš„åŠŸèƒ½ï¼ŒFRPSè¿æ¥æ²¡æœ‰è¯†åˆ«æ¥æºæ‰€ä»¥è®¡åˆ’éšç”¨éš‹å¼€ï¼Œä¸è‡ªåŠ¨å¯åŠ¨ã€‚ 9.1 è®¾ç½®äº‘æœåŠ¡å™¨ç«¯å¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frps.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frps daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/etc/frps/frp_0.38.0_linux_amd64/frps -c /etc/frps/frp_0.38.0_linux_amd64/frps.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpsçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frps systemctl daemon-reload systemctl start frps #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ systemctl enable frps 9.2 è®¾ç½®å±€åŸŸç½‘æœºå­frpcå¼€æœºè‡ªå¯åŠ¨ æ‰§è¡Œsudo vim /etc/systemd/system/frpc.serviceåˆ›å»ºæœåŠ¡ï¼Œç¼–è¾‘å¦‚ä¸‹ [Unit] Description=frpc daemon After=syslog.target network.target Wants=network.target [Service] Type=simple ExecStart=/home/wentao/frps/frp_0.37.0_linux_amd64/frpc -c /home/wentao/frps/frp_0.37.0_linux_amd64/frpc.ini # ç¼–è¾‘çš„æ—¶å€™ä¸€å®šè¦åˆ é™¤æ³¨é‡Š è¿™é‡Œæ›´æ”¹ä¸ºè‡ªå·±å®‰è£…frpcçš„ç»å¯¹è·¯å¾„ Restart= always RestartSec=1min [Install] WantedBy=multi-user.target å¼€å¯è‡ªå¯åŠ¨ æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ #å¯åŠ¨frpc sudo systemctl daemon-reload sudo systemctl start frpc #è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨ sudo systemctl enable frpc åã€å¤æ‚é…ç½® ä»¥ä¸‹é…ç½®ä¸­å¯†ç å’Œå…¬ç½‘IPéƒ½ä½¿ç”¨XXè¿›è¡Œäº†ä»£æ›¿ï¼Œå¤åˆ¶ä½¿ç”¨æ—¶è¯·æ³¨æ„ä¿®æ”¹ è¿œç¨‹æœåŠ¡ç«¯frps.ini [common] # frpç›‘å¬çš„ç«¯å£ï¼Œé»˜è®¤æ˜¯7000 bind_port = 7000 # æˆæƒç ,è¯·è‡ªå®šä¹‰æ›´æ”¹ token = XXXXX # è¿™ä¸ªtokenä¹‹ååœ¨å®¢æˆ·ç«¯ä¼šç”¨åˆ° # frpç®¡ç†åå°ç«¯å£ï¼Œè¯·æŒ‰è‡ªå·±éœ€æ±‚æ›´æ”¹ dashboard_port = 7500 # frpç®¡ç†åå°ç”¨æˆ·åå’Œå¯†ç ï¼Œè¯·æ”¹æˆè‡ªå·±çš„ dashboard_user = admin dashboard_pwd = XXXXX enable_prometheus = true # frpæ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frps.log log_level = info log_max_days = 7 å®¢æˆ·ç«¯çš„frpc.iniæ–‡ä»¶ [common] # è¿œç¨‹æœåŠ¡å™¨ipï¼Œè¿œç¨‹frpæœåŠ¡ç«¯å£ä»¥åŠè¿œç¨‹ç™»å½•å¯†ç  server_addr = 119.XX.XX.119 server_port = 7000 token = XXXXX # æ—¥å¿—å­˜æ”¾ä½ç½®ã€æ—¥å¿—ç­‰çº§åŠæ—¥å¿—å­˜å‚¨æœ€å¤§å¤©æ•° log_file = /var/log/frpc.log log_level = info log_max_days = 7 # å°†æœ¬åœ°æœºçš„22ç«¯å£æ˜ å°„è‡³è¿œç¨‹20022ç«¯å£ ä¸­æ‹¬å·å†…[ssh]åªä½œä¸ºæ ‡è¯†ï¼Œå¯è‡ªå®šä¹‰ [ssh] type = tcp local_ip = 127.0.0.1 local_port = 8060 remote_port = 6000 # å°†æœ¬æœºçš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹25901ç«¯å£ [vnc] type = tcp local_ip = 127.0.0.1 local_port = 8000 remote_port = 6001 # å°†æœ¬æœºæ‰€åœ¨å±€åŸŸç½‘å†…çš„192.168.0.129æœºå­çš„5901ç«¯å£æ˜ å°„è‡³è¿œç¨‹55901ç«¯å£ [tsj-vnc] type = tcp local_ip = 192.168.0.129 local_port = 5901 remote_port = 55901 # ä»£ç†æœ¬æœºæ‰€åœ¨çš„å†…ç½‘ï¼Œå³è‹¥ç”¨æˆ·è®¾ç½®ä»£ç†ä¸ºå…¬ç½‘IP+ç«¯å£å³å¯è®¿é—®æœ¬æœºæ‰€åœ¨å†…ç½‘ï¼Œä½¿ç”¨çš„æ˜¯socks5ä»£ç†åè®®ï¼Œplugin_useråŠåé¢çš„å¯è®¾ç½®å¯ä¸è®¾ï¼Œä½†ä¸è®¾çš„é£é™©è¾ƒå¤§ [socks5_proxy] type = tcp remote_port = 7890 plugin = socks5 plugin = socks5 plugin_user = name plugin_passwd = password use_encryption = true use_compression = true é‡å¯frpæœåŠ¡ ","date":"2024-11-06","objectID":"/posts/mt-photos/:0:0","tags":["blog","ç½‘ç»œé…ç½®"],"title":"MT-Photos","uri":"/posts/mt-photos/#docker-é…ç½®"},{"categories":"å­¦ä¹ æ€»ç»“","collections":null,"content":"ã€Android Frameworkç³»åˆ—ã€‘ç¬¬3ç«  Zygoteè¿›ç¨‹ç›¸å…³_android zygoteè¿›ç¨‹-CSDNåšå®¢ 1 Zygoteç®€ä»‹ Zygoteæ˜¯Androidä¸­æœ€é‡è¦çš„ä¸€ä¸ªè¿›ç¨‹ï¼ŒZygoteè¿›ç¨‹å’ŒInitè¿›ç¨‹ã€SystemServerè¿›ç¨‹æ˜¯Androidæœ€é‡è¦çš„ä¸‰å¤§è¿›ç¨‹ã€‚Zygoteæ˜¯Androidç³»ç»Ÿåˆ›å»ºæ–°è¿›ç¨‹çš„æ ¸å¿ƒè¿›ç¨‹ï¼Œè´Ÿè´£å¯åŠ¨Dalvikè™šæ‹Ÿæœºï¼ŒåŠ è½½ä¸€äº›å¿…è¦çš„ç³»ç»Ÿèµ„æºå’Œç³»ç»Ÿç±»ï¼Œå¯åŠ¨system_serverè¿›ç¨‹ï¼Œéšåè¿›å…¥ç­‰å¾…å¤„ç†appåº”ç”¨è¯·æ±‚ã€‚ åœ¨Androidç³»ç»Ÿä¸­ï¼Œåº”ç”¨ç¨‹åºè¿›ç¨‹éƒ½æ˜¯ç”±Zygoteè¿›ç¨‹å­µåŒ–å‡ºæ¥çš„ï¼Œè€ŒZygoteè¿›ç¨‹æ˜¯ç”±Initè¿›ç¨‹å¯åŠ¨çš„ã€‚Zygoteè¿›ç¨‹åœ¨å¯åŠ¨æ—¶ä¼šåˆ›å»ºä¸€ä¸ªDalvikè™šæ‹Ÿæœºå®ä¾‹ï¼Œæ¯å½“å®ƒå­µåŒ–ä¸€ä¸ªæ–°çš„åº”ç”¨ç¨‹åºè¿›ç¨‹æ—¶ï¼Œéƒ½ä¼šå°†è¿™ä¸ªDalvikè™šæ‹Ÿæœºå®ä¾‹å¤åˆ¶åˆ°æ–°çš„åº”ç”¨ç¨‹åºè¿›ç¨‹é‡Œé¢å»ï¼Œä»è€Œä½¿å¾—æ¯ä¸€ä¸ªåº”ç”¨ç¨‹åºè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„Dalvikè™šæ‹Ÿæœºå®ä¾‹ã€‚ Zygoteæ¶‰åŠçš„ç±»ï¼š frameworks/base/cmds/app_process/app_main.cpp frameworks/base/core/jni/AndroidRuntime.cpp frameworks/base/core/java/com/android/internal/os/ - Zygote.java - ZygoteInit.java - ZygoteServer.java - ZygoteConnection.java ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:1:0","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#1-zygoteç®€ä»‹"},{"categories":"å­¦ä¹ æ€»ç»“","collections":null,"content":"2 Zygoteå¯åŠ¨ æœ¬æ–‡åŸºäºAndroid10ï¼ˆQï¼‰çš„æºç åšåˆ†æ ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:2:0","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#2-zygoteå¯åŠ¨"},{"categories":"å­¦ä¹ æ€»ç»“","collections":null,"content":"2.1 initè¿›ç¨‹è§£æinit.rcè„šæœ¬ Zygoteç”±initè¿›ç¨‹è§£æinit.rcè„šæœ¬å¯åŠ¨çš„ã€‚è„šæœ¬ä¼ å…¥app_processçš„mainæ–¹æ³•åšåˆ†å‰²ï¼Œæ ¹æ®å­—ç¬¦ä¸²å‘½ä»¤åšç›¸åº”é€»è¾‘ã€‚ ç°åœ¨æœºå™¨åˆ†ä¸º32ä½å’Œ64ä½ï¼ŒZygoteçš„å¯åŠ¨è„šæœ¬init.rcä¹Ÿå„æœ‰åŒºåˆ«: init.zygote32.rcï¼šzygoteè¿›ç¨‹å¯¹åº”çš„æ‰§è¡Œç¨‹åºæ˜¯app_process(çº¯32bitæ¨¡å¼) init.zygote64.rcï¼šzygoteè¿›ç¨‹å¯¹åº”çš„æ‰§è¡Œç¨‹åºæ˜¯app_process64(çº¯64bitæ¨¡å¼) init.zygote32_64.rcï¼šå¯åŠ¨ä¸¤ä¸ªzygoteè¿›ç¨‹ï¼Œå¯¹åº”çš„æ‰§è¡Œç¨‹åºåˆ†åˆ«æ˜¯app_process32(ä¸»æ¨¡å¼)ã€app_process64 init.zygote64_32.rcï¼šå¯åŠ¨ä¸¤ä¸ªzygoteè¿›ç¨‹ï¼Œå¯¹åº”çš„æ‰§è¡Œç¨‹åºåˆ†åˆ«æ˜¯app_process64(ä¸»æ¨¡å¼)ã€app_process32 zygoteè¦æ‰§è¡Œçš„ç¨‹åºä¾¿æ˜¯system/bin/app_processï¼Œå®ƒçš„æºä»£ç åœ¨app_main.cppã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹app_mainæ˜¯å¦‚ä½•å¤„ç†è„šæœ¬å‘½ä»¤ï¼š frameworks/base/cmds/app_process/app_main.cpp 165 #if defined(__LP64__) 166 static const char ABI_LIST_PROPERTY[] = \"ro.product.cpu.abilist64\"; 167 static const char ZYGOTE_NICE_NAME[] = \"zygote64\"; 168 #else 169 static const char ABI_LIST_PROPERTY[] = \"ro.product.cpu.abilist32\"; 170 static const char ZYGOTE_NICE_NAME[] = \"zygote\"; 171 #endif 172 173 int main(int argc, char* const argv[]) 174 { ...... 256 // Parse runtime arguments. Stop at first unrecognized option. 257 bool zygote = false; 258 bool startSystemServer = false; 259 bool application = false; 260 String8 niceName; 261 String8 className; 262 263 ++i; // Skip unused \"parent dir\" argument. 264 while (i \u003c argc) { 265 const char* arg = argv[i++]; 266 if (strcmp(arg, \"--zygote\") == 0) { 267 zygote = true; 268 niceName = ZYGOTE_NICE_NAME; 269 } else if (strcmp(arg, \"--start-system-server\") == 0) { 270 startSystemServer = true; 271 } else if (strcmp(arg, \"--application\") == 0) { 272 application = true; 273 } else if (strncmp(arg, \"--nice-name=\", 12) == 0) { 274 niceName.setTo(arg + 12); 275 } else if (strncmp(arg, \"--\", 2) != 0) { 276 className.setTo(arg); 277 break; 278 } else { 279 --i; 280 break; 281 } 282 } ...... 309 if (startSystemServer) { 310 args.add(String8(\"start-system-server\")); 311 } ...... 331 if (!niceName.isEmpty()) { 332 runtime.setArgv0(niceName.string(), true /* setProcName */); 333 } 334 335 if (zygote) { 336 runtime.start(\"com.android.internal.os.ZygoteInit\", args, zygote); 337 } else if (className) { 338 runtime.start(\"com.android.internal.os.RuntimeInit\", args, zygote); 339 } else { 340 fprintf(stderr, \"Error: no class name or --zygote supplied.\\n\"); 341 app_usage(); 342 LOG_ALWAYS_FATAL(\"app_process: no class name or --zygote supplied.\"); 343 } 344 } æˆ‘ä»¬æ‹¿init.zygote64.rcä¸ºä¾‹ï¼š 1 service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server 2 class main 3 priority -20 4 user root 5 group root readproc reserved_disk 6 socket zygote stream 660 root system 7 socket usap_pool_primary stream 660 root system 8 onrestart write /sys/android_power/request_state wake 9 onrestart write /sys/power/state on 10 onrestart restart audioserver 11 onrestart restart cameraserver 12 onrestart restart media 13 onrestart restart netd 14 onrestart restart wificond 15 writepid /dev/cpuset/foreground/tasks ä¸»è¦æ˜¯è¿™ä¸ªè„šæœ¬å‘½ä»¤ï¼šservice zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server å®é™…ä¸Šä¼šè¢«åˆ†å‰²æˆï¼š serviceï¼šæœåŠ¡æ ‡è¯† zygoteï¼šè¡¨ç¤ºè¦å¼€å¯çš„æœåŠ¡åå­— /system/bin/app_process64ï¼šæœåŠ¡å¯¹åº”çš„è·¯å¾„ -Xzygoteï¼šä½œä¸ºè™šæ‹Ÿæœºå¯åŠ¨æ—¶æ‰€éœ€è¦çš„å‚æ•°,åœ¨AndroidRuntime.cppä¸­çš„ startVm() ä¸­è°ƒç”¨JNI_CreateJavaVM ä½¿ç”¨åˆ° /system/binï¼šä»£è¡¨è™šæ‹Ÿæœºç¨‹åºæ‰€åœ¨ç›®å½•,å› ä¸º app_process å¯ä»¥ä¸å’Œè™šæ‹Ÿæœºåœ¨ä¸€ä¸ªç›®å½•,æ‰€ä»¥ app_process éœ€è¦çŸ¥é“è™šæ‹Ÿæœºæ‰€åœ¨çš„ç›®å½• â€“zygote ï¼šæŒ‡æ˜ä»¥ ZygoteInit ç±»ä½œä¸ºå…¥å£,å¦åˆ™éœ€è¦æŒ‡å®šéœ€è¦æ‰§è¡Œçš„ç±»å â€“start-system-serverï¼šä»…åœ¨æœ‰ â€“zygote å‚æ•°æ—¶å¯ç”¨,å‘ŠçŸ¥ ZygoteInit å¯åŠ¨å®Œæ¯•åå­µåŒ–å‡ºçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹æ˜¯ SystemServer ç¬¬ä¸€ä¸ªifä¸­\"--zygote\"å‘½ä¸­ï¼Œzygoteå˜é‡ç½®ä¸ºtrueè¡¨ç¤ºè¦å¯åŠ¨zygoteè¿›ç¨‹ï¼Œå¹¶å°†è¿›ç¨‹åæ”¹æˆäº†zygoteæˆ–zygote64 ç¬¬äºŒä¸ªifä¸­\"--start-system-server\"å‘½ä¸­ï¼ŒstartSystemServerå˜é‡ç½®ä¸ºtrueè¡¨ç¤ºè¦å¯åŠ¨SystemServerè¿›ç¨‹ app_main.cppçš„mainæ–¹æ³•æ‰§è¡Œåï¼ŒZygoteInitå·²ç»é€šè¿‡runtime.start(\"com.android.internal.os.ZygoteInit\", args, zygote);è¢«å¯åŠ¨äº† ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:2:1","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#21-initè¿›ç¨‹è§£æinitrcè„šæœ¬"},{"categories":"å­¦ä¹ æ€»ç»“","collections":null,"content":"2.2 AndroidRuntimeå¯åŠ¨ZygoteInit å…¶ä¸­runtimeå°±æ˜¯AndroidRuntimeç±»ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹AndroidRuntimeçš„startæ–¹æ³•ï¼š /frameworks/base/core/jni/AndroidRuntime.cpp 1112 java/* 1113 * Start the Android runtime. This involves starting the virtual machine 1114 * and calling the \"static void main(String[] args)\" method in the class 1115 * named by \"className\". 1116 * 1117 * Passes the main function two arguments, the class name and the specified 1118 * options string. 1119 */ 1120 void AndroidRuntime::start(const char* className, const Vector\u003cString8\u003e\u0026 options, bool zygote) 1121 { ...... 1164 /* start the virtual machine */ 1165 JniInvocation jni_invocation; 1166 jni_invocation.Init(NULL); 1167 JNIEnv* env; 1168 if (startVm(\u0026mJavaVM, \u0026env, zygote) != 0) { 1169 return; 1170 } 1171 onVmCreated(env); 1172 1173 /* 1174 * Register android functions. 1175 */ 1176 if (startReg(env) \u003c 0) { 1177 ALOGE(\"Unable to register all android natives\\n\"); 1178 return; 1179 } ...... 1203 1204 /* 1205 * Start VM. This thread becomes the main thread of the VM, and will 1206 * not return until the VM exits. 1207 */ 1208 char* slashClassName = toSlashClassName(className != NULL ? className : \"\"); 1209 jclass startClass = env-\u003eFindClass(slashClassName); 1210 if (startClass == NULL) { 1211 ALOGE(\"JavaVM unable to locate class '%s'\\n\", slashClassName); 1212 /* keep going */ 1213 } else { 1214 jmethodID startMeth = env-\u003eGetStaticMethodID(startClass, \"main\", 1215 \"([Ljava/lang/String;)V\"); 1216 if (startMeth == NULL) { 1217 ALOGE(\"JavaVM unable to find main() in '%s'\\n\", className); 1218 /* keep going */ 1219 } else { 1220 env-\u003eCallStaticVoidMethod(startClass, startMeth, strArray); 1226 } 1227 } ...... 1235 } å¯¹è™šæ‹Ÿæœºå’ŒJNIæ–¹æ³•çš„ä¸€äº›æ³¨å†Œåï¼Œé€šè¿‡CallStaticVoidMethodæ¥è°ƒç”¨ä¼ è¿‡æ¥çš„ç±»åçš„mainå‡½æ•°ï¼Œæˆ‘ä»¬ä¼ é€’è¿‡æ¥çš„ç±»åæ˜¯com.android.internal.os.ZygoteInit AndroidRuntimeä¸­ä¸»è¦åšäº†è¿™ä¸‰ä»¶äº‹ï¼š startVm() åˆ›å»ºè™šæ‹Ÿæœº startReg() åŠ¨æ€æ³¨å†Œ java è°ƒç”¨ native çš„ jni åå°„è°ƒç”¨ ZygoteInit çš„ main() ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:2:2","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#22-androidruntimeå¯åŠ¨zygoteinit"},{"categories":"å­¦ä¹ æ€»ç»“","collections":null,"content":"2.3 ZygoteInitåˆå§‹åŒ– AndroidRuntimeåœ¨Nativeå±‚åˆ›å»ºäº†Zygoteï¼Œå¹¶ä¸”é€šè¿‡AndroidRuntime.start()ä»Nativeå±‚è½¬åˆ°Javaå±‚ZygoteInitçš„main()å…¥å£ï¼ŒZygoteInitçš„main()æ–¹æ³•æ˜¯Androidå¯åŠ¨çš„ç¬¬ä¸€ä¸ªJavaè¿›ç¨‹ä¸»æ–¹æ³• /frameworks/base/core/java/com/android/internal/os/ZygoteInit.java 818 @UnsupportedAppUsage 819 public static void main(String argv[]) { 820 ZygoteServer zygoteServer = null; ...... 833 Runnable caller; 834 try { ...... 847 boolean startSystemServer = false; 848 String zygoteSocketName = \"zygote\"; 849 String abiList = null; 850 boolean enableLazyPreload = false; 851 for (int i = 1; i \u003c argv.length; i++) { 852 if (\"start-system-server\".equals(argv[i])) { 853 startSystemServer = true; 854 } else if (\"--enable-lazy-preload\".equals(argv[i])) { 855 enableLazyPreload = true; 856 } else if (argv[i].startsWith(ABI_LIST_ARG)) { 857 abiList = argv[i].substring(ABI_LIST_ARG.length()); 858 } else if (argv[i].startsWith(SOCKET_NAME_ARG)) { 859 zygoteSocketName = argv[i].substring(SOCKET_NAME_ARG.length()); 860 } else { 861 throw new RuntimeException(\"Unknown command line argument: \" + argv[i]); 862 } 863 } 864 865 final boolean isPrimaryZygote = zygoteSocketName.equals(Zygote.PRIMARY_SOCKET_NAME); 866 867 if (abiList == null) { 868 throw new RuntimeException(\"No ABI list supplied.\"); 869 } 870 871 // In some configurations, we avoid preloading resources and classes eagerly. 872 // In such cases, we will preload things prior to our first fork. 873 if (!enableLazyPreload) { ...... 877 preload(bootTimingsTraceLog); ...... 881 } else { 882 Zygote.resetNicePriority(); 883 } ...... 896 Zygote.initNativeState(isPrimaryZygote); 897 898 ZygoteHooks.stopZygoteNoThreadCreation(); 899 900 zygoteServer = new ZygoteServer(isPrimaryZygote); 901 902 if (startSystemServer) { 903 Runnable r = forkSystemServer(abiList, zygoteSocketName, zygoteServer); 904 905 // {@code r == null} in the parent (zygote) process, and {@code r != null} in the 906 // child (system_server) process. 907 if (r != null) { 908 r.run(); 909 return; 910 } 911 } 912 913 Log.i(TAG, \"Accepting command socket connections\"); 914 915 // The select loop returns early in the child process after a fork and 916 // loops forever in the zygote. 917 caller = zygoteServer.runSelectLoop(abiList); 918 } catch (Throwable ex) { 919 Log.e(TAG, \"System zygote died with exception\", ex); 920 throw ex; 921 } finally { 922 if (zygoteServer != null) { 923 zygoteServer.closeServerSocket(); 924 } 925 } 926 927 // We're in the child process and have exited the select loop. Proceed to execute the 928 // command. 929 if (caller != null) { 930 caller.run(); 931 } 932 } ä¸»è¦åšäº†3ä»¶äº‹ï¼š preload()é¢„å…ˆåŠ è½½ç³»ç»Ÿèµ„æºï¼Œå¦‚ç³»ç»Ÿç±»ã€èµ„æºã€ç³»ç»Ÿå…±äº«åº“ç­‰ åˆ›å»º ZygoteServerï¼Œå…¶å®å°±æ˜¯ ServerSocket å¾ªç¯ç­‰å¾…é€šçŸ¥ fork å­è¿›ç¨‹ åˆ›å»º SystemServerè¿›ç¨‹ 2.3.1 preload() preload()ï¼šèµ„æºå‡†å¤‡ï¼ŒåŒ…æ‹¬ç±»åŠ è½½ï¼Œèµ„æºåŠ è½½ç­‰ 135 static void preload(TimingsTraceLog bootTimingsTraceLog) { 138 beginPreload(); 141 preloadClasses(); 144 cacheNonBootClasspathClassLoaders(); 147 preloadResources(); 150 nativePreloadAppProcessHALs(); 153 maybePreloadGraphicsDriver(); 155 preloadSharedLibraries(); 156 preloadTextResources(); 157 // Ask the WebViewFactory to do any initialization that must run in the zygote process, 158 // for memory sharing purposes. 159 WebViewFactory.prepareWebViewInZygote(); 160 endPreload(); 161 warmUpJcaProviders(); 164 sPreloadComplete = true; 165 } ...... 244 /** 245 * Performs Zygote process initialization. Loads and initializes commonly used classes. 246 * 247 * Most classes only cause a few hundred bytes to be allocated, but a few will allocate a dozen 248 * Kbytes (in one case, 500+K). 249 */ 250 private static void preloadClasses() { 251 final VMRuntime runtime = VMRuntime.getRuntime(); 252 253 InputStream is; 254 try { 255 is = new FileInputStream(PRELOADED_CLASSES); 256 } catch (FileNotFoundException e) { 257 Log.e(TAG, \"Couldn't find \" + PRELOADED_CLASSES + \".\"); 258 return; 259 } 260 261 Log.i(TAG, \"Preloading classes...\"); 262 long startTime = SystemClock.uptimeMillis(); 263 264 // Drop root perms while running static initializers. 265 final int ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:2:3","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#23-zygoteinitåˆå§‹åŒ–"},{"categories":"å­¦ä¹ æ€»ç»“","collections":null,"content":"2.3 ZygoteInitåˆå§‹åŒ– AndroidRuntimeåœ¨Nativeå±‚åˆ›å»ºäº†Zygoteï¼Œå¹¶ä¸”é€šè¿‡AndroidRuntime.start()ä»Nativeå±‚è½¬åˆ°Javaå±‚ZygoteInitçš„main()å…¥å£ï¼ŒZygoteInitçš„main()æ–¹æ³•æ˜¯Androidå¯åŠ¨çš„ç¬¬ä¸€ä¸ªJavaè¿›ç¨‹ä¸»æ–¹æ³• /frameworks/base/core/java/com/android/internal/os/ZygoteInit.java 818 @UnsupportedAppUsage 819 public static void main(String argv[]) { 820 ZygoteServer zygoteServer = null; ...... 833 Runnable caller; 834 try { ...... 847 boolean startSystemServer = false; 848 String zygoteSocketName = \"zygote\"; 849 String abiList = null; 850 boolean enableLazyPreload = false; 851 for (int i = 1; i \u003c argv.length; i++) { 852 if (\"start-system-server\".equals(argv[i])) { 853 startSystemServer = true; 854 } else if (\"--enable-lazy-preload\".equals(argv[i])) { 855 enableLazyPreload = true; 856 } else if (argv[i].startsWith(ABI_LIST_ARG)) { 857 abiList = argv[i].substring(ABI_LIST_ARG.length()); 858 } else if (argv[i].startsWith(SOCKET_NAME_ARG)) { 859 zygoteSocketName = argv[i].substring(SOCKET_NAME_ARG.length()); 860 } else { 861 throw new RuntimeException(\"Unknown command line argument: \" + argv[i]); 862 } 863 } 864 865 final boolean isPrimaryZygote = zygoteSocketName.equals(Zygote.PRIMARY_SOCKET_NAME); 866 867 if (abiList == null) { 868 throw new RuntimeException(\"No ABI list supplied.\"); 869 } 870 871 // In some configurations, we avoid preloading resources and classes eagerly. 872 // In such cases, we will preload things prior to our first fork. 873 if (!enableLazyPreload) { ...... 877 preload(bootTimingsTraceLog); ...... 881 } else { 882 Zygote.resetNicePriority(); 883 } ...... 896 Zygote.initNativeState(isPrimaryZygote); 897 898 ZygoteHooks.stopZygoteNoThreadCreation(); 899 900 zygoteServer = new ZygoteServer(isPrimaryZygote); 901 902 if (startSystemServer) { 903 Runnable r = forkSystemServer(abiList, zygoteSocketName, zygoteServer); 904 905 // {@code r == null} in the parent (zygote) process, and {@code r != null} in the 906 // child (system_server) process. 907 if (r != null) { 908 r.run(); 909 return; 910 } 911 } 912 913 Log.i(TAG, \"Accepting command socket connections\"); 914 915 // The select loop returns early in the child process after a fork and 916 // loops forever in the zygote. 917 caller = zygoteServer.runSelectLoop(abiList); 918 } catch (Throwable ex) { 919 Log.e(TAG, \"System zygote died with exception\", ex); 920 throw ex; 921 } finally { 922 if (zygoteServer != null) { 923 zygoteServer.closeServerSocket(); 924 } 925 } 926 927 // We're in the child process and have exited the select loop. Proceed to execute the 928 // command. 929 if (caller != null) { 930 caller.run(); 931 } 932 } ä¸»è¦åšäº†3ä»¶äº‹ï¼š preload()é¢„å…ˆåŠ è½½ç³»ç»Ÿèµ„æºï¼Œå¦‚ç³»ç»Ÿç±»ã€èµ„æºã€ç³»ç»Ÿå…±äº«åº“ç­‰ åˆ›å»º ZygoteServerï¼Œå…¶å®å°±æ˜¯ ServerSocket å¾ªç¯ç­‰å¾…é€šçŸ¥ fork å­è¿›ç¨‹ åˆ›å»º SystemServerè¿›ç¨‹ 2.3.1 preload() preload()ï¼šèµ„æºå‡†å¤‡ï¼ŒåŒ…æ‹¬ç±»åŠ è½½ï¼Œèµ„æºåŠ è½½ç­‰ 135 static void preload(TimingsTraceLog bootTimingsTraceLog) { 138 beginPreload(); 141 preloadClasses(); 144 cacheNonBootClasspathClassLoaders(); 147 preloadResources(); 150 nativePreloadAppProcessHALs(); 153 maybePreloadGraphicsDriver(); 155 preloadSharedLibraries(); 156 preloadTextResources(); 157 // Ask the WebViewFactory to do any initialization that must run in the zygote process, 158 // for memory sharing purposes. 159 WebViewFactory.prepareWebViewInZygote(); 160 endPreload(); 161 warmUpJcaProviders(); 164 sPreloadComplete = true; 165 } ...... 244 /** 245 * Performs Zygote process initialization. Loads and initializes commonly used classes. 246 * 247 * Most classes only cause a few hundred bytes to be allocated, but a few will allocate a dozen 248 * Kbytes (in one case, 500+K). 249 */ 250 private static void preloadClasses() { 251 final VMRuntime runtime = VMRuntime.getRuntime(); 252 253 InputStream is; 254 try { 255 is = new FileInputStream(PRELOADED_CLASSES); 256 } catch (FileNotFoundException e) { 257 Log.e(TAG, \"Couldn't find \" + PRELOADED_CLASSES + \".\"); 258 return; 259 } 260 261 Log.i(TAG, \"Preloading classes...\"); 262 long startTime = SystemClock.uptimeMillis(); 263 264 // Drop root perms while running static initializers. 265 final int ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:2:3","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#231-preload"},{"categories":"å­¦ä¹ æ€»ç»“","collections":null,"content":"2.3 ZygoteInitåˆå§‹åŒ– AndroidRuntimeåœ¨Nativeå±‚åˆ›å»ºäº†Zygoteï¼Œå¹¶ä¸”é€šè¿‡AndroidRuntime.start()ä»Nativeå±‚è½¬åˆ°Javaå±‚ZygoteInitçš„main()å…¥å£ï¼ŒZygoteInitçš„main()æ–¹æ³•æ˜¯Androidå¯åŠ¨çš„ç¬¬ä¸€ä¸ªJavaè¿›ç¨‹ä¸»æ–¹æ³• /frameworks/base/core/java/com/android/internal/os/ZygoteInit.java 818 @UnsupportedAppUsage 819 public static void main(String argv[]) { 820 ZygoteServer zygoteServer = null; ...... 833 Runnable caller; 834 try { ...... 847 boolean startSystemServer = false; 848 String zygoteSocketName = \"zygote\"; 849 String abiList = null; 850 boolean enableLazyPreload = false; 851 for (int i = 1; i \u003c argv.length; i++) { 852 if (\"start-system-server\".equals(argv[i])) { 853 startSystemServer = true; 854 } else if (\"--enable-lazy-preload\".equals(argv[i])) { 855 enableLazyPreload = true; 856 } else if (argv[i].startsWith(ABI_LIST_ARG)) { 857 abiList = argv[i].substring(ABI_LIST_ARG.length()); 858 } else if (argv[i].startsWith(SOCKET_NAME_ARG)) { 859 zygoteSocketName = argv[i].substring(SOCKET_NAME_ARG.length()); 860 } else { 861 throw new RuntimeException(\"Unknown command line argument: \" + argv[i]); 862 } 863 } 864 865 final boolean isPrimaryZygote = zygoteSocketName.equals(Zygote.PRIMARY_SOCKET_NAME); 866 867 if (abiList == null) { 868 throw new RuntimeException(\"No ABI list supplied.\"); 869 } 870 871 // In some configurations, we avoid preloading resources and classes eagerly. 872 // In such cases, we will preload things prior to our first fork. 873 if (!enableLazyPreload) { ...... 877 preload(bootTimingsTraceLog); ...... 881 } else { 882 Zygote.resetNicePriority(); 883 } ...... 896 Zygote.initNativeState(isPrimaryZygote); 897 898 ZygoteHooks.stopZygoteNoThreadCreation(); 899 900 zygoteServer = new ZygoteServer(isPrimaryZygote); 901 902 if (startSystemServer) { 903 Runnable r = forkSystemServer(abiList, zygoteSocketName, zygoteServer); 904 905 // {@code r == null} in the parent (zygote) process, and {@code r != null} in the 906 // child (system_server) process. 907 if (r != null) { 908 r.run(); 909 return; 910 } 911 } 912 913 Log.i(TAG, \"Accepting command socket connections\"); 914 915 // The select loop returns early in the child process after a fork and 916 // loops forever in the zygote. 917 caller = zygoteServer.runSelectLoop(abiList); 918 } catch (Throwable ex) { 919 Log.e(TAG, \"System zygote died with exception\", ex); 920 throw ex; 921 } finally { 922 if (zygoteServer != null) { 923 zygoteServer.closeServerSocket(); 924 } 925 } 926 927 // We're in the child process and have exited the select loop. Proceed to execute the 928 // command. 929 if (caller != null) { 930 caller.run(); 931 } 932 } ä¸»è¦åšäº†3ä»¶äº‹ï¼š preload()é¢„å…ˆåŠ è½½ç³»ç»Ÿèµ„æºï¼Œå¦‚ç³»ç»Ÿç±»ã€èµ„æºã€ç³»ç»Ÿå…±äº«åº“ç­‰ åˆ›å»º ZygoteServerï¼Œå…¶å®å°±æ˜¯ ServerSocket å¾ªç¯ç­‰å¾…é€šçŸ¥ fork å­è¿›ç¨‹ åˆ›å»º SystemServerè¿›ç¨‹ 2.3.1 preload() preload()ï¼šèµ„æºå‡†å¤‡ï¼ŒåŒ…æ‹¬ç±»åŠ è½½ï¼Œèµ„æºåŠ è½½ç­‰ 135 static void preload(TimingsTraceLog bootTimingsTraceLog) { 138 beginPreload(); 141 preloadClasses(); 144 cacheNonBootClasspathClassLoaders(); 147 preloadResources(); 150 nativePreloadAppProcessHALs(); 153 maybePreloadGraphicsDriver(); 155 preloadSharedLibraries(); 156 preloadTextResources(); 157 // Ask the WebViewFactory to do any initialization that must run in the zygote process, 158 // for memory sharing purposes. 159 WebViewFactory.prepareWebViewInZygote(); 160 endPreload(); 161 warmUpJcaProviders(); 164 sPreloadComplete = true; 165 } ...... 244 /** 245 * Performs Zygote process initialization. Loads and initializes commonly used classes. 246 * 247 * Most classes only cause a few hundred bytes to be allocated, but a few will allocate a dozen 248 * Kbytes (in one case, 500+K). 249 */ 250 private static void preloadClasses() { 251 final VMRuntime runtime = VMRuntime.getRuntime(); 252 253 InputStream is; 254 try { 255 is = new FileInputStream(PRELOADED_CLASSES); 256 } catch (FileNotFoundException e) { 257 Log.e(TAG, \"Couldn't find \" + PRELOADED_CLASSES + \".\"); 258 return; 259 } 260 261 Log.i(TAG, \"Preloading classes...\"); 262 long startTime = SystemClock.uptimeMillis(); 263 264 // Drop root perms while running static initializers. 265 final int ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:2:3","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#232-zygoteserver"},{"categories":"å­¦ä¹ æ€»ç»“","collections":null,"content":"2.3 ZygoteInitåˆå§‹åŒ– AndroidRuntimeåœ¨Nativeå±‚åˆ›å»ºäº†Zygoteï¼Œå¹¶ä¸”é€šè¿‡AndroidRuntime.start()ä»Nativeå±‚è½¬åˆ°Javaå±‚ZygoteInitçš„main()å…¥å£ï¼ŒZygoteInitçš„main()æ–¹æ³•æ˜¯Androidå¯åŠ¨çš„ç¬¬ä¸€ä¸ªJavaè¿›ç¨‹ä¸»æ–¹æ³• /frameworks/base/core/java/com/android/internal/os/ZygoteInit.java 818 @UnsupportedAppUsage 819 public static void main(String argv[]) { 820 ZygoteServer zygoteServer = null; ...... 833 Runnable caller; 834 try { ...... 847 boolean startSystemServer = false; 848 String zygoteSocketName = \"zygote\"; 849 String abiList = null; 850 boolean enableLazyPreload = false; 851 for (int i = 1; i \u003c argv.length; i++) { 852 if (\"start-system-server\".equals(argv[i])) { 853 startSystemServer = true; 854 } else if (\"--enable-lazy-preload\".equals(argv[i])) { 855 enableLazyPreload = true; 856 } else if (argv[i].startsWith(ABI_LIST_ARG)) { 857 abiList = argv[i].substring(ABI_LIST_ARG.length()); 858 } else if (argv[i].startsWith(SOCKET_NAME_ARG)) { 859 zygoteSocketName = argv[i].substring(SOCKET_NAME_ARG.length()); 860 } else { 861 throw new RuntimeException(\"Unknown command line argument: \" + argv[i]); 862 } 863 } 864 865 final boolean isPrimaryZygote = zygoteSocketName.equals(Zygote.PRIMARY_SOCKET_NAME); 866 867 if (abiList == null) { 868 throw new RuntimeException(\"No ABI list supplied.\"); 869 } 870 871 // In some configurations, we avoid preloading resources and classes eagerly. 872 // In such cases, we will preload things prior to our first fork. 873 if (!enableLazyPreload) { ...... 877 preload(bootTimingsTraceLog); ...... 881 } else { 882 Zygote.resetNicePriority(); 883 } ...... 896 Zygote.initNativeState(isPrimaryZygote); 897 898 ZygoteHooks.stopZygoteNoThreadCreation(); 899 900 zygoteServer = new ZygoteServer(isPrimaryZygote); 901 902 if (startSystemServer) { 903 Runnable r = forkSystemServer(abiList, zygoteSocketName, zygoteServer); 904 905 // {@code r == null} in the parent (zygote) process, and {@code r != null} in the 906 // child (system_server) process. 907 if (r != null) { 908 r.run(); 909 return; 910 } 911 } 912 913 Log.i(TAG, \"Accepting command socket connections\"); 914 915 // The select loop returns early in the child process after a fork and 916 // loops forever in the zygote. 917 caller = zygoteServer.runSelectLoop(abiList); 918 } catch (Throwable ex) { 919 Log.e(TAG, \"System zygote died with exception\", ex); 920 throw ex; 921 } finally { 922 if (zygoteServer != null) { 923 zygoteServer.closeServerSocket(); 924 } 925 } 926 927 // We're in the child process and have exited the select loop. Proceed to execute the 928 // command. 929 if (caller != null) { 930 caller.run(); 931 } 932 } ä¸»è¦åšäº†3ä»¶äº‹ï¼š preload()é¢„å…ˆåŠ è½½ç³»ç»Ÿèµ„æºï¼Œå¦‚ç³»ç»Ÿç±»ã€èµ„æºã€ç³»ç»Ÿå…±äº«åº“ç­‰ åˆ›å»º ZygoteServerï¼Œå…¶å®å°±æ˜¯ ServerSocket å¾ªç¯ç­‰å¾…é€šçŸ¥ fork å­è¿›ç¨‹ åˆ›å»º SystemServerè¿›ç¨‹ 2.3.1 preload() preload()ï¼šèµ„æºå‡†å¤‡ï¼ŒåŒ…æ‹¬ç±»åŠ è½½ï¼Œèµ„æºåŠ è½½ç­‰ 135 static void preload(TimingsTraceLog bootTimingsTraceLog) { 138 beginPreload(); 141 preloadClasses(); 144 cacheNonBootClasspathClassLoaders(); 147 preloadResources(); 150 nativePreloadAppProcessHALs(); 153 maybePreloadGraphicsDriver(); 155 preloadSharedLibraries(); 156 preloadTextResources(); 157 // Ask the WebViewFactory to do any initialization that must run in the zygote process, 158 // for memory sharing purposes. 159 WebViewFactory.prepareWebViewInZygote(); 160 endPreload(); 161 warmUpJcaProviders(); 164 sPreloadComplete = true; 165 } ...... 244 /** 245 * Performs Zygote process initialization. Loads and initializes commonly used classes. 246 * 247 * Most classes only cause a few hundred bytes to be allocated, but a few will allocate a dozen 248 * Kbytes (in one case, 500+K). 249 */ 250 private static void preloadClasses() { 251 final VMRuntime runtime = VMRuntime.getRuntime(); 252 253 InputStream is; 254 try { 255 is = new FileInputStream(PRELOADED_CLASSES); 256 } catch (FileNotFoundException e) { 257 Log.e(TAG, \"Couldn't find \" + PRELOADED_CLASSES + \".\"); 258 return; 259 } 260 261 Log.i(TAG, \"Preloading classes...\"); 262 long startTime = SystemClock.uptimeMillis(); 263 264 // Drop root perms while running static initializers. 265 final int ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:2:3","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#233-åˆ›å»ºsystemserverè¿›ç¨‹"},{"categories":"å­¦ä¹ æ€»ç»“","collections":null,"content":"2.4 Zygoteå¯åŠ¨æµç¨‹å›¾ ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:2:4","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#24-zygoteå¯åŠ¨æµç¨‹å›¾"},{"categories":"å­¦ä¹ æ€»ç»“","collections":null,"content":"3 æ€»ç»“ æ‰€æœ‰çš„è¿›ç¨‹éƒ½ç”±Zygoteåˆ›å»ºï¼Œzygoteä¸»è¦ç”¨æ¥å­µåŒ–system_serverè¿›ç¨‹å’Œåº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚åœ¨å­µåŒ–å‡ºç¬¬ä¸€ä¸ªè¿›ç¨‹system_serveråé€šè¿‡runSelectLoopç­‰å¾…å¹¶å¤„ç†æ¶ˆæ¯ï¼Œåˆ†è£‚åº”ç”¨ç¨‹åºè¿›ç¨‹ä»ç”±system_serveræ§åˆ¶ï¼Œç­‰å¾… AMS ç»™ä»–å‘æ¶ˆæ¯ï¼ˆå‘Šè¯‰ zygote åˆ›å»ºè¿›ç¨‹ï¼‰ï¼Œå¦‚appå¯åŠ¨æ—¶åˆ›å»ºå­è¿›ç¨‹ã€‚ ä»AndroidRuntimeåˆ°ZygoteInitï¼Œä¸»è¦åˆ†ä¸º3å¤§è¿‡ç¨‹ï¼š 1ã€åˆ›å»ºè™šæ‹Ÿæœºâ€”â€”startVm():è°ƒç”¨JNIè™šæ‹Ÿæœºåˆ›å»ºå‡½æ•° 2ã€æ³¨å†ŒJNIå‡½æ•°â€”â€”startReg()ï¼šå‰é¢å·²ç»åˆ›å»ºè™šæ‹Ÿæœºï¼Œè¿™é‡Œç»™è¿™ä¸ªè™šæ‹Ÿæœºæ³¨å†Œä¸€äº›JNIå‡½æ•°ï¼ˆåç»­javaä¸–ç•Œç”¨åˆ°çš„å‡½æ•°æ˜¯nativeå®ç°ï¼Œè¿™é‡Œéœ€è¦æå‰æ³¨å†Œæ³¨å†Œè¿™äº›å‡½æ•°ï¼‰ 3ã€æ­¤æ—¶å°±è¦æ‰§è¡ŒCallStaticViodMethodï¼Œé€šè¿‡è¿™ä¸ªå‡½æ•°å°†è¿›å…¥androidç²¾å¿ƒæ‰“é€ çš„javaä¸–ç•Œï¼Œè¿™ä¸ªå‡½æ•°å°†è°ƒç”¨com.android.internal.os.ZygoteInitçš„mainå‡½æ•° åœ¨ ZygoteInit.mainå‡½æ•°ä¸­è¿›å…¥Javaä¸–ç•Œï¼Œä¸»è¦æœ‰4ä¸ªå…³é”®æ­¥éª¤ï¼š 1ã€é¢„åŠ è½½ç±»å’Œèµ„æºâ€”â€”preload() ä¸»è¦æ˜¯preloadClasseså’ŒpreloadResourcesï¼Œå…¶ä¸­preloadClassesä¸€èˆ¬æ˜¯åŠ è½½æ—¶é—´è¶…è¿‡1250msçš„ç±»ï¼Œå› è€Œéœ€è¦åœ¨zygoteé¢„åŠ è½½ 2ã€å»ºç«‹IPCé€šä¿¡æœåŠ¡â€”â€”åˆå§‹åŒ–ZygoteServerï¼Œå†…éƒ¨åˆå§‹åŒ–äº†ZygoteSocket zygoteåŠç³»ç»Ÿä¸­å…¶ä»–ç¨‹åºçš„é€šä¿¡å¹¶æ²¡æœ‰ä½¿ç”¨Binderï¼Œè€Œæ˜¯é‡‡ç”¨åŸºäºAF_UNIXç±»å‹çš„Socketï¼Œä½œç”¨æ­£æ˜¯å»ºç«‹è¿™ä¸ªSocket 3ã€å¯åŠ¨system_serverâ€”â€”forkSystemServer() è¿™ä¸ªå‡½æ•°ä¼šåˆ›å»ºJavaä¸–ç•Œä¸­ç³»ç»ŸServiceæ‰€é©»ç•™çš„è¿›ç¨‹system_server,è¯¥è¿›ç¨‹æ˜¯frameworkçš„æ ¸å¿ƒï¼Œä¹Ÿæ˜¯zygoteå­µåŒ–å‡ºçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ã€‚å¦‚æœå®ƒæ­»äº†ï¼Œå°±ä¼šå¯¼è‡´zygoteè‡ªæ€ã€‚ 4ã€ç­‰å¾…è¯·æ±‚â€”â€”runSelectLoop() zygoteä»startSystemServerè¿”å›åï¼Œå°†è¿›å…¥ç¬¬å››ä¸ªå…³é”®å‡½æ•°runSelectLoopï¼Œåœ¨ç¬¬ä¸€ä¸ªå‡½æ•°ZygoteServerä¸­æ³¨å†Œäº†ä¸€ä¸ªç”¨äºIPCçš„Socketå°†åœ¨è¿™é‡Œä½¿ç”¨ï¼Œè¿™é‡ŒZygoteé‡‡ç”¨é«˜æ•ˆçš„I/Oå¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œä¿è¯åœ¨æ²¡æœ‰å®¢æˆ·ç«¯è¯·æ±‚æ—¶æˆ–è€…æ•°æ®å¤„ç†æ—¶ä¼‘çœ ï¼Œå¦åˆ™å“åº”å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚ç­‰å¾… AMS ç»™ä»–å‘æ¶ˆæ¯ï¼ˆå‘Šè¯‰ zygote åˆ›å»ºè¿›ç¨‹ï¼‰ã€‚æ­¤æ—¶zygoteå®Œæˆäº†javaä¸–ç•Œçš„åˆåˆ›å·¥ä½œï¼Œè°ƒç”¨runSelectLoopä¾¿å¼€å§‹ä¼‘çœ äº†ï¼Œå½“æ”¶åˆ°è¯·æ±‚æˆ–è€…æ•°æ®å¤„ç†ä¾¿ä¼šéšæ—¶é†’æ¥ï¼Œç»§ç»­å·¥ä½œã€‚ ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:3:0","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#3-æ€»ç»“"},{"categories":"å­¦ä¹ æ€»ç»“","collections":null,"content":"4 é¢è¯•é¢˜ ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:4:0","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#4-é¢è¯•é¢˜"},{"categories":"å­¦ä¹ æ€»ç»“","collections":null,"content":"1 initè¿›ç¨‹ä½œç”¨æ˜¯ä»€ä¹ˆ initè¿›ç¨‹èµ·ç€æ‰¿ä¸Šå¯ä¸‹çš„ä½œç”¨ï¼ŒAndroidæœ¬èº«æ˜¯åŸºäºLinuxè€Œæ¥çš„ï¼Œinitè¿›ç¨‹æ˜¯Linuxç³»ç»Ÿä¸­ç”¨æˆ·ç©ºé—´çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ã€‚initè¿›ç¨‹å±äºä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ï¼Œå‡†ç¡®çš„è¯´ï¼Œå®ƒæ˜¯Linuxç³»ç»Ÿä¸­ç”¨æˆ·æ§åˆ¶çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œå®ƒçš„è¿›ç¨‹å·ä¸º1ï¼ˆè¿›ç¨‹å·ä¸º0çš„ä¸ºå†…æ ¸è¿›ç¨‹ï¼‰ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸè´¯ç©¿æ•´ä¸ªLinuxå†…æ ¸è¿è¡Œçš„å§‹ç»ˆã€‚Androidä¸­æ‰€æœ‰å…¶å®ƒçš„è¿›ç¨‹å…±åŒçš„é¼»ç¥–å‡ä¸ºinitè¿›ç¨‹ã€‚ Android Q(10.0) çš„initå…¥å£å‡½æ•°ç”±åŸå…ˆçš„init.cpp è°ƒæ•´åˆ°äº†main.cppï¼ŒæŠŠå„ä¸ªé˜¶æ®µçš„æ“ä½œåˆ†ç¦»å¼€æ¥ï¼Œä½¿ä»£ç æ›´åŠ ç®€æ´å‘½ä»¤ã€‚ ä½œä¸ºå¤©å­ç¬¬1å·è¿›ç¨‹ï¼Œinitè¢«èµ‹äºˆäº†å¾ˆå¤šé‡è¦çš„èŒè´£ï¼Œä¸»è¦åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š initè¿›ç¨‹ç¬¬ä¸€é˜¶æ®µåšçš„ä¸»è¦å·¥ä½œæ˜¯æŒ‚è½½åˆ†åŒºï¼Œåˆ›å»ºè®¾å¤‡èŠ‚ç‚¹å’Œä¸€äº›å…³é”®ç›®å½•ï¼Œåˆå§‹åŒ–æ—¥å¿—è¾“å‡ºç³»ç»Ÿ,å¯ç”¨SELinuxå®‰å…¨ç­–ç•¥ã€‚ initè¿›ç¨‹ç¬¬äºŒé˜¶æ®µä¸»è¦å·¥ä½œæ˜¯åˆå§‹åŒ–å±æ€§ç³»ç»Ÿï¼Œè§£æSELinuxçš„åŒ¹é…è§„åˆ™ï¼Œå¤„ç†å­è¿›ç¨‹ç»ˆæ­¢ä¿¡å·ï¼Œå¯åŠ¨ç³»ç»Ÿå±æ€§æœåŠ¡ï¼Œå¯ä»¥è¯´æ¯ä¸€é¡¹éƒ½å¾ˆå…³é”®ï¼Œå¦‚æœè¯´ç¬¬ä¸€é˜¶æ®µæ˜¯ä¸ºå±æ€§ç³»ç»Ÿï¼ŒSELinuxåšå‡†å¤‡ï¼Œé‚£ä¹ˆç¬¬äºŒé˜¶æ®µå°±æ˜¯çœŸæ­£å»æŠŠè¿™äº›åŠŸèƒ½è½å®ã€‚ initè¿›è¡Œç¬¬ä¸‰é˜¶æ®µä¸»è¦æ˜¯è§£æinit.rcæ¥å¯åŠ¨å…¶ä»–è¿›ç¨‹ï¼Œè¿›å…¥æ— é™å¾ªç¯ï¼Œè¿›è¡Œå­è¿›ç¨‹å®æ—¶ç›‘æ§(å®ˆæŠ¤)ã€‚ å…¶ä¸­ç¬¬ä¸‰é˜¶æ®µé€šè¿‡initrcå¯åŠ¨å…¶ä»–è¿›ç¨‹ï¼Œæˆ‘ä»¬å¸¸è§çš„æ¯”å¦‚å¯åŠ¨Zygoteè¿›ç¨‹ã€å¯åŠ¨SeviceManagerè¿›ç¨‹ç­‰ã€‚ ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:4:1","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#1-initè¿›ç¨‹ä½œç”¨æ˜¯ä»€ä¹ˆ"},{"categories":"å­¦ä¹ æ€»ç»“","collections":null,"content":"2 Zygoteè¿›ç¨‹æœ€åŸå§‹çš„è¿›ç¨‹æ˜¯ä»€ä¹ˆè¿›ç¨‹(æˆ–è€…Zygoteè¿›ç¨‹ç”±æ¥) Zygoteæœ€å¼€å§‹æ˜¯app_processï¼Œå®ƒæ˜¯åœ¨ init è¿›ç¨‹å¯åŠ¨æ—¶è¢«å¯åŠ¨çš„ï¼Œåœ¨app_main.cppæ‰è¢«ä¿®æ”¹ä¸º Zygoteã€‚ ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:4:2","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#2-zygoteè¿›ç¨‹æœ€åŸå§‹çš„è¿›ç¨‹æ˜¯ä»€ä¹ˆè¿›ç¨‹æˆ–è€…zygoteè¿›ç¨‹ç”±æ¥"},{"categories":"å­¦ä¹ æ€»ç»“","collections":null,"content":"3 Zygote æ˜¯åœ¨å†…æ ¸ç©ºé—´è¿˜æ˜¯åœ¨ç”¨æˆ·ç©ºé—´ï¼Ÿ å› ä¸º init è¿›ç¨‹çš„åˆ›å»ºåœ¨ç”¨æˆ·ç©ºé—´ï¼Œè€Œ Zygote æ˜¯ç”± init è¿›ç¨‹åˆ›å»ºå¯åŠ¨çš„ï¼Œæ‰€ä»¥Zygoteæ˜¯åœ¨ç”¨æˆ·ç©ºé—´ã€‚ ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:4:3","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#3-zygote-æ˜¯åœ¨å†…æ ¸ç©ºé—´è¿˜æ˜¯åœ¨ç”¨æˆ·ç©ºé—´"},{"categories":"å­¦ä¹ æ€»ç»“","collections":null,"content":"4 Zygoteä¸ºä»€ä¹ˆéœ€è¦ç”¨åˆ°Socketé€šä¿¡è€Œä¸æ˜¯Binder Zygoteæ˜¯Androidä¸­çš„ä¸€ä¸ªé‡è¦è¿›ç¨‹ï¼Œå®ƒæ˜¯å¯åŠ¨åº”ç”¨ç¨‹åºè¿›ç¨‹çš„çˆ¶è¿›ç¨‹ã€‚Zygoteä½¿ç”¨Socketæ¥ä¸åº”ç”¨ç¨‹åºè¿›ç¨‹è¿›è¡Œé€šä¿¡ï¼Œè€Œä¸æ˜¯ä½¿ç”¨Androidä¸­çš„IPCæœºåˆ¶Binderï¼Œè¿™æ˜¯å› ä¸ºSocketå’ŒBinderæœ‰ä¸åŒçš„ä¼˜ç¼ºç‚¹ï¼Œè€Œåœ¨Zygoteè¿›ç¨‹ä¸­ä½¿ç”¨Socketå¯ä»¥æ›´å¥½åœ°æ»¡è¶³Zygoteè¿›ç¨‹çš„éœ€æ±‚ã€‚ Zygote ç”¨ binder é€šä¿¡ä¼šå¯¼è‡´æ­»é” å‡è®¾ Zygote ä½¿ç”¨ Binder é€šä¿¡ï¼Œå› ä¸º Binder æ˜¯æ”¯æŒå¤šçº¿ç¨‹çš„ï¼Œå­˜åœ¨å¹¶å‘é—®é¢˜ï¼Œè€Œå¹¶å‘é—®é¢˜çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯åŠ é”ï¼Œå¦‚æœè¿›ç¨‹ fork æ˜¯åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹è¿è¡Œï¼ŒBinder ç­‰å¾…é”åœ¨é”æœºåˆ¶ä¸‹å°±å¯èƒ½ä¼šå‡ºç°æ­»é”ã€‚ Zygote ç”¨ binder é€šä¿¡ä¼šå¯¼è‡´è¯»å†™é”™è¯¯ æ ¹æœ¬åŸå› åœ¨äºè¦ new ä¸€ä¸ª ProcessState ç”¨äº Binder é€šä¿¡æ—¶ï¼Œéœ€è¦ mmap ç”³è¯·ä¸€ç‰‡å†…å­˜ç”¨ä»¥æä¾›ç»™å†…æ ¸è¿›è¡Œæ•°æ®äº¤æ¢ä½¿ç”¨ã€‚è€Œå¦‚æœç›´æ¥ fork äº†çš„è¯ï¼Œå­è¿›ç¨‹åœ¨è¿›è¡Œ binder é€šä¿¡æ—¶ï¼Œå†…æ ¸è¿˜æ˜¯ä¼šç»§ç»­ä½¿ç”¨çˆ¶è¿›ç¨‹ç”³è¯·çš„åœ°å€å†™æ•°æ®ï¼Œè€Œæ­¤æ—¶ä¼šè§¦å‘å­è¿›ç¨‹ COWï¼ˆCopy on Writeï¼‰ï¼Œä»è€Œå¯¼è‡´åœ°å€ç©ºé—´å·²ç»é‡æ–°æ˜ å°„ï¼Œè€Œå­è¿›ç¨‹è¿˜å°è¯•è®¿é—®ä¹‹å‰çˆ¶è¿›ç¨‹ mmap çš„åœ°å€ï¼Œä¼šå¯¼è‡´ SIGSEGVã€SEGV_MAPERRæ®µé”™è¯¯ã€‚ Zygoteåˆå§‹åŒ–æ—¶ï¼ŒBinderè¿˜æ²¡å¼€å§‹åˆå§‹åŒ–ã€‚ Socketå…·æœ‰è‰¯å¥½çš„è·¨å¹³å°æ€§ï¼Œèƒ½å¤Ÿåœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿå’Œè¯­è¨€ä¹‹é—´è¿›è¡Œé€šä¿¡ã€‚è¿™å¯¹äºZygoteè¿›ç¨‹æ¥è¯´éå¸¸é‡è¦ï¼Œå› ä¸ºå®ƒéœ€è¦åœ¨ä¸åŒçš„è®¾å¤‡å’Œæ¶æ„ä¸Šè¿è¡Œï¼Œå¹¶ä¸”éœ€è¦ä¸ä¸åŒçš„åº”ç”¨ç¨‹åºè¿›ç¨‹è¿›è¡Œé€šä¿¡ã€‚ä½¿ç”¨Socketå¯ä»¥è®©Zygoteè¿›ç¨‹æ›´åŠ çµæ´»å’Œå¯æ‰©å±•ï¼Œå› ä¸ºå®ƒä¸éœ€è¦è€ƒè™‘Binderæ‰€å¸¦æ¥çš„ç‰¹å®šé™åˆ¶å’Œè¦æ±‚ã€‚ Socketå…·æœ‰ç®€å•çš„APIå’Œæ˜“äºä½¿ç”¨çš„ç‰¹ç‚¹ã€‚Zygoteè¿›ç¨‹éœ€è¦å¿«é€Ÿå¯åŠ¨å¹¶ä¸åº”ç”¨ç¨‹åºè¿›ç¨‹å»ºç«‹é€šä¿¡ï¼ŒSocketæä¾›äº†å¿«é€Ÿã€å¯é çš„é€šä¿¡æ–¹å¼ï¼Œå¹¶ä¸”ä½¿ç”¨Socket APIä¹Ÿå¾ˆå®¹æ˜“å®ç°ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒBinderéœ€è¦æ›´å¤šçš„é…ç½®å’Œç»´æŠ¤å·¥ä½œï¼Œè¿™å¯¹äºZygoteè¿›ç¨‹æ¥è¯´å¯èƒ½ä¼šå¢åŠ ä¸å¿…è¦çš„å¤æ‚æ€§å’Œå¼€é”€ã€‚ Socketåœ¨æ•°æ®ä¼ è¾“æ—¶å…·æœ‰æ›´ä½çš„å»¶è¿Ÿå’Œæ›´é«˜çš„ååé‡ï¼Œè¿™å¯¹äºZygoteè¿›ç¨‹æ¥è¯´éå¸¸é‡è¦ã€‚Zygoteè¿›ç¨‹éœ€è¦åœ¨è¾ƒçŸ­çš„æ—¶é—´å†…å¯åŠ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ï¼Œå¹¶ä¸”éœ€è¦ä¼ è¾“å¤§é‡çš„æ•°æ®å’Œä»£ç ï¼ŒSocketçš„é«˜æ€§èƒ½å’Œä½å»¶è¿Ÿä½¿å…¶æˆä¸ºæ›´å¥½çš„é€‰æ‹©ã€‚ æ€»ä¹‹ï¼ŒZygoteè¿›ç¨‹ä½¿ç”¨Socketè€Œä¸æ˜¯Binderæ˜¯åŸºäºå…¶ä¼˜ç‚¹å’Œéœ€æ±‚è€Œåšå‡ºçš„é€‰æ‹©ã€‚è™½ç„¶Binderåœ¨Androidä¸­æ‰®æ¼”ç€é‡è¦çš„è§’è‰²ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½¿ç”¨Socketå¯ä»¥æä¾›æ›´å¥½çš„æ€§èƒ½å’Œæ›´å¤§çš„çµæ´»æ€§ã€‚å†è€…ï¼ŒBinderå½“åˆå¹¶ä¸æˆç†Ÿï¼Œå›¢é˜Ÿæˆå‘˜å¯¹äºè¿›ç¨‹é—´é€šè®¯æ›´å€¾å‘äºç”¨Socketï¼Œåé¢ä¸ºäº†åšäº†å¾ˆå¤šä¼˜åŒ–ï¼Œæ‰ä½¿å¾—Binderé€šè®¯å˜å¾—æˆç†Ÿç¨³å®šã€‚ ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:4:4","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#4-zygoteä¸ºä»€ä¹ˆéœ€è¦ç”¨åˆ°socketé€šä¿¡è€Œä¸æ˜¯binder"},{"categories":"å­¦ä¹ æ€»ç»“","collections":null,"content":"5 æ¯ä¸ªAppéƒ½ä¼šå°†ç³»ç»Ÿçš„èµ„æºï¼Œç³»ç»Ÿçš„ç±»éƒ½åŠ è½½ä¸€éå— zygoteè¿›ç¨‹çš„ä½œç”¨ï¼š 1.åˆ›å»ºä¸€ä¸ªServiceç«¯çš„Socketï¼Œå¼€å¯ä¸€ä¸ªServerSocketå®ç°å’Œåˆ«çš„è¿›ç¨‹é€šä¿¡ã€‚ 2.åŠ è½½ç³»ç»Ÿç±»ï¼Œç³»ç»Ÿèµ„æºã€‚ 3.å¯åŠ¨System Serverè¿›ç¨‹ Zygoteè¿›ç¨‹é¢„åŠ è½½ç³»ç»Ÿèµ„æºåï¼Œç„¶åé€šè¿‡å®ƒå­µåŒ–å‡ºå…¶ä»–çš„è™šæ‹Ÿæœºè¿›ç¨‹ï¼Œè¿›è€Œå…±äº«è™šæ‹Ÿæœºå†…å­˜å’Œæ¡†æ¶å±‚èµ„æºï¼ˆå…±äº«å†…å­˜ï¼‰ï¼Œè¿™æ ·å¤§å¹…åº¦æé«˜åº”ç”¨ç¨‹åºçš„å¯åŠ¨å’Œè¿è¡Œé€Ÿåº¦ã€‚ ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:4:5","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#5-æ¯ä¸ªappéƒ½ä¼šå°†ç³»ç»Ÿçš„èµ„æºç³»ç»Ÿçš„ç±»éƒ½åŠ è½½ä¸€éå—"},{"categories":"å­¦ä¹ æ€»ç»“","collections":null,"content":"6 PMS æ˜¯å¹²ä»€ä¹ˆçš„ï¼Œä½ æ˜¯æ€ä¹ˆç†è§£PMS åŒ…ç®¡ç†ï¼ŒåŒ…è§£æï¼Œç»“æœç¼“å­˜ï¼Œæä¾›æŸ¥è¯¢æ¥å£ã€‚ éå†/data/appçš„æ–‡ä»¶å¤¹ è§£å‹apkæ–‡ä»¶ domè§£æAndroidManifest.xmlæ–‡ä»¶ã€‚ ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:4:6","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#6-pms-æ˜¯å¹²ä»€ä¹ˆçš„ä½ æ˜¯æ€ä¹ˆç†è§£pms"},{"categories":"å­¦ä¹ æ€»ç»“","collections":null,"content":"7 ä¸ºä»€ä¹ˆä¼šæœ‰AMS AMSçš„ä½œç”¨ æŸ¥è¯¢PMS åå°„ç”Ÿæˆå¯¹è±¡ ç®¡ç†Activityç”Ÿå‘½å‘¨æœŸ AMSç¼“å­˜ä¸­å¿ƒï¼šActivityThread ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:4:7","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#7-ä¸ºä»€ä¹ˆä¼šæœ‰ams-amsçš„ä½œç”¨"},{"categories":"å­¦ä¹ æ€»ç»“","collections":null,"content":"8 AMSå¦‚ä½•ç®¡ç†Activityï¼Œæ¢æ¢AMSçš„æ‰§è¡ŒåŸç† Activityåœ¨åº”ç”¨ç«¯ç”±ActivityClientRecordè´Ÿè´£æè¿°å…¶ç”Ÿå‘½å‘¨æœŸçš„è¿‡ç¨‹ä¸çŠ¶æ€ï¼Œä½†æœ€ç»ˆè¿™äº›è¿‡ç¨‹ä¸çŠ¶æ€æ˜¯ç”±ActivityManagerService(ä»¥ä¸‹ç®€ç§°AMS)æ¥ç®¡ç†å’Œæ§åˆ¶çš„ BroadcastRecordï¼šæè¿°äº†åº”ç”¨è¿›ç¨‹çš„BroadcastReceiverï¼Œç”±BroadcastQueueè´Ÿè´£ç®¡ç†ã€‚ ServiceRecordï¼šæè¿°äº†ServiceæœåŠ¡ç»„ä»¶ï¼Œç”±ActiveServicesè´Ÿè´£ç®¡ç†ã€‚ ContentProviderRecordï¼šæè¿°ContentProviderå†…å®¹æä¾›è€…ï¼Œç”±ProviderMapç®¡ç†ã€‚ ActivityRecordï¼šç”¨äºæè¿°Activityï¼Œç”±ActivityStackSupervisorè¿›è¡Œç®¡ç†ã€‚## ç›®æ ‡ ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:4:8","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#8-amså¦‚ä½•ç®¡ç†activityæ¢æ¢amsçš„æ‰§è¡ŒåŸç†"},{"categories":"å­¦ä¹ æ€»ç»“","collections":null,"content":"åŸç† ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:4:9","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#åŸç†"},{"categories":["Android"],"collections":["Framework","å¼€æœºå¯åŠ¨"],"content":" æ ¹æ®å¼€æœºçš„é˜¶æ®µï¼Œæœ‰ä¸€äº›ä¼˜åŒ–å¼€æœºé€Ÿåº¦çš„ç©ºé—´ 1. bootloaderé˜¶æ®µ è¿™è¾¹æ¶‰åŠçš„ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œèƒ½ä¿®æ”¹çš„åœ°æ–¹ä¸å¤šã€‚ æœ€å¤šçš„æ˜¯å»å¤„logï¼Œå¯¹æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Œå¹¶ä¸”å¯¹åæœŸé—®é¢˜çš„åˆ†ææœ‰æ¯”è¾ƒå¤§çš„å½±å“ã€‚ æˆ–è€…é€šè¿‡å±æ€§çš„æ§åˆ¶ï¼Œæ¥æ§åˆ¶æ˜¯å¦æ‰“å°å’Œæ‰“å°çš„ç­‰çº§ã€‚ system/core/logd/LogBuffer.cpp int get_log_level() { char buf[PROPERTY_VALUE_MAX]; memset(buf, 0, PROPERTY_VALUE_MAX); property_get(\"persist.xxx.level\", buf, \"\"); return buf[0]; } â€‹ int loglevl = get_log_level(); int LogBuffer::log(log_id_t log_id, log_time realtime, uid_t uid, pid_t pid, pid_t tid, const char* msg, uint16_t len) { if (log_id \u003e= LOG_ID_MAX) { return -EINVAL; } // é€šè¿‡å±æ€§æ§åˆ¶logè¾“å‡º if (length \u003e 0 \u0026\u0026 loglevl \u003c log_id) { return -EINVAL; } â€‹ } 2 kernelé˜¶æ®µ å¯¹äºkernel é˜¶æ®µçš„æœ‰ï¼Œ å¯¹äºä¸å½±å“å¼€æœºçš„modle ï¼Œå¯ä»¥å»ºè®®å»¶è¿ŸåŠ è½½ã€‚ å¯ä»¥ç­‰zygoteå¯åŠ¨åï¼Œåœ¨early-bootæˆ–booté˜¶æ®µå»åŠ è½½ko, è®©zygoteæ—©ç‚¹èµ·æ¥ æ¯”å¦‚è“ç‰™å’Œwifiçš„koé©±åŠ¨ 3 Inité˜¶æ®µ 3.1 zygote åœ¨ late-initä¹‹åå¯åŠ¨ # Mount filesystems and start core system services. on late-init trigger early-fs # Mount fstab in init.{$device}.rc by mount_all command. Optional parameter # '--early' can be specified to skip entries with 'latemount'. # /system and /vendor must be mounted by the end of the fs stage, # while /data is optional. trigger fs trigger post-fs # Mount fstab in init.{$device}.rc by mount_all with '--late' parameter # to only mount entries with 'latemount'. This is needed if '--early' is # specified in the previous mount_all command on the fs stage. # With /system mounted and properties form /system + /factory available, # some services can be started. trigger late-fs # Now we can mount /data. File encryption requires keymaster to decrypt # /data, which in turn can only be loaded when system properties are present. trigger post-fs-data # Load persist properties and override properties (if enabled) from /data. trigger load_persist_props_action # Should be before netd, but after apex, properties and logging is available. trigger load_bpf_programs # Now we can start zygote for devices with file based encryption # è§¦å‘zygoteå¯åŠ¨ trigger zygote-start # Remove a file to wake up anything waiting for firmware. trigger firmware_mounts_complete trigger early-boot trigger boot 3.2 å¹¶è¡Œæ‰§è¡Œuevent(enable_parallel_restorecon) vendor/ueventd.rcä¸­åŠ å…¥parallel_restorecon enable parallel_restorecon enable 3.3 CPU æ‰“å¼€æ€§èƒ½æ¨¡å¼ 1 å¼€æœºçš„æ—¶å€™ï¼Œcpuå¼€å¯æ€§èƒ½æ¨¡å¼ on early-init write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor performance # æŸ¥çœ‹å½“å‰é¢‘ç‡ # cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq 2 å¼€æœºåå…³é—­,æ”¹æˆè‡ªåŠ¨é€‚åº” on property:sys.boot_completed=1 write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor schedutil 4 ç§»é™¤æ²¡æœ‰ç”¨åˆ°çš„æ¨¡å— æ¯”å¦‚ï¼š å¦‚CIæ¨¡å— on post-fs-data insmod /vendor/lib/modules/cimax-usb.ko insmod /vendor/lib/modules/ci.ko 5 å»¶è¿Ÿvendor/etc/initä¸‹çš„éå…³é”®æœåŠ¡ æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œï¼ŒåŠ å¿«zygoteçš„å¯åŠ¨ // æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œ on boot start xxx service xxx /system/bin/xxx user root group system 6 zygote classloaderæ‡’åŠ è½½ï¼Œ æ‡’åŠ è½½ä¼šæ¯”ç›´æ¥åŠ è½½æ›´è€—å†…å­˜ï¼Œæ‡’åŠ è½½æ˜¯é€šè¿‡system-serverå‘é€æŒ‡ä»¤ç»™zygoteåšåŠ è½½ç›¸å…³åŠ¨ä½œï¼Œåœ¨å‘é€æŒ‡ä»¤å‰ï¼Œsystem-serverä¼šåŠ è½½ä¸€éƒ¨åˆ†è‡ªå·±ä½¿ç”¨çš„ç±»ï¼Œä¼šå’Œzygoteä¸­å­˜åœ¨ç›¸åŒçš„ä¸€éƒ¨åˆ†å¤‡ä»½ service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload zygote æ·»åŠ  task_profiles ProcessCapacityHigh MaxPerformance service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload class main priority -20 user root group root readproc reserved_disk socket zygote stream 660 root system socket usap_pool_primary stream 660 root system onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse onrestart write /sys/power/state on onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart netd onrestart restart wificond task_profiles ProcessCapacityHigh MaxPerformance ç²¾ç®€preloadçš„classes , æ¯”å¦‚å¯ä»¥å»æ‰å¦‚ä¸‹class æ ¹æ®é¡¹ç›®çš„æ—¶é—´æƒ…å†µ å¦‚æœéœ€è¦å†åšä¸€äº›å¤§çš„è£å‰ªï¼Œå¯ä»¥ä½¿ç”¨frameworks\\base\\config\\generate-preloaded-classes.shä¸‹çš„è„šæœ¬æ¥ç”Ÿæˆpreloaded-classes // ç”Ÿç‰©è¯†åˆ« android.hardware.biometrics // äººè„¸è¯†åˆ« android.hardware.face // æ‰“å°æœåŠ¡ android.hardware.fingerprint android.print. // éƒ¨åˆ†å®šä½ç›¸å…³, è¿˜æœ‰GPSå®šä½ç›¸å…³ android.hardware.location com.android.internal.location.GpsNetInitiatedHandler android.location.Gnss* // æ‰‹æœºé€šè¯ç›¸å…³ android.telephony. android.telecom. com.android","date":"2024-11-06","objectID":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/:0:0","tags":["blog","Framework"],"title":"å¼€æœºä¼˜åŒ–","uri":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/#"},{"categories":["Android"],"collections":["Framework","å¼€æœºå¯åŠ¨"],"content":" æ ¹æ®å¼€æœºçš„é˜¶æ®µï¼Œæœ‰ä¸€äº›ä¼˜åŒ–å¼€æœºé€Ÿåº¦çš„ç©ºé—´ 1. bootloaderé˜¶æ®µ è¿™è¾¹æ¶‰åŠçš„ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œèƒ½ä¿®æ”¹çš„åœ°æ–¹ä¸å¤šã€‚ æœ€å¤šçš„æ˜¯å»å¤„logï¼Œå¯¹æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Œå¹¶ä¸”å¯¹åæœŸé—®é¢˜çš„åˆ†ææœ‰æ¯”è¾ƒå¤§çš„å½±å“ã€‚ æˆ–è€…é€šè¿‡å±æ€§çš„æ§åˆ¶ï¼Œæ¥æ§åˆ¶æ˜¯å¦æ‰“å°å’Œæ‰“å°çš„ç­‰çº§ã€‚ system/core/logd/LogBuffer.cpp int get_log_level() { char buf[PROPERTY_VALUE_MAX]; memset(buf, 0, PROPERTY_VALUE_MAX); property_get(\"persist.xxx.level\", buf, \"\"); return buf[0]; } â€‹ int loglevl = get_log_level(); int LogBuffer::log(log_id_t log_id, log_time realtime, uid_t uid, pid_t pid, pid_t tid, const char* msg, uint16_t len) { if (log_id \u003e= LOG_ID_MAX) { return -EINVAL; } // é€šè¿‡å±æ€§æ§åˆ¶logè¾“å‡º if (length \u003e 0 \u0026\u0026 loglevl \u003c log_id) { return -EINVAL; } â€‹ } 2 kernelé˜¶æ®µ å¯¹äºkernel é˜¶æ®µçš„æœ‰ï¼Œ å¯¹äºä¸å½±å“å¼€æœºçš„modle ï¼Œå¯ä»¥å»ºè®®å»¶è¿ŸåŠ è½½ã€‚ å¯ä»¥ç­‰zygoteå¯åŠ¨åï¼Œåœ¨early-bootæˆ–booté˜¶æ®µå»åŠ è½½ko, è®©zygoteæ—©ç‚¹èµ·æ¥ æ¯”å¦‚è“ç‰™å’Œwifiçš„koé©±åŠ¨ 3 Inité˜¶æ®µ 3.1 zygote åœ¨ late-initä¹‹åå¯åŠ¨ # Mount filesystems and start core system services. on late-init trigger early-fs # Mount fstab in init.{$device}.rc by mount_all command. Optional parameter # '--early' can be specified to skip entries with 'latemount'. # /system and /vendor must be mounted by the end of the fs stage, # while /data is optional. trigger fs trigger post-fs # Mount fstab in init.{$device}.rc by mount_all with '--late' parameter # to only mount entries with 'latemount'. This is needed if '--early' is # specified in the previous mount_all command on the fs stage. # With /system mounted and properties form /system + /factory available, # some services can be started. trigger late-fs # Now we can mount /data. File encryption requires keymaster to decrypt # /data, which in turn can only be loaded when system properties are present. trigger post-fs-data # Load persist properties and override properties (if enabled) from /data. trigger load_persist_props_action # Should be before netd, but after apex, properties and logging is available. trigger load_bpf_programs # Now we can start zygote for devices with file based encryption # è§¦å‘zygoteå¯åŠ¨ trigger zygote-start # Remove a file to wake up anything waiting for firmware. trigger firmware_mounts_complete trigger early-boot trigger boot 3.2 å¹¶è¡Œæ‰§è¡Œuevent(enable_parallel_restorecon) vendor/ueventd.rcä¸­åŠ å…¥parallel_restorecon enable parallel_restorecon enable 3.3 CPU æ‰“å¼€æ€§èƒ½æ¨¡å¼ 1 å¼€æœºçš„æ—¶å€™ï¼Œcpuå¼€å¯æ€§èƒ½æ¨¡å¼ on early-init write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor performance # æŸ¥çœ‹å½“å‰é¢‘ç‡ # cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq 2 å¼€æœºåå…³é—­,æ”¹æˆè‡ªåŠ¨é€‚åº” on property:sys.boot_completed=1 write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor schedutil 4 ç§»é™¤æ²¡æœ‰ç”¨åˆ°çš„æ¨¡å— æ¯”å¦‚ï¼š å¦‚CIæ¨¡å— on post-fs-data insmod /vendor/lib/modules/cimax-usb.ko insmod /vendor/lib/modules/ci.ko 5 å»¶è¿Ÿvendor/etc/initä¸‹çš„éå…³é”®æœåŠ¡ æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œï¼ŒåŠ å¿«zygoteçš„å¯åŠ¨ // æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œ on boot start xxx service xxx /system/bin/xxx user root group system 6 zygote classloaderæ‡’åŠ è½½ï¼Œ æ‡’åŠ è½½ä¼šæ¯”ç›´æ¥åŠ è½½æ›´è€—å†…å­˜ï¼Œæ‡’åŠ è½½æ˜¯é€šè¿‡system-serverå‘é€æŒ‡ä»¤ç»™zygoteåšåŠ è½½ç›¸å…³åŠ¨ä½œï¼Œåœ¨å‘é€æŒ‡ä»¤å‰ï¼Œsystem-serverä¼šåŠ è½½ä¸€éƒ¨åˆ†è‡ªå·±ä½¿ç”¨çš„ç±»ï¼Œä¼šå’Œzygoteä¸­å­˜åœ¨ç›¸åŒçš„ä¸€éƒ¨åˆ†å¤‡ä»½ service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload zygote æ·»åŠ  task_profiles ProcessCapacityHigh MaxPerformance service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload class main priority -20 user root group root readproc reserved_disk socket zygote stream 660 root system socket usap_pool_primary stream 660 root system onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse onrestart write /sys/power/state on onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart netd onrestart restart wificond task_profiles ProcessCapacityHigh MaxPerformance ç²¾ç®€preloadçš„classes , æ¯”å¦‚å¯ä»¥å»æ‰å¦‚ä¸‹class æ ¹æ®é¡¹ç›®çš„æ—¶é—´æƒ…å†µ å¦‚æœéœ€è¦å†åšä¸€äº›å¤§çš„è£å‰ªï¼Œå¯ä»¥ä½¿ç”¨frameworks\\base\\config\\generate-preloaded-classes.shä¸‹çš„è„šæœ¬æ¥ç”Ÿæˆpreloaded-classes // ç”Ÿç‰©è¯†åˆ« android.hardware.biometrics // äººè„¸è¯†åˆ« android.hardware.face // æ‰“å°æœåŠ¡ android.hardware.fingerprint android.print. // éƒ¨åˆ†å®šä½ç›¸å…³, è¿˜æœ‰GPSå®šä½ç›¸å…³ android.hardware.location com.android.internal.location.GpsNetInitiatedHandler android.location.Gnss* // æ‰‹æœºé€šè¯ç›¸å…³ android.telephony. android.telecom. com.android","date":"2024-11-06","objectID":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/:0:0","tags":["blog","Framework"],"title":"å¼€æœºä¼˜åŒ–","uri":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/#1-bootloaderé˜¶æ®µ"},{"categories":["Android"],"collections":["Framework","å¼€æœºå¯åŠ¨"],"content":" æ ¹æ®å¼€æœºçš„é˜¶æ®µï¼Œæœ‰ä¸€äº›ä¼˜åŒ–å¼€æœºé€Ÿåº¦çš„ç©ºé—´ 1. bootloaderé˜¶æ®µ è¿™è¾¹æ¶‰åŠçš„ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œèƒ½ä¿®æ”¹çš„åœ°æ–¹ä¸å¤šã€‚ æœ€å¤šçš„æ˜¯å»å¤„logï¼Œå¯¹æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Œå¹¶ä¸”å¯¹åæœŸé—®é¢˜çš„åˆ†ææœ‰æ¯”è¾ƒå¤§çš„å½±å“ã€‚ æˆ–è€…é€šè¿‡å±æ€§çš„æ§åˆ¶ï¼Œæ¥æ§åˆ¶æ˜¯å¦æ‰“å°å’Œæ‰“å°çš„ç­‰çº§ã€‚ system/core/logd/LogBuffer.cpp int get_log_level() { char buf[PROPERTY_VALUE_MAX]; memset(buf, 0, PROPERTY_VALUE_MAX); property_get(\"persist.xxx.level\", buf, \"\"); return buf[0]; } â€‹ int loglevl = get_log_level(); int LogBuffer::log(log_id_t log_id, log_time realtime, uid_t uid, pid_t pid, pid_t tid, const char* msg, uint16_t len) { if (log_id \u003e= LOG_ID_MAX) { return -EINVAL; } // é€šè¿‡å±æ€§æ§åˆ¶logè¾“å‡º if (length \u003e 0 \u0026\u0026 loglevl \u003c log_id) { return -EINVAL; } â€‹ } 2 kernelé˜¶æ®µ å¯¹äºkernel é˜¶æ®µçš„æœ‰ï¼Œ å¯¹äºä¸å½±å“å¼€æœºçš„modle ï¼Œå¯ä»¥å»ºè®®å»¶è¿ŸåŠ è½½ã€‚ å¯ä»¥ç­‰zygoteå¯åŠ¨åï¼Œåœ¨early-bootæˆ–booté˜¶æ®µå»åŠ è½½ko, è®©zygoteæ—©ç‚¹èµ·æ¥ æ¯”å¦‚è“ç‰™å’Œwifiçš„koé©±åŠ¨ 3 Inité˜¶æ®µ 3.1 zygote åœ¨ late-initä¹‹åå¯åŠ¨ # Mount filesystems and start core system services. on late-init trigger early-fs # Mount fstab in init.{$device}.rc by mount_all command. Optional parameter # '--early' can be specified to skip entries with 'latemount'. # /system and /vendor must be mounted by the end of the fs stage, # while /data is optional. trigger fs trigger post-fs # Mount fstab in init.{$device}.rc by mount_all with '--late' parameter # to only mount entries with 'latemount'. This is needed if '--early' is # specified in the previous mount_all command on the fs stage. # With /system mounted and properties form /system + /factory available, # some services can be started. trigger late-fs # Now we can mount /data. File encryption requires keymaster to decrypt # /data, which in turn can only be loaded when system properties are present. trigger post-fs-data # Load persist properties and override properties (if enabled) from /data. trigger load_persist_props_action # Should be before netd, but after apex, properties and logging is available. trigger load_bpf_programs # Now we can start zygote for devices with file based encryption # è§¦å‘zygoteå¯åŠ¨ trigger zygote-start # Remove a file to wake up anything waiting for firmware. trigger firmware_mounts_complete trigger early-boot trigger boot 3.2 å¹¶è¡Œæ‰§è¡Œuevent(enable_parallel_restorecon) vendor/ueventd.rcä¸­åŠ å…¥parallel_restorecon enable parallel_restorecon enable 3.3 CPU æ‰“å¼€æ€§èƒ½æ¨¡å¼ 1 å¼€æœºçš„æ—¶å€™ï¼Œcpuå¼€å¯æ€§èƒ½æ¨¡å¼ on early-init write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor performance # æŸ¥çœ‹å½“å‰é¢‘ç‡ # cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq 2 å¼€æœºåå…³é—­,æ”¹æˆè‡ªåŠ¨é€‚åº” on property:sys.boot_completed=1 write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor schedutil 4 ç§»é™¤æ²¡æœ‰ç”¨åˆ°çš„æ¨¡å— æ¯”å¦‚ï¼š å¦‚CIæ¨¡å— on post-fs-data insmod /vendor/lib/modules/cimax-usb.ko insmod /vendor/lib/modules/ci.ko 5 å»¶è¿Ÿvendor/etc/initä¸‹çš„éå…³é”®æœåŠ¡ æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œï¼ŒåŠ å¿«zygoteçš„å¯åŠ¨ // æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œ on boot start xxx service xxx /system/bin/xxx user root group system 6 zygote classloaderæ‡’åŠ è½½ï¼Œ æ‡’åŠ è½½ä¼šæ¯”ç›´æ¥åŠ è½½æ›´è€—å†…å­˜ï¼Œæ‡’åŠ è½½æ˜¯é€šè¿‡system-serverå‘é€æŒ‡ä»¤ç»™zygoteåšåŠ è½½ç›¸å…³åŠ¨ä½œï¼Œåœ¨å‘é€æŒ‡ä»¤å‰ï¼Œsystem-serverä¼šåŠ è½½ä¸€éƒ¨åˆ†è‡ªå·±ä½¿ç”¨çš„ç±»ï¼Œä¼šå’Œzygoteä¸­å­˜åœ¨ç›¸åŒçš„ä¸€éƒ¨åˆ†å¤‡ä»½ service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload zygote æ·»åŠ  task_profiles ProcessCapacityHigh MaxPerformance service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload class main priority -20 user root group root readproc reserved_disk socket zygote stream 660 root system socket usap_pool_primary stream 660 root system onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse onrestart write /sys/power/state on onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart netd onrestart restart wificond task_profiles ProcessCapacityHigh MaxPerformance ç²¾ç®€preloadçš„classes , æ¯”å¦‚å¯ä»¥å»æ‰å¦‚ä¸‹class æ ¹æ®é¡¹ç›®çš„æ—¶é—´æƒ…å†µ å¦‚æœéœ€è¦å†åšä¸€äº›å¤§çš„è£å‰ªï¼Œå¯ä»¥ä½¿ç”¨frameworks\\base\\config\\generate-preloaded-classes.shä¸‹çš„è„šæœ¬æ¥ç”Ÿæˆpreloaded-classes // ç”Ÿç‰©è¯†åˆ« android.hardware.biometrics // äººè„¸è¯†åˆ« android.hardware.face // æ‰“å°æœåŠ¡ android.hardware.fingerprint android.print. // éƒ¨åˆ†å®šä½ç›¸å…³, è¿˜æœ‰GPSå®šä½ç›¸å…³ android.hardware.location com.android.internal.location.GpsNetInitiatedHandler android.location.Gnss* // æ‰‹æœºé€šè¯ç›¸å…³ android.telephony. android.telecom. com.android","date":"2024-11-06","objectID":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/:0:0","tags":["blog","Framework"],"title":"å¼€æœºä¼˜åŒ–","uri":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/#2--kernelé˜¶æ®µ"},{"categories":["Android"],"collections":["Framework","å¼€æœºå¯åŠ¨"],"content":" æ ¹æ®å¼€æœºçš„é˜¶æ®µï¼Œæœ‰ä¸€äº›ä¼˜åŒ–å¼€æœºé€Ÿåº¦çš„ç©ºé—´ 1. bootloaderé˜¶æ®µ è¿™è¾¹æ¶‰åŠçš„ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œèƒ½ä¿®æ”¹çš„åœ°æ–¹ä¸å¤šã€‚ æœ€å¤šçš„æ˜¯å»å¤„logï¼Œå¯¹æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Œå¹¶ä¸”å¯¹åæœŸé—®é¢˜çš„åˆ†ææœ‰æ¯”è¾ƒå¤§çš„å½±å“ã€‚ æˆ–è€…é€šè¿‡å±æ€§çš„æ§åˆ¶ï¼Œæ¥æ§åˆ¶æ˜¯å¦æ‰“å°å’Œæ‰“å°çš„ç­‰çº§ã€‚ system/core/logd/LogBuffer.cpp int get_log_level() { char buf[PROPERTY_VALUE_MAX]; memset(buf, 0, PROPERTY_VALUE_MAX); property_get(\"persist.xxx.level\", buf, \"\"); return buf[0]; } â€‹ int loglevl = get_log_level(); int LogBuffer::log(log_id_t log_id, log_time realtime, uid_t uid, pid_t pid, pid_t tid, const char* msg, uint16_t len) { if (log_id \u003e= LOG_ID_MAX) { return -EINVAL; } // é€šè¿‡å±æ€§æ§åˆ¶logè¾“å‡º if (length \u003e 0 \u0026\u0026 loglevl \u003c log_id) { return -EINVAL; } â€‹ } 2 kernelé˜¶æ®µ å¯¹äºkernel é˜¶æ®µçš„æœ‰ï¼Œ å¯¹äºä¸å½±å“å¼€æœºçš„modle ï¼Œå¯ä»¥å»ºè®®å»¶è¿ŸåŠ è½½ã€‚ å¯ä»¥ç­‰zygoteå¯åŠ¨åï¼Œåœ¨early-bootæˆ–booté˜¶æ®µå»åŠ è½½ko, è®©zygoteæ—©ç‚¹èµ·æ¥ æ¯”å¦‚è“ç‰™å’Œwifiçš„koé©±åŠ¨ 3 Inité˜¶æ®µ 3.1 zygote åœ¨ late-initä¹‹åå¯åŠ¨ # Mount filesystems and start core system services. on late-init trigger early-fs # Mount fstab in init.{$device}.rc by mount_all command. Optional parameter # '--early' can be specified to skip entries with 'latemount'. # /system and /vendor must be mounted by the end of the fs stage, # while /data is optional. trigger fs trigger post-fs # Mount fstab in init.{$device}.rc by mount_all with '--late' parameter # to only mount entries with 'latemount'. This is needed if '--early' is # specified in the previous mount_all command on the fs stage. # With /system mounted and properties form /system + /factory available, # some services can be started. trigger late-fs # Now we can mount /data. File encryption requires keymaster to decrypt # /data, which in turn can only be loaded when system properties are present. trigger post-fs-data # Load persist properties and override properties (if enabled) from /data. trigger load_persist_props_action # Should be before netd, but after apex, properties and logging is available. trigger load_bpf_programs # Now we can start zygote for devices with file based encryption # è§¦å‘zygoteå¯åŠ¨ trigger zygote-start # Remove a file to wake up anything waiting for firmware. trigger firmware_mounts_complete trigger early-boot trigger boot 3.2 å¹¶è¡Œæ‰§è¡Œuevent(enable_parallel_restorecon) vendor/ueventd.rcä¸­åŠ å…¥parallel_restorecon enable parallel_restorecon enable 3.3 CPU æ‰“å¼€æ€§èƒ½æ¨¡å¼ 1 å¼€æœºçš„æ—¶å€™ï¼Œcpuå¼€å¯æ€§èƒ½æ¨¡å¼ on early-init write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor performance # æŸ¥çœ‹å½“å‰é¢‘ç‡ # cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq 2 å¼€æœºåå…³é—­,æ”¹æˆè‡ªåŠ¨é€‚åº” on property:sys.boot_completed=1 write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor schedutil 4 ç§»é™¤æ²¡æœ‰ç”¨åˆ°çš„æ¨¡å— æ¯”å¦‚ï¼š å¦‚CIæ¨¡å— on post-fs-data insmod /vendor/lib/modules/cimax-usb.ko insmod /vendor/lib/modules/ci.ko 5 å»¶è¿Ÿvendor/etc/initä¸‹çš„éå…³é”®æœåŠ¡ æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œï¼ŒåŠ å¿«zygoteçš„å¯åŠ¨ // æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œ on boot start xxx service xxx /system/bin/xxx user root group system 6 zygote classloaderæ‡’åŠ è½½ï¼Œ æ‡’åŠ è½½ä¼šæ¯”ç›´æ¥åŠ è½½æ›´è€—å†…å­˜ï¼Œæ‡’åŠ è½½æ˜¯é€šè¿‡system-serverå‘é€æŒ‡ä»¤ç»™zygoteåšåŠ è½½ç›¸å…³åŠ¨ä½œï¼Œåœ¨å‘é€æŒ‡ä»¤å‰ï¼Œsystem-serverä¼šåŠ è½½ä¸€éƒ¨åˆ†è‡ªå·±ä½¿ç”¨çš„ç±»ï¼Œä¼šå’Œzygoteä¸­å­˜åœ¨ç›¸åŒçš„ä¸€éƒ¨åˆ†å¤‡ä»½ service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload zygote æ·»åŠ  task_profiles ProcessCapacityHigh MaxPerformance service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload class main priority -20 user root group root readproc reserved_disk socket zygote stream 660 root system socket usap_pool_primary stream 660 root system onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse onrestart write /sys/power/state on onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart netd onrestart restart wificond task_profiles ProcessCapacityHigh MaxPerformance ç²¾ç®€preloadçš„classes , æ¯”å¦‚å¯ä»¥å»æ‰å¦‚ä¸‹class æ ¹æ®é¡¹ç›®çš„æ—¶é—´æƒ…å†µ å¦‚æœéœ€è¦å†åšä¸€äº›å¤§çš„è£å‰ªï¼Œå¯ä»¥ä½¿ç”¨frameworks\\base\\config\\generate-preloaded-classes.shä¸‹çš„è„šæœ¬æ¥ç”Ÿæˆpreloaded-classes // ç”Ÿç‰©è¯†åˆ« android.hardware.biometrics // äººè„¸è¯†åˆ« android.hardware.face // æ‰“å°æœåŠ¡ android.hardware.fingerprint android.print. // éƒ¨åˆ†å®šä½ç›¸å…³, è¿˜æœ‰GPSå®šä½ç›¸å…³ android.hardware.location com.android.internal.location.GpsNetInitiatedHandler android.location.Gnss* // æ‰‹æœºé€šè¯ç›¸å…³ android.telephony. android.telecom. com.android","date":"2024-11-06","objectID":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/:0:0","tags":["blog","Framework"],"title":"å¼€æœºä¼˜åŒ–","uri":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/#3--inité˜¶æ®µ"},{"categories":["Android"],"collections":["Framework","å¼€æœºå¯åŠ¨"],"content":" æ ¹æ®å¼€æœºçš„é˜¶æ®µï¼Œæœ‰ä¸€äº›ä¼˜åŒ–å¼€æœºé€Ÿåº¦çš„ç©ºé—´ 1. bootloaderé˜¶æ®µ è¿™è¾¹æ¶‰åŠçš„ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œèƒ½ä¿®æ”¹çš„åœ°æ–¹ä¸å¤šã€‚ æœ€å¤šçš„æ˜¯å»å¤„logï¼Œå¯¹æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Œå¹¶ä¸”å¯¹åæœŸé—®é¢˜çš„åˆ†ææœ‰æ¯”è¾ƒå¤§çš„å½±å“ã€‚ æˆ–è€…é€šè¿‡å±æ€§çš„æ§åˆ¶ï¼Œæ¥æ§åˆ¶æ˜¯å¦æ‰“å°å’Œæ‰“å°çš„ç­‰çº§ã€‚ system/core/logd/LogBuffer.cpp int get_log_level() { char buf[PROPERTY_VALUE_MAX]; memset(buf, 0, PROPERTY_VALUE_MAX); property_get(\"persist.xxx.level\", buf, \"\"); return buf[0]; } â€‹ int loglevl = get_log_level(); int LogBuffer::log(log_id_t log_id, log_time realtime, uid_t uid, pid_t pid, pid_t tid, const char* msg, uint16_t len) { if (log_id \u003e= LOG_ID_MAX) { return -EINVAL; } // é€šè¿‡å±æ€§æ§åˆ¶logè¾“å‡º if (length \u003e 0 \u0026\u0026 loglevl \u003c log_id) { return -EINVAL; } â€‹ } 2 kernelé˜¶æ®µ å¯¹äºkernel é˜¶æ®µçš„æœ‰ï¼Œ å¯¹äºä¸å½±å“å¼€æœºçš„modle ï¼Œå¯ä»¥å»ºè®®å»¶è¿ŸåŠ è½½ã€‚ å¯ä»¥ç­‰zygoteå¯åŠ¨åï¼Œåœ¨early-bootæˆ–booté˜¶æ®µå»åŠ è½½ko, è®©zygoteæ—©ç‚¹èµ·æ¥ æ¯”å¦‚è“ç‰™å’Œwifiçš„koé©±åŠ¨ 3 Inité˜¶æ®µ 3.1 zygote åœ¨ late-initä¹‹åå¯åŠ¨ # Mount filesystems and start core system services. on late-init trigger early-fs # Mount fstab in init.{$device}.rc by mount_all command. Optional parameter # '--early' can be specified to skip entries with 'latemount'. # /system and /vendor must be mounted by the end of the fs stage, # while /data is optional. trigger fs trigger post-fs # Mount fstab in init.{$device}.rc by mount_all with '--late' parameter # to only mount entries with 'latemount'. This is needed if '--early' is # specified in the previous mount_all command on the fs stage. # With /system mounted and properties form /system + /factory available, # some services can be started. trigger late-fs # Now we can mount /data. File encryption requires keymaster to decrypt # /data, which in turn can only be loaded when system properties are present. trigger post-fs-data # Load persist properties and override properties (if enabled) from /data. trigger load_persist_props_action # Should be before netd, but after apex, properties and logging is available. trigger load_bpf_programs # Now we can start zygote for devices with file based encryption # è§¦å‘zygoteå¯åŠ¨ trigger zygote-start # Remove a file to wake up anything waiting for firmware. trigger firmware_mounts_complete trigger early-boot trigger boot 3.2 å¹¶è¡Œæ‰§è¡Œuevent(enable_parallel_restorecon) vendor/ueventd.rcä¸­åŠ å…¥parallel_restorecon enable parallel_restorecon enable 3.3 CPU æ‰“å¼€æ€§èƒ½æ¨¡å¼ 1 å¼€æœºçš„æ—¶å€™ï¼Œcpuå¼€å¯æ€§èƒ½æ¨¡å¼ on early-init write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor performance # æŸ¥çœ‹å½“å‰é¢‘ç‡ # cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq 2 å¼€æœºåå…³é—­,æ”¹æˆè‡ªåŠ¨é€‚åº” on property:sys.boot_completed=1 write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor schedutil 4 ç§»é™¤æ²¡æœ‰ç”¨åˆ°çš„æ¨¡å— æ¯”å¦‚ï¼š å¦‚CIæ¨¡å— on post-fs-data insmod /vendor/lib/modules/cimax-usb.ko insmod /vendor/lib/modules/ci.ko 5 å»¶è¿Ÿvendor/etc/initä¸‹çš„éå…³é”®æœåŠ¡ æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œï¼ŒåŠ å¿«zygoteçš„å¯åŠ¨ // æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œ on boot start xxx service xxx /system/bin/xxx user root group system 6 zygote classloaderæ‡’åŠ è½½ï¼Œ æ‡’åŠ è½½ä¼šæ¯”ç›´æ¥åŠ è½½æ›´è€—å†…å­˜ï¼Œæ‡’åŠ è½½æ˜¯é€šè¿‡system-serverå‘é€æŒ‡ä»¤ç»™zygoteåšåŠ è½½ç›¸å…³åŠ¨ä½œï¼Œåœ¨å‘é€æŒ‡ä»¤å‰ï¼Œsystem-serverä¼šåŠ è½½ä¸€éƒ¨åˆ†è‡ªå·±ä½¿ç”¨çš„ç±»ï¼Œä¼šå’Œzygoteä¸­å­˜åœ¨ç›¸åŒçš„ä¸€éƒ¨åˆ†å¤‡ä»½ service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload zygote æ·»åŠ  task_profiles ProcessCapacityHigh MaxPerformance service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload class main priority -20 user root group root readproc reserved_disk socket zygote stream 660 root system socket usap_pool_primary stream 660 root system onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse onrestart write /sys/power/state on onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart netd onrestart restart wificond task_profiles ProcessCapacityHigh MaxPerformance ç²¾ç®€preloadçš„classes , æ¯”å¦‚å¯ä»¥å»æ‰å¦‚ä¸‹class æ ¹æ®é¡¹ç›®çš„æ—¶é—´æƒ…å†µ å¦‚æœéœ€è¦å†åšä¸€äº›å¤§çš„è£å‰ªï¼Œå¯ä»¥ä½¿ç”¨frameworks\\base\\config\\generate-preloaded-classes.shä¸‹çš„è„šæœ¬æ¥ç”Ÿæˆpreloaded-classes // ç”Ÿç‰©è¯†åˆ« android.hardware.biometrics // äººè„¸è¯†åˆ« android.hardware.face // æ‰“å°æœåŠ¡ android.hardware.fingerprint android.print. // éƒ¨åˆ†å®šä½ç›¸å…³, è¿˜æœ‰GPSå®šä½ç›¸å…³ android.hardware.location com.android.internal.location.GpsNetInitiatedHandler android.location.Gnss* // æ‰‹æœºé€šè¯ç›¸å…³ android.telephony. android.telecom. com.android","date":"2024-11-06","objectID":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/:0:0","tags":["blog","Framework"],"title":"å¼€æœºä¼˜åŒ–","uri":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/#31-zygote-åœ¨-late-initä¹‹åå¯åŠ¨"},{"categories":["Android"],"collections":["Framework","å¼€æœºå¯åŠ¨"],"content":" æ ¹æ®å¼€æœºçš„é˜¶æ®µï¼Œæœ‰ä¸€äº›ä¼˜åŒ–å¼€æœºé€Ÿåº¦çš„ç©ºé—´ 1. bootloaderé˜¶æ®µ è¿™è¾¹æ¶‰åŠçš„ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œèƒ½ä¿®æ”¹çš„åœ°æ–¹ä¸å¤šã€‚ æœ€å¤šçš„æ˜¯å»å¤„logï¼Œå¯¹æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Œå¹¶ä¸”å¯¹åæœŸé—®é¢˜çš„åˆ†ææœ‰æ¯”è¾ƒå¤§çš„å½±å“ã€‚ æˆ–è€…é€šè¿‡å±æ€§çš„æ§åˆ¶ï¼Œæ¥æ§åˆ¶æ˜¯å¦æ‰“å°å’Œæ‰“å°çš„ç­‰çº§ã€‚ system/core/logd/LogBuffer.cpp int get_log_level() { char buf[PROPERTY_VALUE_MAX]; memset(buf, 0, PROPERTY_VALUE_MAX); property_get(\"persist.xxx.level\", buf, \"\"); return buf[0]; } â€‹ int loglevl = get_log_level(); int LogBuffer::log(log_id_t log_id, log_time realtime, uid_t uid, pid_t pid, pid_t tid, const char* msg, uint16_t len) { if (log_id \u003e= LOG_ID_MAX) { return -EINVAL; } // é€šè¿‡å±æ€§æ§åˆ¶logè¾“å‡º if (length \u003e 0 \u0026\u0026 loglevl \u003c log_id) { return -EINVAL; } â€‹ } 2 kernelé˜¶æ®µ å¯¹äºkernel é˜¶æ®µçš„æœ‰ï¼Œ å¯¹äºä¸å½±å“å¼€æœºçš„modle ï¼Œå¯ä»¥å»ºè®®å»¶è¿ŸåŠ è½½ã€‚ å¯ä»¥ç­‰zygoteå¯åŠ¨åï¼Œåœ¨early-bootæˆ–booté˜¶æ®µå»åŠ è½½ko, è®©zygoteæ—©ç‚¹èµ·æ¥ æ¯”å¦‚è“ç‰™å’Œwifiçš„koé©±åŠ¨ 3 Inité˜¶æ®µ 3.1 zygote åœ¨ late-initä¹‹åå¯åŠ¨ # Mount filesystems and start core system services. on late-init trigger early-fs # Mount fstab in init.{$device}.rc by mount_all command. Optional parameter # '--early' can be specified to skip entries with 'latemount'. # /system and /vendor must be mounted by the end of the fs stage, # while /data is optional. trigger fs trigger post-fs # Mount fstab in init.{$device}.rc by mount_all with '--late' parameter # to only mount entries with 'latemount'. This is needed if '--early' is # specified in the previous mount_all command on the fs stage. # With /system mounted and properties form /system + /factory available, # some services can be started. trigger late-fs # Now we can mount /data. File encryption requires keymaster to decrypt # /data, which in turn can only be loaded when system properties are present. trigger post-fs-data # Load persist properties and override properties (if enabled) from /data. trigger load_persist_props_action # Should be before netd, but after apex, properties and logging is available. trigger load_bpf_programs # Now we can start zygote for devices with file based encryption # è§¦å‘zygoteå¯åŠ¨ trigger zygote-start # Remove a file to wake up anything waiting for firmware. trigger firmware_mounts_complete trigger early-boot trigger boot 3.2 å¹¶è¡Œæ‰§è¡Œuevent(enable_parallel_restorecon) vendor/ueventd.rcä¸­åŠ å…¥parallel_restorecon enable parallel_restorecon enable 3.3 CPU æ‰“å¼€æ€§èƒ½æ¨¡å¼ 1 å¼€æœºçš„æ—¶å€™ï¼Œcpuå¼€å¯æ€§èƒ½æ¨¡å¼ on early-init write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor performance # æŸ¥çœ‹å½“å‰é¢‘ç‡ # cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq 2 å¼€æœºåå…³é—­,æ”¹æˆè‡ªåŠ¨é€‚åº” on property:sys.boot_completed=1 write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor schedutil 4 ç§»é™¤æ²¡æœ‰ç”¨åˆ°çš„æ¨¡å— æ¯”å¦‚ï¼š å¦‚CIæ¨¡å— on post-fs-data insmod /vendor/lib/modules/cimax-usb.ko insmod /vendor/lib/modules/ci.ko 5 å»¶è¿Ÿvendor/etc/initä¸‹çš„éå…³é”®æœåŠ¡ æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œï¼ŒåŠ å¿«zygoteçš„å¯åŠ¨ // æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œ on boot start xxx service xxx /system/bin/xxx user root group system 6 zygote classloaderæ‡’åŠ è½½ï¼Œ æ‡’åŠ è½½ä¼šæ¯”ç›´æ¥åŠ è½½æ›´è€—å†…å­˜ï¼Œæ‡’åŠ è½½æ˜¯é€šè¿‡system-serverå‘é€æŒ‡ä»¤ç»™zygoteåšåŠ è½½ç›¸å…³åŠ¨ä½œï¼Œåœ¨å‘é€æŒ‡ä»¤å‰ï¼Œsystem-serverä¼šåŠ è½½ä¸€éƒ¨åˆ†è‡ªå·±ä½¿ç”¨çš„ç±»ï¼Œä¼šå’Œzygoteä¸­å­˜åœ¨ç›¸åŒçš„ä¸€éƒ¨åˆ†å¤‡ä»½ service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload zygote æ·»åŠ  task_profiles ProcessCapacityHigh MaxPerformance service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload class main priority -20 user root group root readproc reserved_disk socket zygote stream 660 root system socket usap_pool_primary stream 660 root system onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse onrestart write /sys/power/state on onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart netd onrestart restart wificond task_profiles ProcessCapacityHigh MaxPerformance ç²¾ç®€preloadçš„classes , æ¯”å¦‚å¯ä»¥å»æ‰å¦‚ä¸‹class æ ¹æ®é¡¹ç›®çš„æ—¶é—´æƒ…å†µ å¦‚æœéœ€è¦å†åšä¸€äº›å¤§çš„è£å‰ªï¼Œå¯ä»¥ä½¿ç”¨frameworks\\base\\config\\generate-preloaded-classes.shä¸‹çš„è„šæœ¬æ¥ç”Ÿæˆpreloaded-classes // ç”Ÿç‰©è¯†åˆ« android.hardware.biometrics // äººè„¸è¯†åˆ« android.hardware.face // æ‰“å°æœåŠ¡ android.hardware.fingerprint android.print. // éƒ¨åˆ†å®šä½ç›¸å…³, è¿˜æœ‰GPSå®šä½ç›¸å…³ android.hardware.location com.android.internal.location.GpsNetInitiatedHandler android.location.Gnss* // æ‰‹æœºé€šè¯ç›¸å…³ android.telephony. android.telecom. com.android","date":"2024-11-06","objectID":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/:0:0","tags":["blog","Framework"],"title":"å¼€æœºä¼˜åŒ–","uri":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/#32-å¹¶è¡Œæ‰§è¡Œueventenable_parallel_restorecon"},{"categories":["Android"],"collections":["Framework","å¼€æœºå¯åŠ¨"],"content":" æ ¹æ®å¼€æœºçš„é˜¶æ®µï¼Œæœ‰ä¸€äº›ä¼˜åŒ–å¼€æœºé€Ÿåº¦çš„ç©ºé—´ 1. bootloaderé˜¶æ®µ è¿™è¾¹æ¶‰åŠçš„ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œèƒ½ä¿®æ”¹çš„åœ°æ–¹ä¸å¤šã€‚ æœ€å¤šçš„æ˜¯å»å¤„logï¼Œå¯¹æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Œå¹¶ä¸”å¯¹åæœŸé—®é¢˜çš„åˆ†ææœ‰æ¯”è¾ƒå¤§çš„å½±å“ã€‚ æˆ–è€…é€šè¿‡å±æ€§çš„æ§åˆ¶ï¼Œæ¥æ§åˆ¶æ˜¯å¦æ‰“å°å’Œæ‰“å°çš„ç­‰çº§ã€‚ system/core/logd/LogBuffer.cpp int get_log_level() { char buf[PROPERTY_VALUE_MAX]; memset(buf, 0, PROPERTY_VALUE_MAX); property_get(\"persist.xxx.level\", buf, \"\"); return buf[0]; } â€‹ int loglevl = get_log_level(); int LogBuffer::log(log_id_t log_id, log_time realtime, uid_t uid, pid_t pid, pid_t tid, const char* msg, uint16_t len) { if (log_id \u003e= LOG_ID_MAX) { return -EINVAL; } // é€šè¿‡å±æ€§æ§åˆ¶logè¾“å‡º if (length \u003e 0 \u0026\u0026 loglevl \u003c log_id) { return -EINVAL; } â€‹ } 2 kernelé˜¶æ®µ å¯¹äºkernel é˜¶æ®µçš„æœ‰ï¼Œ å¯¹äºä¸å½±å“å¼€æœºçš„modle ï¼Œå¯ä»¥å»ºè®®å»¶è¿ŸåŠ è½½ã€‚ å¯ä»¥ç­‰zygoteå¯åŠ¨åï¼Œåœ¨early-bootæˆ–booté˜¶æ®µå»åŠ è½½ko, è®©zygoteæ—©ç‚¹èµ·æ¥ æ¯”å¦‚è“ç‰™å’Œwifiçš„koé©±åŠ¨ 3 Inité˜¶æ®µ 3.1 zygote åœ¨ late-initä¹‹åå¯åŠ¨ # Mount filesystems and start core system services. on late-init trigger early-fs # Mount fstab in init.{$device}.rc by mount_all command. Optional parameter # '--early' can be specified to skip entries with 'latemount'. # /system and /vendor must be mounted by the end of the fs stage, # while /data is optional. trigger fs trigger post-fs # Mount fstab in init.{$device}.rc by mount_all with '--late' parameter # to only mount entries with 'latemount'. This is needed if '--early' is # specified in the previous mount_all command on the fs stage. # With /system mounted and properties form /system + /factory available, # some services can be started. trigger late-fs # Now we can mount /data. File encryption requires keymaster to decrypt # /data, which in turn can only be loaded when system properties are present. trigger post-fs-data # Load persist properties and override properties (if enabled) from /data. trigger load_persist_props_action # Should be before netd, but after apex, properties and logging is available. trigger load_bpf_programs # Now we can start zygote for devices with file based encryption # è§¦å‘zygoteå¯åŠ¨ trigger zygote-start # Remove a file to wake up anything waiting for firmware. trigger firmware_mounts_complete trigger early-boot trigger boot 3.2 å¹¶è¡Œæ‰§è¡Œuevent(enable_parallel_restorecon) vendor/ueventd.rcä¸­åŠ å…¥parallel_restorecon enable parallel_restorecon enable 3.3 CPU æ‰“å¼€æ€§èƒ½æ¨¡å¼ 1 å¼€æœºçš„æ—¶å€™ï¼Œcpuå¼€å¯æ€§èƒ½æ¨¡å¼ on early-init write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor performance # æŸ¥çœ‹å½“å‰é¢‘ç‡ # cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq 2 å¼€æœºåå…³é—­,æ”¹æˆè‡ªåŠ¨é€‚åº” on property:sys.boot_completed=1 write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor schedutil 4 ç§»é™¤æ²¡æœ‰ç”¨åˆ°çš„æ¨¡å— æ¯”å¦‚ï¼š å¦‚CIæ¨¡å— on post-fs-data insmod /vendor/lib/modules/cimax-usb.ko insmod /vendor/lib/modules/ci.ko 5 å»¶è¿Ÿvendor/etc/initä¸‹çš„éå…³é”®æœåŠ¡ æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œï¼ŒåŠ å¿«zygoteçš„å¯åŠ¨ // æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œ on boot start xxx service xxx /system/bin/xxx user root group system 6 zygote classloaderæ‡’åŠ è½½ï¼Œ æ‡’åŠ è½½ä¼šæ¯”ç›´æ¥åŠ è½½æ›´è€—å†…å­˜ï¼Œæ‡’åŠ è½½æ˜¯é€šè¿‡system-serverå‘é€æŒ‡ä»¤ç»™zygoteåšåŠ è½½ç›¸å…³åŠ¨ä½œï¼Œåœ¨å‘é€æŒ‡ä»¤å‰ï¼Œsystem-serverä¼šåŠ è½½ä¸€éƒ¨åˆ†è‡ªå·±ä½¿ç”¨çš„ç±»ï¼Œä¼šå’Œzygoteä¸­å­˜åœ¨ç›¸åŒçš„ä¸€éƒ¨åˆ†å¤‡ä»½ service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload zygote æ·»åŠ  task_profiles ProcessCapacityHigh MaxPerformance service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload class main priority -20 user root group root readproc reserved_disk socket zygote stream 660 root system socket usap_pool_primary stream 660 root system onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse onrestart write /sys/power/state on onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart netd onrestart restart wificond task_profiles ProcessCapacityHigh MaxPerformance ç²¾ç®€preloadçš„classes , æ¯”å¦‚å¯ä»¥å»æ‰å¦‚ä¸‹class æ ¹æ®é¡¹ç›®çš„æ—¶é—´æƒ…å†µ å¦‚æœéœ€è¦å†åšä¸€äº›å¤§çš„è£å‰ªï¼Œå¯ä»¥ä½¿ç”¨frameworks\\base\\config\\generate-preloaded-classes.shä¸‹çš„è„šæœ¬æ¥ç”Ÿæˆpreloaded-classes // ç”Ÿç‰©è¯†åˆ« android.hardware.biometrics // äººè„¸è¯†åˆ« android.hardware.face // æ‰“å°æœåŠ¡ android.hardware.fingerprint android.print. // éƒ¨åˆ†å®šä½ç›¸å…³, è¿˜æœ‰GPSå®šä½ç›¸å…³ android.hardware.location com.android.internal.location.GpsNetInitiatedHandler android.location.Gnss* // æ‰‹æœºé€šè¯ç›¸å…³ android.telephony. android.telecom. com.android","date":"2024-11-06","objectID":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/:0:0","tags":["blog","Framework"],"title":"å¼€æœºä¼˜åŒ–","uri":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/#33-cpu-æ‰“å¼€æ€§èƒ½æ¨¡å¼"},{"categories":["Android"],"collections":["Framework","å¼€æœºå¯åŠ¨"],"content":" æ ¹æ®å¼€æœºçš„é˜¶æ®µï¼Œæœ‰ä¸€äº›ä¼˜åŒ–å¼€æœºé€Ÿåº¦çš„ç©ºé—´ 1. bootloaderé˜¶æ®µ è¿™è¾¹æ¶‰åŠçš„ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œèƒ½ä¿®æ”¹çš„åœ°æ–¹ä¸å¤šã€‚ æœ€å¤šçš„æ˜¯å»å¤„logï¼Œå¯¹æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Œå¹¶ä¸”å¯¹åæœŸé—®é¢˜çš„åˆ†ææœ‰æ¯”è¾ƒå¤§çš„å½±å“ã€‚ æˆ–è€…é€šè¿‡å±æ€§çš„æ§åˆ¶ï¼Œæ¥æ§åˆ¶æ˜¯å¦æ‰“å°å’Œæ‰“å°çš„ç­‰çº§ã€‚ system/core/logd/LogBuffer.cpp int get_log_level() { char buf[PROPERTY_VALUE_MAX]; memset(buf, 0, PROPERTY_VALUE_MAX); property_get(\"persist.xxx.level\", buf, \"\"); return buf[0]; } â€‹ int loglevl = get_log_level(); int LogBuffer::log(log_id_t log_id, log_time realtime, uid_t uid, pid_t pid, pid_t tid, const char* msg, uint16_t len) { if (log_id \u003e= LOG_ID_MAX) { return -EINVAL; } // é€šè¿‡å±æ€§æ§åˆ¶logè¾“å‡º if (length \u003e 0 \u0026\u0026 loglevl \u003c log_id) { return -EINVAL; } â€‹ } 2 kernelé˜¶æ®µ å¯¹äºkernel é˜¶æ®µçš„æœ‰ï¼Œ å¯¹äºä¸å½±å“å¼€æœºçš„modle ï¼Œå¯ä»¥å»ºè®®å»¶è¿ŸåŠ è½½ã€‚ å¯ä»¥ç­‰zygoteå¯åŠ¨åï¼Œåœ¨early-bootæˆ–booté˜¶æ®µå»åŠ è½½ko, è®©zygoteæ—©ç‚¹èµ·æ¥ æ¯”å¦‚è“ç‰™å’Œwifiçš„koé©±åŠ¨ 3 Inité˜¶æ®µ 3.1 zygote åœ¨ late-initä¹‹åå¯åŠ¨ # Mount filesystems and start core system services. on late-init trigger early-fs # Mount fstab in init.{$device}.rc by mount_all command. Optional parameter # '--early' can be specified to skip entries with 'latemount'. # /system and /vendor must be mounted by the end of the fs stage, # while /data is optional. trigger fs trigger post-fs # Mount fstab in init.{$device}.rc by mount_all with '--late' parameter # to only mount entries with 'latemount'. This is needed if '--early' is # specified in the previous mount_all command on the fs stage. # With /system mounted and properties form /system + /factory available, # some services can be started. trigger late-fs # Now we can mount /data. File encryption requires keymaster to decrypt # /data, which in turn can only be loaded when system properties are present. trigger post-fs-data # Load persist properties and override properties (if enabled) from /data. trigger load_persist_props_action # Should be before netd, but after apex, properties and logging is available. trigger load_bpf_programs # Now we can start zygote for devices with file based encryption # è§¦å‘zygoteå¯åŠ¨ trigger zygote-start # Remove a file to wake up anything waiting for firmware. trigger firmware_mounts_complete trigger early-boot trigger boot 3.2 å¹¶è¡Œæ‰§è¡Œuevent(enable_parallel_restorecon) vendor/ueventd.rcä¸­åŠ å…¥parallel_restorecon enable parallel_restorecon enable 3.3 CPU æ‰“å¼€æ€§èƒ½æ¨¡å¼ 1 å¼€æœºçš„æ—¶å€™ï¼Œcpuå¼€å¯æ€§èƒ½æ¨¡å¼ on early-init write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor performance # æŸ¥çœ‹å½“å‰é¢‘ç‡ # cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq 2 å¼€æœºåå…³é—­,æ”¹æˆè‡ªåŠ¨é€‚åº” on property:sys.boot_completed=1 write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor schedutil 4 ç§»é™¤æ²¡æœ‰ç”¨åˆ°çš„æ¨¡å— æ¯”å¦‚ï¼š å¦‚CIæ¨¡å— on post-fs-data insmod /vendor/lib/modules/cimax-usb.ko insmod /vendor/lib/modules/ci.ko 5 å»¶è¿Ÿvendor/etc/initä¸‹çš„éå…³é”®æœåŠ¡ æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œï¼ŒåŠ å¿«zygoteçš„å¯åŠ¨ // æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œ on boot start xxx service xxx /system/bin/xxx user root group system 6 zygote classloaderæ‡’åŠ è½½ï¼Œ æ‡’åŠ è½½ä¼šæ¯”ç›´æ¥åŠ è½½æ›´è€—å†…å­˜ï¼Œæ‡’åŠ è½½æ˜¯é€šè¿‡system-serverå‘é€æŒ‡ä»¤ç»™zygoteåšåŠ è½½ç›¸å…³åŠ¨ä½œï¼Œåœ¨å‘é€æŒ‡ä»¤å‰ï¼Œsystem-serverä¼šåŠ è½½ä¸€éƒ¨åˆ†è‡ªå·±ä½¿ç”¨çš„ç±»ï¼Œä¼šå’Œzygoteä¸­å­˜åœ¨ç›¸åŒçš„ä¸€éƒ¨åˆ†å¤‡ä»½ service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload zygote æ·»åŠ  task_profiles ProcessCapacityHigh MaxPerformance service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload class main priority -20 user root group root readproc reserved_disk socket zygote stream 660 root system socket usap_pool_primary stream 660 root system onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse onrestart write /sys/power/state on onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart netd onrestart restart wificond task_profiles ProcessCapacityHigh MaxPerformance ç²¾ç®€preloadçš„classes , æ¯”å¦‚å¯ä»¥å»æ‰å¦‚ä¸‹class æ ¹æ®é¡¹ç›®çš„æ—¶é—´æƒ…å†µ å¦‚æœéœ€è¦å†åšä¸€äº›å¤§çš„è£å‰ªï¼Œå¯ä»¥ä½¿ç”¨frameworks\\base\\config\\generate-preloaded-classes.shä¸‹çš„è„šæœ¬æ¥ç”Ÿæˆpreloaded-classes // ç”Ÿç‰©è¯†åˆ« android.hardware.biometrics // äººè„¸è¯†åˆ« android.hardware.face // æ‰“å°æœåŠ¡ android.hardware.fingerprint android.print. // éƒ¨åˆ†å®šä½ç›¸å…³, è¿˜æœ‰GPSå®šä½ç›¸å…³ android.hardware.location com.android.internal.location.GpsNetInitiatedHandler android.location.Gnss* // æ‰‹æœºé€šè¯ç›¸å…³ android.telephony. android.telecom. com.android","date":"2024-11-06","objectID":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/:0:0","tags":["blog","Framework"],"title":"å¼€æœºä¼˜åŒ–","uri":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/#4-ç§»é™¤æ²¡æœ‰ç”¨åˆ°çš„æ¨¡å—"},{"categories":["Android"],"collections":["Framework","å¼€æœºå¯åŠ¨"],"content":" æ ¹æ®å¼€æœºçš„é˜¶æ®µï¼Œæœ‰ä¸€äº›ä¼˜åŒ–å¼€æœºé€Ÿåº¦çš„ç©ºé—´ 1. bootloaderé˜¶æ®µ è¿™è¾¹æ¶‰åŠçš„ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œèƒ½ä¿®æ”¹çš„åœ°æ–¹ä¸å¤šã€‚ æœ€å¤šçš„æ˜¯å»å¤„logï¼Œå¯¹æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Œå¹¶ä¸”å¯¹åæœŸé—®é¢˜çš„åˆ†ææœ‰æ¯”è¾ƒå¤§çš„å½±å“ã€‚ æˆ–è€…é€šè¿‡å±æ€§çš„æ§åˆ¶ï¼Œæ¥æ§åˆ¶æ˜¯å¦æ‰“å°å’Œæ‰“å°çš„ç­‰çº§ã€‚ system/core/logd/LogBuffer.cpp int get_log_level() { char buf[PROPERTY_VALUE_MAX]; memset(buf, 0, PROPERTY_VALUE_MAX); property_get(\"persist.xxx.level\", buf, \"\"); return buf[0]; } â€‹ int loglevl = get_log_level(); int LogBuffer::log(log_id_t log_id, log_time realtime, uid_t uid, pid_t pid, pid_t tid, const char* msg, uint16_t len) { if (log_id \u003e= LOG_ID_MAX) { return -EINVAL; } // é€šè¿‡å±æ€§æ§åˆ¶logè¾“å‡º if (length \u003e 0 \u0026\u0026 loglevl \u003c log_id) { return -EINVAL; } â€‹ } 2 kernelé˜¶æ®µ å¯¹äºkernel é˜¶æ®µçš„æœ‰ï¼Œ å¯¹äºä¸å½±å“å¼€æœºçš„modle ï¼Œå¯ä»¥å»ºè®®å»¶è¿ŸåŠ è½½ã€‚ å¯ä»¥ç­‰zygoteå¯åŠ¨åï¼Œåœ¨early-bootæˆ–booté˜¶æ®µå»åŠ è½½ko, è®©zygoteæ—©ç‚¹èµ·æ¥ æ¯”å¦‚è“ç‰™å’Œwifiçš„koé©±åŠ¨ 3 Inité˜¶æ®µ 3.1 zygote åœ¨ late-initä¹‹åå¯åŠ¨ # Mount filesystems and start core system services. on late-init trigger early-fs # Mount fstab in init.{$device}.rc by mount_all command. Optional parameter # '--early' can be specified to skip entries with 'latemount'. # /system and /vendor must be mounted by the end of the fs stage, # while /data is optional. trigger fs trigger post-fs # Mount fstab in init.{$device}.rc by mount_all with '--late' parameter # to only mount entries with 'latemount'. This is needed if '--early' is # specified in the previous mount_all command on the fs stage. # With /system mounted and properties form /system + /factory available, # some services can be started. trigger late-fs # Now we can mount /data. File encryption requires keymaster to decrypt # /data, which in turn can only be loaded when system properties are present. trigger post-fs-data # Load persist properties and override properties (if enabled) from /data. trigger load_persist_props_action # Should be before netd, but after apex, properties and logging is available. trigger load_bpf_programs # Now we can start zygote for devices with file based encryption # è§¦å‘zygoteå¯åŠ¨ trigger zygote-start # Remove a file to wake up anything waiting for firmware. trigger firmware_mounts_complete trigger early-boot trigger boot 3.2 å¹¶è¡Œæ‰§è¡Œuevent(enable_parallel_restorecon) vendor/ueventd.rcä¸­åŠ å…¥parallel_restorecon enable parallel_restorecon enable 3.3 CPU æ‰“å¼€æ€§èƒ½æ¨¡å¼ 1 å¼€æœºçš„æ—¶å€™ï¼Œcpuå¼€å¯æ€§èƒ½æ¨¡å¼ on early-init write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor performance # æŸ¥çœ‹å½“å‰é¢‘ç‡ # cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq 2 å¼€æœºåå…³é—­,æ”¹æˆè‡ªåŠ¨é€‚åº” on property:sys.boot_completed=1 write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor schedutil 4 ç§»é™¤æ²¡æœ‰ç”¨åˆ°çš„æ¨¡å— æ¯”å¦‚ï¼š å¦‚CIæ¨¡å— on post-fs-data insmod /vendor/lib/modules/cimax-usb.ko insmod /vendor/lib/modules/ci.ko 5 å»¶è¿Ÿvendor/etc/initä¸‹çš„éå…³é”®æœåŠ¡ æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œï¼ŒåŠ å¿«zygoteçš„å¯åŠ¨ // æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œ on boot start xxx service xxx /system/bin/xxx user root group system 6 zygote classloaderæ‡’åŠ è½½ï¼Œ æ‡’åŠ è½½ä¼šæ¯”ç›´æ¥åŠ è½½æ›´è€—å†…å­˜ï¼Œæ‡’åŠ è½½æ˜¯é€šè¿‡system-serverå‘é€æŒ‡ä»¤ç»™zygoteåšåŠ è½½ç›¸å…³åŠ¨ä½œï¼Œåœ¨å‘é€æŒ‡ä»¤å‰ï¼Œsystem-serverä¼šåŠ è½½ä¸€éƒ¨åˆ†è‡ªå·±ä½¿ç”¨çš„ç±»ï¼Œä¼šå’Œzygoteä¸­å­˜åœ¨ç›¸åŒçš„ä¸€éƒ¨åˆ†å¤‡ä»½ service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload zygote æ·»åŠ  task_profiles ProcessCapacityHigh MaxPerformance service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload class main priority -20 user root group root readproc reserved_disk socket zygote stream 660 root system socket usap_pool_primary stream 660 root system onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse onrestart write /sys/power/state on onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart netd onrestart restart wificond task_profiles ProcessCapacityHigh MaxPerformance ç²¾ç®€preloadçš„classes , æ¯”å¦‚å¯ä»¥å»æ‰å¦‚ä¸‹class æ ¹æ®é¡¹ç›®çš„æ—¶é—´æƒ…å†µ å¦‚æœéœ€è¦å†åšä¸€äº›å¤§çš„è£å‰ªï¼Œå¯ä»¥ä½¿ç”¨frameworks\\base\\config\\generate-preloaded-classes.shä¸‹çš„è„šæœ¬æ¥ç”Ÿæˆpreloaded-classes // ç”Ÿç‰©è¯†åˆ« android.hardware.biometrics // äººè„¸è¯†åˆ« android.hardware.face // æ‰“å°æœåŠ¡ android.hardware.fingerprint android.print. // éƒ¨åˆ†å®šä½ç›¸å…³, è¿˜æœ‰GPSå®šä½ç›¸å…³ android.hardware.location com.android.internal.location.GpsNetInitiatedHandler android.location.Gnss* // æ‰‹æœºé€šè¯ç›¸å…³ android.telephony. android.telecom. com.android","date":"2024-11-06","objectID":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/:0:0","tags":["blog","Framework"],"title":"å¼€æœºä¼˜åŒ–","uri":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/#5-å»¶è¿Ÿvendoretcinitä¸‹çš„éå…³é”®æœåŠ¡"},{"categories":["Android"],"collections":["Framework","å¼€æœºå¯åŠ¨"],"content":" æ ¹æ®å¼€æœºçš„é˜¶æ®µï¼Œæœ‰ä¸€äº›ä¼˜åŒ–å¼€æœºé€Ÿåº¦çš„ç©ºé—´ 1. bootloaderé˜¶æ®µ è¿™è¾¹æ¶‰åŠçš„ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œèƒ½ä¿®æ”¹çš„åœ°æ–¹ä¸å¤šã€‚ æœ€å¤šçš„æ˜¯å»å¤„logï¼Œå¯¹æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Œå¹¶ä¸”å¯¹åæœŸé—®é¢˜çš„åˆ†ææœ‰æ¯”è¾ƒå¤§çš„å½±å“ã€‚ æˆ–è€…é€šè¿‡å±æ€§çš„æ§åˆ¶ï¼Œæ¥æ§åˆ¶æ˜¯å¦æ‰“å°å’Œæ‰“å°çš„ç­‰çº§ã€‚ system/core/logd/LogBuffer.cpp int get_log_level() { char buf[PROPERTY_VALUE_MAX]; memset(buf, 0, PROPERTY_VALUE_MAX); property_get(\"persist.xxx.level\", buf, \"\"); return buf[0]; } â€‹ int loglevl = get_log_level(); int LogBuffer::log(log_id_t log_id, log_time realtime, uid_t uid, pid_t pid, pid_t tid, const char* msg, uint16_t len) { if (log_id \u003e= LOG_ID_MAX) { return -EINVAL; } // é€šè¿‡å±æ€§æ§åˆ¶logè¾“å‡º if (length \u003e 0 \u0026\u0026 loglevl \u003c log_id) { return -EINVAL; } â€‹ } 2 kernelé˜¶æ®µ å¯¹äºkernel é˜¶æ®µçš„æœ‰ï¼Œ å¯¹äºä¸å½±å“å¼€æœºçš„modle ï¼Œå¯ä»¥å»ºè®®å»¶è¿ŸåŠ è½½ã€‚ å¯ä»¥ç­‰zygoteå¯åŠ¨åï¼Œåœ¨early-bootæˆ–booté˜¶æ®µå»åŠ è½½ko, è®©zygoteæ—©ç‚¹èµ·æ¥ æ¯”å¦‚è“ç‰™å’Œwifiçš„koé©±åŠ¨ 3 Inité˜¶æ®µ 3.1 zygote åœ¨ late-initä¹‹åå¯åŠ¨ # Mount filesystems and start core system services. on late-init trigger early-fs # Mount fstab in init.{$device}.rc by mount_all command. Optional parameter # '--early' can be specified to skip entries with 'latemount'. # /system and /vendor must be mounted by the end of the fs stage, # while /data is optional. trigger fs trigger post-fs # Mount fstab in init.{$device}.rc by mount_all with '--late' parameter # to only mount entries with 'latemount'. This is needed if '--early' is # specified in the previous mount_all command on the fs stage. # With /system mounted and properties form /system + /factory available, # some services can be started. trigger late-fs # Now we can mount /data. File encryption requires keymaster to decrypt # /data, which in turn can only be loaded when system properties are present. trigger post-fs-data # Load persist properties and override properties (if enabled) from /data. trigger load_persist_props_action # Should be before netd, but after apex, properties and logging is available. trigger load_bpf_programs # Now we can start zygote for devices with file based encryption # è§¦å‘zygoteå¯åŠ¨ trigger zygote-start # Remove a file to wake up anything waiting for firmware. trigger firmware_mounts_complete trigger early-boot trigger boot 3.2 å¹¶è¡Œæ‰§è¡Œuevent(enable_parallel_restorecon) vendor/ueventd.rcä¸­åŠ å…¥parallel_restorecon enable parallel_restorecon enable 3.3 CPU æ‰“å¼€æ€§èƒ½æ¨¡å¼ 1 å¼€æœºçš„æ—¶å€™ï¼Œcpuå¼€å¯æ€§èƒ½æ¨¡å¼ on early-init write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor performance # æŸ¥çœ‹å½“å‰é¢‘ç‡ # cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq 2 å¼€æœºåå…³é—­,æ”¹æˆè‡ªåŠ¨é€‚åº” on property:sys.boot_completed=1 write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor schedutil 4 ç§»é™¤æ²¡æœ‰ç”¨åˆ°çš„æ¨¡å— æ¯”å¦‚ï¼š å¦‚CIæ¨¡å— on post-fs-data insmod /vendor/lib/modules/cimax-usb.ko insmod /vendor/lib/modules/ci.ko 5 å»¶è¿Ÿvendor/etc/initä¸‹çš„éå…³é”®æœåŠ¡ æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œï¼ŒåŠ å¿«zygoteçš„å¯åŠ¨ // æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œ on boot start xxx service xxx /system/bin/xxx user root group system 6 zygote classloaderæ‡’åŠ è½½ï¼Œ æ‡’åŠ è½½ä¼šæ¯”ç›´æ¥åŠ è½½æ›´è€—å†…å­˜ï¼Œæ‡’åŠ è½½æ˜¯é€šè¿‡system-serverå‘é€æŒ‡ä»¤ç»™zygoteåšåŠ è½½ç›¸å…³åŠ¨ä½œï¼Œåœ¨å‘é€æŒ‡ä»¤å‰ï¼Œsystem-serverä¼šåŠ è½½ä¸€éƒ¨åˆ†è‡ªå·±ä½¿ç”¨çš„ç±»ï¼Œä¼šå’Œzygoteä¸­å­˜åœ¨ç›¸åŒçš„ä¸€éƒ¨åˆ†å¤‡ä»½ service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload zygote æ·»åŠ  task_profiles ProcessCapacityHigh MaxPerformance service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload class main priority -20 user root group root readproc reserved_disk socket zygote stream 660 root system socket usap_pool_primary stream 660 root system onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse onrestart write /sys/power/state on onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart netd onrestart restart wificond task_profiles ProcessCapacityHigh MaxPerformance ç²¾ç®€preloadçš„classes , æ¯”å¦‚å¯ä»¥å»æ‰å¦‚ä¸‹class æ ¹æ®é¡¹ç›®çš„æ—¶é—´æƒ…å†µ å¦‚æœéœ€è¦å†åšä¸€äº›å¤§çš„è£å‰ªï¼Œå¯ä»¥ä½¿ç”¨frameworks\\base\\config\\generate-preloaded-classes.shä¸‹çš„è„šæœ¬æ¥ç”Ÿæˆpreloaded-classes // ç”Ÿç‰©è¯†åˆ« android.hardware.biometrics // äººè„¸è¯†åˆ« android.hardware.face // æ‰“å°æœåŠ¡ android.hardware.fingerprint android.print. // éƒ¨åˆ†å®šä½ç›¸å…³, è¿˜æœ‰GPSå®šä½ç›¸å…³ android.hardware.location com.android.internal.location.GpsNetInitiatedHandler android.location.Gnss* // æ‰‹æœºé€šè¯ç›¸å…³ android.telephony. android.telecom. com.android","date":"2024-11-06","objectID":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/:0:0","tags":["blog","Framework"],"title":"å¼€æœºä¼˜åŒ–","uri":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/#6-zygote"},{"categories":["Android"],"collections":["Framework","å¼€æœºå¯åŠ¨"],"content":" æ ¹æ®å¼€æœºçš„é˜¶æ®µï¼Œæœ‰ä¸€äº›ä¼˜åŒ–å¼€æœºé€Ÿåº¦çš„ç©ºé—´ 1. bootloaderé˜¶æ®µ è¿™è¾¹æ¶‰åŠçš„ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œèƒ½ä¿®æ”¹çš„åœ°æ–¹ä¸å¤šã€‚ æœ€å¤šçš„æ˜¯å»å¤„logï¼Œå¯¹æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Œå¹¶ä¸”å¯¹åæœŸé—®é¢˜çš„åˆ†ææœ‰æ¯”è¾ƒå¤§çš„å½±å“ã€‚ æˆ–è€…é€šè¿‡å±æ€§çš„æ§åˆ¶ï¼Œæ¥æ§åˆ¶æ˜¯å¦æ‰“å°å’Œæ‰“å°çš„ç­‰çº§ã€‚ system/core/logd/LogBuffer.cpp int get_log_level() { char buf[PROPERTY_VALUE_MAX]; memset(buf, 0, PROPERTY_VALUE_MAX); property_get(\"persist.xxx.level\", buf, \"\"); return buf[0]; } â€‹ int loglevl = get_log_level(); int LogBuffer::log(log_id_t log_id, log_time realtime, uid_t uid, pid_t pid, pid_t tid, const char* msg, uint16_t len) { if (log_id \u003e= LOG_ID_MAX) { return -EINVAL; } // é€šè¿‡å±æ€§æ§åˆ¶logè¾“å‡º if (length \u003e 0 \u0026\u0026 loglevl \u003c log_id) { return -EINVAL; } â€‹ } 2 kernelé˜¶æ®µ å¯¹äºkernel é˜¶æ®µçš„æœ‰ï¼Œ å¯¹äºä¸å½±å“å¼€æœºçš„modle ï¼Œå¯ä»¥å»ºè®®å»¶è¿ŸåŠ è½½ã€‚ å¯ä»¥ç­‰zygoteå¯åŠ¨åï¼Œåœ¨early-bootæˆ–booté˜¶æ®µå»åŠ è½½ko, è®©zygoteæ—©ç‚¹èµ·æ¥ æ¯”å¦‚è“ç‰™å’Œwifiçš„koé©±åŠ¨ 3 Inité˜¶æ®µ 3.1 zygote åœ¨ late-initä¹‹åå¯åŠ¨ # Mount filesystems and start core system services. on late-init trigger early-fs # Mount fstab in init.{$device}.rc by mount_all command. Optional parameter # '--early' can be specified to skip entries with 'latemount'. # /system and /vendor must be mounted by the end of the fs stage, # while /data is optional. trigger fs trigger post-fs # Mount fstab in init.{$device}.rc by mount_all with '--late' parameter # to only mount entries with 'latemount'. This is needed if '--early' is # specified in the previous mount_all command on the fs stage. # With /system mounted and properties form /system + /factory available, # some services can be started. trigger late-fs # Now we can mount /data. File encryption requires keymaster to decrypt # /data, which in turn can only be loaded when system properties are present. trigger post-fs-data # Load persist properties and override properties (if enabled) from /data. trigger load_persist_props_action # Should be before netd, but after apex, properties and logging is available. trigger load_bpf_programs # Now we can start zygote for devices with file based encryption # è§¦å‘zygoteå¯åŠ¨ trigger zygote-start # Remove a file to wake up anything waiting for firmware. trigger firmware_mounts_complete trigger early-boot trigger boot 3.2 å¹¶è¡Œæ‰§è¡Œuevent(enable_parallel_restorecon) vendor/ueventd.rcä¸­åŠ å…¥parallel_restorecon enable parallel_restorecon enable 3.3 CPU æ‰“å¼€æ€§èƒ½æ¨¡å¼ 1 å¼€æœºçš„æ—¶å€™ï¼Œcpuå¼€å¯æ€§èƒ½æ¨¡å¼ on early-init write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor performance # æŸ¥çœ‹å½“å‰é¢‘ç‡ # cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq 2 å¼€æœºåå…³é—­,æ”¹æˆè‡ªåŠ¨é€‚åº” on property:sys.boot_completed=1 write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor schedutil 4 ç§»é™¤æ²¡æœ‰ç”¨åˆ°çš„æ¨¡å— æ¯”å¦‚ï¼š å¦‚CIæ¨¡å— on post-fs-data insmod /vendor/lib/modules/cimax-usb.ko insmod /vendor/lib/modules/ci.ko 5 å»¶è¿Ÿvendor/etc/initä¸‹çš„éå…³é”®æœåŠ¡ æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œï¼ŒåŠ å¿«zygoteçš„å¯åŠ¨ // æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œ on boot start xxx service xxx /system/bin/xxx user root group system 6 zygote classloaderæ‡’åŠ è½½ï¼Œ æ‡’åŠ è½½ä¼šæ¯”ç›´æ¥åŠ è½½æ›´è€—å†…å­˜ï¼Œæ‡’åŠ è½½æ˜¯é€šè¿‡system-serverå‘é€æŒ‡ä»¤ç»™zygoteåšåŠ è½½ç›¸å…³åŠ¨ä½œï¼Œåœ¨å‘é€æŒ‡ä»¤å‰ï¼Œsystem-serverä¼šåŠ è½½ä¸€éƒ¨åˆ†è‡ªå·±ä½¿ç”¨çš„ç±»ï¼Œä¼šå’Œzygoteä¸­å­˜åœ¨ç›¸åŒçš„ä¸€éƒ¨åˆ†å¤‡ä»½ service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload zygote æ·»åŠ  task_profiles ProcessCapacityHigh MaxPerformance service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload class main priority -20 user root group root readproc reserved_disk socket zygote stream 660 root system socket usap_pool_primary stream 660 root system onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse onrestart write /sys/power/state on onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart netd onrestart restart wificond task_profiles ProcessCapacityHigh MaxPerformance ç²¾ç®€preloadçš„classes , æ¯”å¦‚å¯ä»¥å»æ‰å¦‚ä¸‹class æ ¹æ®é¡¹ç›®çš„æ—¶é—´æƒ…å†µ å¦‚æœéœ€è¦å†åšä¸€äº›å¤§çš„è£å‰ªï¼Œå¯ä»¥ä½¿ç”¨frameworks\\base\\config\\generate-preloaded-classes.shä¸‹çš„è„šæœ¬æ¥ç”Ÿæˆpreloaded-classes // ç”Ÿç‰©è¯†åˆ« android.hardware.biometrics // äººè„¸è¯†åˆ« android.hardware.face // æ‰“å°æœåŠ¡ android.hardware.fingerprint android.print. // éƒ¨åˆ†å®šä½ç›¸å…³, è¿˜æœ‰GPSå®šä½ç›¸å…³ android.hardware.location com.android.internal.location.GpsNetInitiatedHandler android.location.Gnss* // æ‰‹æœºé€šè¯ç›¸å…³ android.telephony. android.telecom. com.android","date":"2024-11-06","objectID":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/:0:0","tags":["blog","Framework"],"title":"å¼€æœºä¼˜åŒ–","uri":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/#classloaderæ‡’åŠ è½½"},{"categories":["Android"],"collections":["Framework","å¼€æœºå¯åŠ¨"],"content":" æ ¹æ®å¼€æœºçš„é˜¶æ®µï¼Œæœ‰ä¸€äº›ä¼˜åŒ–å¼€æœºé€Ÿåº¦çš„ç©ºé—´ 1. bootloaderé˜¶æ®µ è¿™è¾¹æ¶‰åŠçš„ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œèƒ½ä¿®æ”¹çš„åœ°æ–¹ä¸å¤šã€‚ æœ€å¤šçš„æ˜¯å»å¤„logï¼Œå¯¹æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Œå¹¶ä¸”å¯¹åæœŸé—®é¢˜çš„åˆ†ææœ‰æ¯”è¾ƒå¤§çš„å½±å“ã€‚ æˆ–è€…é€šè¿‡å±æ€§çš„æ§åˆ¶ï¼Œæ¥æ§åˆ¶æ˜¯å¦æ‰“å°å’Œæ‰“å°çš„ç­‰çº§ã€‚ system/core/logd/LogBuffer.cpp int get_log_level() { char buf[PROPERTY_VALUE_MAX]; memset(buf, 0, PROPERTY_VALUE_MAX); property_get(\"persist.xxx.level\", buf, \"\"); return buf[0]; } â€‹ int loglevl = get_log_level(); int LogBuffer::log(log_id_t log_id, log_time realtime, uid_t uid, pid_t pid, pid_t tid, const char* msg, uint16_t len) { if (log_id \u003e= LOG_ID_MAX) { return -EINVAL; } // é€šè¿‡å±æ€§æ§åˆ¶logè¾“å‡º if (length \u003e 0 \u0026\u0026 loglevl \u003c log_id) { return -EINVAL; } â€‹ } 2 kernelé˜¶æ®µ å¯¹äºkernel é˜¶æ®µçš„æœ‰ï¼Œ å¯¹äºä¸å½±å“å¼€æœºçš„modle ï¼Œå¯ä»¥å»ºè®®å»¶è¿ŸåŠ è½½ã€‚ å¯ä»¥ç­‰zygoteå¯åŠ¨åï¼Œåœ¨early-bootæˆ–booté˜¶æ®µå»åŠ è½½ko, è®©zygoteæ—©ç‚¹èµ·æ¥ æ¯”å¦‚è“ç‰™å’Œwifiçš„koé©±åŠ¨ 3 Inité˜¶æ®µ 3.1 zygote åœ¨ late-initä¹‹åå¯åŠ¨ # Mount filesystems and start core system services. on late-init trigger early-fs # Mount fstab in init.{$device}.rc by mount_all command. Optional parameter # '--early' can be specified to skip entries with 'latemount'. # /system and /vendor must be mounted by the end of the fs stage, # while /data is optional. trigger fs trigger post-fs # Mount fstab in init.{$device}.rc by mount_all with '--late' parameter # to only mount entries with 'latemount'. This is needed if '--early' is # specified in the previous mount_all command on the fs stage. # With /system mounted and properties form /system + /factory available, # some services can be started. trigger late-fs # Now we can mount /data. File encryption requires keymaster to decrypt # /data, which in turn can only be loaded when system properties are present. trigger post-fs-data # Load persist properties and override properties (if enabled) from /data. trigger load_persist_props_action # Should be before netd, but after apex, properties and logging is available. trigger load_bpf_programs # Now we can start zygote for devices with file based encryption # è§¦å‘zygoteå¯åŠ¨ trigger zygote-start # Remove a file to wake up anything waiting for firmware. trigger firmware_mounts_complete trigger early-boot trigger boot 3.2 å¹¶è¡Œæ‰§è¡Œuevent(enable_parallel_restorecon) vendor/ueventd.rcä¸­åŠ å…¥parallel_restorecon enable parallel_restorecon enable 3.3 CPU æ‰“å¼€æ€§èƒ½æ¨¡å¼ 1 å¼€æœºçš„æ—¶å€™ï¼Œcpuå¼€å¯æ€§èƒ½æ¨¡å¼ on early-init write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor performance # æŸ¥çœ‹å½“å‰é¢‘ç‡ # cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq 2 å¼€æœºåå…³é—­,æ”¹æˆè‡ªåŠ¨é€‚åº” on property:sys.boot_completed=1 write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor schedutil 4 ç§»é™¤æ²¡æœ‰ç”¨åˆ°çš„æ¨¡å— æ¯”å¦‚ï¼š å¦‚CIæ¨¡å— on post-fs-data insmod /vendor/lib/modules/cimax-usb.ko insmod /vendor/lib/modules/ci.ko 5 å»¶è¿Ÿvendor/etc/initä¸‹çš„éå…³é”®æœåŠ¡ æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œï¼ŒåŠ å¿«zygoteçš„å¯åŠ¨ // æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œ on boot start xxx service xxx /system/bin/xxx user root group system 6 zygote classloaderæ‡’åŠ è½½ï¼Œ æ‡’åŠ è½½ä¼šæ¯”ç›´æ¥åŠ è½½æ›´è€—å†…å­˜ï¼Œæ‡’åŠ è½½æ˜¯é€šè¿‡system-serverå‘é€æŒ‡ä»¤ç»™zygoteåšåŠ è½½ç›¸å…³åŠ¨ä½œï¼Œåœ¨å‘é€æŒ‡ä»¤å‰ï¼Œsystem-serverä¼šåŠ è½½ä¸€éƒ¨åˆ†è‡ªå·±ä½¿ç”¨çš„ç±»ï¼Œä¼šå’Œzygoteä¸­å­˜åœ¨ç›¸åŒçš„ä¸€éƒ¨åˆ†å¤‡ä»½ service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload zygote æ·»åŠ  task_profiles ProcessCapacityHigh MaxPerformance service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload class main priority -20 user root group root readproc reserved_disk socket zygote stream 660 root system socket usap_pool_primary stream 660 root system onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse onrestart write /sys/power/state on onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart netd onrestart restart wificond task_profiles ProcessCapacityHigh MaxPerformance ç²¾ç®€preloadçš„classes , æ¯”å¦‚å¯ä»¥å»æ‰å¦‚ä¸‹class æ ¹æ®é¡¹ç›®çš„æ—¶é—´æƒ…å†µ å¦‚æœéœ€è¦å†åšä¸€äº›å¤§çš„è£å‰ªï¼Œå¯ä»¥ä½¿ç”¨frameworks\\base\\config\\generate-preloaded-classes.shä¸‹çš„è„šæœ¬æ¥ç”Ÿæˆpreloaded-classes // ç”Ÿç‰©è¯†åˆ« android.hardware.biometrics // äººè„¸è¯†åˆ« android.hardware.face // æ‰“å°æœåŠ¡ android.hardware.fingerprint android.print. // éƒ¨åˆ†å®šä½ç›¸å…³, è¿˜æœ‰GPSå®šä½ç›¸å…³ android.hardware.location com.android.internal.location.GpsNetInitiatedHandler android.location.Gnss* // æ‰‹æœºé€šè¯ç›¸å…³ android.telephony. android.telecom. com.android","date":"2024-11-06","objectID":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/:0:0","tags":["blog","Framework"],"title":"å¼€æœºä¼˜åŒ–","uri":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/#zygote-æ·»åŠ -task_profiles-processcapacityhigh-maxperformance"},{"categories":["Android"],"collections":["Framework","å¼€æœºå¯åŠ¨"],"content":" æ ¹æ®å¼€æœºçš„é˜¶æ®µï¼Œæœ‰ä¸€äº›ä¼˜åŒ–å¼€æœºé€Ÿåº¦çš„ç©ºé—´ 1. bootloaderé˜¶æ®µ è¿™è¾¹æ¶‰åŠçš„ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œèƒ½ä¿®æ”¹çš„åœ°æ–¹ä¸å¤šã€‚ æœ€å¤šçš„æ˜¯å»å¤„logï¼Œå¯¹æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Œå¹¶ä¸”å¯¹åæœŸé—®é¢˜çš„åˆ†ææœ‰æ¯”è¾ƒå¤§çš„å½±å“ã€‚ æˆ–è€…é€šè¿‡å±æ€§çš„æ§åˆ¶ï¼Œæ¥æ§åˆ¶æ˜¯å¦æ‰“å°å’Œæ‰“å°çš„ç­‰çº§ã€‚ system/core/logd/LogBuffer.cpp int get_log_level() { char buf[PROPERTY_VALUE_MAX]; memset(buf, 0, PROPERTY_VALUE_MAX); property_get(\"persist.xxx.level\", buf, \"\"); return buf[0]; } â€‹ int loglevl = get_log_level(); int LogBuffer::log(log_id_t log_id, log_time realtime, uid_t uid, pid_t pid, pid_t tid, const char* msg, uint16_t len) { if (log_id \u003e= LOG_ID_MAX) { return -EINVAL; } // é€šè¿‡å±æ€§æ§åˆ¶logè¾“å‡º if (length \u003e 0 \u0026\u0026 loglevl \u003c log_id) { return -EINVAL; } â€‹ } 2 kernelé˜¶æ®µ å¯¹äºkernel é˜¶æ®µçš„æœ‰ï¼Œ å¯¹äºä¸å½±å“å¼€æœºçš„modle ï¼Œå¯ä»¥å»ºè®®å»¶è¿ŸåŠ è½½ã€‚ å¯ä»¥ç­‰zygoteå¯åŠ¨åï¼Œåœ¨early-bootæˆ–booté˜¶æ®µå»åŠ è½½ko, è®©zygoteæ—©ç‚¹èµ·æ¥ æ¯”å¦‚è“ç‰™å’Œwifiçš„koé©±åŠ¨ 3 Inité˜¶æ®µ 3.1 zygote åœ¨ late-initä¹‹åå¯åŠ¨ # Mount filesystems and start core system services. on late-init trigger early-fs # Mount fstab in init.{$device}.rc by mount_all command. Optional parameter # '--early' can be specified to skip entries with 'latemount'. # /system and /vendor must be mounted by the end of the fs stage, # while /data is optional. trigger fs trigger post-fs # Mount fstab in init.{$device}.rc by mount_all with '--late' parameter # to only mount entries with 'latemount'. This is needed if '--early' is # specified in the previous mount_all command on the fs stage. # With /system mounted and properties form /system + /factory available, # some services can be started. trigger late-fs # Now we can mount /data. File encryption requires keymaster to decrypt # /data, which in turn can only be loaded when system properties are present. trigger post-fs-data # Load persist properties and override properties (if enabled) from /data. trigger load_persist_props_action # Should be before netd, but after apex, properties and logging is available. trigger load_bpf_programs # Now we can start zygote for devices with file based encryption # è§¦å‘zygoteå¯åŠ¨ trigger zygote-start # Remove a file to wake up anything waiting for firmware. trigger firmware_mounts_complete trigger early-boot trigger boot 3.2 å¹¶è¡Œæ‰§è¡Œuevent(enable_parallel_restorecon) vendor/ueventd.rcä¸­åŠ å…¥parallel_restorecon enable parallel_restorecon enable 3.3 CPU æ‰“å¼€æ€§èƒ½æ¨¡å¼ 1 å¼€æœºçš„æ—¶å€™ï¼Œcpuå¼€å¯æ€§èƒ½æ¨¡å¼ on early-init write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor performance # æŸ¥çœ‹å½“å‰é¢‘ç‡ # cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq 2 å¼€æœºåå…³é—­,æ”¹æˆè‡ªåŠ¨é€‚åº” on property:sys.boot_completed=1 write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor schedutil 4 ç§»é™¤æ²¡æœ‰ç”¨åˆ°çš„æ¨¡å— æ¯”å¦‚ï¼š å¦‚CIæ¨¡å— on post-fs-data insmod /vendor/lib/modules/cimax-usb.ko insmod /vendor/lib/modules/ci.ko 5 å»¶è¿Ÿvendor/etc/initä¸‹çš„éå…³é”®æœåŠ¡ æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œï¼ŒåŠ å¿«zygoteçš„å¯åŠ¨ // æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œ on boot start xxx service xxx /system/bin/xxx user root group system 6 zygote classloaderæ‡’åŠ è½½ï¼Œ æ‡’åŠ è½½ä¼šæ¯”ç›´æ¥åŠ è½½æ›´è€—å†…å­˜ï¼Œæ‡’åŠ è½½æ˜¯é€šè¿‡system-serverå‘é€æŒ‡ä»¤ç»™zygoteåšåŠ è½½ç›¸å…³åŠ¨ä½œï¼Œåœ¨å‘é€æŒ‡ä»¤å‰ï¼Œsystem-serverä¼šåŠ è½½ä¸€éƒ¨åˆ†è‡ªå·±ä½¿ç”¨çš„ç±»ï¼Œä¼šå’Œzygoteä¸­å­˜åœ¨ç›¸åŒçš„ä¸€éƒ¨åˆ†å¤‡ä»½ service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload zygote æ·»åŠ  task_profiles ProcessCapacityHigh MaxPerformance service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload class main priority -20 user root group root readproc reserved_disk socket zygote stream 660 root system socket usap_pool_primary stream 660 root system onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse onrestart write /sys/power/state on onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart netd onrestart restart wificond task_profiles ProcessCapacityHigh MaxPerformance ç²¾ç®€preloadçš„classes , æ¯”å¦‚å¯ä»¥å»æ‰å¦‚ä¸‹class æ ¹æ®é¡¹ç›®çš„æ—¶é—´æƒ…å†µ å¦‚æœéœ€è¦å†åšä¸€äº›å¤§çš„è£å‰ªï¼Œå¯ä»¥ä½¿ç”¨frameworks\\base\\config\\generate-preloaded-classes.shä¸‹çš„è„šæœ¬æ¥ç”Ÿæˆpreloaded-classes // ç”Ÿç‰©è¯†åˆ« android.hardware.biometrics // äººè„¸è¯†åˆ« android.hardware.face // æ‰“å°æœåŠ¡ android.hardware.fingerprint android.print. // éƒ¨åˆ†å®šä½ç›¸å…³, è¿˜æœ‰GPSå®šä½ç›¸å…³ android.hardware.location com.android.internal.location.GpsNetInitiatedHandler android.location.Gnss* // æ‰‹æœºé€šè¯ç›¸å…³ android.telephony. android.telecom. com.android","date":"2024-11-06","objectID":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/:0:0","tags":["blog","Framework"],"title":"å¼€æœºä¼˜åŒ–","uri":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/#ç²¾ç®€preloadçš„classes--æ¯”å¦‚å¯ä»¥å»æ‰å¦‚ä¸‹class"},{"categories":["Android"],"collections":["Framework","å¼€æœºå¯åŠ¨"],"content":" æ ¹æ®å¼€æœºçš„é˜¶æ®µï¼Œæœ‰ä¸€äº›ä¼˜åŒ–å¼€æœºé€Ÿåº¦çš„ç©ºé—´ 1. bootloaderé˜¶æ®µ è¿™è¾¹æ¶‰åŠçš„ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œèƒ½ä¿®æ”¹çš„åœ°æ–¹ä¸å¤šã€‚ æœ€å¤šçš„æ˜¯å»å¤„logï¼Œå¯¹æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Œå¹¶ä¸”å¯¹åæœŸé—®é¢˜çš„åˆ†ææœ‰æ¯”è¾ƒå¤§çš„å½±å“ã€‚ æˆ–è€…é€šè¿‡å±æ€§çš„æ§åˆ¶ï¼Œæ¥æ§åˆ¶æ˜¯å¦æ‰“å°å’Œæ‰“å°çš„ç­‰çº§ã€‚ system/core/logd/LogBuffer.cpp int get_log_level() { char buf[PROPERTY_VALUE_MAX]; memset(buf, 0, PROPERTY_VALUE_MAX); property_get(\"persist.xxx.level\", buf, \"\"); return buf[0]; } â€‹ int loglevl = get_log_level(); int LogBuffer::log(log_id_t log_id, log_time realtime, uid_t uid, pid_t pid, pid_t tid, const char* msg, uint16_t len) { if (log_id \u003e= LOG_ID_MAX) { return -EINVAL; } // é€šè¿‡å±æ€§æ§åˆ¶logè¾“å‡º if (length \u003e 0 \u0026\u0026 loglevl \u003c log_id) { return -EINVAL; } â€‹ } 2 kernelé˜¶æ®µ å¯¹äºkernel é˜¶æ®µçš„æœ‰ï¼Œ å¯¹äºä¸å½±å“å¼€æœºçš„modle ï¼Œå¯ä»¥å»ºè®®å»¶è¿ŸåŠ è½½ã€‚ å¯ä»¥ç­‰zygoteå¯åŠ¨åï¼Œåœ¨early-bootæˆ–booté˜¶æ®µå»åŠ è½½ko, è®©zygoteæ—©ç‚¹èµ·æ¥ æ¯”å¦‚è“ç‰™å’Œwifiçš„koé©±åŠ¨ 3 Inité˜¶æ®µ 3.1 zygote åœ¨ late-initä¹‹åå¯åŠ¨ # Mount filesystems and start core system services. on late-init trigger early-fs # Mount fstab in init.{$device}.rc by mount_all command. Optional parameter # '--early' can be specified to skip entries with 'latemount'. # /system and /vendor must be mounted by the end of the fs stage, # while /data is optional. trigger fs trigger post-fs # Mount fstab in init.{$device}.rc by mount_all with '--late' parameter # to only mount entries with 'latemount'. This is needed if '--early' is # specified in the previous mount_all command on the fs stage. # With /system mounted and properties form /system + /factory available, # some services can be started. trigger late-fs # Now we can mount /data. File encryption requires keymaster to decrypt # /data, which in turn can only be loaded when system properties are present. trigger post-fs-data # Load persist properties and override properties (if enabled) from /data. trigger load_persist_props_action # Should be before netd, but after apex, properties and logging is available. trigger load_bpf_programs # Now we can start zygote for devices with file based encryption # è§¦å‘zygoteå¯åŠ¨ trigger zygote-start # Remove a file to wake up anything waiting for firmware. trigger firmware_mounts_complete trigger early-boot trigger boot 3.2 å¹¶è¡Œæ‰§è¡Œuevent(enable_parallel_restorecon) vendor/ueventd.rcä¸­åŠ å…¥parallel_restorecon enable parallel_restorecon enable 3.3 CPU æ‰“å¼€æ€§èƒ½æ¨¡å¼ 1 å¼€æœºçš„æ—¶å€™ï¼Œcpuå¼€å¯æ€§èƒ½æ¨¡å¼ on early-init write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor performance # æŸ¥çœ‹å½“å‰é¢‘ç‡ # cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq 2 å¼€æœºåå…³é—­,æ”¹æˆè‡ªåŠ¨é€‚åº” on property:sys.boot_completed=1 write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor schedutil 4 ç§»é™¤æ²¡æœ‰ç”¨åˆ°çš„æ¨¡å— æ¯”å¦‚ï¼š å¦‚CIæ¨¡å— on post-fs-data insmod /vendor/lib/modules/cimax-usb.ko insmod /vendor/lib/modules/ci.ko 5 å»¶è¿Ÿvendor/etc/initä¸‹çš„éå…³é”®æœåŠ¡ æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œï¼ŒåŠ å¿«zygoteçš„å¯åŠ¨ // æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œ on boot start xxx service xxx /system/bin/xxx user root group system 6 zygote classloaderæ‡’åŠ è½½ï¼Œ æ‡’åŠ è½½ä¼šæ¯”ç›´æ¥åŠ è½½æ›´è€—å†…å­˜ï¼Œæ‡’åŠ è½½æ˜¯é€šè¿‡system-serverå‘é€æŒ‡ä»¤ç»™zygoteåšåŠ è½½ç›¸å…³åŠ¨ä½œï¼Œåœ¨å‘é€æŒ‡ä»¤å‰ï¼Œsystem-serverä¼šåŠ è½½ä¸€éƒ¨åˆ†è‡ªå·±ä½¿ç”¨çš„ç±»ï¼Œä¼šå’Œzygoteä¸­å­˜åœ¨ç›¸åŒçš„ä¸€éƒ¨åˆ†å¤‡ä»½ service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload zygote æ·»åŠ  task_profiles ProcessCapacityHigh MaxPerformance service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload class main priority -20 user root group root readproc reserved_disk socket zygote stream 660 root system socket usap_pool_primary stream 660 root system onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse onrestart write /sys/power/state on onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart netd onrestart restart wificond task_profiles ProcessCapacityHigh MaxPerformance ç²¾ç®€preloadçš„classes , æ¯”å¦‚å¯ä»¥å»æ‰å¦‚ä¸‹class æ ¹æ®é¡¹ç›®çš„æ—¶é—´æƒ…å†µ å¦‚æœéœ€è¦å†åšä¸€äº›å¤§çš„è£å‰ªï¼Œå¯ä»¥ä½¿ç”¨frameworks\\base\\config\\generate-preloaded-classes.shä¸‹çš„è„šæœ¬æ¥ç”Ÿæˆpreloaded-classes // ç”Ÿç‰©è¯†åˆ« android.hardware.biometrics // äººè„¸è¯†åˆ« android.hardware.face // æ‰“å°æœåŠ¡ android.hardware.fingerprint android.print. // éƒ¨åˆ†å®šä½ç›¸å…³, è¿˜æœ‰GPSå®šä½ç›¸å…³ android.hardware.location com.android.internal.location.GpsNetInitiatedHandler android.location.Gnss* // æ‰‹æœºé€šè¯ç›¸å…³ android.telephony. android.telecom. com.android","date":"2024-11-06","objectID":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/:0:0","tags":["blog","Framework"],"title":"å¼€æœºä¼˜åŒ–","uri":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/#å…³é—­-systemserverè™šæ‹Ÿæœºå®åˆ—çš„-classverify"},{"categories":["Android"],"collections":["Framework","å¼€æœºå¯åŠ¨"],"content":" æ ¹æ®å¼€æœºçš„é˜¶æ®µï¼Œæœ‰ä¸€äº›ä¼˜åŒ–å¼€æœºé€Ÿåº¦çš„ç©ºé—´ 1. bootloaderé˜¶æ®µ è¿™è¾¹æ¶‰åŠçš„ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œèƒ½ä¿®æ”¹çš„åœ°æ–¹ä¸å¤šã€‚ æœ€å¤šçš„æ˜¯å»å¤„logï¼Œå¯¹æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Œå¹¶ä¸”å¯¹åæœŸé—®é¢˜çš„åˆ†ææœ‰æ¯”è¾ƒå¤§çš„å½±å“ã€‚ æˆ–è€…é€šè¿‡å±æ€§çš„æ§åˆ¶ï¼Œæ¥æ§åˆ¶æ˜¯å¦æ‰“å°å’Œæ‰“å°çš„ç­‰çº§ã€‚ system/core/logd/LogBuffer.cpp int get_log_level() { char buf[PROPERTY_VALUE_MAX]; memset(buf, 0, PROPERTY_VALUE_MAX); property_get(\"persist.xxx.level\", buf, \"\"); return buf[0]; } â€‹ int loglevl = get_log_level(); int LogBuffer::log(log_id_t log_id, log_time realtime, uid_t uid, pid_t pid, pid_t tid, const char* msg, uint16_t len) { if (log_id \u003e= LOG_ID_MAX) { return -EINVAL; } // é€šè¿‡å±æ€§æ§åˆ¶logè¾“å‡º if (length \u003e 0 \u0026\u0026 loglevl \u003c log_id) { return -EINVAL; } â€‹ } 2 kernelé˜¶æ®µ å¯¹äºkernel é˜¶æ®µçš„æœ‰ï¼Œ å¯¹äºä¸å½±å“å¼€æœºçš„modle ï¼Œå¯ä»¥å»ºè®®å»¶è¿ŸåŠ è½½ã€‚ å¯ä»¥ç­‰zygoteå¯åŠ¨åï¼Œåœ¨early-bootæˆ–booté˜¶æ®µå»åŠ è½½ko, è®©zygoteæ—©ç‚¹èµ·æ¥ æ¯”å¦‚è“ç‰™å’Œwifiçš„koé©±åŠ¨ 3 Inité˜¶æ®µ 3.1 zygote åœ¨ late-initä¹‹åå¯åŠ¨ # Mount filesystems and start core system services. on late-init trigger early-fs # Mount fstab in init.{$device}.rc by mount_all command. Optional parameter # '--early' can be specified to skip entries with 'latemount'. # /system and /vendor must be mounted by the end of the fs stage, # while /data is optional. trigger fs trigger post-fs # Mount fstab in init.{$device}.rc by mount_all with '--late' parameter # to only mount entries with 'latemount'. This is needed if '--early' is # specified in the previous mount_all command on the fs stage. # With /system mounted and properties form /system + /factory available, # some services can be started. trigger late-fs # Now we can mount /data. File encryption requires keymaster to decrypt # /data, which in turn can only be loaded when system properties are present. trigger post-fs-data # Load persist properties and override properties (if enabled) from /data. trigger load_persist_props_action # Should be before netd, but after apex, properties and logging is available. trigger load_bpf_programs # Now we can start zygote for devices with file based encryption # è§¦å‘zygoteå¯åŠ¨ trigger zygote-start # Remove a file to wake up anything waiting for firmware. trigger firmware_mounts_complete trigger early-boot trigger boot 3.2 å¹¶è¡Œæ‰§è¡Œuevent(enable_parallel_restorecon) vendor/ueventd.rcä¸­åŠ å…¥parallel_restorecon enable parallel_restorecon enable 3.3 CPU æ‰“å¼€æ€§èƒ½æ¨¡å¼ 1 å¼€æœºçš„æ—¶å€™ï¼Œcpuå¼€å¯æ€§èƒ½æ¨¡å¼ on early-init write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor performance # æŸ¥çœ‹å½“å‰é¢‘ç‡ # cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq 2 å¼€æœºåå…³é—­,æ”¹æˆè‡ªåŠ¨é€‚åº” on property:sys.boot_completed=1 write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor schedutil 4 ç§»é™¤æ²¡æœ‰ç”¨åˆ°çš„æ¨¡å— æ¯”å¦‚ï¼š å¦‚CIæ¨¡å— on post-fs-data insmod /vendor/lib/modules/cimax-usb.ko insmod /vendor/lib/modules/ci.ko 5 å»¶è¿Ÿvendor/etc/initä¸‹çš„éå…³é”®æœåŠ¡ æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œï¼ŒåŠ å¿«zygoteçš„å¯åŠ¨ // æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œ on boot start xxx service xxx /system/bin/xxx user root group system 6 zygote classloaderæ‡’åŠ è½½ï¼Œ æ‡’åŠ è½½ä¼šæ¯”ç›´æ¥åŠ è½½æ›´è€—å†…å­˜ï¼Œæ‡’åŠ è½½æ˜¯é€šè¿‡system-serverå‘é€æŒ‡ä»¤ç»™zygoteåšåŠ è½½ç›¸å…³åŠ¨ä½œï¼Œåœ¨å‘é€æŒ‡ä»¤å‰ï¼Œsystem-serverä¼šåŠ è½½ä¸€éƒ¨åˆ†è‡ªå·±ä½¿ç”¨çš„ç±»ï¼Œä¼šå’Œzygoteä¸­å­˜åœ¨ç›¸åŒçš„ä¸€éƒ¨åˆ†å¤‡ä»½ service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload zygote æ·»åŠ  task_profiles ProcessCapacityHigh MaxPerformance service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload class main priority -20 user root group root readproc reserved_disk socket zygote stream 660 root system socket usap_pool_primary stream 660 root system onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse onrestart write /sys/power/state on onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart netd onrestart restart wificond task_profiles ProcessCapacityHigh MaxPerformance ç²¾ç®€preloadçš„classes , æ¯”å¦‚å¯ä»¥å»æ‰å¦‚ä¸‹class æ ¹æ®é¡¹ç›®çš„æ—¶é—´æƒ…å†µ å¦‚æœéœ€è¦å†åšä¸€äº›å¤§çš„è£å‰ªï¼Œå¯ä»¥ä½¿ç”¨frameworks\\base\\config\\generate-preloaded-classes.shä¸‹çš„è„šæœ¬æ¥ç”Ÿæˆpreloaded-classes // ç”Ÿç‰©è¯†åˆ« android.hardware.biometrics // äººè„¸è¯†åˆ« android.hardware.face // æ‰“å°æœåŠ¡ android.hardware.fingerprint android.print. // éƒ¨åˆ†å®šä½ç›¸å…³, è¿˜æœ‰GPSå®šä½ç›¸å…³ android.hardware.location com.android.internal.location.GpsNetInitiatedHandler android.location.Gnss* // æ‰‹æœºé€šè¯ç›¸å…³ android.telephony. android.telecom. com.android","date":"2024-11-06","objectID":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/:0:0","tags":["blog","Framework"],"title":"å¼€æœºä¼˜åŒ–","uri":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/#systemserver"},{"categories":["Android"],"collections":["Framework","å¼€æœºå¯åŠ¨"],"content":" æ ¹æ®å¼€æœºçš„é˜¶æ®µï¼Œæœ‰ä¸€äº›ä¼˜åŒ–å¼€æœºé€Ÿåº¦çš„ç©ºé—´ 1. bootloaderé˜¶æ®µ è¿™è¾¹æ¶‰åŠçš„ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œèƒ½ä¿®æ”¹çš„åœ°æ–¹ä¸å¤šã€‚ æœ€å¤šçš„æ˜¯å»å¤„logï¼Œå¯¹æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Œå¹¶ä¸”å¯¹åæœŸé—®é¢˜çš„åˆ†ææœ‰æ¯”è¾ƒå¤§çš„å½±å“ã€‚ æˆ–è€…é€šè¿‡å±æ€§çš„æ§åˆ¶ï¼Œæ¥æ§åˆ¶æ˜¯å¦æ‰“å°å’Œæ‰“å°çš„ç­‰çº§ã€‚ system/core/logd/LogBuffer.cpp int get_log_level() { char buf[PROPERTY_VALUE_MAX]; memset(buf, 0, PROPERTY_VALUE_MAX); property_get(\"persist.xxx.level\", buf, \"\"); return buf[0]; } â€‹ int loglevl = get_log_level(); int LogBuffer::log(log_id_t log_id, log_time realtime, uid_t uid, pid_t pid, pid_t tid, const char* msg, uint16_t len) { if (log_id \u003e= LOG_ID_MAX) { return -EINVAL; } // é€šè¿‡å±æ€§æ§åˆ¶logè¾“å‡º if (length \u003e 0 \u0026\u0026 loglevl \u003c log_id) { return -EINVAL; } â€‹ } 2 kernelé˜¶æ®µ å¯¹äºkernel é˜¶æ®µçš„æœ‰ï¼Œ å¯¹äºä¸å½±å“å¼€æœºçš„modle ï¼Œå¯ä»¥å»ºè®®å»¶è¿ŸåŠ è½½ã€‚ å¯ä»¥ç­‰zygoteå¯åŠ¨åï¼Œåœ¨early-bootæˆ–booté˜¶æ®µå»åŠ è½½ko, è®©zygoteæ—©ç‚¹èµ·æ¥ æ¯”å¦‚è“ç‰™å’Œwifiçš„koé©±åŠ¨ 3 Inité˜¶æ®µ 3.1 zygote åœ¨ late-initä¹‹åå¯åŠ¨ # Mount filesystems and start core system services. on late-init trigger early-fs # Mount fstab in init.{$device}.rc by mount_all command. Optional parameter # '--early' can be specified to skip entries with 'latemount'. # /system and /vendor must be mounted by the end of the fs stage, # while /data is optional. trigger fs trigger post-fs # Mount fstab in init.{$device}.rc by mount_all with '--late' parameter # to only mount entries with 'latemount'. This is needed if '--early' is # specified in the previous mount_all command on the fs stage. # With /system mounted and properties form /system + /factory available, # some services can be started. trigger late-fs # Now we can mount /data. File encryption requires keymaster to decrypt # /data, which in turn can only be loaded when system properties are present. trigger post-fs-data # Load persist properties and override properties (if enabled) from /data. trigger load_persist_props_action # Should be before netd, but after apex, properties and logging is available. trigger load_bpf_programs # Now we can start zygote for devices with file based encryption # è§¦å‘zygoteå¯åŠ¨ trigger zygote-start # Remove a file to wake up anything waiting for firmware. trigger firmware_mounts_complete trigger early-boot trigger boot 3.2 å¹¶è¡Œæ‰§è¡Œuevent(enable_parallel_restorecon) vendor/ueventd.rcä¸­åŠ å…¥parallel_restorecon enable parallel_restorecon enable 3.3 CPU æ‰“å¼€æ€§èƒ½æ¨¡å¼ 1 å¼€æœºçš„æ—¶å€™ï¼Œcpuå¼€å¯æ€§èƒ½æ¨¡å¼ on early-init write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor performance # æŸ¥çœ‹å½“å‰é¢‘ç‡ # cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq 2 å¼€æœºåå…³é—­,æ”¹æˆè‡ªåŠ¨é€‚åº” on property:sys.boot_completed=1 write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor schedutil 4 ç§»é™¤æ²¡æœ‰ç”¨åˆ°çš„æ¨¡å— æ¯”å¦‚ï¼š å¦‚CIæ¨¡å— on post-fs-data insmod /vendor/lib/modules/cimax-usb.ko insmod /vendor/lib/modules/ci.ko 5 å»¶è¿Ÿvendor/etc/initä¸‹çš„éå…³é”®æœåŠ¡ æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œï¼ŒåŠ å¿«zygoteçš„å¯åŠ¨ // æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œ on boot start xxx service xxx /system/bin/xxx user root group system 6 zygote classloaderæ‡’åŠ è½½ï¼Œ æ‡’åŠ è½½ä¼šæ¯”ç›´æ¥åŠ è½½æ›´è€—å†…å­˜ï¼Œæ‡’åŠ è½½æ˜¯é€šè¿‡system-serverå‘é€æŒ‡ä»¤ç»™zygoteåšåŠ è½½ç›¸å…³åŠ¨ä½œï¼Œåœ¨å‘é€æŒ‡ä»¤å‰ï¼Œsystem-serverä¼šåŠ è½½ä¸€éƒ¨åˆ†è‡ªå·±ä½¿ç”¨çš„ç±»ï¼Œä¼šå’Œzygoteä¸­å­˜åœ¨ç›¸åŒçš„ä¸€éƒ¨åˆ†å¤‡ä»½ service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload zygote æ·»åŠ  task_profiles ProcessCapacityHigh MaxPerformance service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload class main priority -20 user root group root readproc reserved_disk socket zygote stream 660 root system socket usap_pool_primary stream 660 root system onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse onrestart write /sys/power/state on onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart netd onrestart restart wificond task_profiles ProcessCapacityHigh MaxPerformance ç²¾ç®€preloadçš„classes , æ¯”å¦‚å¯ä»¥å»æ‰å¦‚ä¸‹class æ ¹æ®é¡¹ç›®çš„æ—¶é—´æƒ…å†µ å¦‚æœéœ€è¦å†åšä¸€äº›å¤§çš„è£å‰ªï¼Œå¯ä»¥ä½¿ç”¨frameworks\\base\\config\\generate-preloaded-classes.shä¸‹çš„è„šæœ¬æ¥ç”Ÿæˆpreloaded-classes // ç”Ÿç‰©è¯†åˆ« android.hardware.biometrics // äººè„¸è¯†åˆ« android.hardware.face // æ‰“å°æœåŠ¡ android.hardware.fingerprint android.print. // éƒ¨åˆ†å®šä½ç›¸å…³, è¿˜æœ‰GPSå®šä½ç›¸å…³ android.hardware.location com.android.internal.location.GpsNetInitiatedHandler android.location.Gnss* // æ‰‹æœºé€šè¯ç›¸å…³ android.telephony. android.telecom. com.android","date":"2024-11-06","objectID":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/:0:0","tags":["blog","Framework"],"title":"å¼€æœºä¼˜åŒ–","uri":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/#71-è°ƒæ•´systemserverè¿›ç¨‹çº¿ç¨‹ä¼˜å…ˆçº§"},{"categories":["Android"],"collections":["Framework","å¼€æœºå¯åŠ¨"],"content":" æ ¹æ®å¼€æœºçš„é˜¶æ®µï¼Œæœ‰ä¸€äº›ä¼˜åŒ–å¼€æœºé€Ÿåº¦çš„ç©ºé—´ 1. bootloaderé˜¶æ®µ è¿™è¾¹æ¶‰åŠçš„ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œèƒ½ä¿®æ”¹çš„åœ°æ–¹ä¸å¤šã€‚ æœ€å¤šçš„æ˜¯å»å¤„logï¼Œå¯¹æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Œå¹¶ä¸”å¯¹åæœŸé—®é¢˜çš„åˆ†ææœ‰æ¯”è¾ƒå¤§çš„å½±å“ã€‚ æˆ–è€…é€šè¿‡å±æ€§çš„æ§åˆ¶ï¼Œæ¥æ§åˆ¶æ˜¯å¦æ‰“å°å’Œæ‰“å°çš„ç­‰çº§ã€‚ system/core/logd/LogBuffer.cpp int get_log_level() { char buf[PROPERTY_VALUE_MAX]; memset(buf, 0, PROPERTY_VALUE_MAX); property_get(\"persist.xxx.level\", buf, \"\"); return buf[0]; } â€‹ int loglevl = get_log_level(); int LogBuffer::log(log_id_t log_id, log_time realtime, uid_t uid, pid_t pid, pid_t tid, const char* msg, uint16_t len) { if (log_id \u003e= LOG_ID_MAX) { return -EINVAL; } // é€šè¿‡å±æ€§æ§åˆ¶logè¾“å‡º if (length \u003e 0 \u0026\u0026 loglevl \u003c log_id) { return -EINVAL; } â€‹ } 2 kernelé˜¶æ®µ å¯¹äºkernel é˜¶æ®µçš„æœ‰ï¼Œ å¯¹äºä¸å½±å“å¼€æœºçš„modle ï¼Œå¯ä»¥å»ºè®®å»¶è¿ŸåŠ è½½ã€‚ å¯ä»¥ç­‰zygoteå¯åŠ¨åï¼Œåœ¨early-bootæˆ–booté˜¶æ®µå»åŠ è½½ko, è®©zygoteæ—©ç‚¹èµ·æ¥ æ¯”å¦‚è“ç‰™å’Œwifiçš„koé©±åŠ¨ 3 Inité˜¶æ®µ 3.1 zygote åœ¨ late-initä¹‹åå¯åŠ¨ # Mount filesystems and start core system services. on late-init trigger early-fs # Mount fstab in init.{$device}.rc by mount_all command. Optional parameter # '--early' can be specified to skip entries with 'latemount'. # /system and /vendor must be mounted by the end of the fs stage, # while /data is optional. trigger fs trigger post-fs # Mount fstab in init.{$device}.rc by mount_all with '--late' parameter # to only mount entries with 'latemount'. This is needed if '--early' is # specified in the previous mount_all command on the fs stage. # With /system mounted and properties form /system + /factory available, # some services can be started. trigger late-fs # Now we can mount /data. File encryption requires keymaster to decrypt # /data, which in turn can only be loaded when system properties are present. trigger post-fs-data # Load persist properties and override properties (if enabled) from /data. trigger load_persist_props_action # Should be before netd, but after apex, properties and logging is available. trigger load_bpf_programs # Now we can start zygote for devices with file based encryption # è§¦å‘zygoteå¯åŠ¨ trigger zygote-start # Remove a file to wake up anything waiting for firmware. trigger firmware_mounts_complete trigger early-boot trigger boot 3.2 å¹¶è¡Œæ‰§è¡Œuevent(enable_parallel_restorecon) vendor/ueventd.rcä¸­åŠ å…¥parallel_restorecon enable parallel_restorecon enable 3.3 CPU æ‰“å¼€æ€§èƒ½æ¨¡å¼ 1 å¼€æœºçš„æ—¶å€™ï¼Œcpuå¼€å¯æ€§èƒ½æ¨¡å¼ on early-init write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor performance # æŸ¥çœ‹å½“å‰é¢‘ç‡ # cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq 2 å¼€æœºåå…³é—­,æ”¹æˆè‡ªåŠ¨é€‚åº” on property:sys.boot_completed=1 write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor schedutil 4 ç§»é™¤æ²¡æœ‰ç”¨åˆ°çš„æ¨¡å— æ¯”å¦‚ï¼š å¦‚CIæ¨¡å— on post-fs-data insmod /vendor/lib/modules/cimax-usb.ko insmod /vendor/lib/modules/ci.ko 5 å»¶è¿Ÿvendor/etc/initä¸‹çš„éå…³é”®æœåŠ¡ æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œï¼ŒåŠ å¿«zygoteçš„å¯åŠ¨ // æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œ on boot start xxx service xxx /system/bin/xxx user root group system 6 zygote classloaderæ‡’åŠ è½½ï¼Œ æ‡’åŠ è½½ä¼šæ¯”ç›´æ¥åŠ è½½æ›´è€—å†…å­˜ï¼Œæ‡’åŠ è½½æ˜¯é€šè¿‡system-serverå‘é€æŒ‡ä»¤ç»™zygoteåšåŠ è½½ç›¸å…³åŠ¨ä½œï¼Œåœ¨å‘é€æŒ‡ä»¤å‰ï¼Œsystem-serverä¼šåŠ è½½ä¸€éƒ¨åˆ†è‡ªå·±ä½¿ç”¨çš„ç±»ï¼Œä¼šå’Œzygoteä¸­å­˜åœ¨ç›¸åŒçš„ä¸€éƒ¨åˆ†å¤‡ä»½ service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload zygote æ·»åŠ  task_profiles ProcessCapacityHigh MaxPerformance service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload class main priority -20 user root group root readproc reserved_disk socket zygote stream 660 root system socket usap_pool_primary stream 660 root system onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse onrestart write /sys/power/state on onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart netd onrestart restart wificond task_profiles ProcessCapacityHigh MaxPerformance ç²¾ç®€preloadçš„classes , æ¯”å¦‚å¯ä»¥å»æ‰å¦‚ä¸‹class æ ¹æ®é¡¹ç›®çš„æ—¶é—´æƒ…å†µ å¦‚æœéœ€è¦å†åšä¸€äº›å¤§çš„è£å‰ªï¼Œå¯ä»¥ä½¿ç”¨frameworks\\base\\config\\generate-preloaded-classes.shä¸‹çš„è„šæœ¬æ¥ç”Ÿæˆpreloaded-classes // ç”Ÿç‰©è¯†åˆ« android.hardware.biometrics // äººè„¸è¯†åˆ« android.hardware.face // æ‰“å°æœåŠ¡ android.hardware.fingerprint android.print. // éƒ¨åˆ†å®šä½ç›¸å…³, è¿˜æœ‰GPSå®šä½ç›¸å…³ android.hardware.location com.android.internal.location.GpsNetInitiatedHandler android.location.Gnss* // æ‰‹æœºé€šè¯ç›¸å…³ android.telephony. android.telecom. com.android","date":"2024-11-06","objectID":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/:0:0","tags":["blog","Framework"],"title":"å¼€æœºä¼˜åŒ–","uri":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/#72-è°ƒæ•´systemserverinitthreadpoolçº¿ç¨‹æ± ç›¸å…³ä¼˜å…ˆçº§"},{"categories":["Android"],"collections":["Framework","å¼€æœºå¯åŠ¨"],"content":" æ ¹æ®å¼€æœºçš„é˜¶æ®µï¼Œæœ‰ä¸€äº›ä¼˜åŒ–å¼€æœºé€Ÿåº¦çš„ç©ºé—´ 1. bootloaderé˜¶æ®µ è¿™è¾¹æ¶‰åŠçš„ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œèƒ½ä¿®æ”¹çš„åœ°æ–¹ä¸å¤šã€‚ æœ€å¤šçš„æ˜¯å»å¤„logï¼Œå¯¹æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Œå¹¶ä¸”å¯¹åæœŸé—®é¢˜çš„åˆ†ææœ‰æ¯”è¾ƒå¤§çš„å½±å“ã€‚ æˆ–è€…é€šè¿‡å±æ€§çš„æ§åˆ¶ï¼Œæ¥æ§åˆ¶æ˜¯å¦æ‰“å°å’Œæ‰“å°çš„ç­‰çº§ã€‚ system/core/logd/LogBuffer.cpp int get_log_level() { char buf[PROPERTY_VALUE_MAX]; memset(buf, 0, PROPERTY_VALUE_MAX); property_get(\"persist.xxx.level\", buf, \"\"); return buf[0]; } â€‹ int loglevl = get_log_level(); int LogBuffer::log(log_id_t log_id, log_time realtime, uid_t uid, pid_t pid, pid_t tid, const char* msg, uint16_t len) { if (log_id \u003e= LOG_ID_MAX) { return -EINVAL; } // é€šè¿‡å±æ€§æ§åˆ¶logè¾“å‡º if (length \u003e 0 \u0026\u0026 loglevl \u003c log_id) { return -EINVAL; } â€‹ } 2 kernelé˜¶æ®µ å¯¹äºkernel é˜¶æ®µçš„æœ‰ï¼Œ å¯¹äºä¸å½±å“å¼€æœºçš„modle ï¼Œå¯ä»¥å»ºè®®å»¶è¿ŸåŠ è½½ã€‚ å¯ä»¥ç­‰zygoteå¯åŠ¨åï¼Œåœ¨early-bootæˆ–booté˜¶æ®µå»åŠ è½½ko, è®©zygoteæ—©ç‚¹èµ·æ¥ æ¯”å¦‚è“ç‰™å’Œwifiçš„koé©±åŠ¨ 3 Inité˜¶æ®µ 3.1 zygote åœ¨ late-initä¹‹åå¯åŠ¨ # Mount filesystems and start core system services. on late-init trigger early-fs # Mount fstab in init.{$device}.rc by mount_all command. Optional parameter # '--early' can be specified to skip entries with 'latemount'. # /system and /vendor must be mounted by the end of the fs stage, # while /data is optional. trigger fs trigger post-fs # Mount fstab in init.{$device}.rc by mount_all with '--late' parameter # to only mount entries with 'latemount'. This is needed if '--early' is # specified in the previous mount_all command on the fs stage. # With /system mounted and properties form /system + /factory available, # some services can be started. trigger late-fs # Now we can mount /data. File encryption requires keymaster to decrypt # /data, which in turn can only be loaded when system properties are present. trigger post-fs-data # Load persist properties and override properties (if enabled) from /data. trigger load_persist_props_action # Should be before netd, but after apex, properties and logging is available. trigger load_bpf_programs # Now we can start zygote for devices with file based encryption # è§¦å‘zygoteå¯åŠ¨ trigger zygote-start # Remove a file to wake up anything waiting for firmware. trigger firmware_mounts_complete trigger early-boot trigger boot 3.2 å¹¶è¡Œæ‰§è¡Œuevent(enable_parallel_restorecon) vendor/ueventd.rcä¸­åŠ å…¥parallel_restorecon enable parallel_restorecon enable 3.3 CPU æ‰“å¼€æ€§èƒ½æ¨¡å¼ 1 å¼€æœºçš„æ—¶å€™ï¼Œcpuå¼€å¯æ€§èƒ½æ¨¡å¼ on early-init write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor performance # æŸ¥çœ‹å½“å‰é¢‘ç‡ # cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq 2 å¼€æœºåå…³é—­,æ”¹æˆè‡ªåŠ¨é€‚åº” on property:sys.boot_completed=1 write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor schedutil 4 ç§»é™¤æ²¡æœ‰ç”¨åˆ°çš„æ¨¡å— æ¯”å¦‚ï¼š å¦‚CIæ¨¡å— on post-fs-data insmod /vendor/lib/modules/cimax-usb.ko insmod /vendor/lib/modules/ci.ko 5 å»¶è¿Ÿvendor/etc/initä¸‹çš„éå…³é”®æœåŠ¡ æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œï¼ŒåŠ å¿«zygoteçš„å¯åŠ¨ // æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œ on boot start xxx service xxx /system/bin/xxx user root group system 6 zygote classloaderæ‡’åŠ è½½ï¼Œ æ‡’åŠ è½½ä¼šæ¯”ç›´æ¥åŠ è½½æ›´è€—å†…å­˜ï¼Œæ‡’åŠ è½½æ˜¯é€šè¿‡system-serverå‘é€æŒ‡ä»¤ç»™zygoteåšåŠ è½½ç›¸å…³åŠ¨ä½œï¼Œåœ¨å‘é€æŒ‡ä»¤å‰ï¼Œsystem-serverä¼šåŠ è½½ä¸€éƒ¨åˆ†è‡ªå·±ä½¿ç”¨çš„ç±»ï¼Œä¼šå’Œzygoteä¸­å­˜åœ¨ç›¸åŒçš„ä¸€éƒ¨åˆ†å¤‡ä»½ service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload zygote æ·»åŠ  task_profiles ProcessCapacityHigh MaxPerformance service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload class main priority -20 user root group root readproc reserved_disk socket zygote stream 660 root system socket usap_pool_primary stream 660 root system onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse onrestart write /sys/power/state on onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart netd onrestart restart wificond task_profiles ProcessCapacityHigh MaxPerformance ç²¾ç®€preloadçš„classes , æ¯”å¦‚å¯ä»¥å»æ‰å¦‚ä¸‹class æ ¹æ®é¡¹ç›®çš„æ—¶é—´æƒ…å†µ å¦‚æœéœ€è¦å†åšä¸€äº›å¤§çš„è£å‰ªï¼Œå¯ä»¥ä½¿ç”¨frameworks\\base\\config\\generate-preloaded-classes.shä¸‹çš„è„šæœ¬æ¥ç”Ÿæˆpreloaded-classes // ç”Ÿç‰©è¯†åˆ« android.hardware.biometrics // äººè„¸è¯†åˆ« android.hardware.face // æ‰“å°æœåŠ¡ android.hardware.fingerprint android.print. // éƒ¨åˆ†å®šä½ç›¸å…³, è¿˜æœ‰GPSå®šä½ç›¸å…³ android.hardware.location com.android.internal.location.GpsNetInitiatedHandler android.location.Gnss* // æ‰‹æœºé€šè¯ç›¸å…³ android.telephony. android.telecom. com.android","date":"2024-11-06","objectID":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/:0:0","tags":["blog","Framework"],"title":"å¼€æœºä¼˜åŒ–","uri":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/#73-è£å‰ªtvç³»ç»Ÿä¸­æ²¡æœ‰ç”¨åˆ°çš„æœåŠ¡å¯ä»¥ç”¨fetureçš„å½¢å¼æ¥æ§åˆ¶å¼€å…³"},{"categories":["Android"],"collections":["Framework","å¼€æœºå¯åŠ¨"],"content":" æ ¹æ®å¼€æœºçš„é˜¶æ®µï¼Œæœ‰ä¸€äº›ä¼˜åŒ–å¼€æœºé€Ÿåº¦çš„ç©ºé—´ 1. bootloaderé˜¶æ®µ è¿™è¾¹æ¶‰åŠçš„ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œèƒ½ä¿®æ”¹çš„åœ°æ–¹ä¸å¤šã€‚ æœ€å¤šçš„æ˜¯å»å¤„logï¼Œå¯¹æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Œå¹¶ä¸”å¯¹åæœŸé—®é¢˜çš„åˆ†ææœ‰æ¯”è¾ƒå¤§çš„å½±å“ã€‚ æˆ–è€…é€šè¿‡å±æ€§çš„æ§åˆ¶ï¼Œæ¥æ§åˆ¶æ˜¯å¦æ‰“å°å’Œæ‰“å°çš„ç­‰çº§ã€‚ system/core/logd/LogBuffer.cpp int get_log_level() { char buf[PROPERTY_VALUE_MAX]; memset(buf, 0, PROPERTY_VALUE_MAX); property_get(\"persist.xxx.level\", buf, \"\"); return buf[0]; } â€‹ int loglevl = get_log_level(); int LogBuffer::log(log_id_t log_id, log_time realtime, uid_t uid, pid_t pid, pid_t tid, const char* msg, uint16_t len) { if (log_id \u003e= LOG_ID_MAX) { return -EINVAL; } // é€šè¿‡å±æ€§æ§åˆ¶logè¾“å‡º if (length \u003e 0 \u0026\u0026 loglevl \u003c log_id) { return -EINVAL; } â€‹ } 2 kernelé˜¶æ®µ å¯¹äºkernel é˜¶æ®µçš„æœ‰ï¼Œ å¯¹äºä¸å½±å“å¼€æœºçš„modle ï¼Œå¯ä»¥å»ºè®®å»¶è¿ŸåŠ è½½ã€‚ å¯ä»¥ç­‰zygoteå¯åŠ¨åï¼Œåœ¨early-bootæˆ–booté˜¶æ®µå»åŠ è½½ko, è®©zygoteæ—©ç‚¹èµ·æ¥ æ¯”å¦‚è“ç‰™å’Œwifiçš„koé©±åŠ¨ 3 Inité˜¶æ®µ 3.1 zygote åœ¨ late-initä¹‹åå¯åŠ¨ # Mount filesystems and start core system services. on late-init trigger early-fs # Mount fstab in init.{$device}.rc by mount_all command. Optional parameter # '--early' can be specified to skip entries with 'latemount'. # /system and /vendor must be mounted by the end of the fs stage, # while /data is optional. trigger fs trigger post-fs # Mount fstab in init.{$device}.rc by mount_all with '--late' parameter # to only mount entries with 'latemount'. This is needed if '--early' is # specified in the previous mount_all command on the fs stage. # With /system mounted and properties form /system + /factory available, # some services can be started. trigger late-fs # Now we can mount /data. File encryption requires keymaster to decrypt # /data, which in turn can only be loaded when system properties are present. trigger post-fs-data # Load persist properties and override properties (if enabled) from /data. trigger load_persist_props_action # Should be before netd, but after apex, properties and logging is available. trigger load_bpf_programs # Now we can start zygote for devices with file based encryption # è§¦å‘zygoteå¯åŠ¨ trigger zygote-start # Remove a file to wake up anything waiting for firmware. trigger firmware_mounts_complete trigger early-boot trigger boot 3.2 å¹¶è¡Œæ‰§è¡Œuevent(enable_parallel_restorecon) vendor/ueventd.rcä¸­åŠ å…¥parallel_restorecon enable parallel_restorecon enable 3.3 CPU æ‰“å¼€æ€§èƒ½æ¨¡å¼ 1 å¼€æœºçš„æ—¶å€™ï¼Œcpuå¼€å¯æ€§èƒ½æ¨¡å¼ on early-init write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor performance # æŸ¥çœ‹å½“å‰é¢‘ç‡ # cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq 2 å¼€æœºåå…³é—­,æ”¹æˆè‡ªåŠ¨é€‚åº” on property:sys.boot_completed=1 write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor schedutil 4 ç§»é™¤æ²¡æœ‰ç”¨åˆ°çš„æ¨¡å— æ¯”å¦‚ï¼š å¦‚CIæ¨¡å— on post-fs-data insmod /vendor/lib/modules/cimax-usb.ko insmod /vendor/lib/modules/ci.ko 5 å»¶è¿Ÿvendor/etc/initä¸‹çš„éå…³é”®æœåŠ¡ æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œï¼ŒåŠ å¿«zygoteçš„å¯åŠ¨ // æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œ on boot start xxx service xxx /system/bin/xxx user root group system 6 zygote classloaderæ‡’åŠ è½½ï¼Œ æ‡’åŠ è½½ä¼šæ¯”ç›´æ¥åŠ è½½æ›´è€—å†…å­˜ï¼Œæ‡’åŠ è½½æ˜¯é€šè¿‡system-serverå‘é€æŒ‡ä»¤ç»™zygoteåšåŠ è½½ç›¸å…³åŠ¨ä½œï¼Œåœ¨å‘é€æŒ‡ä»¤å‰ï¼Œsystem-serverä¼šåŠ è½½ä¸€éƒ¨åˆ†è‡ªå·±ä½¿ç”¨çš„ç±»ï¼Œä¼šå’Œzygoteä¸­å­˜åœ¨ç›¸åŒçš„ä¸€éƒ¨åˆ†å¤‡ä»½ service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload zygote æ·»åŠ  task_profiles ProcessCapacityHigh MaxPerformance service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload class main priority -20 user root group root readproc reserved_disk socket zygote stream 660 root system socket usap_pool_primary stream 660 root system onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse onrestart write /sys/power/state on onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart netd onrestart restart wificond task_profiles ProcessCapacityHigh MaxPerformance ç²¾ç®€preloadçš„classes , æ¯”å¦‚å¯ä»¥å»æ‰å¦‚ä¸‹class æ ¹æ®é¡¹ç›®çš„æ—¶é—´æƒ…å†µ å¦‚æœéœ€è¦å†åšä¸€äº›å¤§çš„è£å‰ªï¼Œå¯ä»¥ä½¿ç”¨frameworks\\base\\config\\generate-preloaded-classes.shä¸‹çš„è„šæœ¬æ¥ç”Ÿæˆpreloaded-classes // ç”Ÿç‰©è¯†åˆ« android.hardware.biometrics // äººè„¸è¯†åˆ« android.hardware.face // æ‰“å°æœåŠ¡ android.hardware.fingerprint android.print. // éƒ¨åˆ†å®šä½ç›¸å…³, è¿˜æœ‰GPSå®šä½ç›¸å…³ android.hardware.location com.android.internal.location.GpsNetInitiatedHandler android.location.Gnss* // æ‰‹æœºé€šè¯ç›¸å…³ android.telephony. android.telecom. com.android","date":"2024-11-06","objectID":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/:0:0","tags":["blog","Framework"],"title":"å¼€æœºä¼˜åŒ–","uri":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/#74-å»¶æ—¶å¯åŠ¨presist-app"},{"categories":["Android"],"collections":["Framework","å¼€æœºå¯åŠ¨"],"content":" æ ¹æ®å¼€æœºçš„é˜¶æ®µï¼Œæœ‰ä¸€äº›ä¼˜åŒ–å¼€æœºé€Ÿåº¦çš„ç©ºé—´ 1. bootloaderé˜¶æ®µ è¿™è¾¹æ¶‰åŠçš„ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œèƒ½ä¿®æ”¹çš„åœ°æ–¹ä¸å¤šã€‚ æœ€å¤šçš„æ˜¯å»å¤„logï¼Œå¯¹æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Œå¹¶ä¸”å¯¹åæœŸé—®é¢˜çš„åˆ†ææœ‰æ¯”è¾ƒå¤§çš„å½±å“ã€‚ æˆ–è€…é€šè¿‡å±æ€§çš„æ§åˆ¶ï¼Œæ¥æ§åˆ¶æ˜¯å¦æ‰“å°å’Œæ‰“å°çš„ç­‰çº§ã€‚ system/core/logd/LogBuffer.cpp int get_log_level() { char buf[PROPERTY_VALUE_MAX]; memset(buf, 0, PROPERTY_VALUE_MAX); property_get(\"persist.xxx.level\", buf, \"\"); return buf[0]; } â€‹ int loglevl = get_log_level(); int LogBuffer::log(log_id_t log_id, log_time realtime, uid_t uid, pid_t pid, pid_t tid, const char* msg, uint16_t len) { if (log_id \u003e= LOG_ID_MAX) { return -EINVAL; } // é€šè¿‡å±æ€§æ§åˆ¶logè¾“å‡º if (length \u003e 0 \u0026\u0026 loglevl \u003c log_id) { return -EINVAL; } â€‹ } 2 kernelé˜¶æ®µ å¯¹äºkernel é˜¶æ®µçš„æœ‰ï¼Œ å¯¹äºä¸å½±å“å¼€æœºçš„modle ï¼Œå¯ä»¥å»ºè®®å»¶è¿ŸåŠ è½½ã€‚ å¯ä»¥ç­‰zygoteå¯åŠ¨åï¼Œåœ¨early-bootæˆ–booté˜¶æ®µå»åŠ è½½ko, è®©zygoteæ—©ç‚¹èµ·æ¥ æ¯”å¦‚è“ç‰™å’Œwifiçš„koé©±åŠ¨ 3 Inité˜¶æ®µ 3.1 zygote åœ¨ late-initä¹‹åå¯åŠ¨ # Mount filesystems and start core system services. on late-init trigger early-fs # Mount fstab in init.{$device}.rc by mount_all command. Optional parameter # '--early' can be specified to skip entries with 'latemount'. # /system and /vendor must be mounted by the end of the fs stage, # while /data is optional. trigger fs trigger post-fs # Mount fstab in init.{$device}.rc by mount_all with '--late' parameter # to only mount entries with 'latemount'. This is needed if '--early' is # specified in the previous mount_all command on the fs stage. # With /system mounted and properties form /system + /factory available, # some services can be started. trigger late-fs # Now we can mount /data. File encryption requires keymaster to decrypt # /data, which in turn can only be loaded when system properties are present. trigger post-fs-data # Load persist properties and override properties (if enabled) from /data. trigger load_persist_props_action # Should be before netd, but after apex, properties and logging is available. trigger load_bpf_programs # Now we can start zygote for devices with file based encryption # è§¦å‘zygoteå¯åŠ¨ trigger zygote-start # Remove a file to wake up anything waiting for firmware. trigger firmware_mounts_complete trigger early-boot trigger boot 3.2 å¹¶è¡Œæ‰§è¡Œuevent(enable_parallel_restorecon) vendor/ueventd.rcä¸­åŠ å…¥parallel_restorecon enable parallel_restorecon enable 3.3 CPU æ‰“å¼€æ€§èƒ½æ¨¡å¼ 1 å¼€æœºçš„æ—¶å€™ï¼Œcpuå¼€å¯æ€§èƒ½æ¨¡å¼ on early-init write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor performance # æŸ¥çœ‹å½“å‰é¢‘ç‡ # cat /sys/devices/system/cpu/cpu0/cpufreq/scaling_cur_freq 2 å¼€æœºåå…³é—­,æ”¹æˆè‡ªåŠ¨é€‚åº” on property:sys.boot_completed=1 write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor schedutil 4 ç§»é™¤æ²¡æœ‰ç”¨åˆ°çš„æ¨¡å— æ¯”å¦‚ï¼š å¦‚CIæ¨¡å— on post-fs-data insmod /vendor/lib/modules/cimax-usb.ko insmod /vendor/lib/modules/ci.ko 5 å»¶è¿Ÿvendor/etc/initä¸‹çš„éå…³é”®æœåŠ¡ æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œï¼ŒåŠ å¿«zygoteçš„å¯åŠ¨ // æ”¾åœ¨early-bootæˆ–è€…booté˜¶æ®µæ‰§è¡Œ on boot start xxx service xxx /system/bin/xxx user root group system 6 zygote classloaderæ‡’åŠ è½½ï¼Œ æ‡’åŠ è½½ä¼šæ¯”ç›´æ¥åŠ è½½æ›´è€—å†…å­˜ï¼Œæ‡’åŠ è½½æ˜¯é€šè¿‡system-serverå‘é€æŒ‡ä»¤ç»™zygoteåšåŠ è½½ç›¸å…³åŠ¨ä½œï¼Œåœ¨å‘é€æŒ‡ä»¤å‰ï¼Œsystem-serverä¼šåŠ è½½ä¸€éƒ¨åˆ†è‡ªå·±ä½¿ç”¨çš„ç±»ï¼Œä¼šå’Œzygoteä¸­å­˜åœ¨ç›¸åŒçš„ä¸€éƒ¨åˆ†å¤‡ä»½ service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload zygote æ·»åŠ  task_profiles ProcessCapacityHigh MaxPerformance service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server --enable-lazy-preload class main priority -20 user root group root readproc reserved_disk socket zygote stream 660 root system socket usap_pool_primary stream 660 root system onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse onrestart write /sys/power/state on onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart netd onrestart restart wificond task_profiles ProcessCapacityHigh MaxPerformance ç²¾ç®€preloadçš„classes , æ¯”å¦‚å¯ä»¥å»æ‰å¦‚ä¸‹class æ ¹æ®é¡¹ç›®çš„æ—¶é—´æƒ…å†µ å¦‚æœéœ€è¦å†åšä¸€äº›å¤§çš„è£å‰ªï¼Œå¯ä»¥ä½¿ç”¨frameworks\\base\\config\\generate-preloaded-classes.shä¸‹çš„è„šæœ¬æ¥ç”Ÿæˆpreloaded-classes // ç”Ÿç‰©è¯†åˆ« android.hardware.biometrics // äººè„¸è¯†åˆ« android.hardware.face // æ‰“å°æœåŠ¡ android.hardware.fingerprint android.print. // éƒ¨åˆ†å®šä½ç›¸å…³, è¿˜æœ‰GPSå®šä½ç›¸å…³ android.hardware.location com.android.internal.location.GpsNetInitiatedHandler android.location.Gnss* // æ‰‹æœºé€šè¯ç›¸å…³ android.telephony. android.telecom. com.android","date":"2024-11-06","objectID":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/:0:0","tags":["blog","Framework"],"title":"å¼€æœºä¼˜åŒ–","uri":"/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/#8-laucher"},{"categories":["Android"],"collections":["å¼€æœºå¯åŠ¨"],"content":"å¼€æœºæµç¨‹ bootloader å¼•å¯¼ç³»ç»Ÿ å†…æ ¸å¯åŠ¨ idle æµç¨‹å›¾ Zygote å¯åŠ¨ Zygoteè¿›ç¨‹ç›¸å…³ zygoteçš„å¯åŠ¨æ˜¯åœ¨ init è¿›ç¨‹å¯åŠ¨åï¼Œè§£æinit.rcæ–‡ä»¶åˆ›å»ºçš„ï¼š import /system/etc/init/hw/init.${ro.zygote}.rc #è¿™ä¸ªé‡Œé¢ä¼šæ ¹æ®å¹³å°çš„ä¸åŒï¼Œé€‰æ‹©32ä½ï¼Œè¿˜æ˜¯64ä½ã€‚ # system/core/rootdir/init.zygote64.rc service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server --socket-name=zygote class main priority -20 user root group root readproc reserved_disk socket zygote stream 660 root system socket usap_pool_primary stream 660 root system onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse onrestart write /sys/power/state on # NOTE: If the wakelock name here is changed, then also # update it in SystemSuspend.cpp onrestart write /sys/power/wake_lock zygote_kwl onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart media.tuner onrestart restart netd onrestart restart wificond task_profiles ProcessCapacityHigh MaxPerformance critical window=${zygote.critical_window.minute:-off} target=zygote-fatal ","date":"2024-11-06","objectID":"/posts/%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/:0:0","tags":["blog","Framework"],"title":"å¯åŠ¨æµç¨‹åˆ†æ","uri":"/posts/%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/#"},{"categories":["Android"],"collections":["å¼€æœºå¯åŠ¨"],"content":"å¼€æœºæµç¨‹ bootloader å¼•å¯¼ç³»ç»Ÿ å†…æ ¸å¯åŠ¨ idle æµç¨‹å›¾ Zygote å¯åŠ¨ Zygoteè¿›ç¨‹ç›¸å…³ zygoteçš„å¯åŠ¨æ˜¯åœ¨ init è¿›ç¨‹å¯åŠ¨åï¼Œè§£æinit.rcæ–‡ä»¶åˆ›å»ºçš„ï¼š import /system/etc/init/hw/init.${ro.zygote}.rc #è¿™ä¸ªé‡Œé¢ä¼šæ ¹æ®å¹³å°çš„ä¸åŒï¼Œé€‰æ‹©32ä½ï¼Œè¿˜æ˜¯64ä½ã€‚ # system/core/rootdir/init.zygote64.rc service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server --socket-name=zygote class main priority -20 user root group root readproc reserved_disk socket zygote stream 660 root system socket usap_pool_primary stream 660 root system onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse onrestart write /sys/power/state on # NOTE: If the wakelock name here is changed, then also # update it in SystemSuspend.cpp onrestart write /sys/power/wake_lock zygote_kwl onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart media.tuner onrestart restart netd onrestart restart wificond task_profiles ProcessCapacityHigh MaxPerformance critical window=${zygote.critical_window.minute:-off} target=zygote-fatal ","date":"2024-11-06","objectID":"/posts/%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/:0:0","tags":["blog","Framework"],"title":"å¯åŠ¨æµç¨‹åˆ†æ","uri":"/posts/%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/#å¼€æœºæµç¨‹"},{"categories":["Android"],"collections":["å¼€æœºå¯åŠ¨"],"content":"å¼€æœºæµç¨‹ bootloader å¼•å¯¼ç³»ç»Ÿ å†…æ ¸å¯åŠ¨ idle æµç¨‹å›¾ Zygote å¯åŠ¨ Zygoteè¿›ç¨‹ç›¸å…³ zygoteçš„å¯åŠ¨æ˜¯åœ¨ init è¿›ç¨‹å¯åŠ¨åï¼Œè§£æinit.rcæ–‡ä»¶åˆ›å»ºçš„ï¼š import /system/etc/init/hw/init.${ro.zygote}.rc #è¿™ä¸ªé‡Œé¢ä¼šæ ¹æ®å¹³å°çš„ä¸åŒï¼Œé€‰æ‹©32ä½ï¼Œè¿˜æ˜¯64ä½ã€‚ # system/core/rootdir/init.zygote64.rc service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server --socket-name=zygote class main priority -20 user root group root readproc reserved_disk socket zygote stream 660 root system socket usap_pool_primary stream 660 root system onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse onrestart write /sys/power/state on # NOTE: If the wakelock name here is changed, then also # update it in SystemSuspend.cpp onrestart write /sys/power/wake_lock zygote_kwl onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart media.tuner onrestart restart netd onrestart restart wificond task_profiles ProcessCapacityHigh MaxPerformance critical window=${zygote.critical_window.minute:-off} target=zygote-fatal ","date":"2024-11-06","objectID":"/posts/%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/:0:0","tags":["blog","Framework"],"title":"å¯åŠ¨æµç¨‹åˆ†æ","uri":"/posts/%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/#bootloader-å¼•å¯¼ç³»ç»Ÿ"},{"categories":["Android"],"collections":["å¼€æœºå¯åŠ¨"],"content":"å¼€æœºæµç¨‹ bootloader å¼•å¯¼ç³»ç»Ÿ å†…æ ¸å¯åŠ¨ idle æµç¨‹å›¾ Zygote å¯åŠ¨ Zygoteè¿›ç¨‹ç›¸å…³ zygoteçš„å¯åŠ¨æ˜¯åœ¨ init è¿›ç¨‹å¯åŠ¨åï¼Œè§£æinit.rcæ–‡ä»¶åˆ›å»ºçš„ï¼š import /system/etc/init/hw/init.${ro.zygote}.rc #è¿™ä¸ªé‡Œé¢ä¼šæ ¹æ®å¹³å°çš„ä¸åŒï¼Œé€‰æ‹©32ä½ï¼Œè¿˜æ˜¯64ä½ã€‚ # system/core/rootdir/init.zygote64.rc service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server --socket-name=zygote class main priority -20 user root group root readproc reserved_disk socket zygote stream 660 root system socket usap_pool_primary stream 660 root system onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse onrestart write /sys/power/state on # NOTE: If the wakelock name here is changed, then also # update it in SystemSuspend.cpp onrestart write /sys/power/wake_lock zygote_kwl onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart media.tuner onrestart restart netd onrestart restart wificond task_profiles ProcessCapacityHigh MaxPerformance critical window=${zygote.critical_window.minute:-off} target=zygote-fatal ","date":"2024-11-06","objectID":"/posts/%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/:0:0","tags":["blog","Framework"],"title":"å¯åŠ¨æµç¨‹åˆ†æ","uri":"/posts/%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/#å†…æ ¸å¯åŠ¨-idle"},{"categories":["Android"],"collections":["å¼€æœºå¯åŠ¨"],"content":"å¼€æœºæµç¨‹ bootloader å¼•å¯¼ç³»ç»Ÿ å†…æ ¸å¯åŠ¨ idle æµç¨‹å›¾ Zygote å¯åŠ¨ Zygoteè¿›ç¨‹ç›¸å…³ zygoteçš„å¯åŠ¨æ˜¯åœ¨ init è¿›ç¨‹å¯åŠ¨åï¼Œè§£æinit.rcæ–‡ä»¶åˆ›å»ºçš„ï¼š import /system/etc/init/hw/init.${ro.zygote}.rc #è¿™ä¸ªé‡Œé¢ä¼šæ ¹æ®å¹³å°çš„ä¸åŒï¼Œé€‰æ‹©32ä½ï¼Œè¿˜æ˜¯64ä½ã€‚ # system/core/rootdir/init.zygote64.rc service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server --socket-name=zygote class main priority -20 user root group root readproc reserved_disk socket zygote stream 660 root system socket usap_pool_primary stream 660 root system onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse onrestart write /sys/power/state on # NOTE: If the wakelock name here is changed, then also # update it in SystemSuspend.cpp onrestart write /sys/power/wake_lock zygote_kwl onrestart restart audioserver onrestart restart cameraserver onrestart restart media onrestart restart media.tuner onrestart restart netd onrestart restart wificond task_profiles ProcessCapacityHigh MaxPerformance critical window=${zygote.critical_window.minute:-off} target=zygote-fatal ","date":"2024-11-06","objectID":"/posts/%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/:0:0","tags":["blog","Framework"],"title":"å¯åŠ¨æµç¨‹åˆ†æ","uri":"/posts/%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/#zygote-å¯åŠ¨"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#å½•å±ä¼ è¾“"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#å½•å±æ–¹æ³•"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#1-åˆ›å»ºè™šæ‹Ÿå±å¹•æŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„-surface-ä¸­"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#2-surface-ç”±-mediacodec-åˆ›å»º"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#3-æŠŠ-surface-å†…å®¹è¾“å…¥åˆ°-mediacodecç„¶åç¼–ç "},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#å½•å±ä¿å­˜ä¸ºæ–‡ä»¶"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#å½•å±æ•°æ®ç¼–ç ä¼ è¾“"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#å½•å±æ•°æ®è§£ç æ˜¾ç¤º"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#æŠ•å±ç›¸å…³"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#åŒæ˜¾æ¨¡å¼-mirror"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#å¼‚æ˜¾æ¨¡å¼-own_content"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#ä¸åŒå°ºå¯¸çš„æŠ•å±"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#å¼‚å±å¹•å¯åŠ¨æ–¹å¼"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#ä¸€-dialog"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#äºŒ"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#ä¸‰-activity"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#è§¦æ‘¸éƒ¨åˆ†"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#è§¦æ‘¸äº‹ä»¶æ³¨å…¥"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#éŸ³é¢‘éƒ¨åˆ†"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#æœåŠ¡ç«¯"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#audirecord-ç‰ˆæœ¬"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#ä¼˜åŒ–ç‰ˆæœ¬"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#å®¢æˆ·ç«¯"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#bytebuffer-ä»‹ç»"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#åŠŸèƒ½å†ä¼˜åŒ–"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#è§†é¢‘å»¶æ—¶æµ‹è¯•éªŒè¯"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#æ‚¬æµ®çª—å£"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#éŸ³é¢‘å»¶è¿Ÿæµ‹è¯•æ–¹æ¡ˆ"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#ä¼˜åŒ–æ–¹æ¡ˆ"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#è§†é¢‘æ–¹é¢"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#éŸ³é¢‘æ–¹é¢"},{"categories":null,"collections":null,"content":"git clone â€“recursive https://github.com/huang8604/huang8604.github.io.git å½•å±ä¼ è¾“ å½•å±æ–¹æ³• å½•å±åŸç† 1 åˆ›å»ºè™šæ‹Ÿå±å¹•ï¼ŒæŠŠå†…å®¹ç»˜åˆ¶åˆ°å±å¹•ç»‘å®šçš„ surface ä¸­ é’ˆå¯¹ç¬¬ä¸‰æ–¹çš„åº”ç”¨ï¼Œç”±äºç¼ºå°‘æƒé™ã€‚ éœ€è¦é€šè¿‡ MediaProjection çš„æ–¹å¼åˆ›å»º projectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE); meidaProjection = projectionManager.getMediaProjection(resultCode,data); //åˆ›å»ºå‰å°é€šçŸ¥ //mediac åˆ›å»ºçš„surface //åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = mediaProjection.createVirtualDisplay(\"name\",width,height,dpi,flag..mirro,surface,null,null); å¯¹äºç³»ç»Ÿåº”ç”¨ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºè™šæ‹Ÿå±å¹• virtualDisplay = ((DisplayManager)getsystemservice(DISPLAY_SERVIcE)).createvirtualDisplay(\"Mainscreen\", width, height, dpi,surface,flgs: 1 \u003c 10 | DisPlayManager.VIRTUAL_DISPLAY_FLAG PRESENTATION | DisPlayManage r.VIRTUAL_DISPLAY_FLKG_PUBLIC | DisPlayManager.VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY); 2 surface ç”± mediacodec åˆ›å»º 3 æŠŠ surface å†…å®¹è¾“å…¥åˆ° MediaCodecï¼Œç„¶åç¼–ç  MediaFormat format = createFormate(... bit,fps,); MediaCodec codec = createMediaCodec(); SurfactControl.createDisplay(); configure(codec,format);//codec.configure(format) Surface surface = codec.createInputSurface(); setDisplaySurface(display,surface,...) codec.start(); try{ //å¼€å¯å¾ªç¯ alive = encode(codec,fd); code.stop(); } finally{ destoryDisplay(diaplay); codec.release(); surface.release(); } private boolean encode(MediaCodec codec, FileDescriptor fd) throws IOException { boolean eof = false; MediaCodec.BufferInfo bufferInfo = new MediaCodec.BufferInfo(); while (!consumeRotationChange() \u0026\u0026 !eof) { int outputBufferId = codec.dequeueOutputBuffer(bufferInfo, -1); eof = (bufferInfo.flags \u0026 MediaCodec.BUFFER_FLAG_END_OF_STREAM) != 0; try { if (consumeRotationChange()) { // must restart encoding with new size break; } if (outputBufferId \u003e= 0) { ByteBuffer codecBuffer = codec.getOutputBuffer(outputBufferId); if (sendFrameMeta) {//å†™å…¥æ–‡ä»¶å¤´ writeFrameMeta(fd, bufferInfo, codecBuffer.remaining()); } //å†™å…¥å¸§æ•°æ® IO.writeFully(fd, codecBuffer); } } finally { if (outputBufferId \u003e= 0) { codec.releaseOutputBuffer(outputBufferId, false); } } } return !eof; } private static void setDisplaySurface(IBinder display, Surface surface, int orientation, Rect deviceRect, Rect displayRect, int layerStack) { SurfaceControl.openTransaction(); try { SurfaceControl.setDisplaySurface(display, surface); SurfaceControl.setDisplayProjection(display, orientation, deviceRect, displayRect); SurfaceControl.setDisplayLayerStack(display, layerStack); } finally { SurfaceControl.closeTransaction(); } } private static MediaCodec (Codec codec, String encoderName) throws IOException, ConfigurationException { if (encoderName != null) { Ln.d(\"Creating encoder by name: '\" + encoderName + \"'\"); try { return MediaCodec.createByCodecName(encoderName); } catch (IllegalArgumentException e) { Ln.e(\"Video encoder '\" + encoderName + \"' for \" + codec.getName() + \" not found\\n\" + LogUtils.buildVideoEncoderListMessage()); throw new ConfigurationException(\"Unknown encoder: \" + encoderName); } catch (IOException e) { Ln.e(\"Could not create video encoder '\" + encoderName + \"' for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } try { MediaCodec mediaCodec = MediaCodec.createEncoderByType(codec.getMimeType()); Ln.d(\"Using video encoder: '\" + mediaCodec.getName() + \"'\"); return mediaCodec; } catch (IOException | IllegalArgumentException e) { Ln.e(\"Could not create default video encoder for \" + codec.getName() + \"\\n\" + LogUtils.buildVideoEncoderListMessage()); throw e; } } å½•å±ä¿å­˜ä¸ºæ–‡ä»¶ String rootDir = Applistion.getInstance().getExternalCacheDir()+\"...\"; File file = new File(path+\"test.h264\"); FileOutputStream fileOutputStream = null; fileOutputStream = new FileOutputStream(file); fileOutputStream.write(data); fileOutstream.flush(); fileOutStream.close(); fileOutStream = null; file = null; å½•å±æ•°æ®ç¼–ç ä¼ è¾“ æœåŠ¡ç«¯ ServerSocket mServer = null; Socket mSocket = null ; void init() { new Thread (new Runnable(){ @Override public void run(){ while(true){ try{ if(mServer == null){ //æ–°å»ºæœåŠ¡socket æœåŠ¡ mServer = new ServerSocker(6666); mSocket = mServer.acce","date":"2024-11-06","objectID":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/:0:0","tags":["blog"],"title":"æŠ•å±è®°å½•","uri":"/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/#å¼ºåˆ¶æ¡Œé¢æ¨¡å¼"},{"categories":["ç”Ÿæ´»"],"collections":null,"content":"1 . åœ¨githubä¸Šé…ç½®é™æ€é¡µé¢ å‚è€ƒä¸‹é¢åœ°å€ï¼š GitHub - CaiJimmy/hugo-theme-stack: Card-style Hugo theme designed for bloggers 2. å®‰è£…HUGO å‚è€ƒç½‘ä¸Šèµ„æ–™ï¼Œå®‰è£…HUGOï¼ŒGOã€‚ 3. git clone é…ç½®é¡µé¢ 4. obsidia å®‰è£… hugo publish æ’ä»¶ 5. ä½¿ç”¨ ä½¿ç”¨è¿‡ç¨‹æ¯”è¾ƒä¸æ»‘çš„ï¼Œåªè¦åœ¨æ–‡æ¡£å±æ€§é‡Œé¢æ·»åŠ blogå±æ€§ã€‚ æ’ä»¶å›è‡ªåŠ¨ç”Ÿæˆå­—æ®µã€‚å¹¶ä¸”æ‹·è´åˆ° HUGO ç›®å½•ä¸‹å»ã€‚ ç„¶ååœ¨HUGO çš„ç›®å½•ä¸‹ï¼Œgitæäº¤ã€‚ github page ä¼šè‡ªåŠ¨ç”Ÿæˆç½‘é¡µ æ¯”å¦‚è¿™ä¸€ç¯‡å°±æ˜¯è¿™æ · âš ï¸upload failed, check dev console ","date":"2024-11-06","objectID":"/posts/%E7%BD%91%E7%BB%9C%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88/:0:0","tags":["blog","ç½‘ç»œé…ç½®"],"title":"ç½‘ç»œåšå®¢é…ç½®æ–¹æ¡ˆ","uri":"/posts/%E7%BD%91%E7%BB%9C%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88/#"},{"categories":["ç”Ÿæ´»"],"collections":null,"content":"1 . åœ¨githubä¸Šé…ç½®é™æ€é¡µé¢ å‚è€ƒä¸‹é¢åœ°å€ï¼š GitHub - CaiJimmy/hugo-theme-stack: Card-style Hugo theme designed for bloggers 2. å®‰è£…HUGO å‚è€ƒç½‘ä¸Šèµ„æ–™ï¼Œå®‰è£…HUGOï¼ŒGOã€‚ 3. git clone é…ç½®é¡µé¢ 4. obsidia å®‰è£… hugo publish æ’ä»¶ 5. ä½¿ç”¨ ä½¿ç”¨è¿‡ç¨‹æ¯”è¾ƒä¸æ»‘çš„ï¼Œåªè¦åœ¨æ–‡æ¡£å±æ€§é‡Œé¢æ·»åŠ blogå±æ€§ã€‚ æ’ä»¶å›è‡ªåŠ¨ç”Ÿæˆå­—æ®µã€‚å¹¶ä¸”æ‹·è´åˆ° HUGO ç›®å½•ä¸‹å»ã€‚ ç„¶ååœ¨HUGO çš„ç›®å½•ä¸‹ï¼Œgitæäº¤ã€‚ github page ä¼šè‡ªåŠ¨ç”Ÿæˆç½‘é¡µ æ¯”å¦‚è¿™ä¸€ç¯‡å°±æ˜¯è¿™æ · âš ï¸upload failed, check dev console ","date":"2024-11-06","objectID":"/posts/%E7%BD%91%E7%BB%9C%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88/:0:0","tags":["blog","ç½‘ç»œé…ç½®"],"title":"ç½‘ç»œåšå®¢é…ç½®æ–¹æ¡ˆ","uri":"/posts/%E7%BD%91%E7%BB%9C%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88/#1--åœ¨githubä¸Šé…ç½®é™æ€é¡µé¢"},{"categories":["ç”Ÿæ´»"],"collections":null,"content":"1 . åœ¨githubä¸Šé…ç½®é™æ€é¡µé¢ å‚è€ƒä¸‹é¢åœ°å€ï¼š GitHub - CaiJimmy/hugo-theme-stack: Card-style Hugo theme designed for bloggers 2. å®‰è£…HUGO å‚è€ƒç½‘ä¸Šèµ„æ–™ï¼Œå®‰è£…HUGOï¼ŒGOã€‚ 3. git clone é…ç½®é¡µé¢ 4. obsidia å®‰è£… hugo publish æ’ä»¶ 5. ä½¿ç”¨ ä½¿ç”¨è¿‡ç¨‹æ¯”è¾ƒä¸æ»‘çš„ï¼Œåªè¦åœ¨æ–‡æ¡£å±æ€§é‡Œé¢æ·»åŠ blogå±æ€§ã€‚ æ’ä»¶å›è‡ªåŠ¨ç”Ÿæˆå­—æ®µã€‚å¹¶ä¸”æ‹·è´åˆ° HUGO ç›®å½•ä¸‹å»ã€‚ ç„¶ååœ¨HUGO çš„ç›®å½•ä¸‹ï¼Œgitæäº¤ã€‚ github page ä¼šè‡ªåŠ¨ç”Ÿæˆç½‘é¡µ æ¯”å¦‚è¿™ä¸€ç¯‡å°±æ˜¯è¿™æ · âš ï¸upload failed, check dev console ","date":"2024-11-06","objectID":"/posts/%E7%BD%91%E7%BB%9C%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88/:0:0","tags":["blog","ç½‘ç»œé…ç½®"],"title":"ç½‘ç»œåšå®¢é…ç½®æ–¹æ¡ˆ","uri":"/posts/%E7%BD%91%E7%BB%9C%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88/#2-å®‰è£…hugo"},{"categories":["ç”Ÿæ´»"],"collections":null,"content":"1 . åœ¨githubä¸Šé…ç½®é™æ€é¡µé¢ å‚è€ƒä¸‹é¢åœ°å€ï¼š GitHub - CaiJimmy/hugo-theme-stack: Card-style Hugo theme designed for bloggers 2. å®‰è£…HUGO å‚è€ƒç½‘ä¸Šèµ„æ–™ï¼Œå®‰è£…HUGOï¼ŒGOã€‚ 3. git clone é…ç½®é¡µé¢ 4. obsidia å®‰è£… hugo publish æ’ä»¶ 5. ä½¿ç”¨ ä½¿ç”¨è¿‡ç¨‹æ¯”è¾ƒä¸æ»‘çš„ï¼Œåªè¦åœ¨æ–‡æ¡£å±æ€§é‡Œé¢æ·»åŠ blogå±æ€§ã€‚ æ’ä»¶å›è‡ªåŠ¨ç”Ÿæˆå­—æ®µã€‚å¹¶ä¸”æ‹·è´åˆ° HUGO ç›®å½•ä¸‹å»ã€‚ ç„¶ååœ¨HUGO çš„ç›®å½•ä¸‹ï¼Œgitæäº¤ã€‚ github page ä¼šè‡ªåŠ¨ç”Ÿæˆç½‘é¡µ æ¯”å¦‚è¿™ä¸€ç¯‡å°±æ˜¯è¿™æ · âš ï¸upload failed, check dev console ","date":"2024-11-06","objectID":"/posts/%E7%BD%91%E7%BB%9C%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88/:0:0","tags":["blog","ç½‘ç»œé…ç½®"],"title":"ç½‘ç»œåšå®¢é…ç½®æ–¹æ¡ˆ","uri":"/posts/%E7%BD%91%E7%BB%9C%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88/#3-git-clone-é…ç½®é¡µé¢"},{"categories":["ç”Ÿæ´»"],"collections":null,"content":"1 . åœ¨githubä¸Šé…ç½®é™æ€é¡µé¢ å‚è€ƒä¸‹é¢åœ°å€ï¼š GitHub - CaiJimmy/hugo-theme-stack: Card-style Hugo theme designed for bloggers 2. å®‰è£…HUGO å‚è€ƒç½‘ä¸Šèµ„æ–™ï¼Œå®‰è£…HUGOï¼ŒGOã€‚ 3. git clone é…ç½®é¡µé¢ 4. obsidia å®‰è£… hugo publish æ’ä»¶ 5. ä½¿ç”¨ ä½¿ç”¨è¿‡ç¨‹æ¯”è¾ƒä¸æ»‘çš„ï¼Œåªè¦åœ¨æ–‡æ¡£å±æ€§é‡Œé¢æ·»åŠ blogå±æ€§ã€‚ æ’ä»¶å›è‡ªåŠ¨ç”Ÿæˆå­—æ®µã€‚å¹¶ä¸”æ‹·è´åˆ° HUGO ç›®å½•ä¸‹å»ã€‚ ç„¶ååœ¨HUGO çš„ç›®å½•ä¸‹ï¼Œgitæäº¤ã€‚ github page ä¼šè‡ªåŠ¨ç”Ÿæˆç½‘é¡µ æ¯”å¦‚è¿™ä¸€ç¯‡å°±æ˜¯è¿™æ · âš ï¸upload failed, check dev console ","date":"2024-11-06","objectID":"/posts/%E7%BD%91%E7%BB%9C%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88/:0:0","tags":["blog","ç½‘ç»œé…ç½®"],"title":"ç½‘ç»œåšå®¢é…ç½®æ–¹æ¡ˆ","uri":"/posts/%E7%BD%91%E7%BB%9C%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88/#4-obsidia-å®‰è£…-hugo-publish-æ’ä»¶"},{"categories":["ç”Ÿæ´»"],"collections":null,"content":"1 . åœ¨githubä¸Šé…ç½®é™æ€é¡µé¢ å‚è€ƒä¸‹é¢åœ°å€ï¼š GitHub - CaiJimmy/hugo-theme-stack: Card-style Hugo theme designed for bloggers 2. å®‰è£…HUGO å‚è€ƒç½‘ä¸Šèµ„æ–™ï¼Œå®‰è£…HUGOï¼ŒGOã€‚ 3. git clone é…ç½®é¡µé¢ 4. obsidia å®‰è£… hugo publish æ’ä»¶ 5. ä½¿ç”¨ ä½¿ç”¨è¿‡ç¨‹æ¯”è¾ƒä¸æ»‘çš„ï¼Œåªè¦åœ¨æ–‡æ¡£å±æ€§é‡Œé¢æ·»åŠ blogå±æ€§ã€‚ æ’ä»¶å›è‡ªåŠ¨ç”Ÿæˆå­—æ®µã€‚å¹¶ä¸”æ‹·è´åˆ° HUGO ç›®å½•ä¸‹å»ã€‚ ç„¶ååœ¨HUGO çš„ç›®å½•ä¸‹ï¼Œgitæäº¤ã€‚ github page ä¼šè‡ªåŠ¨ç”Ÿæˆç½‘é¡µ æ¯”å¦‚è¿™ä¸€ç¯‡å°±æ˜¯è¿™æ · âš ï¸upload failed, check dev console ","date":"2024-11-06","objectID":"/posts/%E7%BD%91%E7%BB%9C%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88/:0:0","tags":["blog","ç½‘ç»œé…ç½®"],"title":"ç½‘ç»œåšå®¢é…ç½®æ–¹æ¡ˆ","uri":"/posts/%E7%BD%91%E7%BB%9C%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88/#5-ä½¿ç”¨"},{"categories":null,"collections":null,"content":"1 . åœ¨githubä¸Šé…ç½®é™æ€é¡µé¢ å‚è€ƒä¸‹é¢åœ°å€ï¼š GitHub - CaiJimmy/hugo-theme-stack: Card-style Hugo theme designed for bloggers 2. å®‰è£…HUGO å‚è€ƒç½‘ä¸Šèµ„æ–™ï¼Œå®‰è£…HUGOï¼ŒGOã€‚ 3. git clone é…ç½®é¡µé¢ 4. obsidia å®‰è£… hugo publish æ’ä»¶ 5. ä½¿ç”¨ ä½¿ç”¨è¿‡ç¨‹æ¯”è¾ƒä¸æ»‘çš„ï¼Œåªè¦åœ¨æ–‡æ¡£å±æ€§é‡Œé¢æ·»åŠ blogå±æ€§ã€‚ æ’ä»¶å›è‡ªåŠ¨ç”Ÿæˆå­—æ®µã€‚å¹¶ä¸”æ‹·è´åˆ° HUGO ç›®å½•ä¸‹å»ã€‚ ç„¶ååœ¨HUGO çš„ç›®å½•ä¸‹ï¼Œgitæäº¤ã€‚ github page ä¼šè‡ªåŠ¨ç”Ÿæˆç½‘é¡µ æ¯”å¦‚è¿™ä¸€ç¯‡å°±æ˜¯è¿™æ · âš ï¸upload failed, check dev console ","date":"2024-11-06","objectID":"/posts/%E7%BD%91%E7%BB%9C%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88/:0:0","tags":["blog","ç®—æ³•ç ”ç©¶"],"title":"ç½‘ç»œåšå®¢é…ç½®æ–¹æ¡ˆ","uri":"/posts/%E7%BD%91%E7%BB%9C%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88/#"},{"categories":null,"collections":null,"content":"1 . åœ¨githubä¸Šé…ç½®é™æ€é¡µé¢ å‚è€ƒä¸‹é¢åœ°å€ï¼š GitHub - CaiJimmy/hugo-theme-stack: Card-style Hugo theme designed for bloggers 2. å®‰è£…HUGO å‚è€ƒç½‘ä¸Šèµ„æ–™ï¼Œå®‰è£…HUGOï¼ŒGOã€‚ 3. git clone é…ç½®é¡µé¢ 4. obsidia å®‰è£… hugo publish æ’ä»¶ 5. ä½¿ç”¨ ä½¿ç”¨è¿‡ç¨‹æ¯”è¾ƒä¸æ»‘çš„ï¼Œåªè¦åœ¨æ–‡æ¡£å±æ€§é‡Œé¢æ·»åŠ blogå±æ€§ã€‚ æ’ä»¶å›è‡ªåŠ¨ç”Ÿæˆå­—æ®µã€‚å¹¶ä¸”æ‹·è´åˆ° HUGO ç›®å½•ä¸‹å»ã€‚ ç„¶ååœ¨HUGO çš„ç›®å½•ä¸‹ï¼Œgitæäº¤ã€‚ github page ä¼šè‡ªåŠ¨ç”Ÿæˆç½‘é¡µ æ¯”å¦‚è¿™ä¸€ç¯‡å°±æ˜¯è¿™æ · âš ï¸upload failed, check dev console ","date":"2024-11-06","objectID":"/posts/%E7%BD%91%E7%BB%9C%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88/:0:0","tags":["blog","ç®—æ³•ç ”ç©¶"],"title":"ç½‘ç»œåšå®¢é…ç½®æ–¹æ¡ˆ","uri":"/posts/%E7%BD%91%E7%BB%9C%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88/#1--åœ¨githubä¸Šé…ç½®é™æ€é¡µé¢"},{"categories":null,"collections":null,"content":"1 . åœ¨githubä¸Šé…ç½®é™æ€é¡µé¢ å‚è€ƒä¸‹é¢åœ°å€ï¼š GitHub - CaiJimmy/hugo-theme-stack: Card-style Hugo theme designed for bloggers 2. å®‰è£…HUGO å‚è€ƒç½‘ä¸Šèµ„æ–™ï¼Œå®‰è£…HUGOï¼ŒGOã€‚ 3. git clone é…ç½®é¡µé¢ 4. obsidia å®‰è£… hugo publish æ’ä»¶ 5. ä½¿ç”¨ ä½¿ç”¨è¿‡ç¨‹æ¯”è¾ƒä¸æ»‘çš„ï¼Œåªè¦åœ¨æ–‡æ¡£å±æ€§é‡Œé¢æ·»åŠ blogå±æ€§ã€‚ æ’ä»¶å›è‡ªåŠ¨ç”Ÿæˆå­—æ®µã€‚å¹¶ä¸”æ‹·è´åˆ° HUGO ç›®å½•ä¸‹å»ã€‚ ç„¶ååœ¨HUGO çš„ç›®å½•ä¸‹ï¼Œgitæäº¤ã€‚ github page ä¼šè‡ªåŠ¨ç”Ÿæˆç½‘é¡µ æ¯”å¦‚è¿™ä¸€ç¯‡å°±æ˜¯è¿™æ · âš ï¸upload failed, check dev console ","date":"2024-11-06","objectID":"/posts/%E7%BD%91%E7%BB%9C%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88/:0:0","tags":["blog","ç®—æ³•ç ”ç©¶"],"title":"ç½‘ç»œåšå®¢é…ç½®æ–¹æ¡ˆ","uri":"/posts/%E7%BD%91%E7%BB%9C%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88/#2-å®‰è£…hugo"},{"categories":null,"collections":null,"content":"1 . åœ¨githubä¸Šé…ç½®é™æ€é¡µé¢ å‚è€ƒä¸‹é¢åœ°å€ï¼š GitHub - CaiJimmy/hugo-theme-stack: Card-style Hugo theme designed for bloggers 2. å®‰è£…HUGO å‚è€ƒç½‘ä¸Šèµ„æ–™ï¼Œå®‰è£…HUGOï¼ŒGOã€‚ 3. git clone é…ç½®é¡µé¢ 4. obsidia å®‰è£… hugo publish æ’ä»¶ 5. ä½¿ç”¨ ä½¿ç”¨è¿‡ç¨‹æ¯”è¾ƒä¸æ»‘çš„ï¼Œåªè¦åœ¨æ–‡æ¡£å±æ€§é‡Œé¢æ·»åŠ blogå±æ€§ã€‚ æ’ä»¶å›è‡ªåŠ¨ç”Ÿæˆå­—æ®µã€‚å¹¶ä¸”æ‹·è´åˆ° HUGO ç›®å½•ä¸‹å»ã€‚ ç„¶ååœ¨HUGO çš„ç›®å½•ä¸‹ï¼Œgitæäº¤ã€‚ github page ä¼šè‡ªåŠ¨ç”Ÿæˆç½‘é¡µ æ¯”å¦‚è¿™ä¸€ç¯‡å°±æ˜¯è¿™æ · âš ï¸upload failed, check dev console ","date":"2024-11-06","objectID":"/posts/%E7%BD%91%E7%BB%9C%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88/:0:0","tags":["blog","ç®—æ³•ç ”ç©¶"],"title":"ç½‘ç»œåšå®¢é…ç½®æ–¹æ¡ˆ","uri":"/posts/%E7%BD%91%E7%BB%9C%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88/#3-git-clone-é…ç½®é¡µé¢"},{"categories":null,"collections":null,"content":"1 . åœ¨githubä¸Šé…ç½®é™æ€é¡µé¢ å‚è€ƒä¸‹é¢åœ°å€ï¼š GitHub - CaiJimmy/hugo-theme-stack: Card-style Hugo theme designed for bloggers 2. å®‰è£…HUGO å‚è€ƒç½‘ä¸Šèµ„æ–™ï¼Œå®‰è£…HUGOï¼ŒGOã€‚ 3. git clone é…ç½®é¡µé¢ 4. obsidia å®‰è£… hugo publish æ’ä»¶ 5. ä½¿ç”¨ ä½¿ç”¨è¿‡ç¨‹æ¯”è¾ƒä¸æ»‘çš„ï¼Œåªè¦åœ¨æ–‡æ¡£å±æ€§é‡Œé¢æ·»åŠ blogå±æ€§ã€‚ æ’ä»¶å›è‡ªåŠ¨ç”Ÿæˆå­—æ®µã€‚å¹¶ä¸”æ‹·è´åˆ° HUGO ç›®å½•ä¸‹å»ã€‚ ç„¶ååœ¨HUGO çš„ç›®å½•ä¸‹ï¼Œgitæäº¤ã€‚ github page ä¼šè‡ªåŠ¨ç”Ÿæˆç½‘é¡µ æ¯”å¦‚è¿™ä¸€ç¯‡å°±æ˜¯è¿™æ · âš ï¸upload failed, check dev console ","date":"2024-11-06","objectID":"/posts/%E7%BD%91%E7%BB%9C%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88/:0:0","tags":["blog","ç®—æ³•ç ”ç©¶"],"title":"ç½‘ç»œåšå®¢é…ç½®æ–¹æ¡ˆ","uri":"/posts/%E7%BD%91%E7%BB%9C%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88/#4-obsidia-å®‰è£…-hugo-publish-æ’ä»¶"},{"categories":null,"collections":null,"content":"1 . åœ¨githubä¸Šé…ç½®é™æ€é¡µé¢ å‚è€ƒä¸‹é¢åœ°å€ï¼š GitHub - CaiJimmy/hugo-theme-stack: Card-style Hugo theme designed for bloggers 2. å®‰è£…HUGO å‚è€ƒç½‘ä¸Šèµ„æ–™ï¼Œå®‰è£…HUGOï¼ŒGOã€‚ 3. git clone é…ç½®é¡µé¢ 4. obsidia å®‰è£… hugo publish æ’ä»¶ 5. ä½¿ç”¨ ä½¿ç”¨è¿‡ç¨‹æ¯”è¾ƒä¸æ»‘çš„ï¼Œåªè¦åœ¨æ–‡æ¡£å±æ€§é‡Œé¢æ·»åŠ blogå±æ€§ã€‚ æ’ä»¶å›è‡ªåŠ¨ç”Ÿæˆå­—æ®µã€‚å¹¶ä¸”æ‹·è´åˆ° HUGO ç›®å½•ä¸‹å»ã€‚ ç„¶ååœ¨HUGO çš„ç›®å½•ä¸‹ï¼Œgitæäº¤ã€‚ github page ä¼šè‡ªåŠ¨ç”Ÿæˆç½‘é¡µ æ¯”å¦‚è¿™ä¸€ç¯‡å°±æ˜¯è¿™æ · âš ï¸upload failed, check dev console ","date":"2024-11-06","objectID":"/posts/%E7%BD%91%E7%BB%9C%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88/:0:0","tags":["blog","ç®—æ³•ç ”ç©¶"],"title":"ç½‘ç»œåšå®¢é…ç½®æ–¹æ¡ˆ","uri":"/posts/%E7%BD%91%E7%BB%9C%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88/#5-ä½¿ç”¨"},{"categories":null,"collections":null,"content":"ã€é—®é¢˜æè¿°ã€‘ å®¢æˆ·éœ€æ±‚,è¦æ±‚æ—¥æ–‡å¯ä»¥åœ¨å¹³å‡å­—å’Œæ±‰å­—ä¹‹é—´åˆ‡æ¢. ","date":"2024-11-06","objectID":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/:1:0","tags":["å®æˆ˜","blog","Framework"],"title":"å¢åŠ è¯­è¨€æ–¹æ¡ˆ","uri":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/#é—®é¢˜æè¿°"},{"categories":null,"collections":null,"content":"ã€åˆ†æè¿‡ç¨‹ã€‘ åˆšå¼€å§‹æ‹¿åˆ°é—®é¢˜çš„æ˜¯,æŸ¥æ‰¾ï¦ºæ—¥æ–‡å­—åº“çš„æ”¯æŒæ ¼å¼,å‘ç°æ—¥æœ¬å­—åº“å°±æ˜¯åŒ…æ‹¬ï¦ºå¹³å‡å­—å’Œæ±‰å­—,æ˜¯è¿™ä¸¤ä¸ªçš„ä¸€ä¸ªé›†åˆ.ï¥§å­˜åœ¨ä¸¤ä¸ª å­—åº“çš„æ–¹å¼. ","date":"2024-11-06","objectID":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/:2:0","tags":["å®æˆ˜","blog","Framework"],"title":"å¢åŠ è¯­è¨€æ–¹æ¡ˆ","uri":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/#åˆ†æè¿‡ç¨‹"},{"categories":null,"collections":null,"content":"ã€è§£å†³æ–¹æ³•ã€‘ æ—¥æ–‡åŒ…æ‹¬ï¦ºå¹³å‡å­—å’Œæ±‰å­—çš„é›†åˆ,é‚£ä¹ˆå¦‚æœæˆ‘ä»¬è¦åˆ‡æ¢å¹³å‡å­—å’Œæ±‰å­—,æˆ‘ä»¬å°±éœ€è¦æ–°å»ºä¸€ä¸ªè¯­è¨€,æ—¥æ–‡ä½œä¸ºå¹³å‡å­—çš„è®¾ç½®,æ–°å»º çš„è¯­è¨€ä½œä¸ºæ±‰å­—çš„è®¾ç½®æ–¹å¼. æ·»åŠ ä¸€ç§æ–°çš„è¯­è¨€ lilyæ–¹æ¡ˆï¼š ","date":"2024-11-06","objectID":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/:3:0","tags":["å®æˆ˜","blog","Framework"],"title":"å¢åŠ è¯­è¨€æ–¹æ¡ˆ","uri":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/#è§£å†³æ–¹æ³•"},{"categories":null,"collections":null,"content":"ã€è§£å†³æ–¹æ³•ã€‘ æ—¥æ–‡åŒ…æ‹¬ï¦ºå¹³å‡å­—å’Œæ±‰å­—çš„é›†åˆ,é‚£ä¹ˆå¦‚æœæˆ‘ä»¬è¦åˆ‡æ¢å¹³å‡å­—å’Œæ±‰å­—,æˆ‘ä»¬å°±éœ€è¦æ–°å»ºä¸€ä¸ªè¯­è¨€,æ—¥æ–‡ä½œä¸ºå¹³å‡å­—çš„è®¾ç½®,æ–°å»º çš„è¯­è¨€ä½œä¸ºæ±‰å­—çš„è®¾ç½®æ–¹å¼. æ·»åŠ ä¸€ç§æ–°çš„è¯­è¨€ lilyæ–¹æ¡ˆï¼š ","date":"2024-11-06","objectID":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/:3:0","tags":["å®æˆ˜","blog","Framework"],"title":"å¢åŠ è¯­è¨€æ–¹æ¡ˆ","uri":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/#lilyæ–¹æ¡ˆ"},{"categories":null,"collections":null,"content":"1 ç¡®è®¤è¯­è¨€ç±»å‹ language_codeÂ ä¸ country codeÂ æ¯”å¦‚ ak-GHÂ language code å°±æ˜¯ ak ï¼Œ country codeå°±æ˜¯GHÂ èµ„æºæ–‡ä»¶å¤¹å¯ä»¥å®šä¹‰ä¸ºvalues-ak-rGHÂ å¦‚æœæ²¡æœ‰å›½å®¶ç å†²çªï¼Œå¯ä»¥ç›´æ¥å®šä¹‰ values-ak æˆ‘ä»¬éœ€è¦å»ä¸‹é¢ç½‘ç«™æŸ¥æ‰¾ language code å’Œ contry code: language code: https://zh.wikipedia.org/wiki/ISO_639Â­1 country code : https://zh.wikipedia.org/wiki/ISO_3166Â­1 å¦‚æœæˆ‘ä»¬æ·»åŠ çš„è¯­è¨€åœ¨é‡Œé¢,å°±ç›´æ¥ä½¿ç”¨,å¦‚æœï¥§åœ¨é‡Œé¢,é‚£æˆ‘ä»¬éœ€è¦ç¡®ä¿æˆ‘ä»¬æ·»åŠ çš„ç¼©å†™ï¥§èƒ½ä¸ä¸Šé¢çš„ISO_639Â­1é‡å¤. æ‰€ä»¥æˆ‘ä»¬ä»¥hg_JP ä½œä¸ºæ–°æ·»åŠ çš„ä¸€ç§è¯­è¨€,hgæ˜¯ language cod, JPæ˜¯conrty code ç”±äºæ‰‹è¡¨é¡¹ç›® è¯­è¨€å®¢æˆ·æŒ‡å®šäº†å¹³å‡åçš„ è¯­è¨€ç±»å‹ ak ï¼Œä¸ºäº†é€‚é…å®¢æˆ·apkï¼Œåœ¨æ‰‹è¡¨é¡¹ç›®ä¸­æ²¡æœ‰æ–°å»ºä¸€ä¸ªè¯­è¨€ï¼Œè€Œæ˜¯åœ¨ç°æœ‰akçš„è¯­è¨€åŸºç¡€ä¸Šåšä¿®æ”¹ã€‚åŒæ ·éœ€è¦åˆ°icuä¸­æ›´æ”¹icuæ•°æ®ã€‚ ","date":"2024-11-06","objectID":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/:3:1","tags":["å®æˆ˜","blog","Framework"],"title":"å¢åŠ è¯­è¨€æ–¹æ¡ˆ","uri":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/#1-ç¡®è®¤è¯­è¨€ç±»å‹"},{"categories":null,"collections":null,"content":"2 æ·»åŠ ICUèµ„æº ç”±äºHiragana/Kanjiæ˜¯ç»™ä¸Šå±‚è¯­è¨€åˆ‡æ¢åšåŒºåˆ†,ICUçš„èµ„æºæˆ‘ä»¬ä¸»è¦æ˜¯æ‹·è´ja é‡Œé¢çš„èµ„æºï¼Œå†è¿›è¡Œå®¢åˆ¶åŒ–çš„ä¿®æ”¹ã€‚ æŠŠå¯¹åº”çš„txtæ–‡ä»¶æ”¾åˆ°ï¼ˆexternal\\icu\\icu4c\\source\\dataï¼‰ç›®å½•ä¸‹collã€currã€langã€localesã€regionï¼Œzoneè¿™äº›å­æ–‡ä»¶å¤¹ ä¸­ã€‚ ä¸»è¦æ˜¯æ£€æŸ¥ä¸Šé¢ç›®å½•é‡Œé¢çš„ak.txt æ–‡ä»¶ï¼Œ å°†ja.txt æ‹·è´è‡³ak.txtæ–‡ä»¶ ä¸»è¦å·®å¼‚è¯çš„ï¼Œlocales é‡Œé¢çš„txtæ–‡ä»¶ï¼š æ–‡å­—å·®å¼‚ åˆå‰ åˆå¾Œ 1. ---Â a/icu4c/source/data/locales/ja.txt 2. +++Â b/icu4c/source/data/locales/ja.txt 3. @@Â -1258,16Â +1258,16Â @@ 4. } 5. gregorian{ 6. AmPmMarkers{ 7. -Â \"åˆå‰\", 8. -Â \"åˆå¾Œ\", 9. +Â \"ã”ãœã‚“\", 10. +Â \"ã”ã”\", 11. } 12. AmPmMarkersAbbr{ 13. -Â \"åˆå‰\", 14. -Â \"åˆå¾Œ\", 15. +Â \"ã”ãœã‚“\", 16. +Â \"ã”ã”\", 17. } 18. AmPmMarkersNarrow{ 19. -Â \"åˆå‰\", 20. -Â \"åˆå¾Œ\", 21. +Â \"ã”ãœã‚“\", 22. +Â \"ã”ã”\", 23. } 24. DateTimePatterns{ 25. \"Hæ™‚mmåˆ†ssç§’Â zzzz\", 26. @@Â -1345,30Â +1345,30Â @@ 27. format{ 28. abbreviated{ 29. \"æ—¥\", 30. -Â \"æœˆ\", 31. -Â \"ç«\", 32. -Â \"æ°´\", 33. -Â \"æœ¨\", 34. -Â \"é‡‘\", 35. -Â \"åœŸ\", 36. +Â \"ã«ã¡\", 37. +Â \"ã’ã¤\", 38. +Â \"ã‹\", 39. +Â \"ã™ã„\", 40. +Â \"ã‚‚ã\", 41. +Â \"ãã‚“\", 42. +Â \"ã©\", 43. } 2.1 æ›´æ–°åˆ†è¯è§„åˆ™ å®¢æˆ·æŠ¥å‡ºé—®é¢˜ï¼Œä¸åŒè¯­è¨€ä¸‹ï¼ŒåŒæ ·å­—ç¬¦ä¸²ï¼Œæ¢è¡Œä¸ä¸€æ ·ã€‚ ç»è¿‡åˆ†æã€‚TextView é‡Œé¢çš„æ¢è¡Œè§„åˆ™æ˜¯åœ¨StaticLayouté‡Œé¢ï¼š LineBreaker.Result res = lineBreaker.computeLineBreaks(measuredPara.getMeasuredText(), constraints, mLineCount); /** * Break paragraph into lines. * * The result is filled to out param. * * @param measuredPara a result of the text measurement * @param constraints for a single paragraph * @param lineNumber a line number of this paragraph */ public @NonNull Result computeLineBreaks( @NonNull MeasuredText measuredPara, @NonNull ParagraphConstraints constraints, @IntRange(from = 0) int lineNumber) { return new Result(nComputeLineBreaks( mNativePtr, // Inputs measuredPara.getChars(), measuredPara.getNativePtr(), measuredPara.getChars().length, constraints.mFirstWidth, constraints.mFirstWidthLineCount, constraints.mWidth, constraints.mVariableTabStops, constraints.mDefaultTabStop, lineNumber)); } nComputeLineBreaks æ–¹æ³•æ˜¯ä¸€ä¸ªNativeçš„æ–¹æ³•ï¼Œç”¨äºè®¡ç®—ä»€ä¹ˆæ—¶å€™å¼€å§‹æ¢è¡Œ å‘ç°æ¢è¡Œè¦æ ¹æ®åˆ†è¯è§„åˆ™å»æ¢è¡Œï¼Œé‚£ä¹ˆæ—¥è¯­jaæœ‰ç‰¹å®šçš„åˆ†è¯è§„åˆ™ï¼Œè€Œé¢å¤–æ·»åŠ çš„akæ²¡æœ‰ï¼Œä½¿ç”¨çš„å°±æ˜¯åŸºç¡€çš„åˆ†è¯è§„åˆ™ã€‚ å¦‚æœè¦ä¿æŒä¸€è‡´ï¼Œé‚£ä¹ˆå°±éœ€è¦å°†jaçš„brkitr èµ„æºæ‹·è´ä¸€ä»½ç»™ak brkitr è¯´æ˜ ICUï¼ˆInternational Components for Unicodeï¼‰çš„ brkitr åº“æ˜¯ä¸€ä¸ªæä¾›æ–‡æœ¬è¾¹ç•Œåˆ†æçš„åº“ï¼Œbrkitr æ˜¯â€œboundary breaker iteratorâ€ï¼ˆè¾¹ç•Œåˆ†å‰²è¿­ä»£å™¨ï¼‰çš„ç¼©å†™ã€‚å®ƒç”¨æ¥ç¡®å®šæ–‡æœ¬ä¸­çš„è¾¹ç•Œä½ç½®ï¼Œå¦‚å•è¯è¾¹ç•Œã€å¥å­è¾¹ç•Œã€è¡Œè¾¹ç•Œå’Œå­—ç¬¦è¾¹ç•Œã€‚è¿™å¯¹äºæ–‡æœ¬å¤„ç†éå¸¸å…³é”®ï¼Œå°¤å…¶æ˜¯åœ¨éœ€è¦å¯¹æ–‡æœ¬è¿›è¡Œåˆ†è¯ã€æ¢è¡Œã€é€‰æ‹©æˆ–å…‰æ ‡ç§»åŠ¨ç­‰æ“ä½œæ—¶ã€‚ ä»¥ä¸‹æ˜¯ brkitr åº“ä¸€äº›å¸¸è§çš„ä½¿ç”¨åœºæ™¯ï¼š å•è¯è¾¹ç•Œï¼šç”¨äºæ–‡æœ¬ç¼–è¾‘æˆ–å¤„ç†æ—¶ç¡®å®šå•è¯çš„å¼€å§‹å’Œç»“æŸï¼Œè¿™åœ¨æ–‡æœ¬é€‰æ‹©æˆ–è€…åŒå‡»å•è¯æ—¶ç‰¹åˆ«æœ‰ç”¨ã€‚ å¥å­è¾¹ç•Œï¼šç”¨äºæ–‡æœ¬å¤„ç†æ—¶ç¡®å®šå¥å­çš„å¼€å§‹å’Œç»“æŸï¼Œä¾‹å¦‚ï¼Œåœ¨å¤„ç†è‡ªåŠ¨å¤§å†™æ–°å¥å­çš„é¦–å­—æ¯æˆ–æ–‡æœ¬æ‘˜è¦æ—¶ã€‚ è¡Œè¾¹ç•Œï¼šç”¨äºæ–‡æœ¬å¸ƒå±€æ—¶ç¡®å®šåœ¨å“ªé‡Œè¿›è¡Œæ¢è¡Œï¼Œè¿™åœ¨UIç»„ä»¶å¦‚TextViewçš„æ–‡æœ¬æŠ˜è¡Œå¤„ç†ä¸­å°¤å…¶é‡è¦ã€‚ å­—ç¬¦è¾¹ç•Œï¼šç”¨äºç¡®å®šå¯åˆ†å‰²çš„å­—ç¬¦è¾¹ç•Œï¼Œæ¯”å¦‚åœ¨å¤„ç†å¤åˆå­—ç¬¦ï¼ˆå¦‚å¸¦å˜éŸ³ç¬¦çš„å­—æ¯ï¼‰æ—¶æ­£ç¡®åœ°å…‰æ ‡å®šä½æˆ–è€…æ–‡æœ¬é€‰æ‹©ã€‚ brkitr åº“å®ç°äº†å›½é™…åŒ–çš„æ–‡æœ¬è¾¹ç•Œè§„åˆ™ï¼Œæ”¯æŒå¤šç§è¯­è¨€å’Œæ–‡æœ¬è§„åˆ™ã€‚å®ƒåˆ©ç”¨Unicodeæ–‡æœ¬åˆ†å‰²ç®—æ³•å’Œè¯­è¨€ç‰¹å®šçš„è§„åˆ™æ¥ç¡®å®šè¿™äº›è¾¹ç•Œï¼Œä»è€Œæä¾›å‡†ç¡®çš„æ–‡æœ¬å¤„ç†èƒ½åŠ›ã€‚åœ¨å…¨çƒåŒ–çš„åº”ç”¨å¼€å‘ä¸­ï¼Œæ­£ç¡®åœ°è¯†åˆ«å’Œå¤„ç†ä¸åŒè¯­è¨€çš„æ–‡æœ¬è¾¹ç•Œæ˜¯éå¸¸é‡è¦çš„ã€‚ ","date":"2024-11-06","objectID":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/:3:2","tags":["å®æˆ˜","blog","Framework"],"title":"å¢åŠ è¯­è¨€æ–¹æ¡ˆ","uri":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/#2-æ·»åŠ icuèµ„æº"},{"categories":null,"collections":null,"content":"2 æ·»åŠ ICUèµ„æº ç”±äºHiragana/Kanjiæ˜¯ç»™ä¸Šå±‚è¯­è¨€åˆ‡æ¢åšåŒºåˆ†,ICUçš„èµ„æºæˆ‘ä»¬ä¸»è¦æ˜¯æ‹·è´ja é‡Œé¢çš„èµ„æºï¼Œå†è¿›è¡Œå®¢åˆ¶åŒ–çš„ä¿®æ”¹ã€‚ æŠŠå¯¹åº”çš„txtæ–‡ä»¶æ”¾åˆ°ï¼ˆexternal\\icu\\icu4c\\source\\dataï¼‰ç›®å½•ä¸‹collã€currã€langã€localesã€regionï¼Œzoneè¿™äº›å­æ–‡ä»¶å¤¹ ä¸­ã€‚ ä¸»è¦æ˜¯æ£€æŸ¥ä¸Šé¢ç›®å½•é‡Œé¢çš„ak.txt æ–‡ä»¶ï¼Œ å°†ja.txt æ‹·è´è‡³ak.txtæ–‡ä»¶ ä¸»è¦å·®å¼‚è¯çš„ï¼Œlocales é‡Œé¢çš„txtæ–‡ä»¶ï¼š æ–‡å­—å·®å¼‚ åˆå‰ åˆå¾Œ 1. ---Â a/icu4c/source/data/locales/ja.txt 2. +++Â b/icu4c/source/data/locales/ja.txt 3. @@Â -1258,16Â +1258,16Â @@ 4. } 5. gregorian{ 6. AmPmMarkers{ 7. -Â \"åˆå‰\", 8. -Â \"åˆå¾Œ\", 9. +Â \"ã”ãœã‚“\", 10. +Â \"ã”ã”\", 11. } 12. AmPmMarkersAbbr{ 13. -Â \"åˆå‰\", 14. -Â \"åˆå¾Œ\", 15. +Â \"ã”ãœã‚“\", 16. +Â \"ã”ã”\", 17. } 18. AmPmMarkersNarrow{ 19. -Â \"åˆå‰\", 20. -Â \"åˆå¾Œ\", 21. +Â \"ã”ãœã‚“\", 22. +Â \"ã”ã”\", 23. } 24. DateTimePatterns{ 25. \"Hæ™‚mmåˆ†ssç§’Â zzzz\", 26. @@Â -1345,30Â +1345,30Â @@ 27. format{ 28. abbreviated{ 29. \"æ—¥\", 30. -Â \"æœˆ\", 31. -Â \"ç«\", 32. -Â \"æ°´\", 33. -Â \"æœ¨\", 34. -Â \"é‡‘\", 35. -Â \"åœŸ\", 36. +Â \"ã«ã¡\", 37. +Â \"ã’ã¤\", 38. +Â \"ã‹\", 39. +Â \"ã™ã„\", 40. +Â \"ã‚‚ã\", 41. +Â \"ãã‚“\", 42. +Â \"ã©\", 43. } 2.1 æ›´æ–°åˆ†è¯è§„åˆ™ å®¢æˆ·æŠ¥å‡ºé—®é¢˜ï¼Œä¸åŒè¯­è¨€ä¸‹ï¼ŒåŒæ ·å­—ç¬¦ä¸²ï¼Œæ¢è¡Œä¸ä¸€æ ·ã€‚ ç»è¿‡åˆ†æã€‚TextView é‡Œé¢çš„æ¢è¡Œè§„åˆ™æ˜¯åœ¨StaticLayouté‡Œé¢ï¼š LineBreaker.Result res = lineBreaker.computeLineBreaks(measuredPara.getMeasuredText(), constraints, mLineCount); /** * Break paragraph into lines. * * The result is filled to out param. * * @param measuredPara a result of the text measurement * @param constraints for a single paragraph * @param lineNumber a line number of this paragraph */ public @NonNull Result computeLineBreaks( @NonNull MeasuredText measuredPara, @NonNull ParagraphConstraints constraints, @IntRange(from = 0) int lineNumber) { return new Result(nComputeLineBreaks( mNativePtr, // Inputs measuredPara.getChars(), measuredPara.getNativePtr(), measuredPara.getChars().length, constraints.mFirstWidth, constraints.mFirstWidthLineCount, constraints.mWidth, constraints.mVariableTabStops, constraints.mDefaultTabStop, lineNumber)); } nComputeLineBreaks æ–¹æ³•æ˜¯ä¸€ä¸ªNativeçš„æ–¹æ³•ï¼Œç”¨äºè®¡ç®—ä»€ä¹ˆæ—¶å€™å¼€å§‹æ¢è¡Œ å‘ç°æ¢è¡Œè¦æ ¹æ®åˆ†è¯è§„åˆ™å»æ¢è¡Œï¼Œé‚£ä¹ˆæ—¥è¯­jaæœ‰ç‰¹å®šçš„åˆ†è¯è§„åˆ™ï¼Œè€Œé¢å¤–æ·»åŠ çš„akæ²¡æœ‰ï¼Œä½¿ç”¨çš„å°±æ˜¯åŸºç¡€çš„åˆ†è¯è§„åˆ™ã€‚ å¦‚æœè¦ä¿æŒä¸€è‡´ï¼Œé‚£ä¹ˆå°±éœ€è¦å°†jaçš„brkitr èµ„æºæ‹·è´ä¸€ä»½ç»™ak brkitr è¯´æ˜ ICUï¼ˆInternational Components for Unicodeï¼‰çš„ brkitr åº“æ˜¯ä¸€ä¸ªæä¾›æ–‡æœ¬è¾¹ç•Œåˆ†æçš„åº“ï¼Œbrkitr æ˜¯â€œboundary breaker iteratorâ€ï¼ˆè¾¹ç•Œåˆ†å‰²è¿­ä»£å™¨ï¼‰çš„ç¼©å†™ã€‚å®ƒç”¨æ¥ç¡®å®šæ–‡æœ¬ä¸­çš„è¾¹ç•Œä½ç½®ï¼Œå¦‚å•è¯è¾¹ç•Œã€å¥å­è¾¹ç•Œã€è¡Œè¾¹ç•Œå’Œå­—ç¬¦è¾¹ç•Œã€‚è¿™å¯¹äºæ–‡æœ¬å¤„ç†éå¸¸å…³é”®ï¼Œå°¤å…¶æ˜¯åœ¨éœ€è¦å¯¹æ–‡æœ¬è¿›è¡Œåˆ†è¯ã€æ¢è¡Œã€é€‰æ‹©æˆ–å…‰æ ‡ç§»åŠ¨ç­‰æ“ä½œæ—¶ã€‚ ä»¥ä¸‹æ˜¯ brkitr åº“ä¸€äº›å¸¸è§çš„ä½¿ç”¨åœºæ™¯ï¼š å•è¯è¾¹ç•Œï¼šç”¨äºæ–‡æœ¬ç¼–è¾‘æˆ–å¤„ç†æ—¶ç¡®å®šå•è¯çš„å¼€å§‹å’Œç»“æŸï¼Œè¿™åœ¨æ–‡æœ¬é€‰æ‹©æˆ–è€…åŒå‡»å•è¯æ—¶ç‰¹åˆ«æœ‰ç”¨ã€‚ å¥å­è¾¹ç•Œï¼šç”¨äºæ–‡æœ¬å¤„ç†æ—¶ç¡®å®šå¥å­çš„å¼€å§‹å’Œç»“æŸï¼Œä¾‹å¦‚ï¼Œåœ¨å¤„ç†è‡ªåŠ¨å¤§å†™æ–°å¥å­çš„é¦–å­—æ¯æˆ–æ–‡æœ¬æ‘˜è¦æ—¶ã€‚ è¡Œè¾¹ç•Œï¼šç”¨äºæ–‡æœ¬å¸ƒå±€æ—¶ç¡®å®šåœ¨å“ªé‡Œè¿›è¡Œæ¢è¡Œï¼Œè¿™åœ¨UIç»„ä»¶å¦‚TextViewçš„æ–‡æœ¬æŠ˜è¡Œå¤„ç†ä¸­å°¤å…¶é‡è¦ã€‚ å­—ç¬¦è¾¹ç•Œï¼šç”¨äºç¡®å®šå¯åˆ†å‰²çš„å­—ç¬¦è¾¹ç•Œï¼Œæ¯”å¦‚åœ¨å¤„ç†å¤åˆå­—ç¬¦ï¼ˆå¦‚å¸¦å˜éŸ³ç¬¦çš„å­—æ¯ï¼‰æ—¶æ­£ç¡®åœ°å…‰æ ‡å®šä½æˆ–è€…æ–‡æœ¬é€‰æ‹©ã€‚ brkitr åº“å®ç°äº†å›½é™…åŒ–çš„æ–‡æœ¬è¾¹ç•Œè§„åˆ™ï¼Œæ”¯æŒå¤šç§è¯­è¨€å’Œæ–‡æœ¬è§„åˆ™ã€‚å®ƒåˆ©ç”¨Unicodeæ–‡æœ¬åˆ†å‰²ç®—æ³•å’Œè¯­è¨€ç‰¹å®šçš„è§„åˆ™æ¥ç¡®å®šè¿™äº›è¾¹ç•Œï¼Œä»è€Œæä¾›å‡†ç¡®çš„æ–‡æœ¬å¤„ç†èƒ½åŠ›ã€‚åœ¨å…¨çƒåŒ–çš„åº”ç”¨å¼€å‘ä¸­ï¼Œæ­£ç¡®åœ°è¯†åˆ«å’Œå¤„ç†ä¸åŒè¯­è¨€çš„æ–‡æœ¬è¾¹ç•Œæ˜¯éå¸¸é‡è¦çš„ã€‚ ","date":"2024-11-06","objectID":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/:3:2","tags":["å®æˆ˜","blog","Framework"],"title":"å¢åŠ è¯­è¨€æ–¹æ¡ˆ","uri":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/#æ–‡å­—å·®å¼‚-åˆå‰-åˆå¾Œ"},{"categories":null,"collections":null,"content":"2 æ·»åŠ ICUèµ„æº ç”±äºHiragana/Kanjiæ˜¯ç»™ä¸Šå±‚è¯­è¨€åˆ‡æ¢åšåŒºåˆ†,ICUçš„èµ„æºæˆ‘ä»¬ä¸»è¦æ˜¯æ‹·è´ja é‡Œé¢çš„èµ„æºï¼Œå†è¿›è¡Œå®¢åˆ¶åŒ–çš„ä¿®æ”¹ã€‚ æŠŠå¯¹åº”çš„txtæ–‡ä»¶æ”¾åˆ°ï¼ˆexternal\\icu\\icu4c\\source\\dataï¼‰ç›®å½•ä¸‹collã€currã€langã€localesã€regionï¼Œzoneè¿™äº›å­æ–‡ä»¶å¤¹ ä¸­ã€‚ ä¸»è¦æ˜¯æ£€æŸ¥ä¸Šé¢ç›®å½•é‡Œé¢çš„ak.txt æ–‡ä»¶ï¼Œ å°†ja.txt æ‹·è´è‡³ak.txtæ–‡ä»¶ ä¸»è¦å·®å¼‚è¯çš„ï¼Œlocales é‡Œé¢çš„txtæ–‡ä»¶ï¼š æ–‡å­—å·®å¼‚ åˆå‰ åˆå¾Œ 1. ---Â a/icu4c/source/data/locales/ja.txt 2. +++Â b/icu4c/source/data/locales/ja.txt 3. @@Â -1258,16Â +1258,16Â @@ 4. } 5. gregorian{ 6. AmPmMarkers{ 7. -Â \"åˆå‰\", 8. -Â \"åˆå¾Œ\", 9. +Â \"ã”ãœã‚“\", 10. +Â \"ã”ã”\", 11. } 12. AmPmMarkersAbbr{ 13. -Â \"åˆå‰\", 14. -Â \"åˆå¾Œ\", 15. +Â \"ã”ãœã‚“\", 16. +Â \"ã”ã”\", 17. } 18. AmPmMarkersNarrow{ 19. -Â \"åˆå‰\", 20. -Â \"åˆå¾Œ\", 21. +Â \"ã”ãœã‚“\", 22. +Â \"ã”ã”\", 23. } 24. DateTimePatterns{ 25. \"Hæ™‚mmåˆ†ssç§’Â zzzz\", 26. @@Â -1345,30Â +1345,30Â @@ 27. format{ 28. abbreviated{ 29. \"æ—¥\", 30. -Â \"æœˆ\", 31. -Â \"ç«\", 32. -Â \"æ°´\", 33. -Â \"æœ¨\", 34. -Â \"é‡‘\", 35. -Â \"åœŸ\", 36. +Â \"ã«ã¡\", 37. +Â \"ã’ã¤\", 38. +Â \"ã‹\", 39. +Â \"ã™ã„\", 40. +Â \"ã‚‚ã\", 41. +Â \"ãã‚“\", 42. +Â \"ã©\", 43. } 2.1 æ›´æ–°åˆ†è¯è§„åˆ™ å®¢æˆ·æŠ¥å‡ºé—®é¢˜ï¼Œä¸åŒè¯­è¨€ä¸‹ï¼ŒåŒæ ·å­—ç¬¦ä¸²ï¼Œæ¢è¡Œä¸ä¸€æ ·ã€‚ ç»è¿‡åˆ†æã€‚TextView é‡Œé¢çš„æ¢è¡Œè§„åˆ™æ˜¯åœ¨StaticLayouté‡Œé¢ï¼š LineBreaker.Result res = lineBreaker.computeLineBreaks(measuredPara.getMeasuredText(), constraints, mLineCount); /** * Break paragraph into lines. * * The result is filled to out param. * * @param measuredPara a result of the text measurement * @param constraints for a single paragraph * @param lineNumber a line number of this paragraph */ public @NonNull Result computeLineBreaks( @NonNull MeasuredText measuredPara, @NonNull ParagraphConstraints constraints, @IntRange(from = 0) int lineNumber) { return new Result(nComputeLineBreaks( mNativePtr, // Inputs measuredPara.getChars(), measuredPara.getNativePtr(), measuredPara.getChars().length, constraints.mFirstWidth, constraints.mFirstWidthLineCount, constraints.mWidth, constraints.mVariableTabStops, constraints.mDefaultTabStop, lineNumber)); } nComputeLineBreaks æ–¹æ³•æ˜¯ä¸€ä¸ªNativeçš„æ–¹æ³•ï¼Œç”¨äºè®¡ç®—ä»€ä¹ˆæ—¶å€™å¼€å§‹æ¢è¡Œ å‘ç°æ¢è¡Œè¦æ ¹æ®åˆ†è¯è§„åˆ™å»æ¢è¡Œï¼Œé‚£ä¹ˆæ—¥è¯­jaæœ‰ç‰¹å®šçš„åˆ†è¯è§„åˆ™ï¼Œè€Œé¢å¤–æ·»åŠ çš„akæ²¡æœ‰ï¼Œä½¿ç”¨çš„å°±æ˜¯åŸºç¡€çš„åˆ†è¯è§„åˆ™ã€‚ å¦‚æœè¦ä¿æŒä¸€è‡´ï¼Œé‚£ä¹ˆå°±éœ€è¦å°†jaçš„brkitr èµ„æºæ‹·è´ä¸€ä»½ç»™ak brkitr è¯´æ˜ ICUï¼ˆInternational Components for Unicodeï¼‰çš„ brkitr åº“æ˜¯ä¸€ä¸ªæä¾›æ–‡æœ¬è¾¹ç•Œåˆ†æçš„åº“ï¼Œbrkitr æ˜¯â€œboundary breaker iteratorâ€ï¼ˆè¾¹ç•Œåˆ†å‰²è¿­ä»£å™¨ï¼‰çš„ç¼©å†™ã€‚å®ƒç”¨æ¥ç¡®å®šæ–‡æœ¬ä¸­çš„è¾¹ç•Œä½ç½®ï¼Œå¦‚å•è¯è¾¹ç•Œã€å¥å­è¾¹ç•Œã€è¡Œè¾¹ç•Œå’Œå­—ç¬¦è¾¹ç•Œã€‚è¿™å¯¹äºæ–‡æœ¬å¤„ç†éå¸¸å…³é”®ï¼Œå°¤å…¶æ˜¯åœ¨éœ€è¦å¯¹æ–‡æœ¬è¿›è¡Œåˆ†è¯ã€æ¢è¡Œã€é€‰æ‹©æˆ–å…‰æ ‡ç§»åŠ¨ç­‰æ“ä½œæ—¶ã€‚ ä»¥ä¸‹æ˜¯ brkitr åº“ä¸€äº›å¸¸è§çš„ä½¿ç”¨åœºæ™¯ï¼š å•è¯è¾¹ç•Œï¼šç”¨äºæ–‡æœ¬ç¼–è¾‘æˆ–å¤„ç†æ—¶ç¡®å®šå•è¯çš„å¼€å§‹å’Œç»“æŸï¼Œè¿™åœ¨æ–‡æœ¬é€‰æ‹©æˆ–è€…åŒå‡»å•è¯æ—¶ç‰¹åˆ«æœ‰ç”¨ã€‚ å¥å­è¾¹ç•Œï¼šç”¨äºæ–‡æœ¬å¤„ç†æ—¶ç¡®å®šå¥å­çš„å¼€å§‹å’Œç»“æŸï¼Œä¾‹å¦‚ï¼Œåœ¨å¤„ç†è‡ªåŠ¨å¤§å†™æ–°å¥å­çš„é¦–å­—æ¯æˆ–æ–‡æœ¬æ‘˜è¦æ—¶ã€‚ è¡Œè¾¹ç•Œï¼šç”¨äºæ–‡æœ¬å¸ƒå±€æ—¶ç¡®å®šåœ¨å“ªé‡Œè¿›è¡Œæ¢è¡Œï¼Œè¿™åœ¨UIç»„ä»¶å¦‚TextViewçš„æ–‡æœ¬æŠ˜è¡Œå¤„ç†ä¸­å°¤å…¶é‡è¦ã€‚ å­—ç¬¦è¾¹ç•Œï¼šç”¨äºç¡®å®šå¯åˆ†å‰²çš„å­—ç¬¦è¾¹ç•Œï¼Œæ¯”å¦‚åœ¨å¤„ç†å¤åˆå­—ç¬¦ï¼ˆå¦‚å¸¦å˜éŸ³ç¬¦çš„å­—æ¯ï¼‰æ—¶æ­£ç¡®åœ°å…‰æ ‡å®šä½æˆ–è€…æ–‡æœ¬é€‰æ‹©ã€‚ brkitr åº“å®ç°äº†å›½é™…åŒ–çš„æ–‡æœ¬è¾¹ç•Œè§„åˆ™ï¼Œæ”¯æŒå¤šç§è¯­è¨€å’Œæ–‡æœ¬è§„åˆ™ã€‚å®ƒåˆ©ç”¨Unicodeæ–‡æœ¬åˆ†å‰²ç®—æ³•å’Œè¯­è¨€ç‰¹å®šçš„è§„åˆ™æ¥ç¡®å®šè¿™äº›è¾¹ç•Œï¼Œä»è€Œæä¾›å‡†ç¡®çš„æ–‡æœ¬å¤„ç†èƒ½åŠ›ã€‚åœ¨å…¨çƒåŒ–çš„åº”ç”¨å¼€å‘ä¸­ï¼Œæ­£ç¡®åœ°è¯†åˆ«å’Œå¤„ç†ä¸åŒè¯­è¨€çš„æ–‡æœ¬è¾¹ç•Œæ˜¯éå¸¸é‡è¦çš„ã€‚ ","date":"2024-11-06","objectID":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/:3:2","tags":["å®æˆ˜","blog","Framework"],"title":"å¢åŠ è¯­è¨€æ–¹æ¡ˆ","uri":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/#21-æ›´æ–°åˆ†è¯è§„åˆ™"},{"categories":null,"collections":null,"content":"3. ç¼–è¯‘ICUèµ„æº lilié¡¹ç›® è¿›å…¥åˆ°$AOSP/external/icu/icu4c/source/ç›®å½•ä¸‹çš„ åœ¨è¯¥ç›®å½•ä¸‹æ‰§è¡Œ ./runConfigureICU Linuxå‘½ä»¤ç”ŸæˆMAKEæ–‡ä»¶ æ‰§è¡Œmake INCLUDE_UNI_CORE_DATA=1 å°†ç¬¬ä¸€æ­¥ç”Ÿæˆçš„external/icu4c/icubuild/data/out/tmp/icudtxxl.datå¤åˆ¶åˆ°external/icu4c/stubdataä¸‹å¹¶æ”¹åä¸º icudtxxlÂ­all.datè¦†ç›–åŸæ¥çš„åŒåæ–‡ä»¶ã€‚ cpexternal/icu/icu4c/source/data/out/tmp/icudt58l.dat $AOSP/external/icu/icu4c/source/stubdataÂ è¯¥æ–¹æ¡ˆåœ¨A11 ä¸Šç¼–è¯‘å¤±æ•ˆï¼Œçƒ§å…¥æ‰‹æœºå ï¼Œè½½å…¥icuä¼šå‡ºé”™ å¼€ä¸äº†æœºå™¨ã€‚ ç¼–è¯‘æ–¹æ¡ˆï¼š é¦–å…ˆåœ¨å·¥ç¨‹æ ¹ç›®å½•ï¼Œè¿›è¡Œsource ,lunch ï¼Œè®¾ç½®ç¯å¢ƒå˜é‡ã€‚ ç„¶ååœ¨Â aosp/external/icu/tools ç›®å½•ä¸‹ æ‰§è¡Œä¸‹é¢è„šæœ¬ï¼šupdateicudata.py ä¼šè‡ªåŠ¨config å’Œç¼–è¯‘ï¼Œç„¶åè‡ªåŠ¨æŠŠç»“æœcopy åˆ° stubdataç›®å½•ã€‚ ","date":"2024-11-06","objectID":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/:3:3","tags":["å®æˆ˜","blog","Framework"],"title":"å¢åŠ è¯­è¨€æ–¹æ¡ˆ","uri":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/#3-ç¼–è¯‘icuèµ„æº"},{"categories":null,"collections":null,"content":"4.æ·»åŠ è¯­è¨€æ”¯æŒ #Â sdm429w_law.mkÂ Definedthelocales PRODUCT_LOCALES:=en_USÂ ja_JPÂ ak_GK ","date":"2024-11-06","objectID":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/:3:4","tags":["å®æˆ˜","blog","Framework"],"title":"å¢åŠ è¯­è¨€æ–¹æ¡ˆ","uri":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/#4æ·»åŠ è¯­è¨€æ”¯æŒ"},{"categories":null,"collections":null,"content":"5.ç¿»è¯‘å­—ç¬¦ä¸² åœ¨frameworks/base/core/res/res/ä¸‹æ–°å¢åŠ ä¸€ä¸ªvaluesÂ­-akçš„æ–‡ä»¶å¤¹,æ–°å»ºä¸€ä¸ªstrings.xmlæ–‡ä»¶ï¼ŒæŠŠframeworksç¿» è¯‘å†…å®¹æ”¾åœ¨è¿™ä¸ªæ–‡ä»¶å†…: å¯¹æ¯ä¸ªappåšç¿»è¯‘ï¼Œåœ¨æ¯ä¸ªappå¯¹åº”çš„resç›®å½•ä¸‹é¢å»ºç«‹valuesÂ­-akæ–‡ä»¶å¤¹ï¼Œå¹¶å°†ç¿»è¯‘å¥½çš„strings.xmlæ”¾åœ¨é‡Œé¢ï¼› ","date":"2024-11-06","objectID":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/:3:5","tags":["å®æˆ˜","blog","Framework"],"title":"å¢åŠ è¯­è¨€æ–¹æ¡ˆ","uri":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/#5ç¿»è¯‘å­—ç¬¦ä¸²"},{"categories":null,"collections":null,"content":"6. æ·»åŠ è®¾ç½®èœå• è®¾ç½®è¯­è¨€ä¸»è¦å°±æ˜¯é€šè¿‡Â LocalePicker.updateLocale(hiragana); æ¥å®ç° importÂ java.util.Locale; importÂ com.android.internal.app.LocalePicker; staticÂ finalÂ StringÂ hiragana_languageÂ =â€œakâ€; staticÂ finalÂ StringÂ hiragana_countryÂ =â€œGHâ€; staticÂ finalÂ StringÂ kanji_languageÂ =Â â€œjaâ€; staticÂ finalÂ StringÂ kanji_countryÂ =Â â€œJPâ€; staticÂ finalÂ StringÂ english_languageÂ =Â â€œenâ€; staticÂ finalÂ StringÂ english_countryÂ =Â â€œUSâ€; @Override protectedÂ voidÂ onCreate(BundleÂ savedInstanceState)Â { super.onCreate(savedInstanceState); setContentView(R.layout.activity_language_setting); mRadioGroupÂ =Â findViewById(R.id.rg_show); mRbHiraganaÂ =Â findViewById(R.id.rb_hiragana); mRbKanjiÂ =Â findViewById(R.id.rb_kanji); mRbEnglishÂ =Â findViewById(R.id.rb_en_us); updateRadioMenuChecked(); updateEnglisMenu(); mRadioGroup.setOnCheckedChangeListener(newÂ RadioGroup.OnCheckedChangeListener()Â { @Override publicÂ voidÂ onCheckedChanged(RadioGroupÂ group,Â intÂ checkedId)Â { if(checkedIdÂ ==Â R.id.rb_hiragana){ LocaleÂ hiraganaÂ =Â newÂ Locale(hiragana_language,hiragana_country); LocalePicker.updateLocale(hiragana); }elseÂ if(checkedIdÂ ==Â R.id.rb_kanji)Â { LocaleÂ kanjiÂ =Â newÂ Locale(kanji_language,kanji_country); LocalePicker.updateLocale(kanji); }elseÂ if(checkedIdÂ ==Â R.id.rb_en_us)Â { LocaleÂ english_usÂ =Â newÂ Locale(english_language,english_country); LocalePicker.updateLocale(english_us); } } }); } ","date":"2024-11-06","objectID":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/:3:6","tags":["å®æˆ˜","blog","Framework"],"title":"å¢åŠ è¯­è¨€æ–¹æ¡ˆ","uri":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/#6-æ·»åŠ è®¾ç½®èœå•"},{"categories":null,"collections":null,"content":"é™„å½•ï¼š å¹´æœˆæ—¥ç¿»è¯‘ï¼š diff --git a/icu4c/source/data/locales/ak.txt b/icu4c/source/data/locales/ak.txt index 2591869..2e4ceaf 100644 --- a/icu4c/source/data/locales/ak.txt +++ b/icu4c/source/data/locales/ak.txt @@ -243,8 +243,8 @@ \"H:mm:ss z\", \"H:mm:ss\", \"H:mm\", - \"GGGGyå¹´Mæœˆdæ—¥EEEE\", - \"GGGGyå¹´Mæœˆdæ—¥\", + \"GGGGyã­ã‚“MãŒã¤dã«ã¡EEEE\", + \"GGGGyã­ã‚“MãŒã¤dã«ã¡\", \"Gy/MM/dd\", \"Gy/MM/dd\", \"{1} {0}\", @@ -254,42 +254,42 @@ \"{1} {0}\", } availableFormats{ - EEEEd{\"dæ—¥EEEE\"} - Ed{\"dæ—¥(E)\"} - Gy{\"GGGGyå¹´\"} - GyMMM{\"GGGGyå¹´Mæœˆ\"} - GyMMMEEEEd{\"GGGGyå¹´Mæœˆdæ—¥EEEE\"} - GyMMMEd{\"GGGGyå¹´Mæœˆdæ—¥(E)\"} - GyMMMd{\"GGGGyå¹´Mæœˆdæ—¥\"} - GyMd{\"GGGGyå¹´Mæœˆdæ—¥\"} + EEEEd{\"dã«ã¡EEEE\"} + Ed{\"dã«ã¡(E)\"} + Gy{\"GGGGyã­ã‚“\"} + GyMMM{\"GGGGyã­ã‚“MãŒã¤\"} + GyMMMEEEEd{\"GGGGyã­ã‚“MãŒã¤dã«ã¡EEEE\"} + GyMMMEd{\"GGGGyã­ã‚“MãŒã¤dã«ã¡(E)\"} + GyMMMd{\"GGGGyã­ã‚“MãŒã¤dã«ã¡\"} + GyMd{\"GGGGyã­ã‚“MãŒã¤dã«ã¡\"} H{\"Hæ™‚\"} Hm{\"H:mm\"} Hms{\"H:mm:ss\"} - M{\"Mæœˆ\"} + M{\"MãŒã¤\"} MEEEEd{\"M/dEEEE\"} MEd{\"M/d(E)\"} - MMM{\"Mæœˆ\"} - MMMEEEEd{\"Mæœˆdæ—¥EEEE\"} - MMMEd{\"Mæœˆdæ—¥(E)\"} - MMMMd{\"Mæœˆdæ—¥\"} - MMMd{\"Mæœˆdæ—¥\"} + MMM{\"MãŒã¤\"} + MMMEEEEd{\"MãŒã¤dã«ã¡EEEE\"} + MMMEd{\"MãŒã¤dã«ã¡(E)\"} + MMMMd{\"MãŒã¤dã«ã¡\"} + MMMd{\"MãŒã¤dã«ã¡\"} Md{\"M/d\"} - d{\"dæ—¥\"} + d{\"dã«ã¡\"} h{\"aKæ™‚\"} hm{\"aK:mm\"} hms{\"aK:mm:ss\"} ms{\"mm:ss\"} - y{\"GGGGyå¹´\"} - yyyy{\"GGGGyå¹´\"} - yyyyM{\"GGGGyå¹´Mæœˆ\"} - yyyyMEEEEd{\"GGGGyå¹´M/dEEEE\"} - yyyyMEd{\"GGGGyå¹´M/d(E)\"} + y{\"GGGGyã­ã‚“\"} + yyyy{\"GGGGyã­ã‚“\"} + yyyyM{\"GGGGyã­ã‚“MãŒã¤\"} + yyyyMEEEEd{\"GGGGyã­ã‚“M/dEEEE\"} + yyyyMEd{\"GGGGyã­ã‚“M/d(E)\"} yyyyMM{\"Gy/MM\"} - yyyyMMM{\"GGGGyå¹´Mæœˆ\"} - yyyyMMMEEEEd{\"GGGGyå¹´Mæœˆdæ—¥EEEE\"} - yyyyMMMEd{\"GGGGyå¹´Mæœˆdæ—¥(E)\"} - yyyyMMMM{\"GGGGyå¹´Mæœˆ\"} - yyyyMMMd{\"GGGGyå¹´Mæœˆdæ—¥\"} + yyyyMMM{\"GGGGyã­ã‚“MãŒã¤\"} + yyyyMMMEEEEd{\"GGGGyã­ã‚“MãŒã¤dã«ã¡EEEE\"} + yyyyMMMEd{\"GGGGyã­ã‚“MãŒã¤dã«ã¡(E)\"} + yyyyMMMM{\"GGGGyã­ã‚“MãŒã¤\"} + yyyyMMMd{\"GGGGyã­ã‚“MãŒã¤dã«ã¡\"} yyyyMd{\"Gy/M/d\"} } eras{ @@ -311,15 +311,15 @@ \"H:mm:ss\", \"H:mm\", { - \"Uå¹´MMMdæ—¥EEEE\", + \"Uã­ã‚“MMMdã«ã¡EEEE\", \"hanidec\", } { - \"Uå¹´MMMdæ—¥\", + \"Uã­ã‚“MMMdã«ã¡\", \"hanidec\", } { - \"Uå¹´MMMdæ—¥\", + \"Uã­ã‚“MMMdã«ã¡\", \"hanidec\", } \"U-M-d\", @@ -336,13 +336,13 @@ E{\"ccc\"} EBhm{\"BK:mm (E)\"} EBhms{\"BK:mm:ss (E)\"} - EEEEd{\"dæ—¥EEEE\"} - Ed{\"dæ—¥(E)\"} - Gy{\"Uå¹´\"} - GyMMM{\"Uå¹´MMM\"} - GyMMMEEEEd{\"Uå¹´MMMdæ—¥EEEE\"} - GyMMMEd{\"Uå¹´MMMdæ—¥(E)\"} - GyMMMd{\"Uå¹´MMMdæ—¥\"} + EEEEd{\"dã«ã¡EEEE\"} + Ed{\"dã«ã¡(E)\"} + Gy{\"Uã­ã‚“\"} + GyMMM{\"Uã­ã‚“MMM\"} + GyMMMEEEEd{\"Uã­ã‚“MMMdã«ã¡EEEE\"} + GyMMMEd{\"Uã­ã‚“MMMdã«ã¡(E)\"} + GyMMMd{\"Uã­ã‚“MMMdã«ã¡\"} H{\"Hæ™‚\"} Hm{\"H:mm\"} Hms{\"H:mm:ss\"} @@ -350,34 +350,34 @@ MEEEEd{\"M/dEEEE\"} MEd{\"M/d(E)\"} MMM{\"LLL\"} - MMMEEEEd{\"MMMdæ—¥EEEE\"} - MMMEd{\"MMMdæ—¥(E)\"} - MMMMd{\"MMMMdæ—¥\"} - MMMd{\"MMMdæ—¥\"} + MMMEEEEd{\"MMMdã«ã¡EEEE\"} + MMMEd{\"MMMdã«ã¡(E)\"} + MMMMd{\"MMMMdã«ã¡\"} + MMMd{\"MMMdã«ã¡\"} Md{\"M/d\"} - UM{\"Uå¹´Mæœˆ\"} - UMMM{\"Uå¹´MMM\"} - UMMMd{\"Uå¹´MMMdæ—¥\"} - UMd{\"Uå¹´Mæœˆdæ—¥\"} - d{\"dæ—¥\"} + UM{\"Uã­ã‚“MãŒã¤\"} + UMMM{\"Uã­ã‚“MMM\"} + UMMMd{\"Uã­ã‚“MMMdã«ã¡\"} + UMd{\"Uã­ã‚“MãŒã¤dã«ã¡\"} + d{\"dã«ã¡\"} h{\"aKæ™‚\"} hm{\"aK:mm\"} hms{\"aK:mm:ss\"} ms{\"mm:ss\"} - y{\"Uå¹´\"} - yMd{\"Uå¹´Mæœˆdæ—¥\"} - yyyy{\"Uå¹´\"} - yyyyM{\"Uå¹´Mæœˆ\"} - yyyyMEEEEd{\"Uå¹´Mæœˆdæ—¥EEEE\"} - yyyyMEd{\"Uå¹´Mæœˆdæ—¥(E)\"} - yyyyMMM{\"Uå¹´MMM\"} - yyyyMMMEEEEd{\"Uå¹´MMMdæ—¥EEEE\"} - yyyyMMMEd{\"Uå¹´MMMdæ—¥(E)\"} - yyyyMMMM{\"Uå¹´MMMM\"} - yyyyMMMd{\"Uå¹´MMMdæ—¥\"} - yyyyMd{\"Uå¹´Mæœˆdæ—¥\"} - yyyyQQQ{\"Uå¹´QQQ\"} - yyyyQQQQ{\"Uå¹´QQQQ\"} + y{\"Uã­ã‚“\"} + yMd{\"Uã­ã‚“MãŒã¤dã«ã¡\"} + yyyy{\"Uã­ã‚“\"} + yyyyM{\"Uã­ã‚“MãŒã¤\"} + yyyyMEEEEd{\"Uã­ã‚“MãŒã¤dã«ã¡EEEE\"} + yyyyMEd{\"Uã­ã‚“MãŒã¤dã«ã¡(E)\"} + yyyyMMM{\"Uã­ã‚“MMM\"} + yyyyMMMEEEEd{\"Uã­ã‚“MMMdã«ã¡EEEE\"} + yyyyMMMEd{\"Uã­ã‚“MMMdã«ã¡(E)\"} + yyyyMMMM{\"Uã­ã‚“MMMM\"} + yyyyMMMd{\"Uã­ã‚“MMMdã«ã¡\"} + yyyyMd{\"Uã­ã‚“MãŒã¤dã«ã¡\"} + yyyyQQQ{\"Uã­ã‚“QQQ\"} + yyyyQQQQ{\"Uã­ã‚“QQQQ\"} } cyclicNameSets{ dayParts{ @@ -529,7 +529,7 @@ H{\"Hæ™‚ï½Hæ™‚(v)\"} } M{ - M{\"Mæœˆï½Mæœˆ\"} + M{\"MãŒã¤ï½MãŒã¤\"} } MEd{ M{\"MM/dd(E)ï½MM/dd(E)\"} @@ -539,22 +539,22 @@ M{\"MMMï½MMM\"} } MMMEd{ - M{\"MMMdæ—¥(E)ï½MMMdæ—¥(E)\"} - d{\"MMMdæ—¥(E)ï½dæ—¥(E)\"} + M{\"MMMdã«ã¡(E)ï½MMMdã«ã¡(E)\"} + d{\"MMMdã«ã¡(E)ï½dã«ã¡(E)\"} } MMMM{ M{\"MMMMï½MMMM\"} } MMMd{ - M{\"MMMdæ—¥ï½MMMdæ—¥\"} - d{\"MMMdæ—¥ï½dæ—¥\"} + M{\"MMMdã«ã¡ï½MMMdã«ã¡\"} + d{\"MMMdã«ã¡ï½dã«ã¡\"} } Md{ M{\"MM/ddï½MM/dd\"} d{\"MM/ddï½MM/dd\"} } d{ - d{\"dæ—¥ï½dæ—¥\"} + d{\"dã«ã¡ï½dã«ã¡\"} } fallback{\"{0}ï½{1}\"} h{ @@ -576,7 +576,7 @@ h{\"aKæ™‚ï½Kæ™‚(v)\"} } y{ - y{\"Uå¹´ï½Uå¹´\"} + y{\"Uã­ã‚“ï½Uã­ã‚“\"} } yM{ M{\"U/MMï½U/MM\"} @@ -588,22 +588,22 @@ y{\"U/MM/dd(E)ï½U/MM/dd(E)\"} } yMMM{ - M{\"Uå¹´MMMï½MMM\"} - y{\"Uå¹´MMMï½Uå¹´MMM\"} + M{\"Uã­ã‚“MMMï½MMM\"} + y{\"Uã­ã‚“MMMï½Uã­ã‚“MMM\"} } yMMMEd{ - M{\"Uå¹´MMMdæ—¥(E)ï½MMMdæ—¥(E)\"} - d{\"Uå¹´MMMdæ—¥(E)ï½dæ—¥","date":"2024-11-06","objectID":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/:3:7","tags":["å®æˆ˜","blog","Framework"],"title":"å¢åŠ è¯­è¨€æ–¹æ¡ˆ","uri":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/#é™„å½•"},{"categories":null,"collections":null,"content":"é™„å½•ï¼š å¹´æœˆæ—¥ç¿»è¯‘ï¼š diff --git a/icu4c/source/data/locales/ak.txt b/icu4c/source/data/locales/ak.txt index 2591869..2e4ceaf 100644 --- a/icu4c/source/data/locales/ak.txt +++ b/icu4c/source/data/locales/ak.txt @@ -243,8 +243,8 @@ \"H:mm:ss z\", \"H:mm:ss\", \"H:mm\", - \"GGGGyå¹´Mæœˆdæ—¥EEEE\", - \"GGGGyå¹´Mæœˆdæ—¥\", + \"GGGGyã­ã‚“MãŒã¤dã«ã¡EEEE\", + \"GGGGyã­ã‚“MãŒã¤dã«ã¡\", \"Gy/MM/dd\", \"Gy/MM/dd\", \"{1} {0}\", @@ -254,42 +254,42 @@ \"{1} {0}\", } availableFormats{ - EEEEd{\"dæ—¥EEEE\"} - Ed{\"dæ—¥(E)\"} - Gy{\"GGGGyå¹´\"} - GyMMM{\"GGGGyå¹´Mæœˆ\"} - GyMMMEEEEd{\"GGGGyå¹´Mæœˆdæ—¥EEEE\"} - GyMMMEd{\"GGGGyå¹´Mæœˆdæ—¥(E)\"} - GyMMMd{\"GGGGyå¹´Mæœˆdæ—¥\"} - GyMd{\"GGGGyå¹´Mæœˆdæ—¥\"} + EEEEd{\"dã«ã¡EEEE\"} + Ed{\"dã«ã¡(E)\"} + Gy{\"GGGGyã­ã‚“\"} + GyMMM{\"GGGGyã­ã‚“MãŒã¤\"} + GyMMMEEEEd{\"GGGGyã­ã‚“MãŒã¤dã«ã¡EEEE\"} + GyMMMEd{\"GGGGyã­ã‚“MãŒã¤dã«ã¡(E)\"} + GyMMMd{\"GGGGyã­ã‚“MãŒã¤dã«ã¡\"} + GyMd{\"GGGGyã­ã‚“MãŒã¤dã«ã¡\"} H{\"Hæ™‚\"} Hm{\"H:mm\"} Hms{\"H:mm:ss\"} - M{\"Mæœˆ\"} + M{\"MãŒã¤\"} MEEEEd{\"M/dEEEE\"} MEd{\"M/d(E)\"} - MMM{\"Mæœˆ\"} - MMMEEEEd{\"Mæœˆdæ—¥EEEE\"} - MMMEd{\"Mæœˆdæ—¥(E)\"} - MMMMd{\"Mæœˆdæ—¥\"} - MMMd{\"Mæœˆdæ—¥\"} + MMM{\"MãŒã¤\"} + MMMEEEEd{\"MãŒã¤dã«ã¡EEEE\"} + MMMEd{\"MãŒã¤dã«ã¡(E)\"} + MMMMd{\"MãŒã¤dã«ã¡\"} + MMMd{\"MãŒã¤dã«ã¡\"} Md{\"M/d\"} - d{\"dæ—¥\"} + d{\"dã«ã¡\"} h{\"aKæ™‚\"} hm{\"aK:mm\"} hms{\"aK:mm:ss\"} ms{\"mm:ss\"} - y{\"GGGGyå¹´\"} - yyyy{\"GGGGyå¹´\"} - yyyyM{\"GGGGyå¹´Mæœˆ\"} - yyyyMEEEEd{\"GGGGyå¹´M/dEEEE\"} - yyyyMEd{\"GGGGyå¹´M/d(E)\"} + y{\"GGGGyã­ã‚“\"} + yyyy{\"GGGGyã­ã‚“\"} + yyyyM{\"GGGGyã­ã‚“MãŒã¤\"} + yyyyMEEEEd{\"GGGGyã­ã‚“M/dEEEE\"} + yyyyMEd{\"GGGGyã­ã‚“M/d(E)\"} yyyyMM{\"Gy/MM\"} - yyyyMMM{\"GGGGyå¹´Mæœˆ\"} - yyyyMMMEEEEd{\"GGGGyå¹´Mæœˆdæ—¥EEEE\"} - yyyyMMMEd{\"GGGGyå¹´Mæœˆdæ—¥(E)\"} - yyyyMMMM{\"GGGGyå¹´Mæœˆ\"} - yyyyMMMd{\"GGGGyå¹´Mæœˆdæ—¥\"} + yyyyMMM{\"GGGGyã­ã‚“MãŒã¤\"} + yyyyMMMEEEEd{\"GGGGyã­ã‚“MãŒã¤dã«ã¡EEEE\"} + yyyyMMMEd{\"GGGGyã­ã‚“MãŒã¤dã«ã¡(E)\"} + yyyyMMMM{\"GGGGyã­ã‚“MãŒã¤\"} + yyyyMMMd{\"GGGGyã­ã‚“MãŒã¤dã«ã¡\"} yyyyMd{\"Gy/M/d\"} } eras{ @@ -311,15 +311,15 @@ \"H:mm:ss\", \"H:mm\", { - \"Uå¹´MMMdæ—¥EEEE\", + \"Uã­ã‚“MMMdã«ã¡EEEE\", \"hanidec\", } { - \"Uå¹´MMMdæ—¥\", + \"Uã­ã‚“MMMdã«ã¡\", \"hanidec\", } { - \"Uå¹´MMMdæ—¥\", + \"Uã­ã‚“MMMdã«ã¡\", \"hanidec\", } \"U-M-d\", @@ -336,13 +336,13 @@ E{\"ccc\"} EBhm{\"BK:mm (E)\"} EBhms{\"BK:mm:ss (E)\"} - EEEEd{\"dæ—¥EEEE\"} - Ed{\"dæ—¥(E)\"} - Gy{\"Uå¹´\"} - GyMMM{\"Uå¹´MMM\"} - GyMMMEEEEd{\"Uå¹´MMMdæ—¥EEEE\"} - GyMMMEd{\"Uå¹´MMMdæ—¥(E)\"} - GyMMMd{\"Uå¹´MMMdæ—¥\"} + EEEEd{\"dã«ã¡EEEE\"} + Ed{\"dã«ã¡(E)\"} + Gy{\"Uã­ã‚“\"} + GyMMM{\"Uã­ã‚“MMM\"} + GyMMMEEEEd{\"Uã­ã‚“MMMdã«ã¡EEEE\"} + GyMMMEd{\"Uã­ã‚“MMMdã«ã¡(E)\"} + GyMMMd{\"Uã­ã‚“MMMdã«ã¡\"} H{\"Hæ™‚\"} Hm{\"H:mm\"} Hms{\"H:mm:ss\"} @@ -350,34 +350,34 @@ MEEEEd{\"M/dEEEE\"} MEd{\"M/d(E)\"} MMM{\"LLL\"} - MMMEEEEd{\"MMMdæ—¥EEEE\"} - MMMEd{\"MMMdæ—¥(E)\"} - MMMMd{\"MMMMdæ—¥\"} - MMMd{\"MMMdæ—¥\"} + MMMEEEEd{\"MMMdã«ã¡EEEE\"} + MMMEd{\"MMMdã«ã¡(E)\"} + MMMMd{\"MMMMdã«ã¡\"} + MMMd{\"MMMdã«ã¡\"} Md{\"M/d\"} - UM{\"Uå¹´Mæœˆ\"} - UMMM{\"Uå¹´MMM\"} - UMMMd{\"Uå¹´MMMdæ—¥\"} - UMd{\"Uå¹´Mæœˆdæ—¥\"} - d{\"dæ—¥\"} + UM{\"Uã­ã‚“MãŒã¤\"} + UMMM{\"Uã­ã‚“MMM\"} + UMMMd{\"Uã­ã‚“MMMdã«ã¡\"} + UMd{\"Uã­ã‚“MãŒã¤dã«ã¡\"} + d{\"dã«ã¡\"} h{\"aKæ™‚\"} hm{\"aK:mm\"} hms{\"aK:mm:ss\"} ms{\"mm:ss\"} - y{\"Uå¹´\"} - yMd{\"Uå¹´Mæœˆdæ—¥\"} - yyyy{\"Uå¹´\"} - yyyyM{\"Uå¹´Mæœˆ\"} - yyyyMEEEEd{\"Uå¹´Mæœˆdæ—¥EEEE\"} - yyyyMEd{\"Uå¹´Mæœˆdæ—¥(E)\"} - yyyyMMM{\"Uå¹´MMM\"} - yyyyMMMEEEEd{\"Uå¹´MMMdæ—¥EEEE\"} - yyyyMMMEd{\"Uå¹´MMMdæ—¥(E)\"} - yyyyMMMM{\"Uå¹´MMMM\"} - yyyyMMMd{\"Uå¹´MMMdæ—¥\"} - yyyyMd{\"Uå¹´Mæœˆdæ—¥\"} - yyyyQQQ{\"Uå¹´QQQ\"} - yyyyQQQQ{\"Uå¹´QQQQ\"} + y{\"Uã­ã‚“\"} + yMd{\"Uã­ã‚“MãŒã¤dã«ã¡\"} + yyyy{\"Uã­ã‚“\"} + yyyyM{\"Uã­ã‚“MãŒã¤\"} + yyyyMEEEEd{\"Uã­ã‚“MãŒã¤dã«ã¡EEEE\"} + yyyyMEd{\"Uã­ã‚“MãŒã¤dã«ã¡(E)\"} + yyyyMMM{\"Uã­ã‚“MMM\"} + yyyyMMMEEEEd{\"Uã­ã‚“MMMdã«ã¡EEEE\"} + yyyyMMMEd{\"Uã­ã‚“MMMdã«ã¡(E)\"} + yyyyMMMM{\"Uã­ã‚“MMMM\"} + yyyyMMMd{\"Uã­ã‚“MMMdã«ã¡\"} + yyyyMd{\"Uã­ã‚“MãŒã¤dã«ã¡\"} + yyyyQQQ{\"Uã­ã‚“QQQ\"} + yyyyQQQQ{\"Uã­ã‚“QQQQ\"} } cyclicNameSets{ dayParts{ @@ -529,7 +529,7 @@ H{\"Hæ™‚ï½Hæ™‚(v)\"} } M{ - M{\"Mæœˆï½Mæœˆ\"} + M{\"MãŒã¤ï½MãŒã¤\"} } MEd{ M{\"MM/dd(E)ï½MM/dd(E)\"} @@ -539,22 +539,22 @@ M{\"MMMï½MMM\"} } MMMEd{ - M{\"MMMdæ—¥(E)ï½MMMdæ—¥(E)\"} - d{\"MMMdæ—¥(E)ï½dæ—¥(E)\"} + M{\"MMMdã«ã¡(E)ï½MMMdã«ã¡(E)\"} + d{\"MMMdã«ã¡(E)ï½dã«ã¡(E)\"} } MMMM{ M{\"MMMMï½MMMM\"} } MMMd{ - M{\"MMMdæ—¥ï½MMMdæ—¥\"} - d{\"MMMdæ—¥ï½dæ—¥\"} + M{\"MMMdã«ã¡ï½MMMdã«ã¡\"} + d{\"MMMdã«ã¡ï½dã«ã¡\"} } Md{ M{\"MM/ddï½MM/dd\"} d{\"MM/ddï½MM/dd\"} } d{ - d{\"dæ—¥ï½dæ—¥\"} + d{\"dã«ã¡ï½dã«ã¡\"} } fallback{\"{0}ï½{1}\"} h{ @@ -576,7 +576,7 @@ h{\"aKæ™‚ï½Kæ™‚(v)\"} } y{ - y{\"Uå¹´ï½Uå¹´\"} + y{\"Uã­ã‚“ï½Uã­ã‚“\"} } yM{ M{\"U/MMï½U/MM\"} @@ -588,22 +588,22 @@ y{\"U/MM/dd(E)ï½U/MM/dd(E)\"} } yMMM{ - M{\"Uå¹´MMMï½MMM\"} - y{\"Uå¹´MMMï½Uå¹´MMM\"} + M{\"Uã­ã‚“MMMï½MMM\"} + y{\"Uã­ã‚“MMMï½Uã­ã‚“MMM\"} } yMMMEd{ - M{\"Uå¹´MMMdæ—¥(E)ï½MMMdæ—¥(E)\"} - d{\"Uå¹´MMMdæ—¥(E)ï½dæ—¥","date":"2024-11-06","objectID":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/:3:7","tags":["å®æˆ˜","blog","Framework"],"title":"å¢åŠ è¯­è¨€æ–¹æ¡ˆ","uri":"/posts/%E5%A2%9E%E5%8A%A0%E8%AF%AD%E8%A8%80%E6%96%B9%E6%A1%88/#å¹´æœˆæ—¥ç¿»è¯‘"},{"categories":null,"collections":["é˜…è¯»ç›®å½•"],"content":"æœ¬åšå®¢å†…å®¹ä¸»è¦é›†ä¸­åœ¨ Android å¼€å‘å’Œä¼˜åŒ–ç›¸å…³çš„è¯é¢˜ï¼ŒåŒ…æ‹¬ä¸€äº›æ€§èƒ½å·¥å…·çš„ä½¿ç”¨ã€Android App ä¼˜åŒ–çŸ¥è¯†ã€Android Framework çŸ¥è¯†è®²è§£ï¼Œæ€§èƒ½ç†è®ºçŸ¥è¯†è®²è§£ç­‰ï¼Œè¿™é‡Œæ•´ç†äº†ä¸€ä»½ç›®å½•ä¾›å¤§å®¶å‚è€ƒï¼Œå¤§å®¶å¯ä»¥æŒ‘æ„Ÿå…´è¶£çš„éƒ¨åˆ†æ¥çœ‹ã€‚è¿™é‡Œä¸ä»…ä»…åŒ…å«åšå®¢ä¸­çš„å†…å®¹ï¼Œä¸€äº›æˆ‘åœ¨ çŸ¥ä¹ æˆ–è€… çŸ¥è¯†æ˜Ÿçƒ - The Performance çš„å›ç­”ä¹Ÿä¼šæ”¾åˆ°è¿™é‡Œï¼Œä¸è¿‡è¿™ä¸ªç›®å½•é‡Œé¢æ”¾çš„éƒ½æ˜¯æˆ‘åŸåˆ›çš„åšå®¢ï¼Œå¦å¤–è¿˜æ”¶é›†äº†ä¸€äº›ä¼˜ç§€æ–‡ç« ï¼Œæˆ‘ä¹Ÿä¼šä¸å®šæœŸæ›´æ–° Android æ€§èƒ½ä¼˜åŒ–å¿…çŸ¥å¿…ä¼šã€‚ åšå®¢çš„æ¯æ¬¡æ›´æ–°éƒ½ä¼šæ›´æ–°è¿™ç¯‡ç›®å½•ï¼Œæ–¹ä¾¿å¤§å®¶æŸ¥é˜…ã€‚æˆ‘ä¼šå°½é‡ä¿è¯æ¯å‘¨ä¸€æ›´ï¼Œå­¦æ— æ­¢å¢ƒï¼Œä¸å¤§å®¶å…±å‹‰ï¼Œæœ‰ä»€ä¹ˆæƒ³äº†è§£çš„æˆ–è€…åšå®¢ä¸­ä¸è¶³çš„åœ°æ–¹ï¼Œè¯·å¤§å®¶åœ¨åšå®¢æˆ–è€…çŸ¥ä¹ã€å¾®åšã€å¾®ä¿¡ç•™è¨€ç»™æˆ‘ï¼Œæˆ‘ä¼šç§¯ææ”¹æ­£ã€‚ ","date":"2024-11-06","objectID":"/posts/%E7%BD%AE%E9%A1%B6%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"ã€Œç½®é¡¶ã€åšå®¢æ–‡ç« ç›®å½•","uri":"/posts/%E7%BD%AE%E9%A1%B6%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95/#"},{"categories":null,"collections":["é˜…è¯»ç›®å½•"],"content":"ç†è®ºçŸ¥è¯† Android æ€§èƒ½ä¼˜åŒ–çš„æœ¯ã€é“ã€å™¨ The Performance çŸ¥è¯†æ˜Ÿçƒç®€ä»‹ The Performance æ˜ŸçƒèŒ¶è¯ä¼š - ç¬¬ä¸€æœŸ OS è®¾è®¡ä¹‹æ€§èƒ½è®¾è®¡ ","date":"2024-11-06","objectID":"/posts/%E7%BD%AE%E9%A1%B6%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"ã€Œç½®é¡¶ã€åšå®¢æ–‡ç« ç›®å½•","uri":"/posts/%E7%BD%AE%E9%A1%B6%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95/#ç†è®ºçŸ¥è¯†"},{"categories":null,"collections":["é˜…è¯»ç›®å½•"],"content":"Perfetto ç³»åˆ— Perfetto ç³»åˆ—ç›®å½• Android Perfetto ç³»åˆ— 1ï¼šPerfetto å·¥å…·ç®€ä»‹ Android Perfetto ç³»åˆ— 2ï¼šPerfetto Trace æŠ“å– Android Perfetto ç³»åˆ— 3ï¼šç†Ÿæ‚‰ Perfetto View ","date":"2024-11-06","objectID":"/posts/%E7%BD%AE%E9%A1%B6%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"ã€Œç½®é¡¶ã€åšå®¢æ–‡ç« ç›®å½•","uri":"/posts/%E7%BD%AE%E9%A1%B6%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95/#perfetto-ç³»åˆ—"},{"categories":null,"collections":["é˜…è¯»ç›®å½•"],"content":"Systrace ç³»åˆ— Systrace å·¥å…·æ˜¯åˆ†æ Android æ€§èƒ½é—®é¢˜çš„åˆ©å™¨ï¼Œå®ƒå¯ä»¥ä»ä¸€ä¸ªå›¾å½¢çš„è§’åº¦ï¼Œæ¥å±•ç°æ•´æœºçš„è¿è¡Œæƒ…å†µã€‚Systrace å·¥å…·ä¸ä»…å¯ä»¥åˆ†ææ€§èƒ½é—®é¢˜ï¼Œç”¨å®ƒæ¥è¿›è¡Œ Framework çš„å­¦ä¹ ä¹Ÿæ˜¯å¾ˆå¥½çš„ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘å†™æœ¬ç³»åˆ—æ–‡ç« çš„ä¸€ä¸ªåŸå›  Systrace ç®€ä»‹ Systrace åŸºç¡€çŸ¥è¯† - Systrace é¢„å¤‡çŸ¥è¯† Systrace åŸºç¡€çŸ¥è¯† - Why 60 fps ï¼Ÿ Systrace åŸºç¡€çŸ¥è¯† - SystemServer è§£è¯» Systrace åŸºç¡€çŸ¥è¯† - Input è§£è¯» Systrace åŸºç¡€çŸ¥è¯† - Vsync äº§ç”Ÿä¸å·¥ä½œæœºåˆ¶è§£è¯» Systrace åŸºç¡€çŸ¥è¯† - Vsync-App ï¼šåŸºäº Choreographer çš„æ¸²æŸ“æœºåˆ¶è¯¦è§£ Systrace åŸºç¡€çŸ¥è¯† - MainThread å’Œ RenderThread è§£è¯» Systrace åŸºç¡€çŸ¥è¯† - Binder å’Œé”ç«äº‰è§£è¯» Systrace åŸºç¡€çŸ¥è¯† - Triple Buffer è§£è¯» Systrace åŸºç¡€çŸ¥è¯† - CPU Info è§£è¯» Systrace åŸºç¡€çŸ¥è¯† - SystemServer è§£è¯» Systrace åŸºç¡€çŸ¥è¯† - SurfaceFlinger è§£è¯» Systrace æµç•…æ€§å®æˆ˜ 1 ï¼šäº†è§£å¡é¡¿åŸç† Systrace æµç•…æ€§å®æˆ˜ 2 ï¼šæ¡ˆä¾‹åˆ†æ: MIUI æ¡Œé¢æ»‘åŠ¨å¡é¡¿åˆ†æ Systrace æµç•…æ€§å®æˆ˜ 3 ï¼šå¡é¡¿åˆ†æè¿‡ç¨‹ä¸­çš„ä¸€äº›ç–‘é—® Systrace å“åº”é€Ÿåº¦å®æˆ˜ 1 ï¼šäº†è§£å“åº”é€Ÿåº¦åŸç† Systrace å“åº”é€Ÿåº¦å®æˆ˜ 2 ï¼šå“åº”é€Ÿåº¦å®æˆ˜åˆ†æ-ä»¥å¯åŠ¨é€Ÿåº¦ä¸ºä¾‹ Systrace å“åº”é€Ÿåº¦å®æˆ˜ 3 ï¼šå“åº”é€Ÿåº¦å»¶ä¼¸çŸ¥è¯† Systrace çº¿ç¨‹ CPU è¿è¡ŒçŠ¶æ€åˆ†ææŠ€å·§ - Runnable ç¯‡ Systrace çº¿ç¨‹ CPU è¿è¡ŒçŠ¶æ€åˆ†ææŠ€å·§ - Running ç¯‡ Systrace çº¿ç¨‹ CPU è¿è¡ŒçŠ¶æ€åˆ†ææŠ€å·§ - Sleep å’Œ Uninterruptible Sleep ç¯‡ ","date":"2024-11-06","objectID":"/posts/%E7%BD%AE%E9%A1%B6%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95/:3:0","tags":["clippings","è½¬è½½","blog"],"title":"ã€Œç½®é¡¶ã€åšå®¢æ–‡ç« ç›®å½•","uri":"/posts/%E7%BD%AE%E9%A1%B6%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95/#systrace-ç³»åˆ—"},{"categories":null,"collections":["é˜…è¯»ç›®å½•"],"content":"æµç•…æ€§ æµç•…æ€§ä¸»è¦æŒ‡çš„æ˜¯å¡é¡¿ã€æ‰å¸§ï¼Œå¯¹åº”çš„è‹±æ–‡æ˜¯ Smooth vs Jank Android ä¸­çš„å¡é¡¿ä¸¢å¸§åŸå› æ¦‚è¿° - æ–¹æ³•è®º Android ä¸­çš„å¡é¡¿ä¸¢å¸§åŸå› æ¦‚è¿° - ç³»ç»Ÿç¯‡ Android ä¸­çš„å¡é¡¿ä¸¢å¸§åŸå› æ¦‚è¿° - åº”ç”¨ç¯‡ Android ä¸­çš„å¡é¡¿ä¸¢å¸§åŸå› æ¦‚è¿° - ä½å†…å­˜ç¯‡ å…³äº Android ç³»ç»Ÿæµç•…æ€§çš„ä¸€äº›æ€è€ƒ æ–°çš„æµç•…ä½“éªŒï¼Œ90Hz æ¼«è°ˆ Androidæ€§èƒ½ä¼˜åŒ–ä¹‹è¿‡æ¸¡ç»˜åˆ¶(ä¸€) Androidæ€§èƒ½ä¼˜åŒ–ä¹‹è¿‡æ¸¡ç»˜åˆ¶( äºŒ) Androidæ€§èƒ½ä¼˜åŒ–åç»­ åä¸ºæ‰‹æœºåˆ·å¾®åšä½“éªŒæ›´å¥½ï¼ŸæŠ€æœ¯è§’åº¦çš„ä¸€äº›åˆ†æå’Œæ€è€ƒ ","date":"2024-11-06","objectID":"/posts/%E7%BD%AE%E9%A1%B6%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95/:4:0","tags":["clippings","è½¬è½½","blog"],"title":"ã€Œç½®é¡¶ã€åšå®¢æ–‡ç« ç›®å½•","uri":"/posts/%E7%BD%AE%E9%A1%B6%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95/#æµç•…æ€§"},{"categories":null,"collections":["é˜…è¯»ç›®å½•"],"content":"å“åº”é€Ÿåº¦ å“åº”é€Ÿåº¦ä¸»è¦æŒ‡çš„æ˜¯ App å†·çƒ­å¯åŠ¨ã€ç•Œé¢è·³è½¬é€Ÿåº¦ã€äº®ç­å±é€Ÿåº¦ç­‰ï¼Œå¯¹åº”çš„è‹±æ–‡æ˜¯ Fast vs Slow Android App å¯åŠ¨ä¼˜åŒ–å…¨è®°å½• çŸ¥ä¹ æ•‘æ•‘ä½ çš„ StartingWindow Android ä¸­å¦‚ä½•è®¡ç®— App çš„å¯åŠ¨æ—¶é—´ï¼Ÿ Android åº”ç”¨å¯åŠ¨ä¼˜åŒ–:ä¸€ç§ DelayLoad çš„å®ç°å’ŒåŸç†(ä¸Šç¯‡) Android åº”ç”¨å¯åŠ¨ä¼˜åŒ–:ä¸€ç§ DelayLoad çš„å®ç°å’ŒåŸç†(ä¸‹ç¯‡) ","date":"2024-11-06","objectID":"/posts/%E7%BD%AE%E9%A1%B6%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95/:5:0","tags":["clippings","è½¬è½½","blog"],"title":"ã€Œç½®é¡¶ã€åšå®¢æ–‡ç« ç›®å½•","uri":"/posts/%E7%BD%AE%E9%A1%B6%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95/#å“åº”é€Ÿåº¦"},{"categories":null,"collections":["é˜…è¯»ç›®å½•"],"content":"å†…å­˜ ä¸»è¦è®°å½• Android å†…å­˜ä¼˜åŒ–ç›¸å…³çš„çŸ¥è¯†å’Œå·¥å…·ï¼Œä»¥åŠå¯¹ç³»ç»Ÿçš„å½±å“ Android ä¸­ä½å†…å­˜å¯¹æ€§èƒ½çš„å½±å“ Android ç³»ç»Ÿä¸é‡Šæ”¾å†…å­˜å—ï¼Ÿ Android ä»£ç å†…å­˜ä¼˜åŒ–å»ºè®®-Android èµ„æºç¯‡ Android ä»£ç å†…å­˜ä¼˜åŒ–å»ºè®®-Android å®˜æ–¹ç¯‡ Android ä»£ç å†…å­˜ä¼˜åŒ–å»ºè®®-Java å®˜æ–¹ç¯‡ Android å†…å­˜ä¼˜åŒ–ä¹‹ä¸€ï¼šMAT ä½¿ç”¨å…¥é—¨ Androidå†…å­˜ä¼˜åŒ–ä¹‹äºŒï¼šMATä½¿ç”¨è¿›é˜¶ Androidå†…å­˜ä¼˜åŒ–ä¹‹ä¸‰ï¼šæ‰“å¼€MATä¸­çš„BitmapåŸå›¾ ","date":"2024-11-06","objectID":"/posts/%E7%BD%AE%E9%A1%B6%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95/:6:0","tags":["clippings","è½¬è½½","blog"],"title":"ã€Œç½®é¡¶ã€åšå®¢æ–‡ç« ç›®å½•","uri":"/posts/%E7%BD%AE%E9%A1%B6%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95/#å†…å­˜"},{"categories":null,"collections":["é˜…è¯»ç›®å½•"],"content":"Framework çŸ¥è¯† åšå®¢ä¸­ Framework ç›¸å…³çš„å†…å®¹ä¼šé›†ä¸­åœ¨è¿™é‡Œï¼ŒåŒ…æ‹¬ä¸€äº› Framework çš„è¿è¡ŒåŸç†ã€Framework é—®é¢˜çš„è§£é¢˜æ€è·¯ã€Framework ä¼˜åŒ–æ–¹æ³•ç­‰ å½“ App æœ‰äº†ç³»ç»Ÿæƒé™ï¼ŒçœŸçš„å¯ä»¥ä¸ºæ‰€æ¬²ä¸ºï¼Ÿ Android ä¸­çš„â€œåå°æ— æ•ˆåŠ¨ç”»â€œè¡Œä¸ºåˆ†æ Android æ¡†æ¶é—®é¢˜åˆ†ææ¡ˆä¾‹ - è°æ€äº†æ¡Œé¢? Android ä¸­çš„ Activity Launch Mode è¯¦è§£ Android ä¸­çš„ Hardware Layer è¯¦è§£ Android å¹³å°åº”ç”¨å®å’Œè®¯é£è¾“å…¥æ³•æ— éšœç¢æœåŠ¡å¯¼è‡´çš„å…¨å±€å¡é¡¿åˆ†æ ä»ç”¨æˆ·è§’åº¦æ¥ç†è§£ Android åº”ç”¨çš„çŠ¶æ€ Android hwui ä¸­ RenderThread å·¥ä½œæµç¨‹ HashMap æºç åˆ†æ ç»†è¯´Javaå•ä¾‹æ¨¡å¼ Android ç³»ç»Ÿå¼€å‘æºç ç¯å¢ƒæ­å»º Android App é“¾å¼å”¤é†’åˆ†æ ä¸€ä¸ªã€Œé—°ã€å­—å¼•å‘çš„äº‹æ•… - ä¸‰æ˜Ÿç³»ç»Ÿé‡å¯åˆ†æ Android ç³»ç»Ÿå¼€å‘ç³»åˆ—ï¼ˆ1ï¼‰ï¼šAndroid 12 æºä»£ç ä¸‹è½½ã€ç¼–è¯‘å’Œåˆ·æœº ","date":"2024-11-06","objectID":"/posts/%E7%BD%AE%E9%A1%B6%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95/:7:0","tags":["clippings","è½¬è½½","blog"],"title":"ã€Œç½®é¡¶ã€åšå®¢æ–‡ç« ç›®å½•","uri":"/posts/%E7%BD%AE%E9%A1%B6%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95/#framework-çŸ¥è¯†"},{"categories":null,"collections":["é˜…è¯»ç›®å½•"],"content":"App å¼€å‘ è¿™é‡Œä¸»è¦è®°å½•ä¸€äº› App å¼€å‘ç›¸å…³çš„åšæ–‡ï¼Œç”±äºå†™çš„æ¯”è¾ƒæ—©ï¼Œå¤§å®¶éšä¾¿çœ‹ä¸€ä¸‹å°±å¯ä»¥äº† Android Bottom navigation è§„èŒƒä¸€ï¼šä½¿ç”¨æ–¹æ³• Android Bottom navigation è§„èŒƒäºŒï¼šæ ·å¼ã€è¡Œä¸ºä¸è§„æ ¼ Android Serviceï¼šå¼€å‘è‡ªå·±çš„é€šçŸ¥ä¸­å¿ƒ(1):è¾…åŠ©æ€§æœåŠ¡ä»‹ç» Android Serviceï¼šå¼€å‘è‡ªå·±çš„é€šçŸ¥ä¸­å¿ƒ(2):è¾…åŠ©æ€§æœåŠ¡å®æˆ˜ Androidå¼€å‘:Log2Fileå·¥å…·ç±» Android:Ubuntuä¸‹æ‰§è¡ŒAdbå‘½ä»¤æ‰¾ä¸åˆ°è®¾å¤‡ Androidå°æŠ€å·§:å¦‚ä½•è®©EditTextä¸è‡ªåŠ¨è·å–ç„¦ç‚¹ ","date":"2024-11-06","objectID":"/posts/%E7%BD%AE%E9%A1%B6%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95/:8:0","tags":["clippings","è½¬è½½","blog"],"title":"ã€Œç½®é¡¶ã€åšå®¢æ–‡ç« ç›®å½•","uri":"/posts/%E7%BD%AE%E9%A1%B6%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95/#app-å¼€å‘"},{"categories":null,"collections":["é˜…è¯»ç›®å½•"],"content":"ä¸ªäººæ€»ç»“å’Œå¥½ç‰©æ¨è ä¸æŠ€æœ¯æ— å…³ï¼Œä½†æ˜¯å¯ä»¥æé«˜å¹¸ç¦æ„Ÿå’Œå·¥ä½œæ•ˆç‡ 2023 å¹´çš„æ–¹æ–¹é¢é¢ å›é¡¾ 2021 æˆ‘æ˜¯ Grackerï¼Œè¿™æ˜¯æˆ‘çš„åˆ©å™¨ Gracker çš„ 2018 å¹´åº¦æœ€æ¨è - ç»™è¾›å‹¤å·¥ä½œçš„è‡ªå·±ä¸€ç‚¹å¥–åŠ± é™†å¥‡ï¼šé™¤äº†å¥½ä»£ç ï¼Œå·¥ç¨‹å¸ˆæ€æ ·æ‰ç®—ä¼˜ç§€ï¼Ÿ 2017 å¹´åº¦æœ€æ¨è - ç»™è¾›å‹¤å·¥ä½œçš„è‡ªå·±ä¸€ç‚¹å¥–åŠ± å…³äº 2017 Android å¼€å‘è€…å­¦ä¹ è·¯çº¿(2020 ç‰ˆæœ¬) æˆ‘çš„ 2020 å¹´è¯»ä¹¦å• ","date":"2024-11-06","objectID":"/posts/%E7%BD%AE%E9%A1%B6%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95/:9:0","tags":["clippings","è½¬è½½","blog"],"title":"ã€Œç½®é¡¶ã€åšå®¢æ–‡ç« ç›®å½•","uri":"/posts/%E7%BD%AE%E9%A1%B6%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95/#ä¸ªäººæ€»ç»“å’Œå¥½ç‰©æ¨è"},{"categories":null,"collections":["é˜…è¯»ç›®å½•"],"content":"è¯»ä¹¦ç¬”è®° ä¸€æœ¬è®² Android æµç•…æ€§çš„ä¹¦ï¼Œåº”è¯¥æœ‰ä»€ä¹ˆå†…å®¹ï¼Ÿ ç¨‹åºå‘˜çš„ä¿®ç‚¼-01ï¼šç»åœ°åå‡»ä¹‹æœ¯ ç¨‹åºå‘˜çš„ä¿®ç‚¼-02ï¼šç¼–ç¨‹ä¹‹é“ ç¨‹åºå‘˜çš„ä¿®ç‚¼-03ï¼šWeb è®¾è®¡åŸåˆ™ ç¨‹åºå‘˜çš„ä¿®ç‚¼-04ï¼šå…³äºæµ‹è¯•çš„ä¸€äº›æ€è€ƒ ç¨‹åºå‘˜çš„ä¿®ç‚¼-05ï¼šäº†è§£ä½ çš„ç”¨æˆ· ç¨‹åºå‘˜çš„ä¿®ç‚¼-06ï¼šäº’è”ç½‘é‚£äº›äº‹ ç¨‹åºå‘˜çš„ä¿®ç‚¼-07ï¼šæ¸¸æˆä¸ç¼–ç¨‹ ç¨‹åºå‘˜çš„ä¿®ç‚¼-08ï¼šé˜…è¯»ä¹‹ç¾ ","date":"2024-11-06","objectID":"/posts/%E7%BD%AE%E9%A1%B6%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95/:10:0","tags":["clippings","è½¬è½½","blog"],"title":"ã€Œç½®é¡¶ã€åšå®¢æ–‡ç« ç›®å½•","uri":"/posts/%E7%BD%AE%E9%A1%B6%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95/#è¯»ä¹¦ç¬”è®°"},{"categories":null,"collections":["é˜…è¯»ç›®å½•"],"content":"æ€§èƒ½ä¼˜åŒ–å…¸èŒƒå’Œ Tips æ€§èƒ½ä¼˜åŒ–å…¸èŒƒæ˜¯ Google å‡ºå“çš„ä¸€ç³»åˆ—æ€§èƒ½ç›¸å…³çš„çŸ­è§†é¢‘ï¼Œæ€»å…±å‡ºäº† 6 å­£ï¼Œä¹‹å‰æƒ³çš„æ˜¯æ¯ä¸€é›†éƒ½æ¥ä¸€ä¸ªæ–‡ç« é…åˆï¼Œåé¢å‘ç°ä¸æ˜¯å¾ˆç°å®ï¼›Android Tips åˆ™æ˜¯ç¿»è¯‘çš„å¦å¤–ä¸€ä¸ªåšä¸»çš„æ–‡ç«  Androidæ€§èƒ½ä¼˜åŒ–å…¸èŒƒç»¼è¿° Androidæ€§èƒ½ä¼˜åŒ–å…¸èŒƒä¹‹Render Performance Androidæ€§èƒ½ä¼˜åŒ–å…¸èŒƒä¹‹Understanding Overdraw Androidæ€§èƒ½ä¼˜åŒ–å…¸èŒƒä¹‹Understanding VSYNC Androidæ€§èƒ½ä¼˜åŒ–å…¸èŒƒä¹‹Profile GPU Rendering Android Tips 1 Android Tips 2 Android Tips 3 Android Tips 4 Android Tips 5 ","date":"2024-11-06","objectID":"/posts/%E7%BD%AE%E9%A1%B6%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95/:11:0","tags":["clippings","è½¬è½½","blog"],"title":"ã€Œç½®é¡¶ã€åšå®¢æ–‡ç« ç›®å½•","uri":"/posts/%E7%BD%AE%E9%A1%B6%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95/#æ€§èƒ½ä¼˜åŒ–å…¸èŒƒå’Œ-tips"},{"categories":null,"collections":["é˜…è¯»ç›®å½•"],"content":"çŸ¥ä¹é—®ç­” çŸ¥ä¹ä¸“æ ä¼šæ¬è¿ä¸€éƒ¨åˆ†æ–‡ç« ï¼Œè¿™é‡Œåªè´´ä¸€äº›é«˜èµçš„å›ç­” ä¸ªäººçŸ¥ä¹ä¸»é¡µ ï¼Œæ¬¢è¿å¤§å®¶ç‚¹èµå…³æ³¨ å¦‚ä½•çœ‹å¾…å°ç±³éƒ¨åˆ†æœºå‹è¿è¡Œã€Šç‹è€…è£è€€ã€‹æ—¶ä¸¤ä¸ªå¤§æ ¸è¢«é” Flyme 5 ç›¸å¯¹äº Flyme 4 æµç•…å¾—è„±èƒæ¢éª¨ï¼Œå…¶ä¸­æ ¹æœ¬çš„å˜åŒ–æ˜¯ä»€ä¹ˆï¼Ÿ Android ç³»ç»Ÿä¸é‡Šæ”¾å†…å­˜å—ï¼Ÿ äº†è§£Androidçš„Frameworkå±‚å¯¹å·¥ä½œæœ‰ä»€ä¹ˆå¸®åŠ©å—ï¼Ÿ æ€ä¹ˆçœ‹å¾…ä¸‰æ˜Ÿå¤§é‡æ‰‹æœºåœ¨ä»Šå¤©ï¼ˆ5.23ï¼‰å‡Œæ™¨ç³»ç»Ÿå´©æºƒå¹¶æ•°æ®ä¸¢å¤±ï¼Ÿ ","date":"2024-11-06","objectID":"/posts/%E7%BD%AE%E9%A1%B6%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95/:12:0","tags":["clippings","è½¬è½½","blog"],"title":"ã€Œç½®é¡¶ã€åšå®¢æ–‡ç« ç›®å½•","uri":"/posts/%E7%BD%AE%E9%A1%B6%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95/#çŸ¥ä¹é—®ç­”"},{"categories":["Android","ubuntu"],"collections":null,"content":"æ–°ç‰ˆæœ¬çš„CTSå·¥å…·ï¼Œéœ€è¦è¿æ¥å¤–ç½‘æ‰èƒ½å¤Ÿæµ‹è¯•ï¼Œä»¥å¾€çš„ç‰ˆæœ¬æ˜¯ä¸éœ€è¦çš„ã€‚ æ ¹æ®å‡ºé”™logï¼Œå’Œæºç  Site Unreachable DISABLE_CLEARCUT_KEY å‡ºé”™log java.net.SocketTimeoutException: Connect timed out at java.base/sun.nio.ch.NioSocketImpl.timedFinishConnect(NioSocketImpl.java:546) at java.base/sun.nio.ch.NioSocketImpl.connect(NioSocketImpl.java:597) at java.base/java.net.SocksSocketImpl.connect(SocksSocketImpl.java:327) at java.base/java.net.Socket.connect(Socket.java:633) at java.base/sun.security.ssl.SSLSocketImpl.connect(SSLSocketImpl.java:304) at java.base/sun.net.NetworkClient.doConnect(NetworkClient.java:178) at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:532) at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:637) at java.base/sun.net.www.protocol.https.HttpsClient.\u003cinit\u003e(HttpsClient.java:266) at java.base/sun.net.www.protocol.https.HttpsClient.New(HttpsClient.java:380) at java.base/sun.net.www.protocol.https.AbstractDelegateHttpsURLConnection.getNewHttpClient(AbstractDelegateHttpsURLConnection.java:193) at java.base/sun.net.www.protocol.http.HttpURLConnection.plainConnect0(HttpURLConnection.java:1242) at java.base/sun.net.www.protocol.http.HttpURLConnection.plainConnect(HttpURLConnection.java:1128) at java.base/sun.net.www.protocol.https.AbstractDelegateHttpsURLConnection.connect(AbstractDelegateHttpsURLConnection.java:179) at java.base/sun.net.www.protocol.http.HttpURLConnection.getOutputStream0(HttpURLConnection.java:1430) at java.base/sun.net.www.protocol.http.HttpURLConnection.getOutputStream(HttpURLConnection.java:1401) at java.base/sun.net.www.protocol.https.HttpsURLConnectionImpl.getOutputStream(HttpsURLConnectionImpl.java:220) at com.android.tradefed.clearcut.ClearcutClient.sendToClearcut(ClearcutClient.java:344) at com.android.tradefed.clearcut.ClearcutClient.lambda$flushEvents$1(ClearcutClient.java:322) é—®é¢˜æºç ï¼š /** Client that allows reporting usage metrics to clearcut. */ public class ClearcutClient { public static final String DISABLE_CLEARCUT_KEY = \"DISABLE_CLEARCUT\"; /** Returns True if clearcut is disabled, False otherwise. */ @VisibleForTesting boolean isClearcutDisabled() { return \"1\".equals(System.getenv(DISABLE_CLEARCUT_KEY)); } /** * Create Client with customized posting URL and forcing whether it's internal or external user. */ @VisibleForTesting protected ClearcutClient(String url, String subToolName) { mDisabled = isClearcutDisabled(); // We still have to set the 'final' variable so go through the assignments before returning if (!mDisabled \u0026\u0026 isGoogleUser()) { mLogSource = INTERNAL_LOG_SOURCE; mUserType = UserType.GOOGLE; } else { mLogSource = EXTERNAL_LOG_SOURCE; mUserType = UserType.EXTERNAL; } if (url == null) { mUrl = CLEARCUT_PROD_URL; } else { mUrl = url; } mRunId = UUID.randomUUID().toString(); mExternalEventQueue = new ArrayList\u003c\u003e(); mSubToolName = subToolName; if (mDisabled) { return; } æ ¹æ®ä»£ç ï¼Œåœ¨æµ‹è¯•å‰ï¼Œéœ€è¦ export DISABLE_CLEARCUT_KEY=1 mHasServerSideConfig å‡ºé”™log Caused by: java.net.ConnectException: è¿æ¥è¶…æ—¶ at java.base/sun.nio.ch.Net.connect0(Native Method) at java.base/sun.nio.ch.Net.connect(Net.java:579) at java.base/sun.nio.ch.Net.connect(Net.java:568) at java.base/sun.nio.ch.NioSocketImpl.connect(NioSocketImpl.java:588) at java.base/java.net.SocksSocketImpl.connect(SocksSocketImpl.java:327) at java.base/java.net.Socket.connect(Socket.java:633) at java.base/sun.security.ssl.SSLSocketImpl.connect(SSLSocketImpl.java:304) at java.base/sun.security.ssl.BaseSSLSocketImpl.connect(BaseSSLSocketImpl.java:174) at java.base/sun.net.NetworkClient.doConnect(NetworkClient.java:183) at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:532) at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:637) at java.base/sun.net.www.protocol.https.HttpsClient.\u003cinit\u003e(HttpsClient.java:266) at java.base/sun.net.www.protocol.https.HttpsClient.New(HttpsClient.java:380) at java.base/sun.net.www.protocol.https.AbstractDelegateHttpsURLConnection.getNewHttpClient(AbstractDelegateHttpsURLConnection.java:193) at java.base/","date":"2024-11-06","objectID":"/posts/cts-%E5%9C%A8%E5%86%85%E7%BD%91%E6%9C%BA%E5%99%A8%E5%A6%82%E4%BD%95%E6%B5%8B%E8%AF%95/:0:0","tags":["blog","æµ‹è¯•å·¥å…·"],"title":"CTS åœ¨å†…ç½‘æœºå™¨å¦‚ä½•æµ‹è¯•","uri":"/posts/cts-%E5%9C%A8%E5%86%85%E7%BD%91%E6%9C%BA%E5%99%A8%E5%A6%82%E4%BD%95%E6%B5%8B%E8%AF%95/#"},{"categories":["Android","ubuntu"],"collections":null,"content":"æ–°ç‰ˆæœ¬çš„CTSå·¥å…·ï¼Œéœ€è¦è¿æ¥å¤–ç½‘æ‰èƒ½å¤Ÿæµ‹è¯•ï¼Œä»¥å¾€çš„ç‰ˆæœ¬æ˜¯ä¸éœ€è¦çš„ã€‚ æ ¹æ®å‡ºé”™logï¼Œå’Œæºç  Site Unreachable DISABLE_CLEARCUT_KEY å‡ºé”™log java.net.SocketTimeoutException: Connect timed out at java.base/sun.nio.ch.NioSocketImpl.timedFinishConnect(NioSocketImpl.java:546) at java.base/sun.nio.ch.NioSocketImpl.connect(NioSocketImpl.java:597) at java.base/java.net.SocksSocketImpl.connect(SocksSocketImpl.java:327) at java.base/java.net.Socket.connect(Socket.java:633) at java.base/sun.security.ssl.SSLSocketImpl.connect(SSLSocketImpl.java:304) at java.base/sun.net.NetworkClient.doConnect(NetworkClient.java:178) at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:532) at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:637) at java.base/sun.net.www.protocol.https.HttpsClient.(HttpsClient.java:266) at java.base/sun.net.www.protocol.https.HttpsClient.New(HttpsClient.java:380) at java.base/sun.net.www.protocol.https.AbstractDelegateHttpsURLConnection.getNewHttpClient(AbstractDelegateHttpsURLConnection.java:193) at java.base/sun.net.www.protocol.http.HttpURLConnection.plainConnect0(HttpURLConnection.java:1242) at java.base/sun.net.www.protocol.http.HttpURLConnection.plainConnect(HttpURLConnection.java:1128) at java.base/sun.net.www.protocol.https.AbstractDelegateHttpsURLConnection.connect(AbstractDelegateHttpsURLConnection.java:179) at java.base/sun.net.www.protocol.http.HttpURLConnection.getOutputStream0(HttpURLConnection.java:1430) at java.base/sun.net.www.protocol.http.HttpURLConnection.getOutputStream(HttpURLConnection.java:1401) at java.base/sun.net.www.protocol.https.HttpsURLConnectionImpl.getOutputStream(HttpsURLConnectionImpl.java:220) at com.android.tradefed.clearcut.ClearcutClient.sendToClearcut(ClearcutClient.java:344) at com.android.tradefed.clearcut.ClearcutClient.lambda$flushEvents$1(ClearcutClient.java:322) é—®é¢˜æºç ï¼š /** Client that allows reporting usage metrics to clearcut. */ public class ClearcutClient { public static final String DISABLE_CLEARCUT_KEY = \"DISABLE_CLEARCUT\"; /** Returns True if clearcut is disabled, False otherwise. */ @VisibleForTesting boolean isClearcutDisabled() { return \"1\".equals(System.getenv(DISABLE_CLEARCUT_KEY)); } /** * Create Client with customized posting URL and forcing whether it's internal or external user. */ @VisibleForTesting protected ClearcutClient(String url, String subToolName) { mDisabled = isClearcutDisabled(); // We still have to set the 'final' variable so go through the assignments before returning if (!mDisabled \u0026\u0026 isGoogleUser()) { mLogSource = INTERNAL_LOG_SOURCE; mUserType = UserType.GOOGLE; } else { mLogSource = EXTERNAL_LOG_SOURCE; mUserType = UserType.EXTERNAL; } if (url == null) { mUrl = CLEARCUT_PROD_URL; } else { mUrl = url; } mRunId = UUID.randomUUID().toString(); mExternalEventQueue = new ArrayList\u003c\u003e(); mSubToolName = subToolName; if (mDisabled) { return; } æ ¹æ®ä»£ç ï¼Œåœ¨æµ‹è¯•å‰ï¼Œéœ€è¦ export DISABLE_CLEARCUT_KEY=1 mHasServerSideConfig å‡ºé”™log Caused by: java.net.ConnectException: è¿æ¥è¶…æ—¶ at java.base/sun.nio.ch.Net.connect0(Native Method) at java.base/sun.nio.ch.Net.connect(Net.java:579) at java.base/sun.nio.ch.Net.connect(Net.java:568) at java.base/sun.nio.ch.NioSocketImpl.connect(NioSocketImpl.java:588) at java.base/java.net.SocksSocketImpl.connect(SocksSocketImpl.java:327) at java.base/java.net.Socket.connect(Socket.java:633) at java.base/sun.security.ssl.SSLSocketImpl.connect(SSLSocketImpl.java:304) at java.base/sun.security.ssl.BaseSSLSocketImpl.connect(BaseSSLSocketImpl.java:174) at java.base/sun.net.NetworkClient.doConnect(NetworkClient.java:183) at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:532) at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:637) at java.base/sun.net.www.protocol.https.HttpsClient.(HttpsClient.java:266) at java.base/sun.net.www.protocol.https.HttpsClient.New(HttpsClient.java:380) at java.base/sun.net.www.protocol.https.AbstractDelegateHttpsURLConnection.getNewHttpClient(AbstractDelegateHttpsURLConnection.java:193) at java.base/","date":"2024-11-06","objectID":"/posts/cts-%E5%9C%A8%E5%86%85%E7%BD%91%E6%9C%BA%E5%99%A8%E5%A6%82%E4%BD%95%E6%B5%8B%E8%AF%95/:0:0","tags":["blog","æµ‹è¯•å·¥å…·"],"title":"CTS åœ¨å†…ç½‘æœºå™¨å¦‚ä½•æµ‹è¯•","uri":"/posts/cts-%E5%9C%A8%E5%86%85%E7%BD%91%E6%9C%BA%E5%99%A8%E5%A6%82%E4%BD%95%E6%B5%8B%E8%AF%95/#disable_clearcut_key"},{"categories":["Android","ubuntu"],"collections":null,"content":"æ–°ç‰ˆæœ¬çš„CTSå·¥å…·ï¼Œéœ€è¦è¿æ¥å¤–ç½‘æ‰èƒ½å¤Ÿæµ‹è¯•ï¼Œä»¥å¾€çš„ç‰ˆæœ¬æ˜¯ä¸éœ€è¦çš„ã€‚ æ ¹æ®å‡ºé”™logï¼Œå’Œæºç  Site Unreachable DISABLE_CLEARCUT_KEY å‡ºé”™log java.net.SocketTimeoutException: Connect timed out at java.base/sun.nio.ch.NioSocketImpl.timedFinishConnect(NioSocketImpl.java:546) at java.base/sun.nio.ch.NioSocketImpl.connect(NioSocketImpl.java:597) at java.base/java.net.SocksSocketImpl.connect(SocksSocketImpl.java:327) at java.base/java.net.Socket.connect(Socket.java:633) at java.base/sun.security.ssl.SSLSocketImpl.connect(SSLSocketImpl.java:304) at java.base/sun.net.NetworkClient.doConnect(NetworkClient.java:178) at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:532) at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:637) at java.base/sun.net.www.protocol.https.HttpsClient.(HttpsClient.java:266) at java.base/sun.net.www.protocol.https.HttpsClient.New(HttpsClient.java:380) at java.base/sun.net.www.protocol.https.AbstractDelegateHttpsURLConnection.getNewHttpClient(AbstractDelegateHttpsURLConnection.java:193) at java.base/sun.net.www.protocol.http.HttpURLConnection.plainConnect0(HttpURLConnection.java:1242) at java.base/sun.net.www.protocol.http.HttpURLConnection.plainConnect(HttpURLConnection.java:1128) at java.base/sun.net.www.protocol.https.AbstractDelegateHttpsURLConnection.connect(AbstractDelegateHttpsURLConnection.java:179) at java.base/sun.net.www.protocol.http.HttpURLConnection.getOutputStream0(HttpURLConnection.java:1430) at java.base/sun.net.www.protocol.http.HttpURLConnection.getOutputStream(HttpURLConnection.java:1401) at java.base/sun.net.www.protocol.https.HttpsURLConnectionImpl.getOutputStream(HttpsURLConnectionImpl.java:220) at com.android.tradefed.clearcut.ClearcutClient.sendToClearcut(ClearcutClient.java:344) at com.android.tradefed.clearcut.ClearcutClient.lambda$flushEvents$1(ClearcutClient.java:322) é—®é¢˜æºç ï¼š /** Client that allows reporting usage metrics to clearcut. */ public class ClearcutClient { public static final String DISABLE_CLEARCUT_KEY = \"DISABLE_CLEARCUT\"; /** Returns True if clearcut is disabled, False otherwise. */ @VisibleForTesting boolean isClearcutDisabled() { return \"1\".equals(System.getenv(DISABLE_CLEARCUT_KEY)); } /** * Create Client with customized posting URL and forcing whether it's internal or external user. */ @VisibleForTesting protected ClearcutClient(String url, String subToolName) { mDisabled = isClearcutDisabled(); // We still have to set the 'final' variable so go through the assignments before returning if (!mDisabled \u0026\u0026 isGoogleUser()) { mLogSource = INTERNAL_LOG_SOURCE; mUserType = UserType.GOOGLE; } else { mLogSource = EXTERNAL_LOG_SOURCE; mUserType = UserType.EXTERNAL; } if (url == null) { mUrl = CLEARCUT_PROD_URL; } else { mUrl = url; } mRunId = UUID.randomUUID().toString(); mExternalEventQueue = new ArrayList\u003c\u003e(); mSubToolName = subToolName; if (mDisabled) { return; } æ ¹æ®ä»£ç ï¼Œåœ¨æµ‹è¯•å‰ï¼Œéœ€è¦ export DISABLE_CLEARCUT_KEY=1 mHasServerSideConfig å‡ºé”™log Caused by: java.net.ConnectException: è¿æ¥è¶…æ—¶ at java.base/sun.nio.ch.Net.connect0(Native Method) at java.base/sun.nio.ch.Net.connect(Net.java:579) at java.base/sun.nio.ch.Net.connect(Net.java:568) at java.base/sun.nio.ch.NioSocketImpl.connect(NioSocketImpl.java:588) at java.base/java.net.SocksSocketImpl.connect(SocksSocketImpl.java:327) at java.base/java.net.Socket.connect(Socket.java:633) at java.base/sun.security.ssl.SSLSocketImpl.connect(SSLSocketImpl.java:304) at java.base/sun.security.ssl.BaseSSLSocketImpl.connect(BaseSSLSocketImpl.java:174) at java.base/sun.net.NetworkClient.doConnect(NetworkClient.java:183) at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:532) at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:637) at java.base/sun.net.www.protocol.https.HttpsClient.(HttpsClient.java:266) at java.base/sun.net.www.protocol.https.HttpsClient.New(HttpsClient.java:380) at java.base/sun.net.www.protocol.https.AbstractDelegateHttpsURLConnection.getNewHttpClient(AbstractDelegateHttpsURLConnection.java:193) at java.base/","date":"2024-11-06","objectID":"/posts/cts-%E5%9C%A8%E5%86%85%E7%BD%91%E6%9C%BA%E5%99%A8%E5%A6%82%E4%BD%95%E6%B5%8B%E8%AF%95/:0:0","tags":["blog","æµ‹è¯•å·¥å…·"],"title":"CTS åœ¨å†…ç½‘æœºå™¨å¦‚ä½•æµ‹è¯•","uri":"/posts/cts-%E5%9C%A8%E5%86%85%E7%BD%91%E6%9C%BA%E5%99%A8%E5%A6%82%E4%BD%95%E6%B5%8B%E8%AF%95/#mhasserversideconfig"},{"categories":["Android","ubuntu"],"collections":null,"content":"æ–°ç‰ˆæœ¬çš„CTSå·¥å…·ï¼Œéœ€è¦è¿æ¥å¤–ç½‘æ‰èƒ½å¤Ÿæµ‹è¯•ï¼Œä»¥å¾€çš„ç‰ˆæœ¬æ˜¯ä¸éœ€è¦çš„ã€‚ æ ¹æ®å‡ºé”™logï¼Œå’Œæºç  Site Unreachable DISABLE_CLEARCUT_KEY å‡ºé”™log java.net.SocketTimeoutException: Connect timed out at java.base/sun.nio.ch.NioSocketImpl.timedFinishConnect(NioSocketImpl.java:546) at java.base/sun.nio.ch.NioSocketImpl.connect(NioSocketImpl.java:597) at java.base/java.net.SocksSocketImpl.connect(SocksSocketImpl.java:327) at java.base/java.net.Socket.connect(Socket.java:633) at java.base/sun.security.ssl.SSLSocketImpl.connect(SSLSocketImpl.java:304) at java.base/sun.net.NetworkClient.doConnect(NetworkClient.java:178) at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:532) at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:637) at java.base/sun.net.www.protocol.https.HttpsClient.(HttpsClient.java:266) at java.base/sun.net.www.protocol.https.HttpsClient.New(HttpsClient.java:380) at java.base/sun.net.www.protocol.https.AbstractDelegateHttpsURLConnection.getNewHttpClient(AbstractDelegateHttpsURLConnection.java:193) at java.base/sun.net.www.protocol.http.HttpURLConnection.plainConnect0(HttpURLConnection.java:1242) at java.base/sun.net.www.protocol.http.HttpURLConnection.plainConnect(HttpURLConnection.java:1128) at java.base/sun.net.www.protocol.https.AbstractDelegateHttpsURLConnection.connect(AbstractDelegateHttpsURLConnection.java:179) at java.base/sun.net.www.protocol.http.HttpURLConnection.getOutputStream0(HttpURLConnection.java:1430) at java.base/sun.net.www.protocol.http.HttpURLConnection.getOutputStream(HttpURLConnection.java:1401) at java.base/sun.net.www.protocol.https.HttpsURLConnectionImpl.getOutputStream(HttpsURLConnectionImpl.java:220) at com.android.tradefed.clearcut.ClearcutClient.sendToClearcut(ClearcutClient.java:344) at com.android.tradefed.clearcut.ClearcutClient.lambda$flushEvents$1(ClearcutClient.java:322) é—®é¢˜æºç ï¼š /** Client that allows reporting usage metrics to clearcut. */ public class ClearcutClient { public static final String DISABLE_CLEARCUT_KEY = \"DISABLE_CLEARCUT\"; /** Returns True if clearcut is disabled, False otherwise. */ @VisibleForTesting boolean isClearcutDisabled() { return \"1\".equals(System.getenv(DISABLE_CLEARCUT_KEY)); } /** * Create Client with customized posting URL and forcing whether it's internal or external user. */ @VisibleForTesting protected ClearcutClient(String url, String subToolName) { mDisabled = isClearcutDisabled(); // We still have to set the 'final' variable so go through the assignments before returning if (!mDisabled \u0026\u0026 isGoogleUser()) { mLogSource = INTERNAL_LOG_SOURCE; mUserType = UserType.GOOGLE; } else { mLogSource = EXTERNAL_LOG_SOURCE; mUserType = UserType.EXTERNAL; } if (url == null) { mUrl = CLEARCUT_PROD_URL; } else { mUrl = url; } mRunId = UUID.randomUUID().toString(); mExternalEventQueue = new ArrayList\u003c\u003e(); mSubToolName = subToolName; if (mDisabled) { return; } æ ¹æ®ä»£ç ï¼Œåœ¨æµ‹è¯•å‰ï¼Œéœ€è¦ export DISABLE_CLEARCUT_KEY=1 mHasServerSideConfig å‡ºé”™log Caused by: java.net.ConnectException: è¿æ¥è¶…æ—¶ at java.base/sun.nio.ch.Net.connect0(Native Method) at java.base/sun.nio.ch.Net.connect(Net.java:579) at java.base/sun.nio.ch.Net.connect(Net.java:568) at java.base/sun.nio.ch.NioSocketImpl.connect(NioSocketImpl.java:588) at java.base/java.net.SocksSocketImpl.connect(SocksSocketImpl.java:327) at java.base/java.net.Socket.connect(Socket.java:633) at java.base/sun.security.ssl.SSLSocketImpl.connect(SSLSocketImpl.java:304) at java.base/sun.security.ssl.BaseSSLSocketImpl.connect(BaseSSLSocketImpl.java:174) at java.base/sun.net.NetworkClient.doConnect(NetworkClient.java:183) at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:532) at java.base/sun.net.www.http.HttpClient.openServer(HttpClient.java:637) at java.base/sun.net.www.protocol.https.HttpsClient.(HttpsClient.java:266) at java.base/sun.net.www.protocol.https.HttpsClient.New(HttpsClient.java:380) at java.base/sun.net.www.protocol.https.AbstractDelegateHttpsURLConnection.getNewHttpClient(AbstractDelegateHttpsURLConnection.java:193) at java.base/","date":"2024-11-06","objectID":"/posts/cts-%E5%9C%A8%E5%86%85%E7%BD%91%E6%9C%BA%E5%99%A8%E5%A6%82%E4%BD%95%E6%B5%8B%E8%AF%95/:0:0","tags":["blog","æµ‹è¯•å·¥å…·"],"title":"CTS åœ¨å†…ç½‘æœºå™¨å¦‚ä½•æµ‹è¯•","uri":"/posts/cts-%E5%9C%A8%E5%86%85%E7%BD%91%E6%9C%BA%E5%99%A8%E5%A6%82%E4%BD%95%E6%B5%8B%E8%AF%95/#æ€»ç»“"},{"categories":["å­¦ä¹ æ€»ç»“"],"collections":["å¼€æœºå¯åŠ¨"],"content":"ã€Android Frameworkç³»åˆ—ã€‘ç¬¬3ç«  Zygoteè¿›ç¨‹ç›¸å…³_android zygoteè¿›ç¨‹-CSDNåšå®¢ 1 Zygoteç®€ä»‹ Zygoteæ˜¯Androidä¸­æœ€é‡è¦çš„ä¸€ä¸ªè¿›ç¨‹ï¼ŒZygoteè¿›ç¨‹å’ŒInitè¿›ç¨‹ã€SystemServerè¿›ç¨‹æ˜¯Androidæœ€é‡è¦çš„ä¸‰å¤§è¿›ç¨‹ã€‚Zygoteæ˜¯Androidç³»ç»Ÿåˆ›å»ºæ–°è¿›ç¨‹çš„æ ¸å¿ƒè¿›ç¨‹ï¼Œè´Ÿè´£å¯åŠ¨Dalvikè™šæ‹Ÿæœºï¼ŒåŠ è½½ä¸€äº›å¿…è¦çš„ç³»ç»Ÿèµ„æºå’Œç³»ç»Ÿç±»ï¼Œå¯åŠ¨system_serverè¿›ç¨‹ï¼Œéšåè¿›å…¥ç­‰å¾…å¤„ç†appåº”ç”¨è¯·æ±‚ã€‚ åœ¨Androidç³»ç»Ÿä¸­ï¼Œåº”ç”¨ç¨‹åºè¿›ç¨‹éƒ½æ˜¯ç”±Zygoteè¿›ç¨‹å­µåŒ–å‡ºæ¥çš„ï¼Œè€ŒZygoteè¿›ç¨‹æ˜¯ç”±Initè¿›ç¨‹å¯åŠ¨çš„ã€‚Zygoteè¿›ç¨‹åœ¨å¯åŠ¨æ—¶ä¼šåˆ›å»ºä¸€ä¸ªDalvikè™šæ‹Ÿæœºå®ä¾‹ï¼Œæ¯å½“å®ƒå­µåŒ–ä¸€ä¸ªæ–°çš„åº”ç”¨ç¨‹åºè¿›ç¨‹æ—¶ï¼Œéƒ½ä¼šå°†è¿™ä¸ªDalvikè™šæ‹Ÿæœºå®ä¾‹å¤åˆ¶åˆ°æ–°çš„åº”ç”¨ç¨‹åºè¿›ç¨‹é‡Œé¢å»ï¼Œä»è€Œä½¿å¾—æ¯ä¸€ä¸ªåº”ç”¨ç¨‹åºè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹çš„Dalvikè™šæ‹Ÿæœºå®ä¾‹ã€‚ Zygoteæ¶‰åŠçš„ç±»ï¼š frameworks/base/cmds/app_process/app_main.cpp frameworks/base/core/jni/AndroidRuntime.cpp frameworks/base/core/java/com/android/internal/os/ - Zygote.java - ZygoteInit.java - ZygoteServer.java - ZygoteConnection.java ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:1:0","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#1-zygoteç®€ä»‹"},{"categories":["å­¦ä¹ æ€»ç»“"],"collections":["å¼€æœºå¯åŠ¨"],"content":"2 Zygoteå¯åŠ¨ æœ¬æ–‡åŸºäºAndroid10ï¼ˆQï¼‰çš„æºç åšåˆ†æ ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:2:0","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#2-zygoteå¯åŠ¨"},{"categories":["å­¦ä¹ æ€»ç»“"],"collections":["å¼€æœºå¯åŠ¨"],"content":"2.1 initè¿›ç¨‹è§£æinit.rcè„šæœ¬ Zygoteç”±initè¿›ç¨‹è§£æinit.rcè„šæœ¬å¯åŠ¨çš„ã€‚è„šæœ¬ä¼ å…¥app_processçš„mainæ–¹æ³•åšåˆ†å‰²ï¼Œæ ¹æ®å­—ç¬¦ä¸²å‘½ä»¤åšç›¸åº”é€»è¾‘ã€‚ ç°åœ¨æœºå™¨åˆ†ä¸º32ä½å’Œ64ä½ï¼ŒZygoteçš„å¯åŠ¨è„šæœ¬init.rcä¹Ÿå„æœ‰åŒºåˆ«: init.zygote32.rcï¼šzygoteè¿›ç¨‹å¯¹åº”çš„æ‰§è¡Œç¨‹åºæ˜¯app_process(çº¯32bitæ¨¡å¼) init.zygote64.rcï¼šzygoteè¿›ç¨‹å¯¹åº”çš„æ‰§è¡Œç¨‹åºæ˜¯app_process64(çº¯64bitæ¨¡å¼) init.zygote32_64.rcï¼šå¯åŠ¨ä¸¤ä¸ªzygoteè¿›ç¨‹ï¼Œå¯¹åº”çš„æ‰§è¡Œç¨‹åºåˆ†åˆ«æ˜¯app_process32(ä¸»æ¨¡å¼)ã€app_process64 init.zygote64_32.rcï¼šå¯åŠ¨ä¸¤ä¸ªzygoteè¿›ç¨‹ï¼Œå¯¹åº”çš„æ‰§è¡Œç¨‹åºåˆ†åˆ«æ˜¯app_process64(ä¸»æ¨¡å¼)ã€app_process32 zygoteè¦æ‰§è¡Œçš„ç¨‹åºä¾¿æ˜¯system/bin/app_processï¼Œå®ƒçš„æºä»£ç åœ¨app_main.cppã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹app_mainæ˜¯å¦‚ä½•å¤„ç†è„šæœ¬å‘½ä»¤ï¼š frameworks/base/cmds/app_process/app_main.cpp 165 #if defined(__LP64__) 166 static const char ABI_LIST_PROPERTY[] = \"ro.product.cpu.abilist64\"; 167 static const char ZYGOTE_NICE_NAME[] = \"zygote64\"; 168 #else 169 static const char ABI_LIST_PROPERTY[] = \"ro.product.cpu.abilist32\"; 170 static const char ZYGOTE_NICE_NAME[] = \"zygote\"; 171 #endif 172 173 int main(int argc, char* const argv[]) 174 { ...... 256 // Parse runtime arguments. Stop at first unrecognized option. 257 bool zygote = false; 258 bool startSystemServer = false; 259 bool application = false; 260 String8 niceName; 261 String8 className; 262 263 ++i; // Skip unused \"parent dir\" argument. 264 while (i \u003c argc) { 265 const char* arg = argv[i++]; 266 if (strcmp(arg, \"--zygote\") == 0) { 267 zygote = true; 268 niceName = ZYGOTE_NICE_NAME; 269 } else if (strcmp(arg, \"--start-system-server\") == 0) { 270 startSystemServer = true; 271 } else if (strcmp(arg, \"--application\") == 0) { 272 application = true; 273 } else if (strncmp(arg, \"--nice-name=\", 12) == 0) { 274 niceName.setTo(arg + 12); 275 } else if (strncmp(arg, \"--\", 2) != 0) { 276 className.setTo(arg); 277 break; 278 } else { 279 --i; 280 break; 281 } 282 } ...... 309 if (startSystemServer) { 310 args.add(String8(\"start-system-server\")); 311 } ...... 331 if (!niceName.isEmpty()) { 332 runtime.setArgv0(niceName.string(), true /* setProcName */); 333 } 334 335 if (zygote) { 336 runtime.start(\"com.android.internal.os.ZygoteInit\", args, zygote); 337 } else if (className) { 338 runtime.start(\"com.android.internal.os.RuntimeInit\", args, zygote); 339 } else { 340 fprintf(stderr, \"Error: no class name or --zygote supplied.\\n\"); 341 app_usage(); 342 LOG_ALWAYS_FATAL(\"app_process: no class name or --zygote supplied.\"); 343 } 344 } æˆ‘ä»¬æ‹¿init.zygote64.rcä¸ºä¾‹ï¼š 1 service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server 2 class main 3 priority -20 4 user root 5 group root readproc reserved_disk 6 socket zygote stream 660 root system 7 socket usap_pool_primary stream 660 root system 8 onrestart write /sys/android_power/request_state wake 9 onrestart write /sys/power/state on 10 onrestart restart audioserver 11 onrestart restart cameraserver 12 onrestart restart media 13 onrestart restart netd 14 onrestart restart wificond 15 writepid /dev/cpuset/foreground/tasks ä¸»è¦æ˜¯è¿™ä¸ªè„šæœ¬å‘½ä»¤ï¼šservice zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server å®é™…ä¸Šä¼šè¢«åˆ†å‰²æˆï¼š serviceï¼šæœåŠ¡æ ‡è¯† zygoteï¼šè¡¨ç¤ºè¦å¼€å¯çš„æœåŠ¡åå­— /system/bin/app_process64ï¼šæœåŠ¡å¯¹åº”çš„è·¯å¾„ -Xzygoteï¼šä½œä¸ºè™šæ‹Ÿæœºå¯åŠ¨æ—¶æ‰€éœ€è¦çš„å‚æ•°,åœ¨AndroidRuntime.cppä¸­çš„ startVm() ä¸­è°ƒç”¨JNI_CreateJavaVM ä½¿ç”¨åˆ° /system/binï¼šä»£è¡¨è™šæ‹Ÿæœºç¨‹åºæ‰€åœ¨ç›®å½•,å› ä¸º app_process å¯ä»¥ä¸å’Œè™šæ‹Ÿæœºåœ¨ä¸€ä¸ªç›®å½•,æ‰€ä»¥ app_process éœ€è¦çŸ¥é“è™šæ‹Ÿæœºæ‰€åœ¨çš„ç›®å½• â€“zygote ï¼šæŒ‡æ˜ä»¥ ZygoteInit ç±»ä½œä¸ºå…¥å£,å¦åˆ™éœ€è¦æŒ‡å®šéœ€è¦æ‰§è¡Œçš„ç±»å â€“start-system-serverï¼šä»…åœ¨æœ‰ â€“zygote å‚æ•°æ—¶å¯ç”¨,å‘ŠçŸ¥ ZygoteInit å¯åŠ¨å®Œæ¯•åå­µåŒ–å‡ºçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹æ˜¯ SystemServer ç¬¬ä¸€ä¸ªifä¸­\"--zygote\"å‘½ä¸­ï¼Œzygoteå˜é‡ç½®ä¸ºtrueè¡¨ç¤ºè¦å¯åŠ¨zygoteè¿›ç¨‹ï¼Œå¹¶å°†è¿›ç¨‹åæ”¹æˆäº†zygoteæˆ–zygote64 ç¬¬äºŒä¸ªifä¸­\"--start-system-server\"å‘½ä¸­ï¼ŒstartSystemServerå˜é‡ç½®ä¸ºtrueè¡¨ç¤ºè¦å¯åŠ¨SystemServerè¿›ç¨‹ app_main.cppçš„mainæ–¹æ³•æ‰§è¡Œåï¼ŒZygoteInitå·²ç»é€šè¿‡runtime.start(\"com.android.internal.os.ZygoteInit\", args, zygote);è¢«å¯åŠ¨äº† ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:2:1","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#21-initè¿›ç¨‹è§£æinitrcè„šæœ¬"},{"categories":["å­¦ä¹ æ€»ç»“"],"collections":["å¼€æœºå¯åŠ¨"],"content":"2.2 AndroidRuntimeå¯åŠ¨ZygoteInit å…¶ä¸­runtimeå°±æ˜¯AndroidRuntimeç±»ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹AndroidRuntimeçš„startæ–¹æ³•ï¼š /frameworks/base/core/jni/AndroidRuntime.cpp 1112 java/* 1113 * Start the Android runtime. This involves starting the virtual machine 1114 * and calling the \"static void main(String[] args)\" method in the class 1115 * named by \"className\". 1116 * 1117 * Passes the main function two arguments, the class name and the specified 1118 * options string. 1119 */ 1120 void AndroidRuntime::start(const char* className, const Vector\u003cString8\u003e\u0026 options, bool zygote) 1121 { ...... 1164 /* start the virtual machine */ 1165 JniInvocation jni_invocation; 1166 jni_invocation.Init(NULL); 1167 JNIEnv* env; 1168 if (startVm(\u0026mJavaVM, \u0026env, zygote) != 0) { 1169 return; 1170 } 1171 onVmCreated(env); 1172 1173 /* 1174 * Register android functions. 1175 */ 1176 if (startReg(env) \u003c 0) { 1177 ALOGE(\"Unable to register all android natives\\n\"); 1178 return; 1179 } ...... 1203 1204 /* 1205 * Start VM. This thread becomes the main thread of the VM, and will 1206 * not return until the VM exits. 1207 */ 1208 char* slashClassName = toSlashClassName(className != NULL ? className : \"\"); 1209 jclass startClass = env-\u003eFindClass(slashClassName); 1210 if (startClass == NULL) { 1211 ALOGE(\"JavaVM unable to locate class '%s'\\n\", slashClassName); 1212 /* keep going */ 1213 } else { 1214 jmethodID startMeth = env-\u003eGetStaticMethodID(startClass, \"main\", 1215 \"([Ljava/lang/String;)V\"); 1216 if (startMeth == NULL) { 1217 ALOGE(\"JavaVM unable to find main() in '%s'\\n\", className); 1218 /* keep going */ 1219 } else { 1220 env-\u003eCallStaticVoidMethod(startClass, startMeth, strArray); 1226 } 1227 } ...... 1235 } å¯¹è™šæ‹Ÿæœºå’ŒJNIæ–¹æ³•çš„ä¸€äº›æ³¨å†Œåï¼Œé€šè¿‡CallStaticVoidMethodæ¥è°ƒç”¨ä¼ è¿‡æ¥çš„ç±»åçš„mainå‡½æ•°ï¼Œæˆ‘ä»¬ä¼ é€’è¿‡æ¥çš„ç±»åæ˜¯com.android.internal.os.ZygoteInit AndroidRuntimeä¸­ä¸»è¦åšäº†è¿™ä¸‰ä»¶äº‹ï¼š startVm() åˆ›å»ºè™šæ‹Ÿæœº startReg() åŠ¨æ€æ³¨å†Œ java è°ƒç”¨ native çš„ jni åå°„è°ƒç”¨ ZygoteInit çš„ main() ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:2:2","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#22-androidruntimeå¯åŠ¨zygoteinit"},{"categories":["å­¦ä¹ æ€»ç»“"],"collections":["å¼€æœºå¯åŠ¨"],"content":"2.3 ZygoteInitåˆå§‹åŒ– AndroidRuntimeåœ¨Nativeå±‚åˆ›å»ºäº†Zygoteï¼Œå¹¶ä¸”é€šè¿‡AndroidRuntime.start()ä»Nativeå±‚è½¬åˆ°Javaå±‚ZygoteInitçš„main()å…¥å£ï¼ŒZygoteInitçš„main()æ–¹æ³•æ˜¯Androidå¯åŠ¨çš„ç¬¬ä¸€ä¸ªJavaè¿›ç¨‹ä¸»æ–¹æ³• /frameworks/base/core/java/com/android/internal/os/ZygoteInit.java 818 @UnsupportedAppUsage 819 public static void main(String argv[]) { 820 ZygoteServer zygoteServer = null; ...... 833 Runnable caller; 834 try { ...... 847 boolean startSystemServer = false; 848 String zygoteSocketName = \"zygote\"; 849 String abiList = null; 850 boolean enableLazyPreload = false; 851 for (int i = 1; i \u003c argv.length; i++) { 852 if (\"start-system-server\".equals(argv[i])) { 853 startSystemServer = true; 854 } else if (\"--enable-lazy-preload\".equals(argv[i])) { 855 enableLazyPreload = true; 856 } else if (argv[i].startsWith(ABI_LIST_ARG)) { 857 abiList = argv[i].substring(ABI_LIST_ARG.length()); 858 } else if (argv[i].startsWith(SOCKET_NAME_ARG)) { 859 zygoteSocketName = argv[i].substring(SOCKET_NAME_ARG.length()); 860 } else { 861 throw new RuntimeException(\"Unknown command line argument: \" + argv[i]); 862 } 863 } 864 865 final boolean isPrimaryZygote = zygoteSocketName.equals(Zygote.PRIMARY_SOCKET_NAME); 866 867 if (abiList == null) { 868 throw new RuntimeException(\"No ABI list supplied.\"); 869 } 870 871 // In some configurations, we avoid preloading resources and classes eagerly. 872 // In such cases, we will preload things prior to our first fork. 873 if (!enableLazyPreload) { ...... 877 preload(bootTimingsTraceLog); ...... 881 } else { 882 Zygote.resetNicePriority(); 883 } ...... 896 Zygote.initNativeState(isPrimaryZygote); 897 898 ZygoteHooks.stopZygoteNoThreadCreation(); 899 900 zygoteServer = new ZygoteServer(isPrimaryZygote); 901 902 if (startSystemServer) { 903 Runnable r = forkSystemServer(abiList, zygoteSocketName, zygoteServer); 904 905 // {@code r == null} in the parent (zygote) process, and {@code r != null} in the 906 // child (system_server) process. 907 if (r != null) { 908 r.run(); 909 return; 910 } 911 } 912 913 Log.i(TAG, \"Accepting command socket connections\"); 914 915 // The select loop returns early in the child process after a fork and 916 // loops forever in the zygote. 917 caller = zygoteServer.runSelectLoop(abiList); 918 } catch (Throwable ex) { 919 Log.e(TAG, \"System zygote died with exception\", ex); 920 throw ex; 921 } finally { 922 if (zygoteServer != null) { 923 zygoteServer.closeServerSocket(); 924 } 925 } 926 927 // We're in the child process and have exited the select loop. Proceed to execute the 928 // command. 929 if (caller != null) { 930 caller.run(); 931 } 932 } ä¸»è¦åšäº†3ä»¶äº‹ï¼š preload()é¢„å…ˆåŠ è½½ç³»ç»Ÿèµ„æºï¼Œå¦‚ç³»ç»Ÿç±»ã€èµ„æºã€ç³»ç»Ÿå…±äº«åº“ç­‰ åˆ›å»º ZygoteServerï¼Œå…¶å®å°±æ˜¯ ServerSocket å¾ªç¯ç­‰å¾…é€šçŸ¥ fork å­è¿›ç¨‹ åˆ›å»º SystemServerè¿›ç¨‹ 2.3.1 preload() preload()ï¼šèµ„æºå‡†å¤‡ï¼ŒåŒ…æ‹¬ç±»åŠ è½½ï¼Œèµ„æºåŠ è½½ç­‰ 135 static void preload(TimingsTraceLog bootTimingsTraceLog) { 138 beginPreload(); 141 preloadClasses(); 144 cacheNonBootClasspathClassLoaders(); 147 preloadResources(); 150 nativePreloadAppProcessHALs(); 153 maybePreloadGraphicsDriver(); 155 preloadSharedLibraries(); 156 preloadTextResources(); 157 // Ask the WebViewFactory to do any initialization that must run in the zygote process, 158 // for memory sharing purposes. 159 WebViewFactory.prepareWebViewInZygote(); 160 endPreload(); 161 warmUpJcaProviders(); 164 sPreloadComplete = true; 165 } ...... 244 /** 245 * Performs Zygote process initialization. Loads and initializes commonly used classes. 246 * 247 * Most classes only cause a few hundred bytes to be allocated, but a few will allocate a dozen 248 * Kbytes (in one case, 500+K). 249 */ 250 private static void preloadClasses() { 251 final VMRuntime runtime = VMRuntime.getRuntime(); 252 253 InputStream is; 254 try { 255 is = new FileInputStream(PRELOADED_CLASSES); 256 } catch (FileNotFoundException e) { 257 Log.e(TAG, \"Couldn't find \" + PRELOADED_CLASSES + \".\"); 258 return; 259 } 260 261 Log.i(TAG, \"Preloading classes...\"); 262 long startTime = SystemClock.uptimeMillis(); 263 264 // Drop root perms while running static initializers. 265 final int ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:2:3","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#23-zygoteinitåˆå§‹åŒ–"},{"categories":["å­¦ä¹ æ€»ç»“"],"collections":["å¼€æœºå¯åŠ¨"],"content":"2.3 ZygoteInitåˆå§‹åŒ– AndroidRuntimeåœ¨Nativeå±‚åˆ›å»ºäº†Zygoteï¼Œå¹¶ä¸”é€šè¿‡AndroidRuntime.start()ä»Nativeå±‚è½¬åˆ°Javaå±‚ZygoteInitçš„main()å…¥å£ï¼ŒZygoteInitçš„main()æ–¹æ³•æ˜¯Androidå¯åŠ¨çš„ç¬¬ä¸€ä¸ªJavaè¿›ç¨‹ä¸»æ–¹æ³• /frameworks/base/core/java/com/android/internal/os/ZygoteInit.java 818 @UnsupportedAppUsage 819 public static void main(String argv[]) { 820 ZygoteServer zygoteServer = null; ...... 833 Runnable caller; 834 try { ...... 847 boolean startSystemServer = false; 848 String zygoteSocketName = \"zygote\"; 849 String abiList = null; 850 boolean enableLazyPreload = false; 851 for (int i = 1; i \u003c argv.length; i++) { 852 if (\"start-system-server\".equals(argv[i])) { 853 startSystemServer = true; 854 } else if (\"--enable-lazy-preload\".equals(argv[i])) { 855 enableLazyPreload = true; 856 } else if (argv[i].startsWith(ABI_LIST_ARG)) { 857 abiList = argv[i].substring(ABI_LIST_ARG.length()); 858 } else if (argv[i].startsWith(SOCKET_NAME_ARG)) { 859 zygoteSocketName = argv[i].substring(SOCKET_NAME_ARG.length()); 860 } else { 861 throw new RuntimeException(\"Unknown command line argument: \" + argv[i]); 862 } 863 } 864 865 final boolean isPrimaryZygote = zygoteSocketName.equals(Zygote.PRIMARY_SOCKET_NAME); 866 867 if (abiList == null) { 868 throw new RuntimeException(\"No ABI list supplied.\"); 869 } 870 871 // In some configurations, we avoid preloading resources and classes eagerly. 872 // In such cases, we will preload things prior to our first fork. 873 if (!enableLazyPreload) { ...... 877 preload(bootTimingsTraceLog); ...... 881 } else { 882 Zygote.resetNicePriority(); 883 } ...... 896 Zygote.initNativeState(isPrimaryZygote); 897 898 ZygoteHooks.stopZygoteNoThreadCreation(); 899 900 zygoteServer = new ZygoteServer(isPrimaryZygote); 901 902 if (startSystemServer) { 903 Runnable r = forkSystemServer(abiList, zygoteSocketName, zygoteServer); 904 905 // {@code r == null} in the parent (zygote) process, and {@code r != null} in the 906 // child (system_server) process. 907 if (r != null) { 908 r.run(); 909 return; 910 } 911 } 912 913 Log.i(TAG, \"Accepting command socket connections\"); 914 915 // The select loop returns early in the child process after a fork and 916 // loops forever in the zygote. 917 caller = zygoteServer.runSelectLoop(abiList); 918 } catch (Throwable ex) { 919 Log.e(TAG, \"System zygote died with exception\", ex); 920 throw ex; 921 } finally { 922 if (zygoteServer != null) { 923 zygoteServer.closeServerSocket(); 924 } 925 } 926 927 // We're in the child process and have exited the select loop. Proceed to execute the 928 // command. 929 if (caller != null) { 930 caller.run(); 931 } 932 } ä¸»è¦åšäº†3ä»¶äº‹ï¼š preload()é¢„å…ˆåŠ è½½ç³»ç»Ÿèµ„æºï¼Œå¦‚ç³»ç»Ÿç±»ã€èµ„æºã€ç³»ç»Ÿå…±äº«åº“ç­‰ åˆ›å»º ZygoteServerï¼Œå…¶å®å°±æ˜¯ ServerSocket å¾ªç¯ç­‰å¾…é€šçŸ¥ fork å­è¿›ç¨‹ åˆ›å»º SystemServerè¿›ç¨‹ 2.3.1 preload() preload()ï¼šèµ„æºå‡†å¤‡ï¼ŒåŒ…æ‹¬ç±»åŠ è½½ï¼Œèµ„æºåŠ è½½ç­‰ 135 static void preload(TimingsTraceLog bootTimingsTraceLog) { 138 beginPreload(); 141 preloadClasses(); 144 cacheNonBootClasspathClassLoaders(); 147 preloadResources(); 150 nativePreloadAppProcessHALs(); 153 maybePreloadGraphicsDriver(); 155 preloadSharedLibraries(); 156 preloadTextResources(); 157 // Ask the WebViewFactory to do any initialization that must run in the zygote process, 158 // for memory sharing purposes. 159 WebViewFactory.prepareWebViewInZygote(); 160 endPreload(); 161 warmUpJcaProviders(); 164 sPreloadComplete = true; 165 } ...... 244 /** 245 * Performs Zygote process initialization. Loads and initializes commonly used classes. 246 * 247 * Most classes only cause a few hundred bytes to be allocated, but a few will allocate a dozen 248 * Kbytes (in one case, 500+K). 249 */ 250 private static void preloadClasses() { 251 final VMRuntime runtime = VMRuntime.getRuntime(); 252 253 InputStream is; 254 try { 255 is = new FileInputStream(PRELOADED_CLASSES); 256 } catch (FileNotFoundException e) { 257 Log.e(TAG, \"Couldn't find \" + PRELOADED_CLASSES + \".\"); 258 return; 259 } 260 261 Log.i(TAG, \"Preloading classes...\"); 262 long startTime = SystemClock.uptimeMillis(); 263 264 // Drop root perms while running static initializers. 265 final int ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:2:3","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#231-preload"},{"categories":["å­¦ä¹ æ€»ç»“"],"collections":["å¼€æœºå¯åŠ¨"],"content":"2.3 ZygoteInitåˆå§‹åŒ– AndroidRuntimeåœ¨Nativeå±‚åˆ›å»ºäº†Zygoteï¼Œå¹¶ä¸”é€šè¿‡AndroidRuntime.start()ä»Nativeå±‚è½¬åˆ°Javaå±‚ZygoteInitçš„main()å…¥å£ï¼ŒZygoteInitçš„main()æ–¹æ³•æ˜¯Androidå¯åŠ¨çš„ç¬¬ä¸€ä¸ªJavaè¿›ç¨‹ä¸»æ–¹æ³• /frameworks/base/core/java/com/android/internal/os/ZygoteInit.java 818 @UnsupportedAppUsage 819 public static void main(String argv[]) { 820 ZygoteServer zygoteServer = null; ...... 833 Runnable caller; 834 try { ...... 847 boolean startSystemServer = false; 848 String zygoteSocketName = \"zygote\"; 849 String abiList = null; 850 boolean enableLazyPreload = false; 851 for (int i = 1; i \u003c argv.length; i++) { 852 if (\"start-system-server\".equals(argv[i])) { 853 startSystemServer = true; 854 } else if (\"--enable-lazy-preload\".equals(argv[i])) { 855 enableLazyPreload = true; 856 } else if (argv[i].startsWith(ABI_LIST_ARG)) { 857 abiList = argv[i].substring(ABI_LIST_ARG.length()); 858 } else if (argv[i].startsWith(SOCKET_NAME_ARG)) { 859 zygoteSocketName = argv[i].substring(SOCKET_NAME_ARG.length()); 860 } else { 861 throw new RuntimeException(\"Unknown command line argument: \" + argv[i]); 862 } 863 } 864 865 final boolean isPrimaryZygote = zygoteSocketName.equals(Zygote.PRIMARY_SOCKET_NAME); 866 867 if (abiList == null) { 868 throw new RuntimeException(\"No ABI list supplied.\"); 869 } 870 871 // In some configurations, we avoid preloading resources and classes eagerly. 872 // In such cases, we will preload things prior to our first fork. 873 if (!enableLazyPreload) { ...... 877 preload(bootTimingsTraceLog); ...... 881 } else { 882 Zygote.resetNicePriority(); 883 } ...... 896 Zygote.initNativeState(isPrimaryZygote); 897 898 ZygoteHooks.stopZygoteNoThreadCreation(); 899 900 zygoteServer = new ZygoteServer(isPrimaryZygote); 901 902 if (startSystemServer) { 903 Runnable r = forkSystemServer(abiList, zygoteSocketName, zygoteServer); 904 905 // {@code r == null} in the parent (zygote) process, and {@code r != null} in the 906 // child (system_server) process. 907 if (r != null) { 908 r.run(); 909 return; 910 } 911 } 912 913 Log.i(TAG, \"Accepting command socket connections\"); 914 915 // The select loop returns early in the child process after a fork and 916 // loops forever in the zygote. 917 caller = zygoteServer.runSelectLoop(abiList); 918 } catch (Throwable ex) { 919 Log.e(TAG, \"System zygote died with exception\", ex); 920 throw ex; 921 } finally { 922 if (zygoteServer != null) { 923 zygoteServer.closeServerSocket(); 924 } 925 } 926 927 // We're in the child process and have exited the select loop. Proceed to execute the 928 // command. 929 if (caller != null) { 930 caller.run(); 931 } 932 } ä¸»è¦åšäº†3ä»¶äº‹ï¼š preload()é¢„å…ˆåŠ è½½ç³»ç»Ÿèµ„æºï¼Œå¦‚ç³»ç»Ÿç±»ã€èµ„æºã€ç³»ç»Ÿå…±äº«åº“ç­‰ åˆ›å»º ZygoteServerï¼Œå…¶å®å°±æ˜¯ ServerSocket å¾ªç¯ç­‰å¾…é€šçŸ¥ fork å­è¿›ç¨‹ åˆ›å»º SystemServerè¿›ç¨‹ 2.3.1 preload() preload()ï¼šèµ„æºå‡†å¤‡ï¼ŒåŒ…æ‹¬ç±»åŠ è½½ï¼Œèµ„æºåŠ è½½ç­‰ 135 static void preload(TimingsTraceLog bootTimingsTraceLog) { 138 beginPreload(); 141 preloadClasses(); 144 cacheNonBootClasspathClassLoaders(); 147 preloadResources(); 150 nativePreloadAppProcessHALs(); 153 maybePreloadGraphicsDriver(); 155 preloadSharedLibraries(); 156 preloadTextResources(); 157 // Ask the WebViewFactory to do any initialization that must run in the zygote process, 158 // for memory sharing purposes. 159 WebViewFactory.prepareWebViewInZygote(); 160 endPreload(); 161 warmUpJcaProviders(); 164 sPreloadComplete = true; 165 } ...... 244 /** 245 * Performs Zygote process initialization. Loads and initializes commonly used classes. 246 * 247 * Most classes only cause a few hundred bytes to be allocated, but a few will allocate a dozen 248 * Kbytes (in one case, 500+K). 249 */ 250 private static void preloadClasses() { 251 final VMRuntime runtime = VMRuntime.getRuntime(); 252 253 InputStream is; 254 try { 255 is = new FileInputStream(PRELOADED_CLASSES); 256 } catch (FileNotFoundException e) { 257 Log.e(TAG, \"Couldn't find \" + PRELOADED_CLASSES + \".\"); 258 return; 259 } 260 261 Log.i(TAG, \"Preloading classes...\"); 262 long startTime = SystemClock.uptimeMillis(); 263 264 // Drop root perms while running static initializers. 265 final int ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:2:3","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#232-zygoteserver"},{"categories":["å­¦ä¹ æ€»ç»“"],"collections":["å¼€æœºå¯åŠ¨"],"content":"2.3 ZygoteInitåˆå§‹åŒ– AndroidRuntimeåœ¨Nativeå±‚åˆ›å»ºäº†Zygoteï¼Œå¹¶ä¸”é€šè¿‡AndroidRuntime.start()ä»Nativeå±‚è½¬åˆ°Javaå±‚ZygoteInitçš„main()å…¥å£ï¼ŒZygoteInitçš„main()æ–¹æ³•æ˜¯Androidå¯åŠ¨çš„ç¬¬ä¸€ä¸ªJavaè¿›ç¨‹ä¸»æ–¹æ³• /frameworks/base/core/java/com/android/internal/os/ZygoteInit.java 818 @UnsupportedAppUsage 819 public static void main(String argv[]) { 820 ZygoteServer zygoteServer = null; ...... 833 Runnable caller; 834 try { ...... 847 boolean startSystemServer = false; 848 String zygoteSocketName = \"zygote\"; 849 String abiList = null; 850 boolean enableLazyPreload = false; 851 for (int i = 1; i \u003c argv.length; i++) { 852 if (\"start-system-server\".equals(argv[i])) { 853 startSystemServer = true; 854 } else if (\"--enable-lazy-preload\".equals(argv[i])) { 855 enableLazyPreload = true; 856 } else if (argv[i].startsWith(ABI_LIST_ARG)) { 857 abiList = argv[i].substring(ABI_LIST_ARG.length()); 858 } else if (argv[i].startsWith(SOCKET_NAME_ARG)) { 859 zygoteSocketName = argv[i].substring(SOCKET_NAME_ARG.length()); 860 } else { 861 throw new RuntimeException(\"Unknown command line argument: \" + argv[i]); 862 } 863 } 864 865 final boolean isPrimaryZygote = zygoteSocketName.equals(Zygote.PRIMARY_SOCKET_NAME); 866 867 if (abiList == null) { 868 throw new RuntimeException(\"No ABI list supplied.\"); 869 } 870 871 // In some configurations, we avoid preloading resources and classes eagerly. 872 // In such cases, we will preload things prior to our first fork. 873 if (!enableLazyPreload) { ...... 877 preload(bootTimingsTraceLog); ...... 881 } else { 882 Zygote.resetNicePriority(); 883 } ...... 896 Zygote.initNativeState(isPrimaryZygote); 897 898 ZygoteHooks.stopZygoteNoThreadCreation(); 899 900 zygoteServer = new ZygoteServer(isPrimaryZygote); 901 902 if (startSystemServer) { 903 Runnable r = forkSystemServer(abiList, zygoteSocketName, zygoteServer); 904 905 // {@code r == null} in the parent (zygote) process, and {@code r != null} in the 906 // child (system_server) process. 907 if (r != null) { 908 r.run(); 909 return; 910 } 911 } 912 913 Log.i(TAG, \"Accepting command socket connections\"); 914 915 // The select loop returns early in the child process after a fork and 916 // loops forever in the zygote. 917 caller = zygoteServer.runSelectLoop(abiList); 918 } catch (Throwable ex) { 919 Log.e(TAG, \"System zygote died with exception\", ex); 920 throw ex; 921 } finally { 922 if (zygoteServer != null) { 923 zygoteServer.closeServerSocket(); 924 } 925 } 926 927 // We're in the child process and have exited the select loop. Proceed to execute the 928 // command. 929 if (caller != null) { 930 caller.run(); 931 } 932 } ä¸»è¦åšäº†3ä»¶äº‹ï¼š preload()é¢„å…ˆåŠ è½½ç³»ç»Ÿèµ„æºï¼Œå¦‚ç³»ç»Ÿç±»ã€èµ„æºã€ç³»ç»Ÿå…±äº«åº“ç­‰ åˆ›å»º ZygoteServerï¼Œå…¶å®å°±æ˜¯ ServerSocket å¾ªç¯ç­‰å¾…é€šçŸ¥ fork å­è¿›ç¨‹ åˆ›å»º SystemServerè¿›ç¨‹ 2.3.1 preload() preload()ï¼šèµ„æºå‡†å¤‡ï¼ŒåŒ…æ‹¬ç±»åŠ è½½ï¼Œèµ„æºåŠ è½½ç­‰ 135 static void preload(TimingsTraceLog bootTimingsTraceLog) { 138 beginPreload(); 141 preloadClasses(); 144 cacheNonBootClasspathClassLoaders(); 147 preloadResources(); 150 nativePreloadAppProcessHALs(); 153 maybePreloadGraphicsDriver(); 155 preloadSharedLibraries(); 156 preloadTextResources(); 157 // Ask the WebViewFactory to do any initialization that must run in the zygote process, 158 // for memory sharing purposes. 159 WebViewFactory.prepareWebViewInZygote(); 160 endPreload(); 161 warmUpJcaProviders(); 164 sPreloadComplete = true; 165 } ...... 244 /** 245 * Performs Zygote process initialization. Loads and initializes commonly used classes. 246 * 247 * Most classes only cause a few hundred bytes to be allocated, but a few will allocate a dozen 248 * Kbytes (in one case, 500+K). 249 */ 250 private static void preloadClasses() { 251 final VMRuntime runtime = VMRuntime.getRuntime(); 252 253 InputStream is; 254 try { 255 is = new FileInputStream(PRELOADED_CLASSES); 256 } catch (FileNotFoundException e) { 257 Log.e(TAG, \"Couldn't find \" + PRELOADED_CLASSES + \".\"); 258 return; 259 } 260 261 Log.i(TAG, \"Preloading classes...\"); 262 long startTime = SystemClock.uptimeMillis(); 263 264 // Drop root perms while running static initializers. 265 final int ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:2:3","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#233-åˆ›å»ºsystemserverè¿›ç¨‹"},{"categories":["å­¦ä¹ æ€»ç»“"],"collections":["å¼€æœºå¯åŠ¨"],"content":"2.4 Zygoteå¯åŠ¨æµç¨‹å›¾ ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:2:4","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#24-zygoteå¯åŠ¨æµç¨‹å›¾"},{"categories":["å­¦ä¹ æ€»ç»“"],"collections":["å¼€æœºå¯åŠ¨"],"content":"3 æ€»ç»“ æ‰€æœ‰çš„è¿›ç¨‹éƒ½ç”±Zygoteåˆ›å»ºï¼Œzygoteä¸»è¦ç”¨æ¥å­µåŒ–system_serverè¿›ç¨‹å’Œåº”ç”¨ç¨‹åºè¿›ç¨‹ã€‚åœ¨å­µåŒ–å‡ºç¬¬ä¸€ä¸ªè¿›ç¨‹system_serveråé€šè¿‡runSelectLoopç­‰å¾…å¹¶å¤„ç†æ¶ˆæ¯ï¼Œåˆ†è£‚åº”ç”¨ç¨‹åºè¿›ç¨‹ä»ç”±system_serveræ§åˆ¶ï¼Œç­‰å¾… AMS ç»™ä»–å‘æ¶ˆæ¯ï¼ˆå‘Šè¯‰ zygote åˆ›å»ºè¿›ç¨‹ï¼‰ï¼Œå¦‚appå¯åŠ¨æ—¶åˆ›å»ºå­è¿›ç¨‹ã€‚ ä»AndroidRuntimeåˆ°ZygoteInitï¼Œä¸»è¦åˆ†ä¸º3å¤§è¿‡ç¨‹ï¼š 1ã€åˆ›å»ºè™šæ‹Ÿæœºâ€”â€”startVm():è°ƒç”¨JNIè™šæ‹Ÿæœºåˆ›å»ºå‡½æ•° 2ã€æ³¨å†ŒJNIå‡½æ•°â€”â€”startReg()ï¼šå‰é¢å·²ç»åˆ›å»ºè™šæ‹Ÿæœºï¼Œè¿™é‡Œç»™è¿™ä¸ªè™šæ‹Ÿæœºæ³¨å†Œä¸€äº›JNIå‡½æ•°ï¼ˆåç»­javaä¸–ç•Œç”¨åˆ°çš„å‡½æ•°æ˜¯nativeå®ç°ï¼Œè¿™é‡Œéœ€è¦æå‰æ³¨å†Œæ³¨å†Œè¿™äº›å‡½æ•°ï¼‰ 3ã€æ­¤æ—¶å°±è¦æ‰§è¡ŒCallStaticViodMethodï¼Œé€šè¿‡è¿™ä¸ªå‡½æ•°å°†è¿›å…¥androidç²¾å¿ƒæ‰“é€ çš„javaä¸–ç•Œï¼Œè¿™ä¸ªå‡½æ•°å°†è°ƒç”¨com.android.internal.os.ZygoteInitçš„mainå‡½æ•° åœ¨ ZygoteInit.mainå‡½æ•°ä¸­è¿›å…¥Javaä¸–ç•Œï¼Œä¸»è¦æœ‰4ä¸ªå…³é”®æ­¥éª¤ï¼š 1ã€é¢„åŠ è½½ç±»å’Œèµ„æºâ€”â€”preload() ä¸»è¦æ˜¯preloadClasseså’ŒpreloadResourcesï¼Œå…¶ä¸­preloadClassesä¸€èˆ¬æ˜¯åŠ è½½æ—¶é—´è¶…è¿‡1250msçš„ç±»ï¼Œå› è€Œéœ€è¦åœ¨zygoteé¢„åŠ è½½ 2ã€å»ºç«‹IPCé€šä¿¡æœåŠ¡â€”â€”åˆå§‹åŒ–ZygoteServerï¼Œå†…éƒ¨åˆå§‹åŒ–äº†ZygoteSocket zygoteåŠç³»ç»Ÿä¸­å…¶ä»–ç¨‹åºçš„é€šä¿¡å¹¶æ²¡æœ‰ä½¿ç”¨Binderï¼Œè€Œæ˜¯é‡‡ç”¨åŸºäºAF_UNIXç±»å‹çš„Socketï¼Œä½œç”¨æ­£æ˜¯å»ºç«‹è¿™ä¸ªSocket 3ã€å¯åŠ¨system_serverâ€”â€”forkSystemServer() è¿™ä¸ªå‡½æ•°ä¼šåˆ›å»ºJavaä¸–ç•Œä¸­ç³»ç»ŸServiceæ‰€é©»ç•™çš„è¿›ç¨‹system_server,è¯¥è¿›ç¨‹æ˜¯frameworkçš„æ ¸å¿ƒï¼Œä¹Ÿæ˜¯zygoteå­µåŒ–å‡ºçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ã€‚å¦‚æœå®ƒæ­»äº†ï¼Œå°±ä¼šå¯¼è‡´zygoteè‡ªæ€ã€‚ 4ã€ç­‰å¾…è¯·æ±‚â€”â€”runSelectLoop() zygoteä»startSystemServerè¿”å›åï¼Œå°†è¿›å…¥ç¬¬å››ä¸ªå…³é”®å‡½æ•°runSelectLoopï¼Œåœ¨ç¬¬ä¸€ä¸ªå‡½æ•°ZygoteServerä¸­æ³¨å†Œäº†ä¸€ä¸ªç”¨äºIPCçš„Socketå°†åœ¨è¿™é‡Œä½¿ç”¨ï¼Œè¿™é‡ŒZygoteé‡‡ç”¨é«˜æ•ˆçš„I/Oå¤šè·¯å¤ç”¨æœºåˆ¶ï¼Œä¿è¯åœ¨æ²¡æœ‰å®¢æˆ·ç«¯è¯·æ±‚æ—¶æˆ–è€…æ•°æ®å¤„ç†æ—¶ä¼‘çœ ï¼Œå¦åˆ™å“åº”å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚ç­‰å¾… AMS ç»™ä»–å‘æ¶ˆæ¯ï¼ˆå‘Šè¯‰ zygote åˆ›å»ºè¿›ç¨‹ï¼‰ã€‚æ­¤æ—¶zygoteå®Œæˆäº†javaä¸–ç•Œçš„åˆåˆ›å·¥ä½œï¼Œè°ƒç”¨runSelectLoopä¾¿å¼€å§‹ä¼‘çœ äº†ï¼Œå½“æ”¶åˆ°è¯·æ±‚æˆ–è€…æ•°æ®å¤„ç†ä¾¿ä¼šéšæ—¶é†’æ¥ï¼Œç»§ç»­å·¥ä½œã€‚ ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:3:0","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#3-æ€»ç»“"},{"categories":["å­¦ä¹ æ€»ç»“"],"collections":["å¼€æœºå¯åŠ¨"],"content":"4 é¢è¯•é¢˜ ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:4:0","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#4-é¢è¯•é¢˜"},{"categories":["å­¦ä¹ æ€»ç»“"],"collections":["å¼€æœºå¯åŠ¨"],"content":"1 initè¿›ç¨‹ä½œç”¨æ˜¯ä»€ä¹ˆ initè¿›ç¨‹èµ·ç€æ‰¿ä¸Šå¯ä¸‹çš„ä½œç”¨ï¼ŒAndroidæœ¬èº«æ˜¯åŸºäºLinuxè€Œæ¥çš„ï¼Œinitè¿›ç¨‹æ˜¯Linuxç³»ç»Ÿä¸­ç”¨æˆ·ç©ºé—´çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ã€‚initè¿›ç¨‹å±äºä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ï¼Œå‡†ç¡®çš„è¯´ï¼Œå®ƒæ˜¯Linuxç³»ç»Ÿä¸­ç”¨æˆ·æ§åˆ¶çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼Œå®ƒçš„è¿›ç¨‹å·ä¸º1ï¼ˆè¿›ç¨‹å·ä¸º0çš„ä¸ºå†…æ ¸è¿›ç¨‹ï¼‰ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸè´¯ç©¿æ•´ä¸ªLinuxå†…æ ¸è¿è¡Œçš„å§‹ç»ˆã€‚Androidä¸­æ‰€æœ‰å…¶å®ƒçš„è¿›ç¨‹å…±åŒçš„é¼»ç¥–å‡ä¸ºinitè¿›ç¨‹ã€‚ Android Q(10.0) çš„initå…¥å£å‡½æ•°ç”±åŸå…ˆçš„init.cpp è°ƒæ•´åˆ°äº†main.cppï¼ŒæŠŠå„ä¸ªé˜¶æ®µçš„æ“ä½œåˆ†ç¦»å¼€æ¥ï¼Œä½¿ä»£ç æ›´åŠ ç®€æ´å‘½ä»¤ã€‚ ä½œä¸ºå¤©å­ç¬¬1å·è¿›ç¨‹ï¼Œinitè¢«èµ‹äºˆäº†å¾ˆå¤šé‡è¦çš„èŒè´£ï¼Œä¸»è¦åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š initè¿›ç¨‹ç¬¬ä¸€é˜¶æ®µåšçš„ä¸»è¦å·¥ä½œæ˜¯æŒ‚è½½åˆ†åŒºï¼Œåˆ›å»ºè®¾å¤‡èŠ‚ç‚¹å’Œä¸€äº›å…³é”®ç›®å½•ï¼Œåˆå§‹åŒ–æ—¥å¿—è¾“å‡ºç³»ç»Ÿ,å¯ç”¨SELinuxå®‰å…¨ç­–ç•¥ã€‚ initè¿›ç¨‹ç¬¬äºŒé˜¶æ®µä¸»è¦å·¥ä½œæ˜¯åˆå§‹åŒ–å±æ€§ç³»ç»Ÿï¼Œè§£æSELinuxçš„åŒ¹é…è§„åˆ™ï¼Œå¤„ç†å­è¿›ç¨‹ç»ˆæ­¢ä¿¡å·ï¼Œå¯åŠ¨ç³»ç»Ÿå±æ€§æœåŠ¡ï¼Œå¯ä»¥è¯´æ¯ä¸€é¡¹éƒ½å¾ˆå…³é”®ï¼Œå¦‚æœè¯´ç¬¬ä¸€é˜¶æ®µæ˜¯ä¸ºå±æ€§ç³»ç»Ÿï¼ŒSELinuxåšå‡†å¤‡ï¼Œé‚£ä¹ˆç¬¬äºŒé˜¶æ®µå°±æ˜¯çœŸæ­£å»æŠŠè¿™äº›åŠŸèƒ½è½å®ã€‚ initè¿›è¡Œç¬¬ä¸‰é˜¶æ®µä¸»è¦æ˜¯è§£æinit.rcæ¥å¯åŠ¨å…¶ä»–è¿›ç¨‹ï¼Œè¿›å…¥æ— é™å¾ªç¯ï¼Œè¿›è¡Œå­è¿›ç¨‹å®æ—¶ç›‘æ§(å®ˆæŠ¤)ã€‚ å…¶ä¸­ç¬¬ä¸‰é˜¶æ®µé€šè¿‡initrcå¯åŠ¨å…¶ä»–è¿›ç¨‹ï¼Œæˆ‘ä»¬å¸¸è§çš„æ¯”å¦‚å¯åŠ¨Zygoteè¿›ç¨‹ã€å¯åŠ¨SeviceManagerè¿›ç¨‹ç­‰ã€‚ ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:4:1","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#1-initè¿›ç¨‹ä½œç”¨æ˜¯ä»€ä¹ˆ"},{"categories":["å­¦ä¹ æ€»ç»“"],"collections":["å¼€æœºå¯åŠ¨"],"content":"2 Zygoteè¿›ç¨‹æœ€åŸå§‹çš„è¿›ç¨‹æ˜¯ä»€ä¹ˆè¿›ç¨‹(æˆ–è€…Zygoteè¿›ç¨‹ç”±æ¥) Zygoteæœ€å¼€å§‹æ˜¯app_processï¼Œå®ƒæ˜¯åœ¨ init è¿›ç¨‹å¯åŠ¨æ—¶è¢«å¯åŠ¨çš„ï¼Œåœ¨app_main.cppæ‰è¢«ä¿®æ”¹ä¸º Zygoteã€‚ ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:4:2","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#2-zygoteè¿›ç¨‹æœ€åŸå§‹çš„è¿›ç¨‹æ˜¯ä»€ä¹ˆè¿›ç¨‹æˆ–è€…zygoteè¿›ç¨‹ç”±æ¥"},{"categories":["å­¦ä¹ æ€»ç»“"],"collections":["å¼€æœºå¯åŠ¨"],"content":"3 Zygote æ˜¯åœ¨å†…æ ¸ç©ºé—´è¿˜æ˜¯åœ¨ç”¨æˆ·ç©ºé—´ï¼Ÿ å› ä¸º init è¿›ç¨‹çš„åˆ›å»ºåœ¨ç”¨æˆ·ç©ºé—´ï¼Œè€Œ Zygote æ˜¯ç”± init è¿›ç¨‹åˆ›å»ºå¯åŠ¨çš„ï¼Œæ‰€ä»¥Zygoteæ˜¯åœ¨ç”¨æˆ·ç©ºé—´ã€‚ ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:4:3","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#3-zygote-æ˜¯åœ¨å†…æ ¸ç©ºé—´è¿˜æ˜¯åœ¨ç”¨æˆ·ç©ºé—´"},{"categories":["å­¦ä¹ æ€»ç»“"],"collections":["å¼€æœºå¯åŠ¨"],"content":"4 Zygoteä¸ºä»€ä¹ˆéœ€è¦ç”¨åˆ°Socketé€šä¿¡è€Œä¸æ˜¯Binder Zygoteæ˜¯Androidä¸­çš„ä¸€ä¸ªé‡è¦è¿›ç¨‹ï¼Œå®ƒæ˜¯å¯åŠ¨åº”ç”¨ç¨‹åºè¿›ç¨‹çš„çˆ¶è¿›ç¨‹ã€‚Zygoteä½¿ç”¨Socketæ¥ä¸åº”ç”¨ç¨‹åºè¿›ç¨‹è¿›è¡Œé€šä¿¡ï¼Œè€Œä¸æ˜¯ä½¿ç”¨Androidä¸­çš„IPCæœºåˆ¶Binderï¼Œè¿™æ˜¯å› ä¸ºSocketå’ŒBinderæœ‰ä¸åŒçš„ä¼˜ç¼ºç‚¹ï¼Œè€Œåœ¨Zygoteè¿›ç¨‹ä¸­ä½¿ç”¨Socketå¯ä»¥æ›´å¥½åœ°æ»¡è¶³Zygoteè¿›ç¨‹çš„éœ€æ±‚ã€‚ Zygote ç”¨ binder é€šä¿¡ä¼šå¯¼è‡´æ­»é” å‡è®¾ Zygote ä½¿ç”¨ Binder é€šä¿¡ï¼Œå› ä¸º Binder æ˜¯æ”¯æŒå¤šçº¿ç¨‹çš„ï¼Œå­˜åœ¨å¹¶å‘é—®é¢˜ï¼Œè€Œå¹¶å‘é—®é¢˜çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯åŠ é”ï¼Œå¦‚æœè¿›ç¨‹ fork æ˜¯åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹è¿è¡Œï¼ŒBinder ç­‰å¾…é”åœ¨é”æœºåˆ¶ä¸‹å°±å¯èƒ½ä¼šå‡ºç°æ­»é”ã€‚ Zygote ç”¨ binder é€šä¿¡ä¼šå¯¼è‡´è¯»å†™é”™è¯¯ æ ¹æœ¬åŸå› åœ¨äºè¦ new ä¸€ä¸ª ProcessState ç”¨äº Binder é€šä¿¡æ—¶ï¼Œéœ€è¦ mmap ç”³è¯·ä¸€ç‰‡å†…å­˜ç”¨ä»¥æä¾›ç»™å†…æ ¸è¿›è¡Œæ•°æ®äº¤æ¢ä½¿ç”¨ã€‚è€Œå¦‚æœç›´æ¥ fork äº†çš„è¯ï¼Œå­è¿›ç¨‹åœ¨è¿›è¡Œ binder é€šä¿¡æ—¶ï¼Œå†…æ ¸è¿˜æ˜¯ä¼šç»§ç»­ä½¿ç”¨çˆ¶è¿›ç¨‹ç”³è¯·çš„åœ°å€å†™æ•°æ®ï¼Œè€Œæ­¤æ—¶ä¼šè§¦å‘å­è¿›ç¨‹ COWï¼ˆCopy on Writeï¼‰ï¼Œä»è€Œå¯¼è‡´åœ°å€ç©ºé—´å·²ç»é‡æ–°æ˜ å°„ï¼Œè€Œå­è¿›ç¨‹è¿˜å°è¯•è®¿é—®ä¹‹å‰çˆ¶è¿›ç¨‹ mmap çš„åœ°å€ï¼Œä¼šå¯¼è‡´ SIGSEGVã€SEGV_MAPERRæ®µé”™è¯¯ã€‚ Zygoteåˆå§‹åŒ–æ—¶ï¼ŒBinderè¿˜æ²¡å¼€å§‹åˆå§‹åŒ–ã€‚ Socketå…·æœ‰è‰¯å¥½çš„è·¨å¹³å°æ€§ï¼Œèƒ½å¤Ÿåœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿå’Œè¯­è¨€ä¹‹é—´è¿›è¡Œé€šä¿¡ã€‚è¿™å¯¹äºZygoteè¿›ç¨‹æ¥è¯´éå¸¸é‡è¦ï¼Œå› ä¸ºå®ƒéœ€è¦åœ¨ä¸åŒçš„è®¾å¤‡å’Œæ¶æ„ä¸Šè¿è¡Œï¼Œå¹¶ä¸”éœ€è¦ä¸ä¸åŒçš„åº”ç”¨ç¨‹åºè¿›ç¨‹è¿›è¡Œé€šä¿¡ã€‚ä½¿ç”¨Socketå¯ä»¥è®©Zygoteè¿›ç¨‹æ›´åŠ çµæ´»å’Œå¯æ‰©å±•ï¼Œå› ä¸ºå®ƒä¸éœ€è¦è€ƒè™‘Binderæ‰€å¸¦æ¥çš„ç‰¹å®šé™åˆ¶å’Œè¦æ±‚ã€‚ Socketå…·æœ‰ç®€å•çš„APIå’Œæ˜“äºä½¿ç”¨çš„ç‰¹ç‚¹ã€‚Zygoteè¿›ç¨‹éœ€è¦å¿«é€Ÿå¯åŠ¨å¹¶ä¸åº”ç”¨ç¨‹åºè¿›ç¨‹å»ºç«‹é€šä¿¡ï¼ŒSocketæä¾›äº†å¿«é€Ÿã€å¯é çš„é€šä¿¡æ–¹å¼ï¼Œå¹¶ä¸”ä½¿ç”¨Socket APIä¹Ÿå¾ˆå®¹æ˜“å®ç°ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒBinderéœ€è¦æ›´å¤šçš„é…ç½®å’Œç»´æŠ¤å·¥ä½œï¼Œè¿™å¯¹äºZygoteè¿›ç¨‹æ¥è¯´å¯èƒ½ä¼šå¢åŠ ä¸å¿…è¦çš„å¤æ‚æ€§å’Œå¼€é”€ã€‚ Socketåœ¨æ•°æ®ä¼ è¾“æ—¶å…·æœ‰æ›´ä½çš„å»¶è¿Ÿå’Œæ›´é«˜çš„ååé‡ï¼Œè¿™å¯¹äºZygoteè¿›ç¨‹æ¥è¯´éå¸¸é‡è¦ã€‚Zygoteè¿›ç¨‹éœ€è¦åœ¨è¾ƒçŸ­çš„æ—¶é—´å†…å¯åŠ¨åº”ç”¨ç¨‹åºè¿›ç¨‹ï¼Œå¹¶ä¸”éœ€è¦ä¼ è¾“å¤§é‡çš„æ•°æ®å’Œä»£ç ï¼ŒSocketçš„é«˜æ€§èƒ½å’Œä½å»¶è¿Ÿä½¿å…¶æˆä¸ºæ›´å¥½çš„é€‰æ‹©ã€‚ æ€»ä¹‹ï¼ŒZygoteè¿›ç¨‹ä½¿ç”¨Socketè€Œä¸æ˜¯Binderæ˜¯åŸºäºå…¶ä¼˜ç‚¹å’Œéœ€æ±‚è€Œåšå‡ºçš„é€‰æ‹©ã€‚è™½ç„¶Binderåœ¨Androidä¸­æ‰®æ¼”ç€é‡è¦çš„è§’è‰²ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½¿ç”¨Socketå¯ä»¥æä¾›æ›´å¥½çš„æ€§èƒ½å’Œæ›´å¤§çš„çµæ´»æ€§ã€‚å†è€…ï¼ŒBinderå½“åˆå¹¶ä¸æˆç†Ÿï¼Œå›¢é˜Ÿæˆå‘˜å¯¹äºè¿›ç¨‹é—´é€šè®¯æ›´å€¾å‘äºç”¨Socketï¼Œåé¢ä¸ºäº†åšäº†å¾ˆå¤šä¼˜åŒ–ï¼Œæ‰ä½¿å¾—Binderé€šè®¯å˜å¾—æˆç†Ÿç¨³å®šã€‚ ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:4:4","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#4-zygoteä¸ºä»€ä¹ˆéœ€è¦ç”¨åˆ°socketé€šä¿¡è€Œä¸æ˜¯binder"},{"categories":["å­¦ä¹ æ€»ç»“"],"collections":["å¼€æœºå¯åŠ¨"],"content":"5 æ¯ä¸ªAppéƒ½ä¼šå°†ç³»ç»Ÿçš„èµ„æºï¼Œç³»ç»Ÿçš„ç±»éƒ½åŠ è½½ä¸€éå— zygoteè¿›ç¨‹çš„ä½œç”¨ï¼š 1.åˆ›å»ºä¸€ä¸ªServiceç«¯çš„Socketï¼Œå¼€å¯ä¸€ä¸ªServerSocketå®ç°å’Œåˆ«çš„è¿›ç¨‹é€šä¿¡ã€‚ 2.åŠ è½½ç³»ç»Ÿç±»ï¼Œç³»ç»Ÿèµ„æºã€‚ 3.å¯åŠ¨System Serverè¿›ç¨‹ Zygoteè¿›ç¨‹é¢„åŠ è½½ç³»ç»Ÿèµ„æºåï¼Œç„¶åé€šè¿‡å®ƒå­µåŒ–å‡ºå…¶ä»–çš„è™šæ‹Ÿæœºè¿›ç¨‹ï¼Œè¿›è€Œå…±äº«è™šæ‹Ÿæœºå†…å­˜å’Œæ¡†æ¶å±‚èµ„æºï¼ˆå…±äº«å†…å­˜ï¼‰ï¼Œè¿™æ ·å¤§å¹…åº¦æé«˜åº”ç”¨ç¨‹åºçš„å¯åŠ¨å’Œè¿è¡Œé€Ÿåº¦ã€‚ ","date":"2024-11-06","objectID":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/:4:5","tags":["blog","Framework"],"title":"Zygoteè¿›ç¨‹ç›¸å…³","uri":"/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/#5-æ¯ä¸ªappéƒ½ä¼šå°†ç³»ç»Ÿçš„èµ„æºç³»ç»Ÿçš„ç±»éƒ½åŠ è½½ä¸€éå—"},{"categories":null,"collections":["WMS"],"content":"ç›®æ ‡ï¼š ","date":"2024-11-06","objectID":"/posts/%E5%8F%8C%E5%B1%8F%E5%8A%A8%E7%94%BB/:1:0","tags":["clippings","è½¬è½½","blog","å®æˆ˜"],"title":"åŒå±åŠ¨ç”»","uri":"/posts/%E5%8F%8C%E5%B1%8F%E5%8A%A8%E7%94%BB/#ç›®æ ‡"},{"categories":null,"collections":["WMS"],"content":"ä»»åŠ¡åˆ†æå’Œåˆ†è§£ï¼š #ä¸€ ç›‘å¬å¤šæŒ‡äº‹ä»¶ #äºŒ ä»»åŠ¡è·¨å±ç§»åŠ¨ ä¸€ ç›‘å¬å¤šæŒ‡äº‹ä»¶ ç›‘å¬æ‰‹æŒ‡äº‹ä»¶å¯ä»¥å‚è€ƒSystemGesturesPointerEventListener.java é€šè¿‡ç»§æ‰¿å®ç°PointerEventListener å®ç° import android.view.WindowManagerPolicyConstants.PointerEventListener; å®ç°å…¶ä¸­çš„æ–¹æ³•ï¼š @Override public void onPointerEvent(MotionEvent motionEvent) { //å®ç°å…¶ä¸­çš„ down move up äº‹ä»¶ } äºŒ ä»»åŠ¡è·¨å±ç§»åŠ¨ æˆ‘ä»¬åœ¨DisplayContenté‡Œé¢åšåŠŸèƒ½å®ç° mRootWindowContainer.moveRootTaskToDisplay(rootTaskId,otherDisplay.mDisplayId,true);//æŠŠtaskç§»åŠ¨åˆ°å¦ä¸€å± ä¸‰ ç§»åŠ¨åŠ¨ç”»æ–¹æ¡ˆ-è™šæ‹Ÿé•œåƒå±å¹• æ–¹æ¡ˆï¼š é•œåƒæ¨¡å¼ä¸çœŸå®é•œåƒåæ ‡æ˜¯åŒæ­¥çš„ã€‚ å…ˆåˆ›å»ºé•œåƒå±å¹•å›¾å±‚ï¼Œå½“å‰çŠ¶æ€åº”è¯¥æ˜¯é•œåƒå›¾å±‚ç›–åœ¨æºå±å¹•ä¸Šé¢ã€‚ å°†æºå±å¹•å›¾å±‚ï¼Œç§»åŠ¨åˆ°å±å¹•1çš„å·¦è¾¹ã€‚é•œåƒå¯¹åº”çš„éœ€è¦åœ¨å±å¹•ä¸Šæ˜¾ç¤ºã€‚ ç§»åŠ¨åŸæœ‰å±å¹•ç”»é¢åˆ°å³ä¾§æ˜¾ç¤ºå™¨ åˆ¤æ–­å¼€å§‹åŠ¨ç”»ç§»åŠ¨ â€“ \u003e æ›´æ”¹å›¾å±‚åæ ‡ï¼ŒåŠ¨ç”»ç»“æŸåï¼Œåˆ¤æ–­æ˜¯å¦ç§»ä½ 1 ç§»ä½åŠ¨ç”»ï¼Œ2 å¤ä½åŠ¨ç”» åˆ›å»ºé•œåƒå±å¹• //æ·»åŠ å›¾å±‚ SurfaceControl copyTaskSc = null; SurfaceControl copyTaskBuffer = null; SurfaceControl realWindwosSateBuffer = null; //åˆ›å»ºä¸€ä¸ªé•œåƒå›¾å±‚ if(copyTaskSc == null){ makeChildSurface(null).setName(\"copyTaskSc\") .setParent(getWindowingLayer()) .build();// getWindowingLayer åœ¨appä¸Šå— } if(copyTaskBuffer == null){ //é•œåƒä¸€ä¸ªtaskçš„ surfacecontrol ---- copyTaskBuffer //surfacecontrolé‡Œé¢å…¶å®æœ‰ä¸€ä¸ªlayer copyTaskBuffer = SurfaceContrl.mirrorSurface(rootTask.getSurfaceControl()); //åŸç”Ÿçš„ä¸€ä¸ª realWindwosSateBuffer = rootTask.getSurfaceControl(); //è·å–ä¸€ä¸ªäº‹åŠ¡ SurfaceContrl.Transaction t = mWmSerivce.mTransactionFactory.get(); //æŠŠ æ‹·è´çš„ copyTaskBuffer æ”¾åˆ°äº† copyTaskSc ä¸‹é¢ï¼ŒcopyTaskSc åœ¨åŸæ¥çš„å±å¹•ä¸‹é¢ t.reparent(copyTaskBuffer,copyTaskSc); //æ˜¾ç¤ºå›¾å±‚ t.show(copyTaskSc); t.show(copyTaskBuffer); //å¹³ç§» Matrix matrix = new Matrix(); matrix.reset(); matrix.postTranslate(100,0); //å¾€å¹³ç§» t.setMatrix(copyTaskBuffer,matrix,new float[9]) t.apply(); } ç§»åŠ¨å±å¹•åˆ°å³ä¾§ï¼Œå¹¶ä¸”è®¾ç½®å·¦è¾¹å±å¹•å¤–é¢ã€‚ //ç”±äºç§»åŠ¨åˆ°2å±å¹•ï¼Œéœ€è¦å†ç§»åŠ¨åˆ°å±å¹•å¤–ï¼Œä¼šæœ‰é—ªå±çš„æƒ…å†µï¼Œéœ€è¦å†ç§»åŠ¨ä¹‹å‰ï¼Œå…ˆè¿›è¡Œç§»åŠ¨ã€‚ //ç›´æ¥è°ƒç”¨ä¸‹é¢çš„ startMoveCurrentScreenTaskï¼ˆ0ï¼Œ0ï¼‰ mRootWindowContainer.moveRootTaskToDisplay(rootTaskId,otherDisplay.mDisplayId,true);//æŠŠtaskç§»åŠ¨åˆ°å¦ä¸€å± åŠ¨ç”» //ç§»åŠ¨é•œåƒå›¾å±‚ public void startMoveCurrentScreenTask(int x ,int y){ if(copyTaskBuffer != null){ SurfaceControl.Transaction t = mWnService.mTrasactionFactory.get(); //å±å¹•2 Matrix matrix = new Matrix(); int width = getDisaplayINfog().logicalWIdth; matrix.postTranslate(-width+x,0); //å±å¹•1 matrix = new Matrix(); matrix.reset(); matrix.postTranslate(width,y); t.setMatrix(copyTaskBuffer,matrix,new floatp[9]); t.setMatix(reaWindowStateBuffer,matrix,new floatp[9]); t.aaply(); } } //çœŸå®å›¾å±‚ ä¹Ÿéœ€è¦æ“ä½œ,å…ˆç§»åŠ¨åˆ°æœ€å·¦ä¾§ reaWindowStateBuffer = rootTask.getSurfaceControl(); æ‰‹æŒ‡æŠ¬èµ·åå¤„ç†æµç¨‹ï¼š å¦‚æœæ˜¯è‡ªåŠ¨ç§»åŠ¨å±å¹•2ï¼Œåˆ™offsetX â€”â€“\u003e 1440ï¼ˆwidthï¼‰ å¦‚æœæ˜¯è‡ªåŠ¨ç§»åŠ¨å±å¹•1ï¼Œåˆ™offsetX â€”â€“\u003e 0ï¼ˆåŸç‚¹ï¼‰ case MotionEvent.ACTION_POINTER_UP: case MotionEvent.ACTION_UP: startAutoMove(offsetX, .xxx \u003e xxx ? 1: 0) void startAutoMove(int offsetX, int destDisplay){ int endX = destDisplay 0 or width //åˆ¤æ–­æœ€åå±å¹•ã€‚ç„¶ååŠ¨ç”»ç»“æŸä½ç½® ValueAnimator valueAnimiator = ValueAnimator.ofInt(offsetx,end); valueAnimator.addUpdateListener(new ValueAnimator.AnimatorUpdateListener(){ public onUpdate(){ int current = int animate.getValue(); startmovecurrentScreenTask(x,y); } }); valueAnimator.setInterpolator(); valueAnimator.setDuration(); valueAnimator.staret(); } onAnimationEnd //ç§»é™¤å›¾å±‚ SurfaceControl.Transaction t = mWnService.mTrasactionFactory.get(); t.remove(copyBuffer); t.remove(copyTaskSc); t.apply(); copyBuffer = null; copyTaskSc = null; //åŠ¨ç”»å¦‚æœæ˜¯è¿”å›ï¼Œéœ€è¦æŠŠåŸé•œåƒmoveå›å»ã€‚ mRootWindowContainer.moveRootTaskToDisplay(mCurrentTaskId,mDisplayId.mDisplayId,true); //ç§»åŠ¨åŸé•œåƒå›¾å±‚ï¼Œä»å±å¹•å¤–å†ç§»åŠ¨å›æ¥ã€‚ matrix.reset(); setMatrix()//å½’é›¶ targetActivity.mLauncherTaskBehind =false mRootWindowContainer.ensureActiviesVisible(); //æ¡Œé¢å¯ä»¥å¯è§ targetActivity.mLauncherTaskBehind =true é•œåƒæ¨¡å¼ï¼Œæºç•Œé¢å‘ç”Ÿå˜åŒ–ï¼Œé•œåƒåæ ‡ä¹Ÿä¼šå˜åŒ– é—®é¢˜åˆ†æï¼š adb shell dumpsys SurfaceFlinger adb shell dumpsys input ToDo: ![image-20241017173033900](/Users/huangwentao/Library/Application Support/typora-user-images/image-20241017173033900.png) ======================================= DisplayContent.java å®ç°åŒæŒ‡ç›‘å¬äº‹ä»¶ DoubleScreenMovePoiListerner ç»§æ‰¿ PointerEventListener DisplayContext.doTestMoveTaskToOtherDisplay //æ·»åŠ å›¾å±‚ SurfaceControl copyTaskSc = null; SurfaceControl copyTaskBuffer = null; SurfaceControl realWindwosSateBuffer = null; //add by doublescreenmove public void doTestMoveTaskToOtherDisplay() { DisplayContent otherDisplay = null; if (mRootWindowContainer.getChildCount() == 2) {//æ£€æµ‹æ˜¯ä¸æ˜¯åŒå± otherD","date":"2024-11-06","objectID":"/posts/%E5%8F%8C%E5%B1%8F%E5%8A%A8%E7%94%BB/:2:0","tags":["clippings","è½¬è½½","blog","å®æˆ˜"],"title":"åŒå±åŠ¨ç”»","uri":"/posts/%E5%8F%8C%E5%B1%8F%E5%8A%A8%E7%94%BB/#ä»»åŠ¡åˆ†æå’Œåˆ†è§£"},{"categories":null,"collections":["WMS"],"content":"ä»»åŠ¡åˆ†æå’Œåˆ†è§£ï¼š #ä¸€ ç›‘å¬å¤šæŒ‡äº‹ä»¶ #äºŒ ä»»åŠ¡è·¨å±ç§»åŠ¨ ä¸€ ç›‘å¬å¤šæŒ‡äº‹ä»¶ ç›‘å¬æ‰‹æŒ‡äº‹ä»¶å¯ä»¥å‚è€ƒSystemGesturesPointerEventListener.java é€šè¿‡ç»§æ‰¿å®ç°PointerEventListener å®ç° import android.view.WindowManagerPolicyConstants.PointerEventListener; å®ç°å…¶ä¸­çš„æ–¹æ³•ï¼š @Override public void onPointerEvent(MotionEvent motionEvent) { //å®ç°å…¶ä¸­çš„ down move up äº‹ä»¶ } äºŒ ä»»åŠ¡è·¨å±ç§»åŠ¨ æˆ‘ä»¬åœ¨DisplayContenté‡Œé¢åšåŠŸèƒ½å®ç° mRootWindowContainer.moveRootTaskToDisplay(rootTaskId,otherDisplay.mDisplayId,true);//æŠŠtaskç§»åŠ¨åˆ°å¦ä¸€å± ä¸‰ ç§»åŠ¨åŠ¨ç”»æ–¹æ¡ˆ-è™šæ‹Ÿé•œåƒå±å¹• æ–¹æ¡ˆï¼š é•œåƒæ¨¡å¼ä¸çœŸå®é•œåƒåæ ‡æ˜¯åŒæ­¥çš„ã€‚ å…ˆåˆ›å»ºé•œåƒå±å¹•å›¾å±‚ï¼Œå½“å‰çŠ¶æ€åº”è¯¥æ˜¯é•œåƒå›¾å±‚ç›–åœ¨æºå±å¹•ä¸Šé¢ã€‚ å°†æºå±å¹•å›¾å±‚ï¼Œç§»åŠ¨åˆ°å±å¹•1çš„å·¦è¾¹ã€‚é•œåƒå¯¹åº”çš„éœ€è¦åœ¨å±å¹•ä¸Šæ˜¾ç¤ºã€‚ ç§»åŠ¨åŸæœ‰å±å¹•ç”»é¢åˆ°å³ä¾§æ˜¾ç¤ºå™¨ åˆ¤æ–­å¼€å§‹åŠ¨ç”»ç§»åŠ¨ â€“ \u003e æ›´æ”¹å›¾å±‚åæ ‡ï¼ŒåŠ¨ç”»ç»“æŸåï¼Œåˆ¤æ–­æ˜¯å¦ç§»ä½ 1 ç§»ä½åŠ¨ç”»ï¼Œ2 å¤ä½åŠ¨ç”» åˆ›å»ºé•œåƒå±å¹• //æ·»åŠ å›¾å±‚ SurfaceControl copyTaskSc = null; SurfaceControl copyTaskBuffer = null; SurfaceControl realWindwosSateBuffer = null; //åˆ›å»ºä¸€ä¸ªé•œåƒå›¾å±‚ if(copyTaskSc == null){ makeChildSurface(null).setName(\"copyTaskSc\") .setParent(getWindowingLayer()) .build();// getWindowingLayer åœ¨appä¸Šå— } if(copyTaskBuffer == null){ //é•œåƒä¸€ä¸ªtaskçš„ surfacecontrol ---- copyTaskBuffer //surfacecontrolé‡Œé¢å…¶å®æœ‰ä¸€ä¸ªlayer copyTaskBuffer = SurfaceContrl.mirrorSurface(rootTask.getSurfaceControl()); //åŸç”Ÿçš„ä¸€ä¸ª realWindwosSateBuffer = rootTask.getSurfaceControl(); //è·å–ä¸€ä¸ªäº‹åŠ¡ SurfaceContrl.Transaction t = mWmSerivce.mTransactionFactory.get(); //æŠŠ æ‹·è´çš„ copyTaskBuffer æ”¾åˆ°äº† copyTaskSc ä¸‹é¢ï¼ŒcopyTaskSc åœ¨åŸæ¥çš„å±å¹•ä¸‹é¢ t.reparent(copyTaskBuffer,copyTaskSc); //æ˜¾ç¤ºå›¾å±‚ t.show(copyTaskSc); t.show(copyTaskBuffer); //å¹³ç§» Matrix matrix = new Matrix(); matrix.reset(); matrix.postTranslate(100,0); //å¾€å¹³ç§» t.setMatrix(copyTaskBuffer,matrix,new float[9]) t.apply(); } ç§»åŠ¨å±å¹•åˆ°å³ä¾§ï¼Œå¹¶ä¸”è®¾ç½®å·¦è¾¹å±å¹•å¤–é¢ã€‚ //ç”±äºç§»åŠ¨åˆ°2å±å¹•ï¼Œéœ€è¦å†ç§»åŠ¨åˆ°å±å¹•å¤–ï¼Œä¼šæœ‰é—ªå±çš„æƒ…å†µï¼Œéœ€è¦å†ç§»åŠ¨ä¹‹å‰ï¼Œå…ˆè¿›è¡Œç§»åŠ¨ã€‚ //ç›´æ¥è°ƒç”¨ä¸‹é¢çš„ startMoveCurrentScreenTaskï¼ˆ0ï¼Œ0ï¼‰ mRootWindowContainer.moveRootTaskToDisplay(rootTaskId,otherDisplay.mDisplayId,true);//æŠŠtaskç§»åŠ¨åˆ°å¦ä¸€å± åŠ¨ç”» //ç§»åŠ¨é•œåƒå›¾å±‚ public void startMoveCurrentScreenTask(int x ,int y){ if(copyTaskBuffer != null){ SurfaceControl.Transaction t = mWnService.mTrasactionFactory.get(); //å±å¹•2 Matrix matrix = new Matrix(); int width = getDisaplayINfog().logicalWIdth; matrix.postTranslate(-width+x,0); //å±å¹•1 matrix = new Matrix(); matrix.reset(); matrix.postTranslate(width,y); t.setMatrix(copyTaskBuffer,matrix,new floatp[9]); t.setMatix(reaWindowStateBuffer,matrix,new floatp[9]); t.aaply(); } } //çœŸå®å›¾å±‚ ä¹Ÿéœ€è¦æ“ä½œ,å…ˆç§»åŠ¨åˆ°æœ€å·¦ä¾§ reaWindowStateBuffer = rootTask.getSurfaceControl(); æ‰‹æŒ‡æŠ¬èµ·åå¤„ç†æµç¨‹ï¼š å¦‚æœæ˜¯è‡ªåŠ¨ç§»åŠ¨å±å¹•2ï¼Œåˆ™offsetX â€”â€“\u003e 1440ï¼ˆwidthï¼‰ å¦‚æœæ˜¯è‡ªåŠ¨ç§»åŠ¨å±å¹•1ï¼Œåˆ™offsetX â€”â€“\u003e 0ï¼ˆåŸç‚¹ï¼‰ case MotionEvent.ACTION_POINTER_UP: case MotionEvent.ACTION_UP: startAutoMove(offsetX, .xxx \u003e xxx ? 1: 0) void startAutoMove(int offsetX, int destDisplay){ int endX = destDisplay 0 or width //åˆ¤æ–­æœ€åå±å¹•ã€‚ç„¶ååŠ¨ç”»ç»“æŸä½ç½® ValueAnimator valueAnimiator = ValueAnimator.ofInt(offsetx,end); valueAnimator.addUpdateListener(new ValueAnimator.AnimatorUpdateListener(){ public onUpdate(){ int current = int animate.getValue(); startmovecurrentScreenTask(x,y); } }); valueAnimator.setInterpolator(); valueAnimator.setDuration(); valueAnimator.staret(); } onAnimationEnd //ç§»é™¤å›¾å±‚ SurfaceControl.Transaction t = mWnService.mTrasactionFactory.get(); t.remove(copyBuffer); t.remove(copyTaskSc); t.apply(); copyBuffer = null; copyTaskSc = null; //åŠ¨ç”»å¦‚æœæ˜¯è¿”å›ï¼Œéœ€è¦æŠŠåŸé•œåƒmoveå›å»ã€‚ mRootWindowContainer.moveRootTaskToDisplay(mCurrentTaskId,mDisplayId.mDisplayId,true); //ç§»åŠ¨åŸé•œåƒå›¾å±‚ï¼Œä»å±å¹•å¤–å†ç§»åŠ¨å›æ¥ã€‚ matrix.reset(); setMatrix()//å½’é›¶ targetActivity.mLauncherTaskBehind =false mRootWindowContainer.ensureActiviesVisible(); //æ¡Œé¢å¯ä»¥å¯è§ targetActivity.mLauncherTaskBehind =true é•œåƒæ¨¡å¼ï¼Œæºç•Œé¢å‘ç”Ÿå˜åŒ–ï¼Œé•œåƒåæ ‡ä¹Ÿä¼šå˜åŒ– é—®é¢˜åˆ†æï¼š adb shell dumpsys SurfaceFlinger adb shell dumpsys input ToDo: ![image-20241017173033900](/Users/huangwentao/Library/Application Support/typora-user-images/image-20241017173033900.png) ======================================= DisplayContent.java å®ç°åŒæŒ‡ç›‘å¬äº‹ä»¶ DoubleScreenMovePoiListerner ç»§æ‰¿ PointerEventListener DisplayContext.doTestMoveTaskToOtherDisplay //æ·»åŠ å›¾å±‚ SurfaceControl copyTaskSc = null; SurfaceControl copyTaskBuffer = null; SurfaceControl realWindwosSateBuffer = null; //add by doublescreenmove public void doTestMoveTaskToOtherDisplay() { DisplayContent otherDisplay = null; if (mRootWindowContainer.getChildCount() == 2) {//æ£€æµ‹æ˜¯ä¸æ˜¯åŒå± otherD","date":"2024-11-06","objectID":"/posts/%E5%8F%8C%E5%B1%8F%E5%8A%A8%E7%94%BB/:2:0","tags":["clippings","è½¬è½½","blog","å®æˆ˜"],"title":"åŒå±åŠ¨ç”»","uri":"/posts/%E5%8F%8C%E5%B1%8F%E5%8A%A8%E7%94%BB/#ä¸€-ç›‘å¬å¤šæŒ‡äº‹ä»¶"},{"categories":null,"collections":["WMS"],"content":"ä»»åŠ¡åˆ†æå’Œåˆ†è§£ï¼š #ä¸€ ç›‘å¬å¤šæŒ‡äº‹ä»¶ #äºŒ ä»»åŠ¡è·¨å±ç§»åŠ¨ ä¸€ ç›‘å¬å¤šæŒ‡äº‹ä»¶ ç›‘å¬æ‰‹æŒ‡äº‹ä»¶å¯ä»¥å‚è€ƒSystemGesturesPointerEventListener.java é€šè¿‡ç»§æ‰¿å®ç°PointerEventListener å®ç° import android.view.WindowManagerPolicyConstants.PointerEventListener; å®ç°å…¶ä¸­çš„æ–¹æ³•ï¼š @Override public void onPointerEvent(MotionEvent motionEvent) { //å®ç°å…¶ä¸­çš„ down move up äº‹ä»¶ } äºŒ ä»»åŠ¡è·¨å±ç§»åŠ¨ æˆ‘ä»¬åœ¨DisplayContenté‡Œé¢åšåŠŸèƒ½å®ç° mRootWindowContainer.moveRootTaskToDisplay(rootTaskId,otherDisplay.mDisplayId,true);//æŠŠtaskç§»åŠ¨åˆ°å¦ä¸€å± ä¸‰ ç§»åŠ¨åŠ¨ç”»æ–¹æ¡ˆ-è™šæ‹Ÿé•œåƒå±å¹• æ–¹æ¡ˆï¼š é•œåƒæ¨¡å¼ä¸çœŸå®é•œåƒåæ ‡æ˜¯åŒæ­¥çš„ã€‚ å…ˆåˆ›å»ºé•œåƒå±å¹•å›¾å±‚ï¼Œå½“å‰çŠ¶æ€åº”è¯¥æ˜¯é•œåƒå›¾å±‚ç›–åœ¨æºå±å¹•ä¸Šé¢ã€‚ å°†æºå±å¹•å›¾å±‚ï¼Œç§»åŠ¨åˆ°å±å¹•1çš„å·¦è¾¹ã€‚é•œåƒå¯¹åº”çš„éœ€è¦åœ¨å±å¹•ä¸Šæ˜¾ç¤ºã€‚ ç§»åŠ¨åŸæœ‰å±å¹•ç”»é¢åˆ°å³ä¾§æ˜¾ç¤ºå™¨ åˆ¤æ–­å¼€å§‹åŠ¨ç”»ç§»åŠ¨ â€“ \u003e æ›´æ”¹å›¾å±‚åæ ‡ï¼ŒåŠ¨ç”»ç»“æŸåï¼Œåˆ¤æ–­æ˜¯å¦ç§»ä½ 1 ç§»ä½åŠ¨ç”»ï¼Œ2 å¤ä½åŠ¨ç”» åˆ›å»ºé•œåƒå±å¹• //æ·»åŠ å›¾å±‚ SurfaceControl copyTaskSc = null; SurfaceControl copyTaskBuffer = null; SurfaceControl realWindwosSateBuffer = null; //åˆ›å»ºä¸€ä¸ªé•œåƒå›¾å±‚ if(copyTaskSc == null){ makeChildSurface(null).setName(\"copyTaskSc\") .setParent(getWindowingLayer()) .build();// getWindowingLayer åœ¨appä¸Šå— } if(copyTaskBuffer == null){ //é•œåƒä¸€ä¸ªtaskçš„ surfacecontrol ---- copyTaskBuffer //surfacecontrolé‡Œé¢å…¶å®æœ‰ä¸€ä¸ªlayer copyTaskBuffer = SurfaceContrl.mirrorSurface(rootTask.getSurfaceControl()); //åŸç”Ÿçš„ä¸€ä¸ª realWindwosSateBuffer = rootTask.getSurfaceControl(); //è·å–ä¸€ä¸ªäº‹åŠ¡ SurfaceContrl.Transaction t = mWmSerivce.mTransactionFactory.get(); //æŠŠ æ‹·è´çš„ copyTaskBuffer æ”¾åˆ°äº† copyTaskSc ä¸‹é¢ï¼ŒcopyTaskSc åœ¨åŸæ¥çš„å±å¹•ä¸‹é¢ t.reparent(copyTaskBuffer,copyTaskSc); //æ˜¾ç¤ºå›¾å±‚ t.show(copyTaskSc); t.show(copyTaskBuffer); //å¹³ç§» Matrix matrix = new Matrix(); matrix.reset(); matrix.postTranslate(100,0); //å¾€å¹³ç§» t.setMatrix(copyTaskBuffer,matrix,new float[9]) t.apply(); } ç§»åŠ¨å±å¹•åˆ°å³ä¾§ï¼Œå¹¶ä¸”è®¾ç½®å·¦è¾¹å±å¹•å¤–é¢ã€‚ //ç”±äºç§»åŠ¨åˆ°2å±å¹•ï¼Œéœ€è¦å†ç§»åŠ¨åˆ°å±å¹•å¤–ï¼Œä¼šæœ‰é—ªå±çš„æƒ…å†µï¼Œéœ€è¦å†ç§»åŠ¨ä¹‹å‰ï¼Œå…ˆè¿›è¡Œç§»åŠ¨ã€‚ //ç›´æ¥è°ƒç”¨ä¸‹é¢çš„ startMoveCurrentScreenTaskï¼ˆ0ï¼Œ0ï¼‰ mRootWindowContainer.moveRootTaskToDisplay(rootTaskId,otherDisplay.mDisplayId,true);//æŠŠtaskç§»åŠ¨åˆ°å¦ä¸€å± åŠ¨ç”» //ç§»åŠ¨é•œåƒå›¾å±‚ public void startMoveCurrentScreenTask(int x ,int y){ if(copyTaskBuffer != null){ SurfaceControl.Transaction t = mWnService.mTrasactionFactory.get(); //å±å¹•2 Matrix matrix = new Matrix(); int width = getDisaplayINfog().logicalWIdth; matrix.postTranslate(-width+x,0); //å±å¹•1 matrix = new Matrix(); matrix.reset(); matrix.postTranslate(width,y); t.setMatrix(copyTaskBuffer,matrix,new floatp[9]); t.setMatix(reaWindowStateBuffer,matrix,new floatp[9]); t.aaply(); } } //çœŸå®å›¾å±‚ ä¹Ÿéœ€è¦æ“ä½œ,å…ˆç§»åŠ¨åˆ°æœ€å·¦ä¾§ reaWindowStateBuffer = rootTask.getSurfaceControl(); æ‰‹æŒ‡æŠ¬èµ·åå¤„ç†æµç¨‹ï¼š å¦‚æœæ˜¯è‡ªåŠ¨ç§»åŠ¨å±å¹•2ï¼Œåˆ™offsetX â€”â€“\u003e 1440ï¼ˆwidthï¼‰ å¦‚æœæ˜¯è‡ªåŠ¨ç§»åŠ¨å±å¹•1ï¼Œåˆ™offsetX â€”â€“\u003e 0ï¼ˆåŸç‚¹ï¼‰ case MotionEvent.ACTION_POINTER_UP: case MotionEvent.ACTION_UP: startAutoMove(offsetX, .xxx \u003e xxx ? 1: 0) void startAutoMove(int offsetX, int destDisplay){ int endX = destDisplay 0 or width //åˆ¤æ–­æœ€åå±å¹•ã€‚ç„¶ååŠ¨ç”»ç»“æŸä½ç½® ValueAnimator valueAnimiator = ValueAnimator.ofInt(offsetx,end); valueAnimator.addUpdateListener(new ValueAnimator.AnimatorUpdateListener(){ public onUpdate(){ int current = int animate.getValue(); startmovecurrentScreenTask(x,y); } }); valueAnimator.setInterpolator(); valueAnimator.setDuration(); valueAnimator.staret(); } onAnimationEnd //ç§»é™¤å›¾å±‚ SurfaceControl.Transaction t = mWnService.mTrasactionFactory.get(); t.remove(copyBuffer); t.remove(copyTaskSc); t.apply(); copyBuffer = null; copyTaskSc = null; //åŠ¨ç”»å¦‚æœæ˜¯è¿”å›ï¼Œéœ€è¦æŠŠåŸé•œåƒmoveå›å»ã€‚ mRootWindowContainer.moveRootTaskToDisplay(mCurrentTaskId,mDisplayId.mDisplayId,true); //ç§»åŠ¨åŸé•œåƒå›¾å±‚ï¼Œä»å±å¹•å¤–å†ç§»åŠ¨å›æ¥ã€‚ matrix.reset(); setMatrix()//å½’é›¶ targetActivity.mLauncherTaskBehind =false mRootWindowContainer.ensureActiviesVisible(); //æ¡Œé¢å¯ä»¥å¯è§ targetActivity.mLauncherTaskBehind =true é•œåƒæ¨¡å¼ï¼Œæºç•Œé¢å‘ç”Ÿå˜åŒ–ï¼Œé•œåƒåæ ‡ä¹Ÿä¼šå˜åŒ– é—®é¢˜åˆ†æï¼š adb shell dumpsys SurfaceFlinger adb shell dumpsys input ToDo: ![image-20241017173033900](/Users/huangwentao/Library/Application Support/typora-user-images/image-20241017173033900.png) ======================================= DisplayContent.java å®ç°åŒæŒ‡ç›‘å¬äº‹ä»¶ DoubleScreenMovePoiListerner ç»§æ‰¿ PointerEventListener DisplayContext.doTestMoveTaskToOtherDisplay //æ·»åŠ å›¾å±‚ SurfaceControl copyTaskSc = null; SurfaceControl copyTaskBuffer = null; SurfaceControl realWindwosSateBuffer = null; //add by doublescreenmove public void doTestMoveTaskToOtherDisplay() { DisplayContent otherDisplay = null; if (mRootWindowContainer.getChildCount() == 2) {//æ£€æµ‹æ˜¯ä¸æ˜¯åŒå± otherD","date":"2024-11-06","objectID":"/posts/%E5%8F%8C%E5%B1%8F%E5%8A%A8%E7%94%BB/:2:0","tags":["clippings","è½¬è½½","blog","å®æˆ˜"],"title":"åŒå±åŠ¨ç”»","uri":"/posts/%E5%8F%8C%E5%B1%8F%E5%8A%A8%E7%94%BB/#äºŒ-ä»»åŠ¡è·¨å±ç§»åŠ¨"},{"categories":null,"collections":["WMS"],"content":"ä»»åŠ¡åˆ†æå’Œåˆ†è§£ï¼š #ä¸€ ç›‘å¬å¤šæŒ‡äº‹ä»¶ #äºŒ ä»»åŠ¡è·¨å±ç§»åŠ¨ ä¸€ ç›‘å¬å¤šæŒ‡äº‹ä»¶ ç›‘å¬æ‰‹æŒ‡äº‹ä»¶å¯ä»¥å‚è€ƒSystemGesturesPointerEventListener.java é€šè¿‡ç»§æ‰¿å®ç°PointerEventListener å®ç° import android.view.WindowManagerPolicyConstants.PointerEventListener; å®ç°å…¶ä¸­çš„æ–¹æ³•ï¼š @Override public void onPointerEvent(MotionEvent motionEvent) { //å®ç°å…¶ä¸­çš„ down move up äº‹ä»¶ } äºŒ ä»»åŠ¡è·¨å±ç§»åŠ¨ æˆ‘ä»¬åœ¨DisplayContenté‡Œé¢åšåŠŸèƒ½å®ç° mRootWindowContainer.moveRootTaskToDisplay(rootTaskId,otherDisplay.mDisplayId,true);//æŠŠtaskç§»åŠ¨åˆ°å¦ä¸€å± ä¸‰ ç§»åŠ¨åŠ¨ç”»æ–¹æ¡ˆ-è™šæ‹Ÿé•œåƒå±å¹• æ–¹æ¡ˆï¼š é•œåƒæ¨¡å¼ä¸çœŸå®é•œåƒåæ ‡æ˜¯åŒæ­¥çš„ã€‚ å…ˆåˆ›å»ºé•œåƒå±å¹•å›¾å±‚ï¼Œå½“å‰çŠ¶æ€åº”è¯¥æ˜¯é•œåƒå›¾å±‚ç›–åœ¨æºå±å¹•ä¸Šé¢ã€‚ å°†æºå±å¹•å›¾å±‚ï¼Œç§»åŠ¨åˆ°å±å¹•1çš„å·¦è¾¹ã€‚é•œåƒå¯¹åº”çš„éœ€è¦åœ¨å±å¹•ä¸Šæ˜¾ç¤ºã€‚ ç§»åŠ¨åŸæœ‰å±å¹•ç”»é¢åˆ°å³ä¾§æ˜¾ç¤ºå™¨ åˆ¤æ–­å¼€å§‹åŠ¨ç”»ç§»åŠ¨ â€“ \u003e æ›´æ”¹å›¾å±‚åæ ‡ï¼ŒåŠ¨ç”»ç»“æŸåï¼Œåˆ¤æ–­æ˜¯å¦ç§»ä½ 1 ç§»ä½åŠ¨ç”»ï¼Œ2 å¤ä½åŠ¨ç”» åˆ›å»ºé•œåƒå±å¹• //æ·»åŠ å›¾å±‚ SurfaceControl copyTaskSc = null; SurfaceControl copyTaskBuffer = null; SurfaceControl realWindwosSateBuffer = null; //åˆ›å»ºä¸€ä¸ªé•œåƒå›¾å±‚ if(copyTaskSc == null){ makeChildSurface(null).setName(\"copyTaskSc\") .setParent(getWindowingLayer()) .build();// getWindowingLayer åœ¨appä¸Šå— } if(copyTaskBuffer == null){ //é•œåƒä¸€ä¸ªtaskçš„ surfacecontrol ---- copyTaskBuffer //surfacecontrolé‡Œé¢å…¶å®æœ‰ä¸€ä¸ªlayer copyTaskBuffer = SurfaceContrl.mirrorSurface(rootTask.getSurfaceControl()); //åŸç”Ÿçš„ä¸€ä¸ª realWindwosSateBuffer = rootTask.getSurfaceControl(); //è·å–ä¸€ä¸ªäº‹åŠ¡ SurfaceContrl.Transaction t = mWmSerivce.mTransactionFactory.get(); //æŠŠ æ‹·è´çš„ copyTaskBuffer æ”¾åˆ°äº† copyTaskSc ä¸‹é¢ï¼ŒcopyTaskSc åœ¨åŸæ¥çš„å±å¹•ä¸‹é¢ t.reparent(copyTaskBuffer,copyTaskSc); //æ˜¾ç¤ºå›¾å±‚ t.show(copyTaskSc); t.show(copyTaskBuffer); //å¹³ç§» Matrix matrix = new Matrix(); matrix.reset(); matrix.postTranslate(100,0); //å¾€å¹³ç§» t.setMatrix(copyTaskBuffer,matrix,new float[9]) t.apply(); } ç§»åŠ¨å±å¹•åˆ°å³ä¾§ï¼Œå¹¶ä¸”è®¾ç½®å·¦è¾¹å±å¹•å¤–é¢ã€‚ //ç”±äºç§»åŠ¨åˆ°2å±å¹•ï¼Œéœ€è¦å†ç§»åŠ¨åˆ°å±å¹•å¤–ï¼Œä¼šæœ‰é—ªå±çš„æƒ…å†µï¼Œéœ€è¦å†ç§»åŠ¨ä¹‹å‰ï¼Œå…ˆè¿›è¡Œç§»åŠ¨ã€‚ //ç›´æ¥è°ƒç”¨ä¸‹é¢çš„ startMoveCurrentScreenTaskï¼ˆ0ï¼Œ0ï¼‰ mRootWindowContainer.moveRootTaskToDisplay(rootTaskId,otherDisplay.mDisplayId,true);//æŠŠtaskç§»åŠ¨åˆ°å¦ä¸€å± åŠ¨ç”» //ç§»åŠ¨é•œåƒå›¾å±‚ public void startMoveCurrentScreenTask(int x ,int y){ if(copyTaskBuffer != null){ SurfaceControl.Transaction t = mWnService.mTrasactionFactory.get(); //å±å¹•2 Matrix matrix = new Matrix(); int width = getDisaplayINfog().logicalWIdth; matrix.postTranslate(-width+x,0); //å±å¹•1 matrix = new Matrix(); matrix.reset(); matrix.postTranslate(width,y); t.setMatrix(copyTaskBuffer,matrix,new floatp[9]); t.setMatix(reaWindowStateBuffer,matrix,new floatp[9]); t.aaply(); } } //çœŸå®å›¾å±‚ ä¹Ÿéœ€è¦æ“ä½œ,å…ˆç§»åŠ¨åˆ°æœ€å·¦ä¾§ reaWindowStateBuffer = rootTask.getSurfaceControl(); æ‰‹æŒ‡æŠ¬èµ·åå¤„ç†æµç¨‹ï¼š å¦‚æœæ˜¯è‡ªåŠ¨ç§»åŠ¨å±å¹•2ï¼Œåˆ™offsetX â€”â€“\u003e 1440ï¼ˆwidthï¼‰ å¦‚æœæ˜¯è‡ªåŠ¨ç§»åŠ¨å±å¹•1ï¼Œåˆ™offsetX â€”â€“\u003e 0ï¼ˆåŸç‚¹ï¼‰ case MotionEvent.ACTION_POINTER_UP: case MotionEvent.ACTION_UP: startAutoMove(offsetX, .xxx \u003e xxx ? 1: 0) void startAutoMove(int offsetX, int destDisplay){ int endX = destDisplay 0 or width //åˆ¤æ–­æœ€åå±å¹•ã€‚ç„¶ååŠ¨ç”»ç»“æŸä½ç½® ValueAnimator valueAnimiator = ValueAnimator.ofInt(offsetx,end); valueAnimator.addUpdateListener(new ValueAnimator.AnimatorUpdateListener(){ public onUpdate(){ int current = int animate.getValue(); startmovecurrentScreenTask(x,y); } }); valueAnimator.setInterpolator(); valueAnimator.setDuration(); valueAnimator.staret(); } onAnimationEnd //ç§»é™¤å›¾å±‚ SurfaceControl.Transaction t = mWnService.mTrasactionFactory.get(); t.remove(copyBuffer); t.remove(copyTaskSc); t.apply(); copyBuffer = null; copyTaskSc = null; //åŠ¨ç”»å¦‚æœæ˜¯è¿”å›ï¼Œéœ€è¦æŠŠåŸé•œåƒmoveå›å»ã€‚ mRootWindowContainer.moveRootTaskToDisplay(mCurrentTaskId,mDisplayId.mDisplayId,true); //ç§»åŠ¨åŸé•œåƒå›¾å±‚ï¼Œä»å±å¹•å¤–å†ç§»åŠ¨å›æ¥ã€‚ matrix.reset(); setMatrix()//å½’é›¶ targetActivity.mLauncherTaskBehind =false mRootWindowContainer.ensureActiviesVisible(); //æ¡Œé¢å¯ä»¥å¯è§ targetActivity.mLauncherTaskBehind =true é•œåƒæ¨¡å¼ï¼Œæºç•Œé¢å‘ç”Ÿå˜åŒ–ï¼Œé•œåƒåæ ‡ä¹Ÿä¼šå˜åŒ– é—®é¢˜åˆ†æï¼š adb shell dumpsys SurfaceFlinger adb shell dumpsys input ToDo: ![image-20241017173033900](/Users/huangwentao/Library/Application Support/typora-user-images/image-20241017173033900.png) ======================================= DisplayContent.java å®ç°åŒæŒ‡ç›‘å¬äº‹ä»¶ DoubleScreenMovePoiListerner ç»§æ‰¿ PointerEventListener DisplayContext.doTestMoveTaskToOtherDisplay //æ·»åŠ å›¾å±‚ SurfaceControl copyTaskSc = null; SurfaceControl copyTaskBuffer = null; SurfaceControl realWindwosSateBuffer = null; //add by doublescreenmove public void doTestMoveTaskToOtherDisplay() { DisplayContent otherDisplay = null; if (mRootWindowContainer.getChildCount() == 2) {//æ£€æµ‹æ˜¯ä¸æ˜¯åŒå± otherD","date":"2024-11-06","objectID":"/posts/%E5%8F%8C%E5%B1%8F%E5%8A%A8%E7%94%BB/:2:0","tags":["clippings","è½¬è½½","blog","å®æˆ˜"],"title":"åŒå±åŠ¨ç”»","uri":"/posts/%E5%8F%8C%E5%B1%8F%E5%8A%A8%E7%94%BB/#ä¸‰-ç§»åŠ¨åŠ¨ç”»æ–¹æ¡ˆ-è™šæ‹Ÿé•œåƒå±å¹•"},{"categories":["Android","ubuntu"],"collections":null,"content":"reboot_test.sh #Navy add for reboot/factory-reset test #adb reboot #adb reboot factory-reset #é»˜è®¤å¼€å…³æœºæµ‹è¯•æ¬¡æ•° rebootNum=5 #å¼€å…³æœºè®¾å¤‡IDå· deviceId=null #å¼€å…³æœºé—´éš”æ—¶é—´ rebootInterval=30 if [ $# = 1 ];then rebootNum=$1 elif [ $# = 2 ];then rebootNum=$1 deviceId=$2 fi i=1 while [ $i -le $rebootNum ] do if [[ $deviceId =~ \"null\" ]];then echo \"reboot test num\" $i adb reboot else echo \"reboot \"$deviceId\" test num \"$i adb -s $deviceId reboot fi sleep $rebootInterval let i++ done ","date":"2024-11-06","objectID":"/posts/%E8%87%AA%E5%8A%A8%E5%BC%80%E5%85%B3%E6%9C%BA%E8%84%9A%E6%9C%AC/:0:0","tags":["blog","æµ‹è¯•å·¥å…·"],"title":"è‡ªåŠ¨å¼€å…³æœºè„šæœ¬","uri":"/posts/%E8%87%AA%E5%8A%A8%E5%BC%80%E5%85%B3%E6%9C%BA%E8%84%9A%E6%9C%AC/#"},{"categories":["å­¦ä¹ æ€»ç»“","AMS"],"collections":["AMS"],"content":"AMSä¸­Activityæ ˆç®¡ç† ","date":"2024-11-06","objectID":"/posts/app-%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/:0:1","tags":["blog","Framework","AMS"],"title":"APP  å¯åŠ¨è¿‡ç¨‹","uri":"/posts/app-%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/#amsä¸­activityæ ˆç®¡ç†"},{"categories":["å­¦ä¹ æ€»ç»“","AMS"],"collections":["AMS"],"content":"WMSä¸­appçš„æ·»åŠ è¿‡ç¨‹ windows å±‚çº§æ ‘ æ·»åŠ Task ä¸‹ windowstateçš„å †æ ˆ æ·»åŠ DefaultTaskDisplayArea 02-23 14:36:19.116 565 I test2 : DefaultTaskDisplayArea@243571827 addChild child = Task{a13d730 #1 type=home ?? U=0 visible=false visibleRequested=false mode=undefined translucent=true sz=0} 02-23 14:36:19.116 565 I test2 : java.lang.Exception 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.WindowContainer.addChild(WindowContainer.java:727) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.TaskDisplayArea.addChildTask(TaskDisplayArea.java:334) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.TaskDisplayArea.addChild(TaskDisplayArea.java:320) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.Task$Builder.build(Task.java:6551) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.TaskDisplayArea.createRootTask(TaskDisplayArea.java:1066) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.TaskDisplayArea.createRootTask(TaskDisplayArea.java:1040) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.TaskDisplayArea.getOrCreateRootHomeTask(TaskDisplayArea.java:1640) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.RootWindowContainer.setWindowManager(RootWindowContainer.java:1321) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.ActivityTaskManagerService.setWindowManager(ActivityTaskManagerService.java:1006) 02-23 14:36:19.116 565 I test2 : at com.android.server.am.ActivityManagerService.setWindowManager(ActivityManagerService.java:1923) 02-23 14:36:19.116 565 I test2 : at com.android.server.SystemServer.startOtherServices(SystemServer.java:1595) 02-23 14:36:19.116 565 I test2 : at com.android.server.SystemServer.run(SystemServer.java:939) 02-23 14:36:19.116 565 I test2 : at com.android.server.SystemServer.main(SystemServer.java:649) 02-23 14:36:19.116 565 I test2 : at java.lang.reflect.Method.invoke(Native Method) æ·»åŠ Task 14:36:22.676 Task{a13d730 #1 type=home ?? U=0 visible=true visibleRequested=false mode=fullscreen translucent=true sz=0} addChild Comparator child = Task{63f31d4 #2 type=undefined A=1000:com.android.settings.FallbackHome U=0 visible=false quested=false mode=undefined translucent=true sz=0} 14:36:22.676 java.lang.Exception 14:36:22.676 at com.android.server.wm.WindowContainer.addChild(WindowContainer.java:694) 14:36:22.676 at com.android.server.wm.Task.addChild(Task.java:5935) 14:36:22.676 at com.android.server.wm.Task.-$$Nest$maddChild(Unknown Source:0) 14:36:22.676 at com.android.server.wm.Task$Builder.build(Task.java:6548) 14:36:22.676 at com.android.server.wm.Task.reuseOrCreateTask(Task.java:5819) 14:36:22.676 at com.android.server.wm.ActivityStarter.setNewTask(ActivityStarter.java:2872) 14:36:22.676 at com.android.server.wm.ActivityStarter.startActivityInner(ActivityStarter.java:1864) 14:36:22.676 at com.android.server.wm.ActivityStarter.startActivityUnchecked(ActivityStarter.java:1661) 14:36:22.676 at com.android.server.wm.ActivityStarter.executeRequest(ActivityStarter.java:1216) 14:36:22.676 at com.android.server.wm.ActivityStarter.execute(ActivityStarter.java:702) 14:36:22.676 at com.android.server.wm.ActivityStartController.startHomeActivity(ActivityStartController.java:179) 14:36:22.676 at com.android.server.wm.RootWindowContainer.startHomeOnTaskDisplayArea(RootWindowContainer.java:1493) 14:36:22.676 at com.android.server.wm.RootWindowContainer.lambda$startHomeOnDisplay$12$com-android-server-wm-RootWindowContainer(RootWindowContainer.java:1434) 14:36:22.676 at com.android.server.wm.RootWindowContainer$$ExternalSyntheticLambda7.apply(Unknown Source:16) 14:36:22.676 at com.android.server.wm.TaskDisplayArea.reduceOnAllTaskDisplayAreas(TaskDisplayArea.java:513) 14:36:22.676 at com.android.server.wm.DisplayArea.reduceOnAllTaskDisplayAreas(DisplayArea.java:404) 14:36:22.676 at com.android.server.wm.DisplayArea.reduceOnAllTaskDisplayAreas(DisplayArea.java:404) 14:36:22.676 at com.android.server.wm.DisplayArea.reduceOnAllTaskDisplayAreas(DisplayArea.java:404) 14:36:22.676 a","date":"2024-11-06","objectID":"/posts/app-%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/:0:2","tags":["blog","Framework","AMS"],"title":"APP  å¯åŠ¨è¿‡ç¨‹","uri":"/posts/app-%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/#wmsä¸­appçš„æ·»åŠ è¿‡ç¨‹"},{"categories":["å­¦ä¹ æ€»ç»“","AMS"],"collections":["AMS"],"content":"WMSä¸­appçš„æ·»åŠ è¿‡ç¨‹ windows å±‚çº§æ ‘ æ·»åŠ Task ä¸‹ windowstateçš„å †æ ˆ æ·»åŠ DefaultTaskDisplayArea 02-23 14:36:19.116 565 I test2 : DefaultTaskDisplayArea@243571827 addChild child = Task{a13d730 #1 type=home ?? U=0 visible=false visibleRequested=false mode=undefined translucent=true sz=0} 02-23 14:36:19.116 565 I test2 : java.lang.Exception 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.WindowContainer.addChild(WindowContainer.java:727) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.TaskDisplayArea.addChildTask(TaskDisplayArea.java:334) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.TaskDisplayArea.addChild(TaskDisplayArea.java:320) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.Task$Builder.build(Task.java:6551) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.TaskDisplayArea.createRootTask(TaskDisplayArea.java:1066) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.TaskDisplayArea.createRootTask(TaskDisplayArea.java:1040) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.TaskDisplayArea.getOrCreateRootHomeTask(TaskDisplayArea.java:1640) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.RootWindowContainer.setWindowManager(RootWindowContainer.java:1321) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.ActivityTaskManagerService.setWindowManager(ActivityTaskManagerService.java:1006) 02-23 14:36:19.116 565 I test2 : at com.android.server.am.ActivityManagerService.setWindowManager(ActivityManagerService.java:1923) 02-23 14:36:19.116 565 I test2 : at com.android.server.SystemServer.startOtherServices(SystemServer.java:1595) 02-23 14:36:19.116 565 I test2 : at com.android.server.SystemServer.run(SystemServer.java:939) 02-23 14:36:19.116 565 I test2 : at com.android.server.SystemServer.main(SystemServer.java:649) 02-23 14:36:19.116 565 I test2 : at java.lang.reflect.Method.invoke(Native Method) æ·»åŠ Task 14:36:22.676 Task{a13d730 #1 type=home ?? U=0 visible=true visibleRequested=false mode=fullscreen translucent=true sz=0} addChild Comparator child = Task{63f31d4 #2 type=undefined A=1000:com.android.settings.FallbackHome U=0 visible=false quested=false mode=undefined translucent=true sz=0} 14:36:22.676 java.lang.Exception 14:36:22.676 at com.android.server.wm.WindowContainer.addChild(WindowContainer.java:694) 14:36:22.676 at com.android.server.wm.Task.addChild(Task.java:5935) 14:36:22.676 at com.android.server.wm.Task.-$$Nest$maddChild(Unknown Source:0) 14:36:22.676 at com.android.server.wm.Task$Builder.build(Task.java:6548) 14:36:22.676 at com.android.server.wm.Task.reuseOrCreateTask(Task.java:5819) 14:36:22.676 at com.android.server.wm.ActivityStarter.setNewTask(ActivityStarter.java:2872) 14:36:22.676 at com.android.server.wm.ActivityStarter.startActivityInner(ActivityStarter.java:1864) 14:36:22.676 at com.android.server.wm.ActivityStarter.startActivityUnchecked(ActivityStarter.java:1661) 14:36:22.676 at com.android.server.wm.ActivityStarter.executeRequest(ActivityStarter.java:1216) 14:36:22.676 at com.android.server.wm.ActivityStarter.execute(ActivityStarter.java:702) 14:36:22.676 at com.android.server.wm.ActivityStartController.startHomeActivity(ActivityStartController.java:179) 14:36:22.676 at com.android.server.wm.RootWindowContainer.startHomeOnTaskDisplayArea(RootWindowContainer.java:1493) 14:36:22.676 at com.android.server.wm.RootWindowContainer.lambda$startHomeOnDisplay$12$com-android-server-wm-RootWindowContainer(RootWindowContainer.java:1434) 14:36:22.676 at com.android.server.wm.RootWindowContainer$$ExternalSyntheticLambda7.apply(Unknown Source:16) 14:36:22.676 at com.android.server.wm.TaskDisplayArea.reduceOnAllTaskDisplayAreas(TaskDisplayArea.java:513) 14:36:22.676 at com.android.server.wm.DisplayArea.reduceOnAllTaskDisplayAreas(DisplayArea.java:404) 14:36:22.676 at com.android.server.wm.DisplayArea.reduceOnAllTaskDisplayAreas(DisplayArea.java:404) 14:36:22.676 at com.android.server.wm.DisplayArea.reduceOnAllTaskDisplayAreas(DisplayArea.java:404) 14:36:22.676 a","date":"2024-11-06","objectID":"/posts/app-%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/:0:2","tags":["blog","Framework","AMS"],"title":"APP  å¯åŠ¨è¿‡ç¨‹","uri":"/posts/app-%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/#windows-å±‚çº§æ ‘"},{"categories":["å­¦ä¹ æ€»ç»“","AMS"],"collections":["AMS"],"content":"WMSä¸­appçš„æ·»åŠ è¿‡ç¨‹ windows å±‚çº§æ ‘ æ·»åŠ Task ä¸‹ windowstateçš„å †æ ˆ æ·»åŠ DefaultTaskDisplayArea 02-23 14:36:19.116 565 I test2 : DefaultTaskDisplayArea@243571827 addChild child = Task{a13d730 #1 type=home ?? U=0 visible=false visibleRequested=false mode=undefined translucent=true sz=0} 02-23 14:36:19.116 565 I test2 : java.lang.Exception 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.WindowContainer.addChild(WindowContainer.java:727) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.TaskDisplayArea.addChildTask(TaskDisplayArea.java:334) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.TaskDisplayArea.addChild(TaskDisplayArea.java:320) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.Task$Builder.build(Task.java:6551) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.TaskDisplayArea.createRootTask(TaskDisplayArea.java:1066) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.TaskDisplayArea.createRootTask(TaskDisplayArea.java:1040) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.TaskDisplayArea.getOrCreateRootHomeTask(TaskDisplayArea.java:1640) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.RootWindowContainer.setWindowManager(RootWindowContainer.java:1321) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.ActivityTaskManagerService.setWindowManager(ActivityTaskManagerService.java:1006) 02-23 14:36:19.116 565 I test2 : at com.android.server.am.ActivityManagerService.setWindowManager(ActivityManagerService.java:1923) 02-23 14:36:19.116 565 I test2 : at com.android.server.SystemServer.startOtherServices(SystemServer.java:1595) 02-23 14:36:19.116 565 I test2 : at com.android.server.SystemServer.run(SystemServer.java:939) 02-23 14:36:19.116 565 I test2 : at com.android.server.SystemServer.main(SystemServer.java:649) 02-23 14:36:19.116 565 I test2 : at java.lang.reflect.Method.invoke(Native Method) æ·»åŠ Task 14:36:22.676 Task{a13d730 #1 type=home ?? U=0 visible=true visibleRequested=false mode=fullscreen translucent=true sz=0} addChild Comparator child = Task{63f31d4 #2 type=undefined A=1000:com.android.settings.FallbackHome U=0 visible=false quested=false mode=undefined translucent=true sz=0} 14:36:22.676 java.lang.Exception 14:36:22.676 at com.android.server.wm.WindowContainer.addChild(WindowContainer.java:694) 14:36:22.676 at com.android.server.wm.Task.addChild(Task.java:5935) 14:36:22.676 at com.android.server.wm.Task.-$$Nest$maddChild(Unknown Source:0) 14:36:22.676 at com.android.server.wm.Task$Builder.build(Task.java:6548) 14:36:22.676 at com.android.server.wm.Task.reuseOrCreateTask(Task.java:5819) 14:36:22.676 at com.android.server.wm.ActivityStarter.setNewTask(ActivityStarter.java:2872) 14:36:22.676 at com.android.server.wm.ActivityStarter.startActivityInner(ActivityStarter.java:1864) 14:36:22.676 at com.android.server.wm.ActivityStarter.startActivityUnchecked(ActivityStarter.java:1661) 14:36:22.676 at com.android.server.wm.ActivityStarter.executeRequest(ActivityStarter.java:1216) 14:36:22.676 at com.android.server.wm.ActivityStarter.execute(ActivityStarter.java:702) 14:36:22.676 at com.android.server.wm.ActivityStartController.startHomeActivity(ActivityStartController.java:179) 14:36:22.676 at com.android.server.wm.RootWindowContainer.startHomeOnTaskDisplayArea(RootWindowContainer.java:1493) 14:36:22.676 at com.android.server.wm.RootWindowContainer.lambda$startHomeOnDisplay$12$com-android-server-wm-RootWindowContainer(RootWindowContainer.java:1434) 14:36:22.676 at com.android.server.wm.RootWindowContainer$$ExternalSyntheticLambda7.apply(Unknown Source:16) 14:36:22.676 at com.android.server.wm.TaskDisplayArea.reduceOnAllTaskDisplayAreas(TaskDisplayArea.java:513) 14:36:22.676 at com.android.server.wm.DisplayArea.reduceOnAllTaskDisplayAreas(DisplayArea.java:404) 14:36:22.676 at com.android.server.wm.DisplayArea.reduceOnAllTaskDisplayAreas(DisplayArea.java:404) 14:36:22.676 at com.android.server.wm.DisplayArea.reduceOnAllTaskDisplayAreas(DisplayArea.java:404) 14:36:22.676 a","date":"2024-11-06","objectID":"/posts/app-%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/:0:2","tags":["blog","Framework","AMS"],"title":"APP  å¯åŠ¨è¿‡ç¨‹","uri":"/posts/app-%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/#æ·»åŠ task-ä¸‹-windowstateçš„å †æ ˆ"},{"categories":["å­¦ä¹ æ€»ç»“","AMS"],"collections":["AMS"],"content":"WMSä¸­appçš„æ·»åŠ è¿‡ç¨‹ windows å±‚çº§æ ‘ æ·»åŠ Task ä¸‹ windowstateçš„å †æ ˆ æ·»åŠ DefaultTaskDisplayArea 02-23 14:36:19.116 565 I test2 : DefaultTaskDisplayArea@243571827 addChild child = Task{a13d730 #1 type=home ?? U=0 visible=false visibleRequested=false mode=undefined translucent=true sz=0} 02-23 14:36:19.116 565 I test2 : java.lang.Exception 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.WindowContainer.addChild(WindowContainer.java:727) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.TaskDisplayArea.addChildTask(TaskDisplayArea.java:334) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.TaskDisplayArea.addChild(TaskDisplayArea.java:320) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.Task$Builder.build(Task.java:6551) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.TaskDisplayArea.createRootTask(TaskDisplayArea.java:1066) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.TaskDisplayArea.createRootTask(TaskDisplayArea.java:1040) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.TaskDisplayArea.getOrCreateRootHomeTask(TaskDisplayArea.java:1640) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.RootWindowContainer.setWindowManager(RootWindowContainer.java:1321) 02-23 14:36:19.116 565 I test2 : at com.android.server.wm.ActivityTaskManagerService.setWindowManager(ActivityTaskManagerService.java:1006) 02-23 14:36:19.116 565 I test2 : at com.android.server.am.ActivityManagerService.setWindowManager(ActivityManagerService.java:1923) 02-23 14:36:19.116 565 I test2 : at com.android.server.SystemServer.startOtherServices(SystemServer.java:1595) 02-23 14:36:19.116 565 I test2 : at com.android.server.SystemServer.run(SystemServer.java:939) 02-23 14:36:19.116 565 I test2 : at com.android.server.SystemServer.main(SystemServer.java:649) 02-23 14:36:19.116 565 I test2 : at java.lang.reflect.Method.invoke(Native Method) æ·»åŠ Task 14:36:22.676 Task{a13d730 #1 type=home ?? U=0 visible=true visibleRequested=false mode=fullscreen translucent=true sz=0} addChild Comparator child = Task{63f31d4 #2 type=undefined A=1000:com.android.settings.FallbackHome U=0 visible=false quested=false mode=undefined translucent=true sz=0} 14:36:22.676 java.lang.Exception 14:36:22.676 at com.android.server.wm.WindowContainer.addChild(WindowContainer.java:694) 14:36:22.676 at com.android.server.wm.Task.addChild(Task.java:5935) 14:36:22.676 at com.android.server.wm.Task.-$$Nest$maddChild(Unknown Source:0) 14:36:22.676 at com.android.server.wm.Task$Builder.build(Task.java:6548) 14:36:22.676 at com.android.server.wm.Task.reuseOrCreateTask(Task.java:5819) 14:36:22.676 at com.android.server.wm.ActivityStarter.setNewTask(ActivityStarter.java:2872) 14:36:22.676 at com.android.server.wm.ActivityStarter.startActivityInner(ActivityStarter.java:1864) 14:36:22.676 at com.android.server.wm.ActivityStarter.startActivityUnchecked(ActivityStarter.java:1661) 14:36:22.676 at com.android.server.wm.ActivityStarter.executeRequest(ActivityStarter.java:1216) 14:36:22.676 at com.android.server.wm.ActivityStarter.execute(ActivityStarter.java:702) 14:36:22.676 at com.android.server.wm.ActivityStartController.startHomeActivity(ActivityStartController.java:179) 14:36:22.676 at com.android.server.wm.RootWindowContainer.startHomeOnTaskDisplayArea(RootWindowContainer.java:1493) 14:36:22.676 at com.android.server.wm.RootWindowContainer.lambda$startHomeOnDisplay$12$com-android-server-wm-RootWindowContainer(RootWindowContainer.java:1434) 14:36:22.676 at com.android.server.wm.RootWindowContainer$$ExternalSyntheticLambda7.apply(Unknown Source:16) 14:36:22.676 at com.android.server.wm.TaskDisplayArea.reduceOnAllTaskDisplayAreas(TaskDisplayArea.java:513) 14:36:22.676 at com.android.server.wm.DisplayArea.reduceOnAllTaskDisplayAreas(DisplayArea.java:404) 14:36:22.676 at com.android.server.wm.DisplayArea.reduceOnAllTaskDisplayAreas(DisplayArea.java:404) 14:36:22.676 at com.android.server.wm.DisplayArea.reduceOnAllTaskDisplayAreas(DisplayArea.java:404) 14:36:22.676 a","date":"2024-11-06","objectID":"/posts/app-%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/:0:2","tags":["blog","Framework","AMS"],"title":"APP  å¯åŠ¨è¿‡ç¨‹","uri":"/posts/app-%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/#æœ€ç»ˆçš„windowstate-æŒ‚è½½æ•°æ®"},{"categories":null,"collections":["PMS"],"content":"èƒŒæ™¯ï¼š Android12é«˜ç‰ˆæœ¬ä»¥åç³»ç»Ÿç”Ÿæˆçš„å¾ˆå¤šdataè·¯å¾„ä¸‹çš„xmléƒ½å˜æˆäº†äºŒè¿›åˆ¶ç±»å‹ å…·ä½“åŸå› åˆ†æ ä»£ç è·¯å¾„ï¼š frameworks/base/core/java/android/util/Xml.java ä½¿ç”¨BinaryXmlSerializeræœ€é‡è¦åŸå› æ˜¯ï¼š 1ã€å¯ä»¥æœ‰æ›´å¿«çš„é€Ÿåº¦ 2ã€æ›´å°çš„ä½“ç§¯ å¦‚ä½•æŠŠäºŒè¿›åˆ¶å˜æˆæ­£å¸¸å¯è¯»xml æ–¹æ³•1ï¼š é€‚åˆdebugç­‰ç‰ˆæœ¬ä¸Šï¼Œå¯ä»¥éšæ„è¿›è¡Œæ¢å¤å‡ºå‚åˆ é™¤ç›¸å…³çš„xmlçš„åœºæ™¯ å…·ä½“æ“ä½œï¼š æ”¹å˜å±æ€§ï¼Œåˆ é™¤åŸæ¥çš„xmlï¼Œæˆ–è€…æ¢å¤å‡ºå‚ï¼Œè®©ç³»ç»Ÿé‡æ–°ç”Ÿæˆxmlï¼Œ å±æ€§ä¿®æ”¹å¦‚ä¸‹ï¼š adb shell setprop persist.sys.binary_xml false ä¿®æ”¹ååœ¨æŠŠç›¸å…³çš„xmlè¦è¿›è¡Œåˆ é™¤é‡å¯è§¦å‘é‡æ–°ç”Ÿæˆxml æ–¹æ³•2ï¼š è¿™ç§å±äºå·²æœ‰äº†è¿™ç§äºŒè¿›åˆ¶æ ¼å¼çš„xmlï¼Œä¹Ÿä¸æƒ³æ¸…é™¤è¿™ä¸ªxmlè®©é‡æ–°ç”Ÿæˆï¼Œå› ä¸ºè¿™æ ·å¯èƒ½é‡æ–°ç”Ÿæˆçš„æ•°æ®å°±ä¸æ˜¯åŸæ¥xmlçš„æ•°æ®ã€‚ æ‰€ä»¥å¾—è€ƒè™‘æŠŠåŸæ¥çš„äºŒè¿›åˆ¶æ ¼å¼çš„xml è½¬åŒ–æˆå¯è¯»xmlæ–‡ä»¶ Androidç³»ç»Ÿä¸­æœ‰ä¸€éƒ¨åˆ†xmlæ˜¯äºŒè¿›åˆ¶åŠ å¯†ä¿å­˜çš„ï¼Œå½“æˆ‘é—¨ç”¨adb pullå¯¼å‡ºæŸ¥çœ‹çš„æ—¶å€™å‘ç°æ˜¯ä¹±ç ï¼Œä¸ç”¨æ…Œï¼Œä¸‹é¢æˆ‘ç»™å¤§å®¶ä»‹ç»å®‰å“ç³»ç»Ÿè‡ªå¸¦çš„xmlåŠ è§£å¯†å·¥å…·ï¼Œä½äº /system/binä¸‹ï¼Œæœ‰abx2xmlå’Œxml2abx Android xmläºŒè¿›åˆ¶è§£å‹ usage: abx2xml [-i] input [output] adb shell abx2xml zipsrc.xml output.xml //æ³¨æ„ï¼šå¯è¿›å…¥åˆ°æ–‡ä»¶æ‰€åœ¨ç›®å½•è¿›è¡Œæ“ä½œï¼Œä¹Ÿå¯ä»¥å¤åˆ¶æ–‡ä»¶åˆ°sdcardè¿›è¡Œæ“ä½œ //ä¾‹å¦‚æˆ‘ä»¬è¦æŸ¥çœ‹sdcardä¸‹çš„AndroidDemoZip.xml,æ‰‹åŠ¨ä¸æŒ‡å®šè¾“å‡ºè·¯å¾„ï¼Œé»˜è®¤è¦†ç›–å½“å‰XML 1ã€adb shell 2ã€cd sdcard 3ã€abx2xml AndroidDemoZip.xml output.xml Android xmlå‹ç¼©äºŒè¿›åˆ¶ usage: xml2abx [-i] input [output] adb shell xml2abx inputsrc.xml zipsrc.xml //ç”¨æ³•è·Ÿè§£å‹åŒç† æºç ä½ç½®ï¼š ~/Downloads/Study/Code/LA.QSSI.12.0.r1/frameworks/base/cmds/abx % ll total 56 drwxrwxr-x@ 9 huangwentao staff 288 12 31 2021 . drwxrwxr-x 35 huangwentao staff 1120 9 23 17:45 .. -rw-rw-r-- 1 huangwentao staff 637 12 31 2021 Android.bp -rw-rw-r-- 1 huangwentao staff 0 12 31 2021 MODULE_LICENSE_APACHE2 -rw-rw-r-- 1 huangwentao staff 10694 12 31 2021 NOTICE -rwxrwxr-x 1 huangwentao staff 128 12 31 2021 abx -rwxrwxr-x 1 huangwentao staff 128 12 31 2021 abx2xml drwxrwxr-x 3 huangwentao staff 96 12 31 2021 src -rwxrwxr-x 1 huangwentao staff 128 12 31 2021 xml2abx xml2abx ./system/users/0/appwidgets-read.xml ./system/users/0/appwidgets-binary.xml abx2xml ./system/users/0/appwidgets.xml ./system/users/0/appwidgets-read.xml ","date":"2024-11-06","objectID":"/posts/xml-%E6%A0%BC%E5%BC%8F-%E7%9B%B8%E5%85%B3/:0:0","tags":["blog","PMS","tools"],"title":"xml æ ¼å¼ ç›¸å…³","uri":"/posts/xml-%E6%A0%BC%E5%BC%8F-%E7%9B%B8%E5%85%B3/#"},{"categories":null,"collections":["PMS"],"content":"èƒŒæ™¯ï¼š Android12é«˜ç‰ˆæœ¬ä»¥åç³»ç»Ÿç”Ÿæˆçš„å¾ˆå¤šdataè·¯å¾„ä¸‹çš„xmléƒ½å˜æˆäº†äºŒè¿›åˆ¶ç±»å‹ å…·ä½“åŸå› åˆ†æ ä»£ç è·¯å¾„ï¼š frameworks/base/core/java/android/util/Xml.java ä½¿ç”¨BinaryXmlSerializeræœ€é‡è¦åŸå› æ˜¯ï¼š 1ã€å¯ä»¥æœ‰æ›´å¿«çš„é€Ÿåº¦ 2ã€æ›´å°çš„ä½“ç§¯ å¦‚ä½•æŠŠäºŒè¿›åˆ¶å˜æˆæ­£å¸¸å¯è¯»xml æ–¹æ³•1ï¼š é€‚åˆdebugç­‰ç‰ˆæœ¬ä¸Šï¼Œå¯ä»¥éšæ„è¿›è¡Œæ¢å¤å‡ºå‚åˆ é™¤ç›¸å…³çš„xmlçš„åœºæ™¯ å…·ä½“æ“ä½œï¼š æ”¹å˜å±æ€§ï¼Œåˆ é™¤åŸæ¥çš„xmlï¼Œæˆ–è€…æ¢å¤å‡ºå‚ï¼Œè®©ç³»ç»Ÿé‡æ–°ç”Ÿæˆxmlï¼Œ å±æ€§ä¿®æ”¹å¦‚ä¸‹ï¼š adb shell setprop persist.sys.binary_xml false ä¿®æ”¹ååœ¨æŠŠç›¸å…³çš„xmlè¦è¿›è¡Œåˆ é™¤é‡å¯è§¦å‘é‡æ–°ç”Ÿæˆxml æ–¹æ³•2ï¼š è¿™ç§å±äºå·²æœ‰äº†è¿™ç§äºŒè¿›åˆ¶æ ¼å¼çš„xmlï¼Œä¹Ÿä¸æƒ³æ¸…é™¤è¿™ä¸ªxmlè®©é‡æ–°ç”Ÿæˆï¼Œå› ä¸ºè¿™æ ·å¯èƒ½é‡æ–°ç”Ÿæˆçš„æ•°æ®å°±ä¸æ˜¯åŸæ¥xmlçš„æ•°æ®ã€‚ æ‰€ä»¥å¾—è€ƒè™‘æŠŠåŸæ¥çš„äºŒè¿›åˆ¶æ ¼å¼çš„xml è½¬åŒ–æˆå¯è¯»xmlæ–‡ä»¶ Androidç³»ç»Ÿä¸­æœ‰ä¸€éƒ¨åˆ†xmlæ˜¯äºŒè¿›åˆ¶åŠ å¯†ä¿å­˜çš„ï¼Œå½“æˆ‘é—¨ç”¨adb pullå¯¼å‡ºæŸ¥çœ‹çš„æ—¶å€™å‘ç°æ˜¯ä¹±ç ï¼Œä¸ç”¨æ…Œï¼Œä¸‹é¢æˆ‘ç»™å¤§å®¶ä»‹ç»å®‰å“ç³»ç»Ÿè‡ªå¸¦çš„xmlåŠ è§£å¯†å·¥å…·ï¼Œä½äº /system/binä¸‹ï¼Œæœ‰abx2xmlå’Œxml2abx Android xmläºŒè¿›åˆ¶è§£å‹ usage: abx2xml [-i] input [output] adb shell abx2xml zipsrc.xml output.xml //æ³¨æ„ï¼šå¯è¿›å…¥åˆ°æ–‡ä»¶æ‰€åœ¨ç›®å½•è¿›è¡Œæ“ä½œï¼Œä¹Ÿå¯ä»¥å¤åˆ¶æ–‡ä»¶åˆ°sdcardè¿›è¡Œæ“ä½œ //ä¾‹å¦‚æˆ‘ä»¬è¦æŸ¥çœ‹sdcardä¸‹çš„AndroidDemoZip.xml,æ‰‹åŠ¨ä¸æŒ‡å®šè¾“å‡ºè·¯å¾„ï¼Œé»˜è®¤è¦†ç›–å½“å‰XML 1ã€adb shell 2ã€cd sdcard 3ã€abx2xml AndroidDemoZip.xml output.xml Android xmlå‹ç¼©äºŒè¿›åˆ¶ usage: xml2abx [-i] input [output] adb shell xml2abx inputsrc.xml zipsrc.xml //ç”¨æ³•è·Ÿè§£å‹åŒç† æºç ä½ç½®ï¼š ~/Downloads/Study/Code/LA.QSSI.12.0.r1/frameworks/base/cmds/abx % ll total 56 drwxrwxr-x@ 9 huangwentao staff 288 12 31 2021 . drwxrwxr-x 35 huangwentao staff 1120 9 23 17:45 .. -rw-rw-r-- 1 huangwentao staff 637 12 31 2021 Android.bp -rw-rw-r-- 1 huangwentao staff 0 12 31 2021 MODULE_LICENSE_APACHE2 -rw-rw-r-- 1 huangwentao staff 10694 12 31 2021 NOTICE -rwxrwxr-x 1 huangwentao staff 128 12 31 2021 abx -rwxrwxr-x 1 huangwentao staff 128 12 31 2021 abx2xml drwxrwxr-x 3 huangwentao staff 96 12 31 2021 src -rwxrwxr-x 1 huangwentao staff 128 12 31 2021 xml2abx xml2abx ./system/users/0/appwidgets-read.xml ./system/users/0/appwidgets-binary.xml abx2xml ./system/users/0/appwidgets.xml ./system/users/0/appwidgets-read.xml ","date":"2024-11-06","objectID":"/posts/xml-%E6%A0%BC%E5%BC%8F-%E7%9B%B8%E5%85%B3/:0:0","tags":["blog","PMS","tools"],"title":"xml æ ¼å¼ ç›¸å…³","uri":"/posts/xml-%E6%A0%BC%E5%BC%8F-%E7%9B%B8%E5%85%B3/#èƒŒæ™¯"},{"categories":null,"collections":["PMS"],"content":"èƒŒæ™¯ï¼š Android12é«˜ç‰ˆæœ¬ä»¥åç³»ç»Ÿç”Ÿæˆçš„å¾ˆå¤šdataè·¯å¾„ä¸‹çš„xmléƒ½å˜æˆäº†äºŒè¿›åˆ¶ç±»å‹ å…·ä½“åŸå› åˆ†æ ä»£ç è·¯å¾„ï¼š frameworks/base/core/java/android/util/Xml.java ä½¿ç”¨BinaryXmlSerializeræœ€é‡è¦åŸå› æ˜¯ï¼š 1ã€å¯ä»¥æœ‰æ›´å¿«çš„é€Ÿåº¦ 2ã€æ›´å°çš„ä½“ç§¯ å¦‚ä½•æŠŠäºŒè¿›åˆ¶å˜æˆæ­£å¸¸å¯è¯»xml æ–¹æ³•1ï¼š é€‚åˆdebugç­‰ç‰ˆæœ¬ä¸Šï¼Œå¯ä»¥éšæ„è¿›è¡Œæ¢å¤å‡ºå‚åˆ é™¤ç›¸å…³çš„xmlçš„åœºæ™¯ å…·ä½“æ“ä½œï¼š æ”¹å˜å±æ€§ï¼Œåˆ é™¤åŸæ¥çš„xmlï¼Œæˆ–è€…æ¢å¤å‡ºå‚ï¼Œè®©ç³»ç»Ÿé‡æ–°ç”Ÿæˆxmlï¼Œ å±æ€§ä¿®æ”¹å¦‚ä¸‹ï¼š adb shell setprop persist.sys.binary_xml false ä¿®æ”¹ååœ¨æŠŠç›¸å…³çš„xmlè¦è¿›è¡Œåˆ é™¤é‡å¯è§¦å‘é‡æ–°ç”Ÿæˆxml æ–¹æ³•2ï¼š è¿™ç§å±äºå·²æœ‰äº†è¿™ç§äºŒè¿›åˆ¶æ ¼å¼çš„xmlï¼Œä¹Ÿä¸æƒ³æ¸…é™¤è¿™ä¸ªxmlè®©é‡æ–°ç”Ÿæˆï¼Œå› ä¸ºè¿™æ ·å¯èƒ½é‡æ–°ç”Ÿæˆçš„æ•°æ®å°±ä¸æ˜¯åŸæ¥xmlçš„æ•°æ®ã€‚ æ‰€ä»¥å¾—è€ƒè™‘æŠŠåŸæ¥çš„äºŒè¿›åˆ¶æ ¼å¼çš„xml è½¬åŒ–æˆå¯è¯»xmlæ–‡ä»¶ Androidç³»ç»Ÿä¸­æœ‰ä¸€éƒ¨åˆ†xmlæ˜¯äºŒè¿›åˆ¶åŠ å¯†ä¿å­˜çš„ï¼Œå½“æˆ‘é—¨ç”¨adb pullå¯¼å‡ºæŸ¥çœ‹çš„æ—¶å€™å‘ç°æ˜¯ä¹±ç ï¼Œä¸ç”¨æ…Œï¼Œä¸‹é¢æˆ‘ç»™å¤§å®¶ä»‹ç»å®‰å“ç³»ç»Ÿè‡ªå¸¦çš„xmlåŠ è§£å¯†å·¥å…·ï¼Œä½äº /system/binä¸‹ï¼Œæœ‰abx2xmlå’Œxml2abx Android xmläºŒè¿›åˆ¶è§£å‹ usage: abx2xml [-i] input [output] adb shell abx2xml zipsrc.xml output.xml //æ³¨æ„ï¼šå¯è¿›å…¥åˆ°æ–‡ä»¶æ‰€åœ¨ç›®å½•è¿›è¡Œæ“ä½œï¼Œä¹Ÿå¯ä»¥å¤åˆ¶æ–‡ä»¶åˆ°sdcardè¿›è¡Œæ“ä½œ //ä¾‹å¦‚æˆ‘ä»¬è¦æŸ¥çœ‹sdcardä¸‹çš„AndroidDemoZip.xml,æ‰‹åŠ¨ä¸æŒ‡å®šè¾“å‡ºè·¯å¾„ï¼Œé»˜è®¤è¦†ç›–å½“å‰XML 1ã€adb shell 2ã€cd sdcard 3ã€abx2xml AndroidDemoZip.xml output.xml Android xmlå‹ç¼©äºŒè¿›åˆ¶ usage: xml2abx [-i] input [output] adb shell xml2abx inputsrc.xml zipsrc.xml //ç”¨æ³•è·Ÿè§£å‹åŒç† æºç ä½ç½®ï¼š ~/Downloads/Study/Code/LA.QSSI.12.0.r1/frameworks/base/cmds/abx % ll total 56 drwxrwxr-x@ 9 huangwentao staff 288 12 31 2021 . drwxrwxr-x 35 huangwentao staff 1120 9 23 17:45 .. -rw-rw-r-- 1 huangwentao staff 637 12 31 2021 Android.bp -rw-rw-r-- 1 huangwentao staff 0 12 31 2021 MODULE_LICENSE_APACHE2 -rw-rw-r-- 1 huangwentao staff 10694 12 31 2021 NOTICE -rwxrwxr-x 1 huangwentao staff 128 12 31 2021 abx -rwxrwxr-x 1 huangwentao staff 128 12 31 2021 abx2xml drwxrwxr-x 3 huangwentao staff 96 12 31 2021 src -rwxrwxr-x 1 huangwentao staff 128 12 31 2021 xml2abx xml2abx ./system/users/0/appwidgets-read.xml ./system/users/0/appwidgets-binary.xml abx2xml ./system/users/0/appwidgets.xml ./system/users/0/appwidgets-read.xml ","date":"2024-11-06","objectID":"/posts/xml-%E6%A0%BC%E5%BC%8F-%E7%9B%B8%E5%85%B3/:0:0","tags":["blog","PMS","tools"],"title":"xml æ ¼å¼ ç›¸å…³","uri":"/posts/xml-%E6%A0%BC%E5%BC%8F-%E7%9B%B8%E5%85%B3/#å…·ä½“åŸå› åˆ†æ"},{"categories":null,"collections":["PMS"],"content":"èƒŒæ™¯ï¼š Android12é«˜ç‰ˆæœ¬ä»¥åç³»ç»Ÿç”Ÿæˆçš„å¾ˆå¤šdataè·¯å¾„ä¸‹çš„xmléƒ½å˜æˆäº†äºŒè¿›åˆ¶ç±»å‹ å…·ä½“åŸå› åˆ†æ ä»£ç è·¯å¾„ï¼š frameworks/base/core/java/android/util/Xml.java ä½¿ç”¨BinaryXmlSerializeræœ€é‡è¦åŸå› æ˜¯ï¼š 1ã€å¯ä»¥æœ‰æ›´å¿«çš„é€Ÿåº¦ 2ã€æ›´å°çš„ä½“ç§¯ å¦‚ä½•æŠŠäºŒè¿›åˆ¶å˜æˆæ­£å¸¸å¯è¯»xml æ–¹æ³•1ï¼š é€‚åˆdebugç­‰ç‰ˆæœ¬ä¸Šï¼Œå¯ä»¥éšæ„è¿›è¡Œæ¢å¤å‡ºå‚åˆ é™¤ç›¸å…³çš„xmlçš„åœºæ™¯ å…·ä½“æ“ä½œï¼š æ”¹å˜å±æ€§ï¼Œåˆ é™¤åŸæ¥çš„xmlï¼Œæˆ–è€…æ¢å¤å‡ºå‚ï¼Œè®©ç³»ç»Ÿé‡æ–°ç”Ÿæˆxmlï¼Œ å±æ€§ä¿®æ”¹å¦‚ä¸‹ï¼š adb shell setprop persist.sys.binary_xml false ä¿®æ”¹ååœ¨æŠŠç›¸å…³çš„xmlè¦è¿›è¡Œåˆ é™¤é‡å¯è§¦å‘é‡æ–°ç”Ÿæˆxml æ–¹æ³•2ï¼š è¿™ç§å±äºå·²æœ‰äº†è¿™ç§äºŒè¿›åˆ¶æ ¼å¼çš„xmlï¼Œä¹Ÿä¸æƒ³æ¸…é™¤è¿™ä¸ªxmlè®©é‡æ–°ç”Ÿæˆï¼Œå› ä¸ºè¿™æ ·å¯èƒ½é‡æ–°ç”Ÿæˆçš„æ•°æ®å°±ä¸æ˜¯åŸæ¥xmlçš„æ•°æ®ã€‚ æ‰€ä»¥å¾—è€ƒè™‘æŠŠåŸæ¥çš„äºŒè¿›åˆ¶æ ¼å¼çš„xml è½¬åŒ–æˆå¯è¯»xmlæ–‡ä»¶ Androidç³»ç»Ÿä¸­æœ‰ä¸€éƒ¨åˆ†xmlæ˜¯äºŒè¿›åˆ¶åŠ å¯†ä¿å­˜çš„ï¼Œå½“æˆ‘é—¨ç”¨adb pullå¯¼å‡ºæŸ¥çœ‹çš„æ—¶å€™å‘ç°æ˜¯ä¹±ç ï¼Œä¸ç”¨æ…Œï¼Œä¸‹é¢æˆ‘ç»™å¤§å®¶ä»‹ç»å®‰å“ç³»ç»Ÿè‡ªå¸¦çš„xmlåŠ è§£å¯†å·¥å…·ï¼Œä½äº /system/binä¸‹ï¼Œæœ‰abx2xmlå’Œxml2abx Android xmläºŒè¿›åˆ¶è§£å‹ usage: abx2xml [-i] input [output] adb shell abx2xml zipsrc.xml output.xml //æ³¨æ„ï¼šå¯è¿›å…¥åˆ°æ–‡ä»¶æ‰€åœ¨ç›®å½•è¿›è¡Œæ“ä½œï¼Œä¹Ÿå¯ä»¥å¤åˆ¶æ–‡ä»¶åˆ°sdcardè¿›è¡Œæ“ä½œ //ä¾‹å¦‚æˆ‘ä»¬è¦æŸ¥çœ‹sdcardä¸‹çš„AndroidDemoZip.xml,æ‰‹åŠ¨ä¸æŒ‡å®šè¾“å‡ºè·¯å¾„ï¼Œé»˜è®¤è¦†ç›–å½“å‰XML 1ã€adb shell 2ã€cd sdcard 3ã€abx2xml AndroidDemoZip.xml output.xml Android xmlå‹ç¼©äºŒè¿›åˆ¶ usage: xml2abx [-i] input [output] adb shell xml2abx inputsrc.xml zipsrc.xml //ç”¨æ³•è·Ÿè§£å‹åŒç† æºç ä½ç½®ï¼š ~/Downloads/Study/Code/LA.QSSI.12.0.r1/frameworks/base/cmds/abx % ll total 56 drwxrwxr-x@ 9 huangwentao staff 288 12 31 2021 . drwxrwxr-x 35 huangwentao staff 1120 9 23 17:45 .. -rw-rw-r-- 1 huangwentao staff 637 12 31 2021 Android.bp -rw-rw-r-- 1 huangwentao staff 0 12 31 2021 MODULE_LICENSE_APACHE2 -rw-rw-r-- 1 huangwentao staff 10694 12 31 2021 NOTICE -rwxrwxr-x 1 huangwentao staff 128 12 31 2021 abx -rwxrwxr-x 1 huangwentao staff 128 12 31 2021 abx2xml drwxrwxr-x 3 huangwentao staff 96 12 31 2021 src -rwxrwxr-x 1 huangwentao staff 128 12 31 2021 xml2abx xml2abx ./system/users/0/appwidgets-read.xml ./system/users/0/appwidgets-binary.xml abx2xml ./system/users/0/appwidgets.xml ./system/users/0/appwidgets-read.xml ","date":"2024-11-06","objectID":"/posts/xml-%E6%A0%BC%E5%BC%8F-%E7%9B%B8%E5%85%B3/:0:0","tags":["blog","PMS","tools"],"title":"xml æ ¼å¼ ç›¸å…³","uri":"/posts/xml-%E6%A0%BC%E5%BC%8F-%E7%9B%B8%E5%85%B3/#å¦‚ä½•æŠŠäºŒè¿›åˆ¶å˜æˆæ­£å¸¸å¯è¯»xml"},{"categories":null,"collections":["AI"],"content":"ç¥ç»ç½‘ç»œå’Œæ·±åº¦å­¦ä¹ ç®€å² March 17, 2024 TL;DR æœ¬æ–‡8200+å­—ï¼Œå…¨æ–‡é˜…è¯»çº¦éœ€15åˆ†é’Ÿã€‚ä»å»å¹´å¼€å§‹ï¼Œæˆ‘è¯»äº†åä½™æœ¬äººå·¥æ™ºèƒ½æ–¹é¢å…¥é—¨çš„ä¹¦ç±ï¼ˆå‚è§æ–‡æœ«é™„2ï¼‰ï¼Œé…é…¿äº†ä¸¤ä¸ªæœˆï¼ŒèŠ±äº†ä¸¤å‘¨æ—¶é—´å†™ä½œæ­¤æ–‡ã€‚æœ¬æ–‡ç®€è¦å›é¡¾äº†ä»æ„ŸçŸ¥æœºåˆ°æ·±åº¦å­¦ä¹ åŠHugging Faceçš„å†å²ï¼Œå¹¶è¯•å›¾ä»¥é€šä¿—çš„è¯­è¨€æ¥ä»‹ç»ç¥ç»ç½‘ç»œå’Œæ·±åº¦å­¦ä¹ çš„åŸç†ã€‚ ç”Ÿæ´»ä¸­æ²¡æœ‰ä»€ä¹ˆå¯æ€•çš„ä¸œè¥¿ï¼Œåªæœ‰éœ€è¦ç†è§£çš„ä¸œè¥¿ã€‚ â€”â€” å±…é‡Œå¤«äºº ","date":"2024-11-06","objectID":"/posts/%E4%BB%8E%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%88%B0-hugging-face/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"ä»ç¥ç»ç½‘ç»œåˆ° Hugging Face","uri":"/posts/%E4%BB%8E%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%88%B0-hugging-face/#ç¥ç»ç½‘ç»œå’Œæ·±åº¦å­¦ä¹ ç®€å²"},{"categories":null,"collections":["AI"],"content":"ä¸€ æ·±åº¦ä¿¡å¿µç½‘ç»œ 2006å¹´ï¼ŒåŠ æ‹¿å¤§å¤šä¼¦å¤šå¤§å­¦æ•™æˆæ°å¼—é‡ŒÂ·è¾›é¡¿åœ¨ç ”ç©¶å¦‚ä½•è®­ç»ƒå¤šå±‚ç¥ç»ç½‘ç»œï¼Œä»–å·²ç»åœ¨ç¥ç»ç½‘ç»œé¢†åŸŸé»˜é»˜è€•è€˜äº†ä¸‰åå¤šå¹´ï¼Œå°½ç®¡åœ¨è¿™ä¸ªé¢†åŸŸä»–ç®—å¾—ä¸Šæ˜¯æ³°æ–—çº§çš„äººç‰©ï¼Œä½†ç”±äºç¥ç»ç½‘ç»œåœ¨äººå·¥æ™ºèƒ½è¡Œä¸šä¸€ç›´ä¸è¢«çœ‹å¥½ï¼Œæ‰€ä»¥ä»–çš„ç ”ç©¶æˆæœä¸€ç›´ä¸ä¸ºä¸šç•Œæ‰€é‡è§†ã€‚ è¾›é¡¿å‡ºç”Ÿäºè‹±å›½ä¼¦æ•¦ï¼Œä»–çš„å®¶æ—å‡ºè¿‡ä¸å°‘çŸ¥åå­¦è€…ï¼Œåˆ›ç«‹å¸ƒå°”ä»£æ•°çš„é€»è¾‘å­¦å®¶ä¹”æ²»Â·å¸ƒå°”ä¾¿æ˜¯ä»–çš„æ›¾æ›¾ç¥–çˆ¶ã€‚ä»–çš„ç¥–çˆ¶æ˜¯ä½ç§‘æ™®ä½œå®¶ï¼Œçˆ¶äº²æ˜¯æ˜†è™«å­¦å®¶ã€‚è¾›é¡¿æ¯”å‘¨å›´çš„äººéƒ½è¦èªæ˜ï¼Œä½†ä»–çš„æ±‚å­¦ä¹‹è·¯å´é¢‡ä¸ºæ›²æŠ˜ï¼Œå…ˆæ˜¯åœ¨å¤§å­¦æ”»è¯»å»ºç­‘å­¦ï¼Œè½¬è€Œåˆé€‰æ‹©ç‰©ç†å­¦ï¼Œååˆæ”¹è¯»å“²å­¦ï¼Œæœ€åä»¥å¿ƒç†å­¦å­¦å£«èº«ä»½æ¯•ä¸šã€‚1972å¹´è¾›é¡¿è¿›å…¥çˆ±ä¸å ¡å¤§å­¦æ”»è¯»åšå£«å­¦ä½ï¼Œç ”ç©¶æ–¹å‘æ˜¯ç¥ç»ç½‘ç»œã€‚å½¼æ—¶ç¥ç»ç½‘ç»œè¢«ä¸šç•Œæ‰€é„™å¤·ï¼Œè¿è¾›é¡¿çš„å¯¼å¸ˆä¹Ÿè®¤ä¸ºè¿™ç©æ„æ²¡ä»€ä¹ˆå®é™…ç”¨é€”ï¼Œä¹Ÿæ²¡æœ‰å‰é€”å¯è¨€ã€‚ä½†è¾›é¡¿å´ä¸ä¸ºæ‰€åŠ¨ï¼Œå¯¹ç¥ç»ç½‘ç»œç ”ç©¶æ€€æœ‰ä¿¡å¿ƒï¼ŒåšæŒè®¤ä¸ºèƒ½å¤Ÿè¯æ˜ç¥ç»ç½‘ç»œçš„ä»·å€¼ï¼Œè¿™ä¸€åšæŒå°±æ˜¯ä¸‰åå¤šå¹´ã€‚ è¾›é¡¿å¹´è½»çš„æ—¶å€™æœ‰ä¸€æ¬¡æ¬ç§»å–æš–å™¨ï¼Œè…°æ¤é—´ç›˜æ»‘è„±äº†ï¼Œæ­¤åä¾¿ä¸€ç›´é¥±å—è…°èƒŒç—…ç—›é—®é¢˜çš„å›°æ‰°ã€‚è¿‘å¹´æ¥ï¼Œé—®é¢˜æ›´ä¸¥é‡äº†ï¼Œå¤§å¤šæ•°æ—¶å€™ï¼Œä»–éœ€è¦å¹³èººç€ä»¥ç¼“è§£ç–¼ç—›ï¼Œè¿™æ„å‘³ç€ä»–ä¸èƒ½å¼€è½¦ï¼Œä¹Ÿä¸èƒ½åé£æœºï¼Œç”šè‡³åœ¨å®éªŒå®¤é‡Œä¼šè§å­¦ç”Ÿæ—¶ï¼Œä¹Ÿè¦å¹³èººåœ¨åŠå…¬å®¤çš„æŠ˜å åºŠä¸Šã€‚èº«ä½“ä¸Šç–¼ç—›çš„æŠ˜ç£¨å¸¦ç»™è¾›é¡¿çš„æ‰“å‡»è¿˜ä¸å¦‚å­¦æœ¯ç ”ç©¶è¢«å†·æ¼ é‚£ä¹ˆå¤§ã€‚æ—©åœ¨1969å¹´ï¼Œæ˜æ–¯åŸºåœ¨ã€Šæ„ŸçŸ¥æœºã€‹ä¸€ä¹¦ä¸­å°±å¯¹å¤šå±‚æ„ŸçŸ¥æœºä¸‹äº†å®šè®ºï¼Œç»™åæ¥çš„ç¥ç»ç½‘ç»œç ”ç©¶ç›–æˆ³ï¼šâ€œå¤šå±‚æ„ŸçŸ¥æœºä¸ä¼šæœ‰å‘å±•å‰æ™¯ï¼Œå› ä¸ºä¸–ç•Œä¸Šæ²¡äººå¯ä»¥å°†å¤šå±‚æ„ŸçŸ¥æœºè®­ç»ƒå¾—è¶³å¤Ÿå¥½ï¼Œå“ªæ€•æ˜¯ä»¤å®ƒå¯ä»¥å­¦ä¼šæœ€ç®€å•çš„å‡½æ•°æ–¹æ³•ã€‚â€ å•å±‚æ„ŸçŸ¥æœºèƒ½åŠ›æœ‰é™ï¼Œè¿â€œå¼‚æˆ–â€è¿™ç§åŸºç¡€çš„åˆ†ç±»é—®é¢˜ä¹Ÿå®ç°ä¸äº†ï¼Œè€Œå¤šå±‚æ„ŸçŸ¥æœºåˆæ²¡æœ‰å¯ç”¨çš„è®­ç»ƒæ–¹æ³•ï¼Œç­‰äºè¯´ç¥ç»ç½‘ç»œçš„ç ”ç©¶æ–¹å‘æ˜¯æ­»è·¯ä¸€æ¡ã€‚ç¥ç»ç½‘ç»œåœ¨ä¸šç•Œè¢«è®¤ä¸ºæ˜¯å­¦æœ¯å¼‚ç«¯ï¼Œæ²¡æœ‰äººç›¸ä¿¡å®ƒå¯ä»¥æˆåŠŸï¼Œå› æ­¤ä¸€èˆ¬å­¦ç”Ÿåœ¨é€‰æ‹©å¯¼å¸ˆçš„æ—¶å€™éƒ½è°¨æ…ç»•å¼€ç¥ç»ç½‘ç»œï¼Œä¸€æ—¶é—´è¾›é¡¿ç”šè‡³éƒ½æ‹›ä¸æ»¡ç ”ç©¶ç”Ÿã€‚ 1983å¹´ï¼Œè¾›é¡¿å‘æ˜ç»å°”å…¹æ›¼æœºï¼Œåæ¥ï¼Œç®€åŒ–åçš„å—é™ç»å°”å…¹æ›¼æœºè¢«åº”ç”¨äºæœºå™¨å­¦ä¹ ï¼Œæˆä¸ºæ·±åº¦ç¥ç»ç½‘ç»œçš„å±‚çº§ç»“æ„åŸºç¡€ã€‚1986å¹´ï¼Œè¾›é¡¿æå‡ºé€‚ç”¨äºå¤šå±‚æ„ŸçŸ¥æœºçš„è¯¯å·®åå‘ä¼ æ’­ç®—æ³•ï¼ˆBPï¼‰ï¼Œè¿™ä¸€ç®—æ³•å¥ å®šäº†åæ¥æ·±åº¦å­¦ä¹ çš„åŸºç¡€ã€‚è¾›é¡¿æ¯éš”ä¸€æ®µæ—¶é—´éƒ½èƒ½å‘æ˜å‡ºæ–°ä¸œè¥¿ï¼Œè€Œä»–ä¹ŸåšæŒå†™äº†ä¸¤ç™¾å¤šç¯‡ç¥ç»ç½‘ç»œç›¸å…³çš„è®ºæ–‡ï¼Œå°½ç®¡è¿™äº›è®ºæ–‡ä¸è¢«å¾…è§ã€‚åˆ°äº†2006å¹´ï¼Œè¾›é¡¿å·²ç»ç§¯ç´¯äº†ä¸°å¯Œçš„ç†è®ºå’Œå®è·µåŸºç¡€ï¼Œè€Œè¿™ä¸€æ¬¡ï¼Œä»–å‘è¡¨çš„è®ºæ–‡å°†æ”¹å˜æ•´ä¸ªæœºå™¨å­¦ä¹ ä¹ƒè‡³æ•´ä¸ªä¸–ç•Œã€‚ è¾›é¡¿å‘ç°ï¼Œæ‹¥æœ‰å¤šä¸ªéšè—å±‚çš„ç¥ç»ç½‘ç»œèƒ½å¤Ÿå…·æœ‰è‡ªåŠ¨æå–ç‰¹å¾å­¦ä¹ çš„èƒ½åŠ›ï¼Œç›¸æ¯”ä¼ ç»Ÿçš„æ‰‹å·¥æå–ç‰¹å¾çš„æœºå™¨å­¦ä¹ æ›´æœ‰æ•ˆæœã€‚å¦å¤–ï¼Œé€šè¿‡é€å±‚é¢„è®­ç»ƒçš„æ–¹å¼å¯ä»¥é™ä½å¤šå±‚ç¥ç»ç½‘ç»œçš„è®­ç»ƒéš¾åº¦ï¼Œè€Œè¿™è§£å†³äº†é•¿æœŸä»¥æ¥å¤šå±‚ç¥ç»ç½‘ç»œè®­ç»ƒçš„éš¾é¢˜ã€‚è¾›é¡¿å°†ä»–çš„ç ”ç©¶æˆæœå‘è¡¨åœ¨ä¸¤ç¯‡è®ºæ–‡ä¸­ï¼Œè€Œå½“æ—¶ç¥ç»ç½‘ç»œä¸€è¯è¢«è®¸å¤šå­¦æœ¯æœŸåˆŠç¼–è¾‘æ‰€æ’æ–¥ï¼Œæœ‰äº›ç¨¿ä»¶çš„æ ‡é¢˜ç”šè‡³å› ä¸ºåŒ…å«â€œç¥ç»ç½‘ç»œâ€å°±ä¼šè¢«é€€å›ã€‚ä¸ºäº†ä¸åˆºæ¿€è¿™äº›äººçš„æ•æ„Ÿç¥ç»ï¼Œè¾›é¡¿å–äº†ä¸ªæ–°åå­—ï¼Œå°†è¯¥æ¨¡å‹å‘½åä¸ºâ€œæ·±åº¦ä¿¡å¿µç½‘ç»œâ€ï¼ˆDeep Belief Networkï¼‰ã€‚ ","date":"2024-11-06","objectID":"/posts/%E4%BB%8E%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%88%B0-hugging-face/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"ä»ç¥ç»ç½‘ç»œåˆ° Hugging Face","uri":"/posts/%E4%BB%8E%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%88%B0-hugging-face/#ä¸€-æ·±åº¦ä¿¡å¿µç½‘ç»œ"},{"categories":null,"collections":["AI"],"content":"äºŒ æ„ŸçŸ¥æœº å…¶å®ç¥ç»ç½‘ç»œçš„ç ”ç©¶å¯ä»¥è¿½æº¯åˆ°ä¸Šä¸–çºªå››åå¹´ä»£ã€‚1940å¹´ï¼Œ17å²çš„æ²ƒå°”ç‰¹Â·çš®èŒ¨åœ¨ä¼Šåˆ©è¯ºä¼Šå¤§å­¦èŠåŠ å“¥åˆ†æ ¡ç»“è¯†äº†42å²çš„æ•™æˆæ²ƒä¼¦Â·éº¦å¡æ´›å…‹ï¼Œä¸€è§å¦‚æ•…ï¼Œä¾¿åŠ å…¥äº†åè€…çš„ç ”ç©¶é¡¹ç›®ï¼šå°è¯•ç”¨ç¥ç»å…ƒç½‘ç»œå»ºç«‹ä¸€ä¸ªåœ¨é€»è¾‘è¿ç®—åŸºç¡€ä¸Šçš„æœºæ¢°æ€§çš„å¤§è„‘æ€ç»´æ¨¡å‹ã€‚ä»–ä»¬ç”¨é€»è¾‘è¿ç®—æ¥æŠ½è±¡äººç±»å¤§è„‘çš„æ€ç»´æ¨¡å‹ï¼Œæå‡ºäº†â€œç¥ç»ç½‘ç»œâ€ï¼ˆNeural Networkï¼‰è¿™ä¸€æ¦‚å¿µï¼Œè€Œç¥ç»å…ƒæ˜¯ç¥ç»ç½‘ç»œä¸­çš„æœ€å°ä¿¡æ¯å¤„ç†å•å…ƒï¼›å¹¶ä¸”ä»–ä»¬å°†ç¥ç»å…ƒçš„å·¥ä½œè¿‡ç¨‹æŠ½è±¡ç®€åŒ–æˆä¸€ä¸ªéå¸¸ç®€å•çš„é€»è¾‘è¿ç®—æ¨¡å‹ï¼Œåæ¥è¿™ä¸ªæ¨¡å‹è¢«å‘½åä¸ºâ€œM-Pç¥ç»å…ƒæ¨¡å‹â€ï¼Œä»¥ä»–ä»¬ä¸¤å§“åçš„é¦–å­—æ¯æ¥å‘½åã€‚ åœ¨è¿™ä¸ªæ¨¡å‹ä¸­ï¼Œä¸€ä¸ªç¥ç»å…ƒä¼šæ¥å—è¿‡ä¸ªæ¥è‡ªäºå…¶ä»–ç¥ç»å…ƒä¼ é€’è¿‡æ¥çš„è¾“å…¥ä¿¡å·ï¼Œä¸åŒçš„è¾“å…¥ä¿¡å·çš„é‡è¦æ€§æœ‰å·®å¼‚ï¼Œè¿™ç§å·®å¼‚å°±é€šè¿‡è¿æ¥ä¸Šçš„â€œæƒé‡â€ï¼ˆweightï¼‰å¤§å°æ¥è¡¨ç¤ºï¼Œè¯¥ç¥ç»å…ƒå°†æ‰€æœ‰è¾“å…¥å€¼æŒ‰ç…§æƒé‡åŠ æƒæ±‚å’Œï¼Œå†å°†ç»“æœè·Ÿç¥ç»å…ƒçš„â€œæ¿€å‘é˜ˆå€¼â€ï¼ˆThresholdï¼‰è¿›è¡Œæ¯”è¾ƒï¼Œä»¥å†³å®šæ˜¯å¦å¯¹å¤–è¾“å‡ºä¿¡å·ã€‚ â€œM-Pæ¨¡å‹â€è¶³å¤Ÿç®€å•ç›´æ¥ï¼Œè€Œä¸”å¯ä»¥é€šè¿‡ç¬¦å·é€»è¾‘æ¥æ¨¡æ‹Ÿå®ç°ï¼Œäººå·¥æ™ºèƒ½ä¸“å®¶ä»¥è¯¥æ¨¡å‹ä¸ºåŸºç¡€ï¼Œæ„å»ºäº†ç¥ç»ç½‘ç»œæ¨¡å‹ï¼Œç”¨æ¥è§£å†³æœºå™¨å­¦ä¹ ä»»åŠ¡ã€‚è¿™é‡Œç®€å•è¯´æ˜ä¸‹äººå·¥æ™ºèƒ½ã€æœºå™¨å­¦ä¹ å’Œæ·±åº¦å­¦ä¹ çš„å…³ç³»ï¼šäººå·¥æ™ºèƒ½å°±æ˜¯ä½¿ç”¨è®¡ç®—æœºæŠ€æœ¯æ¥å®ç°äººç±»æ™ºèƒ½çš„æŠ€æœ¯ï¼Œåœ¨ä¸€èˆ¬æ•™æå®šä¹‰ä¸ºç ”ç©¶ä¸æ„å»ºæ™ºèƒ½ä½“ã€‚æ™ºèƒ½ä½“å°±æ˜¯ Intelligent agentï¼Œæˆ–ç®€ç§° agentï¼Œå®ƒé€šè¿‡æ¨¡ä»¿äººç±»æ€ç»´å’Œè®¤çŸ¥æ¥è§£å†³ç‰¹å®šä»»åŠ¡æˆ–é€šç”¨ä»»åŠ¡ï¼Œè§£å†³ç‰¹æ€§ä»»åŠ¡çš„æ™ºèƒ½ä½“è¢«ç§°ä¸ºå¼±äººå·¥æ™ºèƒ½ï¼Œæˆ–ç‹­ä¹‰äººå·¥æ™ºèƒ½ï¼ˆANIï¼‰ï¼Œè€Œè§£å†³é€šç”¨ä»»åŠ¡çš„æ™ºèƒ½ä½“è¢«ç§°ä¸ºå¼ºäººå·¥æ™ºèƒ½ï¼Œæˆ–é€šç”¨äººå·¥æ™ºèƒ½ï¼ˆAGIï¼‰ã€‚æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œå®ƒé€šè¿‡æ•°æ®è¿›è¡Œå­¦ä¹ å¹¶æ”¹è¿›ç³»ç»Ÿã€‚è€Œæ·±åº¦å­¦ä¹ åˆ™åˆæ˜¯æœºå™¨å­¦ä¹ çš„ä¸€ä¸ªåˆ†æ”¯ï¼Œå®ƒä½¿ç”¨ç¥ç»ç½‘ç»œæŠ€æœ¯è¿›è¡Œæœºå™¨å­¦ä¹ ã€‚ 1957å¹´ï¼Œåº·å¥ˆå°”å¤§å­¦å¿ƒç†å­¦æ•™æˆç½—æ£®å¸ƒæ‹‰ç‰¹åœ¨IBMè®¡ç®—æœºä¸Šæ¨¡æ‹Ÿå®ç°äº†ä¸€ä¸ªç¥ç»ç½‘ç»œæ¨¡å‹ï¼Œä»–ç§°ä¹‹ä¸ºâ€œæ„ŸçŸ¥æœºâ€ï¼ˆPerceptronï¼‰ã€‚ä»–çš„åšæ³•æ˜¯å°†ä¸€ç»„M-Pæ¨¡å‹ç¥ç»å…ƒç»„åˆåœ¨ä¸€èµ·ï¼Œå¯ä»¥ç”¨æ¥è®­ç»ƒå¹¶å®Œæˆä¸€äº›æœºå™¨è§†è§‰æ¨¡å¼è¯†åˆ«æ–¹é¢çš„ä»»åŠ¡ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæœºå™¨å­¦ä¹ æœ‰ä¸¤ç§ä»»åŠ¡ï¼šåˆ†ç±»å’Œå›å½’ã€‚åˆ†ç±»é—®é¢˜æ˜¯åˆ¤æ–­æ•°æ®æ˜¯å“ªä¸€ç±»çš„é—®é¢˜ï¼Œæ¯”å¦‚è¯†åˆ«å›¾åƒæ˜¯çŒ«è¿˜æ˜¯ç‹—ï¼›è€Œå›å½’é—®é¢˜æ˜¯æ ¹æ®ä¸€ä¸ªæ•°æ®é¢„æµ‹å¦ä¸€ä¸ªæ•°æ®çš„é—®é¢˜ï¼Œæ¯”å¦‚æ ¹æ®äººçš„å›¾åƒé¢„æµ‹å…¶ä½“é‡ã€‚æ„ŸçŸ¥æœºè§£å†³çš„æ˜¯çº¿æ€§åˆ†ç±»é—®é¢˜ã€‚ä»¥ã€Šæ™ºæ…§çš„ç–†ç•Œã€‹ä¹¦ä¸­å¯¹æ„ŸçŸ¥æœºå·¥ä½œåŸç†çš„ä¸¾ä¾‹æ¥è§£é‡Šï¼š å‡è®¾ä»»åŠ¡ç›®æ ‡æ˜¯è‡ªåŠ¨è¯†åˆ«é˜¿æ‹‰ä¼¯æ•°å­—ï¼Œå¾…è¯†åˆ«çš„æ•°å­—æ˜¯å°†æ‰‹å†™æˆ–å°åˆ·çš„å„ç§å½¢å¼çš„æ•°å­—ï¼Œå°†æ•°å­—é€šè¿‡æ‰«æåå­˜å‚¨åœ¨14*14åƒç´ å¤§å°çš„å›¾ç‰‡æ–‡ä»¶ä¸­ã€‚é¦–å…ˆï¼Œè¦å‡†å¤‡ç±»ä¼¼ä¸‹å›¾çš„è®­ç»ƒé›†ä¾›æœºå™¨å­¦ä¹ ç”¨ã€‚è®­ç»ƒé›†å³è®­ç»ƒæ•°æ®é›†ï¼Œæ˜¯ä¸“é—¨æä¾›ç»™è®¡ç®—æœºå­¦ä¹ ä½¿ç”¨çš„æ•°æ®é›†ï¼Œå®ƒä¸ä»…æ˜¯ä¸€ç»„å›¾ç‰‡ä¹‹ç±»çš„æ•°æ®ï¼Œè¿˜ä¼šç”±äººå·¥äº‹å…ˆæ ‡æ³¨å‘Šè¯‰æœºå™¨è¿™äº›å›¾ç‰‡æ•°æ®ä»£è¡¨çš„æ•°å­—æ˜¯ä»€ä¹ˆã€‚ ç„¶åï¼Œæˆ‘ä»¬è¦è®¾è®¡ä¸€ç§æ•°æ®ç»“æ„ï¼Œä»¥ä¾¿æœºå™¨å¯ä»¥å­˜å‚¨å¹¶å¤„ç†è¿™äº›å›¾ç‰‡ã€‚å¯¹äº14*14çš„ç°åº¦æ•°å­—å›¾ç‰‡ï¼Œå¯ä»¥å°†é»‘è‰²åƒç´ ç”¨1æ¥è¡¨ç¤ºï¼Œç™½è‰²åƒç´ ç”¨0è¡¨ç¤ºï¼Œä»‹äºé»‘ç™½é—´çš„ç°åº¦åƒç´ æ ¹æ®å…¶ç°åº¦å¼ºåº¦ç”¨0-1é—´çš„æµ®ç‚¹æ•°è¡¨ç¤ºã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºå¯¹è¯¥å›¾å¯ä»¥è½¬æ¢æˆä¸€ä¸ªäºŒç»´å¼ é‡æ•°ç»„ï¼š è€Œæœºå™¨èƒ½å¤Ÿè¯†åˆ«å‡ºå›¾ç‰‡ä¸­çš„æ•°å­—æ˜¯ä»€ä¹ˆï¼Œä¸»è¦æ˜¯æ‰¾åˆ°äº†è¯¥å›¾ç‰‡è¡¨ç¤ºæŸä¸ªæ•°å­—çš„ç‰¹å¾ã€‚å¯¹äºäººç±»æ¥è¯´ï¼Œå¯¹äºè¯†åˆ«è¿™äº›æ‰‹å†™ä½“æ•°å­—å¾ˆå®¹æ˜“ï¼Œä½†æˆ‘ä»¬å¾ˆéš¾è§£é‡Šè¿™äº›ç‰¹å¾æ˜¯ä»€ä¹ˆã€‚æœºå™¨å­¦ä¹ çš„ç›®æ ‡å°±æ˜¯è¦æå–å‡ºè¿™äº›è®­ç»ƒé›†ä¸­å›¾ç‰‡è¡¨ç¤ºæ•°å­—çš„ç‰¹å¾ï¼Œæ ¹æ®M-Pæ¨¡å‹ï¼Œæå–ç‰¹å¾çš„æ–¹æ³•å°±æ˜¯é€‰æ‹©å¯¹å›¾ç‰‡å„ä¸ªåƒç´ å€¼è¿›è¡ŒåŠ æƒæ±‚å’Œï¼Œæ ¹æ®è®­ç»ƒé›†ä¸­çš„æ ·æœ¬å›¾ç‰‡å’Œæ ‡æ³¨æ•°æ®çš„å¯¹åº”ç»“æœæ¥è®¡ç®—æ¯ä¸ªåƒç´ å¯¹åº”å„æ•°å­—çš„æƒå€¼ï¼šå¦‚æœæŸä¸€ä¸ªåƒç´ å…·æœ‰å¾ˆè´Ÿé¢çš„è¯æ®è¯´æ˜è¯¥å›¾ç‰‡ä¸å±äºæŸä¸ªæ•°å­—çš„è¯ï¼Œå°±æŠŠè¯¥åƒç´ å¯¹åº”è¯¥æ•°å­—çš„æƒå€¼è®¾ç½®æˆè´Ÿæ•°ï¼Œç›¸åå¦‚æœä¸€ä¸ªåƒç´ å…·æœ‰å¾ˆæ­£é¢çš„è¯æ®è¯´æ˜è¯¥å›¾ç‰‡å±äºæŸä¸ªæ•°å­—ï¼Œé‚£ä¹ˆè¯¥åƒç´ å¯¹åº”è¯¥æ•°å­—çš„æƒå€¼è®¾ç½®æˆæ­£å€¼ã€‚æ¯”å¦‚å¯¹äºæ•°å­—â€œ0â€çš„å›¾ç‰‡ä¸­é—´ç‚¹çš„åƒç´ ä¸åº”è¯¥æœ‰é»‘è‰²ï¼ˆ1ï¼‰åƒç´ ï¼Œå¦‚æœå‡ºç°äº†åˆ™è¡¨æ˜è¯¥å›¾ç‰‡å±äºæ•°å­—0ä¸ºè´Ÿé¢è¯æ®ï¼Œå°±é™ä½è¯¥å›¾ç‰‡æ˜¯æ•°å­—0çš„æ¦‚ç‡ã€‚è¿™æ ·ï¼Œç»è¿‡å¯¹æ•°æ®é›†çš„è®­ç»ƒå’Œæ ¡å‡†ï¼Œå°±å¯ä»¥å¾—åˆ°14*14ï¼ˆ=196ï¼‰æ¯ä¸ªåƒç´ å¯¹åº”0-9å„æ•°å­—çš„æƒé‡åˆ†å¸ƒã€‚ æˆ‘ä»¬å†å°†æ¯ä¸ªæ•°å­—çš„åˆ†ç±»è¿‡ç¨‹è½¬æ¢æˆä¸€ä¸ªM-Pç¥ç»å…ƒï¼Œæ¯ä¸ªç¥ç»å…ƒéƒ½æœ‰196ä¸ªåƒç´ è¾“å…¥ï¼Œæ¯ä¸ªè¾“å…¥ä¸è¯¥ç¥ç»å…ƒä¹‹é—´çš„æƒé‡å€¼ç”±è®­ç»ƒå¾—åˆ°ï¼Œè¿™æ ·å°±æ„æˆäº†ä¸€ä¸ª10ä¸ªç¥ç»å…ƒã€196ä¸ªè¾“å…¥ä»¥åŠå®ƒä»¬ä¹‹é—´1960ä¸ªå¸¦æƒé‡çš„è¿æ¥çº¿ç»„æˆçš„ç¥ç»ç½‘ç»œï¼Œå¦‚ä¸‹å›¾ç¤ºï¼šï¼ˆä¸€èˆ¬åœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œä¼šå°†é˜ˆå€¼è½¬æ¢æˆåç½®biasï¼Œç§°ä¸ºæ±‚å’Œé¡¹çš„ä¸€é¡¹ï¼Œç®€åŒ–è¿ç®—è¿‡ç¨‹ã€‚ï¼‰ ä¸è¿‡ï¼Œåœ¨å®é™…æƒ…å†µä¸­ï¼Œæœ‰äº›æ‰‹å†™å­—ä½“å­˜åœ¨æ¨¡æ£±ä¸¤å¯çš„æƒ…å†µï¼Œå¯èƒ½ä¼šå¯¼è‡´åŠ æƒæ±‚å’Œåï¼Œå‡ºç°ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„ç¥ç»å…ƒè¢«æ¿€æ´»ã€‚å› æ­¤æ„ŸçŸ¥æœºåœ¨å®ç°æ—¶å¼•å…¥äº†æ¿€æ´»å‡½æ•°çš„è®¾è®¡ï¼Œå¦‚ä¸‹å›¾ä¸­çš„Softmaxå°±æ˜¯ä¸€ç§æ¿€æ´»å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šå¯¹æ±‚å’Œå€¼è¿›è¡Œå¤„ç†ï¼ŒæŠ‘åˆ¶æ¦‚ç‡å°çš„ã€å¢å¼ºæ¦‚ç‡å¤§çš„æ•°å­—åˆ†ç±»ã€‚ ç½—æ£®å¸ƒæ‹‰ç‰¹åˆåœ¨ä¸¤å¹´ååˆ¶é€ äº†ä¸–ç•Œç¬¬ä¸€å°ç¡¬ä»¶æ„ŸçŸ¥æœºâ€Mark-1â€ï¼Œè¯¥æ„ŸçŸ¥æœºå¯ä»¥è¯†åˆ«è‹±æ–‡å­—æ¯ï¼Œåœ¨å½“æ—¶å¯æ˜¯å¼•èµ·äº†å·¨å¤§è½°åŠ¨ã€‚ç¾å›½å›½é˜²éƒ¨å’Œæµ·å†›å†›æ–¹ä¹Ÿæ³¨æ„åˆ°äº†ï¼Œå¹¶ç»™ä¸äº†å¤§é‡çš„èµ„é‡‘æ”¯æ’‘ï¼Œç½—æ£®å¸ƒæ‹‰ç‰¹å¯¹æ„ŸçŸ¥æœºçš„è‡ªä¿¡ä¹Ÿè¾¾åˆ°é¡¶ç‚¹ï¼Œç”šè‡³æœ‰è®°è€…é—®â€œæœ‰æ²¡æœ‰æ„ŸçŸ¥æœºåšä¸åˆ°çš„äº‹æƒ…â€ï¼Œç½—æ£®å¸ƒæ‹‰ç‰¹çš„å›ç­”æ˜¯â€œçˆ±ã€å¸Œæœ›ã€ç»æœ›â€ã€‚ç½—æ£®å¸ƒæ‹‰ç‰¹çš„åæ°”è¶Šæ¥è¶Šå¤§ï¼Œè€Œå¼ æ‰¬çš„æ€§æ ¼ä¹Ÿå¯¼è‡´ä»–å››å¤„æ ‘æ•Œï¼Œå…¶ä¸­æœ€æœ‰åçš„æ˜¯äººå·¥æ™ºèƒ½çš„å¦ä¸€ä½å·¨å¤´é©¬æ–‡Â·æ˜æ–¯åŸºã€‚æ˜æ–¯åŸºæ˜¯è¾¾ç‰¹èŒ…æ–¯ä¼šè®®çš„ç»„ç»‡è€…ï¼Œä¹Ÿæ˜¯äººå·¥æ™ºèƒ½çš„å¥ åŸºè€…ä¹‹ä¸€ã€‚1969å¹´ï¼Œä»–å‡ºç‰ˆäº†ã€Šæ„ŸçŸ¥æœºã€‹ä¸€ä¹¦ï¼Œè¯¥ä¹¦æ˜ç¡®æŒ‡å‡ºäº†æ„ŸçŸ¥æœºå­˜åœ¨çš„ç¼ºé™·ã€‚é¦–å…ˆæ˜¯é€šè¿‡æ•°å­¦æ–¹æ³•è¯æ˜äº†æ„ŸçŸ¥æœºæ— æ³•å¤„ç†å¼‚æˆ–ç­‰éçº¿æ€§åˆ†ç±»é—®é¢˜ï¼Œè€Œååˆè¯æ˜äº†å¤šå±‚æ„ŸçŸ¥æœºçš„å¤æ‚åº¦å¯¼è‡´è¿æ¥æ•°æ®æ€¥å‰§è†¨èƒ€è€Œæ²¡æœ‰åˆé€‚çš„è®­ç»ƒæ–¹æ³•ã€‚æ˜æ–¯åŸºåœ¨è¯¥ä¹¦å‡ºç‰ˆå½“å¹´è·å¾—äº†ç¬¬å››å±Šå›¾çµå¥–ï¼Œå·¨å¤§çš„å£°æœ›è®©ä»–å¯¹æ„ŸçŸ¥æœºçš„åˆ¤æ–­ç»™ç¥ç»ç½‘ç»œç ”ç©¶åˆ¤äº†æ­»åˆ‘ã€‚è¿æ¥ä¸»ä¹‰å¤‡å—æ‰“å‡»ï¼Œè€Œç¬¦å·ä¸»ä¹‰çš„ç ”ç©¶åˆ™æˆä¸ºäººå·¥æ™ºèƒ½çš„ä¸»æµã€‚ äººå·¥æ™ºèƒ½é¢†åŸŸæœ‰ä¸¤å¤§æµæ´¾ï¼šè¿æ¥ä¸»ä¹‰å’Œç¬¦å·ä¸»ä¹‰ï¼Œæœ‰ç‚¹åƒæ­¦ä¾ å°è¯´ä¸­çš„å‰‘å®—å’Œæ°”å®—ï¼Œé•¿æœŸä»¥æ¥ä¸€ç›´äº’ç›¸ç«äº‰ã€‚è¿æ¥ä¸»ä¹‰é€šè¿‡æ¨¡æ‹Ÿäººç±»çš„å¤§è„‘æ„å»ºç¥ç»ç½‘ç»œï¼Œå°†çŸ¥è¯†å­˜å‚¨åœ¨å¤§é‡çš„è¿æ¥ä¸­ï¼ŒåŸºäºæ•°æ®å­¦ä¹ æ¥å‘å±•äººå·¥æ™ºèƒ½ã€‚è€Œç¬¦å·ä¸»ä¹‰åˆ™æ˜¯è®¤ä¸ºçŸ¥è¯†å’Œæ¨ç†éƒ½åº”è¯¥ç”¨ç¬¦å·å’Œè§„åˆ™æ¥è¡¨ç¤ºï¼Œå³å¤§é‡çš„â€œif-thenâ€è§„åˆ™å®šä¹‰ï¼Œæ¥äº§ç”Ÿå†³ç­–å’Œæ¨ç†ï¼ŒåŸºäºè§„åˆ™å’Œé€»è¾‘æ¥å‘å±•äººå·¥æ™ºèƒ½ã€‚å‰è€…çš„ä»£è¡¨æ˜¯ç¥ç»ç½‘ç»œï¼Œåè€…çš„ä»£è¡¨æ˜¯ä¸“å®¶ç³»ç»Ÿã€‚ ","date":"2024-11-06","objectID":"/posts/%E4%BB%8E%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%88%B0-hugging-face/:3:0","tags":["clippings","è½¬è½½","blog"],"title":"ä»ç¥ç»ç½‘ç»œåˆ° Hugging Face","uri":"/posts/%E4%BB%8E%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%88%B0-hugging-face/#äºŒ-æ„ŸçŸ¥æœº"},{"categories":null,"collections":["AI"],"content":"ä¸‰ æ·±åº¦å­¦ä¹  éšç€æ„ŸçŸ¥æœºçš„å¤±è´¥ï¼Œæ”¿åºœå¯¹äººå·¥æ™ºèƒ½é¢†åŸŸçš„æŠ•å…¥å‡å°‘ï¼Œäººå·¥æ™ºèƒ½è¿›å…¥äº†ç¬¬ä¸€æ¬¡å¯’å†¬æœŸã€‚è€Œåˆ°äº†å…«åå¹´ä»£ï¼Œä»¥ä¸“å®¶ç³»ç»Ÿä¸ºä»£è¡¨çš„ç¬¦å·ä¸»ä¹‰æˆä¸ºäººå·¥æ™ºèƒ½çš„ä¸»æµï¼Œå¼•å‘äº†äººå·¥æ™ºèƒ½çš„ç¬¬äºŒæ³¢æµªæ½®ï¼Œè€Œç¥ç»ç½‘ç»œç ”ç©¶è¢«å†·è½ã€‚å‰æ–‡è¯´åˆ°ï¼Œåªæœ‰ä¸€ä¸ªäººè¿˜åœ¨åšæŒï¼Œé‚£å°±æ˜¯æ°å¼—é‡ŒÂ·è¾›é¡¿ã€‚ è¾›é¡¿åœ¨å‰äººçš„åŸºç¡€ä¸Šï¼Œå…ˆåå‘æ˜äº†ç»å°”å…¹æ›¼æœºå’Œè¯¯å·®åå‘ä¼ æ’­ç®—æ³•ï¼Œè¾›é¡¿åœ¨ç¥ç»ç½‘ç»œé¢†åŸŸçš„å¼€åˆ›è´¡çŒ®ç»™è¿™ä¸ªé¢†åŸŸå¸¦æ¥äº†ç”Ÿæœºï¼Œè™½ç„¶ä»ä¸Šä¸–çºªå…«åå¹´ä»£åˆ°æœ¬ä¸–çºªåˆäººå·¥æ™ºèƒ½é¢†åŸŸçš„ä¸»æµä»ç„¶æ˜¯çŸ¥è¯†åº“å’Œç»Ÿè®¡åˆ†æï¼Œç¥ç»ç½‘ç»œçš„å„é¡¹æŠ€æœ¯ä¹Ÿå¼€å§‹çªç ´ï¼Œå…¶ä¸­ä»£è¡¨æ€§çš„å¦‚å·ç§¯ç¥ç»ç½‘ç»œï¼ˆCNNï¼‰ã€é•¿çŸ­æœŸè®°å¿†ç½‘ç»œï¼ˆLSTMï¼‰ç­‰ã€‚åˆ°äº†2006å¹´ï¼Œè¾›é¡¿æå‡ºæ·±åº¦ä¿¡å¿µç½‘ç»œï¼Œå¼€å¯äº†æ·±åº¦å­¦ä¹ æ—¶ä»£ã€‚ æ·±åº¦å­¦ä¹ æ‰€å¯¹åº”çš„ç¥ç»ç½‘ç»œæ¨¡å‹ç§°ä¸ºæ·±åº¦ç¥ç»ç½‘ç»œï¼Œè¿™æ˜¯ç›¸å¯¹æµ…å±‚ç¥ç»ç½‘ç»œè€Œè¨€çš„ã€‚å¯¹äºæµ…å±‚ç¥ç»ç½‘ç»œè€Œè¨€ï¼Œä¸€èˆ¬åªæœ‰ä¸€ä¸ªéšè—å±‚ï¼ˆæˆ–ç§°ä¸­é—´å±‚ï¼‰ï¼ŒåŠ ä¸Šè¾“å…¥å±‚å’Œè¾“å‡ºå±‚ï¼Œä¸€å…±å°±ä¸‰å±‚ã€‚è€Œæ·±åº¦ç¥ç»ç½‘ç»œçš„éšè—å±‚åˆ™ä¸æ­¢ä¸€å±‚ï¼Œå¯¹æ¯”ä¸¤ç§ç¥ç»ç½‘ç»œï¼š æ·±åº¦å­¦ä¹ ä¹‹å‰äººä»¬ä¸€ç›´èšç„¦äºæµ…å±‚ç¥ç»ç½‘ç»œçš„åŸå› æ˜¯ç¥ç»ç½‘ç»œå±‚æ•°çš„å¢åŠ ä¼šå¯¼è‡´è®­ç»ƒéš¾åº¦å¢åŠ ï¼Œä¸€æ–¹é¢ç¼ºä¹è¶³å¤Ÿçš„ç®—åŠ›æ”¯æ’‘ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿæ²¡æœ‰å¾ˆå¥½çš„ç®—æ³•ã€‚è€Œè¾›é¡¿æå‡ºçš„æ·±åº¦ä¿¡å¿µç½‘ç»œåˆ™ä½¿ç”¨è¯¯å·®åå‘ä¼ æ’­ç®—æ³•å¹¶é€šè¿‡é€å±‚é¢„è®­ç»ƒçš„æ–¹å¼æ¥è§£å†³è¿™ä¸€è®­ç»ƒéš¾é¢˜ã€‚åœ¨æ·±åº¦ä¿¡å¿µç½‘ç»œä¹‹åï¼Œæ·±åº¦ç¥ç»ç½‘ç»œæˆä¸ºæœºå™¨å­¦ä¹ çš„ä¸»æµæ¨¡å‹ï¼Œå½“å‰çƒ­é—¨çš„GPTã€Llamaç­‰å¤§æ¨¡å‹éƒ½æ˜¯ç”±ä¸€ç§æˆ–å¤šç§æ·±åº¦ç¥ç»ç½‘ç»œæ„å»ºè€Œæˆã€‚ å¯¹äºæ·±åº¦ç¥ç»ç½‘ç»œçš„ç†è§£å¯ä»¥å‚è€ƒä¸Šæ–‡æ„ŸçŸ¥æœºåŸç†çš„ä»‹ç»ï¼Œå°†æ·±åº¦ç¥ç»ç½‘ç»œçœ‹æˆæ˜¯å¤šå±‚å¤šä¸ªç¥ç»å…ƒçš„ç»„åˆï¼Œç”±å‰æ–‡å¯ä»¥äº†è§£ï¼Œæ¯ä¸€å±‚è¾“å‡ºç»“æœè·Ÿæƒé‡ã€åç½®å’Œæ¿€æ´»å‡½æ•°æœ‰å…³ï¼Œè€Œå¯¹äºæ·±åº¦ç¥ç»ç½‘ç»œçš„è¾“å‡ºè¿˜è·Ÿå±‚æ•°ç­‰æ•°å€¼ç›¸å…³ã€‚åœ¨æ·±åº¦ç¥ç»ç½‘ç»œä¸­ï¼Œè¿™äº›æ•°å€¼å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç±»æ˜¯å±‚æ•°ã€æ¿€æ´»å‡½æ•°ã€ä¼˜åŒ–å™¨ç­‰ï¼Œç§°ä¸ºè¶…å‚æ•°ï¼ˆhyperparameterï¼‰ï¼Œå®ƒç”±å·¥ç¨‹å¸ˆè®¾å®šï¼›å¦ä¸€ç±»æ˜¯æƒé‡å’Œåç½®ï¼Œç§°ä¸ºå‚æ•°ï¼ˆparameterï¼‰ï¼Œå®ƒæ˜¯åœ¨æ·±åº¦ç¥ç»ç½‘ç»œè®­ç»ƒè¿‡ç¨‹ä¸­è‡ªåŠ¨å¾—åˆ°çš„ï¼Œå¯»æ‰¾åˆ°åˆé€‚çš„å‚æ•°å°±æ˜¯æ·±åº¦å­¦ä¹ çš„ç›®çš„ã€‚ ä½†é—®é¢˜æ˜¯ï¼Œä¸€ä¸ªæ·±åº¦ç¥ç»ç½‘ç»œåŒ…å«äº†æµ·é‡çš„å‚æ•°ï¼Œè€Œä¸”ä¿®æ”¹ä¸€ä¸ªå‚æ•°å°†å½±å“å…¶ä»–çš„å‚æ•°è¡Œä¸ºï¼Œå› æ­¤å¦‚ä½•æ‰¾åˆ°è¿™äº›å‚æ•°çš„æ­£ç¡®å–å€¼æ˜¯ä¸ªéš¾äº‹ã€‚æˆ‘ä»¬è¦æ‰¾å‡ºå‚æ•°æ­£ç¡®å–å€¼ï¼Œå¹¶è®©æ¨¡å‹èƒ½å¤Ÿå‡†ç¡®è¾“å‡ºï¼Œé‚£å°±éœ€è¦æœ‰ä¸€ä¸ªæ–¹æ³•èƒ½å¤Ÿè¡¡é‡æ¨¡å‹è¾“å‡ºä¸æœŸæœ›è¾“å‡ºçš„å·®è·ã€‚å› æ­¤æ·±åº¦å­¦ä¹ è®­ç»ƒä¸­ä½¿ç”¨æŸå¤±å‡½æ•°ï¼ˆloss functionï¼‰æ¥è¡¡é‡ï¼ŒæŸå¤±å‡½æ•°ä¹Ÿè¢«ç§°ä¸ºç›®æ ‡å‡½æ•°æˆ–ä»£ä»·å‡½æ•°ã€‚æŸå¤±å‡½æ•°é€šè¿‡æ¯”è¾ƒæ·±åº¦ç¥ç»ç½‘ç»œçš„é¢„æµ‹å€¼ä¸çœŸå®ç›®æ ‡å€¼ï¼Œå¾—åˆ°æŸå¤±å€¼ï¼Œæ¥è¡¨ç¤ºè¯¥ç¥ç»ç½‘ç»œæ¨¡å‹åœ¨è¿™ä¸ªè®­ç»ƒæ ·æœ¬ä¸Šçš„æ•ˆæœå¥½åã€‚ æ·±åº¦å­¦ä¹ çš„æ–¹æ³•æ˜¯å°†æŸå¤±å€¼ä½œä¸ºåé¦ˆä¿¡å·ï¼Œæ¥å¯¹å‚æ•°è¿›è¡Œå¾®è°ƒï¼Œä»¥é™ä½å½“å‰æ ·æœ¬è®­ç»ƒçš„æŸå¤±å€¼ã€‚å®ç°è¿™ç§è°ƒèŠ‚çš„ä¾¿æ˜¯ä¼˜åŒ–å™¨ï¼Œå®ƒæ¥å®ç°å¦‚æ¢¯åº¦ä¸‹é™ç­‰ä¼˜åŒ–ç®—æ³•ï¼Œé€šè¿‡åå‘ä¼ æ’­æ–¹å¼æ¥æ›´æ–°å„å±‚ç¥ç»å…ƒèŠ‚ç‚¹çš„å‚æ•°ã€‚ ä¸€å¼€å§‹ä¼šå¯¹ç¥ç»ç½‘ç»œçš„å‚æ•°è¿›è¡Œéšæœºèµ‹å€¼ï¼Œè¾“å…¥ä¸€æ‰¹è®­ç»ƒæ•°æ®ï¼Œç»è¾“å…¥å±‚ã€éšè—å±‚åˆ°è¾“å‡ºå±‚ï¼Œå¾—åˆ°ç½‘ç»œçš„é¢„æµ‹è¾“å‡ºåï¼Œæ ¹æ®æŸå¤±å‡½æ•°è®¡ç®—æŸå¤±å€¼ï¼Œè¿™æ˜¯å‰å‘ä¼ æ’­è¿‡ç¨‹ï¼›ç„¶åä»è¾“å‡ºå±‚å¼€å§‹ï¼Œåå‘æ²¿ç€æ¯ä¸€å±‚è®¡ç®—å‚æ•°çš„æ¢¯åº¦ï¼Œç›´åˆ°è¾“å…¥å±‚ï¼Œå¹¶æ ¹æ®æ¢¯åº¦ä½¿ç”¨ä¼˜åŒ–ç®—æ³•æ›´æ–°ç½‘ç»œçš„å‚æ•°ï¼Œè¿™æ˜¯åå‘ä¼ æ’­è¿‡ç¨‹ã€‚ç¥ç»ç½‘ç»œæ¯å¤„ç†ä¸€æ‰¹è®­ç»ƒæ ·æœ¬ï¼Œå‚æ•°éƒ½ä¼šå‘æ­£ç¡®çš„æ–¹å‘å¾®è°ƒï¼ŒæŸå¤±å€¼ä¹Ÿä¼šå‡å°ï¼Œè¿™å°±æ˜¯è®­ç»ƒå¾ªç¯ã€‚è®­ç»ƒå¾ªç¯è¶³å¤Ÿæ¬¡æ•°ï¼Œå°±å¯ä»¥å¾—åˆ°ä½¿æŸå¤±å‡½æ•°æœ€å°åŒ–çš„å‚æ•°ï¼Œè¿™æ ·å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªå¥½çš„ç¥ç»ç½‘ç»œæ¨¡å‹ã€‚ å½“ç„¶ï¼Œå®é™…çš„æ·±åº¦å­¦ä¹ è¿‡ç¨‹æ¯”è¿™ä¸ªè¦å¤æ‚å¾—å¤šï¼Œè¿™é‡Œåªæ˜¯ç®€è¦ä»‹ç»ä¸‹å¤§æ¦‚è¿‡ç¨‹ã€‚ 2012å¹´æ—¶ï¼Œè¾›é¡¿å¸¦é¢†ä»–çš„ä¸¤åå­¦ç”Ÿ Alex Krizhevsky å’Œ Ilya Sutskeverï¼Œå¼€å‘äº†AlexNet ç¥ç»ç½‘ç»œï¼Œå‚åŠ  ImageNet å›¾åƒè¯†åˆ«å¤§èµ›ï¼Œç»“æœè·å¾—å† å†›ï¼Œå‡†ç¡®ç‡è¿œè¿œé«˜å‡ºç¬¬äºŒåã€‚éšåè¾›é¡¿å’Œä»–çš„å­¦ç”Ÿæˆç«‹äº†DNNResearchå…¬å¸ï¼Œä¸“æ³¨äºæ·±åº¦ç¥ç»ç½‘ç»œçš„ç ”ç©¶ã€‚è¿™å®¶å…¬å¸æ²¡æœ‰ä»»ä½•äº§å“æˆ–èµ„äº§ï¼Œä½† AlexNet çš„æˆåŠŸå¸å¼•äº†å‡ å¤§äº’è”ç½‘å·¨å¤´ã€‚2012å¹´å†¬å¤©ï¼Œåœ¨ç¾å›½åŠ å·å’Œå†…åè¾¾å·äº¤ç•Œçš„å¤ªæµ©æ¹–è¾¹ï¼Œä¸€åœºç§˜å¯†çš„ç«æ‹æ­£åœ¨è¿›è¡Œï¼šè¢«æ‹å–çš„å¯¹è±¡æ˜¯åˆšæˆç«‹ä¸ä¹…çš„DNNResearchï¼Œä¹°å®¶åˆ†åˆ«æ˜¯è°·æ­Œã€å¾®è½¯ã€DeepMindå’Œç™¾åº¦ã€‚æœ€ååœ¨è°·æ­Œå’Œç™¾åº¦è¿˜åœ¨ç«ç›¸æŠ¬ä»·æ—¶ï¼Œè¾›é¡¿å«åœäº†æ‹å–ï¼Œé€‰æ‹©ä»¥4400ä¸‡ç¾å…ƒå–ç»™è°·æ­Œã€‚2014å¹´ï¼Œè°·æ­Œåˆå°†DeepMindæ”¶å…¥å›Šä¸­ã€‚2016å¹´ï¼Œé‡‡ç”¨ç»å…¸è’™ç‰¹å¡æ´›æ ‘æœç´¢å’Œæ·±åº¦ç¥ç»ç½‘ç»œç»“åˆçš„AlphaGoæˆ˜èƒœäº†æä¸–çŸ³ï¼Œæ¬¡å¹´ï¼Œåˆæˆ˜èƒœäº†ä¸–ç•Œå›´æ£‹æ’åç¬¬ä¸€çš„æŸ¯æ´ï¼ŒAlphaGoå°†äººå·¥æ™ºèƒ½å’Œæ·±åº¦å­¦ä¹ æ¨å‘äº†ä¸€ä¸ªæ–°çš„é«˜æ½®ã€‚ ","date":"2024-11-06","objectID":"/posts/%E4%BB%8E%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%88%B0-hugging-face/:4:0","tags":["clippings","è½¬è½½","blog"],"title":"ä»ç¥ç»ç½‘ç»œåˆ° Hugging Face","uri":"/posts/%E4%BB%8E%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%88%B0-hugging-face/#ä¸‰-æ·±åº¦å­¦ä¹ "},{"categories":null,"collections":["AI"],"content":"å›› å¤§æ¨¡å‹ 2015å¹´ï¼Œé©¬æ–¯å…‹ã€Stripeçš„CTO Greg Brockmanã€YCåˆ›æŠ•CEO Sam Altman å’Œ Ilya Sutskeverç­‰äººåœ¨åŠ å·çš„Resewoodé…’åº—é‡Œä¼šé¢ï¼Œå•†è®®åˆ›å»ºä¸€å®¶äººå·¥æ™ºèƒ½å®éªŒå®¤ï¼Œä»¥å¯¹æŠ—å¤§å‹äº’è”ç½‘å…¬å¸å¯¹äººå·¥æ™ºèƒ½æŠ€æœ¯çš„æ§åˆ¶ã€‚æ¥ä¸‹æ¥ï¼ŒGreg Brockman åˆä»è°·æ­Œã€å¾®è½¯ç­‰å…¬å¸é‚€è¯·æ¥ä¸€æ‰¹ç ”ç©¶äººå‘˜ï¼Œæˆç«‹æ–°çš„å®éªŒå®¤ï¼Œå¹¶å‘½åä¸ºOpenAIã€‚Greg Brockmanã€Sam Altman å’Œ Ilya Sutskever åˆ†åˆ«æ‹…ä»» OpenAIçš„è‘£äº‹é•¿ã€CEO å’Œ é¦–å¸­ç§‘å­¦å®¶ã€‚ é©¬æ–¯å…‹å’Œ Sam Altman å¯¹ OpenAI æœ€åˆçš„è®¾æƒ³æ˜¯éè¥åˆ©ç»„ç»‡ï¼Œå°†äººå·¥æ™ºèƒ½æŠ€æœ¯é¢å‘æ‰€æœ‰äººå¼€æ”¾ï¼Œä»¥æ­¤å¯¹æŠ—å¤§å‹äº’è”ç½‘å…¬å¸æ§åˆ¶äººå·¥æ™ºèƒ½æŠ€æœ¯è€Œå¸¦æ¥çš„å±é™©æ€§ã€‚å› ä¸ºæ·±åº¦å­¦ä¹ äººå·¥æ™ºèƒ½æŠ€æœ¯æ­£åœ¨çˆ†ç‚¸å¼çš„å‘å±•ï¼Œè°ä¹Ÿé¢„æ–™ä¸åˆ°è¿™é¡¹æŠ€æœ¯åœ¨æœªæ¥ä¼šä¸ä¼šå½¢æˆå¯¹äººç±»çš„å¨èƒï¼Œè€Œå¼€æ”¾å¯èƒ½æ˜¯æœ€å¥½çš„åº”å¯¹æ–¹å¼ã€‚è€Œåæ¥2019å¹´OpenAIä¸ºäº†èèµ„å‘å±•æŠ€æœ¯è€Œé€‰æ‹©æˆç«‹ç›ˆåˆ©å­å…¬å¸ï¼Œå¹¶é—­æºå…¶æ ¸å¿ƒæŠ€æœ¯ï¼Œè¿™æ˜¯åè¯ã€‚ 2017å¹´ï¼Œè°·æ­Œçš„å·¥ç¨‹å¸ˆå‘è¡¨äº†ä¸€ç¯‡è®ºæ–‡ï¼Œåä¸ºã€ŠAttention is all you needã€‹ï¼Œåœ¨è¿™ç¯‡è®ºæ–‡ä¸­æå‡ºäº† Transformer ç¥ç»ç½‘ç»œæ¶æ„ï¼Œè¯¥æ¶æ„çš„ç‰¹ç‚¹æ˜¯å°†äººç±»çš„æ³¨æ„åŠ›æœºåˆ¶å¼•å…¥åˆ°äº†ç¥ç»ç½‘ç»œä¸­ã€‚å‰æ–‡è¯´åˆ°çš„å›¾åƒè¯†åˆ«æ˜¯æ·±åº¦å­¦ä¹ ä¸­çš„ä¸€ç§åœºæ™¯ï¼Œå›¾åƒæ•°æ®æ˜¯ç¦»æ•£æ•°æ®ï¼Œä¹‹é—´æ²¡æœ‰å…³è”ã€‚è€Œç°å®ç”Ÿæ´»ä¸­è¿˜æœ‰å¦å¤–ä¸€ç§åœºæ™¯ï¼Œå°±æ˜¯å¤„ç†æ—¶åºå‹æ•°æ®ï¼Œæ¯”å¦‚æ–‡æœ¬ï¼Œæ–‡å­—çš„ä¸Šä¸‹æ–‡æ˜¯æœ‰å…³è”çš„ï¼Œè¿˜æœ‰è¯­éŸ³ã€è§†é¢‘ç­‰ï¼Œéƒ½æ˜¯æ—¶åºå‹æ•°æ®ã€‚è¿™ç§æ—¶åºå‹æ•°æ®å«åºåˆ—ï¼ˆsequenceï¼‰ï¼Œå¹¶ä¸”å®é™…ä»»åŠ¡ä¸­å¾€å¾€æ˜¯å°†ä¸€ä¸ªåºåˆ—è½¬æ¢æˆå¦å¤–ä¸€ä¸ªåºåˆ—ï¼Œæ¯”å¦‚ç¿»è¯‘ï¼Œå°†ä¸€æ®µä¸­æ–‡ç¿»è¯‘æˆä¸€æ®µè‹±æ–‡ï¼Œè¿˜æœ‰æœºå™¨äººé—®ç­”ï¼Œå°†ä¸€æ®µé—®é¢˜è½¬æ¢æˆä¸€æ®µæ™ºèƒ½ç”Ÿæˆçš„å›ç­”ï¼Œå› æ­¤è¦ç”¨åˆ°è½¬æ¢å™¨ï¼ˆTransformerï¼‰ï¼Œè¿™ä¹Ÿæ˜¯Transformer åç§°çš„ç”±æ¥ã€‚å‰æ–‡è¯´åˆ°ï¼Œä¸€ä¸ªç¥ç»å…ƒçš„æ¿€å‘æ˜¯ç”±å®ƒè¿æ¥çš„è¾“å…¥æ•°æ®åŠ æƒå’Œå†³å®šçš„ï¼Œæƒé‡ä»£è¡¨äº†è¿æ¥çš„å¼ºåº¦ã€‚åœ¨æ—¶åºæ•°æ®ä¸­ï¼Œæ¯ä¸ªå…ƒç´ çš„æƒé‡ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ï¼Œè¿™è·Ÿæˆ‘ä»¬æ—¥å¸¸ç”Ÿæ´»çš„ç»éªŒæ˜¯ä¸€è‡´çš„ï¼Œæ¯”å¦‚çœ‹ä¸‹é¢è¿™æ®µè¯ï¼š ç ”è¡¨ç©¶æ˜ï¼Œæ±‰å­—çš„åºé¡ºå¹¶ä¸å®šä¸€èƒ½å½±é˜…å“è¯»ï¼Œæ¯”å¦‚å½“ä½ å®Œçœ‹è¿™å¥è¯åï¼Œæ‰å‘è¿™ç°é‡Œçš„å­—å…¨æ˜¯éƒ½ä¹±çš„ã€‚ ä¸ä»…æ˜¯æ±‰å­—ï¼Œè‹±è¯­ç­‰å…¶ä»–äººç±»è¯­è¨€åŒæ ·å¦‚æ­¤ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬çš„å¤§è„‘ä¼šè‡ªåŠ¨åˆ¤æ–­å¥å­é‡Œå­—è¯çš„æƒé‡ï¼Œåœ¨å†—æ‚çš„ä¿¡æ¯é‡ŒæŠ“ä¸­é‡ç‚¹ï¼Œè¿™å°±æ˜¯æ³¨æ„åŠ›Attentionã€‚è°·æ­Œå·¥ç¨‹å¸ˆå°†æ³¨æ„åŠ›æœºåˆ¶å¼•å…¥åˆ°ç¥ç»ç½‘ç»œæ¨¡å‹ä¸­ï¼Œç”¨äºè‡ªç„¶è¯­è¨€å¤„ç†ï¼Œä½¿å¾—æœºå™¨å¯ä»¥â€œç†è§£â€äººç±»è¯­è¨€çš„æ„å›¾ã€‚éšå2018å¹´ï¼ŒOpenAIåŸºäºTransformeræ¶æ„å‘å¸ƒäº†GPT-1ï¼Œ2019å¹´å‘å¸ƒGPT-2ï¼Œ2020å¹´å‘å¸ƒGPT-3ï¼Œ2022å¹´åº•åŸºäºGPT-3.5å‘å¸ƒäº†ChatGPTäººå·¥æ™ºèƒ½é—®ç­”ç¨‹åºï¼Œå®ƒçš„å¯¹è¯èƒ½åŠ›è®©äººéœ‡æƒŠï¼Œäººå·¥æ™ºèƒ½ä¹Ÿå‘ç€AGIæ–¹å‘è¿ˆè¿›äº†ä¸€å¤§æ­¥ã€‚ GPTå…¨ç§°æ˜¯ Generative Pre-trained Transformer, Generative ç”Ÿæˆå¼è¡¨æ˜å®ƒçš„èƒ½åŠ›ï¼Œèƒ½å¤Ÿç”Ÿæˆæ–°å†…å®¹ï¼ŒTransformer æ˜¯å®ƒçš„åŸºç¡€æ¶æ„ï¼Œè€Œä¸­é—´çš„ Pre-trained è¡¨æ˜å®ƒçš„è®­ç»ƒæ–¹å¼æ˜¯é¢„è®­ç»ƒã€‚ä¸ºä»€ä¹ˆå«é¢„è®­ç»ƒå‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºï¼Œä»AlexNetå¼€å§‹ï¼Œäººä»¬ä¸ºäº†å–å¾—æ›´å¥½çš„æ•ˆæœï¼Œåœ¨ç¥ç»ç½‘ç»œè®­ç»ƒä¸­å¼€å§‹é‡‡ç”¨æ›´å¤§çš„æ•°æ®å’Œæ›´å¤šçš„å‚æ•°ï¼Œè€Œè¿™ä¹Ÿæ„å‘³ç€è®­ç»ƒçš„èµ„æºå’Œè€—æ—¶ä¹Ÿè¶Šæ¥è¶Šå¤§ã€‚è¿™ç§æˆæœ¬å¯¹äºè®­ç»ƒç‰¹å®šä»»åŠ¡æœ‰äº›é«˜ï¼Œä¸”ä¸èƒ½ä¸å…¶ä»–ç¥ç»ç½‘ç»œå…±äº«ï¼Œæœ‰äº›æµªè´¹ã€‚å› æ­¤ï¼Œä¸šç•Œå¼€å§‹é‡‡ç”¨ä¸€ç§é¢„è®­ç»ƒ+å¾®è°ƒçš„æ–¹å¼æ¥è®­ç»ƒç¥ç»ç½‘ç»œæ¨¡å‹ï¼Œå³å…ˆåœ¨è¾ƒå¤§çš„æ•°æ®é›†ä¸Šå®Œæˆé€šç”¨å¤§æ¨¡å‹çš„è®­ç»ƒï¼Œç„¶ååœ¨å…·ä½“çš„ä»»åŠ¡åœºæ™¯ç”¨è¾ƒå°çš„æ•°æ®é›†å®Œæˆæ¨¡å‹å¾®è°ƒã€‚ChatGPTé‡‡ç”¨äº†åŸºäºäººç±»åé¦ˆçš„å¼ºåŒ–å­¦ä¹ ï¼ˆReinforcement learning from human feedbackï¼Œ RLHFï¼‰æ¥è¿›è¡Œé¢„è®­ç»ƒå¾®è°ƒï¼Œåˆ†æˆä¸‰ä¸ªæ­¥éª¤ï¼šç¬¬ä¸€æ­¥ï¼Œé¢„è®­ç»ƒä¸€ä¸ªè¯­è¨€æ¨¡å‹ï¼ˆLMï¼‰ï¼›ç¬¬äºŒæ­¥ï¼Œæ”¶é›†é—®ç­”æ•°æ®å¹¶è®­ç»ƒä¸€ä¸ªå¥–åŠ±æ¨¡å‹ï¼ˆReward Modelï¼ŒRMï¼‰ï¼›ç¬¬ä¸‰æ­¥ï¼Œç”¨å¼ºåŒ–å­¦ä¹ ï¼ˆRLï¼‰æ–¹å¼å¾®è°ƒè¯­è¨€æ¨¡å‹ï¼ˆLMï¼‰ã€‚è¿™ä¸ªå¥–åŠ±æ¨¡å‹åŒ…å«äº†äººå·¥åé¦ˆï¼Œå› æ­¤è®­ç»ƒè¿‡ç¨‹ç§°ä¸ºRLHFã€‚ ç”¨æˆ·åœ¨ä½¿ç”¨ChatGPTè¿‡ç¨‹ä¸­ï¼Œé™¤äº†èµå¹å®ƒçš„å‡†ç¡®åº¦å¤–ï¼Œè¿˜è¢«å¤šè½®å¯¹è¯çš„èƒ½åŠ›æ‰€æŠ˜æœã€‚æ ¹æ®ç¥ç»ç½‘ç»œçš„åº•å±‚æ¢æï¼Œæˆ‘ä»¬çœ‹åˆ°æ¯æ¬¡æ¨ç†è¿‡ç¨‹æ˜¯ä»è¾“å…¥ç»å„ç¥ç»å…ƒåŠ æƒå’Œæ¿€æ´»åˆ°è¾“å‡ºï¼Œæ˜¯æ²¡æœ‰è®°å¿†èƒ½åŠ›çš„ã€‚è€ŒChatGPTä¹‹æ‰€ä»¥å¤šè½®å¯¹è¯æ•ˆæœå¥½ï¼Œæ˜¯å› ä¸ºå®ƒåœ¨å¯¹è¯ç®¡ç†ä¸­ä½¿ç”¨äº†Prompt Engineeringçš„æŠ€æœ¯ã€‚ å¯¹äºChatGPTç­‰å¤§è¯­è¨€æ¨¡å‹æ¥è¯´ï¼Œå®ƒçš„è¾“å…¥æ˜¯ç»è¿‡å°†ä¸€ä¸²æ–‡å­—è½¬æ¢çš„tokenï¼Œè€Œå¤§æ¨¡å‹å› ä¸ºè®¡ç®—æ•ˆç‡å’Œå†…å­˜é™åˆ¶ï¼Œä¸€èˆ¬ä¼šè®¾è®¡å›ºå®šçš„ä¸Šä¸‹æ–‡çª—å£ï¼Œé™åˆ¶è¾“å…¥tokençš„æ•°é‡ã€‚æ–‡æœ¬é¦–å…ˆä¼šè¢«åˆ†è¯å™¨ï¼ˆtokenizerï¼‰åˆ†è¯ï¼Œå¹¶é€šè¿‡æŸ¥è¡¨ç¼–å·ï¼Œç„¶åembeddingåˆ°çŸ©é˜µä¸­å˜æˆé«˜ç»´ç©ºé—´å‘é‡ï¼Œè¿™æ˜¯æ–‡æœ¬å‘é‡åŒ–çš„è¿‡ç¨‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ ç”±äºtokenæ•°çš„é™åˆ¶ï¼Œå› æ­¤è¦åœ¨æœ‰é™çš„ä¸Šä¸‹æ–‡çª—å£ä¸­å°†æ›´å…¨é¢çš„ä¿¡æ¯å‘Šè¯‰å¤§æ¨¡å‹ï¼Œå°±è¿™éœ€è¦ç”¨åˆ°Prompt Engineeringæç¤ºå·¥ç¨‹æŠ€æœ¯ã€‚æç¤ºå·¥ç¨‹åˆ©ç”¨ä¸€äº›ç­–ç•¥æ¥ä¼˜åŒ–æ¨¡å‹è¾“å…¥ï¼Œä»¥ä¾¿è®©æ¨¡å‹äº§ç”Ÿæ›´ç¬¦åˆæœŸæœ›çš„è¾“å‡ºã€‚ ChatGPTçš„æˆåŠŸèƒŒåæ˜¯ä»¥GPTä¸ºä»£è¡¨çš„å¤§æ¨¡å‹çš„æŠ€æœ¯æ¼”è¿›ï¼ŒOpenAIç›¸ä¿¡å¤§åŠ›å‡ºå¥‡è¿¹ï¼Œä¸æ–­æ‰©å¤§GPTçš„å‚æ•°ï¼ŒGPT-1æ¨¡å‹å‚æ•°æœ‰1.17äº¿ï¼ŒGPT-2æ¨¡å‹å‚æ•°æé«˜åˆ°äº†15äº¿ï¼ŒGPT-3è¾¾åˆ°äº†1750äº¿ï¼Œè€ŒGPT-4çš„æ¨¡å‹å‚æ•°æ®ç§°æœ‰1.8ä¸‡äº¿ã€‚æ›´å¤šçš„æ¨¡å‹å‚æ•°ä¹Ÿå°±æ„å‘³ç€éœ€è¦æ›´å¤§çš„ç®—åŠ›æ¥æ”¯æŒè®­ç»ƒï¼ŒOpenAIå› æ­¤æ€»ç»“äº†â€œScaling Lawâ€ï¼Œç§°æ¨¡å‹çš„æ€§èƒ½ä¸æ¨¡å‹å¤§å°ã€æ•°æ®é‡å’Œè®¡ç®—èµ„æºæœ‰å…³ï¼Œç®€å•çš„è¯´å°±æ˜¯ï¼Œæ¨¡å‹è¶Šå¤§ã€æ•°æ®é‡è¶Šå¤§ã€è®¡ç®—èµ„æºè¶Šå¤§ï¼Œæ¨¡å‹çš„æ€§èƒ½å°±è¶Šå¥½ã€‚å¼ºåŒ–å­¦ä¹ ä¹‹çˆ¶Rich Suttonåœ¨ä»–çš„æ–‡ç« ã€Šè‹¦æ¶©çš„æ•™è®­ã€‹(the Bitter Lesson)ä¸­ä¹Ÿè¡¨è¾¾äº†ç±»ä¼¼çš„è§‚ç‚¹ï¼Œä»–å›é¡¾äººå·¥æ™ºèƒ½è¿‘å‡ åå¹´çš„å‘å±•è·¯ç¨‹ï¼Œæ€»ç»“è¯´çŸ­æœŸå†…äººä»¬æ€»æ˜¯è¯•å›¾é€šè¿‡æ„å»ºçŸ¥è¯†æ¥æå‡æ™ºèƒ½ä½“çš„æ€§èƒ½ï¼Œä½†é•¿æœŸçœ‹å¼ºå¤§çš„ç®—åŠ›æ‰æ˜¯ç‹é“ã€‚ å¤§æ¨¡å‹çš„èƒ½åŠ›ä¹Ÿç”±é‡å˜è½¬ä¸ºè´¨å˜ï¼Œè°·æ­Œé¦–å¸­ç§‘å­¦å®¶Jeff Deanç§°å®ƒä¸ºå¤§æ¨¡å‹çš„â€œæ¶Œç°èƒ½åŠ›â€(Emergent abilities)ã€‚å¸‚åœºçœ‹åˆ°äº†è¿™ä¸ªæœºä¼šï¼Œä¸€æ–¹é¢ï¼Œå„å¤§å‚å•†åœ¨å¤§æ¨¡å‹æŠ•èµ„ä¸Šå‘ˆç°å†›å¤‡ç«èµ›ä¹‹æ€ï¼Œå¦ä¸€æ–¹é¢ï¼Œå¤§æ¨¡å‹çš„å¼€æºç”Ÿæ€ä¹Ÿå¦‚ç«å¦‚è¼ã€‚ ","date":"2024-11-06","objectID":"/posts/%E4%BB%8E%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%88%B0-hugging-face/:5:0","tags":["clippings","è½¬è½½","blog"],"title":"ä»ç¥ç»ç½‘ç»œåˆ° Hugging Face","uri":"/posts/%E4%BB%8E%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%88%B0-hugging-face/#å››-å¤§æ¨¡å‹"},{"categories":null,"collections":["AI"],"content":"äº” Hugging Face 2016å¹´ï¼Œæ³•å›½äººClÃ©ment Delangueã€Julien Chaumondå’ŒThomas Wolfæˆç«‹äº†ä¸€å®¶å…¬å¸ï¼Œèµ·åä¸ºHugging Faceï¼Œå¹¶ä»¥è¯¥emojiå›¾æ ‡ä¸ºå…¬å¸Logo. Hugging Faceæœ€åˆå¼€å‘é¢å‘å¹´è½»äººçš„æ™ºèƒ½èŠå¤©æœºå™¨äººï¼Œè€Œåä»–ä»¬åœ¨è®­ç»ƒæ¨¡å‹çš„è¿‡ç¨‹ä¸­å¼€å‘äº†äº›æ¨¡å‹è®­ç»ƒå·¥å…·å¹¶å°†å®ƒä»¬å¼€æºï¼Œåæ¥ä»–ä»¬ç”šè‡³è°ƒè½¬é‡å¿ƒæ¥åšåè€…ï¼Œè¿™ç§çœ‹ä¼¼â€œä¸åŠ¡æ­£ä¸šâ€çš„åšæ³•å´å°†ä»–ä»¬å¸¦å…¥äº†ä¸€ä¸ªæ–°çš„èµ›é“ï¼Œæˆä¸ºäº†æ·±åº¦å­¦ä¹ é¢†åŸŸä¸å¯æˆ–ç¼ºçš„è§’è‰²ã€‚ ç¡…è°·æœ‰å¾ˆå¤šä¼ä¸šéƒ½æ˜¯åœ¨å‰¯ä¸šä¸Šåšå‡ºæˆå°±ï¼Œæ¯”å¦‚SlackåŸæ¥å¼€å‘æ¸¸æˆï¼Œå…¬å¸å›¢é˜Ÿåˆ†å¸ƒå¤šåœ°ï¼Œåœ¨è¿ä½œè¿‡ç¨‹ä¸­å¼€å‘äº†ä¸€æ¬¾äº¤æµå·¥å…·ç»“æœä¸å°å¿ƒç«äº†ï¼Œå°±æ˜¯Slackã€‚è€ŒHugging Faceçš„è½¬å‘ä¹Ÿç±»ä¼¼ï¼Œä¹Ÿæ˜¯ä¸ºäº†è§£å†³è‡ªå·±çš„ç—›ç‚¹ï¼Œ2018å¹´ï¼Œè°·æ­Œå‘å¸ƒäº†å¤§æ¨¡å‹BERTï¼Œè€ŒHugging Faceçš„å‘˜å·¥ä¾¿ç”¨äº†ä»–ä»¬ç†Ÿæ‚‰çš„Pytorchæ¡†æ¶å®ç°äº†BERTï¼Œå°†æ¨¡å‹å–åä¸ºpytorch-pretrained-bertï¼Œå¹¶å°†å®ƒå¼€æºåˆ°äº†GitHubã€‚åæ¥åœ¨ç¤¾åŒºçš„å¸®åŠ©ä¸‹ï¼Œåˆå¼•å…¥äº†GPTã€GPT-2ã€Transformer-XLç­‰ä¸€æ‰¹æ¨¡å‹ï¼Œè¯¥é¡¹ç›®ä¾¿æ›´åä¸ºpytorch-transformersã€‚æ·±åº¦å­¦ä¹ é¢†åŸŸä¸€ç›´å­˜åœ¨ç€ä¸¤å¤§æ¡†æ¶Pytorchå’ŒTensorFlowä¹‹é—´çš„ç«äº‰ï¼Œè€Œç ”ç©¶äººå‘˜ä¸ºäº†æ¯”è¾ƒä¸¤ä¸ªæ¡†æ¶çš„ä¼˜åŠ£ï¼Œç»å¸¸åœ¨ä¸¤ä¸ªæ¡†æ¶é—´åˆ‡æ¢ï¼Œå› æ­¤è¯¥å¼€æºé¡¹ç›®åˆå¢åŠ äº†ä¸¤ä¸ªæ¡†æ¶é—´çš„åˆ‡æ¢åŠŸèƒ½ï¼Œé¡¹ç›®åç§°ä¹Ÿæ”¹æˆäº†Transformersã€‚Transformersä¹Ÿæˆäº†GitHubä¸Šå¢é•¿æœ€å¿«çš„é¡¹ç›®ã€‚ Hugging Faceç»§ç»­å¼€å‘äº†å¹¶å¼€æºäº†å…¶ä»–ä¸€ç³»åˆ—çš„æœºå™¨å­¦ä¹ å·¥å…·ï¼šDatasetsã€Tokenizerã€Diffusersâ€¦â€¦è¿™äº›å·¥å…·ä¹Ÿè§„èŒƒäº†AIå¼€å‘çš„æµç¨‹ï¼Œåœ¨Hugging Faceä¹‹å‰ï¼Œå¯ä»¥è¯´AIå¼€å‘ä»¥ç ”ç©¶äººå‘˜ä¸ºä¸»ï¼Œæ²¡æœ‰ä¸€å¥—è§„èŒƒçš„å·¥ç¨‹åŒ–æ–¹æ³•ï¼ŒHugging Faceåˆ™æä¾›äº†å®Œå–„çš„AIå·¥å…·é›†å¹¶å»ºç«‹äº†ä¸€å¥—äº‹å®æ ‡å‡†ï¼Œä¹Ÿä½¿å¾—æ›´å¤šçš„AIå¼€å‘è€…ç”šè‡³æ˜¯éAIä»ä¸šè€…å¯ä»¥å¿«é€Ÿä¸Šæ‰‹å¹¶è®­ç»ƒæ¨¡å‹ã€‚ æ¥ç€ï¼ŒHugging FaceåˆåŸºäºGitå’ŒGit LFSæŠ€æœ¯æ¨å‡ºäº†æ‰˜ç®¡æ¨¡å‹ã€æ•°æ®é›†ã€AIåº”ç”¨çš„Hugging Face Hubï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œå¹³å°ä¸Šå·²ç»æ‰˜ç®¡äº†35ä¸‡æ¨¡å‹ã€7.5ä¸‡æ•°æ®é›†å’Œ15ä¸‡ä¸ªAIåº”ç”¨ç¤ºä¾‹ã€‚æ‰˜ç®¡å¹¶å¼€æºæ¨¡å‹å’Œæ•°æ®é›†ï¼Œå¹¶å»ºç«‹å…¨çƒçš„å¼€æºä»“åº“ä¸­å¿ƒè¿™é¡¹å·¥ä½œå¯Œæœ‰åˆ›æ„ä¸”æ„ä¹‰æ·±è¿œã€‚ä¸Šæ–‡æåˆ°ï¼Œé¢„è®­ç»ƒ+å¾®è°ƒçš„æ–¹å¼ä¿ƒè¿›äº†ç¥ç»ç½‘ç»œè®­ç»ƒèµ„æºçš„å…±äº«ï¼Œè€ŒHugging Face Hubåˆ™æ›´è¿›ä¸€æ­¥ï¼Œè®©AIå¼€å‘è€…å¯ä»¥è½»æ¾å¤ç”¨å…¨ä¸–ç•Œæœ€å…ˆè¿›çš„æˆæœï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šæ·»ç –åŠ ç“¦ï¼Œè®©äººäººä½¿ç”¨AIã€å¼€å‘AIçš„AIæ°‘ä¸»åŒ–æˆä¸ºå¯èƒ½ã€‚Hugging Faceä¹Ÿè¢«ç§°ä¸ºæ˜¯æœºå™¨å­¦ä¹ é¢†åŸŸçš„GitHubï¼Œæˆ–å¦‚ä»–ä»¬çš„Sloganæ‰€è¨€ï¼šæ„å»ºæœªæ¥çš„AIç¤¾åŒºã€‚æˆ‘ä¹‹å‰å†™è¿‡ä¸¤ç¯‡æ–‡ç« ï¼Œä¸€ç¯‡ã€Šæ”¹å˜ä¸–ç•Œçš„ä¸€æ¬¡ä»£ç æäº¤ã€‹ä»‹ç»Gitï¼Œä¸€ç¯‡ã€Šä»é›¶åˆ°ç™¾äº¿ç¾é‡‘ä¹‹è·¯ã€‹ä»‹ç»GitHubï¼Œè€ŒGitã€GitHubã€Hugging Faceï¼Œæˆ‘è§‰å¾—å®ƒä»¬ä¹‹é—´å­˜åœ¨æŸç§ä¼ æ‰¿ï¼Œä¸€ç§æ”¹å˜ä¸–ç•Œæ„å»ºæœªæ¥çš„é»‘å®¢ç²¾ç¥çš„ä¼ æ‰¿ï¼Œè¿™ä¹Ÿæ˜¯ä¿ƒä½¿æˆ‘å†™è¿™ç¯‡æ–‡ç« çš„åŸå› ä¹‹ä¸€ã€‚ ","date":"2024-11-06","objectID":"/posts/%E4%BB%8E%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%88%B0-hugging-face/:6:0","tags":["clippings","è½¬è½½","blog"],"title":"ä»ç¥ç»ç½‘ç»œåˆ° Hugging Face","uri":"/posts/%E4%BB%8E%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%88%B0-hugging-face/#äº”-hugging-face"},{"categories":null,"collections":["AI"],"content":"å…­ åè®° åœ¨å¿«è¦å†™å®Œæœ¬æ–‡æ—¶ï¼Œæˆ‘çœ‹äº†è¾›é¡¿æœ€è¿‘åœ¨ç‰›æ´¥å¤§å­¦åšçš„ä¸€æ¬¡æ¼”è®²ã€‚åœ¨æ¼”è®²ä¸­ï¼Œè¾›é¡¿ä»‹ç»äº†äººå·¥æ™ºèƒ½é¢†åŸŸçš„ä¸¤å¤§æµæ´¾ï¼Œä¸€ç§è¾›é¡¿ç§°ä¸ºé€»è¾‘æ–¹æ³•ï¼Œå³ç¬¦å·ä¸»ä¹‰ï¼›å¦ä¸€ç§ä»–ç§°ä¹‹ä¸ºç”Ÿç‰©æ–¹æ³•ï¼Œå³æ¨¡æ‹Ÿäººç±»å¤§è„‘çš„ç¥ç»ç½‘ç»œè¿æ¥ä¸»ä¹‰ã€‚è€Œäº‹å®è¯æ˜äº†ç”Ÿç‰©æ–¹æ³•æ˜æ˜¾æˆ˜èƒœäº†é€»è¾‘æ–¹æ³•ã€‚ç¥ç»ç½‘ç»œæ˜¯æ¨¡æ‹Ÿäººç±»å¤§è„‘ç†è§£è€Œè®¾è®¡çš„æ¨¡å‹ï¼Œå¤§æ¨¡å‹ä¹Ÿåƒå¤§è„‘é‚£æ ·çš„å·¥ä½œå’Œç†è§£ã€‚è¾›é¡¿è®¤ä¸ºï¼Œè¶…è¶Šäººè„‘çš„äººå·¥æ™ºèƒ½åœ¨æœªæ¥ä¼šå‡ºç°ï¼Œè€Œä¸”ä¼šæ¯”æˆ‘ä»¬é¢„æµ‹çš„æ—¶é—´å¿«å¾—å¤šã€‚ ","date":"2024-11-06","objectID":"/posts/%E4%BB%8E%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%88%B0-hugging-face/:7:0","tags":["clippings","è½¬è½½","blog"],"title":"ä»ç¥ç»ç½‘ç»œåˆ° Hugging Face","uri":"/posts/%E4%BB%8E%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%88%B0-hugging-face/#å…­-åè®°"},{"categories":null,"collections":["AI"],"content":"é™„1 å¤§äº‹è®° 1943å¹´ï¼Œéº¦å¡æ´›å…‹å’Œçš®èŒ¨å‘è¡¨â€œM-Pç¥ç»å…ƒæ¨¡å‹â€ï¼Œç”¨æ•°ç†é€»è¾‘è§£é‡Šå¹¶æ¨¡æ‹Ÿäººè„‘çš„è®¡ç®—å•å…ƒï¼Œå¹¶æå‡ºç¥ç»ç½‘ç»œè¿™ä¸€æ¦‚å¿µã€‚ 1956å¹´ï¼Œâ€œäººå·¥æ™ºèƒ½â€ä¸€è¯é¦–å…ˆåœ¨è¾¾ç‰¹èŒ…æ–¯ä¼šè®®ä¸Šè¢«æå‡ºã€‚ 1957å¹´ï¼Œç½—æ£®å¸ƒæ‹‰ç‰¹æå‡ºâ€œæ„ŸçŸ¥æœºâ€æ¨¡å‹ï¼Œå¹¶åœ¨ä¸¤å¹´åæˆåŠŸåˆ¶é€ èƒ½å¤Ÿè¯†åˆ«è‹±æ–‡å­—æ¯çš„ç¡¬ä»¶æ„ŸçŸ¥æœºMark-1. 1969å¹´ï¼Œæ˜æ–¯åŸºå‘è¡¨ã€Šæ„ŸçŸ¥æœºã€‹ï¼Œä¹¦ä¸­æŒ‡å‡ºçš„æ„ŸçŸ¥æœºç¼ºé™·æ²‰é‡æ‰“å‡»äº†æ„ŸçŸ¥æœºä¹ƒè‡³ç¥ç»ç½‘ç»œçš„ç ”ç©¶ã€‚ 1983å¹´ï¼Œè¾›é¡¿å‘æ˜ç»å°”å…¹æ›¼æœºã€‚ 1986å¹´ï¼Œè¾›é¡¿å‘æ˜è¯¯å·®åå‘ä¼ æ’­ç®—æ³•ã€‚ 1989å¹´ï¼Œæ¨ç«‹æ˜†(Yann LeCun)å‘æ˜â€œå·ç§¯ç¥ç»ç½‘ç»œâ€(CNN)ã€‚ 2006å¹´ï¼Œè¾›é¡¿æå‡ºæ·±åº¦ä¿¡å¿µç½‘ç»œï¼Œå¼€å¯æ·±åº¦å­¦ä¹ æ—¶ä»£ã€‚ 2012å¹´ï¼Œè¾›é¡¿å’Œä»–çš„ä¸¤ä¸ªå­¦ç”Ÿè®¾è®¡AlexNetåœ¨ImageNetå¤§èµ›ä¸­ä»¥ç»å¯¹ä¼˜åŠ¿è·å¾—å† å†›ï¼Œæ·±åº¦å­¦ä¹ è¢«ä¸šç•Œæ‰€é‡è§†ã€‚ 2015å¹´ï¼ŒGoogleæ”¶è´­çš„DeepMindå…¬å¸æ¨å‡ºAlphaGoï¼Œ2016å¹´æˆ˜èƒœæä¸–çŸ³ï¼Œ2017å¹´æˆ˜èƒœæŸ¯æ´ã€‚OpenAIæˆç«‹ã€‚ 2016å¹´ï¼ŒHugging Faceæˆç«‹ã€‚ 2017å¹´ï¼ŒGoogleå‘è¡¨Transformeræ¨¡å‹è®ºæ–‡ã€‚ 2018å¹´ï¼ŒOpenAIåŸºäºTransformeræ¶æ„å‘å¸ƒäº†GPT-1ã€‚Hugging Faceå‘å¸ƒ Transformers é¡¹ç›®ã€‚ 2019å¹´ï¼ŒOpenAIå‘å¸ƒGPT-2ã€‚ 2020å¹´ï¼ŒOpenAIå‘å¸ƒGPT-3ã€‚Hugging Faceæ¨å‡ºHugging Face Hubã€‚ 2022å¹´ï¼ŒOpenAIå‘å¸ƒChatGPTã€‚ ","date":"2024-11-06","objectID":"/posts/%E4%BB%8E%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%88%B0-hugging-face/:8:0","tags":["clippings","è½¬è½½","blog"],"title":"ä»ç¥ç»ç½‘ç»œåˆ° Hugging Face","uri":"/posts/%E4%BB%8E%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%88%B0-hugging-face/#é™„1-å¤§äº‹è®°"},{"categories":null,"collections":["AI"],"content":"é™„2 å‚è€ƒèµ„æ–™ ä¹¦ç±ï¼š ã€Šæ™ºæ…§çš„ç–†ç•Œï¼šä»å›¾çµæœºåˆ°äººå·¥æ™ºèƒ½ã€‹å‘¨å¿—æ˜ï¼ˆè‘—ï¼‰ æœºæ¢°å·¥ä¸šå‡ºç‰ˆç¤¾ 2018å¹´10æœˆ ã€Šæ·±åº¦å­¦ä¹ é©å‘½ã€‹å‡¯å¾·Â·æ¢…èŒ¨ï¼ˆè‘—ï¼‰ æœæ›™å…‰ï¼ˆè¯‘ï¼‰ ä¸­ä¿¡å‡ºç‰ˆç¤¾ 2023å¹´1æœˆ ã€ŠPythonæ·±åº¦å­¦ä¹ ã€‹ï¼ˆç¬¬2ç‰ˆï¼‰ å¼—æœ—ç´¢ç“¦Â·è‚–è±ï¼ˆè‘—ï¼‰ å¼ äº®ï¼ˆè¯‘ï¼‰ äººæ°‘é‚®ç”µå‡ºç‰ˆç¤¾ 2022å¹´8æœˆ ã€Šæ·±åº¦å­¦ä¹ å…¥é—¨ï¼šåŸºäºPythonçš„ç†è®ºä¸å®ç°ã€‹æ–‹è—¤åº·æ¯…ï¼ˆè‘—ï¼‰é™†å®‡æ°ï¼ˆè¯‘ï¼‰äººæ°‘é‚®ç”µå‡ºç‰ˆç¤¾ 2018å¹´ ã€Šæ·±åº¦å­¦ä¹ è¿›é˜¶ï¼šè‡ªç„¶è¯­è¨€å¤„ç†ã€‹æ–‹è—¤åº·æ¯…ï¼ˆè‘—ï¼‰é™†å®‡æ°ï¼ˆè¯‘ï¼‰ äººæ°‘é‚®ç”µå‡ºç‰ˆç¤¾ 2020å¹´10æœˆ ã€Šè¿™å°±æ˜¯ChatGPTã€‹ æ–¯è’‚èŠ¬Â·æ²ƒå°”å¤«æ‹‰å§†ï¼ˆè‘—ï¼‰ WOLFRAMä¼ åª’æ±‰åŒ–å°ç»„ï¼ˆè¯‘ï¼‰ äººæ°‘é‚®ç”µå‡ºç‰ˆç¤¾ 2023å¹´7æœˆ ã€Šç”Ÿæˆå¼äººå·¥æ™ºèƒ½ã€‹ä¸ç£Šï¼ˆè‘—ï¼‰ä¸­ä¿¡å‡ºç‰ˆç¤¾ 2023å¹´5æœˆ ã€ŠHuggingfaceè‡ªç„¶è¯­è¨€å¤„ç†è¯¦è§£ã€‹æç¦æ—ï¼ˆè‘—ï¼‰æ¸…åå¤§å­¦å‡ºç‰ˆç¤¾ 2023å¹´4æœˆ æ–‡ç« ï¼š ã€Šç¥ç»ç½‘ç»œå…¥é—¨ã€‹é˜®ä¸€å³° ã€Š2012ï¼Œæ”¹å˜äººç±»å‘½è¿çš„180å¤©ã€‹è¿œå·ç ”ç©¶æ‰€ ã€ŠGPTå®¶æ—è¿›åŒ–å²ã€‹MetaPost ã€ŠTransformer - Attention is all you needã€‹çŸ¥ä¹ ã€Šé¢„è®­ç»ƒè¯­è¨€æ¨¡å‹çš„å‘å±•å†ç¨‹ã€‹ çŸ¥ä¹ ã€Šæç¤ºå·¥ç¨‹æŒ‡å—ã€‹ ã€ŠChatGPT èƒŒåçš„â€œåŠŸè‡£â€â€”â€”RLHF æŠ€æœ¯è¯¦è§£ã€‹ ã€ŠChatGPTå¤§æ¨¡å‹æŠ€æœ¯å‘å±•ä¸åº”ç”¨ã€‹ ã€ŠThe Bitter Lessonã€‹ Rich Sutton ã€Šä¸“è®¿HuggingFace CTOï¼šå¼€æºå´›èµ·ã€åˆ›ä¸šæ•…äº‹å’ŒAIæ°‘ä¸»åŒ–ã€‹ ","date":"2024-11-06","objectID":"/posts/%E4%BB%8E%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%88%B0-hugging-face/:9:0","tags":["clippings","è½¬è½½","blog"],"title":"ä»ç¥ç»ç½‘ç»œåˆ° Hugging Face","uri":"/posts/%E4%BB%8E%E7%A5%9E%E7%BB%8F%E7%BD%91%E7%BB%9C%E5%88%B0-hugging-face/#é™„2-å‚è€ƒèµ„æ–™"},{"categories":["Android"],"collections":["WMS"],"content":"#Peppermill #ç®—æ³•ç ”ç©¶ ç›®å‰ è½è…•ç­å±ç®—æ³•å¤§è‡´åœ¨ framework å±‚å®ç°ã€‚ ç›®å‰ç®—æ³•çš„æ€è·¯ï¼š #è¿åŠ¨æ£€æµ‹ï¼Œé€šè¿‡ä¸€äº›ç‰¹å¾å€¼ï¼Œæ¥åˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªè¿åŠ¨æ®µè½ã€‚ ç¬¦åˆçš„è¿åŠ¨æ£€æµ‹åï¼Œæˆ‘ä»¬æ¥åˆ¤æ–­æ˜¯å¦æ˜¯è½è…•çš„åŠ¨ä½œã€‚ ç¬¦åˆçš„è½è…•çš„åŠ¨ä½œåï¼Œsensor ä¸ŠæŠ¥ eventã€‚ framework ç›‘å¬è·å–åè¿›è¡Œç­å±çš„åˆ¤æ–­åŠ¨ä½œã€‚ èƒŒæ™¯ä»‹ç» æ—©èµ·çš„ Android å¹³å°ï¼ŒSensor æ˜¯æ”¾åœ¨ AP ä¾§å®ç°çš„ï¼ŒSensor ç”Ÿæˆè®¾å¤‡èŠ‚ç‚¹ä¾›ä¸Šå±‚ä½¿ç”¨ï¼ŒSensor çš„å·¥ä½œ CPU å°±ä¸èƒ½å®Œå¥½çš„ä¼‘çœ ã€‚ åç»­çš„é«˜ç‰ˆæœ¬ android å„ä¸ªå¹³å°å‚å•†éƒ½æœ‰äº†ä¸åŒçš„æ–¹æ¡ˆï¼ŒSensorHubï¼ŒADSP SensorHub ä¸ªäººç†è§£å•Šï¼ŒSensorHub åº”è¯¥ç®—ä¸€ä¸ªç‹¬ç«‹çš„å­ç³»ç»Ÿï¼ŒMCUï¼Œå¯ä»¥ä¸ä¾èµ– CPU æ¶æ„ç‹¬ç«‹è¿è¡Œï¼Œå¯ä»¥è¾ƒå¤§çš„ç¨‹åº¦çœç”µã€‚ä¸»è¦åŠŸèƒ½å°±æ˜¯è¿æ¥å„ç±» sensor å¹¶ä¸”å»å¤„ç†ï¼ŒMTK é‡‡ç”¨çš„è¯¥æ–¹æ¡ˆï¼Œä½¿ç”¨çš„æ˜¯ SRAM æ¶æ„ï¼Œé€šç”µå°±å¯ä»¥ä¿å­˜æ•°æ®ï¼Œç›¸å¯¹å†…å­˜éœ€è¦ä¸åœçš„åˆ·æ–°ï¼Œé•¿æœŸè¿è¡Œå¯ä»¥èŠ‚çœç”¨ç”µã€‚ ADSP ADSP éƒ¨åˆ† ä¹‹å‰æŠŠè½è…•çš„æ£€æµ‹æ”¾åœ¨ framework é‡Œé¢å®ç°ï¼Œåœ¨äº®å±ä¹‹åï¼Œç›‘å¬ Asensor å’Œ GSensorï¼Œåšä¸ºè½è…•å…¶å®åªåœ¨äº®å±åä½¿ç”¨ï¼Œæ•´ä½“ä¸Šæ¥è¯´ï¼Œæ˜¯ä¸å½±å“è€—æµã€‚ å°†ç®—æ³•ä¸‹æ²‰åˆ° ADSPï¼Œä¸»è¦è€ƒè™‘åç»­æ–¹æ¡ˆçš„é€‚é…æ€§ï¼Œé’ˆå¯¹ä¸€äº›ä½è€—æµçš„éœ€æ±‚ï¼Œå¯ä»¥èƒ½å¤Ÿè¾ƒå¥½çš„æ»¡è¶³ã€‚ ç¼–è¯‘ è®°å½•æˆ‘ç›®å‰ç¼–è¯‘çš„ä¸€ä¸ªé—®é¢˜ï¼Œå®Œæ•´çš„ AMSS ç¼–è¯‘ OKï¼Œä½†æ˜¯å•ç‹¬ç¼–è¯‘ ADSP çš„æ—¶å€™å°±ä¼šæŠ¥é”™ RuntimeError: Cannot proceed with encryption/decryption: openssl v1.0.1 is unavailable. åº”è¯¥æ˜¯ç¼–è¯‘å‡º adsp çš„ mbn åï¼Œç­¾åæ‰¾ä¸åˆ° openssl å¯¼è‡´çš„ï¼Œå…¨ç¼–è¯‘å’Œå•ç¼–è¯‘çš„ç¯å¢ƒå˜é‡å¯èƒ½æœ‰ä¸ªç¯èŠ‚æœ‰é—®é¢˜ã€‚åæ¥æ·»åŠ äº†ç¼–è¯‘çš„ç¯å¢ƒå˜é‡æ‰èƒ½å¤Ÿæ­£å¸¸çš„ç¼–è¯‘ export PATH=/pkg/qct/software/python/2.7/bin:$PATH è™šæ‹Ÿåˆæˆ Sensor æ·»åŠ  è¿™éƒ¨åˆ†æ˜¯é©±åŠ¨åŒäº‹åšçš„ï¼Œç›®å‰æˆ‘åªæ˜¯è®°å½•ä¸‹æ¥ï¼Œå…·ä½“ä»£ç æˆ‘ä¹ŸåŒæ­¥åœ¨äº† Media\u0026File -\u003e WristDown è·¯å¾„ä¸‹é¢ ä¸»è¦ä¸€ä¸ªæ˜¯åœ¨ adsp_proc/ssc/build/ssc.scons å’Œ adsp_proc/ssc_api/build/ssc_api.scons ä¸‹æ·»åŠ  sensor diff --git a/adsp_proc/ssc/build/ssc.scons b/adsp_proc/ssc/build/ssc.scons index 8b6ab05..28f98a9 100755 (executable) --- a/adsp_proc/ssc/build/ssc.scons +++ b/adsp_proc/ssc/build/ssc.scons @@ -129,7 +129,7 @@ if env.IsKeyEnable(ssc_build_tags) is True: #------------------------------------------------------------------------------- - 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc', + 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc','sns_wrist_tilt_updown', 'pah_813x_algo','pah_hr','sns_pah_hrd_algo_lib'] #------------------------------------------------------------------------------- diff --git a/adsp_proc/ssc_api/build/ssc_api.scons b/adsp_proc/ssc_api/build/ssc_api.scons index b5ca9ee..d67bc30 100755 (executable) --- a/adsp_proc/ssc_api/build/ssc_api.scons +++ b/adsp_proc/ssc_api/build/ssc_api.scons @@ -127,7 +127,8 @@ WHITELIST = [ 'sns_heart_rate.proto', 'sns_offbody_detect.proto', 'sns_ppg.proto', - 'sns_philips_vso.proto'] + 'sns_philips_vso.proto', + 'sns_wrist_tilt_updown.proto'] if 'SENSORS_ALGO_DEV_FLAG' in env: WHITELIST += [ sensor hal é‡Œé¢ä¹Ÿè¦æ·»åŠ  ç®—æ³•æ·»åŠ  ä¸»è¦æ˜¯åœ¨ adsp_proc/ssc/sensors/wrist_tilt_updown/src/sns_wrist_tilt_updown_sensor_instance_island.c é‡Œé¢ï¼Œ æ ¹æ®è·å–åˆ°çš„ Asensor å’Œ Gsensor æ•°æ®æ¥è®¡ç®—å¤„ç† ç®—æ³•éƒ¨åˆ† æ•°æ®ç»“æ„ å®šä¹‰äº†ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œç”¨æ¥ä¿å­˜ A sensor å’Œ G sensor çš„æ•°æ® /*=========================================================================== LinkedList Definitions ===========================================================================*/ /* init */ void LinkedList_init(LinkedList *list, int capacity) { list-\u003eelements = (SensorState *)malloc(sizeof(SensorState) * capacity); list-\u003efront = 0; list-\u003erear = -1; list-\u003ecapacity = capacity; list-\u003ecount = 0; } /* destory */ void LinkedList_destroy(LinkedList *list) { free(list-\u003eelements); } /* add item to the tail */ void LinkedList_enqueue(LinkedList *list, SensorState item,sns_sensor_instance *const this) { list-\u003erear = (list-\u003erear + 1) % list-\u003ecapacity; list-\u003eelements[list-\u003erear] = item; SNS_INST_PRINTF(ERROR, this, \"wentao LinkedList_enqueue item speed = %d /1000\", (int) (1000*item.mSpeed) ); if (list-\u003ecount \u003c list-\u003ecapacity) { list-\u003ecount++; } else { list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; } } /* remove oldest item */ SensorState LinkedList_dequeue(LinkedList *list) { SensorState item = list-\u003eelements[list-\u003efront]; list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; list-\u003ecount--; return item; } typedef struct { double mSpeed; float x; float y; float z; uint64_t timestamp; } SensorState; typedef struct { SensorState *elements; int front; int rear; int capacity; int count; } LinkedList; è¿åŠ¨æ£€æµ‹ é‡‡æ ·æ•°æ® a Sensor åŠ é€Ÿåº¦ g Sensor è§’é€Ÿåº¦ è¿åŠ¨æ£€æµ‹ä¸»è¦æ ¹æ®åŠ é€Ÿåº¦æ¥è®¡ç®—ã€‚ ç›®å‰çš„è¿åŠ¨æ£€æµ‹ç®—æ³• æ ¹æ®ç»éªŒå€¼æ¥åˆ¤æ–­ï¼Œåç»­å¦‚æœæœ‰ä¼˜åŒ–æœºä¼šï¼Œè¿˜æ˜¯è€ƒè™‘é‡‡ç”¨æ›´ç§‘å­¦çš„è®¡ç®—æ–¹æ³•ã€‚ //è¿™é‡Œé¢é‡‡æ ·é¢‘ç‡å¤§æ¦‚80msä¸€æ¬¡ï¼Œé‚£ä¹ˆä¸€ä¸ª10ä¸ªå•ä½çš„é‡‡æ ·æ•°ç»„ï¼Œå¤§æ¦‚èƒ½è®°å½•åˆ°0.8ç§’å‰çš„æ•°æ®ã€‚ float deltaX = x - lastX; float deltaY = y - lastY; float deltaZ = z - lastZ; //é€šè¿‡è®¡ç®—åŠ é€Ÿåº¦å·®å€¼çš„å¼€æ–¹é™¤ä»¥é—´éš”æ—¶é—´ï¼Œä½œä¸ºå°±æ£€æµ‹è¿åŠ¨å¼ºåº¦çš„åˆ¤æ–­ä¾æ® float sqrtV","date":"2024-11-06","objectID":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/:0:0","tags":["å®æˆ˜","ç®—æ³•ç ”ç©¶","blog","sensor"],"title":"adsp wristdown æµç¨‹ä¸å®ç°","uri":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/#"},{"categories":["Android"],"collections":["WMS"],"content":"#Peppermill #ç®—æ³•ç ”ç©¶ ç›®å‰ è½è…•ç­å±ç®—æ³•å¤§è‡´åœ¨ framework å±‚å®ç°ã€‚ ç›®å‰ç®—æ³•çš„æ€è·¯ï¼š #è¿åŠ¨æ£€æµ‹ï¼Œé€šè¿‡ä¸€äº›ç‰¹å¾å€¼ï¼Œæ¥åˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªè¿åŠ¨æ®µè½ã€‚ ç¬¦åˆçš„è¿åŠ¨æ£€æµ‹åï¼Œæˆ‘ä»¬æ¥åˆ¤æ–­æ˜¯å¦æ˜¯è½è…•çš„åŠ¨ä½œã€‚ ç¬¦åˆçš„è½è…•çš„åŠ¨ä½œåï¼Œsensor ä¸ŠæŠ¥ eventã€‚ framework ç›‘å¬è·å–åè¿›è¡Œç­å±çš„åˆ¤æ–­åŠ¨ä½œã€‚ èƒŒæ™¯ä»‹ç» æ—©èµ·çš„ Android å¹³å°ï¼ŒSensor æ˜¯æ”¾åœ¨ AP ä¾§å®ç°çš„ï¼ŒSensor ç”Ÿæˆè®¾å¤‡èŠ‚ç‚¹ä¾›ä¸Šå±‚ä½¿ç”¨ï¼ŒSensor çš„å·¥ä½œ CPU å°±ä¸èƒ½å®Œå¥½çš„ä¼‘çœ ã€‚ åç»­çš„é«˜ç‰ˆæœ¬ android å„ä¸ªå¹³å°å‚å•†éƒ½æœ‰äº†ä¸åŒçš„æ–¹æ¡ˆï¼ŒSensorHubï¼ŒADSP SensorHub ä¸ªäººç†è§£å•Šï¼ŒSensorHub åº”è¯¥ç®—ä¸€ä¸ªç‹¬ç«‹çš„å­ç³»ç»Ÿï¼ŒMCUï¼Œå¯ä»¥ä¸ä¾èµ– CPU æ¶æ„ç‹¬ç«‹è¿è¡Œï¼Œå¯ä»¥è¾ƒå¤§çš„ç¨‹åº¦çœç”µã€‚ä¸»è¦åŠŸèƒ½å°±æ˜¯è¿æ¥å„ç±» sensor å¹¶ä¸”å»å¤„ç†ï¼ŒMTK é‡‡ç”¨çš„è¯¥æ–¹æ¡ˆï¼Œä½¿ç”¨çš„æ˜¯ SRAM æ¶æ„ï¼Œé€šç”µå°±å¯ä»¥ä¿å­˜æ•°æ®ï¼Œç›¸å¯¹å†…å­˜éœ€è¦ä¸åœçš„åˆ·æ–°ï¼Œé•¿æœŸè¿è¡Œå¯ä»¥èŠ‚çœç”¨ç”µã€‚ ADSP ADSP éƒ¨åˆ† ä¹‹å‰æŠŠè½è…•çš„æ£€æµ‹æ”¾åœ¨ framework é‡Œé¢å®ç°ï¼Œåœ¨äº®å±ä¹‹åï¼Œç›‘å¬ Asensor å’Œ GSensorï¼Œåšä¸ºè½è…•å…¶å®åªåœ¨äº®å±åä½¿ç”¨ï¼Œæ•´ä½“ä¸Šæ¥è¯´ï¼Œæ˜¯ä¸å½±å“è€—æµã€‚ å°†ç®—æ³•ä¸‹æ²‰åˆ° ADSPï¼Œä¸»è¦è€ƒè™‘åç»­æ–¹æ¡ˆçš„é€‚é…æ€§ï¼Œé’ˆå¯¹ä¸€äº›ä½è€—æµçš„éœ€æ±‚ï¼Œå¯ä»¥èƒ½å¤Ÿè¾ƒå¥½çš„æ»¡è¶³ã€‚ ç¼–è¯‘ è®°å½•æˆ‘ç›®å‰ç¼–è¯‘çš„ä¸€ä¸ªé—®é¢˜ï¼Œå®Œæ•´çš„ AMSS ç¼–è¯‘ OKï¼Œä½†æ˜¯å•ç‹¬ç¼–è¯‘ ADSP çš„æ—¶å€™å°±ä¼šæŠ¥é”™ RuntimeError: Cannot proceed with encryption/decryption: openssl v1.0.1 is unavailable. åº”è¯¥æ˜¯ç¼–è¯‘å‡º adsp çš„ mbn åï¼Œç­¾åæ‰¾ä¸åˆ° openssl å¯¼è‡´çš„ï¼Œå…¨ç¼–è¯‘å’Œå•ç¼–è¯‘çš„ç¯å¢ƒå˜é‡å¯èƒ½æœ‰ä¸ªç¯èŠ‚æœ‰é—®é¢˜ã€‚åæ¥æ·»åŠ äº†ç¼–è¯‘çš„ç¯å¢ƒå˜é‡æ‰èƒ½å¤Ÿæ­£å¸¸çš„ç¼–è¯‘ export PATH=/pkg/qct/software/python/2.7/bin:$PATH è™šæ‹Ÿåˆæˆ Sensor æ·»åŠ  è¿™éƒ¨åˆ†æ˜¯é©±åŠ¨åŒäº‹åšçš„ï¼Œç›®å‰æˆ‘åªæ˜¯è®°å½•ä¸‹æ¥ï¼Œå…·ä½“ä»£ç æˆ‘ä¹ŸåŒæ­¥åœ¨äº† Media\u0026File -\u003e WristDown è·¯å¾„ä¸‹é¢ ä¸»è¦ä¸€ä¸ªæ˜¯åœ¨ adsp_proc/ssc/build/ssc.scons å’Œ adsp_proc/ssc_api/build/ssc_api.scons ä¸‹æ·»åŠ  sensor diff --git a/adsp_proc/ssc/build/ssc.scons b/adsp_proc/ssc/build/ssc.scons index 8b6ab05..28f98a9 100755 (executable) --- a/adsp_proc/ssc/build/ssc.scons +++ b/adsp_proc/ssc/build/ssc.scons @@ -129,7 +129,7 @@ if env.IsKeyEnable(ssc_build_tags) is True: #------------------------------------------------------------------------------- - 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc', + 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc','sns_wrist_tilt_updown', 'pah_813x_algo','pah_hr','sns_pah_hrd_algo_lib'] #------------------------------------------------------------------------------- diff --git a/adsp_proc/ssc_api/build/ssc_api.scons b/adsp_proc/ssc_api/build/ssc_api.scons index b5ca9ee..d67bc30 100755 (executable) --- a/adsp_proc/ssc_api/build/ssc_api.scons +++ b/adsp_proc/ssc_api/build/ssc_api.scons @@ -127,7 +127,8 @@ WHITELIST = [ 'sns_heart_rate.proto', 'sns_offbody_detect.proto', 'sns_ppg.proto', - 'sns_philips_vso.proto'] + 'sns_philips_vso.proto', + 'sns_wrist_tilt_updown.proto'] if 'SENSORS_ALGO_DEV_FLAG' in env: WHITELIST += [ sensor hal é‡Œé¢ä¹Ÿè¦æ·»åŠ  ç®—æ³•æ·»åŠ  ä¸»è¦æ˜¯åœ¨ adsp_proc/ssc/sensors/wrist_tilt_updown/src/sns_wrist_tilt_updown_sensor_instance_island.c é‡Œé¢ï¼Œ æ ¹æ®è·å–åˆ°çš„ Asensor å’Œ Gsensor æ•°æ®æ¥è®¡ç®—å¤„ç† ç®—æ³•éƒ¨åˆ† æ•°æ®ç»“æ„ å®šä¹‰äº†ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œç”¨æ¥ä¿å­˜ A sensor å’Œ G sensor çš„æ•°æ® /*=========================================================================== LinkedList Definitions ===========================================================================*/ /* init */ void LinkedList_init(LinkedList *list, int capacity) { list-\u003eelements = (SensorState *)malloc(sizeof(SensorState) * capacity); list-\u003efront = 0; list-\u003erear = -1; list-\u003ecapacity = capacity; list-\u003ecount = 0; } /* destory */ void LinkedList_destroy(LinkedList *list) { free(list-\u003eelements); } /* add item to the tail */ void LinkedList_enqueue(LinkedList *list, SensorState item,sns_sensor_instance *const this) { list-\u003erear = (list-\u003erear + 1) % list-\u003ecapacity; list-\u003eelements[list-\u003erear] = item; SNS_INST_PRINTF(ERROR, this, \"wentao LinkedList_enqueue item speed = %d /1000\", (int) (1000*item.mSpeed) ); if (list-\u003ecount \u003c list-\u003ecapacity) { list-\u003ecount++; } else { list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; } } /* remove oldest item */ SensorState LinkedList_dequeue(LinkedList *list) { SensorState item = list-\u003eelements[list-\u003efront]; list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; list-\u003ecount--; return item; } typedef struct { double mSpeed; float x; float y; float z; uint64_t timestamp; } SensorState; typedef struct { SensorState *elements; int front; int rear; int capacity; int count; } LinkedList; è¿åŠ¨æ£€æµ‹ é‡‡æ ·æ•°æ® a Sensor åŠ é€Ÿåº¦ g Sensor è§’é€Ÿåº¦ è¿åŠ¨æ£€æµ‹ä¸»è¦æ ¹æ®åŠ é€Ÿåº¦æ¥è®¡ç®—ã€‚ ç›®å‰çš„è¿åŠ¨æ£€æµ‹ç®—æ³• æ ¹æ®ç»éªŒå€¼æ¥åˆ¤æ–­ï¼Œåç»­å¦‚æœæœ‰ä¼˜åŒ–æœºä¼šï¼Œè¿˜æ˜¯è€ƒè™‘é‡‡ç”¨æ›´ç§‘å­¦çš„è®¡ç®—æ–¹æ³•ã€‚ //è¿™é‡Œé¢é‡‡æ ·é¢‘ç‡å¤§æ¦‚80msä¸€æ¬¡ï¼Œé‚£ä¹ˆä¸€ä¸ª10ä¸ªå•ä½çš„é‡‡æ ·æ•°ç»„ï¼Œå¤§æ¦‚èƒ½è®°å½•åˆ°0.8ç§’å‰çš„æ•°æ®ã€‚ float deltaX = x - lastX; float deltaY = y - lastY; float deltaZ = z - lastZ; //é€šè¿‡è®¡ç®—åŠ é€Ÿåº¦å·®å€¼çš„å¼€æ–¹é™¤ä»¥é—´éš”æ—¶é—´ï¼Œä½œä¸ºå°±æ£€æµ‹è¿åŠ¨å¼ºåº¦çš„åˆ¤æ–­ä¾æ® float sqrtV","date":"2024-11-06","objectID":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/:0:0","tags":["å®æˆ˜","ç®—æ³•ç ”ç©¶","blog","sensor"],"title":"adsp wristdown æµç¨‹ä¸å®ç°","uri":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/#èƒŒæ™¯ä»‹ç»"},{"categories":["Android"],"collections":["WMS"],"content":"#Peppermill #ç®—æ³•ç ”ç©¶ ç›®å‰ è½è…•ç­å±ç®—æ³•å¤§è‡´åœ¨ framework å±‚å®ç°ã€‚ ç›®å‰ç®—æ³•çš„æ€è·¯ï¼š #è¿åŠ¨æ£€æµ‹ï¼Œé€šè¿‡ä¸€äº›ç‰¹å¾å€¼ï¼Œæ¥åˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªè¿åŠ¨æ®µè½ã€‚ ç¬¦åˆçš„è¿åŠ¨æ£€æµ‹åï¼Œæˆ‘ä»¬æ¥åˆ¤æ–­æ˜¯å¦æ˜¯è½è…•çš„åŠ¨ä½œã€‚ ç¬¦åˆçš„è½è…•çš„åŠ¨ä½œåï¼Œsensor ä¸ŠæŠ¥ eventã€‚ framework ç›‘å¬è·å–åè¿›è¡Œç­å±çš„åˆ¤æ–­åŠ¨ä½œã€‚ èƒŒæ™¯ä»‹ç» æ—©èµ·çš„ Android å¹³å°ï¼ŒSensor æ˜¯æ”¾åœ¨ AP ä¾§å®ç°çš„ï¼ŒSensor ç”Ÿæˆè®¾å¤‡èŠ‚ç‚¹ä¾›ä¸Šå±‚ä½¿ç”¨ï¼ŒSensor çš„å·¥ä½œ CPU å°±ä¸èƒ½å®Œå¥½çš„ä¼‘çœ ã€‚ åç»­çš„é«˜ç‰ˆæœ¬ android å„ä¸ªå¹³å°å‚å•†éƒ½æœ‰äº†ä¸åŒçš„æ–¹æ¡ˆï¼ŒSensorHubï¼ŒADSP SensorHub ä¸ªäººç†è§£å•Šï¼ŒSensorHub åº”è¯¥ç®—ä¸€ä¸ªç‹¬ç«‹çš„å­ç³»ç»Ÿï¼ŒMCUï¼Œå¯ä»¥ä¸ä¾èµ– CPU æ¶æ„ç‹¬ç«‹è¿è¡Œï¼Œå¯ä»¥è¾ƒå¤§çš„ç¨‹åº¦çœç”µã€‚ä¸»è¦åŠŸèƒ½å°±æ˜¯è¿æ¥å„ç±» sensor å¹¶ä¸”å»å¤„ç†ï¼ŒMTK é‡‡ç”¨çš„è¯¥æ–¹æ¡ˆï¼Œä½¿ç”¨çš„æ˜¯ SRAM æ¶æ„ï¼Œé€šç”µå°±å¯ä»¥ä¿å­˜æ•°æ®ï¼Œç›¸å¯¹å†…å­˜éœ€è¦ä¸åœçš„åˆ·æ–°ï¼Œé•¿æœŸè¿è¡Œå¯ä»¥èŠ‚çœç”¨ç”µã€‚ ADSP ADSP éƒ¨åˆ† ä¹‹å‰æŠŠè½è…•çš„æ£€æµ‹æ”¾åœ¨ framework é‡Œé¢å®ç°ï¼Œåœ¨äº®å±ä¹‹åï¼Œç›‘å¬ Asensor å’Œ GSensorï¼Œåšä¸ºè½è…•å…¶å®åªåœ¨äº®å±åä½¿ç”¨ï¼Œæ•´ä½“ä¸Šæ¥è¯´ï¼Œæ˜¯ä¸å½±å“è€—æµã€‚ å°†ç®—æ³•ä¸‹æ²‰åˆ° ADSPï¼Œä¸»è¦è€ƒè™‘åç»­æ–¹æ¡ˆçš„é€‚é…æ€§ï¼Œé’ˆå¯¹ä¸€äº›ä½è€—æµçš„éœ€æ±‚ï¼Œå¯ä»¥èƒ½å¤Ÿè¾ƒå¥½çš„æ»¡è¶³ã€‚ ç¼–è¯‘ è®°å½•æˆ‘ç›®å‰ç¼–è¯‘çš„ä¸€ä¸ªé—®é¢˜ï¼Œå®Œæ•´çš„ AMSS ç¼–è¯‘ OKï¼Œä½†æ˜¯å•ç‹¬ç¼–è¯‘ ADSP çš„æ—¶å€™å°±ä¼šæŠ¥é”™ RuntimeError: Cannot proceed with encryption/decryption: openssl v1.0.1 is unavailable. åº”è¯¥æ˜¯ç¼–è¯‘å‡º adsp çš„ mbn åï¼Œç­¾åæ‰¾ä¸åˆ° openssl å¯¼è‡´çš„ï¼Œå…¨ç¼–è¯‘å’Œå•ç¼–è¯‘çš„ç¯å¢ƒå˜é‡å¯èƒ½æœ‰ä¸ªç¯èŠ‚æœ‰é—®é¢˜ã€‚åæ¥æ·»åŠ äº†ç¼–è¯‘çš„ç¯å¢ƒå˜é‡æ‰èƒ½å¤Ÿæ­£å¸¸çš„ç¼–è¯‘ export PATH=/pkg/qct/software/python/2.7/bin:$PATH è™šæ‹Ÿåˆæˆ Sensor æ·»åŠ  è¿™éƒ¨åˆ†æ˜¯é©±åŠ¨åŒäº‹åšçš„ï¼Œç›®å‰æˆ‘åªæ˜¯è®°å½•ä¸‹æ¥ï¼Œå…·ä½“ä»£ç æˆ‘ä¹ŸåŒæ­¥åœ¨äº† Media\u0026File -\u003e WristDown è·¯å¾„ä¸‹é¢ ä¸»è¦ä¸€ä¸ªæ˜¯åœ¨ adsp_proc/ssc/build/ssc.scons å’Œ adsp_proc/ssc_api/build/ssc_api.scons ä¸‹æ·»åŠ  sensor diff --git a/adsp_proc/ssc/build/ssc.scons b/adsp_proc/ssc/build/ssc.scons index 8b6ab05..28f98a9 100755 (executable) --- a/adsp_proc/ssc/build/ssc.scons +++ b/adsp_proc/ssc/build/ssc.scons @@ -129,7 +129,7 @@ if env.IsKeyEnable(ssc_build_tags) is True: #------------------------------------------------------------------------------- - 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc', + 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc','sns_wrist_tilt_updown', 'pah_813x_algo','pah_hr','sns_pah_hrd_algo_lib'] #------------------------------------------------------------------------------- diff --git a/adsp_proc/ssc_api/build/ssc_api.scons b/adsp_proc/ssc_api/build/ssc_api.scons index b5ca9ee..d67bc30 100755 (executable) --- a/adsp_proc/ssc_api/build/ssc_api.scons +++ b/adsp_proc/ssc_api/build/ssc_api.scons @@ -127,7 +127,8 @@ WHITELIST = [ 'sns_heart_rate.proto', 'sns_offbody_detect.proto', 'sns_ppg.proto', - 'sns_philips_vso.proto'] + 'sns_philips_vso.proto', + 'sns_wrist_tilt_updown.proto'] if 'SENSORS_ALGO_DEV_FLAG' in env: WHITELIST += [ sensor hal é‡Œé¢ä¹Ÿè¦æ·»åŠ  ç®—æ³•æ·»åŠ  ä¸»è¦æ˜¯åœ¨ adsp_proc/ssc/sensors/wrist_tilt_updown/src/sns_wrist_tilt_updown_sensor_instance_island.c é‡Œé¢ï¼Œ æ ¹æ®è·å–åˆ°çš„ Asensor å’Œ Gsensor æ•°æ®æ¥è®¡ç®—å¤„ç† ç®—æ³•éƒ¨åˆ† æ•°æ®ç»“æ„ å®šä¹‰äº†ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œç”¨æ¥ä¿å­˜ A sensor å’Œ G sensor çš„æ•°æ® /*=========================================================================== LinkedList Definitions ===========================================================================*/ /* init */ void LinkedList_init(LinkedList *list, int capacity) { list-\u003eelements = (SensorState *)malloc(sizeof(SensorState) * capacity); list-\u003efront = 0; list-\u003erear = -1; list-\u003ecapacity = capacity; list-\u003ecount = 0; } /* destory */ void LinkedList_destroy(LinkedList *list) { free(list-\u003eelements); } /* add item to the tail */ void LinkedList_enqueue(LinkedList *list, SensorState item,sns_sensor_instance *const this) { list-\u003erear = (list-\u003erear + 1) % list-\u003ecapacity; list-\u003eelements[list-\u003erear] = item; SNS_INST_PRINTF(ERROR, this, \"wentao LinkedList_enqueue item speed = %d /1000\", (int) (1000*item.mSpeed) ); if (list-\u003ecount \u003c list-\u003ecapacity) { list-\u003ecount++; } else { list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; } } /* remove oldest item */ SensorState LinkedList_dequeue(LinkedList *list) { SensorState item = list-\u003eelements[list-\u003efront]; list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; list-\u003ecount--; return item; } typedef struct { double mSpeed; float x; float y; float z; uint64_t timestamp; } SensorState; typedef struct { SensorState *elements; int front; int rear; int capacity; int count; } LinkedList; è¿åŠ¨æ£€æµ‹ é‡‡æ ·æ•°æ® a Sensor åŠ é€Ÿåº¦ g Sensor è§’é€Ÿåº¦ è¿åŠ¨æ£€æµ‹ä¸»è¦æ ¹æ®åŠ é€Ÿåº¦æ¥è®¡ç®—ã€‚ ç›®å‰çš„è¿åŠ¨æ£€æµ‹ç®—æ³• æ ¹æ®ç»éªŒå€¼æ¥åˆ¤æ–­ï¼Œåç»­å¦‚æœæœ‰ä¼˜åŒ–æœºä¼šï¼Œè¿˜æ˜¯è€ƒè™‘é‡‡ç”¨æ›´ç§‘å­¦çš„è®¡ç®—æ–¹æ³•ã€‚ //è¿™é‡Œé¢é‡‡æ ·é¢‘ç‡å¤§æ¦‚80msä¸€æ¬¡ï¼Œé‚£ä¹ˆä¸€ä¸ª10ä¸ªå•ä½çš„é‡‡æ ·æ•°ç»„ï¼Œå¤§æ¦‚èƒ½è®°å½•åˆ°0.8ç§’å‰çš„æ•°æ®ã€‚ float deltaX = x - lastX; float deltaY = y - lastY; float deltaZ = z - lastZ; //é€šè¿‡è®¡ç®—åŠ é€Ÿåº¦å·®å€¼çš„å¼€æ–¹é™¤ä»¥é—´éš”æ—¶é—´ï¼Œä½œä¸ºå°±æ£€æµ‹è¿åŠ¨å¼ºåº¦çš„åˆ¤æ–­ä¾æ® float sqrtV","date":"2024-11-06","objectID":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/:0:0","tags":["å®æˆ˜","ç®—æ³•ç ”ç©¶","blog","sensor"],"title":"adsp wristdown æµç¨‹ä¸å®ç°","uri":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/#sensorhub"},{"categories":["Android"],"collections":["WMS"],"content":"#Peppermill #ç®—æ³•ç ”ç©¶ ç›®å‰ è½è…•ç­å±ç®—æ³•å¤§è‡´åœ¨ framework å±‚å®ç°ã€‚ ç›®å‰ç®—æ³•çš„æ€è·¯ï¼š #è¿åŠ¨æ£€æµ‹ï¼Œé€šè¿‡ä¸€äº›ç‰¹å¾å€¼ï¼Œæ¥åˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªè¿åŠ¨æ®µè½ã€‚ ç¬¦åˆçš„è¿åŠ¨æ£€æµ‹åï¼Œæˆ‘ä»¬æ¥åˆ¤æ–­æ˜¯å¦æ˜¯è½è…•çš„åŠ¨ä½œã€‚ ç¬¦åˆçš„è½è…•çš„åŠ¨ä½œåï¼Œsensor ä¸ŠæŠ¥ eventã€‚ framework ç›‘å¬è·å–åè¿›è¡Œç­å±çš„åˆ¤æ–­åŠ¨ä½œã€‚ èƒŒæ™¯ä»‹ç» æ—©èµ·çš„ Android å¹³å°ï¼ŒSensor æ˜¯æ”¾åœ¨ AP ä¾§å®ç°çš„ï¼ŒSensor ç”Ÿæˆè®¾å¤‡èŠ‚ç‚¹ä¾›ä¸Šå±‚ä½¿ç”¨ï¼ŒSensor çš„å·¥ä½œ CPU å°±ä¸èƒ½å®Œå¥½çš„ä¼‘çœ ã€‚ åç»­çš„é«˜ç‰ˆæœ¬ android å„ä¸ªå¹³å°å‚å•†éƒ½æœ‰äº†ä¸åŒçš„æ–¹æ¡ˆï¼ŒSensorHubï¼ŒADSP SensorHub ä¸ªäººç†è§£å•Šï¼ŒSensorHub åº”è¯¥ç®—ä¸€ä¸ªç‹¬ç«‹çš„å­ç³»ç»Ÿï¼ŒMCUï¼Œå¯ä»¥ä¸ä¾èµ– CPU æ¶æ„ç‹¬ç«‹è¿è¡Œï¼Œå¯ä»¥è¾ƒå¤§çš„ç¨‹åº¦çœç”µã€‚ä¸»è¦åŠŸèƒ½å°±æ˜¯è¿æ¥å„ç±» sensor å¹¶ä¸”å»å¤„ç†ï¼ŒMTK é‡‡ç”¨çš„è¯¥æ–¹æ¡ˆï¼Œä½¿ç”¨çš„æ˜¯ SRAM æ¶æ„ï¼Œé€šç”µå°±å¯ä»¥ä¿å­˜æ•°æ®ï¼Œç›¸å¯¹å†…å­˜éœ€è¦ä¸åœçš„åˆ·æ–°ï¼Œé•¿æœŸè¿è¡Œå¯ä»¥èŠ‚çœç”¨ç”µã€‚ ADSP ADSP éƒ¨åˆ† ä¹‹å‰æŠŠè½è…•çš„æ£€æµ‹æ”¾åœ¨ framework é‡Œé¢å®ç°ï¼Œåœ¨äº®å±ä¹‹åï¼Œç›‘å¬ Asensor å’Œ GSensorï¼Œåšä¸ºè½è…•å…¶å®åªåœ¨äº®å±åä½¿ç”¨ï¼Œæ•´ä½“ä¸Šæ¥è¯´ï¼Œæ˜¯ä¸å½±å“è€—æµã€‚ å°†ç®—æ³•ä¸‹æ²‰åˆ° ADSPï¼Œä¸»è¦è€ƒè™‘åç»­æ–¹æ¡ˆçš„é€‚é…æ€§ï¼Œé’ˆå¯¹ä¸€äº›ä½è€—æµçš„éœ€æ±‚ï¼Œå¯ä»¥èƒ½å¤Ÿè¾ƒå¥½çš„æ»¡è¶³ã€‚ ç¼–è¯‘ è®°å½•æˆ‘ç›®å‰ç¼–è¯‘çš„ä¸€ä¸ªé—®é¢˜ï¼Œå®Œæ•´çš„ AMSS ç¼–è¯‘ OKï¼Œä½†æ˜¯å•ç‹¬ç¼–è¯‘ ADSP çš„æ—¶å€™å°±ä¼šæŠ¥é”™ RuntimeError: Cannot proceed with encryption/decryption: openssl v1.0.1 is unavailable. åº”è¯¥æ˜¯ç¼–è¯‘å‡º adsp çš„ mbn åï¼Œç­¾åæ‰¾ä¸åˆ° openssl å¯¼è‡´çš„ï¼Œå…¨ç¼–è¯‘å’Œå•ç¼–è¯‘çš„ç¯å¢ƒå˜é‡å¯èƒ½æœ‰ä¸ªç¯èŠ‚æœ‰é—®é¢˜ã€‚åæ¥æ·»åŠ äº†ç¼–è¯‘çš„ç¯å¢ƒå˜é‡æ‰èƒ½å¤Ÿæ­£å¸¸çš„ç¼–è¯‘ export PATH=/pkg/qct/software/python/2.7/bin:$PATH è™šæ‹Ÿåˆæˆ Sensor æ·»åŠ  è¿™éƒ¨åˆ†æ˜¯é©±åŠ¨åŒäº‹åšçš„ï¼Œç›®å‰æˆ‘åªæ˜¯è®°å½•ä¸‹æ¥ï¼Œå…·ä½“ä»£ç æˆ‘ä¹ŸåŒæ­¥åœ¨äº† Media\u0026File -\u003e WristDown è·¯å¾„ä¸‹é¢ ä¸»è¦ä¸€ä¸ªæ˜¯åœ¨ adsp_proc/ssc/build/ssc.scons å’Œ adsp_proc/ssc_api/build/ssc_api.scons ä¸‹æ·»åŠ  sensor diff --git a/adsp_proc/ssc/build/ssc.scons b/adsp_proc/ssc/build/ssc.scons index 8b6ab05..28f98a9 100755 (executable) --- a/adsp_proc/ssc/build/ssc.scons +++ b/adsp_proc/ssc/build/ssc.scons @@ -129,7 +129,7 @@ if env.IsKeyEnable(ssc_build_tags) is True: #------------------------------------------------------------------------------- - 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc', + 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc','sns_wrist_tilt_updown', 'pah_813x_algo','pah_hr','sns_pah_hrd_algo_lib'] #------------------------------------------------------------------------------- diff --git a/adsp_proc/ssc_api/build/ssc_api.scons b/adsp_proc/ssc_api/build/ssc_api.scons index b5ca9ee..d67bc30 100755 (executable) --- a/adsp_proc/ssc_api/build/ssc_api.scons +++ b/adsp_proc/ssc_api/build/ssc_api.scons @@ -127,7 +127,8 @@ WHITELIST = [ 'sns_heart_rate.proto', 'sns_offbody_detect.proto', 'sns_ppg.proto', - 'sns_philips_vso.proto'] + 'sns_philips_vso.proto', + 'sns_wrist_tilt_updown.proto'] if 'SENSORS_ALGO_DEV_FLAG' in env: WHITELIST += [ sensor hal é‡Œé¢ä¹Ÿè¦æ·»åŠ  ç®—æ³•æ·»åŠ  ä¸»è¦æ˜¯åœ¨ adsp_proc/ssc/sensors/wrist_tilt_updown/src/sns_wrist_tilt_updown_sensor_instance_island.c é‡Œé¢ï¼Œ æ ¹æ®è·å–åˆ°çš„ Asensor å’Œ Gsensor æ•°æ®æ¥è®¡ç®—å¤„ç† ç®—æ³•éƒ¨åˆ† æ•°æ®ç»“æ„ å®šä¹‰äº†ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œç”¨æ¥ä¿å­˜ A sensor å’Œ G sensor çš„æ•°æ® /*=========================================================================== LinkedList Definitions ===========================================================================*/ /* init */ void LinkedList_init(LinkedList *list, int capacity) { list-\u003eelements = (SensorState *)malloc(sizeof(SensorState) * capacity); list-\u003efront = 0; list-\u003erear = -1; list-\u003ecapacity = capacity; list-\u003ecount = 0; } /* destory */ void LinkedList_destroy(LinkedList *list) { free(list-\u003eelements); } /* add item to the tail */ void LinkedList_enqueue(LinkedList *list, SensorState item,sns_sensor_instance *const this) { list-\u003erear = (list-\u003erear + 1) % list-\u003ecapacity; list-\u003eelements[list-\u003erear] = item; SNS_INST_PRINTF(ERROR, this, \"wentao LinkedList_enqueue item speed = %d /1000\", (int) (1000*item.mSpeed) ); if (list-\u003ecount \u003c list-\u003ecapacity) { list-\u003ecount++; } else { list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; } } /* remove oldest item */ SensorState LinkedList_dequeue(LinkedList *list) { SensorState item = list-\u003eelements[list-\u003efront]; list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; list-\u003ecount--; return item; } typedef struct { double mSpeed; float x; float y; float z; uint64_t timestamp; } SensorState; typedef struct { SensorState *elements; int front; int rear; int capacity; int count; } LinkedList; è¿åŠ¨æ£€æµ‹ é‡‡æ ·æ•°æ® a Sensor åŠ é€Ÿåº¦ g Sensor è§’é€Ÿåº¦ è¿åŠ¨æ£€æµ‹ä¸»è¦æ ¹æ®åŠ é€Ÿåº¦æ¥è®¡ç®—ã€‚ ç›®å‰çš„è¿åŠ¨æ£€æµ‹ç®—æ³• æ ¹æ®ç»éªŒå€¼æ¥åˆ¤æ–­ï¼Œåç»­å¦‚æœæœ‰ä¼˜åŒ–æœºä¼šï¼Œè¿˜æ˜¯è€ƒè™‘é‡‡ç”¨æ›´ç§‘å­¦çš„è®¡ç®—æ–¹æ³•ã€‚ //è¿™é‡Œé¢é‡‡æ ·é¢‘ç‡å¤§æ¦‚80msä¸€æ¬¡ï¼Œé‚£ä¹ˆä¸€ä¸ª10ä¸ªå•ä½çš„é‡‡æ ·æ•°ç»„ï¼Œå¤§æ¦‚èƒ½è®°å½•åˆ°0.8ç§’å‰çš„æ•°æ®ã€‚ float deltaX = x - lastX; float deltaY = y - lastY; float deltaZ = z - lastZ; //é€šè¿‡è®¡ç®—åŠ é€Ÿåº¦å·®å€¼çš„å¼€æ–¹é™¤ä»¥é—´éš”æ—¶é—´ï¼Œä½œä¸ºå°±æ£€æµ‹è¿åŠ¨å¼ºåº¦çš„åˆ¤æ–­ä¾æ® float sqrtV","date":"2024-11-06","objectID":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/:0:0","tags":["å®æˆ˜","ç®—æ³•ç ”ç©¶","blog","sensor"],"title":"adsp wristdown æµç¨‹ä¸å®ç°","uri":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/#adsp"},{"categories":["Android"],"collections":["WMS"],"content":"#Peppermill #ç®—æ³•ç ”ç©¶ ç›®å‰ è½è…•ç­å±ç®—æ³•å¤§è‡´åœ¨ framework å±‚å®ç°ã€‚ ç›®å‰ç®—æ³•çš„æ€è·¯ï¼š #è¿åŠ¨æ£€æµ‹ï¼Œé€šè¿‡ä¸€äº›ç‰¹å¾å€¼ï¼Œæ¥åˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªè¿åŠ¨æ®µè½ã€‚ ç¬¦åˆçš„è¿åŠ¨æ£€æµ‹åï¼Œæˆ‘ä»¬æ¥åˆ¤æ–­æ˜¯å¦æ˜¯è½è…•çš„åŠ¨ä½œã€‚ ç¬¦åˆçš„è½è…•çš„åŠ¨ä½œåï¼Œsensor ä¸ŠæŠ¥ eventã€‚ framework ç›‘å¬è·å–åè¿›è¡Œç­å±çš„åˆ¤æ–­åŠ¨ä½œã€‚ èƒŒæ™¯ä»‹ç» æ—©èµ·çš„ Android å¹³å°ï¼ŒSensor æ˜¯æ”¾åœ¨ AP ä¾§å®ç°çš„ï¼ŒSensor ç”Ÿæˆè®¾å¤‡èŠ‚ç‚¹ä¾›ä¸Šå±‚ä½¿ç”¨ï¼ŒSensor çš„å·¥ä½œ CPU å°±ä¸èƒ½å®Œå¥½çš„ä¼‘çœ ã€‚ åç»­çš„é«˜ç‰ˆæœ¬ android å„ä¸ªå¹³å°å‚å•†éƒ½æœ‰äº†ä¸åŒçš„æ–¹æ¡ˆï¼ŒSensorHubï¼ŒADSP SensorHub ä¸ªäººç†è§£å•Šï¼ŒSensorHub åº”è¯¥ç®—ä¸€ä¸ªç‹¬ç«‹çš„å­ç³»ç»Ÿï¼ŒMCUï¼Œå¯ä»¥ä¸ä¾èµ– CPU æ¶æ„ç‹¬ç«‹è¿è¡Œï¼Œå¯ä»¥è¾ƒå¤§çš„ç¨‹åº¦çœç”µã€‚ä¸»è¦åŠŸèƒ½å°±æ˜¯è¿æ¥å„ç±» sensor å¹¶ä¸”å»å¤„ç†ï¼ŒMTK é‡‡ç”¨çš„è¯¥æ–¹æ¡ˆï¼Œä½¿ç”¨çš„æ˜¯ SRAM æ¶æ„ï¼Œé€šç”µå°±å¯ä»¥ä¿å­˜æ•°æ®ï¼Œç›¸å¯¹å†…å­˜éœ€è¦ä¸åœçš„åˆ·æ–°ï¼Œé•¿æœŸè¿è¡Œå¯ä»¥èŠ‚çœç”¨ç”µã€‚ ADSP ADSP éƒ¨åˆ† ä¹‹å‰æŠŠè½è…•çš„æ£€æµ‹æ”¾åœ¨ framework é‡Œé¢å®ç°ï¼Œåœ¨äº®å±ä¹‹åï¼Œç›‘å¬ Asensor å’Œ GSensorï¼Œåšä¸ºè½è…•å…¶å®åªåœ¨äº®å±åä½¿ç”¨ï¼Œæ•´ä½“ä¸Šæ¥è¯´ï¼Œæ˜¯ä¸å½±å“è€—æµã€‚ å°†ç®—æ³•ä¸‹æ²‰åˆ° ADSPï¼Œä¸»è¦è€ƒè™‘åç»­æ–¹æ¡ˆçš„é€‚é…æ€§ï¼Œé’ˆå¯¹ä¸€äº›ä½è€—æµçš„éœ€æ±‚ï¼Œå¯ä»¥èƒ½å¤Ÿè¾ƒå¥½çš„æ»¡è¶³ã€‚ ç¼–è¯‘ è®°å½•æˆ‘ç›®å‰ç¼–è¯‘çš„ä¸€ä¸ªé—®é¢˜ï¼Œå®Œæ•´çš„ AMSS ç¼–è¯‘ OKï¼Œä½†æ˜¯å•ç‹¬ç¼–è¯‘ ADSP çš„æ—¶å€™å°±ä¼šæŠ¥é”™ RuntimeError: Cannot proceed with encryption/decryption: openssl v1.0.1 is unavailable. åº”è¯¥æ˜¯ç¼–è¯‘å‡º adsp çš„ mbn åï¼Œç­¾åæ‰¾ä¸åˆ° openssl å¯¼è‡´çš„ï¼Œå…¨ç¼–è¯‘å’Œå•ç¼–è¯‘çš„ç¯å¢ƒå˜é‡å¯èƒ½æœ‰ä¸ªç¯èŠ‚æœ‰é—®é¢˜ã€‚åæ¥æ·»åŠ äº†ç¼–è¯‘çš„ç¯å¢ƒå˜é‡æ‰èƒ½å¤Ÿæ­£å¸¸çš„ç¼–è¯‘ export PATH=/pkg/qct/software/python/2.7/bin:$PATH è™šæ‹Ÿåˆæˆ Sensor æ·»åŠ  è¿™éƒ¨åˆ†æ˜¯é©±åŠ¨åŒäº‹åšçš„ï¼Œç›®å‰æˆ‘åªæ˜¯è®°å½•ä¸‹æ¥ï¼Œå…·ä½“ä»£ç æˆ‘ä¹ŸåŒæ­¥åœ¨äº† Media\u0026File -\u003e WristDown è·¯å¾„ä¸‹é¢ ä¸»è¦ä¸€ä¸ªæ˜¯åœ¨ adsp_proc/ssc/build/ssc.scons å’Œ adsp_proc/ssc_api/build/ssc_api.scons ä¸‹æ·»åŠ  sensor diff --git a/adsp_proc/ssc/build/ssc.scons b/adsp_proc/ssc/build/ssc.scons index 8b6ab05..28f98a9 100755 (executable) --- a/adsp_proc/ssc/build/ssc.scons +++ b/adsp_proc/ssc/build/ssc.scons @@ -129,7 +129,7 @@ if env.IsKeyEnable(ssc_build_tags) is True: #------------------------------------------------------------------------------- - 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc', + 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc','sns_wrist_tilt_updown', 'pah_813x_algo','pah_hr','sns_pah_hrd_algo_lib'] #------------------------------------------------------------------------------- diff --git a/adsp_proc/ssc_api/build/ssc_api.scons b/adsp_proc/ssc_api/build/ssc_api.scons index b5ca9ee..d67bc30 100755 (executable) --- a/adsp_proc/ssc_api/build/ssc_api.scons +++ b/adsp_proc/ssc_api/build/ssc_api.scons @@ -127,7 +127,8 @@ WHITELIST = [ 'sns_heart_rate.proto', 'sns_offbody_detect.proto', 'sns_ppg.proto', - 'sns_philips_vso.proto'] + 'sns_philips_vso.proto', + 'sns_wrist_tilt_updown.proto'] if 'SENSORS_ALGO_DEV_FLAG' in env: WHITELIST += [ sensor hal é‡Œé¢ä¹Ÿè¦æ·»åŠ  ç®—æ³•æ·»åŠ  ä¸»è¦æ˜¯åœ¨ adsp_proc/ssc/sensors/wrist_tilt_updown/src/sns_wrist_tilt_updown_sensor_instance_island.c é‡Œé¢ï¼Œ æ ¹æ®è·å–åˆ°çš„ Asensor å’Œ Gsensor æ•°æ®æ¥è®¡ç®—å¤„ç† ç®—æ³•éƒ¨åˆ† æ•°æ®ç»“æ„ å®šä¹‰äº†ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œç”¨æ¥ä¿å­˜ A sensor å’Œ G sensor çš„æ•°æ® /*=========================================================================== LinkedList Definitions ===========================================================================*/ /* init */ void LinkedList_init(LinkedList *list, int capacity) { list-\u003eelements = (SensorState *)malloc(sizeof(SensorState) * capacity); list-\u003efront = 0; list-\u003erear = -1; list-\u003ecapacity = capacity; list-\u003ecount = 0; } /* destory */ void LinkedList_destroy(LinkedList *list) { free(list-\u003eelements); } /* add item to the tail */ void LinkedList_enqueue(LinkedList *list, SensorState item,sns_sensor_instance *const this) { list-\u003erear = (list-\u003erear + 1) % list-\u003ecapacity; list-\u003eelements[list-\u003erear] = item; SNS_INST_PRINTF(ERROR, this, \"wentao LinkedList_enqueue item speed = %d /1000\", (int) (1000*item.mSpeed) ); if (list-\u003ecount \u003c list-\u003ecapacity) { list-\u003ecount++; } else { list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; } } /* remove oldest item */ SensorState LinkedList_dequeue(LinkedList *list) { SensorState item = list-\u003eelements[list-\u003efront]; list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; list-\u003ecount--; return item; } typedef struct { double mSpeed; float x; float y; float z; uint64_t timestamp; } SensorState; typedef struct { SensorState *elements; int front; int rear; int capacity; int count; } LinkedList; è¿åŠ¨æ£€æµ‹ é‡‡æ ·æ•°æ® a Sensor åŠ é€Ÿåº¦ g Sensor è§’é€Ÿåº¦ è¿åŠ¨æ£€æµ‹ä¸»è¦æ ¹æ®åŠ é€Ÿåº¦æ¥è®¡ç®—ã€‚ ç›®å‰çš„è¿åŠ¨æ£€æµ‹ç®—æ³• æ ¹æ®ç»éªŒå€¼æ¥åˆ¤æ–­ï¼Œåç»­å¦‚æœæœ‰ä¼˜åŒ–æœºä¼šï¼Œè¿˜æ˜¯è€ƒè™‘é‡‡ç”¨æ›´ç§‘å­¦çš„è®¡ç®—æ–¹æ³•ã€‚ //è¿™é‡Œé¢é‡‡æ ·é¢‘ç‡å¤§æ¦‚80msä¸€æ¬¡ï¼Œé‚£ä¹ˆä¸€ä¸ª10ä¸ªå•ä½çš„é‡‡æ ·æ•°ç»„ï¼Œå¤§æ¦‚èƒ½è®°å½•åˆ°0.8ç§’å‰çš„æ•°æ®ã€‚ float deltaX = x - lastX; float deltaY = y - lastY; float deltaZ = z - lastZ; //é€šè¿‡è®¡ç®—åŠ é€Ÿåº¦å·®å€¼çš„å¼€æ–¹é™¤ä»¥é—´éš”æ—¶é—´ï¼Œä½œä¸ºå°±æ£€æµ‹è¿åŠ¨å¼ºåº¦çš„åˆ¤æ–­ä¾æ® float sqrtV","date":"2024-11-06","objectID":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/:0:0","tags":["å®æˆ˜","ç®—æ³•ç ”ç©¶","blog","sensor"],"title":"adsp wristdown æµç¨‹ä¸å®ç°","uri":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/#adsp-éƒ¨åˆ†"},{"categories":["Android"],"collections":["WMS"],"content":"#Peppermill #ç®—æ³•ç ”ç©¶ ç›®å‰ è½è…•ç­å±ç®—æ³•å¤§è‡´åœ¨ framework å±‚å®ç°ã€‚ ç›®å‰ç®—æ³•çš„æ€è·¯ï¼š #è¿åŠ¨æ£€æµ‹ï¼Œé€šè¿‡ä¸€äº›ç‰¹å¾å€¼ï¼Œæ¥åˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªè¿åŠ¨æ®µè½ã€‚ ç¬¦åˆçš„è¿åŠ¨æ£€æµ‹åï¼Œæˆ‘ä»¬æ¥åˆ¤æ–­æ˜¯å¦æ˜¯è½è…•çš„åŠ¨ä½œã€‚ ç¬¦åˆçš„è½è…•çš„åŠ¨ä½œåï¼Œsensor ä¸ŠæŠ¥ eventã€‚ framework ç›‘å¬è·å–åè¿›è¡Œç­å±çš„åˆ¤æ–­åŠ¨ä½œã€‚ èƒŒæ™¯ä»‹ç» æ—©èµ·çš„ Android å¹³å°ï¼ŒSensor æ˜¯æ”¾åœ¨ AP ä¾§å®ç°çš„ï¼ŒSensor ç”Ÿæˆè®¾å¤‡èŠ‚ç‚¹ä¾›ä¸Šå±‚ä½¿ç”¨ï¼ŒSensor çš„å·¥ä½œ CPU å°±ä¸èƒ½å®Œå¥½çš„ä¼‘çœ ã€‚ åç»­çš„é«˜ç‰ˆæœ¬ android å„ä¸ªå¹³å°å‚å•†éƒ½æœ‰äº†ä¸åŒçš„æ–¹æ¡ˆï¼ŒSensorHubï¼ŒADSP SensorHub ä¸ªäººç†è§£å•Šï¼ŒSensorHub åº”è¯¥ç®—ä¸€ä¸ªç‹¬ç«‹çš„å­ç³»ç»Ÿï¼ŒMCUï¼Œå¯ä»¥ä¸ä¾èµ– CPU æ¶æ„ç‹¬ç«‹è¿è¡Œï¼Œå¯ä»¥è¾ƒå¤§çš„ç¨‹åº¦çœç”µã€‚ä¸»è¦åŠŸèƒ½å°±æ˜¯è¿æ¥å„ç±» sensor å¹¶ä¸”å»å¤„ç†ï¼ŒMTK é‡‡ç”¨çš„è¯¥æ–¹æ¡ˆï¼Œä½¿ç”¨çš„æ˜¯ SRAM æ¶æ„ï¼Œé€šç”µå°±å¯ä»¥ä¿å­˜æ•°æ®ï¼Œç›¸å¯¹å†…å­˜éœ€è¦ä¸åœçš„åˆ·æ–°ï¼Œé•¿æœŸè¿è¡Œå¯ä»¥èŠ‚çœç”¨ç”µã€‚ ADSP ADSP éƒ¨åˆ† ä¹‹å‰æŠŠè½è…•çš„æ£€æµ‹æ”¾åœ¨ framework é‡Œé¢å®ç°ï¼Œåœ¨äº®å±ä¹‹åï¼Œç›‘å¬ Asensor å’Œ GSensorï¼Œåšä¸ºè½è…•å…¶å®åªåœ¨äº®å±åä½¿ç”¨ï¼Œæ•´ä½“ä¸Šæ¥è¯´ï¼Œæ˜¯ä¸å½±å“è€—æµã€‚ å°†ç®—æ³•ä¸‹æ²‰åˆ° ADSPï¼Œä¸»è¦è€ƒè™‘åç»­æ–¹æ¡ˆçš„é€‚é…æ€§ï¼Œé’ˆå¯¹ä¸€äº›ä½è€—æµçš„éœ€æ±‚ï¼Œå¯ä»¥èƒ½å¤Ÿè¾ƒå¥½çš„æ»¡è¶³ã€‚ ç¼–è¯‘ è®°å½•æˆ‘ç›®å‰ç¼–è¯‘çš„ä¸€ä¸ªé—®é¢˜ï¼Œå®Œæ•´çš„ AMSS ç¼–è¯‘ OKï¼Œä½†æ˜¯å•ç‹¬ç¼–è¯‘ ADSP çš„æ—¶å€™å°±ä¼šæŠ¥é”™ RuntimeError: Cannot proceed with encryption/decryption: openssl v1.0.1 is unavailable. åº”è¯¥æ˜¯ç¼–è¯‘å‡º adsp çš„ mbn åï¼Œç­¾åæ‰¾ä¸åˆ° openssl å¯¼è‡´çš„ï¼Œå…¨ç¼–è¯‘å’Œå•ç¼–è¯‘çš„ç¯å¢ƒå˜é‡å¯èƒ½æœ‰ä¸ªç¯èŠ‚æœ‰é—®é¢˜ã€‚åæ¥æ·»åŠ äº†ç¼–è¯‘çš„ç¯å¢ƒå˜é‡æ‰èƒ½å¤Ÿæ­£å¸¸çš„ç¼–è¯‘ export PATH=/pkg/qct/software/python/2.7/bin:$PATH è™šæ‹Ÿåˆæˆ Sensor æ·»åŠ  è¿™éƒ¨åˆ†æ˜¯é©±åŠ¨åŒäº‹åšçš„ï¼Œç›®å‰æˆ‘åªæ˜¯è®°å½•ä¸‹æ¥ï¼Œå…·ä½“ä»£ç æˆ‘ä¹ŸåŒæ­¥åœ¨äº† Media\u0026File -\u003e WristDown è·¯å¾„ä¸‹é¢ ä¸»è¦ä¸€ä¸ªæ˜¯åœ¨ adsp_proc/ssc/build/ssc.scons å’Œ adsp_proc/ssc_api/build/ssc_api.scons ä¸‹æ·»åŠ  sensor diff --git a/adsp_proc/ssc/build/ssc.scons b/adsp_proc/ssc/build/ssc.scons index 8b6ab05..28f98a9 100755 (executable) --- a/adsp_proc/ssc/build/ssc.scons +++ b/adsp_proc/ssc/build/ssc.scons @@ -129,7 +129,7 @@ if env.IsKeyEnable(ssc_build_tags) is True: #------------------------------------------------------------------------------- - 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc', + 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc','sns_wrist_tilt_updown', 'pah_813x_algo','pah_hr','sns_pah_hrd_algo_lib'] #------------------------------------------------------------------------------- diff --git a/adsp_proc/ssc_api/build/ssc_api.scons b/adsp_proc/ssc_api/build/ssc_api.scons index b5ca9ee..d67bc30 100755 (executable) --- a/adsp_proc/ssc_api/build/ssc_api.scons +++ b/adsp_proc/ssc_api/build/ssc_api.scons @@ -127,7 +127,8 @@ WHITELIST = [ 'sns_heart_rate.proto', 'sns_offbody_detect.proto', 'sns_ppg.proto', - 'sns_philips_vso.proto'] + 'sns_philips_vso.proto', + 'sns_wrist_tilt_updown.proto'] if 'SENSORS_ALGO_DEV_FLAG' in env: WHITELIST += [ sensor hal é‡Œé¢ä¹Ÿè¦æ·»åŠ  ç®—æ³•æ·»åŠ  ä¸»è¦æ˜¯åœ¨ adsp_proc/ssc/sensors/wrist_tilt_updown/src/sns_wrist_tilt_updown_sensor_instance_island.c é‡Œé¢ï¼Œ æ ¹æ®è·å–åˆ°çš„ Asensor å’Œ Gsensor æ•°æ®æ¥è®¡ç®—å¤„ç† ç®—æ³•éƒ¨åˆ† æ•°æ®ç»“æ„ å®šä¹‰äº†ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œç”¨æ¥ä¿å­˜ A sensor å’Œ G sensor çš„æ•°æ® /*=========================================================================== LinkedList Definitions ===========================================================================*/ /* init */ void LinkedList_init(LinkedList *list, int capacity) { list-\u003eelements = (SensorState *)malloc(sizeof(SensorState) * capacity); list-\u003efront = 0; list-\u003erear = -1; list-\u003ecapacity = capacity; list-\u003ecount = 0; } /* destory */ void LinkedList_destroy(LinkedList *list) { free(list-\u003eelements); } /* add item to the tail */ void LinkedList_enqueue(LinkedList *list, SensorState item,sns_sensor_instance *const this) { list-\u003erear = (list-\u003erear + 1) % list-\u003ecapacity; list-\u003eelements[list-\u003erear] = item; SNS_INST_PRINTF(ERROR, this, \"wentao LinkedList_enqueue item speed = %d /1000\", (int) (1000*item.mSpeed) ); if (list-\u003ecount \u003c list-\u003ecapacity) { list-\u003ecount++; } else { list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; } } /* remove oldest item */ SensorState LinkedList_dequeue(LinkedList *list) { SensorState item = list-\u003eelements[list-\u003efront]; list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; list-\u003ecount--; return item; } typedef struct { double mSpeed; float x; float y; float z; uint64_t timestamp; } SensorState; typedef struct { SensorState *elements; int front; int rear; int capacity; int count; } LinkedList; è¿åŠ¨æ£€æµ‹ é‡‡æ ·æ•°æ® a Sensor åŠ é€Ÿåº¦ g Sensor è§’é€Ÿåº¦ è¿åŠ¨æ£€æµ‹ä¸»è¦æ ¹æ®åŠ é€Ÿåº¦æ¥è®¡ç®—ã€‚ ç›®å‰çš„è¿åŠ¨æ£€æµ‹ç®—æ³• æ ¹æ®ç»éªŒå€¼æ¥åˆ¤æ–­ï¼Œåç»­å¦‚æœæœ‰ä¼˜åŒ–æœºä¼šï¼Œè¿˜æ˜¯è€ƒè™‘é‡‡ç”¨æ›´ç§‘å­¦çš„è®¡ç®—æ–¹æ³•ã€‚ //è¿™é‡Œé¢é‡‡æ ·é¢‘ç‡å¤§æ¦‚80msä¸€æ¬¡ï¼Œé‚£ä¹ˆä¸€ä¸ª10ä¸ªå•ä½çš„é‡‡æ ·æ•°ç»„ï¼Œå¤§æ¦‚èƒ½è®°å½•åˆ°0.8ç§’å‰çš„æ•°æ®ã€‚ float deltaX = x - lastX; float deltaY = y - lastY; float deltaZ = z - lastZ; //é€šè¿‡è®¡ç®—åŠ é€Ÿåº¦å·®å€¼çš„å¼€æ–¹é™¤ä»¥é—´éš”æ—¶é—´ï¼Œä½œä¸ºå°±æ£€æµ‹è¿åŠ¨å¼ºåº¦çš„åˆ¤æ–­ä¾æ® float sqrtV","date":"2024-11-06","objectID":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/:0:0","tags":["å®æˆ˜","ç®—æ³•ç ”ç©¶","blog","sensor"],"title":"adsp wristdown æµç¨‹ä¸å®ç°","uri":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/#ç¼–è¯‘"},{"categories":["Android"],"collections":["WMS"],"content":"#Peppermill #ç®—æ³•ç ”ç©¶ ç›®å‰ è½è…•ç­å±ç®—æ³•å¤§è‡´åœ¨ framework å±‚å®ç°ã€‚ ç›®å‰ç®—æ³•çš„æ€è·¯ï¼š #è¿åŠ¨æ£€æµ‹ï¼Œé€šè¿‡ä¸€äº›ç‰¹å¾å€¼ï¼Œæ¥åˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªè¿åŠ¨æ®µè½ã€‚ ç¬¦åˆçš„è¿åŠ¨æ£€æµ‹åï¼Œæˆ‘ä»¬æ¥åˆ¤æ–­æ˜¯å¦æ˜¯è½è…•çš„åŠ¨ä½œã€‚ ç¬¦åˆçš„è½è…•çš„åŠ¨ä½œåï¼Œsensor ä¸ŠæŠ¥ eventã€‚ framework ç›‘å¬è·å–åè¿›è¡Œç­å±çš„åˆ¤æ–­åŠ¨ä½œã€‚ èƒŒæ™¯ä»‹ç» æ—©èµ·çš„ Android å¹³å°ï¼ŒSensor æ˜¯æ”¾åœ¨ AP ä¾§å®ç°çš„ï¼ŒSensor ç”Ÿæˆè®¾å¤‡èŠ‚ç‚¹ä¾›ä¸Šå±‚ä½¿ç”¨ï¼ŒSensor çš„å·¥ä½œ CPU å°±ä¸èƒ½å®Œå¥½çš„ä¼‘çœ ã€‚ åç»­çš„é«˜ç‰ˆæœ¬ android å„ä¸ªå¹³å°å‚å•†éƒ½æœ‰äº†ä¸åŒçš„æ–¹æ¡ˆï¼ŒSensorHubï¼ŒADSP SensorHub ä¸ªäººç†è§£å•Šï¼ŒSensorHub åº”è¯¥ç®—ä¸€ä¸ªç‹¬ç«‹çš„å­ç³»ç»Ÿï¼ŒMCUï¼Œå¯ä»¥ä¸ä¾èµ– CPU æ¶æ„ç‹¬ç«‹è¿è¡Œï¼Œå¯ä»¥è¾ƒå¤§çš„ç¨‹åº¦çœç”µã€‚ä¸»è¦åŠŸèƒ½å°±æ˜¯è¿æ¥å„ç±» sensor å¹¶ä¸”å»å¤„ç†ï¼ŒMTK é‡‡ç”¨çš„è¯¥æ–¹æ¡ˆï¼Œä½¿ç”¨çš„æ˜¯ SRAM æ¶æ„ï¼Œé€šç”µå°±å¯ä»¥ä¿å­˜æ•°æ®ï¼Œç›¸å¯¹å†…å­˜éœ€è¦ä¸åœçš„åˆ·æ–°ï¼Œé•¿æœŸè¿è¡Œå¯ä»¥èŠ‚çœç”¨ç”µã€‚ ADSP ADSP éƒ¨åˆ† ä¹‹å‰æŠŠè½è…•çš„æ£€æµ‹æ”¾åœ¨ framework é‡Œé¢å®ç°ï¼Œåœ¨äº®å±ä¹‹åï¼Œç›‘å¬ Asensor å’Œ GSensorï¼Œåšä¸ºè½è…•å…¶å®åªåœ¨äº®å±åä½¿ç”¨ï¼Œæ•´ä½“ä¸Šæ¥è¯´ï¼Œæ˜¯ä¸å½±å“è€—æµã€‚ å°†ç®—æ³•ä¸‹æ²‰åˆ° ADSPï¼Œä¸»è¦è€ƒè™‘åç»­æ–¹æ¡ˆçš„é€‚é…æ€§ï¼Œé’ˆå¯¹ä¸€äº›ä½è€—æµçš„éœ€æ±‚ï¼Œå¯ä»¥èƒ½å¤Ÿè¾ƒå¥½çš„æ»¡è¶³ã€‚ ç¼–è¯‘ è®°å½•æˆ‘ç›®å‰ç¼–è¯‘çš„ä¸€ä¸ªé—®é¢˜ï¼Œå®Œæ•´çš„ AMSS ç¼–è¯‘ OKï¼Œä½†æ˜¯å•ç‹¬ç¼–è¯‘ ADSP çš„æ—¶å€™å°±ä¼šæŠ¥é”™ RuntimeError: Cannot proceed with encryption/decryption: openssl v1.0.1 is unavailable. åº”è¯¥æ˜¯ç¼–è¯‘å‡º adsp çš„ mbn åï¼Œç­¾åæ‰¾ä¸åˆ° openssl å¯¼è‡´çš„ï¼Œå…¨ç¼–è¯‘å’Œå•ç¼–è¯‘çš„ç¯å¢ƒå˜é‡å¯èƒ½æœ‰ä¸ªç¯èŠ‚æœ‰é—®é¢˜ã€‚åæ¥æ·»åŠ äº†ç¼–è¯‘çš„ç¯å¢ƒå˜é‡æ‰èƒ½å¤Ÿæ­£å¸¸çš„ç¼–è¯‘ export PATH=/pkg/qct/software/python/2.7/bin:$PATH è™šæ‹Ÿåˆæˆ Sensor æ·»åŠ  è¿™éƒ¨åˆ†æ˜¯é©±åŠ¨åŒäº‹åšçš„ï¼Œç›®å‰æˆ‘åªæ˜¯è®°å½•ä¸‹æ¥ï¼Œå…·ä½“ä»£ç æˆ‘ä¹ŸåŒæ­¥åœ¨äº† Media\u0026File -\u003e WristDown è·¯å¾„ä¸‹é¢ ä¸»è¦ä¸€ä¸ªæ˜¯åœ¨ adsp_proc/ssc/build/ssc.scons å’Œ adsp_proc/ssc_api/build/ssc_api.scons ä¸‹æ·»åŠ  sensor diff --git a/adsp_proc/ssc/build/ssc.scons b/adsp_proc/ssc/build/ssc.scons index 8b6ab05..28f98a9 100755 (executable) --- a/adsp_proc/ssc/build/ssc.scons +++ b/adsp_proc/ssc/build/ssc.scons @@ -129,7 +129,7 @@ if env.IsKeyEnable(ssc_build_tags) is True: #------------------------------------------------------------------------------- - 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc', + 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc','sns_wrist_tilt_updown', 'pah_813x_algo','pah_hr','sns_pah_hrd_algo_lib'] #------------------------------------------------------------------------------- diff --git a/adsp_proc/ssc_api/build/ssc_api.scons b/adsp_proc/ssc_api/build/ssc_api.scons index b5ca9ee..d67bc30 100755 (executable) --- a/adsp_proc/ssc_api/build/ssc_api.scons +++ b/adsp_proc/ssc_api/build/ssc_api.scons @@ -127,7 +127,8 @@ WHITELIST = [ 'sns_heart_rate.proto', 'sns_offbody_detect.proto', 'sns_ppg.proto', - 'sns_philips_vso.proto'] + 'sns_philips_vso.proto', + 'sns_wrist_tilt_updown.proto'] if 'SENSORS_ALGO_DEV_FLAG' in env: WHITELIST += [ sensor hal é‡Œé¢ä¹Ÿè¦æ·»åŠ  ç®—æ³•æ·»åŠ  ä¸»è¦æ˜¯åœ¨ adsp_proc/ssc/sensors/wrist_tilt_updown/src/sns_wrist_tilt_updown_sensor_instance_island.c é‡Œé¢ï¼Œ æ ¹æ®è·å–åˆ°çš„ Asensor å’Œ Gsensor æ•°æ®æ¥è®¡ç®—å¤„ç† ç®—æ³•éƒ¨åˆ† æ•°æ®ç»“æ„ å®šä¹‰äº†ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œç”¨æ¥ä¿å­˜ A sensor å’Œ G sensor çš„æ•°æ® /*=========================================================================== LinkedList Definitions ===========================================================================*/ /* init */ void LinkedList_init(LinkedList *list, int capacity) { list-\u003eelements = (SensorState *)malloc(sizeof(SensorState) * capacity); list-\u003efront = 0; list-\u003erear = -1; list-\u003ecapacity = capacity; list-\u003ecount = 0; } /* destory */ void LinkedList_destroy(LinkedList *list) { free(list-\u003eelements); } /* add item to the tail */ void LinkedList_enqueue(LinkedList *list, SensorState item,sns_sensor_instance *const this) { list-\u003erear = (list-\u003erear + 1) % list-\u003ecapacity; list-\u003eelements[list-\u003erear] = item; SNS_INST_PRINTF(ERROR, this, \"wentao LinkedList_enqueue item speed = %d /1000\", (int) (1000*item.mSpeed) ); if (list-\u003ecount \u003c list-\u003ecapacity) { list-\u003ecount++; } else { list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; } } /* remove oldest item */ SensorState LinkedList_dequeue(LinkedList *list) { SensorState item = list-\u003eelements[list-\u003efront]; list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; list-\u003ecount--; return item; } typedef struct { double mSpeed; float x; float y; float z; uint64_t timestamp; } SensorState; typedef struct { SensorState *elements; int front; int rear; int capacity; int count; } LinkedList; è¿åŠ¨æ£€æµ‹ é‡‡æ ·æ•°æ® a Sensor åŠ é€Ÿåº¦ g Sensor è§’é€Ÿåº¦ è¿åŠ¨æ£€æµ‹ä¸»è¦æ ¹æ®åŠ é€Ÿåº¦æ¥è®¡ç®—ã€‚ ç›®å‰çš„è¿åŠ¨æ£€æµ‹ç®—æ³• æ ¹æ®ç»éªŒå€¼æ¥åˆ¤æ–­ï¼Œåç»­å¦‚æœæœ‰ä¼˜åŒ–æœºä¼šï¼Œè¿˜æ˜¯è€ƒè™‘é‡‡ç”¨æ›´ç§‘å­¦çš„è®¡ç®—æ–¹æ³•ã€‚ //è¿™é‡Œé¢é‡‡æ ·é¢‘ç‡å¤§æ¦‚80msä¸€æ¬¡ï¼Œé‚£ä¹ˆä¸€ä¸ª10ä¸ªå•ä½çš„é‡‡æ ·æ•°ç»„ï¼Œå¤§æ¦‚èƒ½è®°å½•åˆ°0.8ç§’å‰çš„æ•°æ®ã€‚ float deltaX = x - lastX; float deltaY = y - lastY; float deltaZ = z - lastZ; //é€šè¿‡è®¡ç®—åŠ é€Ÿåº¦å·®å€¼çš„å¼€æ–¹é™¤ä»¥é—´éš”æ—¶é—´ï¼Œä½œä¸ºå°±æ£€æµ‹è¿åŠ¨å¼ºåº¦çš„åˆ¤æ–­ä¾æ® float sqrtV","date":"2024-11-06","objectID":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/:0:0","tags":["å®æˆ˜","ç®—æ³•ç ”ç©¶","blog","sensor"],"title":"adsp wristdown æµç¨‹ä¸å®ç°","uri":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/#è™šæ‹Ÿåˆæˆ-sensor-æ·»åŠ "},{"categories":["Android"],"collections":["WMS"],"content":"#Peppermill #ç®—æ³•ç ”ç©¶ ç›®å‰ è½è…•ç­å±ç®—æ³•å¤§è‡´åœ¨ framework å±‚å®ç°ã€‚ ç›®å‰ç®—æ³•çš„æ€è·¯ï¼š #è¿åŠ¨æ£€æµ‹ï¼Œé€šè¿‡ä¸€äº›ç‰¹å¾å€¼ï¼Œæ¥åˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªè¿åŠ¨æ®µè½ã€‚ ç¬¦åˆçš„è¿åŠ¨æ£€æµ‹åï¼Œæˆ‘ä»¬æ¥åˆ¤æ–­æ˜¯å¦æ˜¯è½è…•çš„åŠ¨ä½œã€‚ ç¬¦åˆçš„è½è…•çš„åŠ¨ä½œåï¼Œsensor ä¸ŠæŠ¥ eventã€‚ framework ç›‘å¬è·å–åè¿›è¡Œç­å±çš„åˆ¤æ–­åŠ¨ä½œã€‚ èƒŒæ™¯ä»‹ç» æ—©èµ·çš„ Android å¹³å°ï¼ŒSensor æ˜¯æ”¾åœ¨ AP ä¾§å®ç°çš„ï¼ŒSensor ç”Ÿæˆè®¾å¤‡èŠ‚ç‚¹ä¾›ä¸Šå±‚ä½¿ç”¨ï¼ŒSensor çš„å·¥ä½œ CPU å°±ä¸èƒ½å®Œå¥½çš„ä¼‘çœ ã€‚ åç»­çš„é«˜ç‰ˆæœ¬ android å„ä¸ªå¹³å°å‚å•†éƒ½æœ‰äº†ä¸åŒçš„æ–¹æ¡ˆï¼ŒSensorHubï¼ŒADSP SensorHub ä¸ªäººç†è§£å•Šï¼ŒSensorHub åº”è¯¥ç®—ä¸€ä¸ªç‹¬ç«‹çš„å­ç³»ç»Ÿï¼ŒMCUï¼Œå¯ä»¥ä¸ä¾èµ– CPU æ¶æ„ç‹¬ç«‹è¿è¡Œï¼Œå¯ä»¥è¾ƒå¤§çš„ç¨‹åº¦çœç”µã€‚ä¸»è¦åŠŸèƒ½å°±æ˜¯è¿æ¥å„ç±» sensor å¹¶ä¸”å»å¤„ç†ï¼ŒMTK é‡‡ç”¨çš„è¯¥æ–¹æ¡ˆï¼Œä½¿ç”¨çš„æ˜¯ SRAM æ¶æ„ï¼Œé€šç”µå°±å¯ä»¥ä¿å­˜æ•°æ®ï¼Œç›¸å¯¹å†…å­˜éœ€è¦ä¸åœçš„åˆ·æ–°ï¼Œé•¿æœŸè¿è¡Œå¯ä»¥èŠ‚çœç”¨ç”µã€‚ ADSP ADSP éƒ¨åˆ† ä¹‹å‰æŠŠè½è…•çš„æ£€æµ‹æ”¾åœ¨ framework é‡Œé¢å®ç°ï¼Œåœ¨äº®å±ä¹‹åï¼Œç›‘å¬ Asensor å’Œ GSensorï¼Œåšä¸ºè½è…•å…¶å®åªåœ¨äº®å±åä½¿ç”¨ï¼Œæ•´ä½“ä¸Šæ¥è¯´ï¼Œæ˜¯ä¸å½±å“è€—æµã€‚ å°†ç®—æ³•ä¸‹æ²‰åˆ° ADSPï¼Œä¸»è¦è€ƒè™‘åç»­æ–¹æ¡ˆçš„é€‚é…æ€§ï¼Œé’ˆå¯¹ä¸€äº›ä½è€—æµçš„éœ€æ±‚ï¼Œå¯ä»¥èƒ½å¤Ÿè¾ƒå¥½çš„æ»¡è¶³ã€‚ ç¼–è¯‘ è®°å½•æˆ‘ç›®å‰ç¼–è¯‘çš„ä¸€ä¸ªé—®é¢˜ï¼Œå®Œæ•´çš„ AMSS ç¼–è¯‘ OKï¼Œä½†æ˜¯å•ç‹¬ç¼–è¯‘ ADSP çš„æ—¶å€™å°±ä¼šæŠ¥é”™ RuntimeError: Cannot proceed with encryption/decryption: openssl v1.0.1 is unavailable. åº”è¯¥æ˜¯ç¼–è¯‘å‡º adsp çš„ mbn åï¼Œç­¾åæ‰¾ä¸åˆ° openssl å¯¼è‡´çš„ï¼Œå…¨ç¼–è¯‘å’Œå•ç¼–è¯‘çš„ç¯å¢ƒå˜é‡å¯èƒ½æœ‰ä¸ªç¯èŠ‚æœ‰é—®é¢˜ã€‚åæ¥æ·»åŠ äº†ç¼–è¯‘çš„ç¯å¢ƒå˜é‡æ‰èƒ½å¤Ÿæ­£å¸¸çš„ç¼–è¯‘ export PATH=/pkg/qct/software/python/2.7/bin:$PATH è™šæ‹Ÿåˆæˆ Sensor æ·»åŠ  è¿™éƒ¨åˆ†æ˜¯é©±åŠ¨åŒäº‹åšçš„ï¼Œç›®å‰æˆ‘åªæ˜¯è®°å½•ä¸‹æ¥ï¼Œå…·ä½“ä»£ç æˆ‘ä¹ŸåŒæ­¥åœ¨äº† Media\u0026File -\u003e WristDown è·¯å¾„ä¸‹é¢ ä¸»è¦ä¸€ä¸ªæ˜¯åœ¨ adsp_proc/ssc/build/ssc.scons å’Œ adsp_proc/ssc_api/build/ssc_api.scons ä¸‹æ·»åŠ  sensor diff --git a/adsp_proc/ssc/build/ssc.scons b/adsp_proc/ssc/build/ssc.scons index 8b6ab05..28f98a9 100755 (executable) --- a/adsp_proc/ssc/build/ssc.scons +++ b/adsp_proc/ssc/build/ssc.scons @@ -129,7 +129,7 @@ if env.IsKeyEnable(ssc_build_tags) is True: #------------------------------------------------------------------------------- - 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc', + 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc','sns_wrist_tilt_updown', 'pah_813x_algo','pah_hr','sns_pah_hrd_algo_lib'] #------------------------------------------------------------------------------- diff --git a/adsp_proc/ssc_api/build/ssc_api.scons b/adsp_proc/ssc_api/build/ssc_api.scons index b5ca9ee..d67bc30 100755 (executable) --- a/adsp_proc/ssc_api/build/ssc_api.scons +++ b/adsp_proc/ssc_api/build/ssc_api.scons @@ -127,7 +127,8 @@ WHITELIST = [ 'sns_heart_rate.proto', 'sns_offbody_detect.proto', 'sns_ppg.proto', - 'sns_philips_vso.proto'] + 'sns_philips_vso.proto', + 'sns_wrist_tilt_updown.proto'] if 'SENSORS_ALGO_DEV_FLAG' in env: WHITELIST += [ sensor hal é‡Œé¢ä¹Ÿè¦æ·»åŠ  ç®—æ³•æ·»åŠ  ä¸»è¦æ˜¯åœ¨ adsp_proc/ssc/sensors/wrist_tilt_updown/src/sns_wrist_tilt_updown_sensor_instance_island.c é‡Œé¢ï¼Œ æ ¹æ®è·å–åˆ°çš„ Asensor å’Œ Gsensor æ•°æ®æ¥è®¡ç®—å¤„ç† ç®—æ³•éƒ¨åˆ† æ•°æ®ç»“æ„ å®šä¹‰äº†ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œç”¨æ¥ä¿å­˜ A sensor å’Œ G sensor çš„æ•°æ® /*=========================================================================== LinkedList Definitions ===========================================================================*/ /* init */ void LinkedList_init(LinkedList *list, int capacity) { list-\u003eelements = (SensorState *)malloc(sizeof(SensorState) * capacity); list-\u003efront = 0; list-\u003erear = -1; list-\u003ecapacity = capacity; list-\u003ecount = 0; } /* destory */ void LinkedList_destroy(LinkedList *list) { free(list-\u003eelements); } /* add item to the tail */ void LinkedList_enqueue(LinkedList *list, SensorState item,sns_sensor_instance *const this) { list-\u003erear = (list-\u003erear + 1) % list-\u003ecapacity; list-\u003eelements[list-\u003erear] = item; SNS_INST_PRINTF(ERROR, this, \"wentao LinkedList_enqueue item speed = %d /1000\", (int) (1000*item.mSpeed) ); if (list-\u003ecount \u003c list-\u003ecapacity) { list-\u003ecount++; } else { list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; } } /* remove oldest item */ SensorState LinkedList_dequeue(LinkedList *list) { SensorState item = list-\u003eelements[list-\u003efront]; list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; list-\u003ecount--; return item; } typedef struct { double mSpeed; float x; float y; float z; uint64_t timestamp; } SensorState; typedef struct { SensorState *elements; int front; int rear; int capacity; int count; } LinkedList; è¿åŠ¨æ£€æµ‹ é‡‡æ ·æ•°æ® a Sensor åŠ é€Ÿåº¦ g Sensor è§’é€Ÿåº¦ è¿åŠ¨æ£€æµ‹ä¸»è¦æ ¹æ®åŠ é€Ÿåº¦æ¥è®¡ç®—ã€‚ ç›®å‰çš„è¿åŠ¨æ£€æµ‹ç®—æ³• æ ¹æ®ç»éªŒå€¼æ¥åˆ¤æ–­ï¼Œåç»­å¦‚æœæœ‰ä¼˜åŒ–æœºä¼šï¼Œè¿˜æ˜¯è€ƒè™‘é‡‡ç”¨æ›´ç§‘å­¦çš„è®¡ç®—æ–¹æ³•ã€‚ //è¿™é‡Œé¢é‡‡æ ·é¢‘ç‡å¤§æ¦‚80msä¸€æ¬¡ï¼Œé‚£ä¹ˆä¸€ä¸ª10ä¸ªå•ä½çš„é‡‡æ ·æ•°ç»„ï¼Œå¤§æ¦‚èƒ½è®°å½•åˆ°0.8ç§’å‰çš„æ•°æ®ã€‚ float deltaX = x - lastX; float deltaY = y - lastY; float deltaZ = z - lastZ; //é€šè¿‡è®¡ç®—åŠ é€Ÿåº¦å·®å€¼çš„å¼€æ–¹é™¤ä»¥é—´éš”æ—¶é—´ï¼Œä½œä¸ºå°±æ£€æµ‹è¿åŠ¨å¼ºåº¦çš„åˆ¤æ–­ä¾æ® float sqrtV","date":"2024-11-06","objectID":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/:0:0","tags":["å®æˆ˜","ç®—æ³•ç ”ç©¶","blog","sensor"],"title":"adsp wristdown æµç¨‹ä¸å®ç°","uri":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/#ç®—æ³•æ·»åŠ "},{"categories":["Android"],"collections":["WMS"],"content":"#Peppermill #ç®—æ³•ç ”ç©¶ ç›®å‰ è½è…•ç­å±ç®—æ³•å¤§è‡´åœ¨ framework å±‚å®ç°ã€‚ ç›®å‰ç®—æ³•çš„æ€è·¯ï¼š #è¿åŠ¨æ£€æµ‹ï¼Œé€šè¿‡ä¸€äº›ç‰¹å¾å€¼ï¼Œæ¥åˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªè¿åŠ¨æ®µè½ã€‚ ç¬¦åˆçš„è¿åŠ¨æ£€æµ‹åï¼Œæˆ‘ä»¬æ¥åˆ¤æ–­æ˜¯å¦æ˜¯è½è…•çš„åŠ¨ä½œã€‚ ç¬¦åˆçš„è½è…•çš„åŠ¨ä½œåï¼Œsensor ä¸ŠæŠ¥ eventã€‚ framework ç›‘å¬è·å–åè¿›è¡Œç­å±çš„åˆ¤æ–­åŠ¨ä½œã€‚ èƒŒæ™¯ä»‹ç» æ—©èµ·çš„ Android å¹³å°ï¼ŒSensor æ˜¯æ”¾åœ¨ AP ä¾§å®ç°çš„ï¼ŒSensor ç”Ÿæˆè®¾å¤‡èŠ‚ç‚¹ä¾›ä¸Šå±‚ä½¿ç”¨ï¼ŒSensor çš„å·¥ä½œ CPU å°±ä¸èƒ½å®Œå¥½çš„ä¼‘çœ ã€‚ åç»­çš„é«˜ç‰ˆæœ¬ android å„ä¸ªå¹³å°å‚å•†éƒ½æœ‰äº†ä¸åŒçš„æ–¹æ¡ˆï¼ŒSensorHubï¼ŒADSP SensorHub ä¸ªäººç†è§£å•Šï¼ŒSensorHub åº”è¯¥ç®—ä¸€ä¸ªç‹¬ç«‹çš„å­ç³»ç»Ÿï¼ŒMCUï¼Œå¯ä»¥ä¸ä¾èµ– CPU æ¶æ„ç‹¬ç«‹è¿è¡Œï¼Œå¯ä»¥è¾ƒå¤§çš„ç¨‹åº¦çœç”µã€‚ä¸»è¦åŠŸèƒ½å°±æ˜¯è¿æ¥å„ç±» sensor å¹¶ä¸”å»å¤„ç†ï¼ŒMTK é‡‡ç”¨çš„è¯¥æ–¹æ¡ˆï¼Œä½¿ç”¨çš„æ˜¯ SRAM æ¶æ„ï¼Œé€šç”µå°±å¯ä»¥ä¿å­˜æ•°æ®ï¼Œç›¸å¯¹å†…å­˜éœ€è¦ä¸åœçš„åˆ·æ–°ï¼Œé•¿æœŸè¿è¡Œå¯ä»¥èŠ‚çœç”¨ç”µã€‚ ADSP ADSP éƒ¨åˆ† ä¹‹å‰æŠŠè½è…•çš„æ£€æµ‹æ”¾åœ¨ framework é‡Œé¢å®ç°ï¼Œåœ¨äº®å±ä¹‹åï¼Œç›‘å¬ Asensor å’Œ GSensorï¼Œåšä¸ºè½è…•å…¶å®åªåœ¨äº®å±åä½¿ç”¨ï¼Œæ•´ä½“ä¸Šæ¥è¯´ï¼Œæ˜¯ä¸å½±å“è€—æµã€‚ å°†ç®—æ³•ä¸‹æ²‰åˆ° ADSPï¼Œä¸»è¦è€ƒè™‘åç»­æ–¹æ¡ˆçš„é€‚é…æ€§ï¼Œé’ˆå¯¹ä¸€äº›ä½è€—æµçš„éœ€æ±‚ï¼Œå¯ä»¥èƒ½å¤Ÿè¾ƒå¥½çš„æ»¡è¶³ã€‚ ç¼–è¯‘ è®°å½•æˆ‘ç›®å‰ç¼–è¯‘çš„ä¸€ä¸ªé—®é¢˜ï¼Œå®Œæ•´çš„ AMSS ç¼–è¯‘ OKï¼Œä½†æ˜¯å•ç‹¬ç¼–è¯‘ ADSP çš„æ—¶å€™å°±ä¼šæŠ¥é”™ RuntimeError: Cannot proceed with encryption/decryption: openssl v1.0.1 is unavailable. åº”è¯¥æ˜¯ç¼–è¯‘å‡º adsp çš„ mbn åï¼Œç­¾åæ‰¾ä¸åˆ° openssl å¯¼è‡´çš„ï¼Œå…¨ç¼–è¯‘å’Œå•ç¼–è¯‘çš„ç¯å¢ƒå˜é‡å¯èƒ½æœ‰ä¸ªç¯èŠ‚æœ‰é—®é¢˜ã€‚åæ¥æ·»åŠ äº†ç¼–è¯‘çš„ç¯å¢ƒå˜é‡æ‰èƒ½å¤Ÿæ­£å¸¸çš„ç¼–è¯‘ export PATH=/pkg/qct/software/python/2.7/bin:$PATH è™šæ‹Ÿåˆæˆ Sensor æ·»åŠ  è¿™éƒ¨åˆ†æ˜¯é©±åŠ¨åŒäº‹åšçš„ï¼Œç›®å‰æˆ‘åªæ˜¯è®°å½•ä¸‹æ¥ï¼Œå…·ä½“ä»£ç æˆ‘ä¹ŸåŒæ­¥åœ¨äº† Media\u0026File -\u003e WristDown è·¯å¾„ä¸‹é¢ ä¸»è¦ä¸€ä¸ªæ˜¯åœ¨ adsp_proc/ssc/build/ssc.scons å’Œ adsp_proc/ssc_api/build/ssc_api.scons ä¸‹æ·»åŠ  sensor diff --git a/adsp_proc/ssc/build/ssc.scons b/adsp_proc/ssc/build/ssc.scons index 8b6ab05..28f98a9 100755 (executable) --- a/adsp_proc/ssc/build/ssc.scons +++ b/adsp_proc/ssc/build/ssc.scons @@ -129,7 +129,7 @@ if env.IsKeyEnable(ssc_build_tags) is True: #------------------------------------------------------------------------------- - 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc', + 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc','sns_wrist_tilt_updown', 'pah_813x_algo','pah_hr','sns_pah_hrd_algo_lib'] #------------------------------------------------------------------------------- diff --git a/adsp_proc/ssc_api/build/ssc_api.scons b/adsp_proc/ssc_api/build/ssc_api.scons index b5ca9ee..d67bc30 100755 (executable) --- a/adsp_proc/ssc_api/build/ssc_api.scons +++ b/adsp_proc/ssc_api/build/ssc_api.scons @@ -127,7 +127,8 @@ WHITELIST = [ 'sns_heart_rate.proto', 'sns_offbody_detect.proto', 'sns_ppg.proto', - 'sns_philips_vso.proto'] + 'sns_philips_vso.proto', + 'sns_wrist_tilt_updown.proto'] if 'SENSORS_ALGO_DEV_FLAG' in env: WHITELIST += [ sensor hal é‡Œé¢ä¹Ÿè¦æ·»åŠ  ç®—æ³•æ·»åŠ  ä¸»è¦æ˜¯åœ¨ adsp_proc/ssc/sensors/wrist_tilt_updown/src/sns_wrist_tilt_updown_sensor_instance_island.c é‡Œé¢ï¼Œ æ ¹æ®è·å–åˆ°çš„ Asensor å’Œ Gsensor æ•°æ®æ¥è®¡ç®—å¤„ç† ç®—æ³•éƒ¨åˆ† æ•°æ®ç»“æ„ å®šä¹‰äº†ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œç”¨æ¥ä¿å­˜ A sensor å’Œ G sensor çš„æ•°æ® /*=========================================================================== LinkedList Definitions ===========================================================================*/ /* init */ void LinkedList_init(LinkedList *list, int capacity) { list-\u003eelements = (SensorState *)malloc(sizeof(SensorState) * capacity); list-\u003efront = 0; list-\u003erear = -1; list-\u003ecapacity = capacity; list-\u003ecount = 0; } /* destory */ void LinkedList_destroy(LinkedList *list) { free(list-\u003eelements); } /* add item to the tail */ void LinkedList_enqueue(LinkedList *list, SensorState item,sns_sensor_instance *const this) { list-\u003erear = (list-\u003erear + 1) % list-\u003ecapacity; list-\u003eelements[list-\u003erear] = item; SNS_INST_PRINTF(ERROR, this, \"wentao LinkedList_enqueue item speed = %d /1000\", (int) (1000*item.mSpeed) ); if (list-\u003ecount \u003c list-\u003ecapacity) { list-\u003ecount++; } else { list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; } } /* remove oldest item */ SensorState LinkedList_dequeue(LinkedList *list) { SensorState item = list-\u003eelements[list-\u003efront]; list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; list-\u003ecount--; return item; } typedef struct { double mSpeed; float x; float y; float z; uint64_t timestamp; } SensorState; typedef struct { SensorState *elements; int front; int rear; int capacity; int count; } LinkedList; è¿åŠ¨æ£€æµ‹ é‡‡æ ·æ•°æ® a Sensor åŠ é€Ÿåº¦ g Sensor è§’é€Ÿåº¦ è¿åŠ¨æ£€æµ‹ä¸»è¦æ ¹æ®åŠ é€Ÿåº¦æ¥è®¡ç®—ã€‚ ç›®å‰çš„è¿åŠ¨æ£€æµ‹ç®—æ³• æ ¹æ®ç»éªŒå€¼æ¥åˆ¤æ–­ï¼Œåç»­å¦‚æœæœ‰ä¼˜åŒ–æœºä¼šï¼Œè¿˜æ˜¯è€ƒè™‘é‡‡ç”¨æ›´ç§‘å­¦çš„è®¡ç®—æ–¹æ³•ã€‚ //è¿™é‡Œé¢é‡‡æ ·é¢‘ç‡å¤§æ¦‚80msä¸€æ¬¡ï¼Œé‚£ä¹ˆä¸€ä¸ª10ä¸ªå•ä½çš„é‡‡æ ·æ•°ç»„ï¼Œå¤§æ¦‚èƒ½è®°å½•åˆ°0.8ç§’å‰çš„æ•°æ®ã€‚ float deltaX = x - lastX; float deltaY = y - lastY; float deltaZ = z - lastZ; //é€šè¿‡è®¡ç®—åŠ é€Ÿåº¦å·®å€¼çš„å¼€æ–¹é™¤ä»¥é—´éš”æ—¶é—´ï¼Œä½œä¸ºå°±æ£€æµ‹è¿åŠ¨å¼ºåº¦çš„åˆ¤æ–­ä¾æ® float sqrtV","date":"2024-11-06","objectID":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/:0:0","tags":["å®æˆ˜","ç®—æ³•ç ”ç©¶","blog","sensor"],"title":"adsp wristdown æµç¨‹ä¸å®ç°","uri":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/#ç®—æ³•éƒ¨åˆ†"},{"categories":["Android"],"collections":["WMS"],"content":"#Peppermill #ç®—æ³•ç ”ç©¶ ç›®å‰ è½è…•ç­å±ç®—æ³•å¤§è‡´åœ¨ framework å±‚å®ç°ã€‚ ç›®å‰ç®—æ³•çš„æ€è·¯ï¼š #è¿åŠ¨æ£€æµ‹ï¼Œé€šè¿‡ä¸€äº›ç‰¹å¾å€¼ï¼Œæ¥åˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªè¿åŠ¨æ®µè½ã€‚ ç¬¦åˆçš„è¿åŠ¨æ£€æµ‹åï¼Œæˆ‘ä»¬æ¥åˆ¤æ–­æ˜¯å¦æ˜¯è½è…•çš„åŠ¨ä½œã€‚ ç¬¦åˆçš„è½è…•çš„åŠ¨ä½œåï¼Œsensor ä¸ŠæŠ¥ eventã€‚ framework ç›‘å¬è·å–åè¿›è¡Œç­å±çš„åˆ¤æ–­åŠ¨ä½œã€‚ èƒŒæ™¯ä»‹ç» æ—©èµ·çš„ Android å¹³å°ï¼ŒSensor æ˜¯æ”¾åœ¨ AP ä¾§å®ç°çš„ï¼ŒSensor ç”Ÿæˆè®¾å¤‡èŠ‚ç‚¹ä¾›ä¸Šå±‚ä½¿ç”¨ï¼ŒSensor çš„å·¥ä½œ CPU å°±ä¸èƒ½å®Œå¥½çš„ä¼‘çœ ã€‚ åç»­çš„é«˜ç‰ˆæœ¬ android å„ä¸ªå¹³å°å‚å•†éƒ½æœ‰äº†ä¸åŒçš„æ–¹æ¡ˆï¼ŒSensorHubï¼ŒADSP SensorHub ä¸ªäººç†è§£å•Šï¼ŒSensorHub åº”è¯¥ç®—ä¸€ä¸ªç‹¬ç«‹çš„å­ç³»ç»Ÿï¼ŒMCUï¼Œå¯ä»¥ä¸ä¾èµ– CPU æ¶æ„ç‹¬ç«‹è¿è¡Œï¼Œå¯ä»¥è¾ƒå¤§çš„ç¨‹åº¦çœç”µã€‚ä¸»è¦åŠŸèƒ½å°±æ˜¯è¿æ¥å„ç±» sensor å¹¶ä¸”å»å¤„ç†ï¼ŒMTK é‡‡ç”¨çš„è¯¥æ–¹æ¡ˆï¼Œä½¿ç”¨çš„æ˜¯ SRAM æ¶æ„ï¼Œé€šç”µå°±å¯ä»¥ä¿å­˜æ•°æ®ï¼Œç›¸å¯¹å†…å­˜éœ€è¦ä¸åœçš„åˆ·æ–°ï¼Œé•¿æœŸè¿è¡Œå¯ä»¥èŠ‚çœç”¨ç”µã€‚ ADSP ADSP éƒ¨åˆ† ä¹‹å‰æŠŠè½è…•çš„æ£€æµ‹æ”¾åœ¨ framework é‡Œé¢å®ç°ï¼Œåœ¨äº®å±ä¹‹åï¼Œç›‘å¬ Asensor å’Œ GSensorï¼Œåšä¸ºè½è…•å…¶å®åªåœ¨äº®å±åä½¿ç”¨ï¼Œæ•´ä½“ä¸Šæ¥è¯´ï¼Œæ˜¯ä¸å½±å“è€—æµã€‚ å°†ç®—æ³•ä¸‹æ²‰åˆ° ADSPï¼Œä¸»è¦è€ƒè™‘åç»­æ–¹æ¡ˆçš„é€‚é…æ€§ï¼Œé’ˆå¯¹ä¸€äº›ä½è€—æµçš„éœ€æ±‚ï¼Œå¯ä»¥èƒ½å¤Ÿè¾ƒå¥½çš„æ»¡è¶³ã€‚ ç¼–è¯‘ è®°å½•æˆ‘ç›®å‰ç¼–è¯‘çš„ä¸€ä¸ªé—®é¢˜ï¼Œå®Œæ•´çš„ AMSS ç¼–è¯‘ OKï¼Œä½†æ˜¯å•ç‹¬ç¼–è¯‘ ADSP çš„æ—¶å€™å°±ä¼šæŠ¥é”™ RuntimeError: Cannot proceed with encryption/decryption: openssl v1.0.1 is unavailable. åº”è¯¥æ˜¯ç¼–è¯‘å‡º adsp çš„ mbn åï¼Œç­¾åæ‰¾ä¸åˆ° openssl å¯¼è‡´çš„ï¼Œå…¨ç¼–è¯‘å’Œå•ç¼–è¯‘çš„ç¯å¢ƒå˜é‡å¯èƒ½æœ‰ä¸ªç¯èŠ‚æœ‰é—®é¢˜ã€‚åæ¥æ·»åŠ äº†ç¼–è¯‘çš„ç¯å¢ƒå˜é‡æ‰èƒ½å¤Ÿæ­£å¸¸çš„ç¼–è¯‘ export PATH=/pkg/qct/software/python/2.7/bin:$PATH è™šæ‹Ÿåˆæˆ Sensor æ·»åŠ  è¿™éƒ¨åˆ†æ˜¯é©±åŠ¨åŒäº‹åšçš„ï¼Œç›®å‰æˆ‘åªæ˜¯è®°å½•ä¸‹æ¥ï¼Œå…·ä½“ä»£ç æˆ‘ä¹ŸåŒæ­¥åœ¨äº† Media\u0026File -\u003e WristDown è·¯å¾„ä¸‹é¢ ä¸»è¦ä¸€ä¸ªæ˜¯åœ¨ adsp_proc/ssc/build/ssc.scons å’Œ adsp_proc/ssc_api/build/ssc_api.scons ä¸‹æ·»åŠ  sensor diff --git a/adsp_proc/ssc/build/ssc.scons b/adsp_proc/ssc/build/ssc.scons index 8b6ab05..28f98a9 100755 (executable) --- a/adsp_proc/ssc/build/ssc.scons +++ b/adsp_proc/ssc/build/ssc.scons @@ -129,7 +129,7 @@ if env.IsKeyEnable(ssc_build_tags) is True: #------------------------------------------------------------------------------- - 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc', + 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc','sns_wrist_tilt_updown', 'pah_813x_algo','pah_hr','sns_pah_hrd_algo_lib'] #------------------------------------------------------------------------------- diff --git a/adsp_proc/ssc_api/build/ssc_api.scons b/adsp_proc/ssc_api/build/ssc_api.scons index b5ca9ee..d67bc30 100755 (executable) --- a/adsp_proc/ssc_api/build/ssc_api.scons +++ b/adsp_proc/ssc_api/build/ssc_api.scons @@ -127,7 +127,8 @@ WHITELIST = [ 'sns_heart_rate.proto', 'sns_offbody_detect.proto', 'sns_ppg.proto', - 'sns_philips_vso.proto'] + 'sns_philips_vso.proto', + 'sns_wrist_tilt_updown.proto'] if 'SENSORS_ALGO_DEV_FLAG' in env: WHITELIST += [ sensor hal é‡Œé¢ä¹Ÿè¦æ·»åŠ  ç®—æ³•æ·»åŠ  ä¸»è¦æ˜¯åœ¨ adsp_proc/ssc/sensors/wrist_tilt_updown/src/sns_wrist_tilt_updown_sensor_instance_island.c é‡Œé¢ï¼Œ æ ¹æ®è·å–åˆ°çš„ Asensor å’Œ Gsensor æ•°æ®æ¥è®¡ç®—å¤„ç† ç®—æ³•éƒ¨åˆ† æ•°æ®ç»“æ„ å®šä¹‰äº†ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œç”¨æ¥ä¿å­˜ A sensor å’Œ G sensor çš„æ•°æ® /*=========================================================================== LinkedList Definitions ===========================================================================*/ /* init */ void LinkedList_init(LinkedList *list, int capacity) { list-\u003eelements = (SensorState *)malloc(sizeof(SensorState) * capacity); list-\u003efront = 0; list-\u003erear = -1; list-\u003ecapacity = capacity; list-\u003ecount = 0; } /* destory */ void LinkedList_destroy(LinkedList *list) { free(list-\u003eelements); } /* add item to the tail */ void LinkedList_enqueue(LinkedList *list, SensorState item,sns_sensor_instance *const this) { list-\u003erear = (list-\u003erear + 1) % list-\u003ecapacity; list-\u003eelements[list-\u003erear] = item; SNS_INST_PRINTF(ERROR, this, \"wentao LinkedList_enqueue item speed = %d /1000\", (int) (1000*item.mSpeed) ); if (list-\u003ecount \u003c list-\u003ecapacity) { list-\u003ecount++; } else { list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; } } /* remove oldest item */ SensorState LinkedList_dequeue(LinkedList *list) { SensorState item = list-\u003eelements[list-\u003efront]; list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; list-\u003ecount--; return item; } typedef struct { double mSpeed; float x; float y; float z; uint64_t timestamp; } SensorState; typedef struct { SensorState *elements; int front; int rear; int capacity; int count; } LinkedList; è¿åŠ¨æ£€æµ‹ é‡‡æ ·æ•°æ® a Sensor åŠ é€Ÿåº¦ g Sensor è§’é€Ÿåº¦ è¿åŠ¨æ£€æµ‹ä¸»è¦æ ¹æ®åŠ é€Ÿåº¦æ¥è®¡ç®—ã€‚ ç›®å‰çš„è¿åŠ¨æ£€æµ‹ç®—æ³• æ ¹æ®ç»éªŒå€¼æ¥åˆ¤æ–­ï¼Œåç»­å¦‚æœæœ‰ä¼˜åŒ–æœºä¼šï¼Œè¿˜æ˜¯è€ƒè™‘é‡‡ç”¨æ›´ç§‘å­¦çš„è®¡ç®—æ–¹æ³•ã€‚ //è¿™é‡Œé¢é‡‡æ ·é¢‘ç‡å¤§æ¦‚80msä¸€æ¬¡ï¼Œé‚£ä¹ˆä¸€ä¸ª10ä¸ªå•ä½çš„é‡‡æ ·æ•°ç»„ï¼Œå¤§æ¦‚èƒ½è®°å½•åˆ°0.8ç§’å‰çš„æ•°æ®ã€‚ float deltaX = x - lastX; float deltaY = y - lastY; float deltaZ = z - lastZ; //é€šè¿‡è®¡ç®—åŠ é€Ÿåº¦å·®å€¼çš„å¼€æ–¹é™¤ä»¥é—´éš”æ—¶é—´ï¼Œä½œä¸ºå°±æ£€æµ‹è¿åŠ¨å¼ºåº¦çš„åˆ¤æ–­ä¾æ® float sqrtV","date":"2024-11-06","objectID":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/:0:0","tags":["å®æˆ˜","ç®—æ³•ç ”ç©¶","blog","sensor"],"title":"adsp wristdown æµç¨‹ä¸å®ç°","uri":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/#æ•°æ®ç»“æ„"},{"categories":["Android"],"collections":["WMS"],"content":"#Peppermill #ç®—æ³•ç ”ç©¶ ç›®å‰ è½è…•ç­å±ç®—æ³•å¤§è‡´åœ¨ framework å±‚å®ç°ã€‚ ç›®å‰ç®—æ³•çš„æ€è·¯ï¼š #è¿åŠ¨æ£€æµ‹ï¼Œé€šè¿‡ä¸€äº›ç‰¹å¾å€¼ï¼Œæ¥åˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªè¿åŠ¨æ®µè½ã€‚ ç¬¦åˆçš„è¿åŠ¨æ£€æµ‹åï¼Œæˆ‘ä»¬æ¥åˆ¤æ–­æ˜¯å¦æ˜¯è½è…•çš„åŠ¨ä½œã€‚ ç¬¦åˆçš„è½è…•çš„åŠ¨ä½œåï¼Œsensor ä¸ŠæŠ¥ eventã€‚ framework ç›‘å¬è·å–åè¿›è¡Œç­å±çš„åˆ¤æ–­åŠ¨ä½œã€‚ èƒŒæ™¯ä»‹ç» æ—©èµ·çš„ Android å¹³å°ï¼ŒSensor æ˜¯æ”¾åœ¨ AP ä¾§å®ç°çš„ï¼ŒSensor ç”Ÿæˆè®¾å¤‡èŠ‚ç‚¹ä¾›ä¸Šå±‚ä½¿ç”¨ï¼ŒSensor çš„å·¥ä½œ CPU å°±ä¸èƒ½å®Œå¥½çš„ä¼‘çœ ã€‚ åç»­çš„é«˜ç‰ˆæœ¬ android å„ä¸ªå¹³å°å‚å•†éƒ½æœ‰äº†ä¸åŒçš„æ–¹æ¡ˆï¼ŒSensorHubï¼ŒADSP SensorHub ä¸ªäººç†è§£å•Šï¼ŒSensorHub åº”è¯¥ç®—ä¸€ä¸ªç‹¬ç«‹çš„å­ç³»ç»Ÿï¼ŒMCUï¼Œå¯ä»¥ä¸ä¾èµ– CPU æ¶æ„ç‹¬ç«‹è¿è¡Œï¼Œå¯ä»¥è¾ƒå¤§çš„ç¨‹åº¦çœç”µã€‚ä¸»è¦åŠŸèƒ½å°±æ˜¯è¿æ¥å„ç±» sensor å¹¶ä¸”å»å¤„ç†ï¼ŒMTK é‡‡ç”¨çš„è¯¥æ–¹æ¡ˆï¼Œä½¿ç”¨çš„æ˜¯ SRAM æ¶æ„ï¼Œé€šç”µå°±å¯ä»¥ä¿å­˜æ•°æ®ï¼Œç›¸å¯¹å†…å­˜éœ€è¦ä¸åœçš„åˆ·æ–°ï¼Œé•¿æœŸè¿è¡Œå¯ä»¥èŠ‚çœç”¨ç”µã€‚ ADSP ADSP éƒ¨åˆ† ä¹‹å‰æŠŠè½è…•çš„æ£€æµ‹æ”¾åœ¨ framework é‡Œé¢å®ç°ï¼Œåœ¨äº®å±ä¹‹åï¼Œç›‘å¬ Asensor å’Œ GSensorï¼Œåšä¸ºè½è…•å…¶å®åªåœ¨äº®å±åä½¿ç”¨ï¼Œæ•´ä½“ä¸Šæ¥è¯´ï¼Œæ˜¯ä¸å½±å“è€—æµã€‚ å°†ç®—æ³•ä¸‹æ²‰åˆ° ADSPï¼Œä¸»è¦è€ƒè™‘åç»­æ–¹æ¡ˆçš„é€‚é…æ€§ï¼Œé’ˆå¯¹ä¸€äº›ä½è€—æµçš„éœ€æ±‚ï¼Œå¯ä»¥èƒ½å¤Ÿè¾ƒå¥½çš„æ»¡è¶³ã€‚ ç¼–è¯‘ è®°å½•æˆ‘ç›®å‰ç¼–è¯‘çš„ä¸€ä¸ªé—®é¢˜ï¼Œå®Œæ•´çš„ AMSS ç¼–è¯‘ OKï¼Œä½†æ˜¯å•ç‹¬ç¼–è¯‘ ADSP çš„æ—¶å€™å°±ä¼šæŠ¥é”™ RuntimeError: Cannot proceed with encryption/decryption: openssl v1.0.1 is unavailable. åº”è¯¥æ˜¯ç¼–è¯‘å‡º adsp çš„ mbn åï¼Œç­¾åæ‰¾ä¸åˆ° openssl å¯¼è‡´çš„ï¼Œå…¨ç¼–è¯‘å’Œå•ç¼–è¯‘çš„ç¯å¢ƒå˜é‡å¯èƒ½æœ‰ä¸ªç¯èŠ‚æœ‰é—®é¢˜ã€‚åæ¥æ·»åŠ äº†ç¼–è¯‘çš„ç¯å¢ƒå˜é‡æ‰èƒ½å¤Ÿæ­£å¸¸çš„ç¼–è¯‘ export PATH=/pkg/qct/software/python/2.7/bin:$PATH è™šæ‹Ÿåˆæˆ Sensor æ·»åŠ  è¿™éƒ¨åˆ†æ˜¯é©±åŠ¨åŒäº‹åšçš„ï¼Œç›®å‰æˆ‘åªæ˜¯è®°å½•ä¸‹æ¥ï¼Œå…·ä½“ä»£ç æˆ‘ä¹ŸåŒæ­¥åœ¨äº† Media\u0026File -\u003e WristDown è·¯å¾„ä¸‹é¢ ä¸»è¦ä¸€ä¸ªæ˜¯åœ¨ adsp_proc/ssc/build/ssc.scons å’Œ adsp_proc/ssc_api/build/ssc_api.scons ä¸‹æ·»åŠ  sensor diff --git a/adsp_proc/ssc/build/ssc.scons b/adsp_proc/ssc/build/ssc.scons index 8b6ab05..28f98a9 100755 (executable) --- a/adsp_proc/ssc/build/ssc.scons +++ b/adsp_proc/ssc/build/ssc.scons @@ -129,7 +129,7 @@ if env.IsKeyEnable(ssc_build_tags) is True: #------------------------------------------------------------------------------- - 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc', + 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc','sns_wrist_tilt_updown', 'pah_813x_algo','pah_hr','sns_pah_hrd_algo_lib'] #------------------------------------------------------------------------------- diff --git a/adsp_proc/ssc_api/build/ssc_api.scons b/adsp_proc/ssc_api/build/ssc_api.scons index b5ca9ee..d67bc30 100755 (executable) --- a/adsp_proc/ssc_api/build/ssc_api.scons +++ b/adsp_proc/ssc_api/build/ssc_api.scons @@ -127,7 +127,8 @@ WHITELIST = [ 'sns_heart_rate.proto', 'sns_offbody_detect.proto', 'sns_ppg.proto', - 'sns_philips_vso.proto'] + 'sns_philips_vso.proto', + 'sns_wrist_tilt_updown.proto'] if 'SENSORS_ALGO_DEV_FLAG' in env: WHITELIST += [ sensor hal é‡Œé¢ä¹Ÿè¦æ·»åŠ  ç®—æ³•æ·»åŠ  ä¸»è¦æ˜¯åœ¨ adsp_proc/ssc/sensors/wrist_tilt_updown/src/sns_wrist_tilt_updown_sensor_instance_island.c é‡Œé¢ï¼Œ æ ¹æ®è·å–åˆ°çš„ Asensor å’Œ Gsensor æ•°æ®æ¥è®¡ç®—å¤„ç† ç®—æ³•éƒ¨åˆ† æ•°æ®ç»“æ„ å®šä¹‰äº†ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œç”¨æ¥ä¿å­˜ A sensor å’Œ G sensor çš„æ•°æ® /*=========================================================================== LinkedList Definitions ===========================================================================*/ /* init */ void LinkedList_init(LinkedList *list, int capacity) { list-\u003eelements = (SensorState *)malloc(sizeof(SensorState) * capacity); list-\u003efront = 0; list-\u003erear = -1; list-\u003ecapacity = capacity; list-\u003ecount = 0; } /* destory */ void LinkedList_destroy(LinkedList *list) { free(list-\u003eelements); } /* add item to the tail */ void LinkedList_enqueue(LinkedList *list, SensorState item,sns_sensor_instance *const this) { list-\u003erear = (list-\u003erear + 1) % list-\u003ecapacity; list-\u003eelements[list-\u003erear] = item; SNS_INST_PRINTF(ERROR, this, \"wentao LinkedList_enqueue item speed = %d /1000\", (int) (1000*item.mSpeed) ); if (list-\u003ecount \u003c list-\u003ecapacity) { list-\u003ecount++; } else { list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; } } /* remove oldest item */ SensorState LinkedList_dequeue(LinkedList *list) { SensorState item = list-\u003eelements[list-\u003efront]; list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; list-\u003ecount--; return item; } typedef struct { double mSpeed; float x; float y; float z; uint64_t timestamp; } SensorState; typedef struct { SensorState *elements; int front; int rear; int capacity; int count; } LinkedList; è¿åŠ¨æ£€æµ‹ é‡‡æ ·æ•°æ® a Sensor åŠ é€Ÿåº¦ g Sensor è§’é€Ÿåº¦ è¿åŠ¨æ£€æµ‹ä¸»è¦æ ¹æ®åŠ é€Ÿåº¦æ¥è®¡ç®—ã€‚ ç›®å‰çš„è¿åŠ¨æ£€æµ‹ç®—æ³• æ ¹æ®ç»éªŒå€¼æ¥åˆ¤æ–­ï¼Œåç»­å¦‚æœæœ‰ä¼˜åŒ–æœºä¼šï¼Œè¿˜æ˜¯è€ƒè™‘é‡‡ç”¨æ›´ç§‘å­¦çš„è®¡ç®—æ–¹æ³•ã€‚ //è¿™é‡Œé¢é‡‡æ ·é¢‘ç‡å¤§æ¦‚80msä¸€æ¬¡ï¼Œé‚£ä¹ˆä¸€ä¸ª10ä¸ªå•ä½çš„é‡‡æ ·æ•°ç»„ï¼Œå¤§æ¦‚èƒ½è®°å½•åˆ°0.8ç§’å‰çš„æ•°æ®ã€‚ float deltaX = x - lastX; float deltaY = y - lastY; float deltaZ = z - lastZ; //é€šè¿‡è®¡ç®—åŠ é€Ÿåº¦å·®å€¼çš„å¼€æ–¹é™¤ä»¥é—´éš”æ—¶é—´ï¼Œä½œä¸ºå°±æ£€æµ‹è¿åŠ¨å¼ºåº¦çš„åˆ¤æ–­ä¾æ® float sqrtV","date":"2024-11-06","objectID":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/:0:0","tags":["å®æˆ˜","ç®—æ³•ç ”ç©¶","blog","sensor"],"title":"adsp wristdown æµç¨‹ä¸å®ç°","uri":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/#è¿åŠ¨æ£€æµ‹"},{"categories":["Android"],"collections":["WMS"],"content":"#Peppermill #ç®—æ³•ç ”ç©¶ ç›®å‰ è½è…•ç­å±ç®—æ³•å¤§è‡´åœ¨ framework å±‚å®ç°ã€‚ ç›®å‰ç®—æ³•çš„æ€è·¯ï¼š #è¿åŠ¨æ£€æµ‹ï¼Œé€šè¿‡ä¸€äº›ç‰¹å¾å€¼ï¼Œæ¥åˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªè¿åŠ¨æ®µè½ã€‚ ç¬¦åˆçš„è¿åŠ¨æ£€æµ‹åï¼Œæˆ‘ä»¬æ¥åˆ¤æ–­æ˜¯å¦æ˜¯è½è…•çš„åŠ¨ä½œã€‚ ç¬¦åˆçš„è½è…•çš„åŠ¨ä½œåï¼Œsensor ä¸ŠæŠ¥ eventã€‚ framework ç›‘å¬è·å–åè¿›è¡Œç­å±çš„åˆ¤æ–­åŠ¨ä½œã€‚ èƒŒæ™¯ä»‹ç» æ—©èµ·çš„ Android å¹³å°ï¼ŒSensor æ˜¯æ”¾åœ¨ AP ä¾§å®ç°çš„ï¼ŒSensor ç”Ÿæˆè®¾å¤‡èŠ‚ç‚¹ä¾›ä¸Šå±‚ä½¿ç”¨ï¼ŒSensor çš„å·¥ä½œ CPU å°±ä¸èƒ½å®Œå¥½çš„ä¼‘çœ ã€‚ åç»­çš„é«˜ç‰ˆæœ¬ android å„ä¸ªå¹³å°å‚å•†éƒ½æœ‰äº†ä¸åŒçš„æ–¹æ¡ˆï¼ŒSensorHubï¼ŒADSP SensorHub ä¸ªäººç†è§£å•Šï¼ŒSensorHub åº”è¯¥ç®—ä¸€ä¸ªç‹¬ç«‹çš„å­ç³»ç»Ÿï¼ŒMCUï¼Œå¯ä»¥ä¸ä¾èµ– CPU æ¶æ„ç‹¬ç«‹è¿è¡Œï¼Œå¯ä»¥è¾ƒå¤§çš„ç¨‹åº¦çœç”µã€‚ä¸»è¦åŠŸèƒ½å°±æ˜¯è¿æ¥å„ç±» sensor å¹¶ä¸”å»å¤„ç†ï¼ŒMTK é‡‡ç”¨çš„è¯¥æ–¹æ¡ˆï¼Œä½¿ç”¨çš„æ˜¯ SRAM æ¶æ„ï¼Œé€šç”µå°±å¯ä»¥ä¿å­˜æ•°æ®ï¼Œç›¸å¯¹å†…å­˜éœ€è¦ä¸åœçš„åˆ·æ–°ï¼Œé•¿æœŸè¿è¡Œå¯ä»¥èŠ‚çœç”¨ç”µã€‚ ADSP ADSP éƒ¨åˆ† ä¹‹å‰æŠŠè½è…•çš„æ£€æµ‹æ”¾åœ¨ framework é‡Œé¢å®ç°ï¼Œåœ¨äº®å±ä¹‹åï¼Œç›‘å¬ Asensor å’Œ GSensorï¼Œåšä¸ºè½è…•å…¶å®åªåœ¨äº®å±åä½¿ç”¨ï¼Œæ•´ä½“ä¸Šæ¥è¯´ï¼Œæ˜¯ä¸å½±å“è€—æµã€‚ å°†ç®—æ³•ä¸‹æ²‰åˆ° ADSPï¼Œä¸»è¦è€ƒè™‘åç»­æ–¹æ¡ˆçš„é€‚é…æ€§ï¼Œé’ˆå¯¹ä¸€äº›ä½è€—æµçš„éœ€æ±‚ï¼Œå¯ä»¥èƒ½å¤Ÿè¾ƒå¥½çš„æ»¡è¶³ã€‚ ç¼–è¯‘ è®°å½•æˆ‘ç›®å‰ç¼–è¯‘çš„ä¸€ä¸ªé—®é¢˜ï¼Œå®Œæ•´çš„ AMSS ç¼–è¯‘ OKï¼Œä½†æ˜¯å•ç‹¬ç¼–è¯‘ ADSP çš„æ—¶å€™å°±ä¼šæŠ¥é”™ RuntimeError: Cannot proceed with encryption/decryption: openssl v1.0.1 is unavailable. åº”è¯¥æ˜¯ç¼–è¯‘å‡º adsp çš„ mbn åï¼Œç­¾åæ‰¾ä¸åˆ° openssl å¯¼è‡´çš„ï¼Œå…¨ç¼–è¯‘å’Œå•ç¼–è¯‘çš„ç¯å¢ƒå˜é‡å¯èƒ½æœ‰ä¸ªç¯èŠ‚æœ‰é—®é¢˜ã€‚åæ¥æ·»åŠ äº†ç¼–è¯‘çš„ç¯å¢ƒå˜é‡æ‰èƒ½å¤Ÿæ­£å¸¸çš„ç¼–è¯‘ export PATH=/pkg/qct/software/python/2.7/bin:$PATH è™šæ‹Ÿåˆæˆ Sensor æ·»åŠ  è¿™éƒ¨åˆ†æ˜¯é©±åŠ¨åŒäº‹åšçš„ï¼Œç›®å‰æˆ‘åªæ˜¯è®°å½•ä¸‹æ¥ï¼Œå…·ä½“ä»£ç æˆ‘ä¹ŸåŒæ­¥åœ¨äº† Media\u0026File -\u003e WristDown è·¯å¾„ä¸‹é¢ ä¸»è¦ä¸€ä¸ªæ˜¯åœ¨ adsp_proc/ssc/build/ssc.scons å’Œ adsp_proc/ssc_api/build/ssc_api.scons ä¸‹æ·»åŠ  sensor diff --git a/adsp_proc/ssc/build/ssc.scons b/adsp_proc/ssc/build/ssc.scons index 8b6ab05..28f98a9 100755 (executable) --- a/adsp_proc/ssc/build/ssc.scons +++ b/adsp_proc/ssc/build/ssc.scons @@ -129,7 +129,7 @@ if env.IsKeyEnable(ssc_build_tags) is True: #------------------------------------------------------------------------------- - 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc', + 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc','sns_wrist_tilt_updown', 'pah_813x_algo','pah_hr','sns_pah_hrd_algo_lib'] #------------------------------------------------------------------------------- diff --git a/adsp_proc/ssc_api/build/ssc_api.scons b/adsp_proc/ssc_api/build/ssc_api.scons index b5ca9ee..d67bc30 100755 (executable) --- a/adsp_proc/ssc_api/build/ssc_api.scons +++ b/adsp_proc/ssc_api/build/ssc_api.scons @@ -127,7 +127,8 @@ WHITELIST = [ 'sns_heart_rate.proto', 'sns_offbody_detect.proto', 'sns_ppg.proto', - 'sns_philips_vso.proto'] + 'sns_philips_vso.proto', + 'sns_wrist_tilt_updown.proto'] if 'SENSORS_ALGO_DEV_FLAG' in env: WHITELIST += [ sensor hal é‡Œé¢ä¹Ÿè¦æ·»åŠ  ç®—æ³•æ·»åŠ  ä¸»è¦æ˜¯åœ¨ adsp_proc/ssc/sensors/wrist_tilt_updown/src/sns_wrist_tilt_updown_sensor_instance_island.c é‡Œé¢ï¼Œ æ ¹æ®è·å–åˆ°çš„ Asensor å’Œ Gsensor æ•°æ®æ¥è®¡ç®—å¤„ç† ç®—æ³•éƒ¨åˆ† æ•°æ®ç»“æ„ å®šä¹‰äº†ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œç”¨æ¥ä¿å­˜ A sensor å’Œ G sensor çš„æ•°æ® /*=========================================================================== LinkedList Definitions ===========================================================================*/ /* init */ void LinkedList_init(LinkedList *list, int capacity) { list-\u003eelements = (SensorState *)malloc(sizeof(SensorState) * capacity); list-\u003efront = 0; list-\u003erear = -1; list-\u003ecapacity = capacity; list-\u003ecount = 0; } /* destory */ void LinkedList_destroy(LinkedList *list) { free(list-\u003eelements); } /* add item to the tail */ void LinkedList_enqueue(LinkedList *list, SensorState item,sns_sensor_instance *const this) { list-\u003erear = (list-\u003erear + 1) % list-\u003ecapacity; list-\u003eelements[list-\u003erear] = item; SNS_INST_PRINTF(ERROR, this, \"wentao LinkedList_enqueue item speed = %d /1000\", (int) (1000*item.mSpeed) ); if (list-\u003ecount \u003c list-\u003ecapacity) { list-\u003ecount++; } else { list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; } } /* remove oldest item */ SensorState LinkedList_dequeue(LinkedList *list) { SensorState item = list-\u003eelements[list-\u003efront]; list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; list-\u003ecount--; return item; } typedef struct { double mSpeed; float x; float y; float z; uint64_t timestamp; } SensorState; typedef struct { SensorState *elements; int front; int rear; int capacity; int count; } LinkedList; è¿åŠ¨æ£€æµ‹ é‡‡æ ·æ•°æ® a Sensor åŠ é€Ÿåº¦ g Sensor è§’é€Ÿåº¦ è¿åŠ¨æ£€æµ‹ä¸»è¦æ ¹æ®åŠ é€Ÿåº¦æ¥è®¡ç®—ã€‚ ç›®å‰çš„è¿åŠ¨æ£€æµ‹ç®—æ³• æ ¹æ®ç»éªŒå€¼æ¥åˆ¤æ–­ï¼Œåç»­å¦‚æœæœ‰ä¼˜åŒ–æœºä¼šï¼Œè¿˜æ˜¯è€ƒè™‘é‡‡ç”¨æ›´ç§‘å­¦çš„è®¡ç®—æ–¹æ³•ã€‚ //è¿™é‡Œé¢é‡‡æ ·é¢‘ç‡å¤§æ¦‚80msä¸€æ¬¡ï¼Œé‚£ä¹ˆä¸€ä¸ª10ä¸ªå•ä½çš„é‡‡æ ·æ•°ç»„ï¼Œå¤§æ¦‚èƒ½è®°å½•åˆ°0.8ç§’å‰çš„æ•°æ®ã€‚ float deltaX = x - lastX; float deltaY = y - lastY; float deltaZ = z - lastZ; //é€šè¿‡è®¡ç®—åŠ é€Ÿåº¦å·®å€¼çš„å¼€æ–¹é™¤ä»¥é—´éš”æ—¶é—´ï¼Œä½œä¸ºå°±æ£€æµ‹è¿åŠ¨å¼ºåº¦çš„åˆ¤æ–­ä¾æ® float sqrtV","date":"2024-11-06","objectID":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/:0:0","tags":["å®æˆ˜","ç®—æ³•ç ”ç©¶","blog","sensor"],"title":"adsp wristdown æµç¨‹ä¸å®ç°","uri":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/#framework-éƒ¨åˆ†"},{"categories":["Android"],"collections":["WMS"],"content":"#Peppermill #ç®—æ³•ç ”ç©¶ ç›®å‰ è½è…•ç­å±ç®—æ³•å¤§è‡´åœ¨ framework å±‚å®ç°ã€‚ ç›®å‰ç®—æ³•çš„æ€è·¯ï¼š #è¿åŠ¨æ£€æµ‹ï¼Œé€šè¿‡ä¸€äº›ç‰¹å¾å€¼ï¼Œæ¥åˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªè¿åŠ¨æ®µè½ã€‚ ç¬¦åˆçš„è¿åŠ¨æ£€æµ‹åï¼Œæˆ‘ä»¬æ¥åˆ¤æ–­æ˜¯å¦æ˜¯è½è…•çš„åŠ¨ä½œã€‚ ç¬¦åˆçš„è½è…•çš„åŠ¨ä½œåï¼Œsensor ä¸ŠæŠ¥ eventã€‚ framework ç›‘å¬è·å–åè¿›è¡Œç­å±çš„åˆ¤æ–­åŠ¨ä½œã€‚ èƒŒæ™¯ä»‹ç» æ—©èµ·çš„ Android å¹³å°ï¼ŒSensor æ˜¯æ”¾åœ¨ AP ä¾§å®ç°çš„ï¼ŒSensor ç”Ÿæˆè®¾å¤‡èŠ‚ç‚¹ä¾›ä¸Šå±‚ä½¿ç”¨ï¼ŒSensor çš„å·¥ä½œ CPU å°±ä¸èƒ½å®Œå¥½çš„ä¼‘çœ ã€‚ åç»­çš„é«˜ç‰ˆæœ¬ android å„ä¸ªå¹³å°å‚å•†éƒ½æœ‰äº†ä¸åŒçš„æ–¹æ¡ˆï¼ŒSensorHubï¼ŒADSP SensorHub ä¸ªäººç†è§£å•Šï¼ŒSensorHub åº”è¯¥ç®—ä¸€ä¸ªç‹¬ç«‹çš„å­ç³»ç»Ÿï¼ŒMCUï¼Œå¯ä»¥ä¸ä¾èµ– CPU æ¶æ„ç‹¬ç«‹è¿è¡Œï¼Œå¯ä»¥è¾ƒå¤§çš„ç¨‹åº¦çœç”µã€‚ä¸»è¦åŠŸèƒ½å°±æ˜¯è¿æ¥å„ç±» sensor å¹¶ä¸”å»å¤„ç†ï¼ŒMTK é‡‡ç”¨çš„è¯¥æ–¹æ¡ˆï¼Œä½¿ç”¨çš„æ˜¯ SRAM æ¶æ„ï¼Œé€šç”µå°±å¯ä»¥ä¿å­˜æ•°æ®ï¼Œç›¸å¯¹å†…å­˜éœ€è¦ä¸åœçš„åˆ·æ–°ï¼Œé•¿æœŸè¿è¡Œå¯ä»¥èŠ‚çœç”¨ç”µã€‚ ADSP ADSP éƒ¨åˆ† ä¹‹å‰æŠŠè½è…•çš„æ£€æµ‹æ”¾åœ¨ framework é‡Œé¢å®ç°ï¼Œåœ¨äº®å±ä¹‹åï¼Œç›‘å¬ Asensor å’Œ GSensorï¼Œåšä¸ºè½è…•å…¶å®åªåœ¨äº®å±åä½¿ç”¨ï¼Œæ•´ä½“ä¸Šæ¥è¯´ï¼Œæ˜¯ä¸å½±å“è€—æµã€‚ å°†ç®—æ³•ä¸‹æ²‰åˆ° ADSPï¼Œä¸»è¦è€ƒè™‘åç»­æ–¹æ¡ˆçš„é€‚é…æ€§ï¼Œé’ˆå¯¹ä¸€äº›ä½è€—æµçš„éœ€æ±‚ï¼Œå¯ä»¥èƒ½å¤Ÿè¾ƒå¥½çš„æ»¡è¶³ã€‚ ç¼–è¯‘ è®°å½•æˆ‘ç›®å‰ç¼–è¯‘çš„ä¸€ä¸ªé—®é¢˜ï¼Œå®Œæ•´çš„ AMSS ç¼–è¯‘ OKï¼Œä½†æ˜¯å•ç‹¬ç¼–è¯‘ ADSP çš„æ—¶å€™å°±ä¼šæŠ¥é”™ RuntimeError: Cannot proceed with encryption/decryption: openssl v1.0.1 is unavailable. åº”è¯¥æ˜¯ç¼–è¯‘å‡º adsp çš„ mbn åï¼Œç­¾åæ‰¾ä¸åˆ° openssl å¯¼è‡´çš„ï¼Œå…¨ç¼–è¯‘å’Œå•ç¼–è¯‘çš„ç¯å¢ƒå˜é‡å¯èƒ½æœ‰ä¸ªç¯èŠ‚æœ‰é—®é¢˜ã€‚åæ¥æ·»åŠ äº†ç¼–è¯‘çš„ç¯å¢ƒå˜é‡æ‰èƒ½å¤Ÿæ­£å¸¸çš„ç¼–è¯‘ export PATH=/pkg/qct/software/python/2.7/bin:$PATH è™šæ‹Ÿåˆæˆ Sensor æ·»åŠ  è¿™éƒ¨åˆ†æ˜¯é©±åŠ¨åŒäº‹åšçš„ï¼Œç›®å‰æˆ‘åªæ˜¯è®°å½•ä¸‹æ¥ï¼Œå…·ä½“ä»£ç æˆ‘ä¹ŸåŒæ­¥åœ¨äº† Media\u0026File -\u003e WristDown è·¯å¾„ä¸‹é¢ ä¸»è¦ä¸€ä¸ªæ˜¯åœ¨ adsp_proc/ssc/build/ssc.scons å’Œ adsp_proc/ssc_api/build/ssc_api.scons ä¸‹æ·»åŠ  sensor diff --git a/adsp_proc/ssc/build/ssc.scons b/adsp_proc/ssc/build/ssc.scons index 8b6ab05..28f98a9 100755 (executable) --- a/adsp_proc/ssc/build/ssc.scons +++ b/adsp_proc/ssc/build/ssc.scons @@ -129,7 +129,7 @@ if env.IsKeyEnable(ssc_build_tags) is True: #------------------------------------------------------------------------------- - 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc', + 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc','sns_wrist_tilt_updown', 'pah_813x_algo','pah_hr','sns_pah_hrd_algo_lib'] #------------------------------------------------------------------------------- diff --git a/adsp_proc/ssc_api/build/ssc_api.scons b/adsp_proc/ssc_api/build/ssc_api.scons index b5ca9ee..d67bc30 100755 (executable) --- a/adsp_proc/ssc_api/build/ssc_api.scons +++ b/adsp_proc/ssc_api/build/ssc_api.scons @@ -127,7 +127,8 @@ WHITELIST = [ 'sns_heart_rate.proto', 'sns_offbody_detect.proto', 'sns_ppg.proto', - 'sns_philips_vso.proto'] + 'sns_philips_vso.proto', + 'sns_wrist_tilt_updown.proto'] if 'SENSORS_ALGO_DEV_FLAG' in env: WHITELIST += [ sensor hal é‡Œé¢ä¹Ÿè¦æ·»åŠ  ç®—æ³•æ·»åŠ  ä¸»è¦æ˜¯åœ¨ adsp_proc/ssc/sensors/wrist_tilt_updown/src/sns_wrist_tilt_updown_sensor_instance_island.c é‡Œé¢ï¼Œ æ ¹æ®è·å–åˆ°çš„ Asensor å’Œ Gsensor æ•°æ®æ¥è®¡ç®—å¤„ç† ç®—æ³•éƒ¨åˆ† æ•°æ®ç»“æ„ å®šä¹‰äº†ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œç”¨æ¥ä¿å­˜ A sensor å’Œ G sensor çš„æ•°æ® /*=========================================================================== LinkedList Definitions ===========================================================================*/ /* init */ void LinkedList_init(LinkedList *list, int capacity) { list-\u003eelements = (SensorState *)malloc(sizeof(SensorState) * capacity); list-\u003efront = 0; list-\u003erear = -1; list-\u003ecapacity = capacity; list-\u003ecount = 0; } /* destory */ void LinkedList_destroy(LinkedList *list) { free(list-\u003eelements); } /* add item to the tail */ void LinkedList_enqueue(LinkedList *list, SensorState item,sns_sensor_instance *const this) { list-\u003erear = (list-\u003erear + 1) % list-\u003ecapacity; list-\u003eelements[list-\u003erear] = item; SNS_INST_PRINTF(ERROR, this, \"wentao LinkedList_enqueue item speed = %d /1000\", (int) (1000*item.mSpeed) ); if (list-\u003ecount \u003c list-\u003ecapacity) { list-\u003ecount++; } else { list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; } } /* remove oldest item */ SensorState LinkedList_dequeue(LinkedList *list) { SensorState item = list-\u003eelements[list-\u003efront]; list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; list-\u003ecount--; return item; } typedef struct { double mSpeed; float x; float y; float z; uint64_t timestamp; } SensorState; typedef struct { SensorState *elements; int front; int rear; int capacity; int count; } LinkedList; è¿åŠ¨æ£€æµ‹ é‡‡æ ·æ•°æ® a Sensor åŠ é€Ÿåº¦ g Sensor è§’é€Ÿåº¦ è¿åŠ¨æ£€æµ‹ä¸»è¦æ ¹æ®åŠ é€Ÿåº¦æ¥è®¡ç®—ã€‚ ç›®å‰çš„è¿åŠ¨æ£€æµ‹ç®—æ³• æ ¹æ®ç»éªŒå€¼æ¥åˆ¤æ–­ï¼Œåç»­å¦‚æœæœ‰ä¼˜åŒ–æœºä¼šï¼Œè¿˜æ˜¯è€ƒè™‘é‡‡ç”¨æ›´ç§‘å­¦çš„è®¡ç®—æ–¹æ³•ã€‚ //è¿™é‡Œé¢é‡‡æ ·é¢‘ç‡å¤§æ¦‚80msä¸€æ¬¡ï¼Œé‚£ä¹ˆä¸€ä¸ª10ä¸ªå•ä½çš„é‡‡æ ·æ•°ç»„ï¼Œå¤§æ¦‚èƒ½è®°å½•åˆ°0.8ç§’å‰çš„æ•°æ®ã€‚ float deltaX = x - lastX; float deltaY = y - lastY; float deltaZ = z - lastZ; //é€šè¿‡è®¡ç®—åŠ é€Ÿåº¦å·®å€¼çš„å¼€æ–¹é™¤ä»¥é—´éš”æ—¶é—´ï¼Œä½œä¸ºå°±æ£€æµ‹è¿åŠ¨å¼ºåº¦çš„åˆ¤æ–­ä¾æ® float sqrtV","date":"2024-11-06","objectID":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/:0:0","tags":["å®æˆ˜","ç®—æ³•ç ”ç©¶","blog","sensor"],"title":"adsp wristdown æµç¨‹ä¸å®ç°","uri":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/#å‚è€ƒéƒ¨åˆ†"},{"categories":["Android"],"collections":["WMS"],"content":"#Peppermill #ç®—æ³•ç ”ç©¶ ç›®å‰ è½è…•ç­å±ç®—æ³•å¤§è‡´åœ¨ framework å±‚å®ç°ã€‚ ç›®å‰ç®—æ³•çš„æ€è·¯ï¼š #è¿åŠ¨æ£€æµ‹ï¼Œé€šè¿‡ä¸€äº›ç‰¹å¾å€¼ï¼Œæ¥åˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªè¿åŠ¨æ®µè½ã€‚ ç¬¦åˆçš„è¿åŠ¨æ£€æµ‹åï¼Œæˆ‘ä»¬æ¥åˆ¤æ–­æ˜¯å¦æ˜¯è½è…•çš„åŠ¨ä½œã€‚ ç¬¦åˆçš„è½è…•çš„åŠ¨ä½œåï¼Œsensor ä¸ŠæŠ¥ eventã€‚ framework ç›‘å¬è·å–åè¿›è¡Œç­å±çš„åˆ¤æ–­åŠ¨ä½œã€‚ èƒŒæ™¯ä»‹ç» æ—©èµ·çš„ Android å¹³å°ï¼ŒSensor æ˜¯æ”¾åœ¨ AP ä¾§å®ç°çš„ï¼ŒSensor ç”Ÿæˆè®¾å¤‡èŠ‚ç‚¹ä¾›ä¸Šå±‚ä½¿ç”¨ï¼ŒSensor çš„å·¥ä½œ CPU å°±ä¸èƒ½å®Œå¥½çš„ä¼‘çœ ã€‚ åç»­çš„é«˜ç‰ˆæœ¬ android å„ä¸ªå¹³å°å‚å•†éƒ½æœ‰äº†ä¸åŒçš„æ–¹æ¡ˆï¼ŒSensorHubï¼ŒADSP SensorHub ä¸ªäººç†è§£å•Šï¼ŒSensorHub åº”è¯¥ç®—ä¸€ä¸ªç‹¬ç«‹çš„å­ç³»ç»Ÿï¼ŒMCUï¼Œå¯ä»¥ä¸ä¾èµ– CPU æ¶æ„ç‹¬ç«‹è¿è¡Œï¼Œå¯ä»¥è¾ƒå¤§çš„ç¨‹åº¦çœç”µã€‚ä¸»è¦åŠŸèƒ½å°±æ˜¯è¿æ¥å„ç±» sensor å¹¶ä¸”å»å¤„ç†ï¼ŒMTK é‡‡ç”¨çš„è¯¥æ–¹æ¡ˆï¼Œä½¿ç”¨çš„æ˜¯ SRAM æ¶æ„ï¼Œé€šç”µå°±å¯ä»¥ä¿å­˜æ•°æ®ï¼Œç›¸å¯¹å†…å­˜éœ€è¦ä¸åœçš„åˆ·æ–°ï¼Œé•¿æœŸè¿è¡Œå¯ä»¥èŠ‚çœç”¨ç”µã€‚ ADSP ADSP éƒ¨åˆ† ä¹‹å‰æŠŠè½è…•çš„æ£€æµ‹æ”¾åœ¨ framework é‡Œé¢å®ç°ï¼Œåœ¨äº®å±ä¹‹åï¼Œç›‘å¬ Asensor å’Œ GSensorï¼Œåšä¸ºè½è…•å…¶å®åªåœ¨äº®å±åä½¿ç”¨ï¼Œæ•´ä½“ä¸Šæ¥è¯´ï¼Œæ˜¯ä¸å½±å“è€—æµã€‚ å°†ç®—æ³•ä¸‹æ²‰åˆ° ADSPï¼Œä¸»è¦è€ƒè™‘åç»­æ–¹æ¡ˆçš„é€‚é…æ€§ï¼Œé’ˆå¯¹ä¸€äº›ä½è€—æµçš„éœ€æ±‚ï¼Œå¯ä»¥èƒ½å¤Ÿè¾ƒå¥½çš„æ»¡è¶³ã€‚ ç¼–è¯‘ è®°å½•æˆ‘ç›®å‰ç¼–è¯‘çš„ä¸€ä¸ªé—®é¢˜ï¼Œå®Œæ•´çš„ AMSS ç¼–è¯‘ OKï¼Œä½†æ˜¯å•ç‹¬ç¼–è¯‘ ADSP çš„æ—¶å€™å°±ä¼šæŠ¥é”™ RuntimeError: Cannot proceed with encryption/decryption: openssl v1.0.1 is unavailable. åº”è¯¥æ˜¯ç¼–è¯‘å‡º adsp çš„ mbn åï¼Œç­¾åæ‰¾ä¸åˆ° openssl å¯¼è‡´çš„ï¼Œå…¨ç¼–è¯‘å’Œå•ç¼–è¯‘çš„ç¯å¢ƒå˜é‡å¯èƒ½æœ‰ä¸ªç¯èŠ‚æœ‰é—®é¢˜ã€‚åæ¥æ·»åŠ äº†ç¼–è¯‘çš„ç¯å¢ƒå˜é‡æ‰èƒ½å¤Ÿæ­£å¸¸çš„ç¼–è¯‘ export PATH=/pkg/qct/software/python/2.7/bin:$PATH è™šæ‹Ÿåˆæˆ Sensor æ·»åŠ  è¿™éƒ¨åˆ†æ˜¯é©±åŠ¨åŒäº‹åšçš„ï¼Œç›®å‰æˆ‘åªæ˜¯è®°å½•ä¸‹æ¥ï¼Œå…·ä½“ä»£ç æˆ‘ä¹ŸåŒæ­¥åœ¨äº† Media\u0026File -\u003e WristDown è·¯å¾„ä¸‹é¢ ä¸»è¦ä¸€ä¸ªæ˜¯åœ¨ adsp_proc/ssc/build/ssc.scons å’Œ adsp_proc/ssc_api/build/ssc_api.scons ä¸‹æ·»åŠ  sensor diff --git a/adsp_proc/ssc/build/ssc.scons b/adsp_proc/ssc/build/ssc.scons index 8b6ab05..28f98a9 100755 (executable) --- a/adsp_proc/ssc/build/ssc.scons +++ b/adsp_proc/ssc/build/ssc.scons @@ -129,7 +129,7 @@ if env.IsKeyEnable(ssc_build_tags) is True: #------------------------------------------------------------------------------- - 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc', + 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc','sns_wrist_tilt_updown', 'pah_813x_algo','pah_hr','sns_pah_hrd_algo_lib'] #------------------------------------------------------------------------------- diff --git a/adsp_proc/ssc_api/build/ssc_api.scons b/adsp_proc/ssc_api/build/ssc_api.scons index b5ca9ee..d67bc30 100755 (executable) --- a/adsp_proc/ssc_api/build/ssc_api.scons +++ b/adsp_proc/ssc_api/build/ssc_api.scons @@ -127,7 +127,8 @@ WHITELIST = [ 'sns_heart_rate.proto', 'sns_offbody_detect.proto', 'sns_ppg.proto', - 'sns_philips_vso.proto'] + 'sns_philips_vso.proto', + 'sns_wrist_tilt_updown.proto'] if 'SENSORS_ALGO_DEV_FLAG' in env: WHITELIST += [ sensor hal é‡Œé¢ä¹Ÿè¦æ·»åŠ  ç®—æ³•æ·»åŠ  ä¸»è¦æ˜¯åœ¨ adsp_proc/ssc/sensors/wrist_tilt_updown/src/sns_wrist_tilt_updown_sensor_instance_island.c é‡Œé¢ï¼Œ æ ¹æ®è·å–åˆ°çš„ Asensor å’Œ Gsensor æ•°æ®æ¥è®¡ç®—å¤„ç† ç®—æ³•éƒ¨åˆ† æ•°æ®ç»“æ„ å®šä¹‰äº†ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œç”¨æ¥ä¿å­˜ A sensor å’Œ G sensor çš„æ•°æ® /*=========================================================================== LinkedList Definitions ===========================================================================*/ /* init */ void LinkedList_init(LinkedList *list, int capacity) { list-\u003eelements = (SensorState *)malloc(sizeof(SensorState) * capacity); list-\u003efront = 0; list-\u003erear = -1; list-\u003ecapacity = capacity; list-\u003ecount = 0; } /* destory */ void LinkedList_destroy(LinkedList *list) { free(list-\u003eelements); } /* add item to the tail */ void LinkedList_enqueue(LinkedList *list, SensorState item,sns_sensor_instance *const this) { list-\u003erear = (list-\u003erear + 1) % list-\u003ecapacity; list-\u003eelements[list-\u003erear] = item; SNS_INST_PRINTF(ERROR, this, \"wentao LinkedList_enqueue item speed = %d /1000\", (int) (1000*item.mSpeed) ); if (list-\u003ecount \u003c list-\u003ecapacity) { list-\u003ecount++; } else { list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; } } /* remove oldest item */ SensorState LinkedList_dequeue(LinkedList *list) { SensorState item = list-\u003eelements[list-\u003efront]; list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; list-\u003ecount--; return item; } typedef struct { double mSpeed; float x; float y; float z; uint64_t timestamp; } SensorState; typedef struct { SensorState *elements; int front; int rear; int capacity; int count; } LinkedList; è¿åŠ¨æ£€æµ‹ é‡‡æ ·æ•°æ® a Sensor åŠ é€Ÿåº¦ g Sensor è§’é€Ÿåº¦ è¿åŠ¨æ£€æµ‹ä¸»è¦æ ¹æ®åŠ é€Ÿåº¦æ¥è®¡ç®—ã€‚ ç›®å‰çš„è¿åŠ¨æ£€æµ‹ç®—æ³• æ ¹æ®ç»éªŒå€¼æ¥åˆ¤æ–­ï¼Œåç»­å¦‚æœæœ‰ä¼˜åŒ–æœºä¼šï¼Œè¿˜æ˜¯è€ƒè™‘é‡‡ç”¨æ›´ç§‘å­¦çš„è®¡ç®—æ–¹æ³•ã€‚ //è¿™é‡Œé¢é‡‡æ ·é¢‘ç‡å¤§æ¦‚80msä¸€æ¬¡ï¼Œé‚£ä¹ˆä¸€ä¸ª10ä¸ªå•ä½çš„é‡‡æ ·æ•°ç»„ï¼Œå¤§æ¦‚èƒ½è®°å½•åˆ°0.8ç§’å‰çš„æ•°æ®ã€‚ float deltaX = x - lastX; float deltaY = y - lastY; float deltaZ = z - lastZ; //é€šè¿‡è®¡ç®—åŠ é€Ÿåº¦å·®å€¼çš„å¼€æ–¹é™¤ä»¥é—´éš”æ—¶é—´ï¼Œä½œä¸ºå°±æ£€æµ‹è¿åŠ¨å¼ºåº¦çš„åˆ¤æ–­ä¾æ® float sqrtV","date":"2024-11-06","objectID":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/:0:0","tags":["å®æˆ˜","ç®—æ³•ç ”ç©¶","blog","sensor"],"title":"adsp wristdown æµç¨‹ä¸å®ç°","uri":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/#å‚è€ƒåˆ°çš„èµ„æ–™"},{"categories":["Android"],"collections":["WMS"],"content":"#Peppermill #ç®—æ³•ç ”ç©¶ ç›®å‰ è½è…•ç­å±ç®—æ³•å¤§è‡´åœ¨ framework å±‚å®ç°ã€‚ ç›®å‰ç®—æ³•çš„æ€è·¯ï¼š #è¿åŠ¨æ£€æµ‹ï¼Œé€šè¿‡ä¸€äº›ç‰¹å¾å€¼ï¼Œæ¥åˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªè¿åŠ¨æ®µè½ã€‚ ç¬¦åˆçš„è¿åŠ¨æ£€æµ‹åï¼Œæˆ‘ä»¬æ¥åˆ¤æ–­æ˜¯å¦æ˜¯è½è…•çš„åŠ¨ä½œã€‚ ç¬¦åˆçš„è½è…•çš„åŠ¨ä½œåï¼Œsensor ä¸ŠæŠ¥ eventã€‚ framework ç›‘å¬è·å–åè¿›è¡Œç­å±çš„åˆ¤æ–­åŠ¨ä½œã€‚ èƒŒæ™¯ä»‹ç» æ—©èµ·çš„ Android å¹³å°ï¼ŒSensor æ˜¯æ”¾åœ¨ AP ä¾§å®ç°çš„ï¼ŒSensor ç”Ÿæˆè®¾å¤‡èŠ‚ç‚¹ä¾›ä¸Šå±‚ä½¿ç”¨ï¼ŒSensor çš„å·¥ä½œ CPU å°±ä¸èƒ½å®Œå¥½çš„ä¼‘çœ ã€‚ åç»­çš„é«˜ç‰ˆæœ¬ android å„ä¸ªå¹³å°å‚å•†éƒ½æœ‰äº†ä¸åŒçš„æ–¹æ¡ˆï¼ŒSensorHubï¼ŒADSP SensorHub ä¸ªäººç†è§£å•Šï¼ŒSensorHub åº”è¯¥ç®—ä¸€ä¸ªç‹¬ç«‹çš„å­ç³»ç»Ÿï¼ŒMCUï¼Œå¯ä»¥ä¸ä¾èµ– CPU æ¶æ„ç‹¬ç«‹è¿è¡Œï¼Œå¯ä»¥è¾ƒå¤§çš„ç¨‹åº¦çœç”µã€‚ä¸»è¦åŠŸèƒ½å°±æ˜¯è¿æ¥å„ç±» sensor å¹¶ä¸”å»å¤„ç†ï¼ŒMTK é‡‡ç”¨çš„è¯¥æ–¹æ¡ˆï¼Œä½¿ç”¨çš„æ˜¯ SRAM æ¶æ„ï¼Œé€šç”µå°±å¯ä»¥ä¿å­˜æ•°æ®ï¼Œç›¸å¯¹å†…å­˜éœ€è¦ä¸åœçš„åˆ·æ–°ï¼Œé•¿æœŸè¿è¡Œå¯ä»¥èŠ‚çœç”¨ç”µã€‚ ADSP ADSP éƒ¨åˆ† ä¹‹å‰æŠŠè½è…•çš„æ£€æµ‹æ”¾åœ¨ framework é‡Œé¢å®ç°ï¼Œåœ¨äº®å±ä¹‹åï¼Œç›‘å¬ Asensor å’Œ GSensorï¼Œåšä¸ºè½è…•å…¶å®åªåœ¨äº®å±åä½¿ç”¨ï¼Œæ•´ä½“ä¸Šæ¥è¯´ï¼Œæ˜¯ä¸å½±å“è€—æµã€‚ å°†ç®—æ³•ä¸‹æ²‰åˆ° ADSPï¼Œä¸»è¦è€ƒè™‘åç»­æ–¹æ¡ˆçš„é€‚é…æ€§ï¼Œé’ˆå¯¹ä¸€äº›ä½è€—æµçš„éœ€æ±‚ï¼Œå¯ä»¥èƒ½å¤Ÿè¾ƒå¥½çš„æ»¡è¶³ã€‚ ç¼–è¯‘ è®°å½•æˆ‘ç›®å‰ç¼–è¯‘çš„ä¸€ä¸ªé—®é¢˜ï¼Œå®Œæ•´çš„ AMSS ç¼–è¯‘ OKï¼Œä½†æ˜¯å•ç‹¬ç¼–è¯‘ ADSP çš„æ—¶å€™å°±ä¼šæŠ¥é”™ RuntimeError: Cannot proceed with encryption/decryption: openssl v1.0.1 is unavailable. åº”è¯¥æ˜¯ç¼–è¯‘å‡º adsp çš„ mbn åï¼Œç­¾åæ‰¾ä¸åˆ° openssl å¯¼è‡´çš„ï¼Œå…¨ç¼–è¯‘å’Œå•ç¼–è¯‘çš„ç¯å¢ƒå˜é‡å¯èƒ½æœ‰ä¸ªç¯èŠ‚æœ‰é—®é¢˜ã€‚åæ¥æ·»åŠ äº†ç¼–è¯‘çš„ç¯å¢ƒå˜é‡æ‰èƒ½å¤Ÿæ­£å¸¸çš„ç¼–è¯‘ export PATH=/pkg/qct/software/python/2.7/bin:$PATH è™šæ‹Ÿåˆæˆ Sensor æ·»åŠ  è¿™éƒ¨åˆ†æ˜¯é©±åŠ¨åŒäº‹åšçš„ï¼Œç›®å‰æˆ‘åªæ˜¯è®°å½•ä¸‹æ¥ï¼Œå…·ä½“ä»£ç æˆ‘ä¹ŸåŒæ­¥åœ¨äº† Media\u0026File -\u003e WristDown è·¯å¾„ä¸‹é¢ ä¸»è¦ä¸€ä¸ªæ˜¯åœ¨ adsp_proc/ssc/build/ssc.scons å’Œ adsp_proc/ssc_api/build/ssc_api.scons ä¸‹æ·»åŠ  sensor diff --git a/adsp_proc/ssc/build/ssc.scons b/adsp_proc/ssc/build/ssc.scons index 8b6ab05..28f98a9 100755 (executable) --- a/adsp_proc/ssc/build/ssc.scons +++ b/adsp_proc/ssc/build/ssc.scons @@ -129,7 +129,7 @@ if env.IsKeyEnable(ssc_build_tags) is True: #------------------------------------------------------------------------------- - 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc', + 'sns_pedometer','sns_psmd','sns_rmd','sns_rotv','smd','sns_multishake','sns_threshold','sns_tilt','sns_tilt_to_wake','sdc','sns_wrist_tilt_updown', 'pah_813x_algo','pah_hr','sns_pah_hrd_algo_lib'] #------------------------------------------------------------------------------- diff --git a/adsp_proc/ssc_api/build/ssc_api.scons b/adsp_proc/ssc_api/build/ssc_api.scons index b5ca9ee..d67bc30 100755 (executable) --- a/adsp_proc/ssc_api/build/ssc_api.scons +++ b/adsp_proc/ssc_api/build/ssc_api.scons @@ -127,7 +127,8 @@ WHITELIST = [ 'sns_heart_rate.proto', 'sns_offbody_detect.proto', 'sns_ppg.proto', - 'sns_philips_vso.proto'] + 'sns_philips_vso.proto', + 'sns_wrist_tilt_updown.proto'] if 'SENSORS_ALGO_DEV_FLAG' in env: WHITELIST += [ sensor hal é‡Œé¢ä¹Ÿè¦æ·»åŠ  ç®—æ³•æ·»åŠ  ä¸»è¦æ˜¯åœ¨ adsp_proc/ssc/sensors/wrist_tilt_updown/src/sns_wrist_tilt_updown_sensor_instance_island.c é‡Œé¢ï¼Œ æ ¹æ®è·å–åˆ°çš„ Asensor å’Œ Gsensor æ•°æ®æ¥è®¡ç®—å¤„ç† ç®—æ³•éƒ¨åˆ† æ•°æ®ç»“æ„ å®šä¹‰äº†ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œç”¨æ¥ä¿å­˜ A sensor å’Œ G sensor çš„æ•°æ® /*=========================================================================== LinkedList Definitions ===========================================================================*/ /* init */ void LinkedList_init(LinkedList *list, int capacity) { list-\u003eelements = (SensorState *)malloc(sizeof(SensorState) * capacity); list-\u003efront = 0; list-\u003erear = -1; list-\u003ecapacity = capacity; list-\u003ecount = 0; } /* destory */ void LinkedList_destroy(LinkedList *list) { free(list-\u003eelements); } /* add item to the tail */ void LinkedList_enqueue(LinkedList *list, SensorState item,sns_sensor_instance *const this) { list-\u003erear = (list-\u003erear + 1) % list-\u003ecapacity; list-\u003eelements[list-\u003erear] = item; SNS_INST_PRINTF(ERROR, this, \"wentao LinkedList_enqueue item speed = %d /1000\", (int) (1000*item.mSpeed) ); if (list-\u003ecount \u003c list-\u003ecapacity) { list-\u003ecount++; } else { list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; } } /* remove oldest item */ SensorState LinkedList_dequeue(LinkedList *list) { SensorState item = list-\u003eelements[list-\u003efront]; list-\u003efront = (list-\u003efront + 1) % list-\u003ecapacity; list-\u003ecount--; return item; } typedef struct { double mSpeed; float x; float y; float z; uint64_t timestamp; } SensorState; typedef struct { SensorState *elements; int front; int rear; int capacity; int count; } LinkedList; è¿åŠ¨æ£€æµ‹ é‡‡æ ·æ•°æ® a Sensor åŠ é€Ÿåº¦ g Sensor è§’é€Ÿåº¦ è¿åŠ¨æ£€æµ‹ä¸»è¦æ ¹æ®åŠ é€Ÿåº¦æ¥è®¡ç®—ã€‚ ç›®å‰çš„è¿åŠ¨æ£€æµ‹ç®—æ³• æ ¹æ®ç»éªŒå€¼æ¥åˆ¤æ–­ï¼Œåç»­å¦‚æœæœ‰ä¼˜åŒ–æœºä¼šï¼Œè¿˜æ˜¯è€ƒè™‘é‡‡ç”¨æ›´ç§‘å­¦çš„è®¡ç®—æ–¹æ³•ã€‚ //è¿™é‡Œé¢é‡‡æ ·é¢‘ç‡å¤§æ¦‚80msä¸€æ¬¡ï¼Œé‚£ä¹ˆä¸€ä¸ª10ä¸ªå•ä½çš„é‡‡æ ·æ•°ç»„ï¼Œå¤§æ¦‚èƒ½è®°å½•åˆ°0.8ç§’å‰çš„æ•°æ®ã€‚ float deltaX = x - lastX; float deltaY = y - lastY; float deltaZ = z - lastZ; //é€šè¿‡è®¡ç®—åŠ é€Ÿåº¦å·®å€¼çš„å¼€æ–¹é™¤ä»¥é—´éš”æ—¶é—´ï¼Œä½œä¸ºå°±æ£€æµ‹è¿åŠ¨å¼ºåº¦çš„åˆ¤æ–­ä¾æ® float sqrtV","date":"2024-11-06","objectID":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/:0:0","tags":["å®æˆ˜","ç®—æ³•ç ”ç©¶","blog","sensor"],"title":"adsp wristdown æµç¨‹ä¸å®ç°","uri":"/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/#æœç´¢åˆ°çš„æ— å…³èµ„æ–™"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"å®˜æ–¹æ–‡æ¡£ï¼š https://source.android.com/docs/security/features/selinux https://source.android.com/docs/security/features/selinux/images/SELinux_Treble.pdf Your visual how-to guide for SELinux policy enforcement | Opensource.com SeLinuxï¼ˆSecurity-EnhancedÂ Linuxï¼‰æ˜¯ä¸€ä¸ªæ ‡ç­¾ç³»ç»Ÿï¼ˆlabelingÂ systemï¼‰ã€‚æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªlabelï¼ˆç§°ä¸ºprocessÂ labelï¼‰ï¼Œæ¯ä¸ªæ–‡ä»¶ç³»ç»Ÿæ‰€æ¶µç›–çš„æ–‡ä»¶/ç›®å½•ã€ç½‘ç»œç«¯å£ã€è®¾å¤‡ç­‰å¯¹è±¡ä¹Ÿæœ‰ä¸€ä¸ªlableï¼ˆç§°ä¸ºObjectÂ labelï¼‰ã€‚SeLinuxé€šè¿‡ç¼–å†™è§„åˆ™æ¥æ§åˆ¶ä¸€ä¸ªprocessÂ labelå¯¹ä¸€ä¸ªObjectÂ labelçš„è®¿é—®ï¼Œè¿™ä¸ªè§„åˆ™ç§°ä¹‹ä¸ºç­–ç•¥ï¼ˆPolicyï¼‰ã€‚SeLinuxçš„è¿™ç§å®‰å…¨æœºåˆ¶ç§°ä¸ºMandatoryÂ AccessÂ ControlÂ (MAC)ï¼Œæ˜¯åœ¨å†…æ ¸å±‚å®ç°çš„ã€‚ åœ¨æ ‡å‡†çš„Linuxä¸Šï¼Œä¹Ÿå°±æ˜¯æœªå®æ–½SeLinuxçš„Linuxä¸Šï¼Œä¼ ç»Ÿçš„è®¿é—®æ§åˆ¶æ˜¯é€šè¿‡owner/groupÂ +Â permissionÂ flagsï¼ˆæ¯”å¦‚rwxï¼‰å®ç°çš„ï¼Œç§°ä¹‹ä¸ºDiscretionaryÂ AccessÂ ControlÂ (DAC). SeLinuxå’Œä¼ ç»Ÿçš„DACä¸æ˜¯æ›¿ä»£çš„å…³ç³»ï¼Œè€Œæ˜¯å¹¶è¡Œçš„å…³ç³»ã€‚ä¸¤è€…åŒæ—¶åœ¨èµ·ä½œç”¨ã€‚ä¹‹æ‰€ä»¥å‡ºç°SeLinuxï¼Œæ˜¯å› ä¸ºä¼ ç»ŸDACçš„å®‰å…¨æœºåˆ¶è¿‡äºç²—ç²ï¼Œè€ŒSelinuxæä¾›äº†æ›´ä¸ºç»†è‡´å’Œå®‰å…¨çš„è®¿é—®æ§åˆ¶ã€‚ç®€è¨€ä¹‹ï¼Œä¼ ç»ŸDACæœºåˆ¶ä¸‹ï¼Œä¸€æ—¦ä½ è·å¾—äº†rootæƒé™ï¼Œå°†æ— æ‰€ä¸èƒ½ï¼Œä½†åœ¨SeLinuxçš„æœºåˆ¶ä¸‹ï¼Œå³ä½¿è·å¾—äº†rootæƒé™ï¼Œä¹Ÿä»ç„¶éœ€è¦éµå¾ªå·²ç»è®¾ç½®å¥½çš„è®¿é—®ç­–ç•¥ï¼Œåªæœ‰æŒ‡å®šçš„è¿›ç¨‹æ‰å¯ä»¥è®¿é—®æŒ‡å®šçš„æ–‡ä»¶ã€‚ SeLinuxæœ‰ä¸¤ç§è¿è¡Œæ¨¡å¼ï¼š PermissiveÂ modeï¼šå½“è®¿é—®å¹¶æœªæˆæƒæ—¶ï¼Œä¸ä¼šé˜»æ­¢è®¿é—®ï¼Œä½†ä¼šæ‰“å°log EnforcingÂ modeï¼šå½“è®¿é—®æœªè¢«æˆæƒæ—¶ï¼Œä¼šé˜»æ­¢è®¿é—®ï¼Œå¹¶ä¸”ä¼šæ‰“å°log logå°†å‡ºç°åœ¨dmesgå’Œlogcatã€‚ é™¤äº†å¯ä»¥å¯¹æ•´ä½“è¿›è¡Œæ¨¡å¼è®¾ç½®ï¼Œä¹Ÿå¯ä»¥é’ˆå¯¹æŸä¸ªè¿›ç¨‹å•ç‹¬è®¾ç½®æŸä¸ªæ¨¡å¼ï¼Œé™¤æ­¤ä¹‹å¤–çš„è¿›ç¨‹ä½¿ç”¨å…¨å±€æ¨¡å¼ã€‚ ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"è®¾è®¡ SeLinuxåœ¨AndroidÂ 4~7å’ŒAndroidÂ 8ä»¥åé‡‡ç”¨äº†ä¸åŒçš„è®¾è®¡ AndroidÂ 4~7ä¸Šï¼ŒSeLinuxçš„ç­–ç•¥æ˜¯ä½œä¸ºä¸€ä¸ªæ•´ä½“æ¥ç¼–è¯‘å’Œæ›´æ–°çš„ï¼› AndroidÂ 8åŠä»¥åï¼ŒSeLinuxé‡‡ç”¨äº†æ¨¡å—åŒ–ã€åŠ¨æ€åŒ–è®¾è®¡ï¼ŒPlatformï¼ˆå¯ä»¥ç†è§£ä¸ºAOSPçš„éƒ¨åˆ†ï¼‰ã€Non-Platformï¼ˆvendorã€odmã€oemçš„éƒ¨åˆ†ï¼Œè¿™é‡Œæ€»ä½“ç§°ä¸ºvendoréƒ¨åˆ†ï¼‰çš„SeLinuxç­–ç•¥åˆ†åˆ«ç‹¬ç«‹ç¼–è¯‘ã€å‡çº§ã€‚ é™„ä¸€å¼ Androidè®¾å¤‡çš„æ¶æ„å›¾ï¼š ç¼–è¯‘åä¼šç”Ÿæˆå¯¹åº”çš„imgæ–‡ä»¶ â—Â system.img.Â ContainsÂ mainlyÂ AndroidÂ framework. â—Â boot.img.Â (kernel/ramdisk)Â ContainsÂ LinuxÂ kernelÂ +Â AndroidÂ patches. â—Â vendor.img.Â ContainsÂ SoC-specificÂ codeÂ andÂ configurations. â—Â odm.img.Â ContainsÂ device-specificÂ codeÂ andÂ configurations. â—Â oem.img.Â ContainsÂ OEM/carrier-relatedÂ configurationsÂ andÂ customizations. â—Â bootloader.Â BringsÂ upÂ theÂ kernelÂ (vendor-proprietary). â—Â radio.Â ModemÂ (proprietary). AndroidÂ 8ä»¥åï¼ŒSeLinuxçš„ç­–ç•¥æ–‡ä»¶å¯ä»¥ä¼´éšç›¸åº”çš„imgç‹¬ç«‹ç¼–è¯‘æˆ–è€…OTAã€‚ ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:0:1","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#è®¾è®¡"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"2. æ¦‚å¿µ ä»€ä¹ˆæ˜¯æ ‡ç­¾ï¼ˆLabelï¼‰ï¼Ÿæ€ä¹ˆåŸºäºLabelå¯¹è®¿é—®è¿›è¡Œæ§åˆ¶ï¼Ÿ å…ˆæŠ›å¼€Labelè¿™ä¸ªæ¦‚å¿µä¸è¯´ã€‚æ‰€è°“SeLinuxé‡Œçš„è®¿é—®æ§åˆ¶ï¼Œå°±æ˜¯åˆ¤å®šä¸€ä¸ªSourceæœ‰æ²¡æœ‰æƒé™å»è®¿é—®Targetã€‚è¿™é‡Œçš„Sourceä¸€èˆ¬å°±æ˜¯è¿›ç¨‹ï¼ŒTargetæœ€é•¿è§çš„å°±æ˜¯æ–‡ä»¶ç³»ç»Ÿï¼ˆæ¯”å¦‚æ–‡ä»¶ã€ç›®å½•ã€socketã€è®¾å¤‡ç­‰ç­‰ï¼‰ï¼Œå½“ç„¶è¿˜æœ‰å…¶ä»–ç±»å‹çš„Targetã€‚æ¢å¥è¯è¯´ï¼ŒSeLinuxçš„æœºåˆ¶å°±æ˜¯é€šè¿‡è¯»å–ä¸€ä¸ªâ€œè§„åˆ™â€ï¼Œæ¥æ§åˆ¶ä¸€ä¸ªè¿›ç¨‹æœ‰æ²¡æœ‰æƒé™å»è®¿é—®ä¸€ä¸ªæ–‡ä»¶ï¼ˆæˆ–å…¶ä»–ç±»å‹ï¼‰ã€‚ ä¸Šé¢è¯´çš„â€œè§„åˆ™â€ï¼Œåœ¨SeLinuxé‡Œçš„æœ¯è¯­å«åšPolicyï¼ˆç­–ç•¥ï¼‰æˆ–å«AccessÂ VectorÂ Ruleã€‚æ˜¯å¯ä»¥ç”±AOSPå’Œå‚å•†ã€ä¾›åº”å•†æ¥ç¼–å†™çš„ã€‚ ä¸Šé¢çš„Sourceï¼Œè¿˜å«åšSubjectï¼ˆä¸»ä½“ï¼‰ ä¸Šé¢çš„Targetï¼Œè¿˜å«åšObjectï¼ˆå¯¹è±¡æˆ–å®¢ä½“ï¼‰ Labelã€Sourceã€Targetã€Subjectã€Objectï¼Œè¿™äº›éƒ½ä¸é‡è¦ï¼ŒÂ åœ¨å®é™…è¯­æ³•ä¸­å¹¶æ²¡æœ‰ç›¸å…³å…³é”®è¯ï¼Œåªè¦å„ç§èµ„æ–™é‡Œå‡ºç°è¿™äº›è¯çš„æ—¶å€™çŸ¥é“å…¶æ‰€æŒ‡å°±å¯ä»¥ã€‚ ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#2-æ¦‚å¿µ"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"2.1Â è§„åˆ™PolicyÂ Ruleï¼ˆæˆ–å«AccessÂ VectorÂ Ruleï¼‰ ç­–ç•¥è§„åˆ™çš„è¯­æ³•ä¸ºï¼š allowÂ sourceÂ target:classÂ permissions; SourceÂ -Â TheÂ typeÂ (orÂ attribute)Â ofÂ theÂ subjectÂ ofÂ theÂ rule.Â WhoÂ isÂ requestingÂ theÂ access?ï¼ˆæ˜¯è°åœ¨è¯·æ±‚è®¿é—®ä¸€ä¸ªèµ„æºï¼‰ TargetÂ -Â TheÂ typeÂ (orÂ attribute)Â ofÂ theÂ object.Â ToÂ whatÂ isÂ theÂ accessÂ requested?ï¼ˆè¢«è®¿é—®çš„å¯¹è±¡ï¼‰ ClassÂ -Â TheÂ kindÂ ofÂ objectÂ (e.g.Â file,Â socket)Â beingÂ accessed.ï¼ˆè¢«è®¿é—®è€…çš„ç±»å‹ï¼‰ PermissionsÂ -Â TheÂ operationÂ (orÂ setÂ ofÂ operations)Â (e.g.Â read,Â write)Â beingÂ performed.ï¼ˆå¯¹Targetå…·ä½“è¦åšä»€ä¹ˆæ“ä½œï¼Ÿæ¯”å¦‚å¯¹è¢«è®¿é—®è€…æ˜¯æ–‡ä»¶æ¥è¯´ï¼Œæ˜¯è¦è¯»ã€å†™å®ƒè¿˜æ˜¯å…¶ä»–æ“ä½œï¼Ÿï¼‰ å…·ä½“ä¾‹å­å¦‚ä¸‹ï¼š allowÂ sample_appÂ app_data_file:fileÂ {Â readÂ writeÂ }; è¿™ä¸ªä¾‹å­æ˜¯è¯´ï¼Œå…è®¸sample_appè¿™ä¸ªè¿›ç¨‹å»è®¿é—®app_data_fileï¼ˆå®ƒæ˜¯ä¸€ä¸ªfileç±»å‹ï¼Œä¹Ÿå°±æ˜¯æ–‡ä»¶ï¼‰ï¼Œå…è®¸çš„æ“ä½œæ˜¯readå’Œwriteã€‚ è€Œå…¶å®è¿™é‡Œçš„sample_appå¹¶ä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„å…·ä½“çš„è¿›ç¨‹åï¼Œè€Œæ˜¯åœ¨ç³»ç»Ÿç¼–è¯‘é˜¶æ®µå°±å®šä¹‰å¥½çš„ä¸€ä¸ªæ ‡ç­¾ï¼ˆLabelï¼‰ï¼Œä¸€äº›çœŸæ­£çš„è¿›ç¨‹è¢«æ˜ å°„åˆ°sample_appè¿™ä¸ªæ ‡ç­¾ä¸Šï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œä¸Šé¢è§„åˆ™çš„æ—¶å€™ï¼Œå…¶å®ç”Ÿæ•ˆçš„ã€æœ‰æƒé™è®¿é—®app_data_fileçš„æ˜¯æ‰€æœ‰æ˜ å°„äº†sample_appæ ‡ç­¾çš„é‚£äº›è¿›ç¨‹ã€‚åŒæ ·çš„ï¼Œapp_data_fileä¹Ÿä¸æ˜¯ä¸€ä¸ªå…·ä½“çš„æ–‡ä»¶åã€‚å®ƒä¹Ÿæ˜¯ä¸€ä¸ªæå‰å£°æ˜äº†çš„æ ‡ç­¾ï¼Œä¸€äº›çœŸæ­£çš„æ–‡ä»¶è¢«æ˜ å°„åˆ°è¿™ä¸ªæ ‡ç­¾ä¸Šï¼Œsample_appæœ‰æƒè®¿é—®çš„æ˜¯æ‰€æ˜ å°„çš„è¿™äº›æ–‡ä»¶ã€‚ ä»è¿™é‡Œçœ‹å‡ºæ¥ï¼Œæœ‰åˆ«äºä¼ ç»ŸDACçš„Ownerã€Groupã€Permissions çš„æ§åˆ¶æ–¹å¼ï¼Œæ‰€è°“çš„â€œåŸºäºæ ‡ç­¾ç³»ç»Ÿâ€çš„SeLinuxï¼Œå°±æ˜¯è¿™ç§é€šè¿‡å£°æ˜æ ‡ç­¾çš„æ–¹å¼æ¥è¡¨è¿°è®¿é—®è§„åˆ™çš„ã€‚ æ ‡ç­¾åªæ˜¯ä¸€ç§æ¦‚å¿µæ€§çš„ä¸œè¥¿ï¼Œå…·ä½“ä½“ç°åœ¨ç­–ç•¥æ–‡ä»¶é‡Œï¼Œåˆ™æ˜¯æŠ½è±¡æˆäº†Typeã€Attributeã€Classã€Permissionsè¿™äº›å…·ä½“å…³é”®å­—ã€‚ ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#21è§„åˆ™policyruleæˆ–å«accessvectorrule"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"2.2Â è§„åˆ™é‡Œçš„å…³é”®å­—è¯´æ˜ ä»¥ä¸‹é¢è¿™ä¸ªè§„åˆ™ä¸¾ä¾‹ allowÂ sample_appÂ app_data_file:fileÂ {Â readÂ writeÂ }; RuleÂ Name ä¸Šé¢è§„åˆ™ç¤ºä¾‹ä¸­ï¼Œallowå°±æ˜¯RuleÂ Nameçš„ä¸€ç§ã€‚SeLinuxæœ‰å¤šç§RuleNameï¼š allowï¼šè¡¨ç¤ºå…è®¸Sourceå¯¹Targetæ‰§è¡Œè®¸å¯çš„æ“ä½œ neverallowï¼šè¡¨ç¤ºä¸å…è®¸Sourceå¯¹Targetæ‰§è¡Œåˆ¶å®šçš„æ“ä½œ auditallowï¼šè¡¨ç¤ºå…è®¸æ“ä½œå¹¶è®°å½•è®¿é—®å†³ç­–ä¿¡æ¯ dontauditï¼šè¡¨ç¤ºä¸è®°å½•è¿åè§„åˆ™çš„å†³ç­–ä¿¡æ¯ï¼Œåˆ‡è¿åè§„åˆ™ä¸å½±å“è¿è¡Œã€‚ å…¶ä¸­allowæ˜¯ç”¨çš„æœ€å¤šçš„ã€‚ Type ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œsample_appã€app_data_fileéƒ½æ˜¯ä¸€ä¸ªTypeã€‚ç®€å•ç†è§£å°±æ˜¯å°†ä¸€ä¸ªæˆ–å‡ ä¸ªè¿›ç¨‹å£°æ˜ä¸ºTypeÂ Aï¼ŒÂ å°†ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶å£°æ˜ä¸ºTypeÂ Bã€‚é‚£ä¹ˆåœ¨æ§åˆ¶è¿™ä¸ªè¿›ç¨‹æœ‰æ²¡æœ‰æƒé™è®¿é—®è¿™ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œåªç”¨Aå’ŒBæ¥è¡¨ç¤ºå°±å¯ä»¥äº†ã€‚ è¿™æ ·åšæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿâ€œä¸€ç±»è¿›ç¨‹â€æ€»æ¯”å…·ä½“çš„â€œä¸€ä¸ªè¿›ç¨‹â€è¦çµæ´»çš„å¤šã€‚æŠŠå¤šä¸ªè¿›ç¨‹å£°æ˜ä¸ºåŒä¸€ä¸ªTypeï¼Œé‚£ä¹ˆåœ¨å†™è§„åˆ™çš„æ—¶å€™åªè¦æè¿°è¿™ä¸ªTypeï¼Œé‚£ä¹ˆè¿™ä¸ªTypeå¯¹åº”çš„æ‰€æœ‰è¿›ç¨‹éƒ½ä¼šç”Ÿæ•ˆã€‚æ–‡ä»¶æˆ–å…¶ä»–å¯¹è±¡ä¹Ÿæ˜¯åŒæ ·çš„ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è§„åˆ™ä¸­æè¿°Sourceèƒ½ä¸èƒ½è®¿é—®Targetï¼Œæ˜¯é€šè¿‡Typeæ¥è¡¨è¿°çš„ã€‚ Typeæ˜¯å‚å•†æˆ–ä¾›åº”å•†å¯ä»¥è‡ªå®šä¹‰çš„ Attribute å°†å¤šä¸ªTypeå½’ä¸ºä¸€ç»„ï¼Œå°±æ˜¯ä¸€ä¸ªAttributeã€‚ é€šä¿—çš„è¯´ï¼ŒæŠŠä¸€äº›è¿›ç¨‹å£°æ˜ä¸ºTypeï¼Œä½†æ˜¯å¤šä¸ªTypeæœ‰æŸç§å…±é€šçš„ç‰¹æ€§ï¼Œå°±å¯ä»¥æŠŠè¿™äº›Typeå£°æ˜ä¸ºåŒä¸€ä¸ªAttributeã€‚åœ¨æè¿°è§„åˆ™çš„æ—¶å€™ï¼Œå¯ä»¥å°†Sourceæˆ–è€…TargetæŒ‡å®šä¸ºä¸€ä¸ªAttributeè€Œä¸æ˜¯Typeï¼Œè¿™æ ·æ‰€æœ‰å±äºè¿™ä¸ªAttributeçš„Typeéƒ½ç”Ÿæ•ˆã€‚ AOSPæœ¬èº«å†…ç½®äº†ä¸€äº›Attributeï¼Œè€Œè¿™äº›Attributeå¾ˆå¤šéƒ½æ˜¯çº¦å®šä¿—ç§°çš„å›ºå®šå«ä¹‰ã€‚æ¯”å¦‚ï¼š domain æ‰€æœ‰è¿›ç¨‹çš„typeå¿…é¡»å½’å±äºdomainã€‚domainå› æ­¤æˆäº†è¿›ç¨‹typeçš„å¸¸è§è¡¨è¿°ã€‚ file_type æ‰€æœ‰æ–‡ä»¶typeéƒ½å½’å±äºfile_type â€¦ AOSPå†…ç½®çš„Attributeè§ platform/system/sepolicy/public/attributes platform/system/sepolicy/private/attributes platform/system/sepolicy/prebuilts/api/[version]/public/attributes platform/system/sepolicy/prebuilts/api/[version]/private/attributes Class ä¸Šé¢ç¤ºä¾‹ä¸­ï¼Œâ€œ:fileâ€å°±æ˜¯ä¸€ä¸ªClassã€‚ç®€å•è¯´å°±æ˜¯å°†æŸäº›è¢«è®¿é—®å¯¹è±¡å½’ä¸ºä¸€ç§Classï¼Œæ¯”å¦‚è¯´è¢«è®¿é—®çš„æ˜¯æ–‡ä»¶ï¼ŒClassä¸€èˆ¬å°±æ˜¯fileï¼Œå¦‚æœæ˜¯ç›®å½•ï¼ŒClasså°±æ˜¯dirï¼Œå¦‚æœæ˜¯socketï¼ŒClasså°±æ˜¯socketç­‰ç­‰ã€‚Classæ˜¯AOSPå†…å®šä¹‰å¥½çš„ï¼Œä¸€èˆ¬ä¸éœ€è¦è‡ªå®šä¹‰ å…·ä½“æœ‰é‚£äº›Classï¼Œå¯è§æºç platform/system/sepolicy/private/security_classes Classæ˜¯ç”¨æ¥åšä»€ä¹ˆçš„ï¼Ÿå…¶å®æ˜¯ä¸Permissionsç›¸å…³çš„ã€‚ Permissions å³ç¤ºä¾‹ä¸­çš„Â {Â readÂ writeÂ }ã€‚è¡¨ç¤ºå…·ä½“å¯ä»¥åšä»€ä¹ˆæ“ä½œã€‚ä¸åŒçš„Classæœ‰ä¸åŒçš„Permissionsé›†åˆã€‚ç½—åˆ—ä¸€äº›Classå¯¹åº”çš„Permissionï¼ˆéå®Œæ•´ï¼‰ï¼š Class Permission file ioctlÂ readÂ writeÂ createÂ getattrÂ setattrÂ lockÂ relabelfromÂ relabeltoÂ appendÂ unlinkÂ linkÂ renameÂ executeÂ swaponÂ quotaonÂ mounton directory add_nameÂ remove_nameÂ reparentÂ searchÂ rmdirÂ openÂ audit_accessÂ execmod socket ioctlÂ readÂ writeÂ createÂ getattrÂ setattrÂ lockÂ relabelfromÂ relabeltoÂ appendÂ bindÂ connectÂ listenÂ acceptÂ getoptÂ setoptÂ shutdownÂ recvfromÂ sendtoÂ recv_msgÂ send_msgÂ name_bind filesystem mountÂ remountÂ unmountÂ getattrÂ relabelfromÂ relabeltoÂ transitionÂ associateÂ quotamodÂ quotaget process forkÂ transitionÂ sigchldÂ sigkillÂ sigstopÂ signullÂ signalÂ ptraceÂ getschedÂ setschedÂ getsessionÂ getpgidÂ setpgidÂ getcapÂ setcapÂ shareÂ getattrÂ setexecÂ setfscreateÂ noatsecureÂ siginhÂ setrlimitÂ rlimitinhÂ dyntransitionÂ setcurrentÂ execmemÂ execstackÂ execheapÂ setkeycreateÂ setsockcreate security compute_avÂ compute_createÂ compute_memberÂ check_contextÂ load_policyÂ compute_relabelÂ compute_userÂ setenforceÂ setboolÂ setsecparamÂ setcheckreqprotÂ read_policy capability chownÂ dac_overrideÂ dac_read_searchÂ fownerÂ fsetidÂ killÂ setgidÂ setuidÂ setpcapÂ linux_immutableÂ net_bind_serviceÂ net_broadcastÂ net_adminÂ net_rawÂ ipc_lockÂ ipc_ownerÂ sys_moduleÂ sys_rawioÂ sys_chrootÂ sys_ptraceÂ sys_pacctÂ sys_adminÂ sys_bootÂ sys_niceÂ sys_resourceÂ sys_timeÂ sys_tty_configÂ mknodÂ leaseÂ audit_writeÂ audit_controlÂ setfcap MORE ANDÂ MORE å¯ä»¥ä»å¯¹åº”çš„Classä¸­é€‰å–ä»»æ„ä¸ªPermission Classä¸Perimssionçš„å®Œæ•´æ˜ å°„å…·ä½“è§æºç ï¼škernel/arm64/security/selinux/include/classmap.h ç¤ºä¾‹ ä»¥æ§åˆ¶ç‹—æ˜¯å¦æœ‰æƒåƒçŒ«ç²®ç‹—ç²®ä¸ºä¾‹ã€‚ æœ‰ä¸€ä¸ªç‹—å«å°é»„ï¼ŒÂ ä¸€ç§ç‹—ç²®å«â€œç‹—ç²®Aâ€ã€‚ ç°åœ¨å£°æ˜ä¸€ä¸ªTypeå«dogï¼Œä¸€ä¸ªTypeå«dog_chowï¼Œç³»ç»Ÿæœ¬èº«å†…ç½®äº†Classå«foodï¼Œfoodå¯¹åº”çš„permissionsé‡ŒåŒ…å«äº†eatè¿™ä¸ªæƒé™ã€‚ éšåå°†å°é»„æ˜ å°„åˆ°dogè¿™ä¸ªtypeï¼Œå°†ç‹—ç²®Aæ˜ å°„åˆ°dog_chowè¿™ä¸ªtype è¿™æ ·ï¼Œåœ¨æ·»åŠ äº†è¿™æ ·ä¸€æ¡è§„åˆ™åï¼Œå°é»„å°±æœ‰æƒé™å»åƒç‹—ç²®Aäº†ï¼š allowÂ dogÂ dog_chow:foodÂ eat; æ­¤æ—¶å¦‚æœè¿˜æœ‰ä¸€åªç‹—å°ç™½ï¼Œé‚£ä¹ˆå¯ä»¥å°†å°ç™½æ˜ å°„åˆ°dogè¿™ä¸ªtypeï¼Œè¿™æ ·å°ç™½ä¹Ÿå¯ä»¥æœ‰æƒé™åƒç‹—ç²®Aã€‚ ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:1:2","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#22è§„åˆ™é‡Œçš„å…³é”®å­—è¯´æ˜"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"2.2Â è§„åˆ™é‡Œçš„å…³é”®å­—è¯´æ˜ ä»¥ä¸‹é¢è¿™ä¸ªè§„åˆ™ä¸¾ä¾‹ allowÂ sample_appÂ app_data_file:fileÂ {Â readÂ writeÂ }; RuleÂ Name ä¸Šé¢è§„åˆ™ç¤ºä¾‹ä¸­ï¼Œallowå°±æ˜¯RuleÂ Nameçš„ä¸€ç§ã€‚SeLinuxæœ‰å¤šç§RuleNameï¼š allowï¼šè¡¨ç¤ºå…è®¸Sourceå¯¹Targetæ‰§è¡Œè®¸å¯çš„æ“ä½œ neverallowï¼šè¡¨ç¤ºä¸å…è®¸Sourceå¯¹Targetæ‰§è¡Œåˆ¶å®šçš„æ“ä½œ auditallowï¼šè¡¨ç¤ºå…è®¸æ“ä½œå¹¶è®°å½•è®¿é—®å†³ç­–ä¿¡æ¯ dontauditï¼šè¡¨ç¤ºä¸è®°å½•è¿åè§„åˆ™çš„å†³ç­–ä¿¡æ¯ï¼Œåˆ‡è¿åè§„åˆ™ä¸å½±å“è¿è¡Œã€‚ å…¶ä¸­allowæ˜¯ç”¨çš„æœ€å¤šçš„ã€‚ Type ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œsample_appã€app_data_fileéƒ½æ˜¯ä¸€ä¸ªTypeã€‚ç®€å•ç†è§£å°±æ˜¯å°†ä¸€ä¸ªæˆ–å‡ ä¸ªè¿›ç¨‹å£°æ˜ä¸ºTypeÂ Aï¼ŒÂ å°†ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶å£°æ˜ä¸ºTypeÂ Bã€‚é‚£ä¹ˆåœ¨æ§åˆ¶è¿™ä¸ªè¿›ç¨‹æœ‰æ²¡æœ‰æƒé™è®¿é—®è¿™ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œåªç”¨Aå’ŒBæ¥è¡¨ç¤ºå°±å¯ä»¥äº†ã€‚ è¿™æ ·åšæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿâ€œä¸€ç±»è¿›ç¨‹â€æ€»æ¯”å…·ä½“çš„â€œä¸€ä¸ªè¿›ç¨‹â€è¦çµæ´»çš„å¤šã€‚æŠŠå¤šä¸ªè¿›ç¨‹å£°æ˜ä¸ºåŒä¸€ä¸ªTypeï¼Œé‚£ä¹ˆåœ¨å†™è§„åˆ™çš„æ—¶å€™åªè¦æè¿°è¿™ä¸ªTypeï¼Œé‚£ä¹ˆè¿™ä¸ªTypeå¯¹åº”çš„æ‰€æœ‰è¿›ç¨‹éƒ½ä¼šç”Ÿæ•ˆã€‚æ–‡ä»¶æˆ–å…¶ä»–å¯¹è±¡ä¹Ÿæ˜¯åŒæ ·çš„ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è§„åˆ™ä¸­æè¿°Sourceèƒ½ä¸èƒ½è®¿é—®Targetï¼Œæ˜¯é€šè¿‡Typeæ¥è¡¨è¿°çš„ã€‚ Typeæ˜¯å‚å•†æˆ–ä¾›åº”å•†å¯ä»¥è‡ªå®šä¹‰çš„ Attribute å°†å¤šä¸ªTypeå½’ä¸ºä¸€ç»„ï¼Œå°±æ˜¯ä¸€ä¸ªAttributeã€‚ é€šä¿—çš„è¯´ï¼ŒæŠŠä¸€äº›è¿›ç¨‹å£°æ˜ä¸ºTypeï¼Œä½†æ˜¯å¤šä¸ªTypeæœ‰æŸç§å…±é€šçš„ç‰¹æ€§ï¼Œå°±å¯ä»¥æŠŠè¿™äº›Typeå£°æ˜ä¸ºåŒä¸€ä¸ªAttributeã€‚åœ¨æè¿°è§„åˆ™çš„æ—¶å€™ï¼Œå¯ä»¥å°†Sourceæˆ–è€…TargetæŒ‡å®šä¸ºä¸€ä¸ªAttributeè€Œä¸æ˜¯Typeï¼Œè¿™æ ·æ‰€æœ‰å±äºè¿™ä¸ªAttributeçš„Typeéƒ½ç”Ÿæ•ˆã€‚ AOSPæœ¬èº«å†…ç½®äº†ä¸€äº›Attributeï¼Œè€Œè¿™äº›Attributeå¾ˆå¤šéƒ½æ˜¯çº¦å®šä¿—ç§°çš„å›ºå®šå«ä¹‰ã€‚æ¯”å¦‚ï¼š domain æ‰€æœ‰è¿›ç¨‹çš„typeå¿…é¡»å½’å±äºdomainã€‚domainå› æ­¤æˆäº†è¿›ç¨‹typeçš„å¸¸è§è¡¨è¿°ã€‚ file_type æ‰€æœ‰æ–‡ä»¶typeéƒ½å½’å±äºfile_type â€¦ AOSPå†…ç½®çš„Attributeè§ platform/system/sepolicy/public/attributes platform/system/sepolicy/private/attributes platform/system/sepolicy/prebuilts/api/[version]/public/attributes platform/system/sepolicy/prebuilts/api/[version]/private/attributes Class ä¸Šé¢ç¤ºä¾‹ä¸­ï¼Œâ€œ:fileâ€å°±æ˜¯ä¸€ä¸ªClassã€‚ç®€å•è¯´å°±æ˜¯å°†æŸäº›è¢«è®¿é—®å¯¹è±¡å½’ä¸ºä¸€ç§Classï¼Œæ¯”å¦‚è¯´è¢«è®¿é—®çš„æ˜¯æ–‡ä»¶ï¼ŒClassä¸€èˆ¬å°±æ˜¯fileï¼Œå¦‚æœæ˜¯ç›®å½•ï¼ŒClasså°±æ˜¯dirï¼Œå¦‚æœæ˜¯socketï¼ŒClasså°±æ˜¯socketç­‰ç­‰ã€‚Classæ˜¯AOSPå†…å®šä¹‰å¥½çš„ï¼Œä¸€èˆ¬ä¸éœ€è¦è‡ªå®šä¹‰ å…·ä½“æœ‰é‚£äº›Classï¼Œå¯è§æºç platform/system/sepolicy/private/security_classes Classæ˜¯ç”¨æ¥åšä»€ä¹ˆçš„ï¼Ÿå…¶å®æ˜¯ä¸Permissionsç›¸å…³çš„ã€‚ Permissions å³ç¤ºä¾‹ä¸­çš„Â {Â readÂ writeÂ }ã€‚è¡¨ç¤ºå…·ä½“å¯ä»¥åšä»€ä¹ˆæ“ä½œã€‚ä¸åŒçš„Classæœ‰ä¸åŒçš„Permissionsé›†åˆã€‚ç½—åˆ—ä¸€äº›Classå¯¹åº”çš„Permissionï¼ˆéå®Œæ•´ï¼‰ï¼š Class Permission file ioctlÂ readÂ writeÂ createÂ getattrÂ setattrÂ lockÂ relabelfromÂ relabeltoÂ appendÂ unlinkÂ linkÂ renameÂ executeÂ swaponÂ quotaonÂ mounton directory add_nameÂ remove_nameÂ reparentÂ searchÂ rmdirÂ openÂ audit_accessÂ execmod socket ioctlÂ readÂ writeÂ createÂ getattrÂ setattrÂ lockÂ relabelfromÂ relabeltoÂ appendÂ bindÂ connectÂ listenÂ acceptÂ getoptÂ setoptÂ shutdownÂ recvfromÂ sendtoÂ recv_msgÂ send_msgÂ name_bind filesystem mountÂ remountÂ unmountÂ getattrÂ relabelfromÂ relabeltoÂ transitionÂ associateÂ quotamodÂ quotaget process forkÂ transitionÂ sigchldÂ sigkillÂ sigstopÂ signullÂ signalÂ ptraceÂ getschedÂ setschedÂ getsessionÂ getpgidÂ setpgidÂ getcapÂ setcapÂ shareÂ getattrÂ setexecÂ setfscreateÂ noatsecureÂ siginhÂ setrlimitÂ rlimitinhÂ dyntransitionÂ setcurrentÂ execmemÂ execstackÂ execheapÂ setkeycreateÂ setsockcreate security compute_avÂ compute_createÂ compute_memberÂ check_contextÂ load_policyÂ compute_relabelÂ compute_userÂ setenforceÂ setboolÂ setsecparamÂ setcheckreqprotÂ read_policy capability chownÂ dac_overrideÂ dac_read_searchÂ fownerÂ fsetidÂ killÂ setgidÂ setuidÂ setpcapÂ linux_immutableÂ net_bind_serviceÂ net_broadcastÂ net_adminÂ net_rawÂ ipc_lockÂ ipc_ownerÂ sys_moduleÂ sys_rawioÂ sys_chrootÂ sys_ptraceÂ sys_pacctÂ sys_adminÂ sys_bootÂ sys_niceÂ sys_resourceÂ sys_timeÂ sys_tty_configÂ mknodÂ leaseÂ audit_writeÂ audit_controlÂ setfcap MORE ANDÂ MORE å¯ä»¥ä»å¯¹åº”çš„Classä¸­é€‰å–ä»»æ„ä¸ªPermission Classä¸Perimssionçš„å®Œæ•´æ˜ å°„å…·ä½“è§æºç ï¼škernel/arm64/security/selinux/include/classmap.h ç¤ºä¾‹ ä»¥æ§åˆ¶ç‹—æ˜¯å¦æœ‰æƒåƒçŒ«ç²®ç‹—ç²®ä¸ºä¾‹ã€‚ æœ‰ä¸€ä¸ªç‹—å«å°é»„ï¼ŒÂ ä¸€ç§ç‹—ç²®å«â€œç‹—ç²®Aâ€ã€‚ ç°åœ¨å£°æ˜ä¸€ä¸ªTypeå«dogï¼Œä¸€ä¸ªTypeå«dog_chowï¼Œç³»ç»Ÿæœ¬èº«å†…ç½®äº†Classå«foodï¼Œfoodå¯¹åº”çš„permissionsé‡ŒåŒ…å«äº†eatè¿™ä¸ªæƒé™ã€‚ éšåå°†å°é»„æ˜ å°„åˆ°dogè¿™ä¸ªtypeï¼Œå°†ç‹—ç²®Aæ˜ å°„åˆ°dog_chowè¿™ä¸ªtype è¿™æ ·ï¼Œåœ¨æ·»åŠ äº†è¿™æ ·ä¸€æ¡è§„åˆ™åï¼Œå°é»„å°±æœ‰æƒé™å»åƒç‹—ç²®Aäº†ï¼š allowÂ dogÂ dog_chow:foodÂ eat; æ­¤æ—¶å¦‚æœè¿˜æœ‰ä¸€åªç‹—å°ç™½ï¼Œé‚£ä¹ˆå¯ä»¥å°†å°ç™½æ˜ å°„åˆ°dogè¿™ä¸ªtypeï¼Œè¿™æ ·å°ç™½ä¹Ÿå¯ä»¥æœ‰æƒé™åƒç‹—ç²®Aã€‚ ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:1:2","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#rulename"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"2.2Â è§„åˆ™é‡Œçš„å…³é”®å­—è¯´æ˜ ä»¥ä¸‹é¢è¿™ä¸ªè§„åˆ™ä¸¾ä¾‹ allowÂ sample_appÂ app_data_file:fileÂ {Â readÂ writeÂ }; RuleÂ Name ä¸Šé¢è§„åˆ™ç¤ºä¾‹ä¸­ï¼Œallowå°±æ˜¯RuleÂ Nameçš„ä¸€ç§ã€‚SeLinuxæœ‰å¤šç§RuleNameï¼š allowï¼šè¡¨ç¤ºå…è®¸Sourceå¯¹Targetæ‰§è¡Œè®¸å¯çš„æ“ä½œ neverallowï¼šè¡¨ç¤ºä¸å…è®¸Sourceå¯¹Targetæ‰§è¡Œåˆ¶å®šçš„æ“ä½œ auditallowï¼šè¡¨ç¤ºå…è®¸æ“ä½œå¹¶è®°å½•è®¿é—®å†³ç­–ä¿¡æ¯ dontauditï¼šè¡¨ç¤ºä¸è®°å½•è¿åè§„åˆ™çš„å†³ç­–ä¿¡æ¯ï¼Œåˆ‡è¿åè§„åˆ™ä¸å½±å“è¿è¡Œã€‚ å…¶ä¸­allowæ˜¯ç”¨çš„æœ€å¤šçš„ã€‚ Type ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œsample_appã€app_data_fileéƒ½æ˜¯ä¸€ä¸ªTypeã€‚ç®€å•ç†è§£å°±æ˜¯å°†ä¸€ä¸ªæˆ–å‡ ä¸ªè¿›ç¨‹å£°æ˜ä¸ºTypeÂ Aï¼ŒÂ å°†ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶å£°æ˜ä¸ºTypeÂ Bã€‚é‚£ä¹ˆåœ¨æ§åˆ¶è¿™ä¸ªè¿›ç¨‹æœ‰æ²¡æœ‰æƒé™è®¿é—®è¿™ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œåªç”¨Aå’ŒBæ¥è¡¨ç¤ºå°±å¯ä»¥äº†ã€‚ è¿™æ ·åšæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿâ€œä¸€ç±»è¿›ç¨‹â€æ€»æ¯”å…·ä½“çš„â€œä¸€ä¸ªè¿›ç¨‹â€è¦çµæ´»çš„å¤šã€‚æŠŠå¤šä¸ªè¿›ç¨‹å£°æ˜ä¸ºåŒä¸€ä¸ªTypeï¼Œé‚£ä¹ˆåœ¨å†™è§„åˆ™çš„æ—¶å€™åªè¦æè¿°è¿™ä¸ªTypeï¼Œé‚£ä¹ˆè¿™ä¸ªTypeå¯¹åº”çš„æ‰€æœ‰è¿›ç¨‹éƒ½ä¼šç”Ÿæ•ˆã€‚æ–‡ä»¶æˆ–å…¶ä»–å¯¹è±¡ä¹Ÿæ˜¯åŒæ ·çš„ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è§„åˆ™ä¸­æè¿°Sourceèƒ½ä¸èƒ½è®¿é—®Targetï¼Œæ˜¯é€šè¿‡Typeæ¥è¡¨è¿°çš„ã€‚ Typeæ˜¯å‚å•†æˆ–ä¾›åº”å•†å¯ä»¥è‡ªå®šä¹‰çš„ Attribute å°†å¤šä¸ªTypeå½’ä¸ºä¸€ç»„ï¼Œå°±æ˜¯ä¸€ä¸ªAttributeã€‚ é€šä¿—çš„è¯´ï¼ŒæŠŠä¸€äº›è¿›ç¨‹å£°æ˜ä¸ºTypeï¼Œä½†æ˜¯å¤šä¸ªTypeæœ‰æŸç§å…±é€šçš„ç‰¹æ€§ï¼Œå°±å¯ä»¥æŠŠè¿™äº›Typeå£°æ˜ä¸ºåŒä¸€ä¸ªAttributeã€‚åœ¨æè¿°è§„åˆ™çš„æ—¶å€™ï¼Œå¯ä»¥å°†Sourceæˆ–è€…TargetæŒ‡å®šä¸ºä¸€ä¸ªAttributeè€Œä¸æ˜¯Typeï¼Œè¿™æ ·æ‰€æœ‰å±äºè¿™ä¸ªAttributeçš„Typeéƒ½ç”Ÿæ•ˆã€‚ AOSPæœ¬èº«å†…ç½®äº†ä¸€äº›Attributeï¼Œè€Œè¿™äº›Attributeå¾ˆå¤šéƒ½æ˜¯çº¦å®šä¿—ç§°çš„å›ºå®šå«ä¹‰ã€‚æ¯”å¦‚ï¼š domain æ‰€æœ‰è¿›ç¨‹çš„typeå¿…é¡»å½’å±äºdomainã€‚domainå› æ­¤æˆäº†è¿›ç¨‹typeçš„å¸¸è§è¡¨è¿°ã€‚ file_type æ‰€æœ‰æ–‡ä»¶typeéƒ½å½’å±äºfile_type â€¦ AOSPå†…ç½®çš„Attributeè§ platform/system/sepolicy/public/attributes platform/system/sepolicy/private/attributes platform/system/sepolicy/prebuilts/api/[version]/public/attributes platform/system/sepolicy/prebuilts/api/[version]/private/attributes Class ä¸Šé¢ç¤ºä¾‹ä¸­ï¼Œâ€œ:fileâ€å°±æ˜¯ä¸€ä¸ªClassã€‚ç®€å•è¯´å°±æ˜¯å°†æŸäº›è¢«è®¿é—®å¯¹è±¡å½’ä¸ºä¸€ç§Classï¼Œæ¯”å¦‚è¯´è¢«è®¿é—®çš„æ˜¯æ–‡ä»¶ï¼ŒClassä¸€èˆ¬å°±æ˜¯fileï¼Œå¦‚æœæ˜¯ç›®å½•ï¼ŒClasså°±æ˜¯dirï¼Œå¦‚æœæ˜¯socketï¼ŒClasså°±æ˜¯socketç­‰ç­‰ã€‚Classæ˜¯AOSPå†…å®šä¹‰å¥½çš„ï¼Œä¸€èˆ¬ä¸éœ€è¦è‡ªå®šä¹‰ å…·ä½“æœ‰é‚£äº›Classï¼Œå¯è§æºç platform/system/sepolicy/private/security_classes Classæ˜¯ç”¨æ¥åšä»€ä¹ˆçš„ï¼Ÿå…¶å®æ˜¯ä¸Permissionsç›¸å…³çš„ã€‚ Permissions å³ç¤ºä¾‹ä¸­çš„Â {Â readÂ writeÂ }ã€‚è¡¨ç¤ºå…·ä½“å¯ä»¥åšä»€ä¹ˆæ“ä½œã€‚ä¸åŒçš„Classæœ‰ä¸åŒçš„Permissionsé›†åˆã€‚ç½—åˆ—ä¸€äº›Classå¯¹åº”çš„Permissionï¼ˆéå®Œæ•´ï¼‰ï¼š Class Permission file ioctlÂ readÂ writeÂ createÂ getattrÂ setattrÂ lockÂ relabelfromÂ relabeltoÂ appendÂ unlinkÂ linkÂ renameÂ executeÂ swaponÂ quotaonÂ mounton directory add_nameÂ remove_nameÂ reparentÂ searchÂ rmdirÂ openÂ audit_accessÂ execmod socket ioctlÂ readÂ writeÂ createÂ getattrÂ setattrÂ lockÂ relabelfromÂ relabeltoÂ appendÂ bindÂ connectÂ listenÂ acceptÂ getoptÂ setoptÂ shutdownÂ recvfromÂ sendtoÂ recv_msgÂ send_msgÂ name_bind filesystem mountÂ remountÂ unmountÂ getattrÂ relabelfromÂ relabeltoÂ transitionÂ associateÂ quotamodÂ quotaget process forkÂ transitionÂ sigchldÂ sigkillÂ sigstopÂ signullÂ signalÂ ptraceÂ getschedÂ setschedÂ getsessionÂ getpgidÂ setpgidÂ getcapÂ setcapÂ shareÂ getattrÂ setexecÂ setfscreateÂ noatsecureÂ siginhÂ setrlimitÂ rlimitinhÂ dyntransitionÂ setcurrentÂ execmemÂ execstackÂ execheapÂ setkeycreateÂ setsockcreate security compute_avÂ compute_createÂ compute_memberÂ check_contextÂ load_policyÂ compute_relabelÂ compute_userÂ setenforceÂ setboolÂ setsecparamÂ setcheckreqprotÂ read_policy capability chownÂ dac_overrideÂ dac_read_searchÂ fownerÂ fsetidÂ killÂ setgidÂ setuidÂ setpcapÂ linux_immutableÂ net_bind_serviceÂ net_broadcastÂ net_adminÂ net_rawÂ ipc_lockÂ ipc_ownerÂ sys_moduleÂ sys_rawioÂ sys_chrootÂ sys_ptraceÂ sys_pacctÂ sys_adminÂ sys_bootÂ sys_niceÂ sys_resourceÂ sys_timeÂ sys_tty_configÂ mknodÂ leaseÂ audit_writeÂ audit_controlÂ setfcap MORE ANDÂ MORE å¯ä»¥ä»å¯¹åº”çš„Classä¸­é€‰å–ä»»æ„ä¸ªPermission Classä¸Perimssionçš„å®Œæ•´æ˜ å°„å…·ä½“è§æºç ï¼škernel/arm64/security/selinux/include/classmap.h ç¤ºä¾‹ ä»¥æ§åˆ¶ç‹—æ˜¯å¦æœ‰æƒåƒçŒ«ç²®ç‹—ç²®ä¸ºä¾‹ã€‚ æœ‰ä¸€ä¸ªç‹—å«å°é»„ï¼ŒÂ ä¸€ç§ç‹—ç²®å«â€œç‹—ç²®Aâ€ã€‚ ç°åœ¨å£°æ˜ä¸€ä¸ªTypeå«dogï¼Œä¸€ä¸ªTypeå«dog_chowï¼Œç³»ç»Ÿæœ¬èº«å†…ç½®äº†Classå«foodï¼Œfoodå¯¹åº”çš„permissionsé‡ŒåŒ…å«äº†eatè¿™ä¸ªæƒé™ã€‚ éšåå°†å°é»„æ˜ å°„åˆ°dogè¿™ä¸ªtypeï¼Œå°†ç‹—ç²®Aæ˜ å°„åˆ°dog_chowè¿™ä¸ªtype è¿™æ ·ï¼Œåœ¨æ·»åŠ äº†è¿™æ ·ä¸€æ¡è§„åˆ™åï¼Œå°é»„å°±æœ‰æƒé™å»åƒç‹—ç²®Aäº†ï¼š allowÂ dogÂ dog_chow:foodÂ eat; æ­¤æ—¶å¦‚æœè¿˜æœ‰ä¸€åªç‹—å°ç™½ï¼Œé‚£ä¹ˆå¯ä»¥å°†å°ç™½æ˜ å°„åˆ°dogè¿™ä¸ªtypeï¼Œè¿™æ ·å°ç™½ä¹Ÿå¯ä»¥æœ‰æƒé™åƒç‹—ç²®Aã€‚ ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:1:2","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#type"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"2.2Â è§„åˆ™é‡Œçš„å…³é”®å­—è¯´æ˜ ä»¥ä¸‹é¢è¿™ä¸ªè§„åˆ™ä¸¾ä¾‹ allowÂ sample_appÂ app_data_file:fileÂ {Â readÂ writeÂ }; RuleÂ Name ä¸Šé¢è§„åˆ™ç¤ºä¾‹ä¸­ï¼Œallowå°±æ˜¯RuleÂ Nameçš„ä¸€ç§ã€‚SeLinuxæœ‰å¤šç§RuleNameï¼š allowï¼šè¡¨ç¤ºå…è®¸Sourceå¯¹Targetæ‰§è¡Œè®¸å¯çš„æ“ä½œ neverallowï¼šè¡¨ç¤ºä¸å…è®¸Sourceå¯¹Targetæ‰§è¡Œåˆ¶å®šçš„æ“ä½œ auditallowï¼šè¡¨ç¤ºå…è®¸æ“ä½œå¹¶è®°å½•è®¿é—®å†³ç­–ä¿¡æ¯ dontauditï¼šè¡¨ç¤ºä¸è®°å½•è¿åè§„åˆ™çš„å†³ç­–ä¿¡æ¯ï¼Œåˆ‡è¿åè§„åˆ™ä¸å½±å“è¿è¡Œã€‚ å…¶ä¸­allowæ˜¯ç”¨çš„æœ€å¤šçš„ã€‚ Type ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œsample_appã€app_data_fileéƒ½æ˜¯ä¸€ä¸ªTypeã€‚ç®€å•ç†è§£å°±æ˜¯å°†ä¸€ä¸ªæˆ–å‡ ä¸ªè¿›ç¨‹å£°æ˜ä¸ºTypeÂ Aï¼ŒÂ å°†ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶å£°æ˜ä¸ºTypeÂ Bã€‚é‚£ä¹ˆåœ¨æ§åˆ¶è¿™ä¸ªè¿›ç¨‹æœ‰æ²¡æœ‰æƒé™è®¿é—®è¿™ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œåªç”¨Aå’ŒBæ¥è¡¨ç¤ºå°±å¯ä»¥äº†ã€‚ è¿™æ ·åšæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿâ€œä¸€ç±»è¿›ç¨‹â€æ€»æ¯”å…·ä½“çš„â€œä¸€ä¸ªè¿›ç¨‹â€è¦çµæ´»çš„å¤šã€‚æŠŠå¤šä¸ªè¿›ç¨‹å£°æ˜ä¸ºåŒä¸€ä¸ªTypeï¼Œé‚£ä¹ˆåœ¨å†™è§„åˆ™çš„æ—¶å€™åªè¦æè¿°è¿™ä¸ªTypeï¼Œé‚£ä¹ˆè¿™ä¸ªTypeå¯¹åº”çš„æ‰€æœ‰è¿›ç¨‹éƒ½ä¼šç”Ÿæ•ˆã€‚æ–‡ä»¶æˆ–å…¶ä»–å¯¹è±¡ä¹Ÿæ˜¯åŒæ ·çš„ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è§„åˆ™ä¸­æè¿°Sourceèƒ½ä¸èƒ½è®¿é—®Targetï¼Œæ˜¯é€šè¿‡Typeæ¥è¡¨è¿°çš„ã€‚ Typeæ˜¯å‚å•†æˆ–ä¾›åº”å•†å¯ä»¥è‡ªå®šä¹‰çš„ Attribute å°†å¤šä¸ªTypeå½’ä¸ºä¸€ç»„ï¼Œå°±æ˜¯ä¸€ä¸ªAttributeã€‚ é€šä¿—çš„è¯´ï¼ŒæŠŠä¸€äº›è¿›ç¨‹å£°æ˜ä¸ºTypeï¼Œä½†æ˜¯å¤šä¸ªTypeæœ‰æŸç§å…±é€šçš„ç‰¹æ€§ï¼Œå°±å¯ä»¥æŠŠè¿™äº›Typeå£°æ˜ä¸ºåŒä¸€ä¸ªAttributeã€‚åœ¨æè¿°è§„åˆ™çš„æ—¶å€™ï¼Œå¯ä»¥å°†Sourceæˆ–è€…TargetæŒ‡å®šä¸ºä¸€ä¸ªAttributeè€Œä¸æ˜¯Typeï¼Œè¿™æ ·æ‰€æœ‰å±äºè¿™ä¸ªAttributeçš„Typeéƒ½ç”Ÿæ•ˆã€‚ AOSPæœ¬èº«å†…ç½®äº†ä¸€äº›Attributeï¼Œè€Œè¿™äº›Attributeå¾ˆå¤šéƒ½æ˜¯çº¦å®šä¿—ç§°çš„å›ºå®šå«ä¹‰ã€‚æ¯”å¦‚ï¼š domain æ‰€æœ‰è¿›ç¨‹çš„typeå¿…é¡»å½’å±äºdomainã€‚domainå› æ­¤æˆäº†è¿›ç¨‹typeçš„å¸¸è§è¡¨è¿°ã€‚ file_type æ‰€æœ‰æ–‡ä»¶typeéƒ½å½’å±äºfile_type â€¦ AOSPå†…ç½®çš„Attributeè§ platform/system/sepolicy/public/attributes platform/system/sepolicy/private/attributes platform/system/sepolicy/prebuilts/api/[version]/public/attributes platform/system/sepolicy/prebuilts/api/[version]/private/attributes Class ä¸Šé¢ç¤ºä¾‹ä¸­ï¼Œâ€œ:fileâ€å°±æ˜¯ä¸€ä¸ªClassã€‚ç®€å•è¯´å°±æ˜¯å°†æŸäº›è¢«è®¿é—®å¯¹è±¡å½’ä¸ºä¸€ç§Classï¼Œæ¯”å¦‚è¯´è¢«è®¿é—®çš„æ˜¯æ–‡ä»¶ï¼ŒClassä¸€èˆ¬å°±æ˜¯fileï¼Œå¦‚æœæ˜¯ç›®å½•ï¼ŒClasså°±æ˜¯dirï¼Œå¦‚æœæ˜¯socketï¼ŒClasså°±æ˜¯socketç­‰ç­‰ã€‚Classæ˜¯AOSPå†…å®šä¹‰å¥½çš„ï¼Œä¸€èˆ¬ä¸éœ€è¦è‡ªå®šä¹‰ å…·ä½“æœ‰é‚£äº›Classï¼Œå¯è§æºç platform/system/sepolicy/private/security_classes Classæ˜¯ç”¨æ¥åšä»€ä¹ˆçš„ï¼Ÿå…¶å®æ˜¯ä¸Permissionsç›¸å…³çš„ã€‚ Permissions å³ç¤ºä¾‹ä¸­çš„Â {Â readÂ writeÂ }ã€‚è¡¨ç¤ºå…·ä½“å¯ä»¥åšä»€ä¹ˆæ“ä½œã€‚ä¸åŒçš„Classæœ‰ä¸åŒçš„Permissionsé›†åˆã€‚ç½—åˆ—ä¸€äº›Classå¯¹åº”çš„Permissionï¼ˆéå®Œæ•´ï¼‰ï¼š Class Permission file ioctlÂ readÂ writeÂ createÂ getattrÂ setattrÂ lockÂ relabelfromÂ relabeltoÂ appendÂ unlinkÂ linkÂ renameÂ executeÂ swaponÂ quotaonÂ mounton directory add_nameÂ remove_nameÂ reparentÂ searchÂ rmdirÂ openÂ audit_accessÂ execmod socket ioctlÂ readÂ writeÂ createÂ getattrÂ setattrÂ lockÂ relabelfromÂ relabeltoÂ appendÂ bindÂ connectÂ listenÂ acceptÂ getoptÂ setoptÂ shutdownÂ recvfromÂ sendtoÂ recv_msgÂ send_msgÂ name_bind filesystem mountÂ remountÂ unmountÂ getattrÂ relabelfromÂ relabeltoÂ transitionÂ associateÂ quotamodÂ quotaget process forkÂ transitionÂ sigchldÂ sigkillÂ sigstopÂ signullÂ signalÂ ptraceÂ getschedÂ setschedÂ getsessionÂ getpgidÂ setpgidÂ getcapÂ setcapÂ shareÂ getattrÂ setexecÂ setfscreateÂ noatsecureÂ siginhÂ setrlimitÂ rlimitinhÂ dyntransitionÂ setcurrentÂ execmemÂ execstackÂ execheapÂ setkeycreateÂ setsockcreate security compute_avÂ compute_createÂ compute_memberÂ check_contextÂ load_policyÂ compute_relabelÂ compute_userÂ setenforceÂ setboolÂ setsecparamÂ setcheckreqprotÂ read_policy capability chownÂ dac_overrideÂ dac_read_searchÂ fownerÂ fsetidÂ killÂ setgidÂ setuidÂ setpcapÂ linux_immutableÂ net_bind_serviceÂ net_broadcastÂ net_adminÂ net_rawÂ ipc_lockÂ ipc_ownerÂ sys_moduleÂ sys_rawioÂ sys_chrootÂ sys_ptraceÂ sys_pacctÂ sys_adminÂ sys_bootÂ sys_niceÂ sys_resourceÂ sys_timeÂ sys_tty_configÂ mknodÂ leaseÂ audit_writeÂ audit_controlÂ setfcap MORE ANDÂ MORE å¯ä»¥ä»å¯¹åº”çš„Classä¸­é€‰å–ä»»æ„ä¸ªPermission Classä¸Perimssionçš„å®Œæ•´æ˜ å°„å…·ä½“è§æºç ï¼škernel/arm64/security/selinux/include/classmap.h ç¤ºä¾‹ ä»¥æ§åˆ¶ç‹—æ˜¯å¦æœ‰æƒåƒçŒ«ç²®ç‹—ç²®ä¸ºä¾‹ã€‚ æœ‰ä¸€ä¸ªç‹—å«å°é»„ï¼ŒÂ ä¸€ç§ç‹—ç²®å«â€œç‹—ç²®Aâ€ã€‚ ç°åœ¨å£°æ˜ä¸€ä¸ªTypeå«dogï¼Œä¸€ä¸ªTypeå«dog_chowï¼Œç³»ç»Ÿæœ¬èº«å†…ç½®äº†Classå«foodï¼Œfoodå¯¹åº”çš„permissionsé‡ŒåŒ…å«äº†eatè¿™ä¸ªæƒé™ã€‚ éšåå°†å°é»„æ˜ å°„åˆ°dogè¿™ä¸ªtypeï¼Œå°†ç‹—ç²®Aæ˜ å°„åˆ°dog_chowè¿™ä¸ªtype è¿™æ ·ï¼Œåœ¨æ·»åŠ äº†è¿™æ ·ä¸€æ¡è§„åˆ™åï¼Œå°é»„å°±æœ‰æƒé™å»åƒç‹—ç²®Aäº†ï¼š allowÂ dogÂ dog_chow:foodÂ eat; æ­¤æ—¶å¦‚æœè¿˜æœ‰ä¸€åªç‹—å°ç™½ï¼Œé‚£ä¹ˆå¯ä»¥å°†å°ç™½æ˜ å°„åˆ°dogè¿™ä¸ªtypeï¼Œè¿™æ ·å°ç™½ä¹Ÿå¯ä»¥æœ‰æƒé™åƒç‹—ç²®Aã€‚ ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:1:2","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#attribute"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"2.2Â è§„åˆ™é‡Œçš„å…³é”®å­—è¯´æ˜ ä»¥ä¸‹é¢è¿™ä¸ªè§„åˆ™ä¸¾ä¾‹ allowÂ sample_appÂ app_data_file:fileÂ {Â readÂ writeÂ }; RuleÂ Name ä¸Šé¢è§„åˆ™ç¤ºä¾‹ä¸­ï¼Œallowå°±æ˜¯RuleÂ Nameçš„ä¸€ç§ã€‚SeLinuxæœ‰å¤šç§RuleNameï¼š allowï¼šè¡¨ç¤ºå…è®¸Sourceå¯¹Targetæ‰§è¡Œè®¸å¯çš„æ“ä½œ neverallowï¼šè¡¨ç¤ºä¸å…è®¸Sourceå¯¹Targetæ‰§è¡Œåˆ¶å®šçš„æ“ä½œ auditallowï¼šè¡¨ç¤ºå…è®¸æ“ä½œå¹¶è®°å½•è®¿é—®å†³ç­–ä¿¡æ¯ dontauditï¼šè¡¨ç¤ºä¸è®°å½•è¿åè§„åˆ™çš„å†³ç­–ä¿¡æ¯ï¼Œåˆ‡è¿åè§„åˆ™ä¸å½±å“è¿è¡Œã€‚ å…¶ä¸­allowæ˜¯ç”¨çš„æœ€å¤šçš„ã€‚ Type ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œsample_appã€app_data_fileéƒ½æ˜¯ä¸€ä¸ªTypeã€‚ç®€å•ç†è§£å°±æ˜¯å°†ä¸€ä¸ªæˆ–å‡ ä¸ªè¿›ç¨‹å£°æ˜ä¸ºTypeÂ Aï¼ŒÂ å°†ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶å£°æ˜ä¸ºTypeÂ Bã€‚é‚£ä¹ˆåœ¨æ§åˆ¶è¿™ä¸ªè¿›ç¨‹æœ‰æ²¡æœ‰æƒé™è®¿é—®è¿™ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œåªç”¨Aå’ŒBæ¥è¡¨ç¤ºå°±å¯ä»¥äº†ã€‚ è¿™æ ·åšæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿâ€œä¸€ç±»è¿›ç¨‹â€æ€»æ¯”å…·ä½“çš„â€œä¸€ä¸ªè¿›ç¨‹â€è¦çµæ´»çš„å¤šã€‚æŠŠå¤šä¸ªè¿›ç¨‹å£°æ˜ä¸ºåŒä¸€ä¸ªTypeï¼Œé‚£ä¹ˆåœ¨å†™è§„åˆ™çš„æ—¶å€™åªè¦æè¿°è¿™ä¸ªTypeï¼Œé‚£ä¹ˆè¿™ä¸ªTypeå¯¹åº”çš„æ‰€æœ‰è¿›ç¨‹éƒ½ä¼šç”Ÿæ•ˆã€‚æ–‡ä»¶æˆ–å…¶ä»–å¯¹è±¡ä¹Ÿæ˜¯åŒæ ·çš„ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è§„åˆ™ä¸­æè¿°Sourceèƒ½ä¸èƒ½è®¿é—®Targetï¼Œæ˜¯é€šè¿‡Typeæ¥è¡¨è¿°çš„ã€‚ Typeæ˜¯å‚å•†æˆ–ä¾›åº”å•†å¯ä»¥è‡ªå®šä¹‰çš„ Attribute å°†å¤šä¸ªTypeå½’ä¸ºä¸€ç»„ï¼Œå°±æ˜¯ä¸€ä¸ªAttributeã€‚ é€šä¿—çš„è¯´ï¼ŒæŠŠä¸€äº›è¿›ç¨‹å£°æ˜ä¸ºTypeï¼Œä½†æ˜¯å¤šä¸ªTypeæœ‰æŸç§å…±é€šçš„ç‰¹æ€§ï¼Œå°±å¯ä»¥æŠŠè¿™äº›Typeå£°æ˜ä¸ºåŒä¸€ä¸ªAttributeã€‚åœ¨æè¿°è§„åˆ™çš„æ—¶å€™ï¼Œå¯ä»¥å°†Sourceæˆ–è€…TargetæŒ‡å®šä¸ºä¸€ä¸ªAttributeè€Œä¸æ˜¯Typeï¼Œè¿™æ ·æ‰€æœ‰å±äºè¿™ä¸ªAttributeçš„Typeéƒ½ç”Ÿæ•ˆã€‚ AOSPæœ¬èº«å†…ç½®äº†ä¸€äº›Attributeï¼Œè€Œè¿™äº›Attributeå¾ˆå¤šéƒ½æ˜¯çº¦å®šä¿—ç§°çš„å›ºå®šå«ä¹‰ã€‚æ¯”å¦‚ï¼š domain æ‰€æœ‰è¿›ç¨‹çš„typeå¿…é¡»å½’å±äºdomainã€‚domainå› æ­¤æˆäº†è¿›ç¨‹typeçš„å¸¸è§è¡¨è¿°ã€‚ file_type æ‰€æœ‰æ–‡ä»¶typeéƒ½å½’å±äºfile_type â€¦ AOSPå†…ç½®çš„Attributeè§ platform/system/sepolicy/public/attributes platform/system/sepolicy/private/attributes platform/system/sepolicy/prebuilts/api/[version]/public/attributes platform/system/sepolicy/prebuilts/api/[version]/private/attributes Class ä¸Šé¢ç¤ºä¾‹ä¸­ï¼Œâ€œ:fileâ€å°±æ˜¯ä¸€ä¸ªClassã€‚ç®€å•è¯´å°±æ˜¯å°†æŸäº›è¢«è®¿é—®å¯¹è±¡å½’ä¸ºä¸€ç§Classï¼Œæ¯”å¦‚è¯´è¢«è®¿é—®çš„æ˜¯æ–‡ä»¶ï¼ŒClassä¸€èˆ¬å°±æ˜¯fileï¼Œå¦‚æœæ˜¯ç›®å½•ï¼ŒClasså°±æ˜¯dirï¼Œå¦‚æœæ˜¯socketï¼ŒClasså°±æ˜¯socketç­‰ç­‰ã€‚Classæ˜¯AOSPå†…å®šä¹‰å¥½çš„ï¼Œä¸€èˆ¬ä¸éœ€è¦è‡ªå®šä¹‰ å…·ä½“æœ‰é‚£äº›Classï¼Œå¯è§æºç platform/system/sepolicy/private/security_classes Classæ˜¯ç”¨æ¥åšä»€ä¹ˆçš„ï¼Ÿå…¶å®æ˜¯ä¸Permissionsç›¸å…³çš„ã€‚ Permissions å³ç¤ºä¾‹ä¸­çš„Â {Â readÂ writeÂ }ã€‚è¡¨ç¤ºå…·ä½“å¯ä»¥åšä»€ä¹ˆæ“ä½œã€‚ä¸åŒçš„Classæœ‰ä¸åŒçš„Permissionsé›†åˆã€‚ç½—åˆ—ä¸€äº›Classå¯¹åº”çš„Permissionï¼ˆéå®Œæ•´ï¼‰ï¼š Class Permission file ioctlÂ readÂ writeÂ createÂ getattrÂ setattrÂ lockÂ relabelfromÂ relabeltoÂ appendÂ unlinkÂ linkÂ renameÂ executeÂ swaponÂ quotaonÂ mounton directory add_nameÂ remove_nameÂ reparentÂ searchÂ rmdirÂ openÂ audit_accessÂ execmod socket ioctlÂ readÂ writeÂ createÂ getattrÂ setattrÂ lockÂ relabelfromÂ relabeltoÂ appendÂ bindÂ connectÂ listenÂ acceptÂ getoptÂ setoptÂ shutdownÂ recvfromÂ sendtoÂ recv_msgÂ send_msgÂ name_bind filesystem mountÂ remountÂ unmountÂ getattrÂ relabelfromÂ relabeltoÂ transitionÂ associateÂ quotamodÂ quotaget process forkÂ transitionÂ sigchldÂ sigkillÂ sigstopÂ signullÂ signalÂ ptraceÂ getschedÂ setschedÂ getsessionÂ getpgidÂ setpgidÂ getcapÂ setcapÂ shareÂ getattrÂ setexecÂ setfscreateÂ noatsecureÂ siginhÂ setrlimitÂ rlimitinhÂ dyntransitionÂ setcurrentÂ execmemÂ execstackÂ execheapÂ setkeycreateÂ setsockcreate security compute_avÂ compute_createÂ compute_memberÂ check_contextÂ load_policyÂ compute_relabelÂ compute_userÂ setenforceÂ setboolÂ setsecparamÂ setcheckreqprotÂ read_policy capability chownÂ dac_overrideÂ dac_read_searchÂ fownerÂ fsetidÂ killÂ setgidÂ setuidÂ setpcapÂ linux_immutableÂ net_bind_serviceÂ net_broadcastÂ net_adminÂ net_rawÂ ipc_lockÂ ipc_ownerÂ sys_moduleÂ sys_rawioÂ sys_chrootÂ sys_ptraceÂ sys_pacctÂ sys_adminÂ sys_bootÂ sys_niceÂ sys_resourceÂ sys_timeÂ sys_tty_configÂ mknodÂ leaseÂ audit_writeÂ audit_controlÂ setfcap MORE ANDÂ MORE å¯ä»¥ä»å¯¹åº”çš„Classä¸­é€‰å–ä»»æ„ä¸ªPermission Classä¸Perimssionçš„å®Œæ•´æ˜ å°„å…·ä½“è§æºç ï¼škernel/arm64/security/selinux/include/classmap.h ç¤ºä¾‹ ä»¥æ§åˆ¶ç‹—æ˜¯å¦æœ‰æƒåƒçŒ«ç²®ç‹—ç²®ä¸ºä¾‹ã€‚ æœ‰ä¸€ä¸ªç‹—å«å°é»„ï¼ŒÂ ä¸€ç§ç‹—ç²®å«â€œç‹—ç²®Aâ€ã€‚ ç°åœ¨å£°æ˜ä¸€ä¸ªTypeå«dogï¼Œä¸€ä¸ªTypeå«dog_chowï¼Œç³»ç»Ÿæœ¬èº«å†…ç½®äº†Classå«foodï¼Œfoodå¯¹åº”çš„permissionsé‡ŒåŒ…å«äº†eatè¿™ä¸ªæƒé™ã€‚ éšåå°†å°é»„æ˜ å°„åˆ°dogè¿™ä¸ªtypeï¼Œå°†ç‹—ç²®Aæ˜ å°„åˆ°dog_chowè¿™ä¸ªtype è¿™æ ·ï¼Œåœ¨æ·»åŠ äº†è¿™æ ·ä¸€æ¡è§„åˆ™åï¼Œå°é»„å°±æœ‰æƒé™å»åƒç‹—ç²®Aäº†ï¼š allowÂ dogÂ dog_chow:foodÂ eat; æ­¤æ—¶å¦‚æœè¿˜æœ‰ä¸€åªç‹—å°ç™½ï¼Œé‚£ä¹ˆå¯ä»¥å°†å°ç™½æ˜ å°„åˆ°dogè¿™ä¸ªtypeï¼Œè¿™æ ·å°ç™½ä¹Ÿå¯ä»¥æœ‰æƒé™åƒç‹—ç²®Aã€‚ ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:1:2","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#domain"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"2.2Â è§„åˆ™é‡Œçš„å…³é”®å­—è¯´æ˜ ä»¥ä¸‹é¢è¿™ä¸ªè§„åˆ™ä¸¾ä¾‹ allowÂ sample_appÂ app_data_file:fileÂ {Â readÂ writeÂ }; RuleÂ Name ä¸Šé¢è§„åˆ™ç¤ºä¾‹ä¸­ï¼Œallowå°±æ˜¯RuleÂ Nameçš„ä¸€ç§ã€‚SeLinuxæœ‰å¤šç§RuleNameï¼š allowï¼šè¡¨ç¤ºå…è®¸Sourceå¯¹Targetæ‰§è¡Œè®¸å¯çš„æ“ä½œ neverallowï¼šè¡¨ç¤ºä¸å…è®¸Sourceå¯¹Targetæ‰§è¡Œåˆ¶å®šçš„æ“ä½œ auditallowï¼šè¡¨ç¤ºå…è®¸æ“ä½œå¹¶è®°å½•è®¿é—®å†³ç­–ä¿¡æ¯ dontauditï¼šè¡¨ç¤ºä¸è®°å½•è¿åè§„åˆ™çš„å†³ç­–ä¿¡æ¯ï¼Œåˆ‡è¿åè§„åˆ™ä¸å½±å“è¿è¡Œã€‚ å…¶ä¸­allowæ˜¯ç”¨çš„æœ€å¤šçš„ã€‚ Type ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œsample_appã€app_data_fileéƒ½æ˜¯ä¸€ä¸ªTypeã€‚ç®€å•ç†è§£å°±æ˜¯å°†ä¸€ä¸ªæˆ–å‡ ä¸ªè¿›ç¨‹å£°æ˜ä¸ºTypeÂ Aï¼ŒÂ å°†ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶å£°æ˜ä¸ºTypeÂ Bã€‚é‚£ä¹ˆåœ¨æ§åˆ¶è¿™ä¸ªè¿›ç¨‹æœ‰æ²¡æœ‰æƒé™è®¿é—®è¿™ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œåªç”¨Aå’ŒBæ¥è¡¨ç¤ºå°±å¯ä»¥äº†ã€‚ è¿™æ ·åšæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿâ€œä¸€ç±»è¿›ç¨‹â€æ€»æ¯”å…·ä½“çš„â€œä¸€ä¸ªè¿›ç¨‹â€è¦çµæ´»çš„å¤šã€‚æŠŠå¤šä¸ªè¿›ç¨‹å£°æ˜ä¸ºåŒä¸€ä¸ªTypeï¼Œé‚£ä¹ˆåœ¨å†™è§„åˆ™çš„æ—¶å€™åªè¦æè¿°è¿™ä¸ªTypeï¼Œé‚£ä¹ˆè¿™ä¸ªTypeå¯¹åº”çš„æ‰€æœ‰è¿›ç¨‹éƒ½ä¼šç”Ÿæ•ˆã€‚æ–‡ä»¶æˆ–å…¶ä»–å¯¹è±¡ä¹Ÿæ˜¯åŒæ ·çš„ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è§„åˆ™ä¸­æè¿°Sourceèƒ½ä¸èƒ½è®¿é—®Targetï¼Œæ˜¯é€šè¿‡Typeæ¥è¡¨è¿°çš„ã€‚ Typeæ˜¯å‚å•†æˆ–ä¾›åº”å•†å¯ä»¥è‡ªå®šä¹‰çš„ Attribute å°†å¤šä¸ªTypeå½’ä¸ºä¸€ç»„ï¼Œå°±æ˜¯ä¸€ä¸ªAttributeã€‚ é€šä¿—çš„è¯´ï¼ŒæŠŠä¸€äº›è¿›ç¨‹å£°æ˜ä¸ºTypeï¼Œä½†æ˜¯å¤šä¸ªTypeæœ‰æŸç§å…±é€šçš„ç‰¹æ€§ï¼Œå°±å¯ä»¥æŠŠè¿™äº›Typeå£°æ˜ä¸ºåŒä¸€ä¸ªAttributeã€‚åœ¨æè¿°è§„åˆ™çš„æ—¶å€™ï¼Œå¯ä»¥å°†Sourceæˆ–è€…TargetæŒ‡å®šä¸ºä¸€ä¸ªAttributeè€Œä¸æ˜¯Typeï¼Œè¿™æ ·æ‰€æœ‰å±äºè¿™ä¸ªAttributeçš„Typeéƒ½ç”Ÿæ•ˆã€‚ AOSPæœ¬èº«å†…ç½®äº†ä¸€äº›Attributeï¼Œè€Œè¿™äº›Attributeå¾ˆå¤šéƒ½æ˜¯çº¦å®šä¿—ç§°çš„å›ºå®šå«ä¹‰ã€‚æ¯”å¦‚ï¼š domain æ‰€æœ‰è¿›ç¨‹çš„typeå¿…é¡»å½’å±äºdomainã€‚domainå› æ­¤æˆäº†è¿›ç¨‹typeçš„å¸¸è§è¡¨è¿°ã€‚ file_type æ‰€æœ‰æ–‡ä»¶typeéƒ½å½’å±äºfile_type â€¦ AOSPå†…ç½®çš„Attributeè§ platform/system/sepolicy/public/attributes platform/system/sepolicy/private/attributes platform/system/sepolicy/prebuilts/api/[version]/public/attributes platform/system/sepolicy/prebuilts/api/[version]/private/attributes Class ä¸Šé¢ç¤ºä¾‹ä¸­ï¼Œâ€œ:fileâ€å°±æ˜¯ä¸€ä¸ªClassã€‚ç®€å•è¯´å°±æ˜¯å°†æŸäº›è¢«è®¿é—®å¯¹è±¡å½’ä¸ºä¸€ç§Classï¼Œæ¯”å¦‚è¯´è¢«è®¿é—®çš„æ˜¯æ–‡ä»¶ï¼ŒClassä¸€èˆ¬å°±æ˜¯fileï¼Œå¦‚æœæ˜¯ç›®å½•ï¼ŒClasså°±æ˜¯dirï¼Œå¦‚æœæ˜¯socketï¼ŒClasså°±æ˜¯socketç­‰ç­‰ã€‚Classæ˜¯AOSPå†…å®šä¹‰å¥½çš„ï¼Œä¸€èˆ¬ä¸éœ€è¦è‡ªå®šä¹‰ å…·ä½“æœ‰é‚£äº›Classï¼Œå¯è§æºç platform/system/sepolicy/private/security_classes Classæ˜¯ç”¨æ¥åšä»€ä¹ˆçš„ï¼Ÿå…¶å®æ˜¯ä¸Permissionsç›¸å…³çš„ã€‚ Permissions å³ç¤ºä¾‹ä¸­çš„Â {Â readÂ writeÂ }ã€‚è¡¨ç¤ºå…·ä½“å¯ä»¥åšä»€ä¹ˆæ“ä½œã€‚ä¸åŒçš„Classæœ‰ä¸åŒçš„Permissionsé›†åˆã€‚ç½—åˆ—ä¸€äº›Classå¯¹åº”çš„Permissionï¼ˆéå®Œæ•´ï¼‰ï¼š Class Permission file ioctlÂ readÂ writeÂ createÂ getattrÂ setattrÂ lockÂ relabelfromÂ relabeltoÂ appendÂ unlinkÂ linkÂ renameÂ executeÂ swaponÂ quotaonÂ mounton directory add_nameÂ remove_nameÂ reparentÂ searchÂ rmdirÂ openÂ audit_accessÂ execmod socket ioctlÂ readÂ writeÂ createÂ getattrÂ setattrÂ lockÂ relabelfromÂ relabeltoÂ appendÂ bindÂ connectÂ listenÂ acceptÂ getoptÂ setoptÂ shutdownÂ recvfromÂ sendtoÂ recv_msgÂ send_msgÂ name_bind filesystem mountÂ remountÂ unmountÂ getattrÂ relabelfromÂ relabeltoÂ transitionÂ associateÂ quotamodÂ quotaget process forkÂ transitionÂ sigchldÂ sigkillÂ sigstopÂ signullÂ signalÂ ptraceÂ getschedÂ setschedÂ getsessionÂ getpgidÂ setpgidÂ getcapÂ setcapÂ shareÂ getattrÂ setexecÂ setfscreateÂ noatsecureÂ siginhÂ setrlimitÂ rlimitinhÂ dyntransitionÂ setcurrentÂ execmemÂ execstackÂ execheapÂ setkeycreateÂ setsockcreate security compute_avÂ compute_createÂ compute_memberÂ check_contextÂ load_policyÂ compute_relabelÂ compute_userÂ setenforceÂ setboolÂ setsecparamÂ setcheckreqprotÂ read_policy capability chownÂ dac_overrideÂ dac_read_searchÂ fownerÂ fsetidÂ killÂ setgidÂ setuidÂ setpcapÂ linux_immutableÂ net_bind_serviceÂ net_broadcastÂ net_adminÂ net_rawÂ ipc_lockÂ ipc_ownerÂ sys_moduleÂ sys_rawioÂ sys_chrootÂ sys_ptraceÂ sys_pacctÂ sys_adminÂ sys_bootÂ sys_niceÂ sys_resourceÂ sys_timeÂ sys_tty_configÂ mknodÂ leaseÂ audit_writeÂ audit_controlÂ setfcap MORE ANDÂ MORE å¯ä»¥ä»å¯¹åº”çš„Classä¸­é€‰å–ä»»æ„ä¸ªPermission Classä¸Perimssionçš„å®Œæ•´æ˜ å°„å…·ä½“è§æºç ï¼škernel/arm64/security/selinux/include/classmap.h ç¤ºä¾‹ ä»¥æ§åˆ¶ç‹—æ˜¯å¦æœ‰æƒåƒçŒ«ç²®ç‹—ç²®ä¸ºä¾‹ã€‚ æœ‰ä¸€ä¸ªç‹—å«å°é»„ï¼ŒÂ ä¸€ç§ç‹—ç²®å«â€œç‹—ç²®Aâ€ã€‚ ç°åœ¨å£°æ˜ä¸€ä¸ªTypeå«dogï¼Œä¸€ä¸ªTypeå«dog_chowï¼Œç³»ç»Ÿæœ¬èº«å†…ç½®äº†Classå«foodï¼Œfoodå¯¹åº”çš„permissionsé‡ŒåŒ…å«äº†eatè¿™ä¸ªæƒé™ã€‚ éšåå°†å°é»„æ˜ å°„åˆ°dogè¿™ä¸ªtypeï¼Œå°†ç‹—ç²®Aæ˜ å°„åˆ°dog_chowè¿™ä¸ªtype è¿™æ ·ï¼Œåœ¨æ·»åŠ äº†è¿™æ ·ä¸€æ¡è§„åˆ™åï¼Œå°é»„å°±æœ‰æƒé™å»åƒç‹—ç²®Aäº†ï¼š allowÂ dogÂ dog_chow:foodÂ eat; æ­¤æ—¶å¦‚æœè¿˜æœ‰ä¸€åªç‹—å°ç™½ï¼Œé‚£ä¹ˆå¯ä»¥å°†å°ç™½æ˜ å°„åˆ°dogè¿™ä¸ªtypeï¼Œè¿™æ ·å°ç™½ä¹Ÿå¯ä»¥æœ‰æƒé™åƒç‹—ç²®Aã€‚ ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:1:2","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#file_type"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"2.2Â è§„åˆ™é‡Œçš„å…³é”®å­—è¯´æ˜ ä»¥ä¸‹é¢è¿™ä¸ªè§„åˆ™ä¸¾ä¾‹ allowÂ sample_appÂ app_data_file:fileÂ {Â readÂ writeÂ }; RuleÂ Name ä¸Šé¢è§„åˆ™ç¤ºä¾‹ä¸­ï¼Œallowå°±æ˜¯RuleÂ Nameçš„ä¸€ç§ã€‚SeLinuxæœ‰å¤šç§RuleNameï¼š allowï¼šè¡¨ç¤ºå…è®¸Sourceå¯¹Targetæ‰§è¡Œè®¸å¯çš„æ“ä½œ neverallowï¼šè¡¨ç¤ºä¸å…è®¸Sourceå¯¹Targetæ‰§è¡Œåˆ¶å®šçš„æ“ä½œ auditallowï¼šè¡¨ç¤ºå…è®¸æ“ä½œå¹¶è®°å½•è®¿é—®å†³ç­–ä¿¡æ¯ dontauditï¼šè¡¨ç¤ºä¸è®°å½•è¿åè§„åˆ™çš„å†³ç­–ä¿¡æ¯ï¼Œåˆ‡è¿åè§„åˆ™ä¸å½±å“è¿è¡Œã€‚ å…¶ä¸­allowæ˜¯ç”¨çš„æœ€å¤šçš„ã€‚ Type ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œsample_appã€app_data_fileéƒ½æ˜¯ä¸€ä¸ªTypeã€‚ç®€å•ç†è§£å°±æ˜¯å°†ä¸€ä¸ªæˆ–å‡ ä¸ªè¿›ç¨‹å£°æ˜ä¸ºTypeÂ Aï¼ŒÂ å°†ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶å£°æ˜ä¸ºTypeÂ Bã€‚é‚£ä¹ˆåœ¨æ§åˆ¶è¿™ä¸ªè¿›ç¨‹æœ‰æ²¡æœ‰æƒé™è®¿é—®è¿™ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œåªç”¨Aå’ŒBæ¥è¡¨ç¤ºå°±å¯ä»¥äº†ã€‚ è¿™æ ·åšæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿâ€œä¸€ç±»è¿›ç¨‹â€æ€»æ¯”å…·ä½“çš„â€œä¸€ä¸ªè¿›ç¨‹â€è¦çµæ´»çš„å¤šã€‚æŠŠå¤šä¸ªè¿›ç¨‹å£°æ˜ä¸ºåŒä¸€ä¸ªTypeï¼Œé‚£ä¹ˆåœ¨å†™è§„åˆ™çš„æ—¶å€™åªè¦æè¿°è¿™ä¸ªTypeï¼Œé‚£ä¹ˆè¿™ä¸ªTypeå¯¹åº”çš„æ‰€æœ‰è¿›ç¨‹éƒ½ä¼šç”Ÿæ•ˆã€‚æ–‡ä»¶æˆ–å…¶ä»–å¯¹è±¡ä¹Ÿæ˜¯åŒæ ·çš„ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è§„åˆ™ä¸­æè¿°Sourceèƒ½ä¸èƒ½è®¿é—®Targetï¼Œæ˜¯é€šè¿‡Typeæ¥è¡¨è¿°çš„ã€‚ Typeæ˜¯å‚å•†æˆ–ä¾›åº”å•†å¯ä»¥è‡ªå®šä¹‰çš„ Attribute å°†å¤šä¸ªTypeå½’ä¸ºä¸€ç»„ï¼Œå°±æ˜¯ä¸€ä¸ªAttributeã€‚ é€šä¿—çš„è¯´ï¼ŒæŠŠä¸€äº›è¿›ç¨‹å£°æ˜ä¸ºTypeï¼Œä½†æ˜¯å¤šä¸ªTypeæœ‰æŸç§å…±é€šçš„ç‰¹æ€§ï¼Œå°±å¯ä»¥æŠŠè¿™äº›Typeå£°æ˜ä¸ºåŒä¸€ä¸ªAttributeã€‚åœ¨æè¿°è§„åˆ™çš„æ—¶å€™ï¼Œå¯ä»¥å°†Sourceæˆ–è€…TargetæŒ‡å®šä¸ºä¸€ä¸ªAttributeè€Œä¸æ˜¯Typeï¼Œè¿™æ ·æ‰€æœ‰å±äºè¿™ä¸ªAttributeçš„Typeéƒ½ç”Ÿæ•ˆã€‚ AOSPæœ¬èº«å†…ç½®äº†ä¸€äº›Attributeï¼Œè€Œè¿™äº›Attributeå¾ˆå¤šéƒ½æ˜¯çº¦å®šä¿—ç§°çš„å›ºå®šå«ä¹‰ã€‚æ¯”å¦‚ï¼š domain æ‰€æœ‰è¿›ç¨‹çš„typeå¿…é¡»å½’å±äºdomainã€‚domainå› æ­¤æˆäº†è¿›ç¨‹typeçš„å¸¸è§è¡¨è¿°ã€‚ file_type æ‰€æœ‰æ–‡ä»¶typeéƒ½å½’å±äºfile_type â€¦ AOSPå†…ç½®çš„Attributeè§ platform/system/sepolicy/public/attributes platform/system/sepolicy/private/attributes platform/system/sepolicy/prebuilts/api/[version]/public/attributes platform/system/sepolicy/prebuilts/api/[version]/private/attributes Class ä¸Šé¢ç¤ºä¾‹ä¸­ï¼Œâ€œ:fileâ€å°±æ˜¯ä¸€ä¸ªClassã€‚ç®€å•è¯´å°±æ˜¯å°†æŸäº›è¢«è®¿é—®å¯¹è±¡å½’ä¸ºä¸€ç§Classï¼Œæ¯”å¦‚è¯´è¢«è®¿é—®çš„æ˜¯æ–‡ä»¶ï¼ŒClassä¸€èˆ¬å°±æ˜¯fileï¼Œå¦‚æœæ˜¯ç›®å½•ï¼ŒClasså°±æ˜¯dirï¼Œå¦‚æœæ˜¯socketï¼ŒClasså°±æ˜¯socketç­‰ç­‰ã€‚Classæ˜¯AOSPå†…å®šä¹‰å¥½çš„ï¼Œä¸€èˆ¬ä¸éœ€è¦è‡ªå®šä¹‰ å…·ä½“æœ‰é‚£äº›Classï¼Œå¯è§æºç platform/system/sepolicy/private/security_classes Classæ˜¯ç”¨æ¥åšä»€ä¹ˆçš„ï¼Ÿå…¶å®æ˜¯ä¸Permissionsç›¸å…³çš„ã€‚ Permissions å³ç¤ºä¾‹ä¸­çš„Â {Â readÂ writeÂ }ã€‚è¡¨ç¤ºå…·ä½“å¯ä»¥åšä»€ä¹ˆæ“ä½œã€‚ä¸åŒçš„Classæœ‰ä¸åŒçš„Permissionsé›†åˆã€‚ç½—åˆ—ä¸€äº›Classå¯¹åº”çš„Permissionï¼ˆéå®Œæ•´ï¼‰ï¼š Class Permission file ioctlÂ readÂ writeÂ createÂ getattrÂ setattrÂ lockÂ relabelfromÂ relabeltoÂ appendÂ unlinkÂ linkÂ renameÂ executeÂ swaponÂ quotaonÂ mounton directory add_nameÂ remove_nameÂ reparentÂ searchÂ rmdirÂ openÂ audit_accessÂ execmod socket ioctlÂ readÂ writeÂ createÂ getattrÂ setattrÂ lockÂ relabelfromÂ relabeltoÂ appendÂ bindÂ connectÂ listenÂ acceptÂ getoptÂ setoptÂ shutdownÂ recvfromÂ sendtoÂ recv_msgÂ send_msgÂ name_bind filesystem mountÂ remountÂ unmountÂ getattrÂ relabelfromÂ relabeltoÂ transitionÂ associateÂ quotamodÂ quotaget process forkÂ transitionÂ sigchldÂ sigkillÂ sigstopÂ signullÂ signalÂ ptraceÂ getschedÂ setschedÂ getsessionÂ getpgidÂ setpgidÂ getcapÂ setcapÂ shareÂ getattrÂ setexecÂ setfscreateÂ noatsecureÂ siginhÂ setrlimitÂ rlimitinhÂ dyntransitionÂ setcurrentÂ execmemÂ execstackÂ execheapÂ setkeycreateÂ setsockcreate security compute_avÂ compute_createÂ compute_memberÂ check_contextÂ load_policyÂ compute_relabelÂ compute_userÂ setenforceÂ setboolÂ setsecparamÂ setcheckreqprotÂ read_policy capability chownÂ dac_overrideÂ dac_read_searchÂ fownerÂ fsetidÂ killÂ setgidÂ setuidÂ setpcapÂ linux_immutableÂ net_bind_serviceÂ net_broadcastÂ net_adminÂ net_rawÂ ipc_lockÂ ipc_ownerÂ sys_moduleÂ sys_rawioÂ sys_chrootÂ sys_ptraceÂ sys_pacctÂ sys_adminÂ sys_bootÂ sys_niceÂ sys_resourceÂ sys_timeÂ sys_tty_configÂ mknodÂ leaseÂ audit_writeÂ audit_controlÂ setfcap MORE ANDÂ MORE å¯ä»¥ä»å¯¹åº”çš„Classä¸­é€‰å–ä»»æ„ä¸ªPermission Classä¸Perimssionçš„å®Œæ•´æ˜ å°„å…·ä½“è§æºç ï¼škernel/arm64/security/selinux/include/classmap.h ç¤ºä¾‹ ä»¥æ§åˆ¶ç‹—æ˜¯å¦æœ‰æƒåƒçŒ«ç²®ç‹—ç²®ä¸ºä¾‹ã€‚ æœ‰ä¸€ä¸ªç‹—å«å°é»„ï¼ŒÂ ä¸€ç§ç‹—ç²®å«â€œç‹—ç²®Aâ€ã€‚ ç°åœ¨å£°æ˜ä¸€ä¸ªTypeå«dogï¼Œä¸€ä¸ªTypeå«dog_chowï¼Œç³»ç»Ÿæœ¬èº«å†…ç½®äº†Classå«foodï¼Œfoodå¯¹åº”çš„permissionsé‡ŒåŒ…å«äº†eatè¿™ä¸ªæƒé™ã€‚ éšåå°†å°é»„æ˜ å°„åˆ°dogè¿™ä¸ªtypeï¼Œå°†ç‹—ç²®Aæ˜ å°„åˆ°dog_chowè¿™ä¸ªtype è¿™æ ·ï¼Œåœ¨æ·»åŠ äº†è¿™æ ·ä¸€æ¡è§„åˆ™åï¼Œå°é»„å°±æœ‰æƒé™å»åƒç‹—ç²®Aäº†ï¼š allowÂ dogÂ dog_chow:foodÂ eat; æ­¤æ—¶å¦‚æœè¿˜æœ‰ä¸€åªç‹—å°ç™½ï¼Œé‚£ä¹ˆå¯ä»¥å°†å°ç™½æ˜ å°„åˆ°dogè¿™ä¸ªtypeï¼Œè¿™æ ·å°ç™½ä¹Ÿå¯ä»¥æœ‰æƒé™åƒç‹—ç²®Aã€‚ ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:1:2","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#class"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"2.2Â è§„åˆ™é‡Œçš„å…³é”®å­—è¯´æ˜ ä»¥ä¸‹é¢è¿™ä¸ªè§„åˆ™ä¸¾ä¾‹ allowÂ sample_appÂ app_data_file:fileÂ {Â readÂ writeÂ }; RuleÂ Name ä¸Šé¢è§„åˆ™ç¤ºä¾‹ä¸­ï¼Œallowå°±æ˜¯RuleÂ Nameçš„ä¸€ç§ã€‚SeLinuxæœ‰å¤šç§RuleNameï¼š allowï¼šè¡¨ç¤ºå…è®¸Sourceå¯¹Targetæ‰§è¡Œè®¸å¯çš„æ“ä½œ neverallowï¼šè¡¨ç¤ºä¸å…è®¸Sourceå¯¹Targetæ‰§è¡Œåˆ¶å®šçš„æ“ä½œ auditallowï¼šè¡¨ç¤ºå…è®¸æ“ä½œå¹¶è®°å½•è®¿é—®å†³ç­–ä¿¡æ¯ dontauditï¼šè¡¨ç¤ºä¸è®°å½•è¿åè§„åˆ™çš„å†³ç­–ä¿¡æ¯ï¼Œåˆ‡è¿åè§„åˆ™ä¸å½±å“è¿è¡Œã€‚ å…¶ä¸­allowæ˜¯ç”¨çš„æœ€å¤šçš„ã€‚ Type ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œsample_appã€app_data_fileéƒ½æ˜¯ä¸€ä¸ªTypeã€‚ç®€å•ç†è§£å°±æ˜¯å°†ä¸€ä¸ªæˆ–å‡ ä¸ªè¿›ç¨‹å£°æ˜ä¸ºTypeÂ Aï¼ŒÂ å°†ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶å£°æ˜ä¸ºTypeÂ Bã€‚é‚£ä¹ˆåœ¨æ§åˆ¶è¿™ä¸ªè¿›ç¨‹æœ‰æ²¡æœ‰æƒé™è®¿é—®è¿™ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œåªç”¨Aå’ŒBæ¥è¡¨ç¤ºå°±å¯ä»¥äº†ã€‚ è¿™æ ·åšæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿâ€œä¸€ç±»è¿›ç¨‹â€æ€»æ¯”å…·ä½“çš„â€œä¸€ä¸ªè¿›ç¨‹â€è¦çµæ´»çš„å¤šã€‚æŠŠå¤šä¸ªè¿›ç¨‹å£°æ˜ä¸ºåŒä¸€ä¸ªTypeï¼Œé‚£ä¹ˆåœ¨å†™è§„åˆ™çš„æ—¶å€™åªè¦æè¿°è¿™ä¸ªTypeï¼Œé‚£ä¹ˆè¿™ä¸ªTypeå¯¹åº”çš„æ‰€æœ‰è¿›ç¨‹éƒ½ä¼šç”Ÿæ•ˆã€‚æ–‡ä»¶æˆ–å…¶ä»–å¯¹è±¡ä¹Ÿæ˜¯åŒæ ·çš„ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è§„åˆ™ä¸­æè¿°Sourceèƒ½ä¸èƒ½è®¿é—®Targetï¼Œæ˜¯é€šè¿‡Typeæ¥è¡¨è¿°çš„ã€‚ Typeæ˜¯å‚å•†æˆ–ä¾›åº”å•†å¯ä»¥è‡ªå®šä¹‰çš„ Attribute å°†å¤šä¸ªTypeå½’ä¸ºä¸€ç»„ï¼Œå°±æ˜¯ä¸€ä¸ªAttributeã€‚ é€šä¿—çš„è¯´ï¼ŒæŠŠä¸€äº›è¿›ç¨‹å£°æ˜ä¸ºTypeï¼Œä½†æ˜¯å¤šä¸ªTypeæœ‰æŸç§å…±é€šçš„ç‰¹æ€§ï¼Œå°±å¯ä»¥æŠŠè¿™äº›Typeå£°æ˜ä¸ºåŒä¸€ä¸ªAttributeã€‚åœ¨æè¿°è§„åˆ™çš„æ—¶å€™ï¼Œå¯ä»¥å°†Sourceæˆ–è€…TargetæŒ‡å®šä¸ºä¸€ä¸ªAttributeè€Œä¸æ˜¯Typeï¼Œè¿™æ ·æ‰€æœ‰å±äºè¿™ä¸ªAttributeçš„Typeéƒ½ç”Ÿæ•ˆã€‚ AOSPæœ¬èº«å†…ç½®äº†ä¸€äº›Attributeï¼Œè€Œè¿™äº›Attributeå¾ˆå¤šéƒ½æ˜¯çº¦å®šä¿—ç§°çš„å›ºå®šå«ä¹‰ã€‚æ¯”å¦‚ï¼š domain æ‰€æœ‰è¿›ç¨‹çš„typeå¿…é¡»å½’å±äºdomainã€‚domainå› æ­¤æˆäº†è¿›ç¨‹typeçš„å¸¸è§è¡¨è¿°ã€‚ file_type æ‰€æœ‰æ–‡ä»¶typeéƒ½å½’å±äºfile_type â€¦ AOSPå†…ç½®çš„Attributeè§ platform/system/sepolicy/public/attributes platform/system/sepolicy/private/attributes platform/system/sepolicy/prebuilts/api/[version]/public/attributes platform/system/sepolicy/prebuilts/api/[version]/private/attributes Class ä¸Šé¢ç¤ºä¾‹ä¸­ï¼Œâ€œ:fileâ€å°±æ˜¯ä¸€ä¸ªClassã€‚ç®€å•è¯´å°±æ˜¯å°†æŸäº›è¢«è®¿é—®å¯¹è±¡å½’ä¸ºä¸€ç§Classï¼Œæ¯”å¦‚è¯´è¢«è®¿é—®çš„æ˜¯æ–‡ä»¶ï¼ŒClassä¸€èˆ¬å°±æ˜¯fileï¼Œå¦‚æœæ˜¯ç›®å½•ï¼ŒClasså°±æ˜¯dirï¼Œå¦‚æœæ˜¯socketï¼ŒClasså°±æ˜¯socketç­‰ç­‰ã€‚Classæ˜¯AOSPå†…å®šä¹‰å¥½çš„ï¼Œä¸€èˆ¬ä¸éœ€è¦è‡ªå®šä¹‰ å…·ä½“æœ‰é‚£äº›Classï¼Œå¯è§æºç platform/system/sepolicy/private/security_classes Classæ˜¯ç”¨æ¥åšä»€ä¹ˆçš„ï¼Ÿå…¶å®æ˜¯ä¸Permissionsç›¸å…³çš„ã€‚ Permissions å³ç¤ºä¾‹ä¸­çš„Â {Â readÂ writeÂ }ã€‚è¡¨ç¤ºå…·ä½“å¯ä»¥åšä»€ä¹ˆæ“ä½œã€‚ä¸åŒçš„Classæœ‰ä¸åŒçš„Permissionsé›†åˆã€‚ç½—åˆ—ä¸€äº›Classå¯¹åº”çš„Permissionï¼ˆéå®Œæ•´ï¼‰ï¼š Class Permission file ioctlÂ readÂ writeÂ createÂ getattrÂ setattrÂ lockÂ relabelfromÂ relabeltoÂ appendÂ unlinkÂ linkÂ renameÂ executeÂ swaponÂ quotaonÂ mounton directory add_nameÂ remove_nameÂ reparentÂ searchÂ rmdirÂ openÂ audit_accessÂ execmod socket ioctlÂ readÂ writeÂ createÂ getattrÂ setattrÂ lockÂ relabelfromÂ relabeltoÂ appendÂ bindÂ connectÂ listenÂ acceptÂ getoptÂ setoptÂ shutdownÂ recvfromÂ sendtoÂ recv_msgÂ send_msgÂ name_bind filesystem mountÂ remountÂ unmountÂ getattrÂ relabelfromÂ relabeltoÂ transitionÂ associateÂ quotamodÂ quotaget process forkÂ transitionÂ sigchldÂ sigkillÂ sigstopÂ signullÂ signalÂ ptraceÂ getschedÂ setschedÂ getsessionÂ getpgidÂ setpgidÂ getcapÂ setcapÂ shareÂ getattrÂ setexecÂ setfscreateÂ noatsecureÂ siginhÂ setrlimitÂ rlimitinhÂ dyntransitionÂ setcurrentÂ execmemÂ execstackÂ execheapÂ setkeycreateÂ setsockcreate security compute_avÂ compute_createÂ compute_memberÂ check_contextÂ load_policyÂ compute_relabelÂ compute_userÂ setenforceÂ setboolÂ setsecparamÂ setcheckreqprotÂ read_policy capability chownÂ dac_overrideÂ dac_read_searchÂ fownerÂ fsetidÂ killÂ setgidÂ setuidÂ setpcapÂ linux_immutableÂ net_bind_serviceÂ net_broadcastÂ net_adminÂ net_rawÂ ipc_lockÂ ipc_ownerÂ sys_moduleÂ sys_rawioÂ sys_chrootÂ sys_ptraceÂ sys_pacctÂ sys_adminÂ sys_bootÂ sys_niceÂ sys_resourceÂ sys_timeÂ sys_tty_configÂ mknodÂ leaseÂ audit_writeÂ audit_controlÂ setfcap MORE ANDÂ MORE å¯ä»¥ä»å¯¹åº”çš„Classä¸­é€‰å–ä»»æ„ä¸ªPermission Classä¸Perimssionçš„å®Œæ•´æ˜ å°„å…·ä½“è§æºç ï¼škernel/arm64/security/selinux/include/classmap.h ç¤ºä¾‹ ä»¥æ§åˆ¶ç‹—æ˜¯å¦æœ‰æƒåƒçŒ«ç²®ç‹—ç²®ä¸ºä¾‹ã€‚ æœ‰ä¸€ä¸ªç‹—å«å°é»„ï¼ŒÂ ä¸€ç§ç‹—ç²®å«â€œç‹—ç²®Aâ€ã€‚ ç°åœ¨å£°æ˜ä¸€ä¸ªTypeå«dogï¼Œä¸€ä¸ªTypeå«dog_chowï¼Œç³»ç»Ÿæœ¬èº«å†…ç½®äº†Classå«foodï¼Œfoodå¯¹åº”çš„permissionsé‡ŒåŒ…å«äº†eatè¿™ä¸ªæƒé™ã€‚ éšåå°†å°é»„æ˜ å°„åˆ°dogè¿™ä¸ªtypeï¼Œå°†ç‹—ç²®Aæ˜ å°„åˆ°dog_chowè¿™ä¸ªtype è¿™æ ·ï¼Œåœ¨æ·»åŠ äº†è¿™æ ·ä¸€æ¡è§„åˆ™åï¼Œå°é»„å°±æœ‰æƒé™å»åƒç‹—ç²®Aäº†ï¼š allowÂ dogÂ dog_chow:foodÂ eat; æ­¤æ—¶å¦‚æœè¿˜æœ‰ä¸€åªç‹—å°ç™½ï¼Œé‚£ä¹ˆå¯ä»¥å°†å°ç™½æ˜ å°„åˆ°dogè¿™ä¸ªtypeï¼Œè¿™æ ·å°ç™½ä¹Ÿå¯ä»¥æœ‰æƒé™åƒç‹—ç²®Aã€‚ ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:1:2","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#permissions"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"2.2Â è§„åˆ™é‡Œçš„å…³é”®å­—è¯´æ˜ ä»¥ä¸‹é¢è¿™ä¸ªè§„åˆ™ä¸¾ä¾‹ allowÂ sample_appÂ app_data_file:fileÂ {Â readÂ writeÂ }; RuleÂ Name ä¸Šé¢è§„åˆ™ç¤ºä¾‹ä¸­ï¼Œallowå°±æ˜¯RuleÂ Nameçš„ä¸€ç§ã€‚SeLinuxæœ‰å¤šç§RuleNameï¼š allowï¼šè¡¨ç¤ºå…è®¸Sourceå¯¹Targetæ‰§è¡Œè®¸å¯çš„æ“ä½œ neverallowï¼šè¡¨ç¤ºä¸å…è®¸Sourceå¯¹Targetæ‰§è¡Œåˆ¶å®šçš„æ“ä½œ auditallowï¼šè¡¨ç¤ºå…è®¸æ“ä½œå¹¶è®°å½•è®¿é—®å†³ç­–ä¿¡æ¯ dontauditï¼šè¡¨ç¤ºä¸è®°å½•è¿åè§„åˆ™çš„å†³ç­–ä¿¡æ¯ï¼Œåˆ‡è¿åè§„åˆ™ä¸å½±å“è¿è¡Œã€‚ å…¶ä¸­allowæ˜¯ç”¨çš„æœ€å¤šçš„ã€‚ Type ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œsample_appã€app_data_fileéƒ½æ˜¯ä¸€ä¸ªTypeã€‚ç®€å•ç†è§£å°±æ˜¯å°†ä¸€ä¸ªæˆ–å‡ ä¸ªè¿›ç¨‹å£°æ˜ä¸ºTypeÂ Aï¼ŒÂ å°†ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶å£°æ˜ä¸ºTypeÂ Bã€‚é‚£ä¹ˆåœ¨æ§åˆ¶è¿™ä¸ªè¿›ç¨‹æœ‰æ²¡æœ‰æƒé™è®¿é—®è¿™ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œåªç”¨Aå’ŒBæ¥è¡¨ç¤ºå°±å¯ä»¥äº†ã€‚ è¿™æ ·åšæœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿâ€œä¸€ç±»è¿›ç¨‹â€æ€»æ¯”å…·ä½“çš„â€œä¸€ä¸ªè¿›ç¨‹â€è¦çµæ´»çš„å¤šã€‚æŠŠå¤šä¸ªè¿›ç¨‹å£°æ˜ä¸ºåŒä¸€ä¸ªTypeï¼Œé‚£ä¹ˆåœ¨å†™è§„åˆ™çš„æ—¶å€™åªè¦æè¿°è¿™ä¸ªTypeï¼Œé‚£ä¹ˆè¿™ä¸ªTypeå¯¹åº”çš„æ‰€æœ‰è¿›ç¨‹éƒ½ä¼šç”Ÿæ•ˆã€‚æ–‡ä»¶æˆ–å…¶ä»–å¯¹è±¡ä¹Ÿæ˜¯åŒæ ·çš„ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è§„åˆ™ä¸­æè¿°Sourceèƒ½ä¸èƒ½è®¿é—®Targetï¼Œæ˜¯é€šè¿‡Typeæ¥è¡¨è¿°çš„ã€‚ Typeæ˜¯å‚å•†æˆ–ä¾›åº”å•†å¯ä»¥è‡ªå®šä¹‰çš„ Attribute å°†å¤šä¸ªTypeå½’ä¸ºä¸€ç»„ï¼Œå°±æ˜¯ä¸€ä¸ªAttributeã€‚ é€šä¿—çš„è¯´ï¼ŒæŠŠä¸€äº›è¿›ç¨‹å£°æ˜ä¸ºTypeï¼Œä½†æ˜¯å¤šä¸ªTypeæœ‰æŸç§å…±é€šçš„ç‰¹æ€§ï¼Œå°±å¯ä»¥æŠŠè¿™äº›Typeå£°æ˜ä¸ºåŒä¸€ä¸ªAttributeã€‚åœ¨æè¿°è§„åˆ™çš„æ—¶å€™ï¼Œå¯ä»¥å°†Sourceæˆ–è€…TargetæŒ‡å®šä¸ºä¸€ä¸ªAttributeè€Œä¸æ˜¯Typeï¼Œè¿™æ ·æ‰€æœ‰å±äºè¿™ä¸ªAttributeçš„Typeéƒ½ç”Ÿæ•ˆã€‚ AOSPæœ¬èº«å†…ç½®äº†ä¸€äº›Attributeï¼Œè€Œè¿™äº›Attributeå¾ˆå¤šéƒ½æ˜¯çº¦å®šä¿—ç§°çš„å›ºå®šå«ä¹‰ã€‚æ¯”å¦‚ï¼š domain æ‰€æœ‰è¿›ç¨‹çš„typeå¿…é¡»å½’å±äºdomainã€‚domainå› æ­¤æˆäº†è¿›ç¨‹typeçš„å¸¸è§è¡¨è¿°ã€‚ file_type æ‰€æœ‰æ–‡ä»¶typeéƒ½å½’å±äºfile_type â€¦ AOSPå†…ç½®çš„Attributeè§ platform/system/sepolicy/public/attributes platform/system/sepolicy/private/attributes platform/system/sepolicy/prebuilts/api/[version]/public/attributes platform/system/sepolicy/prebuilts/api/[version]/private/attributes Class ä¸Šé¢ç¤ºä¾‹ä¸­ï¼Œâ€œ:fileâ€å°±æ˜¯ä¸€ä¸ªClassã€‚ç®€å•è¯´å°±æ˜¯å°†æŸäº›è¢«è®¿é—®å¯¹è±¡å½’ä¸ºä¸€ç§Classï¼Œæ¯”å¦‚è¯´è¢«è®¿é—®çš„æ˜¯æ–‡ä»¶ï¼ŒClassä¸€èˆ¬å°±æ˜¯fileï¼Œå¦‚æœæ˜¯ç›®å½•ï¼ŒClasså°±æ˜¯dirï¼Œå¦‚æœæ˜¯socketï¼ŒClasså°±æ˜¯socketç­‰ç­‰ã€‚Classæ˜¯AOSPå†…å®šä¹‰å¥½çš„ï¼Œä¸€èˆ¬ä¸éœ€è¦è‡ªå®šä¹‰ å…·ä½“æœ‰é‚£äº›Classï¼Œå¯è§æºç platform/system/sepolicy/private/security_classes Classæ˜¯ç”¨æ¥åšä»€ä¹ˆçš„ï¼Ÿå…¶å®æ˜¯ä¸Permissionsç›¸å…³çš„ã€‚ Permissions å³ç¤ºä¾‹ä¸­çš„Â {Â readÂ writeÂ }ã€‚è¡¨ç¤ºå…·ä½“å¯ä»¥åšä»€ä¹ˆæ“ä½œã€‚ä¸åŒçš„Classæœ‰ä¸åŒçš„Permissionsé›†åˆã€‚ç½—åˆ—ä¸€äº›Classå¯¹åº”çš„Permissionï¼ˆéå®Œæ•´ï¼‰ï¼š Class Permission file ioctlÂ readÂ writeÂ createÂ getattrÂ setattrÂ lockÂ relabelfromÂ relabeltoÂ appendÂ unlinkÂ linkÂ renameÂ executeÂ swaponÂ quotaonÂ mounton directory add_nameÂ remove_nameÂ reparentÂ searchÂ rmdirÂ openÂ audit_accessÂ execmod socket ioctlÂ readÂ writeÂ createÂ getattrÂ setattrÂ lockÂ relabelfromÂ relabeltoÂ appendÂ bindÂ connectÂ listenÂ acceptÂ getoptÂ setoptÂ shutdownÂ recvfromÂ sendtoÂ recv_msgÂ send_msgÂ name_bind filesystem mountÂ remountÂ unmountÂ getattrÂ relabelfromÂ relabeltoÂ transitionÂ associateÂ quotamodÂ quotaget process forkÂ transitionÂ sigchldÂ sigkillÂ sigstopÂ signullÂ signalÂ ptraceÂ getschedÂ setschedÂ getsessionÂ getpgidÂ setpgidÂ getcapÂ setcapÂ shareÂ getattrÂ setexecÂ setfscreateÂ noatsecureÂ siginhÂ setrlimitÂ rlimitinhÂ dyntransitionÂ setcurrentÂ execmemÂ execstackÂ execheapÂ setkeycreateÂ setsockcreate security compute_avÂ compute_createÂ compute_memberÂ check_contextÂ load_policyÂ compute_relabelÂ compute_userÂ setenforceÂ setboolÂ setsecparamÂ setcheckreqprotÂ read_policy capability chownÂ dac_overrideÂ dac_read_searchÂ fownerÂ fsetidÂ killÂ setgidÂ setuidÂ setpcapÂ linux_immutableÂ net_bind_serviceÂ net_broadcastÂ net_adminÂ net_rawÂ ipc_lockÂ ipc_ownerÂ sys_moduleÂ sys_rawioÂ sys_chrootÂ sys_ptraceÂ sys_pacctÂ sys_adminÂ sys_bootÂ sys_niceÂ sys_resourceÂ sys_timeÂ sys_tty_configÂ mknodÂ leaseÂ audit_writeÂ audit_controlÂ setfcap MORE ANDÂ MORE å¯ä»¥ä»å¯¹åº”çš„Classä¸­é€‰å–ä»»æ„ä¸ªPermission Classä¸Perimssionçš„å®Œæ•´æ˜ å°„å…·ä½“è§æºç ï¼škernel/arm64/security/selinux/include/classmap.h ç¤ºä¾‹ ä»¥æ§åˆ¶ç‹—æ˜¯å¦æœ‰æƒåƒçŒ«ç²®ç‹—ç²®ä¸ºä¾‹ã€‚ æœ‰ä¸€ä¸ªç‹—å«å°é»„ï¼ŒÂ ä¸€ç§ç‹—ç²®å«â€œç‹—ç²®Aâ€ã€‚ ç°åœ¨å£°æ˜ä¸€ä¸ªTypeå«dogï¼Œä¸€ä¸ªTypeå«dog_chowï¼Œç³»ç»Ÿæœ¬èº«å†…ç½®äº†Classå«foodï¼Œfoodå¯¹åº”çš„permissionsé‡ŒåŒ…å«äº†eatè¿™ä¸ªæƒé™ã€‚ éšåå°†å°é»„æ˜ å°„åˆ°dogè¿™ä¸ªtypeï¼Œå°†ç‹—ç²®Aæ˜ å°„åˆ°dog_chowè¿™ä¸ªtype è¿™æ ·ï¼Œåœ¨æ·»åŠ äº†è¿™æ ·ä¸€æ¡è§„åˆ™åï¼Œå°é»„å°±æœ‰æƒé™å»åƒç‹—ç²®Aäº†ï¼š allowÂ dogÂ dog_chow:foodÂ eat; æ­¤æ—¶å¦‚æœè¿˜æœ‰ä¸€åªç‹—å°ç™½ï¼Œé‚£ä¹ˆå¯ä»¥å°†å°ç™½æ˜ å°„åˆ°dogè¿™ä¸ªtypeï¼Œè¿™æ ·å°ç™½ä¹Ÿå¯ä»¥æœ‰æƒé™åƒç‹—ç²®Aã€‚ ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:1:2","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#ç¤ºä¾‹"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"2.3Â Context ä¸Šé¢æ‰€è¯´çš„â€œæ˜ å°„â€ï¼Œå³å°†ä¸€ä¸ªè¿›ç¨‹å…³è”åˆ°ä¸€ä¸ªTypeï¼Œæˆ–è€…å°†ä¸€ä¸ªæ–‡ä»¶å…³è”åˆ°ä¸€ä¸ªTypeï¼Œæ˜¯é€šè¿‡contextæ¥å®Œæˆçš„ã€‚ è¿›ç¨‹Contextï¼ˆseapp_contextsï¼‰ ä¸€ä¸ªè¿›ç¨‹çš„Contextæ¡ç›®å¯èƒ½å¦‚ä¸‹ï¼š user=_appÂ isPrivApp=trueÂ name=com.android.vzwomatriggerÂ domain=vzwomatrigger_appÂ type=privapp_data_fileÂ levelFrom=all user=_appä»£è¡¨è¿™æ˜¯ä¸€ä¸ªå¸¸è§„çš„appï¼› isPrivApp=trueä»£è¡¨è¿™æ˜¯ä¸€ä¸ªé¢„ç½®appï¼› name=com.android.vzwomatriggerÂ æŒ‡å®šäº†è¿›ç¨‹å domain=vzwomatrigger_appÂ å°†è¿›ç¨‹åå…³è”åˆ°ä¸€ä¸ªtype type=privapp_data_fileÂ è¿™æ˜¯ä¸€ä¸ªæ–‡ä»¶typeï¼ŒæŒ‡å®šäº†appçš„dataÂ directoryç›®å½•æ‰€å±çš„type levelFrom=allÂ MLS/MCSçš„levelç›¸å…³ AOSPå†…ç½®è¿›ç¨‹Contextè§platform/system/sepolicy/private/seapp_contexts ä¾›åº”å•†æˆ–å‚å•†è¦å®šä¹‰è‡ªå·±çš„seapp_contextï¼Œå°†åœ¨/venderä¸‹æˆ–\u003croot\u003e/device/manufacturer/device-name/sepolicyä¸‹ç›¸åº”ç›®å½•æ·»åŠ  æ–‡ä»¶Context ä¸€ä¸ªæ–‡ä»¶çš„Contextå¯èƒ½è¿™æ ·ï¼š /system/bin/bccÂ u:object_r:rs_exec:s0 /system/bin/bccÂ æŒ‡çš„æ˜¯å…·ä½“æ–‡ä»¶ u:object_r:rs_exec:s0æ˜¯ä¸€ä¸ªsecurityÂ contextã€‚å…¶ä¸­çš„rs_execä¸ºtypeã€‚è¿™æ ·æ–‡ä»¶å’Œtypeå°±è¿›è¡Œäº†å…³è” SecurityÂ Context å…¶æ ¼å¼ä¸ºï¼š user:role:type:sensitivity[:categories] åœ¨Androidä¸­ï¼Œ useræ˜¯å›ºå®šçš„ï¼Œæ°¸è¿œä¸ºu roleæ˜¯å›ºå®šçš„ï¼Œè®¿é—®è€…ï¼ˆç§°subjectæˆ–sourceï¼‰æ°¸è¿œä¸ºrï¼›è¢«è®¿é—®è€…ï¼ˆç§°objectæˆ–targetï¼‰æ°¸è¿œä¸ºobject_rã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿›ç¨‹ä¸€æ–¹å°±æ˜¯subjectï¼Œæ–‡ä»¶ä¸€æ–¹å°±æ˜¯objectï¼Œæ‰€ä»¥ä¸€èˆ¬è¿›ç¨‹çš„roleä¸ºrï¼Œæ–‡ä»¶çš„roleä¸ºobject_rã€‚ typeä¸ºä¸æ–‡ä»¶å…³è”çš„type sensitivityæ˜¯å›ºå®šçš„ï¼Œæ°¸è¿œä¸ºs0 categoriesæ˜¯Multi-LevelÂ SecurityÂ (MLS)Â åè®®ï¼Œç”¨æ¥éš”ç¦»ä¸€ä¸ªappçš„dataï¼Œé˜²æ­¢è¢«å¦ä¸€ä¸ªappè®¿é—®ï¼Œæˆ–è€…éš”ç¦»ä¸åŒç”¨æˆ·é—´å¯¹åŒä¸€ä¸ªappÂ dataçš„è®¿é—®ã€‚ AOSPå†…ç½®çš„æ–‡ä»¶Contextè§platform/system/sepolicy/private/file_contexts seinfo seapp_contexté‡Œé™¤äº†å¯ä»¥å°†ä¸€ä¸ªå…·ä½“åº”ç”¨æ˜ å°„åˆ°ä¸€ä¸ªdomainï¼Œä¹Ÿå¯ä»¥å°†seinfæ˜ å°„åˆ°domainã€‚mac_permissions.xmlé‡Œå®šä¹‰äº†seinfoã€‚å…¶ä¼šæ ¹æ®appæ‰€å±çš„signatureæ¥ä¸ºå…¶åˆ†é…ä¸€ä¸ªseinfoã€‚ æ¯”å¦‚ï¼š platform/system/sepolicy/private/mac_permissions.xml \u003c!-- Platform dev key in AOSP --\u003e \u003csigner signature=\"@PLATFORM\" \u003e \u003cseinfo value=\"platform\" /\u003e \u003c/signer\u003e \u003c!-- Sdk Sandbox key --\u003e \u003csigner signature=\"@SDK_SANDBOX\" \u003e \u003cseinfo value=\"sdk_sandbox\" /\u003e \u003c/signer\u003e \u003c!-- Bluetooth key in AOSP --\u003e \u003csigner signature=\"@BLUETOOTH\" \u003e \u003cseinfo value=\"bluetooth\" /\u003e \u003c/signer\u003e \u003c!-- Media key in AOSP --\u003e \u003csigner signature=\"@MEDIA\" \u003e \u003cseinfo value=\"media\" /\u003e \u003c/signer\u003e \u003csigner signature=\"@NETWORK_STACK\" \u003e \u003cseinfo value=\"network_stack\" /\u003e \u003c/signer\u003e ä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰æ‹¥æœ‰PLATFORM signatureçš„appï¼Œå°†æ‹¥æœ‰platformè¿™ä¸ªseinfoã€‚åœ¨seapp_contextä¸­å¯ä»¥å¦‚ä¸‹é…ç½®ï¼š user=radio seinfo=platform domain=radio type=radio_data_file æ‰€æœ‰æ‹¥æœ‰platformç­¾åçš„ï¼Œå¹¶ä¸”æœªé…ç½®å…·ä½“contextçš„appï¼Œå°†éµå¾ªå…¶seinfo platformçš„è§„åˆ™ã€‚ untrusted**_app** æ—¢ä¸ºé…ç½®seinfoï¼Œåˆæœªé…ç½®seapp_contextçš„appï¼Œå°†é»˜è®¤ä¸ºuntrusted_appã€‚å„çº§seapp_contextä¸­ä¹Ÿæœ‰å¯¹untrusted_appçš„æƒé™é…ç½®ã€‚ æŸ¥çœ‹å½“å‰Context è¦çœ‹è¿›ç¨‹çš„Contextï¼Œä½¿ç”¨psÂ -Z emu64xa:/ $ ps -AZ | grep google u:r:hal_camera_default:s0 system 362 1 10891800 3272 0 0 S android.hardware.camera.provider@2.7-service-google u:r:permissioncontroller_app:s0:c179,c256,c512,c768 u0_a179 976 354 13918328 83660 0 0 S com.google.android.permissioncontroller u:r:bluetooth:s0 bluetooth 1033 354 14050488 73628 0 0 S com.google.android.bluetooth u:r:priv_app:s0:c512,c768 u0_a167 1090 354 14016372 119796 0 0 S com.google.android.apps.nexuslauncher u:r:priv_app:s0:c512,c768 u0_a170 1157 354 13873728 68724 0 0 S com.google.android.ext.services u:r:untrusted_app_32:s0:c142,c256,c512,c768 u0_a142 1393 354 14070168 104520 0 0 S com.google.android.inputmethod.latin æŸ¥çœ‹æ–‡ä»¶çš„Contextï¼Œä½¿ç”¨ emu64xa:/ $ ls -Z u:object_r:cgroup:s0 acct u:object_r:tmpfs:s0 debug_ramdisk u:object_r:vendor_file:s0 odm u:object_r:sysfs:s0 sys u:object_r:apex_mnt_dir:s0 apex u:object_r:device:s0 dev u:object_r:vendor_file:s0 odm_dlkm u:object_r:system_file:s0 system u:object_r:rootfs:s0 bin u:object_r:rootfs:s0 etc u:object_r:oemfs:s0 oem ? ... ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:1:3","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#23context"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"2.3Â Context ä¸Šé¢æ‰€è¯´çš„â€œæ˜ å°„â€ï¼Œå³å°†ä¸€ä¸ªè¿›ç¨‹å…³è”åˆ°ä¸€ä¸ªTypeï¼Œæˆ–è€…å°†ä¸€ä¸ªæ–‡ä»¶å…³è”åˆ°ä¸€ä¸ªTypeï¼Œæ˜¯é€šè¿‡contextæ¥å®Œæˆçš„ã€‚ è¿›ç¨‹Contextï¼ˆseapp_contextsï¼‰ ä¸€ä¸ªè¿›ç¨‹çš„Contextæ¡ç›®å¯èƒ½å¦‚ä¸‹ï¼š user=_appÂ isPrivApp=trueÂ name=com.android.vzwomatriggerÂ domain=vzwomatrigger_appÂ type=privapp_data_fileÂ levelFrom=all user=_appä»£è¡¨è¿™æ˜¯ä¸€ä¸ªå¸¸è§„çš„appï¼› isPrivApp=trueä»£è¡¨è¿™æ˜¯ä¸€ä¸ªé¢„ç½®appï¼› name=com.android.vzwomatriggerÂ æŒ‡å®šäº†è¿›ç¨‹å domain=vzwomatrigger_appÂ å°†è¿›ç¨‹åå…³è”åˆ°ä¸€ä¸ªtype type=privapp_data_fileÂ è¿™æ˜¯ä¸€ä¸ªæ–‡ä»¶typeï¼ŒæŒ‡å®šäº†appçš„dataÂ directoryç›®å½•æ‰€å±çš„type levelFrom=allÂ MLS/MCSçš„levelç›¸å…³ AOSPå†…ç½®è¿›ç¨‹Contextè§platform/system/sepolicy/private/seapp_contexts ä¾›åº”å•†æˆ–å‚å•†è¦å®šä¹‰è‡ªå·±çš„seapp_contextï¼Œå°†åœ¨/venderä¸‹æˆ–/device/manufacturer/device-name/sepolicyä¸‹ç›¸åº”ç›®å½•æ·»åŠ  æ–‡ä»¶Context ä¸€ä¸ªæ–‡ä»¶çš„Contextå¯èƒ½è¿™æ ·ï¼š /system/bin/bccÂ u:object_r:rs_exec:s0 /system/bin/bccÂ æŒ‡çš„æ˜¯å…·ä½“æ–‡ä»¶ u:object_r:rs_exec:s0æ˜¯ä¸€ä¸ªsecurityÂ contextã€‚å…¶ä¸­çš„rs_execä¸ºtypeã€‚è¿™æ ·æ–‡ä»¶å’Œtypeå°±è¿›è¡Œäº†å…³è” SecurityÂ Context å…¶æ ¼å¼ä¸ºï¼š user:role:type:sensitivity[:categories] åœ¨Androidä¸­ï¼Œ useræ˜¯å›ºå®šçš„ï¼Œæ°¸è¿œä¸ºu roleæ˜¯å›ºå®šçš„ï¼Œè®¿é—®è€…ï¼ˆç§°subjectæˆ–sourceï¼‰æ°¸è¿œä¸ºrï¼›è¢«è®¿é—®è€…ï¼ˆç§°objectæˆ–targetï¼‰æ°¸è¿œä¸ºobject_rã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿›ç¨‹ä¸€æ–¹å°±æ˜¯subjectï¼Œæ–‡ä»¶ä¸€æ–¹å°±æ˜¯objectï¼Œæ‰€ä»¥ä¸€èˆ¬è¿›ç¨‹çš„roleä¸ºrï¼Œæ–‡ä»¶çš„roleä¸ºobject_rã€‚ typeä¸ºä¸æ–‡ä»¶å…³è”çš„type sensitivityæ˜¯å›ºå®šçš„ï¼Œæ°¸è¿œä¸ºs0 categoriesæ˜¯Multi-LevelÂ SecurityÂ (MLS)Â åè®®ï¼Œç”¨æ¥éš”ç¦»ä¸€ä¸ªappçš„dataï¼Œé˜²æ­¢è¢«å¦ä¸€ä¸ªappè®¿é—®ï¼Œæˆ–è€…éš”ç¦»ä¸åŒç”¨æˆ·é—´å¯¹åŒä¸€ä¸ªappÂ dataçš„è®¿é—®ã€‚ AOSPå†…ç½®çš„æ–‡ä»¶Contextè§platform/system/sepolicy/private/file_contexts seinfo seapp_contexté‡Œé™¤äº†å¯ä»¥å°†ä¸€ä¸ªå…·ä½“åº”ç”¨æ˜ å°„åˆ°ä¸€ä¸ªdomainï¼Œä¹Ÿå¯ä»¥å°†seinfæ˜ å°„åˆ°domainã€‚mac_permissions.xmlé‡Œå®šä¹‰äº†seinfoã€‚å…¶ä¼šæ ¹æ®appæ‰€å±çš„signatureæ¥ä¸ºå…¶åˆ†é…ä¸€ä¸ªseinfoã€‚ æ¯”å¦‚ï¼š platform/system/sepolicy/private/mac_permissions.xml ä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰æ‹¥æœ‰PLATFORM signatureçš„appï¼Œå°†æ‹¥æœ‰platformè¿™ä¸ªseinfoã€‚åœ¨seapp_contextä¸­å¯ä»¥å¦‚ä¸‹é…ç½®ï¼š user=radio seinfo=platform domain=radio type=radio_data_file æ‰€æœ‰æ‹¥æœ‰platformç­¾åçš„ï¼Œå¹¶ä¸”æœªé…ç½®å…·ä½“contextçš„appï¼Œå°†éµå¾ªå…¶seinfo platformçš„è§„åˆ™ã€‚ untrusted**_app** æ—¢ä¸ºé…ç½®seinfoï¼Œåˆæœªé…ç½®seapp_contextçš„appï¼Œå°†é»˜è®¤ä¸ºuntrusted_appã€‚å„çº§seapp_contextä¸­ä¹Ÿæœ‰å¯¹untrusted_appçš„æƒé™é…ç½®ã€‚ æŸ¥çœ‹å½“å‰Context è¦çœ‹è¿›ç¨‹çš„Contextï¼Œä½¿ç”¨psÂ -Z emu64xa:/ $ ps -AZ | grep google u:r:hal_camera_default:s0 system 362 1 10891800 3272 0 0 S android.hardware.camera.provider@2.7-service-google u:r:permissioncontroller_app:s0:c179,c256,c512,c768 u0_a179 976 354 13918328 83660 0 0 S com.google.android.permissioncontroller u:r:bluetooth:s0 bluetooth 1033 354 14050488 73628 0 0 S com.google.android.bluetooth u:r:priv_app:s0:c512,c768 u0_a167 1090 354 14016372 119796 0 0 S com.google.android.apps.nexuslauncher u:r:priv_app:s0:c512,c768 u0_a170 1157 354 13873728 68724 0 0 S com.google.android.ext.services u:r:untrusted_app_32:s0:c142,c256,c512,c768 u0_a142 1393 354 14070168 104520 0 0 S com.google.android.inputmethod.latin æŸ¥çœ‹æ–‡ä»¶çš„Contextï¼Œä½¿ç”¨ emu64xa:/ $ ls -Z u:object_r:cgroup:s0 acct u:object_r:tmpfs:s0 debug_ramdisk u:object_r:vendor_file:s0 odm u:object_r:sysfs:s0 sys u:object_r:apex_mnt_dir:s0 apex u:object_r:device:s0 dev u:object_r:vendor_file:s0 odm_dlkm u:object_r:system_file:s0 system u:object_r:rootfs:s0 bin u:object_r:rootfs:s0 etc u:object_r:oemfs:s0 oem ? ... ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:1:3","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#è¿›ç¨‹contextseapp_contexts"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"2.3Â Context ä¸Šé¢æ‰€è¯´çš„â€œæ˜ å°„â€ï¼Œå³å°†ä¸€ä¸ªè¿›ç¨‹å…³è”åˆ°ä¸€ä¸ªTypeï¼Œæˆ–è€…å°†ä¸€ä¸ªæ–‡ä»¶å…³è”åˆ°ä¸€ä¸ªTypeï¼Œæ˜¯é€šè¿‡contextæ¥å®Œæˆçš„ã€‚ è¿›ç¨‹Contextï¼ˆseapp_contextsï¼‰ ä¸€ä¸ªè¿›ç¨‹çš„Contextæ¡ç›®å¯èƒ½å¦‚ä¸‹ï¼š user=_appÂ isPrivApp=trueÂ name=com.android.vzwomatriggerÂ domain=vzwomatrigger_appÂ type=privapp_data_fileÂ levelFrom=all user=_appä»£è¡¨è¿™æ˜¯ä¸€ä¸ªå¸¸è§„çš„appï¼› isPrivApp=trueä»£è¡¨è¿™æ˜¯ä¸€ä¸ªé¢„ç½®appï¼› name=com.android.vzwomatriggerÂ æŒ‡å®šäº†è¿›ç¨‹å domain=vzwomatrigger_appÂ å°†è¿›ç¨‹åå…³è”åˆ°ä¸€ä¸ªtype type=privapp_data_fileÂ è¿™æ˜¯ä¸€ä¸ªæ–‡ä»¶typeï¼ŒæŒ‡å®šäº†appçš„dataÂ directoryç›®å½•æ‰€å±çš„type levelFrom=allÂ MLS/MCSçš„levelç›¸å…³ AOSPå†…ç½®è¿›ç¨‹Contextè§platform/system/sepolicy/private/seapp_contexts ä¾›åº”å•†æˆ–å‚å•†è¦å®šä¹‰è‡ªå·±çš„seapp_contextï¼Œå°†åœ¨/venderä¸‹æˆ–/device/manufacturer/device-name/sepolicyä¸‹ç›¸åº”ç›®å½•æ·»åŠ  æ–‡ä»¶Context ä¸€ä¸ªæ–‡ä»¶çš„Contextå¯èƒ½è¿™æ ·ï¼š /system/bin/bccÂ u:object_r:rs_exec:s0 /system/bin/bccÂ æŒ‡çš„æ˜¯å…·ä½“æ–‡ä»¶ u:object_r:rs_exec:s0æ˜¯ä¸€ä¸ªsecurityÂ contextã€‚å…¶ä¸­çš„rs_execä¸ºtypeã€‚è¿™æ ·æ–‡ä»¶å’Œtypeå°±è¿›è¡Œäº†å…³è” SecurityÂ Context å…¶æ ¼å¼ä¸ºï¼š user:role:type:sensitivity[:categories] åœ¨Androidä¸­ï¼Œ useræ˜¯å›ºå®šçš„ï¼Œæ°¸è¿œä¸ºu roleæ˜¯å›ºå®šçš„ï¼Œè®¿é—®è€…ï¼ˆç§°subjectæˆ–sourceï¼‰æ°¸è¿œä¸ºrï¼›è¢«è®¿é—®è€…ï¼ˆç§°objectæˆ–targetï¼‰æ°¸è¿œä¸ºobject_rã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿›ç¨‹ä¸€æ–¹å°±æ˜¯subjectï¼Œæ–‡ä»¶ä¸€æ–¹å°±æ˜¯objectï¼Œæ‰€ä»¥ä¸€èˆ¬è¿›ç¨‹çš„roleä¸ºrï¼Œæ–‡ä»¶çš„roleä¸ºobject_rã€‚ typeä¸ºä¸æ–‡ä»¶å…³è”çš„type sensitivityæ˜¯å›ºå®šçš„ï¼Œæ°¸è¿œä¸ºs0 categoriesæ˜¯Multi-LevelÂ SecurityÂ (MLS)Â åè®®ï¼Œç”¨æ¥éš”ç¦»ä¸€ä¸ªappçš„dataï¼Œé˜²æ­¢è¢«å¦ä¸€ä¸ªappè®¿é—®ï¼Œæˆ–è€…éš”ç¦»ä¸åŒç”¨æˆ·é—´å¯¹åŒä¸€ä¸ªappÂ dataçš„è®¿é—®ã€‚ AOSPå†…ç½®çš„æ–‡ä»¶Contextè§platform/system/sepolicy/private/file_contexts seinfo seapp_contexté‡Œé™¤äº†å¯ä»¥å°†ä¸€ä¸ªå…·ä½“åº”ç”¨æ˜ å°„åˆ°ä¸€ä¸ªdomainï¼Œä¹Ÿå¯ä»¥å°†seinfæ˜ å°„åˆ°domainã€‚mac_permissions.xmlé‡Œå®šä¹‰äº†seinfoã€‚å…¶ä¼šæ ¹æ®appæ‰€å±çš„signatureæ¥ä¸ºå…¶åˆ†é…ä¸€ä¸ªseinfoã€‚ æ¯”å¦‚ï¼š platform/system/sepolicy/private/mac_permissions.xml ä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰æ‹¥æœ‰PLATFORM signatureçš„appï¼Œå°†æ‹¥æœ‰platformè¿™ä¸ªseinfoã€‚åœ¨seapp_contextä¸­å¯ä»¥å¦‚ä¸‹é…ç½®ï¼š user=radio seinfo=platform domain=radio type=radio_data_file æ‰€æœ‰æ‹¥æœ‰platformç­¾åçš„ï¼Œå¹¶ä¸”æœªé…ç½®å…·ä½“contextçš„appï¼Œå°†éµå¾ªå…¶seinfo platformçš„è§„åˆ™ã€‚ untrusted**_app** æ—¢ä¸ºé…ç½®seinfoï¼Œåˆæœªé…ç½®seapp_contextçš„appï¼Œå°†é»˜è®¤ä¸ºuntrusted_appã€‚å„çº§seapp_contextä¸­ä¹Ÿæœ‰å¯¹untrusted_appçš„æƒé™é…ç½®ã€‚ æŸ¥çœ‹å½“å‰Context è¦çœ‹è¿›ç¨‹çš„Contextï¼Œä½¿ç”¨psÂ -Z emu64xa:/ $ ps -AZ | grep google u:r:hal_camera_default:s0 system 362 1 10891800 3272 0 0 S android.hardware.camera.provider@2.7-service-google u:r:permissioncontroller_app:s0:c179,c256,c512,c768 u0_a179 976 354 13918328 83660 0 0 S com.google.android.permissioncontroller u:r:bluetooth:s0 bluetooth 1033 354 14050488 73628 0 0 S com.google.android.bluetooth u:r:priv_app:s0:c512,c768 u0_a167 1090 354 14016372 119796 0 0 S com.google.android.apps.nexuslauncher u:r:priv_app:s0:c512,c768 u0_a170 1157 354 13873728 68724 0 0 S com.google.android.ext.services u:r:untrusted_app_32:s0:c142,c256,c512,c768 u0_a142 1393 354 14070168 104520 0 0 S com.google.android.inputmethod.latin æŸ¥çœ‹æ–‡ä»¶çš„Contextï¼Œä½¿ç”¨ emu64xa:/ $ ls -Z u:object_r:cgroup:s0 acct u:object_r:tmpfs:s0 debug_ramdisk u:object_r:vendor_file:s0 odm u:object_r:sysfs:s0 sys u:object_r:apex_mnt_dir:s0 apex u:object_r:device:s0 dev u:object_r:vendor_file:s0 odm_dlkm u:object_r:system_file:s0 system u:object_r:rootfs:s0 bin u:object_r:rootfs:s0 etc u:object_r:oemfs:s0 oem ? ... ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:1:3","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#æ–‡ä»¶context"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"2.3Â Context ä¸Šé¢æ‰€è¯´çš„â€œæ˜ å°„â€ï¼Œå³å°†ä¸€ä¸ªè¿›ç¨‹å…³è”åˆ°ä¸€ä¸ªTypeï¼Œæˆ–è€…å°†ä¸€ä¸ªæ–‡ä»¶å…³è”åˆ°ä¸€ä¸ªTypeï¼Œæ˜¯é€šè¿‡contextæ¥å®Œæˆçš„ã€‚ è¿›ç¨‹Contextï¼ˆseapp_contextsï¼‰ ä¸€ä¸ªè¿›ç¨‹çš„Contextæ¡ç›®å¯èƒ½å¦‚ä¸‹ï¼š user=_appÂ isPrivApp=trueÂ name=com.android.vzwomatriggerÂ domain=vzwomatrigger_appÂ type=privapp_data_fileÂ levelFrom=all user=_appä»£è¡¨è¿™æ˜¯ä¸€ä¸ªå¸¸è§„çš„appï¼› isPrivApp=trueä»£è¡¨è¿™æ˜¯ä¸€ä¸ªé¢„ç½®appï¼› name=com.android.vzwomatriggerÂ æŒ‡å®šäº†è¿›ç¨‹å domain=vzwomatrigger_appÂ å°†è¿›ç¨‹åå…³è”åˆ°ä¸€ä¸ªtype type=privapp_data_fileÂ è¿™æ˜¯ä¸€ä¸ªæ–‡ä»¶typeï¼ŒæŒ‡å®šäº†appçš„dataÂ directoryç›®å½•æ‰€å±çš„type levelFrom=allÂ MLS/MCSçš„levelç›¸å…³ AOSPå†…ç½®è¿›ç¨‹Contextè§platform/system/sepolicy/private/seapp_contexts ä¾›åº”å•†æˆ–å‚å•†è¦å®šä¹‰è‡ªå·±çš„seapp_contextï¼Œå°†åœ¨/venderä¸‹æˆ–/device/manufacturer/device-name/sepolicyä¸‹ç›¸åº”ç›®å½•æ·»åŠ  æ–‡ä»¶Context ä¸€ä¸ªæ–‡ä»¶çš„Contextå¯èƒ½è¿™æ ·ï¼š /system/bin/bccÂ u:object_r:rs_exec:s0 /system/bin/bccÂ æŒ‡çš„æ˜¯å…·ä½“æ–‡ä»¶ u:object_r:rs_exec:s0æ˜¯ä¸€ä¸ªsecurityÂ contextã€‚å…¶ä¸­çš„rs_execä¸ºtypeã€‚è¿™æ ·æ–‡ä»¶å’Œtypeå°±è¿›è¡Œäº†å…³è” SecurityÂ Context å…¶æ ¼å¼ä¸ºï¼š user:role:type:sensitivity[:categories] åœ¨Androidä¸­ï¼Œ useræ˜¯å›ºå®šçš„ï¼Œæ°¸è¿œä¸ºu roleæ˜¯å›ºå®šçš„ï¼Œè®¿é—®è€…ï¼ˆç§°subjectæˆ–sourceï¼‰æ°¸è¿œä¸ºrï¼›è¢«è®¿é—®è€…ï¼ˆç§°objectæˆ–targetï¼‰æ°¸è¿œä¸ºobject_rã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿›ç¨‹ä¸€æ–¹å°±æ˜¯subjectï¼Œæ–‡ä»¶ä¸€æ–¹å°±æ˜¯objectï¼Œæ‰€ä»¥ä¸€èˆ¬è¿›ç¨‹çš„roleä¸ºrï¼Œæ–‡ä»¶çš„roleä¸ºobject_rã€‚ typeä¸ºä¸æ–‡ä»¶å…³è”çš„type sensitivityæ˜¯å›ºå®šçš„ï¼Œæ°¸è¿œä¸ºs0 categoriesæ˜¯Multi-LevelÂ SecurityÂ (MLS)Â åè®®ï¼Œç”¨æ¥éš”ç¦»ä¸€ä¸ªappçš„dataï¼Œé˜²æ­¢è¢«å¦ä¸€ä¸ªappè®¿é—®ï¼Œæˆ–è€…éš”ç¦»ä¸åŒç”¨æˆ·é—´å¯¹åŒä¸€ä¸ªappÂ dataçš„è®¿é—®ã€‚ AOSPå†…ç½®çš„æ–‡ä»¶Contextè§platform/system/sepolicy/private/file_contexts seinfo seapp_contexté‡Œé™¤äº†å¯ä»¥å°†ä¸€ä¸ªå…·ä½“åº”ç”¨æ˜ å°„åˆ°ä¸€ä¸ªdomainï¼Œä¹Ÿå¯ä»¥å°†seinfæ˜ å°„åˆ°domainã€‚mac_permissions.xmlé‡Œå®šä¹‰äº†seinfoã€‚å…¶ä¼šæ ¹æ®appæ‰€å±çš„signatureæ¥ä¸ºå…¶åˆ†é…ä¸€ä¸ªseinfoã€‚ æ¯”å¦‚ï¼š platform/system/sepolicy/private/mac_permissions.xml ä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰æ‹¥æœ‰PLATFORM signatureçš„appï¼Œå°†æ‹¥æœ‰platformè¿™ä¸ªseinfoã€‚åœ¨seapp_contextä¸­å¯ä»¥å¦‚ä¸‹é…ç½®ï¼š user=radio seinfo=platform domain=radio type=radio_data_file æ‰€æœ‰æ‹¥æœ‰platformç­¾åçš„ï¼Œå¹¶ä¸”æœªé…ç½®å…·ä½“contextçš„appï¼Œå°†éµå¾ªå…¶seinfo platformçš„è§„åˆ™ã€‚ untrusted**_app** æ—¢ä¸ºé…ç½®seinfoï¼Œåˆæœªé…ç½®seapp_contextçš„appï¼Œå°†é»˜è®¤ä¸ºuntrusted_appã€‚å„çº§seapp_contextä¸­ä¹Ÿæœ‰å¯¹untrusted_appçš„æƒé™é…ç½®ã€‚ æŸ¥çœ‹å½“å‰Context è¦çœ‹è¿›ç¨‹çš„Contextï¼Œä½¿ç”¨psÂ -Z emu64xa:/ $ ps -AZ | grep google u:r:hal_camera_default:s0 system 362 1 10891800 3272 0 0 S android.hardware.camera.provider@2.7-service-google u:r:permissioncontroller_app:s0:c179,c256,c512,c768 u0_a179 976 354 13918328 83660 0 0 S com.google.android.permissioncontroller u:r:bluetooth:s0 bluetooth 1033 354 14050488 73628 0 0 S com.google.android.bluetooth u:r:priv_app:s0:c512,c768 u0_a167 1090 354 14016372 119796 0 0 S com.google.android.apps.nexuslauncher u:r:priv_app:s0:c512,c768 u0_a170 1157 354 13873728 68724 0 0 S com.google.android.ext.services u:r:untrusted_app_32:s0:c142,c256,c512,c768 u0_a142 1393 354 14070168 104520 0 0 S com.google.android.inputmethod.latin æŸ¥çœ‹æ–‡ä»¶çš„Contextï¼Œä½¿ç”¨ emu64xa:/ $ ls -Z u:object_r:cgroup:s0 acct u:object_r:tmpfs:s0 debug_ramdisk u:object_r:vendor_file:s0 odm u:object_r:sysfs:s0 sys u:object_r:apex_mnt_dir:s0 apex u:object_r:device:s0 dev u:object_r:vendor_file:s0 odm_dlkm u:object_r:system_file:s0 system u:object_r:rootfs:s0 bin u:object_r:rootfs:s0 etc u:object_r:oemfs:s0 oem ? ... ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:1:3","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#securitycontext"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"2.3Â Context ä¸Šé¢æ‰€è¯´çš„â€œæ˜ å°„â€ï¼Œå³å°†ä¸€ä¸ªè¿›ç¨‹å…³è”åˆ°ä¸€ä¸ªTypeï¼Œæˆ–è€…å°†ä¸€ä¸ªæ–‡ä»¶å…³è”åˆ°ä¸€ä¸ªTypeï¼Œæ˜¯é€šè¿‡contextæ¥å®Œæˆçš„ã€‚ è¿›ç¨‹Contextï¼ˆseapp_contextsï¼‰ ä¸€ä¸ªè¿›ç¨‹çš„Contextæ¡ç›®å¯èƒ½å¦‚ä¸‹ï¼š user=_appÂ isPrivApp=trueÂ name=com.android.vzwomatriggerÂ domain=vzwomatrigger_appÂ type=privapp_data_fileÂ levelFrom=all user=_appä»£è¡¨è¿™æ˜¯ä¸€ä¸ªå¸¸è§„çš„appï¼› isPrivApp=trueä»£è¡¨è¿™æ˜¯ä¸€ä¸ªé¢„ç½®appï¼› name=com.android.vzwomatriggerÂ æŒ‡å®šäº†è¿›ç¨‹å domain=vzwomatrigger_appÂ å°†è¿›ç¨‹åå…³è”åˆ°ä¸€ä¸ªtype type=privapp_data_fileÂ è¿™æ˜¯ä¸€ä¸ªæ–‡ä»¶typeï¼ŒæŒ‡å®šäº†appçš„dataÂ directoryç›®å½•æ‰€å±çš„type levelFrom=allÂ MLS/MCSçš„levelç›¸å…³ AOSPå†…ç½®è¿›ç¨‹Contextè§platform/system/sepolicy/private/seapp_contexts ä¾›åº”å•†æˆ–å‚å•†è¦å®šä¹‰è‡ªå·±çš„seapp_contextï¼Œå°†åœ¨/venderä¸‹æˆ–/device/manufacturer/device-name/sepolicyä¸‹ç›¸åº”ç›®å½•æ·»åŠ  æ–‡ä»¶Context ä¸€ä¸ªæ–‡ä»¶çš„Contextå¯èƒ½è¿™æ ·ï¼š /system/bin/bccÂ u:object_r:rs_exec:s0 /system/bin/bccÂ æŒ‡çš„æ˜¯å…·ä½“æ–‡ä»¶ u:object_r:rs_exec:s0æ˜¯ä¸€ä¸ªsecurityÂ contextã€‚å…¶ä¸­çš„rs_execä¸ºtypeã€‚è¿™æ ·æ–‡ä»¶å’Œtypeå°±è¿›è¡Œäº†å…³è” SecurityÂ Context å…¶æ ¼å¼ä¸ºï¼š user:role:type:sensitivity[:categories] åœ¨Androidä¸­ï¼Œ useræ˜¯å›ºå®šçš„ï¼Œæ°¸è¿œä¸ºu roleæ˜¯å›ºå®šçš„ï¼Œè®¿é—®è€…ï¼ˆç§°subjectæˆ–sourceï¼‰æ°¸è¿œä¸ºrï¼›è¢«è®¿é—®è€…ï¼ˆç§°objectæˆ–targetï¼‰æ°¸è¿œä¸ºobject_rã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿›ç¨‹ä¸€æ–¹å°±æ˜¯subjectï¼Œæ–‡ä»¶ä¸€æ–¹å°±æ˜¯objectï¼Œæ‰€ä»¥ä¸€èˆ¬è¿›ç¨‹çš„roleä¸ºrï¼Œæ–‡ä»¶çš„roleä¸ºobject_rã€‚ typeä¸ºä¸æ–‡ä»¶å…³è”çš„type sensitivityæ˜¯å›ºå®šçš„ï¼Œæ°¸è¿œä¸ºs0 categoriesæ˜¯Multi-LevelÂ SecurityÂ (MLS)Â åè®®ï¼Œç”¨æ¥éš”ç¦»ä¸€ä¸ªappçš„dataï¼Œé˜²æ­¢è¢«å¦ä¸€ä¸ªappè®¿é—®ï¼Œæˆ–è€…éš”ç¦»ä¸åŒç”¨æˆ·é—´å¯¹åŒä¸€ä¸ªappÂ dataçš„è®¿é—®ã€‚ AOSPå†…ç½®çš„æ–‡ä»¶Contextè§platform/system/sepolicy/private/file_contexts seinfo seapp_contexté‡Œé™¤äº†å¯ä»¥å°†ä¸€ä¸ªå…·ä½“åº”ç”¨æ˜ å°„åˆ°ä¸€ä¸ªdomainï¼Œä¹Ÿå¯ä»¥å°†seinfæ˜ å°„åˆ°domainã€‚mac_permissions.xmlé‡Œå®šä¹‰äº†seinfoã€‚å…¶ä¼šæ ¹æ®appæ‰€å±çš„signatureæ¥ä¸ºå…¶åˆ†é…ä¸€ä¸ªseinfoã€‚ æ¯”å¦‚ï¼š platform/system/sepolicy/private/mac_permissions.xml ä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰æ‹¥æœ‰PLATFORM signatureçš„appï¼Œå°†æ‹¥æœ‰platformè¿™ä¸ªseinfoã€‚åœ¨seapp_contextä¸­å¯ä»¥å¦‚ä¸‹é…ç½®ï¼š user=radio seinfo=platform domain=radio type=radio_data_file æ‰€æœ‰æ‹¥æœ‰platformç­¾åçš„ï¼Œå¹¶ä¸”æœªé…ç½®å…·ä½“contextçš„appï¼Œå°†éµå¾ªå…¶seinfo platformçš„è§„åˆ™ã€‚ untrusted**_app** æ—¢ä¸ºé…ç½®seinfoï¼Œåˆæœªé…ç½®seapp_contextçš„appï¼Œå°†é»˜è®¤ä¸ºuntrusted_appã€‚å„çº§seapp_contextä¸­ä¹Ÿæœ‰å¯¹untrusted_appçš„æƒé™é…ç½®ã€‚ æŸ¥çœ‹å½“å‰Context è¦çœ‹è¿›ç¨‹çš„Contextï¼Œä½¿ç”¨psÂ -Z emu64xa:/ $ ps -AZ | grep google u:r:hal_camera_default:s0 system 362 1 10891800 3272 0 0 S android.hardware.camera.provider@2.7-service-google u:r:permissioncontroller_app:s0:c179,c256,c512,c768 u0_a179 976 354 13918328 83660 0 0 S com.google.android.permissioncontroller u:r:bluetooth:s0 bluetooth 1033 354 14050488 73628 0 0 S com.google.android.bluetooth u:r:priv_app:s0:c512,c768 u0_a167 1090 354 14016372 119796 0 0 S com.google.android.apps.nexuslauncher u:r:priv_app:s0:c512,c768 u0_a170 1157 354 13873728 68724 0 0 S com.google.android.ext.services u:r:untrusted_app_32:s0:c142,c256,c512,c768 u0_a142 1393 354 14070168 104520 0 0 S com.google.android.inputmethod.latin æŸ¥çœ‹æ–‡ä»¶çš„Contextï¼Œä½¿ç”¨ emu64xa:/ $ ls -Z u:object_r:cgroup:s0 acct u:object_r:tmpfs:s0 debug_ramdisk u:object_r:vendor_file:s0 odm u:object_r:sysfs:s0 sys u:object_r:apex_mnt_dir:s0 apex u:object_r:device:s0 dev u:object_r:vendor_file:s0 odm_dlkm u:object_r:system_file:s0 system u:object_r:rootfs:s0 bin u:object_r:rootfs:s0 etc u:object_r:oemfs:s0 oem ? ... ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:1:3","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#seinfo"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"2.3Â Context ä¸Šé¢æ‰€è¯´çš„â€œæ˜ å°„â€ï¼Œå³å°†ä¸€ä¸ªè¿›ç¨‹å…³è”åˆ°ä¸€ä¸ªTypeï¼Œæˆ–è€…å°†ä¸€ä¸ªæ–‡ä»¶å…³è”åˆ°ä¸€ä¸ªTypeï¼Œæ˜¯é€šè¿‡contextæ¥å®Œæˆçš„ã€‚ è¿›ç¨‹Contextï¼ˆseapp_contextsï¼‰ ä¸€ä¸ªè¿›ç¨‹çš„Contextæ¡ç›®å¯èƒ½å¦‚ä¸‹ï¼š user=_appÂ isPrivApp=trueÂ name=com.android.vzwomatriggerÂ domain=vzwomatrigger_appÂ type=privapp_data_fileÂ levelFrom=all user=_appä»£è¡¨è¿™æ˜¯ä¸€ä¸ªå¸¸è§„çš„appï¼› isPrivApp=trueä»£è¡¨è¿™æ˜¯ä¸€ä¸ªé¢„ç½®appï¼› name=com.android.vzwomatriggerÂ æŒ‡å®šäº†è¿›ç¨‹å domain=vzwomatrigger_appÂ å°†è¿›ç¨‹åå…³è”åˆ°ä¸€ä¸ªtype type=privapp_data_fileÂ è¿™æ˜¯ä¸€ä¸ªæ–‡ä»¶typeï¼ŒæŒ‡å®šäº†appçš„dataÂ directoryç›®å½•æ‰€å±çš„type levelFrom=allÂ MLS/MCSçš„levelç›¸å…³ AOSPå†…ç½®è¿›ç¨‹Contextè§platform/system/sepolicy/private/seapp_contexts ä¾›åº”å•†æˆ–å‚å•†è¦å®šä¹‰è‡ªå·±çš„seapp_contextï¼Œå°†åœ¨/venderä¸‹æˆ–/device/manufacturer/device-name/sepolicyä¸‹ç›¸åº”ç›®å½•æ·»åŠ  æ–‡ä»¶Context ä¸€ä¸ªæ–‡ä»¶çš„Contextå¯èƒ½è¿™æ ·ï¼š /system/bin/bccÂ u:object_r:rs_exec:s0 /system/bin/bccÂ æŒ‡çš„æ˜¯å…·ä½“æ–‡ä»¶ u:object_r:rs_exec:s0æ˜¯ä¸€ä¸ªsecurityÂ contextã€‚å…¶ä¸­çš„rs_execä¸ºtypeã€‚è¿™æ ·æ–‡ä»¶å’Œtypeå°±è¿›è¡Œäº†å…³è” SecurityÂ Context å…¶æ ¼å¼ä¸ºï¼š user:role:type:sensitivity[:categories] åœ¨Androidä¸­ï¼Œ useræ˜¯å›ºå®šçš„ï¼Œæ°¸è¿œä¸ºu roleæ˜¯å›ºå®šçš„ï¼Œè®¿é—®è€…ï¼ˆç§°subjectæˆ–sourceï¼‰æ°¸è¿œä¸ºrï¼›è¢«è®¿é—®è€…ï¼ˆç§°objectæˆ–targetï¼‰æ°¸è¿œä¸ºobject_rã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿›ç¨‹ä¸€æ–¹å°±æ˜¯subjectï¼Œæ–‡ä»¶ä¸€æ–¹å°±æ˜¯objectï¼Œæ‰€ä»¥ä¸€èˆ¬è¿›ç¨‹çš„roleä¸ºrï¼Œæ–‡ä»¶çš„roleä¸ºobject_rã€‚ typeä¸ºä¸æ–‡ä»¶å…³è”çš„type sensitivityæ˜¯å›ºå®šçš„ï¼Œæ°¸è¿œä¸ºs0 categoriesæ˜¯Multi-LevelÂ SecurityÂ (MLS)Â åè®®ï¼Œç”¨æ¥éš”ç¦»ä¸€ä¸ªappçš„dataï¼Œé˜²æ­¢è¢«å¦ä¸€ä¸ªappè®¿é—®ï¼Œæˆ–è€…éš”ç¦»ä¸åŒç”¨æˆ·é—´å¯¹åŒä¸€ä¸ªappÂ dataçš„è®¿é—®ã€‚ AOSPå†…ç½®çš„æ–‡ä»¶Contextè§platform/system/sepolicy/private/file_contexts seinfo seapp_contexté‡Œé™¤äº†å¯ä»¥å°†ä¸€ä¸ªå…·ä½“åº”ç”¨æ˜ å°„åˆ°ä¸€ä¸ªdomainï¼Œä¹Ÿå¯ä»¥å°†seinfæ˜ å°„åˆ°domainã€‚mac_permissions.xmlé‡Œå®šä¹‰äº†seinfoã€‚å…¶ä¼šæ ¹æ®appæ‰€å±çš„signatureæ¥ä¸ºå…¶åˆ†é…ä¸€ä¸ªseinfoã€‚ æ¯”å¦‚ï¼š platform/system/sepolicy/private/mac_permissions.xml ä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰æ‹¥æœ‰PLATFORM signatureçš„appï¼Œå°†æ‹¥æœ‰platformè¿™ä¸ªseinfoã€‚åœ¨seapp_contextä¸­å¯ä»¥å¦‚ä¸‹é…ç½®ï¼š user=radio seinfo=platform domain=radio type=radio_data_file æ‰€æœ‰æ‹¥æœ‰platformç­¾åçš„ï¼Œå¹¶ä¸”æœªé…ç½®å…·ä½“contextçš„appï¼Œå°†éµå¾ªå…¶seinfo platformçš„è§„åˆ™ã€‚ untrusted**_app** æ—¢ä¸ºé…ç½®seinfoï¼Œåˆæœªé…ç½®seapp_contextçš„appï¼Œå°†é»˜è®¤ä¸ºuntrusted_appã€‚å„çº§seapp_contextä¸­ä¹Ÿæœ‰å¯¹untrusted_appçš„æƒé™é…ç½®ã€‚ æŸ¥çœ‹å½“å‰Context è¦çœ‹è¿›ç¨‹çš„Contextï¼Œä½¿ç”¨psÂ -Z emu64xa:/ $ ps -AZ | grep google u:r:hal_camera_default:s0 system 362 1 10891800 3272 0 0 S android.hardware.camera.provider@2.7-service-google u:r:permissioncontroller_app:s0:c179,c256,c512,c768 u0_a179 976 354 13918328 83660 0 0 S com.google.android.permissioncontroller u:r:bluetooth:s0 bluetooth 1033 354 14050488 73628 0 0 S com.google.android.bluetooth u:r:priv_app:s0:c512,c768 u0_a167 1090 354 14016372 119796 0 0 S com.google.android.apps.nexuslauncher u:r:priv_app:s0:c512,c768 u0_a170 1157 354 13873728 68724 0 0 S com.google.android.ext.services u:r:untrusted_app_32:s0:c142,c256,c512,c768 u0_a142 1393 354 14070168 104520 0 0 S com.google.android.inputmethod.latin æŸ¥çœ‹æ–‡ä»¶çš„Contextï¼Œä½¿ç”¨ emu64xa:/ $ ls -Z u:object_r:cgroup:s0 acct u:object_r:tmpfs:s0 debug_ramdisk u:object_r:vendor_file:s0 odm u:object_r:sysfs:s0 sys u:object_r:apex_mnt_dir:s0 apex u:object_r:device:s0 dev u:object_r:vendor_file:s0 odm_dlkm u:object_r:system_file:s0 system u:object_r:rootfs:s0 bin u:object_r:rootfs:s0 etc u:object_r:oemfs:s0 oem ? ... ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:1:3","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#untrusted_app"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"2.3Â Context ä¸Šé¢æ‰€è¯´çš„â€œæ˜ å°„â€ï¼Œå³å°†ä¸€ä¸ªè¿›ç¨‹å…³è”åˆ°ä¸€ä¸ªTypeï¼Œæˆ–è€…å°†ä¸€ä¸ªæ–‡ä»¶å…³è”åˆ°ä¸€ä¸ªTypeï¼Œæ˜¯é€šè¿‡contextæ¥å®Œæˆçš„ã€‚ è¿›ç¨‹Contextï¼ˆseapp_contextsï¼‰ ä¸€ä¸ªè¿›ç¨‹çš„Contextæ¡ç›®å¯èƒ½å¦‚ä¸‹ï¼š user=_appÂ isPrivApp=trueÂ name=com.android.vzwomatriggerÂ domain=vzwomatrigger_appÂ type=privapp_data_fileÂ levelFrom=all user=_appä»£è¡¨è¿™æ˜¯ä¸€ä¸ªå¸¸è§„çš„appï¼› isPrivApp=trueä»£è¡¨è¿™æ˜¯ä¸€ä¸ªé¢„ç½®appï¼› name=com.android.vzwomatriggerÂ æŒ‡å®šäº†è¿›ç¨‹å domain=vzwomatrigger_appÂ å°†è¿›ç¨‹åå…³è”åˆ°ä¸€ä¸ªtype type=privapp_data_fileÂ è¿™æ˜¯ä¸€ä¸ªæ–‡ä»¶typeï¼ŒæŒ‡å®šäº†appçš„dataÂ directoryç›®å½•æ‰€å±çš„type levelFrom=allÂ MLS/MCSçš„levelç›¸å…³ AOSPå†…ç½®è¿›ç¨‹Contextè§platform/system/sepolicy/private/seapp_contexts ä¾›åº”å•†æˆ–å‚å•†è¦å®šä¹‰è‡ªå·±çš„seapp_contextï¼Œå°†åœ¨/venderä¸‹æˆ–/device/manufacturer/device-name/sepolicyä¸‹ç›¸åº”ç›®å½•æ·»åŠ  æ–‡ä»¶Context ä¸€ä¸ªæ–‡ä»¶çš„Contextå¯èƒ½è¿™æ ·ï¼š /system/bin/bccÂ u:object_r:rs_exec:s0 /system/bin/bccÂ æŒ‡çš„æ˜¯å…·ä½“æ–‡ä»¶ u:object_r:rs_exec:s0æ˜¯ä¸€ä¸ªsecurityÂ contextã€‚å…¶ä¸­çš„rs_execä¸ºtypeã€‚è¿™æ ·æ–‡ä»¶å’Œtypeå°±è¿›è¡Œäº†å…³è” SecurityÂ Context å…¶æ ¼å¼ä¸ºï¼š user:role:type:sensitivity[:categories] åœ¨Androidä¸­ï¼Œ useræ˜¯å›ºå®šçš„ï¼Œæ°¸è¿œä¸ºu roleæ˜¯å›ºå®šçš„ï¼Œè®¿é—®è€…ï¼ˆç§°subjectæˆ–sourceï¼‰æ°¸è¿œä¸ºrï¼›è¢«è®¿é—®è€…ï¼ˆç§°objectæˆ–targetï¼‰æ°¸è¿œä¸ºobject_rã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿›ç¨‹ä¸€æ–¹å°±æ˜¯subjectï¼Œæ–‡ä»¶ä¸€æ–¹å°±æ˜¯objectï¼Œæ‰€ä»¥ä¸€èˆ¬è¿›ç¨‹çš„roleä¸ºrï¼Œæ–‡ä»¶çš„roleä¸ºobject_rã€‚ typeä¸ºä¸æ–‡ä»¶å…³è”çš„type sensitivityæ˜¯å›ºå®šçš„ï¼Œæ°¸è¿œä¸ºs0 categoriesæ˜¯Multi-LevelÂ SecurityÂ (MLS)Â åè®®ï¼Œç”¨æ¥éš”ç¦»ä¸€ä¸ªappçš„dataï¼Œé˜²æ­¢è¢«å¦ä¸€ä¸ªappè®¿é—®ï¼Œæˆ–è€…éš”ç¦»ä¸åŒç”¨æˆ·é—´å¯¹åŒä¸€ä¸ªappÂ dataçš„è®¿é—®ã€‚ AOSPå†…ç½®çš„æ–‡ä»¶Contextè§platform/system/sepolicy/private/file_contexts seinfo seapp_contexté‡Œé™¤äº†å¯ä»¥å°†ä¸€ä¸ªå…·ä½“åº”ç”¨æ˜ å°„åˆ°ä¸€ä¸ªdomainï¼Œä¹Ÿå¯ä»¥å°†seinfæ˜ å°„åˆ°domainã€‚mac_permissions.xmlé‡Œå®šä¹‰äº†seinfoã€‚å…¶ä¼šæ ¹æ®appæ‰€å±çš„signatureæ¥ä¸ºå…¶åˆ†é…ä¸€ä¸ªseinfoã€‚ æ¯”å¦‚ï¼š platform/system/sepolicy/private/mac_permissions.xml ä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰æ‹¥æœ‰PLATFORM signatureçš„appï¼Œå°†æ‹¥æœ‰platformè¿™ä¸ªseinfoã€‚åœ¨seapp_contextä¸­å¯ä»¥å¦‚ä¸‹é…ç½®ï¼š user=radio seinfo=platform domain=radio type=radio_data_file æ‰€æœ‰æ‹¥æœ‰platformç­¾åçš„ï¼Œå¹¶ä¸”æœªé…ç½®å…·ä½“contextçš„appï¼Œå°†éµå¾ªå…¶seinfo platformçš„è§„åˆ™ã€‚ untrusted**_app** æ—¢ä¸ºé…ç½®seinfoï¼Œåˆæœªé…ç½®seapp_contextçš„appï¼Œå°†é»˜è®¤ä¸ºuntrusted_appã€‚å„çº§seapp_contextä¸­ä¹Ÿæœ‰å¯¹untrusted_appçš„æƒé™é…ç½®ã€‚ æŸ¥çœ‹å½“å‰Context è¦çœ‹è¿›ç¨‹çš„Contextï¼Œä½¿ç”¨psÂ -Z emu64xa:/ $ ps -AZ | grep google u:r:hal_camera_default:s0 system 362 1 10891800 3272 0 0 S android.hardware.camera.provider@2.7-service-google u:r:permissioncontroller_app:s0:c179,c256,c512,c768 u0_a179 976 354 13918328 83660 0 0 S com.google.android.permissioncontroller u:r:bluetooth:s0 bluetooth 1033 354 14050488 73628 0 0 S com.google.android.bluetooth u:r:priv_app:s0:c512,c768 u0_a167 1090 354 14016372 119796 0 0 S com.google.android.apps.nexuslauncher u:r:priv_app:s0:c512,c768 u0_a170 1157 354 13873728 68724 0 0 S com.google.android.ext.services u:r:untrusted_app_32:s0:c142,c256,c512,c768 u0_a142 1393 354 14070168 104520 0 0 S com.google.android.inputmethod.latin æŸ¥çœ‹æ–‡ä»¶çš„Contextï¼Œä½¿ç”¨ emu64xa:/ $ ls -Z u:object_r:cgroup:s0 acct u:object_r:tmpfs:s0 debug_ramdisk u:object_r:vendor_file:s0 odm u:object_r:sysfs:s0 sys u:object_r:apex_mnt_dir:s0 apex u:object_r:device:s0 dev u:object_r:vendor_file:s0 odm_dlkm u:object_r:system_file:s0 system u:object_r:rootfs:s0 bin u:object_r:rootfs:s0 etc u:object_r:oemfs:s0 oem ? ... ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:1:3","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#æŸ¥çœ‹å½“å‰context"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"3. SeLinuxçš„é…ç½® å‚è§https://android.googlesource.com/platform/system/sepolicy/ ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#3-selinuxçš„é…ç½®"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"3**.**1 SeLinuxæ–‡ä»¶ä½“ç³» ä¹‹å‰æåˆ°Androidæ¶æ„ä¸­å¤§è‡´åŒ…å«AOSPã€å‚å•†ã€Vendorç­‰éƒ¨åˆ†ã€‚åœ¨Android 8ä»¥ä¸Šçš„ç³»ç»Ÿä¸­ï¼ŒAOSPå’Œå‚å•†ã€ä¾›åº”å•†çš„éƒ¨åˆ†æ˜¯ç‹¬ç«‹é…ç½®çš„ï¼Œæ–¹ä¾¿OTAæ›´æ–°ã€‚ é’ˆå¯¹è¿™ç§æ¶æ„ï¼ŒSeLinuxçš„Policyæ–‡ä»¶ä½“ç³»åŒ…å«ä»¥ä¸‹ç›®å½•ï¼š system/sepolicy/publicï¼šè¿™éƒ¨åˆ†æ˜¯AOSPå…¬å¼€ç»™venderä½¿ç”¨çš„ï¼Œä½œä¸ºå…¶åŸºç¡€apiã€‚æ¯”å¦‚å£°æ˜äº†domainçš„attributeå°±åœ¨è¿™ä¸‹é¢ï¼šplatform/system/sepolicy/public/attributesã€‚è¿™éƒ¨åˆ†Policyéœ€è¦åšå…¼å®¹å¤„ç†ï¼Œå› ä¸ºVenderå¼•ç”¨äº†è¿™é‡Œpolicyï¼Œå¦‚æœOTAå•ç‹¬å‡çº§äº†AOSPï¼Œéœ€è¦åšå‘åå…¼å®¹å¤„ç†ã€‚è¯¦è§https://source.android.com/docs/security/features/selinux/compatibility system/sepolicy/privateï¼šAOSPå†…éƒ¨ä½¿ç”¨çš„ï¼Œå³system imageå†…éƒ¨ç”¨çš„policyã€‚venderä¸åº”è¯¥æ„ŸçŸ¥åˆ°è¿™éƒ¨åˆ†policy system/sepolicy/vendorï¼švenderéƒ¨åˆ†çš„policy device/manufacturer/device-name/sepolicyï¼šç‰¹å®šè®¾å¤‡çš„policyï¼Œæ¯”å¦‚ä¸‰æ˜Ÿè®¾å¤‡ï¼šdevice/samsung/tuna/sepolicy BoardConfig.mkÂ makefile AOSPçš„SeLinux Policyæ–‡ä»¶ä¸€èˆ¬ä¸éœ€è¦æ›´æ”¹ï¼Œæˆ–å°‘é‡æ›´æ”¹ã€‚å‚å•†ä¾§ä¸»è¦ä¿®æ”¹å’Œå®šåˆ¶çš„Policyåœ¨/device/manufacturer/device-name/ä¸‹ï¼Œ/device/manufacturer/device-name/BoardConfig.mkç”¨äºæŒ‡å®šPolicyæ–‡ä»¶çš„å…·ä½“è·¯å¾„ï¼Œé€šè¿‡BOARD_VENDOR_SEPOLICY_DIRSï¼Œæ¯”å¦‚ï¼š device/samsung/tuna/BoardConfig.mk BOARD_VENDOR_SEPOLICY_DIRSÂ +=Â device/samsung/tuna/sepolicy system_extÂ å’ŒÂ productåˆ†åŒº åœ¨AndroidÂ 11åŠä»¥ä¸Šç³»ç»Ÿä¸­ï¼Œsystem_extÂ å’ŒÂ productåˆ†åŒºä¹Ÿç‹¬ç«‹å‡ºå•ç‹¬çš„policyï¼Œå¹¶ä¸”åŒºåˆ†äº†publicå’Œprivateã€‚publicéƒ¨åˆ†åŒæ ·å…±venderå¼•ç”¨ã€‚system_extå’Œproductçš„ç‰ˆæœ¬å…¼å®¹å¤„ç†ç”±å„partnerè‡ªå·±è´Ÿè´£ï¼ŒAOSPä¸è´Ÿè´£ã€‚ SYSTEM_EXT_PUBLIC_SEPOLICY_DIRSï¼šæŒ‡å®šsystem_extçš„publicçš„ç›®å½•ï¼Œå®‰è£…åˆ°system_extåˆ†åŒºã€‚ SYSTEM_EXT_PRIVATE_SEPOLICY_DIRSï¼šæŒ‡å®šsystem_extçš„privateç›®å½•ã€‚system_extå†…éƒ¨ä½¿ç”¨ã€‚å®‰è£…åˆ°system_extåˆ†åŒº PRODUCT_PUBLIC_SEPOLICY_DIRSï¼šæŒ‡å®šproductåˆ†åŒºçš„publicç›®å½•ã€‚å®‰è£…åˆ°productåˆ†åŒº PRODUCT_PRIVATE_SEPOLICY_DIRSï¼šæŒ‡å®šproductçš„privateç›®å½•ã€‚å®‰è£…åˆ°productåˆ†åŒºã€‚ ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:2:1","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#31-selinux"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"3**.**1 SeLinuxæ–‡ä»¶ä½“ç³» ä¹‹å‰æåˆ°Androidæ¶æ„ä¸­å¤§è‡´åŒ…å«AOSPã€å‚å•†ã€Vendorç­‰éƒ¨åˆ†ã€‚åœ¨Android 8ä»¥ä¸Šçš„ç³»ç»Ÿä¸­ï¼ŒAOSPå’Œå‚å•†ã€ä¾›åº”å•†çš„éƒ¨åˆ†æ˜¯ç‹¬ç«‹é…ç½®çš„ï¼Œæ–¹ä¾¿OTAæ›´æ–°ã€‚ é’ˆå¯¹è¿™ç§æ¶æ„ï¼ŒSeLinuxçš„Policyæ–‡ä»¶ä½“ç³»åŒ…å«ä»¥ä¸‹ç›®å½•ï¼š system/sepolicy/publicï¼šè¿™éƒ¨åˆ†æ˜¯AOSPå…¬å¼€ç»™venderä½¿ç”¨çš„ï¼Œä½œä¸ºå…¶åŸºç¡€apiã€‚æ¯”å¦‚å£°æ˜äº†domainçš„attributeå°±åœ¨è¿™ä¸‹é¢ï¼šplatform/system/sepolicy/public/attributesã€‚è¿™éƒ¨åˆ†Policyéœ€è¦åšå…¼å®¹å¤„ç†ï¼Œå› ä¸ºVenderå¼•ç”¨äº†è¿™é‡Œpolicyï¼Œå¦‚æœOTAå•ç‹¬å‡çº§äº†AOSPï¼Œéœ€è¦åšå‘åå…¼å®¹å¤„ç†ã€‚è¯¦è§https://source.android.com/docs/security/features/selinux/compatibility system/sepolicy/privateï¼šAOSPå†…éƒ¨ä½¿ç”¨çš„ï¼Œå³system imageå†…éƒ¨ç”¨çš„policyã€‚venderä¸åº”è¯¥æ„ŸçŸ¥åˆ°è¿™éƒ¨åˆ†policy system/sepolicy/vendorï¼švenderéƒ¨åˆ†çš„policy device/manufacturer/device-name/sepolicyï¼šç‰¹å®šè®¾å¤‡çš„policyï¼Œæ¯”å¦‚ä¸‰æ˜Ÿè®¾å¤‡ï¼šdevice/samsung/tuna/sepolicy BoardConfig.mkÂ makefile AOSPçš„SeLinux Policyæ–‡ä»¶ä¸€èˆ¬ä¸éœ€è¦æ›´æ”¹ï¼Œæˆ–å°‘é‡æ›´æ”¹ã€‚å‚å•†ä¾§ä¸»è¦ä¿®æ”¹å’Œå®šåˆ¶çš„Policyåœ¨/device/manufacturer/device-name/ä¸‹ï¼Œ/device/manufacturer/device-name/BoardConfig.mkç”¨äºæŒ‡å®šPolicyæ–‡ä»¶çš„å…·ä½“è·¯å¾„ï¼Œé€šè¿‡BOARD_VENDOR_SEPOLICY_DIRSï¼Œæ¯”å¦‚ï¼š device/samsung/tuna/BoardConfig.mk BOARD_VENDOR_SEPOLICY_DIRSÂ +=Â device/samsung/tuna/sepolicy system_extÂ å’ŒÂ productåˆ†åŒº åœ¨AndroidÂ 11åŠä»¥ä¸Šç³»ç»Ÿä¸­ï¼Œsystem_extÂ å’ŒÂ productåˆ†åŒºä¹Ÿç‹¬ç«‹å‡ºå•ç‹¬çš„policyï¼Œå¹¶ä¸”åŒºåˆ†äº†publicå’Œprivateã€‚publicéƒ¨åˆ†åŒæ ·å…±venderå¼•ç”¨ã€‚system_extå’Œproductçš„ç‰ˆæœ¬å…¼å®¹å¤„ç†ç”±å„partnerè‡ªå·±è´Ÿè´£ï¼ŒAOSPä¸è´Ÿè´£ã€‚ SYSTEM_EXT_PUBLIC_SEPOLICY_DIRSï¼šæŒ‡å®šsystem_extçš„publicçš„ç›®å½•ï¼Œå®‰è£…åˆ°system_extåˆ†åŒºã€‚ SYSTEM_EXT_PRIVATE_SEPOLICY_DIRSï¼šæŒ‡å®šsystem_extçš„privateç›®å½•ã€‚system_extå†…éƒ¨ä½¿ç”¨ã€‚å®‰è£…åˆ°system_extåˆ†åŒº PRODUCT_PUBLIC_SEPOLICY_DIRSï¼šæŒ‡å®šproductåˆ†åŒºçš„publicç›®å½•ã€‚å®‰è£…åˆ°productåˆ†åŒº PRODUCT_PRIVATE_SEPOLICY_DIRSï¼šæŒ‡å®šproductçš„privateç›®å½•ã€‚å®‰è£…åˆ°productåˆ†åŒºã€‚ ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:2:1","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#boardconfigmkmakefile"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"3**.**1 SeLinuxæ–‡ä»¶ä½“ç³» ä¹‹å‰æåˆ°Androidæ¶æ„ä¸­å¤§è‡´åŒ…å«AOSPã€å‚å•†ã€Vendorç­‰éƒ¨åˆ†ã€‚åœ¨Android 8ä»¥ä¸Šçš„ç³»ç»Ÿä¸­ï¼ŒAOSPå’Œå‚å•†ã€ä¾›åº”å•†çš„éƒ¨åˆ†æ˜¯ç‹¬ç«‹é…ç½®çš„ï¼Œæ–¹ä¾¿OTAæ›´æ–°ã€‚ é’ˆå¯¹è¿™ç§æ¶æ„ï¼ŒSeLinuxçš„Policyæ–‡ä»¶ä½“ç³»åŒ…å«ä»¥ä¸‹ç›®å½•ï¼š system/sepolicy/publicï¼šè¿™éƒ¨åˆ†æ˜¯AOSPå…¬å¼€ç»™venderä½¿ç”¨çš„ï¼Œä½œä¸ºå…¶åŸºç¡€apiã€‚æ¯”å¦‚å£°æ˜äº†domainçš„attributeå°±åœ¨è¿™ä¸‹é¢ï¼šplatform/system/sepolicy/public/attributesã€‚è¿™éƒ¨åˆ†Policyéœ€è¦åšå…¼å®¹å¤„ç†ï¼Œå› ä¸ºVenderå¼•ç”¨äº†è¿™é‡Œpolicyï¼Œå¦‚æœOTAå•ç‹¬å‡çº§äº†AOSPï¼Œéœ€è¦åšå‘åå…¼å®¹å¤„ç†ã€‚è¯¦è§https://source.android.com/docs/security/features/selinux/compatibility system/sepolicy/privateï¼šAOSPå†…éƒ¨ä½¿ç”¨çš„ï¼Œå³system imageå†…éƒ¨ç”¨çš„policyã€‚venderä¸åº”è¯¥æ„ŸçŸ¥åˆ°è¿™éƒ¨åˆ†policy system/sepolicy/vendorï¼švenderéƒ¨åˆ†çš„policy device/manufacturer/device-name/sepolicyï¼šç‰¹å®šè®¾å¤‡çš„policyï¼Œæ¯”å¦‚ä¸‰æ˜Ÿè®¾å¤‡ï¼šdevice/samsung/tuna/sepolicy BoardConfig.mkÂ makefile AOSPçš„SeLinux Policyæ–‡ä»¶ä¸€èˆ¬ä¸éœ€è¦æ›´æ”¹ï¼Œæˆ–å°‘é‡æ›´æ”¹ã€‚å‚å•†ä¾§ä¸»è¦ä¿®æ”¹å’Œå®šåˆ¶çš„Policyåœ¨/device/manufacturer/device-name/ä¸‹ï¼Œ/device/manufacturer/device-name/BoardConfig.mkç”¨äºæŒ‡å®šPolicyæ–‡ä»¶çš„å…·ä½“è·¯å¾„ï¼Œé€šè¿‡BOARD_VENDOR_SEPOLICY_DIRSï¼Œæ¯”å¦‚ï¼š device/samsung/tuna/BoardConfig.mk BOARD_VENDOR_SEPOLICY_DIRSÂ +=Â device/samsung/tuna/sepolicy system_extÂ å’ŒÂ productåˆ†åŒº åœ¨AndroidÂ 11åŠä»¥ä¸Šç³»ç»Ÿä¸­ï¼Œsystem_extÂ å’ŒÂ productåˆ†åŒºä¹Ÿç‹¬ç«‹å‡ºå•ç‹¬çš„policyï¼Œå¹¶ä¸”åŒºåˆ†äº†publicå’Œprivateã€‚publicéƒ¨åˆ†åŒæ ·å…±venderå¼•ç”¨ã€‚system_extå’Œproductçš„ç‰ˆæœ¬å…¼å®¹å¤„ç†ç”±å„partnerè‡ªå·±è´Ÿè´£ï¼ŒAOSPä¸è´Ÿè´£ã€‚ SYSTEM_EXT_PUBLIC_SEPOLICY_DIRSï¼šæŒ‡å®šsystem_extçš„publicçš„ç›®å½•ï¼Œå®‰è£…åˆ°system_extåˆ†åŒºã€‚ SYSTEM_EXT_PRIVATE_SEPOLICY_DIRSï¼šæŒ‡å®šsystem_extçš„privateç›®å½•ã€‚system_extå†…éƒ¨ä½¿ç”¨ã€‚å®‰è£…åˆ°system_extåˆ†åŒº PRODUCT_PUBLIC_SEPOLICY_DIRSï¼šæŒ‡å®šproductåˆ†åŒºçš„publicç›®å½•ã€‚å®‰è£…åˆ°productåˆ†åŒº PRODUCT_PRIVATE_SEPOLICY_DIRSï¼šæŒ‡å®šproductçš„privateç›®å½•ã€‚å®‰è£…åˆ°productåˆ†åŒºã€‚ ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:2:1","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#system_extå’Œproductåˆ†åŒº"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"3**.2**Â Policyæ–‡ä»¶ æŠŠSeLinuxç­–ç•¥é…ç½®ç›¸å…³çš„æ–‡ä»¶ç»Ÿç§°ä¸ºPolicyæ–‡ä»¶ Policyæ–‡ä»¶ä¸€èˆ¬åŒ…å«ï¼š TE****æ–‡ä»¶ å°±æ˜¯ä¸€å †.teæ–‡ä»¶ã€‚TEé‡Œå®šä¹‰äº†Typeã€è®¿é—®è§„åˆ™ç­‰ã€‚å¯¹è¿›ç¨‹å’Œæ–‡ä»¶Typeçš„å®šä¹‰ã€è®¿é—®è§„åˆ™çš„å®šåˆ¶å°±åªåœ¨TEé‡Œå®Œæˆçš„ã€‚ä¸€èˆ¬æ¯ä¸ªè¿›ç¨‹æœ‰ä¸€ä¸ªç‹¬ç«‹çš„teæ–‡ä»¶ï¼Œè€Œæ‰€æœ‰æ–‡ä»¶çš„teç»Ÿä¸€å£°æ˜åœ¨ä¸€ä¸ªfile.teæ–‡ä»¶ä¸­ã€‚è¯¦è§3.3èŠ‚ ContextÂ files file_contextsï¼šå‰é¢è¯´è¿‡ï¼Œfile_contextsé‡Œé¢å®šä¹‰äº†æ–‡ä»¶çš„contextï¼Œç”¨äºå°†æ–‡ä»¶ç›®å½•å’Œæ–‡ä»¶çš„typeå…³è”èµ·æ¥ã€‚ genfs_contextsï¼šç”¨äºå°†æ–‡ä»¶ç³»ç»Ÿï¼ˆæ¯”å¦‚/procå’Œvfatï¼‰ä¸typeå…³è”èµ·æ¥ã€‚ property_contextsï¼šç”¨äºå°†Androidç³»ç»Ÿpropertiesä¸typeå…³è”èµ·æ¥ service_contextsï¼šç”¨äºå°†serviceè¿›ç¨‹ä¸typeå…³è” seapp_contextsï¼šç”¨äºå°†appä¸typeå…³è” mac_permissions.xmlï¼šæ ¹æ®appçš„signatureæˆ–åŒ…åï¼Œä¸ºappåˆ†é…ä¸€ä¸ªseinfoã€‚seinfoç”¨äºåœ¨appæ²¡æœ‰æ˜ç¡®å…³è”ä¸€ä¸ªtypeæ—¶å½’å±ä¸€ä¸ªé»˜è®¤typeã€‚ keystore2_key_contexts ï¼šä¸ºKeystoreÂ 2.0Â namespacesåˆ†é…ä¸€ä¸ªlabelã€‚ Attribute ç”¨æ¥å£°æ˜Attribute security_classes ç”¨æ¥å£°æ˜Class ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:2:2","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#32policyæ–‡ä»¶"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"3**.2**Â Policyæ–‡ä»¶ æŠŠSeLinuxç­–ç•¥é…ç½®ç›¸å…³çš„æ–‡ä»¶ç»Ÿç§°ä¸ºPolicyæ–‡ä»¶ Policyæ–‡ä»¶ä¸€èˆ¬åŒ…å«ï¼š TE****æ–‡ä»¶ å°±æ˜¯ä¸€å †.teæ–‡ä»¶ã€‚TEé‡Œå®šä¹‰äº†Typeã€è®¿é—®è§„åˆ™ç­‰ã€‚å¯¹è¿›ç¨‹å’Œæ–‡ä»¶Typeçš„å®šä¹‰ã€è®¿é—®è§„åˆ™çš„å®šåˆ¶å°±åªåœ¨TEé‡Œå®Œæˆçš„ã€‚ä¸€èˆ¬æ¯ä¸ªè¿›ç¨‹æœ‰ä¸€ä¸ªç‹¬ç«‹çš„teæ–‡ä»¶ï¼Œè€Œæ‰€æœ‰æ–‡ä»¶çš„teç»Ÿä¸€å£°æ˜åœ¨ä¸€ä¸ªfile.teæ–‡ä»¶ä¸­ã€‚è¯¦è§3.3èŠ‚ ContextÂ files file_contextsï¼šå‰é¢è¯´è¿‡ï¼Œfile_contextsé‡Œé¢å®šä¹‰äº†æ–‡ä»¶çš„contextï¼Œç”¨äºå°†æ–‡ä»¶ç›®å½•å’Œæ–‡ä»¶çš„typeå…³è”èµ·æ¥ã€‚ genfs_contextsï¼šç”¨äºå°†æ–‡ä»¶ç³»ç»Ÿï¼ˆæ¯”å¦‚/procå’Œvfatï¼‰ä¸typeå…³è”èµ·æ¥ã€‚ property_contextsï¼šç”¨äºå°†Androidç³»ç»Ÿpropertiesä¸typeå…³è”èµ·æ¥ service_contextsï¼šç”¨äºå°†serviceè¿›ç¨‹ä¸typeå…³è” seapp_contextsï¼šç”¨äºå°†appä¸typeå…³è” mac_permissions.xmlï¼šæ ¹æ®appçš„signatureæˆ–åŒ…åï¼Œä¸ºappåˆ†é…ä¸€ä¸ªseinfoã€‚seinfoç”¨äºåœ¨appæ²¡æœ‰æ˜ç¡®å…³è”ä¸€ä¸ªtypeæ—¶å½’å±ä¸€ä¸ªé»˜è®¤typeã€‚ keystore2_key_contexts ï¼šä¸ºKeystoreÂ 2.0Â namespacesåˆ†é…ä¸€ä¸ªlabelã€‚ Attribute ç”¨æ¥å£°æ˜Attribute security_classes ç”¨æ¥å£°æ˜Class ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:2:2","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#teæ–‡ä»¶"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"3**.2**Â Policyæ–‡ä»¶ æŠŠSeLinuxç­–ç•¥é…ç½®ç›¸å…³çš„æ–‡ä»¶ç»Ÿç§°ä¸ºPolicyæ–‡ä»¶ Policyæ–‡ä»¶ä¸€èˆ¬åŒ…å«ï¼š TE****æ–‡ä»¶ å°±æ˜¯ä¸€å †.teæ–‡ä»¶ã€‚TEé‡Œå®šä¹‰äº†Typeã€è®¿é—®è§„åˆ™ç­‰ã€‚å¯¹è¿›ç¨‹å’Œæ–‡ä»¶Typeçš„å®šä¹‰ã€è®¿é—®è§„åˆ™çš„å®šåˆ¶å°±åªåœ¨TEé‡Œå®Œæˆçš„ã€‚ä¸€èˆ¬æ¯ä¸ªè¿›ç¨‹æœ‰ä¸€ä¸ªç‹¬ç«‹çš„teæ–‡ä»¶ï¼Œè€Œæ‰€æœ‰æ–‡ä»¶çš„teç»Ÿä¸€å£°æ˜åœ¨ä¸€ä¸ªfile.teæ–‡ä»¶ä¸­ã€‚è¯¦è§3.3èŠ‚ ContextÂ files file_contextsï¼šå‰é¢è¯´è¿‡ï¼Œfile_contextsé‡Œé¢å®šä¹‰äº†æ–‡ä»¶çš„contextï¼Œç”¨äºå°†æ–‡ä»¶ç›®å½•å’Œæ–‡ä»¶çš„typeå…³è”èµ·æ¥ã€‚ genfs_contextsï¼šç”¨äºå°†æ–‡ä»¶ç³»ç»Ÿï¼ˆæ¯”å¦‚/procå’Œvfatï¼‰ä¸typeå…³è”èµ·æ¥ã€‚ property_contextsï¼šç”¨äºå°†Androidç³»ç»Ÿpropertiesä¸typeå…³è”èµ·æ¥ service_contextsï¼šç”¨äºå°†serviceè¿›ç¨‹ä¸typeå…³è” seapp_contextsï¼šç”¨äºå°†appä¸typeå…³è” mac_permissions.xmlï¼šæ ¹æ®appçš„signatureæˆ–åŒ…åï¼Œä¸ºappåˆ†é…ä¸€ä¸ªseinfoã€‚seinfoç”¨äºåœ¨appæ²¡æœ‰æ˜ç¡®å…³è”ä¸€ä¸ªtypeæ—¶å½’å±ä¸€ä¸ªé»˜è®¤typeã€‚ keystore2_key_contexts ï¼šä¸ºKeystoreÂ 2.0Â namespacesåˆ†é…ä¸€ä¸ªlabelã€‚ Attribute ç”¨æ¥å£°æ˜Attribute security_classes ç”¨æ¥å£°æ˜Class ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:2:2","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#contextfiles"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"3**.2**Â Policyæ–‡ä»¶ æŠŠSeLinuxç­–ç•¥é…ç½®ç›¸å…³çš„æ–‡ä»¶ç»Ÿç§°ä¸ºPolicyæ–‡ä»¶ Policyæ–‡ä»¶ä¸€èˆ¬åŒ…å«ï¼š TE****æ–‡ä»¶ å°±æ˜¯ä¸€å †.teæ–‡ä»¶ã€‚TEé‡Œå®šä¹‰äº†Typeã€è®¿é—®è§„åˆ™ç­‰ã€‚å¯¹è¿›ç¨‹å’Œæ–‡ä»¶Typeçš„å®šä¹‰ã€è®¿é—®è§„åˆ™çš„å®šåˆ¶å°±åªåœ¨TEé‡Œå®Œæˆçš„ã€‚ä¸€èˆ¬æ¯ä¸ªè¿›ç¨‹æœ‰ä¸€ä¸ªç‹¬ç«‹çš„teæ–‡ä»¶ï¼Œè€Œæ‰€æœ‰æ–‡ä»¶çš„teç»Ÿä¸€å£°æ˜åœ¨ä¸€ä¸ªfile.teæ–‡ä»¶ä¸­ã€‚è¯¦è§3.3èŠ‚ ContextÂ files file_contextsï¼šå‰é¢è¯´è¿‡ï¼Œfile_contextsé‡Œé¢å®šä¹‰äº†æ–‡ä»¶çš„contextï¼Œç”¨äºå°†æ–‡ä»¶ç›®å½•å’Œæ–‡ä»¶çš„typeå…³è”èµ·æ¥ã€‚ genfs_contextsï¼šç”¨äºå°†æ–‡ä»¶ç³»ç»Ÿï¼ˆæ¯”å¦‚/procå’Œvfatï¼‰ä¸typeå…³è”èµ·æ¥ã€‚ property_contextsï¼šç”¨äºå°†Androidç³»ç»Ÿpropertiesä¸typeå…³è”èµ·æ¥ service_contextsï¼šç”¨äºå°†serviceè¿›ç¨‹ä¸typeå…³è” seapp_contextsï¼šç”¨äºå°†appä¸typeå…³è” mac_permissions.xmlï¼šæ ¹æ®appçš„signatureæˆ–åŒ…åï¼Œä¸ºappåˆ†é…ä¸€ä¸ªseinfoã€‚seinfoç”¨äºåœ¨appæ²¡æœ‰æ˜ç¡®å…³è”ä¸€ä¸ªtypeæ—¶å½’å±ä¸€ä¸ªé»˜è®¤typeã€‚ keystore2_key_contexts ï¼šä¸ºKeystoreÂ 2.0Â namespacesåˆ†é…ä¸€ä¸ªlabelã€‚ Attribute ç”¨æ¥å£°æ˜Attribute security_classes ç”¨æ¥å£°æ˜Class ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:2:2","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#attribute-1"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"3**.2**Â Policyæ–‡ä»¶ æŠŠSeLinuxç­–ç•¥é…ç½®ç›¸å…³çš„æ–‡ä»¶ç»Ÿç§°ä¸ºPolicyæ–‡ä»¶ Policyæ–‡ä»¶ä¸€èˆ¬åŒ…å«ï¼š TE****æ–‡ä»¶ å°±æ˜¯ä¸€å †.teæ–‡ä»¶ã€‚TEé‡Œå®šä¹‰äº†Typeã€è®¿é—®è§„åˆ™ç­‰ã€‚å¯¹è¿›ç¨‹å’Œæ–‡ä»¶Typeçš„å®šä¹‰ã€è®¿é—®è§„åˆ™çš„å®šåˆ¶å°±åªåœ¨TEé‡Œå®Œæˆçš„ã€‚ä¸€èˆ¬æ¯ä¸ªè¿›ç¨‹æœ‰ä¸€ä¸ªç‹¬ç«‹çš„teæ–‡ä»¶ï¼Œè€Œæ‰€æœ‰æ–‡ä»¶çš„teç»Ÿä¸€å£°æ˜åœ¨ä¸€ä¸ªfile.teæ–‡ä»¶ä¸­ã€‚è¯¦è§3.3èŠ‚ ContextÂ files file_contextsï¼šå‰é¢è¯´è¿‡ï¼Œfile_contextsé‡Œé¢å®šä¹‰äº†æ–‡ä»¶çš„contextï¼Œç”¨äºå°†æ–‡ä»¶ç›®å½•å’Œæ–‡ä»¶çš„typeå…³è”èµ·æ¥ã€‚ genfs_contextsï¼šç”¨äºå°†æ–‡ä»¶ç³»ç»Ÿï¼ˆæ¯”å¦‚/procå’Œvfatï¼‰ä¸typeå…³è”èµ·æ¥ã€‚ property_contextsï¼šç”¨äºå°†Androidç³»ç»Ÿpropertiesä¸typeå…³è”èµ·æ¥ service_contextsï¼šç”¨äºå°†serviceè¿›ç¨‹ä¸typeå…³è” seapp_contextsï¼šç”¨äºå°†appä¸typeå…³è” mac_permissions.xmlï¼šæ ¹æ®appçš„signatureæˆ–åŒ…åï¼Œä¸ºappåˆ†é…ä¸€ä¸ªseinfoã€‚seinfoç”¨äºåœ¨appæ²¡æœ‰æ˜ç¡®å…³è”ä¸€ä¸ªtypeæ—¶å½’å±ä¸€ä¸ªé»˜è®¤typeã€‚ keystore2_key_contexts ï¼šä¸ºKeystoreÂ 2.0Â namespacesåˆ†é…ä¸€ä¸ªlabelã€‚ Attribute ç”¨æ¥å£°æ˜Attribute security_classes ç”¨æ¥å£°æ˜Class ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:2:2","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#security_classes"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"**3.3Â TEï¼ˆTypeÂ Enforcementï¼‰**æ–‡ä»¶ æ‰€æœ‰çš„è§„åˆ™é…ç½®ï¼Œæˆ–ç§°Policyï¼Œéƒ½å†™åœ¨.teæ–‡ä»¶ä¸­ã€‚ç¼–å†™å®ŒTEæ–‡ä»¶åï¼Œå°†TEæ–‡ä»¶æ”¾åœ¨å¯¹åº”ç›®å½•ä¸‹ï¼ŒAndroidç³»ç»Ÿç¼–è¯‘å.teæ–‡ä»¶å°†è¢«ç¼–è¯‘æˆ.cilæ–‡ä»¶ã€‚åœ¨initè¿›ç¨‹å¯åŠ¨é˜¶æ®µï¼Œä¼šå°†.cilæ–‡ä»¶æ±‡æ€»ç»Ÿä¸€ç¼–è¯‘æˆä¸€ä¸ªå‘½åä¸ºpolicyçš„æ–‡ä»¶ã€‚cilæ–‡ä»¶æ˜¯å¯è¯»çš„ï¼Œpolicyæ–‡ä»¶æ˜¯äºŒè¿›åˆ¶çš„ã€‚åœ¨ç³»ç»Ÿè¿è¡Œæ—¶æœ€ç»ˆåŠ è½½ä½¿ç”¨çš„æ˜¯policyæ–‡ä»¶ã€‚ policyæ–‡ä»¶ä¸€èˆ¬åœ¨/sys/fs/selinux/policy ä¸€èˆ¬ä¸€ä¸ªè¿›ç¨‹å•ç‹¬å£°æ˜ä¸€ä¸ªTEæ–‡ä»¶ã€‚æ¯”å¦‚ä¸€ä¸ªdhcpè¿›ç¨‹å•ç‹¬æœ‰ä¸€ä¸ªteæ–‡ä»¶å«dhcp.teã€‚è€Œæ–‡ä»¶çš„teç»Ÿä¸€æ•´åˆåœ¨file.teï¼ˆæ¯”å¦‚platform/system/sepolicy/public/file.teï¼‰ä¸­ã€‚ é’ˆå¯¹Platformï¼ˆAOSPçš„éƒ¨åˆ†ï¼‰ã€Non-Platformï¼ˆå‚å•†ã€ä¾›åº”å•†çš„éƒ¨åˆ†ï¼‰ï¼ŒTEä¼šæœ‰ä¸åŒçš„æ”¾ç½®ç›®å½•ã€‚ ä¸‹é¢æ˜¯TEæ–‡ä»¶çš„ä¸€ä¸ªä¾‹å­ï¼š platform/system/sepolicy/public/dhcp.te typeÂ dhcp,Â domain;permissiveÂ dhcp;typeÂ dhcp_exec,Â exec_type,Â file_type;typeÂ dhcp_data_file,Â file_type,Â data_file_type;init_daemon_domain(dhcp)net_domain(dhcp)allowÂ dhcpÂ self:capabilityÂ {Â setgidÂ setuidÂ net_adminÂ net_rawÂ net_bind_service};allowÂ dhcpÂ self:packet_socketÂ create_socket_perms;allowÂ dhcpÂ self:netlink_route_socketÂ {Â create_socket_permsÂ nlmsg_writeÂ };allowÂ dhcpÂ shell_exec:fileÂ rx_file_perms;allowÂ dhcpÂ system_file:fileÂ rx_file_perms;#Â ForÂ /proc/sys/net/ipv4/conf/*/promote_secondariesallowÂ dhcpÂ proc_net:file write;allowÂ dhcpÂ system_prop:property_serviceÂ setÂ ;unix_socket_connect(dhcp,Â property,Â init)type_transitionÂ dhcpÂ system_data_file:{Â dirÂ fileÂ }Â dhcp_data_file;allowÂ dhcpÂ dhcp_data_file:dirÂ create_dir_perms;allowÂ dhcpÂ dhcp_data_file:fileÂ create_file_perms;allowÂ dhcpÂ netd:fdÂ use;allowÂ dhcpÂ netd:fifo_fileÂ rw_file_perms;allowÂ dhcpÂ netd:{Â dgram_socket_class_setÂ unix_stream_socketÂ }Â {Â read writeÂ };allowÂ dhcpÂ netd:{Â netlink_kobject_uevent_socketÂ netlink_route_socketnetlink_nflog_socketÂ }Â {Â read writeÂ }; TEæ–‡ä»¶è¯­æ³•è§£æ typeÂ dhcp,Â domain;Â â€“Â å£°æ˜ä¸€ä¸ªtypeåä¸ºdhcpï¼Œå…¶ç»§æ‰¿domainè¿™ä¸ªAttributeï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨å£°æ˜æ—¶ä¾¿ç»§æ‰¿äº†domainæ‰€æ‹¥æœ‰çš„æƒé™ã€‚domainå±æ€§æ˜¯è¿›ç¨‹ä¸“ç”¨çš„ï¼Œå¾ˆæ˜¾ç„¶è¿™æ˜¯ä¸€ä¸ªè¿›ç¨‹çš„teæ–‡ä»¶ã€‚ permissiveÂ dhcp;Â â€“Â å°†dhcpæ ‡è¯†ä¸ºpermissiveæ¨¡å¼ã€‚ä¹‹å‰è¯´åˆ°ï¼ŒSeLinuxå¼€å¯æ¨¡å¼å¯ä»¥å…¨å±€è®¾ç½®ï¼Œä¹Ÿå¯ä»¥é’ˆå¯¹è¿›ç¨‹å•ç‹¬è®¾ç½®ã€‚è¿™é‡Œæ˜¯å•ç‹¬è®¾ç½®è¯¥è¿›ç¨‹çš„æ¨¡å¼ã€‚ typeÂ dhcp_exec,Â exec_type,Â file_type;Â â€“Â å£°æ˜ä¸€ä¸ªtypeåä¸ºdhcp_execï¼ŒÂ ä»å±äºexec_typeå’Œfile_typeä¸¤ä¸ªAttributeã€‚ä¹Ÿå°±æ˜¯è¯´åŒæ—¶ç»§æ‰¿ä¸¤ä¸ªAttributeæ‰€ä»£è¡¨çš„æ–‡ä»¶ã€‚exec_typeç”¨äºä»£è¡¨å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯è¿›ç¨‹çš„å¯æ‰§è¡Œæ–‡ä»¶å…¥å£ï¼›file_typeä»£è¡¨é€šç”¨æ–‡ä»¶ã€‚ä»è¿™é‡Œæˆ‘ä»¬çŸ¥é“dhcp_execä»£è¡¨dhcpå¯æ‰§è¡Œæ–‡ä»¶çš„å…¥å£ã€‚ init_daemon_domain(dhcp)Â â€“Â è¿™æ˜¯ä¸€ä¸ªå®ï¼Œä»£è¡¨è¿™æ˜¯ä¸€ä¸ªä»initå¯åŠ¨çš„è¿›ç¨‹ï¼Œå¹¶ä¸”å¯ä»¥åŒinité€šä¿¡ã€‚å®çš„æºç è§platform/system/sepolicy/public/te_macros net_domain â€“Â ä¹Ÿæ˜¯ä¸€ä¸ªå®ï¼Œå¯ä»¥è¿›è¡Œé€šç”¨çš„ç½‘ç»œæ“ä½œï¼Œæ¯”å¦‚è¯»å†™TCPåŒ…ï¼Œæ“ä½œsocketç­‰ã€‚ allowÂ dhcpÂ self:capabilityÂ {Â setgidÂ setuidÂ net_adminÂ net_rawÂ net_bind_service}; â€“ è¿™ä¸ªå°±æ˜¯å…·ä½“çš„è§„åˆ™æè¿°äº†ã€‚dhcpæ˜¯sourceæ–¹ï¼Œ selfæ˜¯targetæ–¹ï¼Œcapabilityæ˜¯ä¸€ä¸ªClassåï¼Œå…¶åæ˜¯å¯ä»¥åšçš„æ“ä½œã€‚è¿™å¥è¯æ˜¯è¯´å…è®¸dhcpè¿™ä¸ªè¿›ç¨‹å¯¹è‡ªå·±åšsetgidç­‰æ“ä½œã€‚selfå…³é”®å­—ç”¨æ¥è¡¨ç¤ºsourceå¯ä»¥å¯¹è‡ªå·±åšä»€ä¹ˆæ“ä½œã€‚ é™¤äº†ä¸Šé¢ä¾‹å­é‡Œå‡ºç°çš„å…³é”®å­—ï¼Œæœ‰æ—¶æˆ‘ä»¬è¿˜ä¼šçœ‹åˆ°typeattributeè¿™ä¸ªå…³é”®å­—ï¼šå®ƒä»£è¡¨å°†ä¹‹å‰å·²ç»å£°æ˜è¿‡çš„Typeå…³è”åˆ°ä¸€ä¸ªä¹‹å‰å£°æ˜è¿‡çš„Attributeã€‚ æ›´å¤šè¯­æ³•è§TypeStatements - SELinux Wiki ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:2:3","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#33typeenforcementæ–‡ä»¶"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"**3.3Â TEï¼ˆTypeÂ Enforcementï¼‰**æ–‡ä»¶ æ‰€æœ‰çš„è§„åˆ™é…ç½®ï¼Œæˆ–ç§°Policyï¼Œéƒ½å†™åœ¨.teæ–‡ä»¶ä¸­ã€‚ç¼–å†™å®ŒTEæ–‡ä»¶åï¼Œå°†TEæ–‡ä»¶æ”¾åœ¨å¯¹åº”ç›®å½•ä¸‹ï¼ŒAndroidç³»ç»Ÿç¼–è¯‘å.teæ–‡ä»¶å°†è¢«ç¼–è¯‘æˆ.cilæ–‡ä»¶ã€‚åœ¨initè¿›ç¨‹å¯åŠ¨é˜¶æ®µï¼Œä¼šå°†.cilæ–‡ä»¶æ±‡æ€»ç»Ÿä¸€ç¼–è¯‘æˆä¸€ä¸ªå‘½åä¸ºpolicyçš„æ–‡ä»¶ã€‚cilæ–‡ä»¶æ˜¯å¯è¯»çš„ï¼Œpolicyæ–‡ä»¶æ˜¯äºŒè¿›åˆ¶çš„ã€‚åœ¨ç³»ç»Ÿè¿è¡Œæ—¶æœ€ç»ˆåŠ è½½ä½¿ç”¨çš„æ˜¯policyæ–‡ä»¶ã€‚ policyæ–‡ä»¶ä¸€èˆ¬åœ¨/sys/fs/selinux/policy ä¸€èˆ¬ä¸€ä¸ªè¿›ç¨‹å•ç‹¬å£°æ˜ä¸€ä¸ªTEæ–‡ä»¶ã€‚æ¯”å¦‚ä¸€ä¸ªdhcpè¿›ç¨‹å•ç‹¬æœ‰ä¸€ä¸ªteæ–‡ä»¶å«dhcp.teã€‚è€Œæ–‡ä»¶çš„teç»Ÿä¸€æ•´åˆåœ¨file.teï¼ˆæ¯”å¦‚platform/system/sepolicy/public/file.teï¼‰ä¸­ã€‚ é’ˆå¯¹Platformï¼ˆAOSPçš„éƒ¨åˆ†ï¼‰ã€Non-Platformï¼ˆå‚å•†ã€ä¾›åº”å•†çš„éƒ¨åˆ†ï¼‰ï¼ŒTEä¼šæœ‰ä¸åŒçš„æ”¾ç½®ç›®å½•ã€‚ ä¸‹é¢æ˜¯TEæ–‡ä»¶çš„ä¸€ä¸ªä¾‹å­ï¼š platform/system/sepolicy/public/dhcp.te typeÂ dhcp,Â domain;permissiveÂ dhcp;typeÂ dhcp_exec,Â exec_type,Â file_type;typeÂ dhcp_data_file,Â file_type,Â data_file_type;init_daemon_domain(dhcp)net_domain(dhcp)allowÂ dhcpÂ self:capabilityÂ {Â setgidÂ setuidÂ net_adminÂ net_rawÂ net_bind_service};allowÂ dhcpÂ self:packet_socketÂ create_socket_perms;allowÂ dhcpÂ self:netlink_route_socketÂ {Â create_socket_permsÂ nlmsg_writeÂ };allowÂ dhcpÂ shell_exec:fileÂ rx_file_perms;allowÂ dhcpÂ system_file:fileÂ rx_file_perms;#Â ForÂ /proc/sys/net/ipv4/conf/*/promote_secondariesallowÂ dhcpÂ proc_net:file write;allowÂ dhcpÂ system_prop:property_serviceÂ setÂ ;unix_socket_connect(dhcp,Â property,Â init)type_transitionÂ dhcpÂ system_data_file:{Â dirÂ fileÂ }Â dhcp_data_file;allowÂ dhcpÂ dhcp_data_file:dirÂ create_dir_perms;allowÂ dhcpÂ dhcp_data_file:fileÂ create_file_perms;allowÂ dhcpÂ netd:fdÂ use;allowÂ dhcpÂ netd:fifo_fileÂ rw_file_perms;allowÂ dhcpÂ netd:{Â dgram_socket_class_setÂ unix_stream_socketÂ }Â {Â read writeÂ };allowÂ dhcpÂ netd:{Â netlink_kobject_uevent_socketÂ netlink_route_socketnetlink_nflog_socketÂ }Â {Â read writeÂ }; TEæ–‡ä»¶è¯­æ³•è§£æ typeÂ dhcp,Â domain;Â â€“Â å£°æ˜ä¸€ä¸ªtypeåä¸ºdhcpï¼Œå…¶ç»§æ‰¿domainè¿™ä¸ªAttributeï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨å£°æ˜æ—¶ä¾¿ç»§æ‰¿äº†domainæ‰€æ‹¥æœ‰çš„æƒé™ã€‚domainå±æ€§æ˜¯è¿›ç¨‹ä¸“ç”¨çš„ï¼Œå¾ˆæ˜¾ç„¶è¿™æ˜¯ä¸€ä¸ªè¿›ç¨‹çš„teæ–‡ä»¶ã€‚ permissiveÂ dhcp;Â â€“Â å°†dhcpæ ‡è¯†ä¸ºpermissiveæ¨¡å¼ã€‚ä¹‹å‰è¯´åˆ°ï¼ŒSeLinuxå¼€å¯æ¨¡å¼å¯ä»¥å…¨å±€è®¾ç½®ï¼Œä¹Ÿå¯ä»¥é’ˆå¯¹è¿›ç¨‹å•ç‹¬è®¾ç½®ã€‚è¿™é‡Œæ˜¯å•ç‹¬è®¾ç½®è¯¥è¿›ç¨‹çš„æ¨¡å¼ã€‚ typeÂ dhcp_exec,Â exec_type,Â file_type;Â â€“Â å£°æ˜ä¸€ä¸ªtypeåä¸ºdhcp_execï¼ŒÂ ä»å±äºexec_typeå’Œfile_typeä¸¤ä¸ªAttributeã€‚ä¹Ÿå°±æ˜¯è¯´åŒæ—¶ç»§æ‰¿ä¸¤ä¸ªAttributeæ‰€ä»£è¡¨çš„æ–‡ä»¶ã€‚exec_typeç”¨äºä»£è¡¨å¯æ‰§è¡Œæ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯è¿›ç¨‹çš„å¯æ‰§è¡Œæ–‡ä»¶å…¥å£ï¼›file_typeä»£è¡¨é€šç”¨æ–‡ä»¶ã€‚ä»è¿™é‡Œæˆ‘ä»¬çŸ¥é“dhcp_execä»£è¡¨dhcpå¯æ‰§è¡Œæ–‡ä»¶çš„å…¥å£ã€‚ init_daemon_domain(dhcp)Â â€“Â è¿™æ˜¯ä¸€ä¸ªå®ï¼Œä»£è¡¨è¿™æ˜¯ä¸€ä¸ªä»initå¯åŠ¨çš„è¿›ç¨‹ï¼Œå¹¶ä¸”å¯ä»¥åŒinité€šä¿¡ã€‚å®çš„æºç è§platform/system/sepolicy/public/te_macros net_domain â€“Â ä¹Ÿæ˜¯ä¸€ä¸ªå®ï¼Œå¯ä»¥è¿›è¡Œé€šç”¨çš„ç½‘ç»œæ“ä½œï¼Œæ¯”å¦‚è¯»å†™TCPåŒ…ï¼Œæ“ä½œsocketç­‰ã€‚ allowÂ dhcpÂ self:capabilityÂ {Â setgidÂ setuidÂ net_adminÂ net_rawÂ net_bind_service}; â€“ è¿™ä¸ªå°±æ˜¯å…·ä½“çš„è§„åˆ™æè¿°äº†ã€‚dhcpæ˜¯sourceæ–¹ï¼Œ selfæ˜¯targetæ–¹ï¼Œcapabilityæ˜¯ä¸€ä¸ªClassåï¼Œå…¶åæ˜¯å¯ä»¥åšçš„æ“ä½œã€‚è¿™å¥è¯æ˜¯è¯´å…è®¸dhcpè¿™ä¸ªè¿›ç¨‹å¯¹è‡ªå·±åšsetgidç­‰æ“ä½œã€‚selfå…³é”®å­—ç”¨æ¥è¡¨ç¤ºsourceå¯ä»¥å¯¹è‡ªå·±åšä»€ä¹ˆæ“ä½œã€‚ é™¤äº†ä¸Šé¢ä¾‹å­é‡Œå‡ºç°çš„å…³é”®å­—ï¼Œæœ‰æ—¶æˆ‘ä»¬è¿˜ä¼šçœ‹åˆ°typeattributeè¿™ä¸ªå…³é”®å­—ï¼šå®ƒä»£è¡¨å°†ä¹‹å‰å·²ç»å£°æ˜è¿‡çš„Typeå…³è”åˆ°ä¸€ä¸ªä¹‹å‰å£°æ˜è¿‡çš„Attributeã€‚ æ›´å¤šè¯­æ³•è§TypeStatements - SELinux Wiki ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:2:3","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#teæ–‡ä»¶è¯­æ³•è§£æ"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"â€‹â€‹â€‹â€‹â€‹â€‹â€‹4.Â SeLinuxçš„ç¼–è¯‘ ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:3:0","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#4selinuxçš„ç¼–è¯‘"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"4**.**1 ç¼–è¯‘****SeLinux Policy Android 8ä»¥ä¸Šç¼–è¯‘è¿‡ç¨‹ä¸­å°†æŠŠ/systemÂ å’ŒÂ /vendorä¸‹çš„policyåˆå¹¶ã€‚è¿™ä¸ªé€»è¾‘ä½“ç°åœ¨/platform/system/sepolicy/Android.mkã€‚ å…·ä½“policyä½ç½®ï¼š Location Contains system/sepolicy/public TheÂ platform'sÂ sepolicyÂ API system/sepolicy/private PlatformÂ implementationÂ detailsÂ (vendorsÂ canÂ ignore) system/sepolicy/vendor PolicyÂ andÂ contextÂ filesÂ thatÂ vendorsÂ canÂ useÂ (vendorsÂ canÂ ignoreÂ ifÂ desired) BOARD_SEPOLICY_DIRS VendorÂ sepolicy BOARD_ODM_SEPOLICY_DIRS (AndroidÂ 9Â andÂ higher) OdmÂ sepolicy SYSTEM_EXT_PUBLIC_SEPOLICY_DIRS (AndroidÂ 11Â andÂ higher) System_ext'sÂ sepolicyÂ API SYSTEM_EXT_PRIVATE_SEPOLICY_DIRS (AndroidÂ 11Â andÂ higher) System_extÂ implementationÂ detailsÂ (vendorsÂ canÂ ignore) PRODUCT_PUBLIC_SEPOLICY_DIRS (AndroidÂ 11Â andÂ higher) Product'sÂ sepolicyÂ API PRODUCT_PRIVATE_SEPOLICY_DIRS (AndroidÂ 11Â andÂ higher) ProductÂ implementationÂ detailsÂ (vendorsÂ canÂ ignore) ç¼–è¯‘è¿‡ç¨‹ï¼š å°†Policyè½¬åŒ–æˆCILï¼ˆÂ CommonÂ IntermediateÂ LanguageÂ ï¼‰æ–‡ä»¶ï¼ŒåŒ…æ‹¬ systemÂ +Â system_extÂ +Â productçš„publicéƒ¨åˆ†çš„policy åˆå¹¶private + public policy åˆå¹¶publicÂ +Â vendorÂ andÂ BOARD_SEPOLICY_DIRSÂ policy å°†publicéƒ¨åˆ†çš„policyè¿›è¡Œæ•´ç†æˆå¯¹åº”ç‰ˆæœ¬policyï¼Œä½œä¸ºvendor policyçš„ä¸€éƒ¨åˆ†ã€‚ç„¶åå°†publicçš„policyä¼ ç»™åˆå¹¶åçš„publicÂ +Â vendorÂ andÂ BOARD_SEPOLICY_DIRSÂ policyï¼Œå‘ŠçŸ¥å…¶å“ªéƒ¨åˆ†å¯ä»¥è¿æ¥åˆ°platformçš„attribute åˆ›å»ºä¸€ä¸ªmappingæ–‡ä»¶ï¼Œè¿æ¥platformå’Œvendorçš„éƒ¨åˆ†ã€‚ åˆå¹¶æ‰€æœ‰çš„policyæ–‡ä»¶ï¼Œæ•´åˆmappingã€platformå’Œvenderçš„policyï¼Œæœ€ç»ˆè¾“å‡ºä¸€ä¸ªäºŒè¿›åˆ¶çš„åä¸ºpolicyçš„æ–‡ä»¶ã€‚ä¸€èˆ¬è¿™ä¸ªæ–‡ä»¶çš„ä½ç½®åœ¨/sys/fs/sepolicy/policyã€‚è¿™ä¸ªpolicyæœ€ç»ˆä¼šè¢«kernelåŠ è½½ã€‚è¿™ä¸ªå·¥ä½œæ˜¯åœ¨initè¿›ç¨‹åˆå§‹åŒ–æ—¶è¿›è¡Œçš„ã€‚ä¹Ÿå°±æ˜¯è¯´æ˜¯åœ¨è¿è¡Œæ—¶è¿›è¡Œçš„ã€‚ ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:3:1","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#41-ç¼–è¯‘selinux-policy"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"4.2Â é¢„ç¼–è¯‘ åœ¨SeLinuxæ­£å¼å¼€å¯ä¹‹å‰ï¼Œinitè¿›ç¨‹ä¼šæ”¶é›†æ‰€æœ‰çš„cilæ–‡ä»¶ï¼Œå°†å…¶ç¼–è¯‘æˆpolicyï¼Œè¿™ä¸ªè¿‡ç¨‹éœ€è¦èŠ±è´¹1-2ç§’æ—¶é—´ã€‚ä¸ºäº†æ›´å¿«å®Œæˆæ­¤è¿‡ç¨‹ï¼Œä¼šå°†CILåœ¨ç¼–ä¸€é˜¶æ®µé¢„ç¼–è¯‘ï¼Œæ”¾åœ¨/vendor/etc/selinux/precompiled_sepolicyå’Œ/odm/etc/selinux/precompiled_sepolicyä¸‹ï¼Œå¹¶ä¸”é™„æœ‰sha256Â æ‘˜è¦ã€‚è¿è¡Œæ—¶ä¼šæ£€æŸ¥sha256æ˜¯å¦æœ‰å˜åŒ–ï¼Œå¦‚æœæ²¡æœ‰å˜åŒ–å°±ç›´æ¥ä½¿ç”¨é¢„ç¼–è¯‘çš„æ–‡ä»¶ã€‚ ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:3:2","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#42é¢„ç¼–è¯‘"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"5. å®è·µ ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:4:0","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#5-å®è·µ"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"5**.**1 å¼€å¯SeLinux ç¼–è¯‘kernelæ—¶ï¼ŒæŒ‡å®šCONFIG_SECURITY_SELINUX=yã€‚ æ¯”å¦‚åœ¨kernel/arm64/arch/arm64/configs/defconfigä¸­æ·»åŠ æ­¤é…ç½®ã€‚ åœ¨kernel/arm64/include/linux/selinux.hä¼šå¯¹è¯¥é…ç½®è¿›è¡Œåˆ¤æ–­ï¼š #ifdefÂ CONFIG_SECURITY_SELINUXbool selinux_is_enabled(void);#elsestatic inline bool selinux_is_enabled(void){return false;}#endif #endifÂ ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:4:1","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#51-å¼€å¯"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"**5.**2Â è®¾å®šSeLinuxæ¨¡å¼ åœ¨å‚å•†ç›®å½•çš„BoardConfig.mkä¸­ï¼ˆæ¯”å¦‚/device/google/trout/trout_arm64/BoardConfig.mkï¼‰æ·»åŠ å¦‚ä¸‹é…ç½®ï¼Œå¯æ”¹å˜SeLinuxæ¨¡å¼ BOARD_KERNEL_CMDLINEÂ :=Â androidboot.selinux=permissive æˆ– BOARD_BOOTCONFIGÂ :=Â androidboot.selinux=permissive ä¸Šé¢ä¸¤ä¸ªé…ç½®åªç”¨äºå¼€å‘é˜¶æ®µã€‚æ­£å¼ç‰ˆæœ¬éœ€è¦ç§»é™¤ï¼Œå¦åˆ™æ— æ³•é€šè¿‡CTSã€‚å³æ­£å¼ç‰ˆæœ¬ä¸Šï¼ŒSeLinuxæ˜¯å¼ºåˆ¶enforcingæ¨¡å¼ã€‚ éæ­£å¼çš„ä¿®æ”¹æ–¹æ³•ï¼š ALLOW_PERMISSIVE_SELINUXå®å®šä¹‰äº†æ˜¯å¦å¯ç”¨permissivveæ¨¡å¼ã€‚ åœ¨core/init/Android.bpä¸­æœ‰å¯¹è¯¥å®è®¾ç½®ï¼š init_first_stage_cc_defaults { ... cflags: [ \"-Wall\", \"-Wextra\", \"-Wno-unused-parameter\", \"-Werror\", \"-DALLOW_FIRST_STAGE_CONSOLE=0\", \"-DALLOW_LOCAL_PROP_OVERRIDE=0\", \"-DALLOW_PERMISSIVE_SELINUX=0\", \"-DREBOOT_BOOTLOADER_ON_PANIC=0\", \"-DWORLD_WRITABLE_KMSG=0\", \"-DDUMP_ON_UMOUNT_FAILURE=0\", \"-DSHUTDOWN_ZERO_TIMEOUT=0\", \"-DLOG_UEVENTS=0\", \"-DSEPOLICY_VERSION=30\", // TODO(jiyong): externalize the version number ], } å®é™…çš„ç”Ÿæ•ˆä½ç½®ï¼š core/init/selinux.cppboolÂ IsEnforcing() {if (ALLOW_PERMISSIVE_SELINUX) {return StatusFromProperty() ==Â SELINUX_ENFORCING; }return true;} ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:4:2","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#52è®¾å®šselinuxæ¨¡å¼"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"5**.**3 å¤„ç†å¼‚å¸¸LOG å‚å•†æˆ–ä¾›åº”ä¸Šåœ¨æ·»åŠ äº†ä¸€äº›è¿›ç¨‹ã€è®¿é—®è¡Œä¸ºã€ç­–ç•¥ç­‰ä¹‹åï¼Œéœ€è¦ç¡®è®¤æ˜¯å¦ç¬¦åˆSeLinuxè§„åˆ™ã€‚ å¦‚æœæœ‰ä»»ä½•è®¿é—®é™åˆ¶å‡ºç°ï¼Œåˆ™ä¼šæ‰“å°logï¼š 02-05 15:06:30.448 450 450Â EÂ SELinuxÂ :Â avc:Â deniedÂ {Â findÂ } forÂ pid=3059Â uid=10074Â name=media.metricsÂ scontext=u:r:testapp:s0:c512,c768Â tcontext=u:object_r:mediametrics_service:s0Â tclass=service_managerÂ permissive=0 ç²¾ç®€ä¸‹logï¼Œåªéœ€avc:åé¢çš„å³å¯ avc:Â deniedÂ {Â findÂ } forÂ pid=3059Â uid=10074Â name=media.metricsÂ scontext=u:r:testapp:s0:c512,c768Â tcontext=u:object_r:mediametrics_service:s0Â tclass=service_managerÂ permissive=0 å„å­—æ®µå«ä¹‰ï¼š {Â findÂ }ï¼šè¢«ç»„ç»‡çš„è¡Œä¸ºã€‚ scontextï¼ˆå¯ä»¥ç†è§£ä¸ºsource contextçš„ç¼©å†™ï¼‰ï¼šè¯¥è¡Œä¸ºçš„æ‰§è¡Œè€…çš„contextï¼› tcontextï¼ˆå¯ä»¥ç†è§£ä¸ºtarget contextçš„ç¼©å†™ï¼šï¼‰è¢«è®¿é—®è€…çš„contextï¼› tclassï¼šè¢«è®¿é—®è€…çš„classï¼Œè¯¦è§æœ¬æ–‡ä¹‹å‰çš„è§£é‡Šã€‚ ä½¿ç”¨auditallowç”ŸæˆTE ubuntuä¸­ï¼Œé€šè¿‡apt-getÂ audit2allowå®‰è£…audit2allowã€‚ è·å–policyæ–‡ä»¶ï¼š /sys/fs/selinux/policy å°†ä¸Šé¢çš„avc logä¿å­˜åœ¨test.avcæ–‡ä»¶ä¸­ï¼Œç„¶åæ‰§è¡Œï¼š audit2allowÂ -iÂ test.avcÂ -pÂ policyÂ \u003eÂ hynex.te å³ç”ŸæˆTEæ–‡ä»¶ã€‚å†å°†TEåŠ å…¥åˆ°SeLinuxç¼–è¯‘ç›®å½•sepolicyå³å¯ä¿®å¤å¼‚å¸¸logã€‚ ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:4:3","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#53-å¤„ç†"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"5**.**3 å¤„ç†å¼‚å¸¸LOG å‚å•†æˆ–ä¾›åº”ä¸Šåœ¨æ·»åŠ äº†ä¸€äº›è¿›ç¨‹ã€è®¿é—®è¡Œä¸ºã€ç­–ç•¥ç­‰ä¹‹åï¼Œéœ€è¦ç¡®è®¤æ˜¯å¦ç¬¦åˆSeLinuxè§„åˆ™ã€‚ å¦‚æœæœ‰ä»»ä½•è®¿é—®é™åˆ¶å‡ºç°ï¼Œåˆ™ä¼šæ‰“å°logï¼š 02-05 15:06:30.448 450 450Â EÂ SELinuxÂ :Â avc:Â deniedÂ {Â findÂ } forÂ pid=3059Â uid=10074Â name=media.metricsÂ scontext=u:r:testapp:s0:c512,c768Â tcontext=u:object_r:mediametrics_service:s0Â tclass=service_managerÂ permissive=0 ç²¾ç®€ä¸‹logï¼Œåªéœ€avc:åé¢çš„å³å¯ avc:Â deniedÂ {Â findÂ } forÂ pid=3059Â uid=10074Â name=media.metricsÂ scontext=u:r:testapp:s0:c512,c768Â tcontext=u:object_r:mediametrics_service:s0Â tclass=service_managerÂ permissive=0 å„å­—æ®µå«ä¹‰ï¼š {Â findÂ }ï¼šè¢«ç»„ç»‡çš„è¡Œä¸ºã€‚ scontextï¼ˆå¯ä»¥ç†è§£ä¸ºsource contextçš„ç¼©å†™ï¼‰ï¼šè¯¥è¡Œä¸ºçš„æ‰§è¡Œè€…çš„contextï¼› tcontextï¼ˆå¯ä»¥ç†è§£ä¸ºtarget contextçš„ç¼©å†™ï¼šï¼‰è¢«è®¿é—®è€…çš„contextï¼› tclassï¼šè¢«è®¿é—®è€…çš„classï¼Œè¯¦è§æœ¬æ–‡ä¹‹å‰çš„è§£é‡Šã€‚ ä½¿ç”¨auditallowç”ŸæˆTE ubuntuä¸­ï¼Œé€šè¿‡apt-getÂ audit2allowå®‰è£…audit2allowã€‚ è·å–policyæ–‡ä»¶ï¼š /sys/fs/selinux/policy å°†ä¸Šé¢çš„avc logä¿å­˜åœ¨test.avcæ–‡ä»¶ä¸­ï¼Œç„¶åæ‰§è¡Œï¼š audit2allowÂ -iÂ test.avcÂ -pÂ policyÂ \u003eÂ hynex.te å³ç”ŸæˆTEæ–‡ä»¶ã€‚å†å°†TEåŠ å…¥åˆ°SeLinuxç¼–è¯‘ç›®å½•sepolicyå³å¯ä¿®å¤å¼‚å¸¸logã€‚ ","date":"2024-11-06","objectID":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/:4:3","tags":["clippings","è½¬è½½","blog"],"title":"Android - æ·±å…¥æµ…å‡ºç†è§£SeLinux-CSDNåšå®¢","uri":"/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/#ä½¿ç”¨auditallow"},{"categories":null,"collections":["Framework","WMS"],"content":"****## å‰è¨€ æ¥åˆ°ä¸€ä¸ªå¼€å‘éœ€æ±‚ï¼Œéœ€è¦å®šåˆ¶åŒ–å¼€å‘ä¸€ä¸ªå®‰å…¨éŸ³é‡åŠŸèƒ½ï¼›æ­¤å‰æœ‰äº†è§£è¿‡ä¸ºäº†ç¬¦åˆæ¬§ç›Ÿç­‰æœ‰å…³å›½å®¶å’Œåœ°åŒºçš„è§„å®šï¼ŒåŸç”ŸAndroidæ˜¯æœ‰è‡ªå¸¦ä¸€ä¸ªå®‰å…¨éŸ³é‡åŠŸèƒ½çš„ï¼Œæƒ³è¦å®šåˆ¶åˆ™å…ˆè¦äº†è§£è¿™ä¸ªåŠŸèƒ½åŸå…ˆé•¿ä»€ä¹ˆæ ·å­ï¼Œä¸‹é¢æˆ‘ä»¬å°±ä»ä¸€ä¸ªç³»ç»Ÿå·¥ç¨‹å¸ˆçš„è§’åº¦å‡ºå‘å»æ¢å¯»ä¸€ä¸‹ï¼ŒåŸç”ŸAndroidçš„å®‰å…¨éŸ³é‡åŠŸèƒ½æ˜¯å¦‚ä½•å®ç°çš„ã€‚ ","date":"2024-11-06","objectID":"/posts/android-%E5%8E%9F%E7%94%9F%E5%AE%89%E5%85%A8%E9%9F%B3%E9%87%8F%E9%80%BB%E8%BE%91%E8%AE%BE%E8%AE%A1/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"android åŸç”Ÿå®‰å…¨éŸ³é‡é€»è¾‘è®¾è®¡","uri":"/posts/android-%E5%8E%9F%E7%94%9F%E5%AE%89%E5%85%A8%E9%9F%B3%E9%87%8F%E9%80%BB%E8%BE%91%E8%AE%BE%E8%AE%A1/#"},{"categories":null,"collections":["Framework","WMS"],"content":"å®‰å…¨éŸ³é‡é…ç½® å®‰å…¨éŸ³é‡çš„ç›¸å…³é…ç½®éƒ½åœ¨frameworkçš„config.xmlé‡Œé¢ï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹æˆ–è€…overlayé…ç½®ä¿®æ”¹å…¶é»˜è®¤å€¼ã€‚ \u003c!-- Whether safe headphone volume is enabled or not (country specific). --\u003e \u003cbool name=\"config_safe_media_volume_enabled\"\u003etrue\u003c/bool\u003e \u003c!-- Safe headphone volume index. When music stream volume is below this index the SPL on headphone output is compliant to EN 60950 requirements for portable music players. --\u003e \u003cinteger name=\"config_safe_media_volume_index\"\u003e10\u003c/integer\u003e config_safe_media_volume_enabledæ˜¯å®‰å…¨éŸ³é‡åŠŸèƒ½çš„æ€»å¼€å…³ï¼Œconfig_safe_media_volume_indexåˆ™æ˜¯è¡¨æ˜è§¦å‘å®‰å…¨éŸ³é‡å¼¹æ¡†çš„éŸ³é‡å¤§å°å€¼ã€‚ ","date":"2024-11-06","objectID":"/posts/android-%E5%8E%9F%E7%94%9F%E5%AE%89%E5%85%A8%E9%9F%B3%E9%87%8F%E9%80%BB%E8%BE%91%E8%AE%BE%E8%AE%A1/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"android åŸç”Ÿå®‰å…¨éŸ³é‡é€»è¾‘è®¾è®¡","uri":"/posts/android-%E5%8E%9F%E7%94%9F%E5%AE%89%E5%85%A8%E9%9F%B3%E9%87%8F%E9%80%BB%E8%BE%91%E8%AE%BE%E8%AE%A1/#å®‰å…¨éŸ³é‡é…ç½®"},{"categories":null,"collections":["Framework","WMS"],"content":"å®‰å…¨éŸ³é‡ç›¸å…³æµç¨‹ å®‰å…¨éŸ³é‡çš„ä¸»è¦æµç¨‹éƒ½åœ¨AudioServiceé‡Œé¢ï¼Œå…¶å¤§è‡´æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š MSG_CONFIGURE_SAFE_MEDIA_VOLUME_FORCED onSystemReady onConfigureSafeVolume checkSafeMediaVolume AudioManager adjustStreamVolume setStreamVolume showSafetyWarningH onSystemReady åˆå§‹åŒ– ç³»ç»Ÿå¯åŠ¨è¿‡ç¨‹ç•¥å»ä¸è¡¨ï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨å®Œæˆåä¼šè°ƒç”¨onSystemReadyï¼›åœ¨onSystemReadyä¸­ï¼Œserviceä¼šå‘é€ä¸€ä¸ªMSG_CONFIGURE_SAFE_MEDIA_VOLUME_FORCEDçš„msgï¼Œå¼ºåˆ¶é…ç½®å®‰å…¨éŸ³é‡ã€‚ public void onSystemReady() { ... sendMsg(mAudioHandler, MSG_CONFIGURE_SAFE_MEDIA_VOLUME_FORCED, SENDMSG_REPLACE, 0, 0, TAG, SystemProperties.getBoolean(\"audio.safemedia.bypass\", false) ? 0 : SAFE_VOLUME_CONFIGURE_TIMEOUT_MS); ... } å‘é€çš„MSG_CONFIGURE_SAFE_MEDIA_VOLUME_FORCEDä¼šè°ƒç”¨onConfigureSafeVolume()æ¥è¿›è¡Œå®‰å…¨éŸ³é‡çš„é…ç½® onConfigureSafeVolume() å®‰å…¨éŸ³é‡é…ç½® private void onConfigureSafeVolume(boolean force, String caller) { synchronized (mSafeMediaVolumeStateLock) { //Mobile contry codeï¼Œå›½å®¶ä»£ç ï¼Œä¸»è¦ç”¨æ¥åŒºåˆ†ä¸åŒå›½å®¶ï¼Œéƒ¨åˆ†å›½å®¶ç­–ç•¥å¯èƒ½ä¼šä¸ä¸€è‡´ int mcc = mContext.getResources().getConfiguration().mcc; if ((mMcc != mcc) || ((mMcc == 0) \u0026\u0026 force)) { //ä»config_safe_media_volume_indexä¸­è·å–å›æ¥çš„å®‰å…¨éŸ³é‡è§¦å‘é˜ˆå€¼ mSafeMediaVolumeIndex = mContext.getResources().getInteger( com.android.internal.R.integer.config_safe_media_volume_index) * 10; mSafeUsbMediaVolumeIndex = getSafeUsbMediaVolumeIndex(); //æ ¹æ®audio.safemedia.forceå±æ€§å€¼æˆ–è€…valueé…ç½®çš„å€¼æ¥å†³å®šæ˜¯å¦ä½¿èƒ½å®‰å…¨éŸ³é‡ boolean safeMediaVolumeEnabled = SystemProperties.getBoolean(\"audio.safemedia.force\", false) || mContext.getResources().getBoolean( com.android.internal.R.bool.config_safe_media_volume_enabled); //ç¡®è®¤æ˜¯å¦éœ€è¦bypassæ‰å®‰å…¨éŸ³é‡åŠŸèƒ½ boolean safeMediaVolumeBypass = SystemProperties.getBoolean(\"audio.safemedia.bypass\", false); // The persisted state is either \"disabled\" or \"active\": this is the state applied // next time we boot and cannot be \"inactive\" int persistedState; if (safeMediaVolumeEnabled \u0026\u0026 !safeMediaVolumeBypass) { persistedState = SAFE_MEDIA_VOLUME_ACTIVE; //è¿™ä¸ªå€¼åªèƒ½æ˜¯disableæˆ–è€…activeï¼Œä¸èƒ½æ˜¯inactiveï¼Œä¸»è¦ç”¨äºä¸‹æ¬¡å¯åŠ¨ã€‚ // The state can already be \"inactive\" here if the user has forced it before // the 30 seconds timeout for forced configuration. In this case we don't reset // it to \"active\". if (mSafeMediaVolumeState != SAFE_MEDIA_VOLUME_INACTIVE) { if (mMusicActiveMs == 0) { //mMusicActiveMsä¸»è¦ç”¨äºè®¡æ•°ï¼Œå½“å®‰å…¨éŸ³é‡å¼¹æ¡†å¼¹å‡ºæ—¶ï¼Œå¦‚æœæŒ‰äº†ç¡®å®šï¼Œè¿™ä¸ªå€¼ä¾¿å¼€å§‹é€’å¢ï¼Œå½“å…¶è¾¾åˆ°UNSAFE_VOLUME_MUSIC_ACTIVE_MS_MAXæ—¶ï¼Œåˆ™é‡æ–°ä½¿èƒ½å®‰å…¨éŸ³é‡ mSafeMediaVolumeState = SAFE_MEDIA_VOLUME_ACTIVE; enforceSafeMediaVolume(caller); } else { //è·‘åˆ°è¿™é‡Œåˆ™è¡¨ç¤ºå·²ç»å¼¹è¿‡å®‰å…¨éŸ³é‡è­¦ç¤ºäº†ï¼Œå¹¶ä¸”æŒ‰äº†ç¡®å®šï¼Œæ‰€ä»¥æŠŠå€¼è®¾ç½®ä¸ºinactive // We have existing playback time recorded, already confirmed. mSafeMediaVolumeState = SAFE_MEDIA_VOLUME_INACTIVE; } } } else { persistedState = SAFE_MEDIA_VOLUME_DISABLED; mSafeMediaVolumeState = SAFE_MEDIA_VOLUME_DISABLED; } mMcc = mcc; //æŒä¹…åŒ–å½“å‰å®‰å…¨éŸ³é‡çš„çŠ¶æ€ sendMsg(mAudioHandler, MSG_PERSIST_SAFE_VOLUME_STATE, SENDMSG_QUEUE, persistedState, 0, null, 0); } } } ç”±ä¸Šå¯çŸ¥ï¼ŒonConfigureSafeVolume()ä¸»è¦ç”¨äºé…ç½®å’Œä½¿èƒ½å®‰å…¨éŸ³é‡åŠŸèƒ½ï¼Œå¹¶ä¸”é€šè¿‡å‘é€MSG_PERSIST_SAFE_VOLUME_STATEæ¥æŒä¹…åŒ–å®‰å…¨éŸ³é‡é…ç½®çš„å€¼ï¼Œè¿™ä¸ªæŒä¹…åŒ–çš„å€¼åªèƒ½æ˜¯activeæˆ–è€…disabledã€‚ case MSG_PERSIST_SAFE_VOLUME_STATE: onPersistSafeVolumeState(msg.arg1); break; .... .... private void onPersistSafeVolumeState(int state) { Settings.Global.putInt(mContentResolver, Settings.Global.AUDIO_SAFE_VOLUME_STATE, state); } å®‰å…¨éŸ³é‡è§¦å‘ ä»å®é™…æ“ä½œå¯çŸ¥ï¼Œå®‰å…¨éŸ³é‡è§¦å‘æ¡ä»¶æ˜¯ï¼šéŸ³é‡å¢å¤§åˆ°æŒ‡å®šå€¼ã€‚ ä»è°ƒèŠ‚éŸ³é‡çš„ä»£ç å‡ºå‘ï¼Œåœ¨è°ƒç”¨mAudioManager.adjustStreamVolumeå’ŒmAudioManager.setStreamVolumeæ—¶ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°AudioServiceä¸­çš„åŒåæ–¹æ³•ï¼Œåœ¨æ‰§è¡Œè¯¥æ–¹æ³•çš„å†…éƒ¨ï¼š protected void adjustStreamVolume(int streamType, int direction, int flags, String callingPackage, String caller, int uid) { ... ... ... } else if ((direction == AudioManager.ADJUST_RAISE) \u0026\u0026 !checkSafeMediaVolume(streamTypeAlias, aliasIndex + step, device)) { Log.e(TAG, \"adjustStreamVolume() safe volume index = \" + oldIndex); mVolumeController.postDisplaySafeVolumeWarning(flags); .... ... private void setStreamVolume(int streamType, int index, int flags, String callingPackage, String caller, int uid) { .... .... if (!checkSafeMediaVolume(streamTypeAlias, index, device)) { mVolumeController.postDisplaySafeVolumeWarning(flags); mPendingVolumeCommand = new StreamVolumeCommand( streamType, index, flags, device); } else { onSetStreamVolume(streamType, index, flags, device, caller); index = mStrea","date":"2024-11-06","objectID":"/posts/android-%E5%8E%9F%E7%94%9F%E5%AE%89%E5%85%A8%E9%9F%B3%E9%87%8F%E9%80%BB%E8%BE%91%E8%AE%BE%E8%AE%A1/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"android åŸç”Ÿå®‰å…¨éŸ³é‡é€»è¾‘è®¾è®¡","uri":"/posts/android-%E5%8E%9F%E7%94%9F%E5%AE%89%E5%85%A8%E9%9F%B3%E9%87%8F%E9%80%BB%E8%BE%91%E8%AE%BE%E8%AE%A1/#å®‰å…¨éŸ³é‡ç›¸å…³æµç¨‹"},{"categories":null,"collections":["Framework","WMS"],"content":"å®‰å…¨éŸ³é‡ç›¸å…³æµç¨‹ å®‰å…¨éŸ³é‡çš„ä¸»è¦æµç¨‹éƒ½åœ¨AudioServiceé‡Œé¢ï¼Œå…¶å¤§è‡´æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š MSG_CONFIGURE_SAFE_MEDIA_VOLUME_FORCED onSystemReady onConfigureSafeVolume checkSafeMediaVolume AudioManager adjustStreamVolume setStreamVolume showSafetyWarningH onSystemReady åˆå§‹åŒ– ç³»ç»Ÿå¯åŠ¨è¿‡ç¨‹ç•¥å»ä¸è¡¨ï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨å®Œæˆåä¼šè°ƒç”¨onSystemReadyï¼›åœ¨onSystemReadyä¸­ï¼Œserviceä¼šå‘é€ä¸€ä¸ªMSG_CONFIGURE_SAFE_MEDIA_VOLUME_FORCEDçš„msgï¼Œå¼ºåˆ¶é…ç½®å®‰å…¨éŸ³é‡ã€‚ public void onSystemReady() { ... sendMsg(mAudioHandler, MSG_CONFIGURE_SAFE_MEDIA_VOLUME_FORCED, SENDMSG_REPLACE, 0, 0, TAG, SystemProperties.getBoolean(\"audio.safemedia.bypass\", false) ? 0 : SAFE_VOLUME_CONFIGURE_TIMEOUT_MS); ... } å‘é€çš„MSG_CONFIGURE_SAFE_MEDIA_VOLUME_FORCEDä¼šè°ƒç”¨onConfigureSafeVolume()æ¥è¿›è¡Œå®‰å…¨éŸ³é‡çš„é…ç½® onConfigureSafeVolume() å®‰å…¨éŸ³é‡é…ç½® private void onConfigureSafeVolume(boolean force, String caller) { synchronized (mSafeMediaVolumeStateLock) { //Mobile contry codeï¼Œå›½å®¶ä»£ç ï¼Œä¸»è¦ç”¨æ¥åŒºåˆ†ä¸åŒå›½å®¶ï¼Œéƒ¨åˆ†å›½å®¶ç­–ç•¥å¯èƒ½ä¼šä¸ä¸€è‡´ int mcc = mContext.getResources().getConfiguration().mcc; if ((mMcc != mcc) || ((mMcc == 0) \u0026\u0026 force)) { //ä»config_safe_media_volume_indexä¸­è·å–å›æ¥çš„å®‰å…¨éŸ³é‡è§¦å‘é˜ˆå€¼ mSafeMediaVolumeIndex = mContext.getResources().getInteger( com.android.internal.R.integer.config_safe_media_volume_index) * 10; mSafeUsbMediaVolumeIndex = getSafeUsbMediaVolumeIndex(); //æ ¹æ®audio.safemedia.forceå±æ€§å€¼æˆ–è€…valueé…ç½®çš„å€¼æ¥å†³å®šæ˜¯å¦ä½¿èƒ½å®‰å…¨éŸ³é‡ boolean safeMediaVolumeEnabled = SystemProperties.getBoolean(\"audio.safemedia.force\", false) || mContext.getResources().getBoolean( com.android.internal.R.bool.config_safe_media_volume_enabled); //ç¡®è®¤æ˜¯å¦éœ€è¦bypassæ‰å®‰å…¨éŸ³é‡åŠŸèƒ½ boolean safeMediaVolumeBypass = SystemProperties.getBoolean(\"audio.safemedia.bypass\", false); // The persisted state is either \"disabled\" or \"active\": this is the state applied // next time we boot and cannot be \"inactive\" int persistedState; if (safeMediaVolumeEnabled \u0026\u0026 !safeMediaVolumeBypass) { persistedState = SAFE_MEDIA_VOLUME_ACTIVE; //è¿™ä¸ªå€¼åªèƒ½æ˜¯disableæˆ–è€…activeï¼Œä¸èƒ½æ˜¯inactiveï¼Œä¸»è¦ç”¨äºä¸‹æ¬¡å¯åŠ¨ã€‚ // The state can already be \"inactive\" here if the user has forced it before // the 30 seconds timeout for forced configuration. In this case we don't reset // it to \"active\". if (mSafeMediaVolumeState != SAFE_MEDIA_VOLUME_INACTIVE) { if (mMusicActiveMs == 0) { //mMusicActiveMsä¸»è¦ç”¨äºè®¡æ•°ï¼Œå½“å®‰å…¨éŸ³é‡å¼¹æ¡†å¼¹å‡ºæ—¶ï¼Œå¦‚æœæŒ‰äº†ç¡®å®šï¼Œè¿™ä¸ªå€¼ä¾¿å¼€å§‹é€’å¢ï¼Œå½“å…¶è¾¾åˆ°UNSAFE_VOLUME_MUSIC_ACTIVE_MS_MAXæ—¶ï¼Œåˆ™é‡æ–°ä½¿èƒ½å®‰å…¨éŸ³é‡ mSafeMediaVolumeState = SAFE_MEDIA_VOLUME_ACTIVE; enforceSafeMediaVolume(caller); } else { //è·‘åˆ°è¿™é‡Œåˆ™è¡¨ç¤ºå·²ç»å¼¹è¿‡å®‰å…¨éŸ³é‡è­¦ç¤ºäº†ï¼Œå¹¶ä¸”æŒ‰äº†ç¡®å®šï¼Œæ‰€ä»¥æŠŠå€¼è®¾ç½®ä¸ºinactive // We have existing playback time recorded, already confirmed. mSafeMediaVolumeState = SAFE_MEDIA_VOLUME_INACTIVE; } } } else { persistedState = SAFE_MEDIA_VOLUME_DISABLED; mSafeMediaVolumeState = SAFE_MEDIA_VOLUME_DISABLED; } mMcc = mcc; //æŒä¹…åŒ–å½“å‰å®‰å…¨éŸ³é‡çš„çŠ¶æ€ sendMsg(mAudioHandler, MSG_PERSIST_SAFE_VOLUME_STATE, SENDMSG_QUEUE, persistedState, 0, null, 0); } } } ç”±ä¸Šå¯çŸ¥ï¼ŒonConfigureSafeVolume()ä¸»è¦ç”¨äºé…ç½®å’Œä½¿èƒ½å®‰å…¨éŸ³é‡åŠŸèƒ½ï¼Œå¹¶ä¸”é€šè¿‡å‘é€MSG_PERSIST_SAFE_VOLUME_STATEæ¥æŒä¹…åŒ–å®‰å…¨éŸ³é‡é…ç½®çš„å€¼ï¼Œè¿™ä¸ªæŒä¹…åŒ–çš„å€¼åªèƒ½æ˜¯activeæˆ–è€…disabledã€‚ case MSG_PERSIST_SAFE_VOLUME_STATE: onPersistSafeVolumeState(msg.arg1); break; .... .... private void onPersistSafeVolumeState(int state) { Settings.Global.putInt(mContentResolver, Settings.Global.AUDIO_SAFE_VOLUME_STATE, state); } å®‰å…¨éŸ³é‡è§¦å‘ ä»å®é™…æ“ä½œå¯çŸ¥ï¼Œå®‰å…¨éŸ³é‡è§¦å‘æ¡ä»¶æ˜¯ï¼šéŸ³é‡å¢å¤§åˆ°æŒ‡å®šå€¼ã€‚ ä»è°ƒèŠ‚éŸ³é‡çš„ä»£ç å‡ºå‘ï¼Œåœ¨è°ƒç”¨mAudioManager.adjustStreamVolumeå’ŒmAudioManager.setStreamVolumeæ—¶ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°AudioServiceä¸­çš„åŒåæ–¹æ³•ï¼Œåœ¨æ‰§è¡Œè¯¥æ–¹æ³•çš„å†…éƒ¨ï¼š protected void adjustStreamVolume(int streamType, int direction, int flags, String callingPackage, String caller, int uid) { ... ... ... } else if ((direction == AudioManager.ADJUST_RAISE) \u0026\u0026 !checkSafeMediaVolume(streamTypeAlias, aliasIndex + step, device)) { Log.e(TAG, \"adjustStreamVolume() safe volume index = \" + oldIndex); mVolumeController.postDisplaySafeVolumeWarning(flags); .... ... private void setStreamVolume(int streamType, int index, int flags, String callingPackage, String caller, int uid) { .... .... if (!checkSafeMediaVolume(streamTypeAlias, index, device)) { mVolumeController.postDisplaySafeVolumeWarning(flags); mPendingVolumeCommand = new StreamVolumeCommand( streamType, index, flags, device); } else { onSetStreamVolume(streamType, index, flags, device, caller); index = mStrea","date":"2024-11-06","objectID":"/posts/android-%E5%8E%9F%E7%94%9F%E5%AE%89%E5%85%A8%E9%9F%B3%E9%87%8F%E9%80%BB%E8%BE%91%E8%AE%BE%E8%AE%A1/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"android åŸç”Ÿå®‰å…¨éŸ³é‡é€»è¾‘è®¾è®¡","uri":"/posts/android-%E5%8E%9F%E7%94%9F%E5%AE%89%E5%85%A8%E9%9F%B3%E9%87%8F%E9%80%BB%E8%BE%91%E8%AE%BE%E8%AE%A1/#onsystemready-åˆå§‹åŒ–"},{"categories":null,"collections":["Framework","WMS"],"content":"å®‰å…¨éŸ³é‡ç›¸å…³æµç¨‹ å®‰å…¨éŸ³é‡çš„ä¸»è¦æµç¨‹éƒ½åœ¨AudioServiceé‡Œé¢ï¼Œå…¶å¤§è‡´æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š MSG_CONFIGURE_SAFE_MEDIA_VOLUME_FORCED onSystemReady onConfigureSafeVolume checkSafeMediaVolume AudioManager adjustStreamVolume setStreamVolume showSafetyWarningH onSystemReady åˆå§‹åŒ– ç³»ç»Ÿå¯åŠ¨è¿‡ç¨‹ç•¥å»ä¸è¡¨ï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨å®Œæˆåä¼šè°ƒç”¨onSystemReadyï¼›åœ¨onSystemReadyä¸­ï¼Œserviceä¼šå‘é€ä¸€ä¸ªMSG_CONFIGURE_SAFE_MEDIA_VOLUME_FORCEDçš„msgï¼Œå¼ºåˆ¶é…ç½®å®‰å…¨éŸ³é‡ã€‚ public void onSystemReady() { ... sendMsg(mAudioHandler, MSG_CONFIGURE_SAFE_MEDIA_VOLUME_FORCED, SENDMSG_REPLACE, 0, 0, TAG, SystemProperties.getBoolean(\"audio.safemedia.bypass\", false) ? 0 : SAFE_VOLUME_CONFIGURE_TIMEOUT_MS); ... } å‘é€çš„MSG_CONFIGURE_SAFE_MEDIA_VOLUME_FORCEDä¼šè°ƒç”¨onConfigureSafeVolume()æ¥è¿›è¡Œå®‰å…¨éŸ³é‡çš„é…ç½® onConfigureSafeVolume() å®‰å…¨éŸ³é‡é…ç½® private void onConfigureSafeVolume(boolean force, String caller) { synchronized (mSafeMediaVolumeStateLock) { //Mobile contry codeï¼Œå›½å®¶ä»£ç ï¼Œä¸»è¦ç”¨æ¥åŒºåˆ†ä¸åŒå›½å®¶ï¼Œéƒ¨åˆ†å›½å®¶ç­–ç•¥å¯èƒ½ä¼šä¸ä¸€è‡´ int mcc = mContext.getResources().getConfiguration().mcc; if ((mMcc != mcc) || ((mMcc == 0) \u0026\u0026 force)) { //ä»config_safe_media_volume_indexä¸­è·å–å›æ¥çš„å®‰å…¨éŸ³é‡è§¦å‘é˜ˆå€¼ mSafeMediaVolumeIndex = mContext.getResources().getInteger( com.android.internal.R.integer.config_safe_media_volume_index) * 10; mSafeUsbMediaVolumeIndex = getSafeUsbMediaVolumeIndex(); //æ ¹æ®audio.safemedia.forceå±æ€§å€¼æˆ–è€…valueé…ç½®çš„å€¼æ¥å†³å®šæ˜¯å¦ä½¿èƒ½å®‰å…¨éŸ³é‡ boolean safeMediaVolumeEnabled = SystemProperties.getBoolean(\"audio.safemedia.force\", false) || mContext.getResources().getBoolean( com.android.internal.R.bool.config_safe_media_volume_enabled); //ç¡®è®¤æ˜¯å¦éœ€è¦bypassæ‰å®‰å…¨éŸ³é‡åŠŸèƒ½ boolean safeMediaVolumeBypass = SystemProperties.getBoolean(\"audio.safemedia.bypass\", false); // The persisted state is either \"disabled\" or \"active\": this is the state applied // next time we boot and cannot be \"inactive\" int persistedState; if (safeMediaVolumeEnabled \u0026\u0026 !safeMediaVolumeBypass) { persistedState = SAFE_MEDIA_VOLUME_ACTIVE; //è¿™ä¸ªå€¼åªèƒ½æ˜¯disableæˆ–è€…activeï¼Œä¸èƒ½æ˜¯inactiveï¼Œä¸»è¦ç”¨äºä¸‹æ¬¡å¯åŠ¨ã€‚ // The state can already be \"inactive\" here if the user has forced it before // the 30 seconds timeout for forced configuration. In this case we don't reset // it to \"active\". if (mSafeMediaVolumeState != SAFE_MEDIA_VOLUME_INACTIVE) { if (mMusicActiveMs == 0) { //mMusicActiveMsä¸»è¦ç”¨äºè®¡æ•°ï¼Œå½“å®‰å…¨éŸ³é‡å¼¹æ¡†å¼¹å‡ºæ—¶ï¼Œå¦‚æœæŒ‰äº†ç¡®å®šï¼Œè¿™ä¸ªå€¼ä¾¿å¼€å§‹é€’å¢ï¼Œå½“å…¶è¾¾åˆ°UNSAFE_VOLUME_MUSIC_ACTIVE_MS_MAXæ—¶ï¼Œåˆ™é‡æ–°ä½¿èƒ½å®‰å…¨éŸ³é‡ mSafeMediaVolumeState = SAFE_MEDIA_VOLUME_ACTIVE; enforceSafeMediaVolume(caller); } else { //è·‘åˆ°è¿™é‡Œåˆ™è¡¨ç¤ºå·²ç»å¼¹è¿‡å®‰å…¨éŸ³é‡è­¦ç¤ºäº†ï¼Œå¹¶ä¸”æŒ‰äº†ç¡®å®šï¼Œæ‰€ä»¥æŠŠå€¼è®¾ç½®ä¸ºinactive // We have existing playback time recorded, already confirmed. mSafeMediaVolumeState = SAFE_MEDIA_VOLUME_INACTIVE; } } } else { persistedState = SAFE_MEDIA_VOLUME_DISABLED; mSafeMediaVolumeState = SAFE_MEDIA_VOLUME_DISABLED; } mMcc = mcc; //æŒä¹…åŒ–å½“å‰å®‰å…¨éŸ³é‡çš„çŠ¶æ€ sendMsg(mAudioHandler, MSG_PERSIST_SAFE_VOLUME_STATE, SENDMSG_QUEUE, persistedState, 0, null, 0); } } } ç”±ä¸Šå¯çŸ¥ï¼ŒonConfigureSafeVolume()ä¸»è¦ç”¨äºé…ç½®å’Œä½¿èƒ½å®‰å…¨éŸ³é‡åŠŸèƒ½ï¼Œå¹¶ä¸”é€šè¿‡å‘é€MSG_PERSIST_SAFE_VOLUME_STATEæ¥æŒä¹…åŒ–å®‰å…¨éŸ³é‡é…ç½®çš„å€¼ï¼Œè¿™ä¸ªæŒä¹…åŒ–çš„å€¼åªèƒ½æ˜¯activeæˆ–è€…disabledã€‚ case MSG_PERSIST_SAFE_VOLUME_STATE: onPersistSafeVolumeState(msg.arg1); break; .... .... private void onPersistSafeVolumeState(int state) { Settings.Global.putInt(mContentResolver, Settings.Global.AUDIO_SAFE_VOLUME_STATE, state); } å®‰å…¨éŸ³é‡è§¦å‘ ä»å®é™…æ“ä½œå¯çŸ¥ï¼Œå®‰å…¨éŸ³é‡è§¦å‘æ¡ä»¶æ˜¯ï¼šéŸ³é‡å¢å¤§åˆ°æŒ‡å®šå€¼ã€‚ ä»è°ƒèŠ‚éŸ³é‡çš„ä»£ç å‡ºå‘ï¼Œåœ¨è°ƒç”¨mAudioManager.adjustStreamVolumeå’ŒmAudioManager.setStreamVolumeæ—¶ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°AudioServiceä¸­çš„åŒåæ–¹æ³•ï¼Œåœ¨æ‰§è¡Œè¯¥æ–¹æ³•çš„å†…éƒ¨ï¼š protected void adjustStreamVolume(int streamType, int direction, int flags, String callingPackage, String caller, int uid) { ... ... ... } else if ((direction == AudioManager.ADJUST_RAISE) \u0026\u0026 !checkSafeMediaVolume(streamTypeAlias, aliasIndex + step, device)) { Log.e(TAG, \"adjustStreamVolume() safe volume index = \" + oldIndex); mVolumeController.postDisplaySafeVolumeWarning(flags); .... ... private void setStreamVolume(int streamType, int index, int flags, String callingPackage, String caller, int uid) { .... .... if (!checkSafeMediaVolume(streamTypeAlias, index, device)) { mVolumeController.postDisplaySafeVolumeWarning(flags); mPendingVolumeCommand = new StreamVolumeCommand( streamType, index, flags, device); } else { onSetStreamVolume(streamType, index, flags, device, caller); index = mStrea","date":"2024-11-06","objectID":"/posts/android-%E5%8E%9F%E7%94%9F%E5%AE%89%E5%85%A8%E9%9F%B3%E9%87%8F%E9%80%BB%E8%BE%91%E8%AE%BE%E8%AE%A1/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"android åŸç”Ÿå®‰å…¨éŸ³é‡é€»è¾‘è®¾è®¡","uri":"/posts/android-%E5%8E%9F%E7%94%9F%E5%AE%89%E5%85%A8%E9%9F%B3%E9%87%8F%E9%80%BB%E8%BE%91%E8%AE%BE%E8%AE%A1/#onconfiguresafevolume-å®‰å…¨éŸ³é‡é…ç½®"},{"categories":null,"collections":["Framework","WMS"],"content":"å®‰å…¨éŸ³é‡ç›¸å…³æµç¨‹ å®‰å…¨éŸ³é‡çš„ä¸»è¦æµç¨‹éƒ½åœ¨AudioServiceé‡Œé¢ï¼Œå…¶å¤§è‡´æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š MSG_CONFIGURE_SAFE_MEDIA_VOLUME_FORCED onSystemReady onConfigureSafeVolume checkSafeMediaVolume AudioManager adjustStreamVolume setStreamVolume showSafetyWarningH onSystemReady åˆå§‹åŒ– ç³»ç»Ÿå¯åŠ¨è¿‡ç¨‹ç•¥å»ä¸è¡¨ï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨å®Œæˆåä¼šè°ƒç”¨onSystemReadyï¼›åœ¨onSystemReadyä¸­ï¼Œserviceä¼šå‘é€ä¸€ä¸ªMSG_CONFIGURE_SAFE_MEDIA_VOLUME_FORCEDçš„msgï¼Œå¼ºåˆ¶é…ç½®å®‰å…¨éŸ³é‡ã€‚ public void onSystemReady() { ... sendMsg(mAudioHandler, MSG_CONFIGURE_SAFE_MEDIA_VOLUME_FORCED, SENDMSG_REPLACE, 0, 0, TAG, SystemProperties.getBoolean(\"audio.safemedia.bypass\", false) ? 0 : SAFE_VOLUME_CONFIGURE_TIMEOUT_MS); ... } å‘é€çš„MSG_CONFIGURE_SAFE_MEDIA_VOLUME_FORCEDä¼šè°ƒç”¨onConfigureSafeVolume()æ¥è¿›è¡Œå®‰å…¨éŸ³é‡çš„é…ç½® onConfigureSafeVolume() å®‰å…¨éŸ³é‡é…ç½® private void onConfigureSafeVolume(boolean force, String caller) { synchronized (mSafeMediaVolumeStateLock) { //Mobile contry codeï¼Œå›½å®¶ä»£ç ï¼Œä¸»è¦ç”¨æ¥åŒºåˆ†ä¸åŒå›½å®¶ï¼Œéƒ¨åˆ†å›½å®¶ç­–ç•¥å¯èƒ½ä¼šä¸ä¸€è‡´ int mcc = mContext.getResources().getConfiguration().mcc; if ((mMcc != mcc) || ((mMcc == 0) \u0026\u0026 force)) { //ä»config_safe_media_volume_indexä¸­è·å–å›æ¥çš„å®‰å…¨éŸ³é‡è§¦å‘é˜ˆå€¼ mSafeMediaVolumeIndex = mContext.getResources().getInteger( com.android.internal.R.integer.config_safe_media_volume_index) * 10; mSafeUsbMediaVolumeIndex = getSafeUsbMediaVolumeIndex(); //æ ¹æ®audio.safemedia.forceå±æ€§å€¼æˆ–è€…valueé…ç½®çš„å€¼æ¥å†³å®šæ˜¯å¦ä½¿èƒ½å®‰å…¨éŸ³é‡ boolean safeMediaVolumeEnabled = SystemProperties.getBoolean(\"audio.safemedia.force\", false) || mContext.getResources().getBoolean( com.android.internal.R.bool.config_safe_media_volume_enabled); //ç¡®è®¤æ˜¯å¦éœ€è¦bypassæ‰å®‰å…¨éŸ³é‡åŠŸèƒ½ boolean safeMediaVolumeBypass = SystemProperties.getBoolean(\"audio.safemedia.bypass\", false); // The persisted state is either \"disabled\" or \"active\": this is the state applied // next time we boot and cannot be \"inactive\" int persistedState; if (safeMediaVolumeEnabled \u0026\u0026 !safeMediaVolumeBypass) { persistedState = SAFE_MEDIA_VOLUME_ACTIVE; //è¿™ä¸ªå€¼åªèƒ½æ˜¯disableæˆ–è€…activeï¼Œä¸èƒ½æ˜¯inactiveï¼Œä¸»è¦ç”¨äºä¸‹æ¬¡å¯åŠ¨ã€‚ // The state can already be \"inactive\" here if the user has forced it before // the 30 seconds timeout for forced configuration. In this case we don't reset // it to \"active\". if (mSafeMediaVolumeState != SAFE_MEDIA_VOLUME_INACTIVE) { if (mMusicActiveMs == 0) { //mMusicActiveMsä¸»è¦ç”¨äºè®¡æ•°ï¼Œå½“å®‰å…¨éŸ³é‡å¼¹æ¡†å¼¹å‡ºæ—¶ï¼Œå¦‚æœæŒ‰äº†ç¡®å®šï¼Œè¿™ä¸ªå€¼ä¾¿å¼€å§‹é€’å¢ï¼Œå½“å…¶è¾¾åˆ°UNSAFE_VOLUME_MUSIC_ACTIVE_MS_MAXæ—¶ï¼Œåˆ™é‡æ–°ä½¿èƒ½å®‰å…¨éŸ³é‡ mSafeMediaVolumeState = SAFE_MEDIA_VOLUME_ACTIVE; enforceSafeMediaVolume(caller); } else { //è·‘åˆ°è¿™é‡Œåˆ™è¡¨ç¤ºå·²ç»å¼¹è¿‡å®‰å…¨éŸ³é‡è­¦ç¤ºäº†ï¼Œå¹¶ä¸”æŒ‰äº†ç¡®å®šï¼Œæ‰€ä»¥æŠŠå€¼è®¾ç½®ä¸ºinactive // We have existing playback time recorded, already confirmed. mSafeMediaVolumeState = SAFE_MEDIA_VOLUME_INACTIVE; } } } else { persistedState = SAFE_MEDIA_VOLUME_DISABLED; mSafeMediaVolumeState = SAFE_MEDIA_VOLUME_DISABLED; } mMcc = mcc; //æŒä¹…åŒ–å½“å‰å®‰å…¨éŸ³é‡çš„çŠ¶æ€ sendMsg(mAudioHandler, MSG_PERSIST_SAFE_VOLUME_STATE, SENDMSG_QUEUE, persistedState, 0, null, 0); } } } ç”±ä¸Šå¯çŸ¥ï¼ŒonConfigureSafeVolume()ä¸»è¦ç”¨äºé…ç½®å’Œä½¿èƒ½å®‰å…¨éŸ³é‡åŠŸèƒ½ï¼Œå¹¶ä¸”é€šè¿‡å‘é€MSG_PERSIST_SAFE_VOLUME_STATEæ¥æŒä¹…åŒ–å®‰å…¨éŸ³é‡é…ç½®çš„å€¼ï¼Œè¿™ä¸ªæŒä¹…åŒ–çš„å€¼åªèƒ½æ˜¯activeæˆ–è€…disabledã€‚ case MSG_PERSIST_SAFE_VOLUME_STATE: onPersistSafeVolumeState(msg.arg1); break; .... .... private void onPersistSafeVolumeState(int state) { Settings.Global.putInt(mContentResolver, Settings.Global.AUDIO_SAFE_VOLUME_STATE, state); } å®‰å…¨éŸ³é‡è§¦å‘ ä»å®é™…æ“ä½œå¯çŸ¥ï¼Œå®‰å…¨éŸ³é‡è§¦å‘æ¡ä»¶æ˜¯ï¼šéŸ³é‡å¢å¤§åˆ°æŒ‡å®šå€¼ã€‚ ä»è°ƒèŠ‚éŸ³é‡çš„ä»£ç å‡ºå‘ï¼Œåœ¨è°ƒç”¨mAudioManager.adjustStreamVolumeå’ŒmAudioManager.setStreamVolumeæ—¶ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°AudioServiceä¸­çš„åŒåæ–¹æ³•ï¼Œåœ¨æ‰§è¡Œè¯¥æ–¹æ³•çš„å†…éƒ¨ï¼š protected void adjustStreamVolume(int streamType, int direction, int flags, String callingPackage, String caller, int uid) { ... ... ... } else if ((direction == AudioManager.ADJUST_RAISE) \u0026\u0026 !checkSafeMediaVolume(streamTypeAlias, aliasIndex + step, device)) { Log.e(TAG, \"adjustStreamVolume() safe volume index = \" + oldIndex); mVolumeController.postDisplaySafeVolumeWarning(flags); .... ... private void setStreamVolume(int streamType, int index, int flags, String callingPackage, String caller, int uid) { .... .... if (!checkSafeMediaVolume(streamTypeAlias, index, device)) { mVolumeController.postDisplaySafeVolumeWarning(flags); mPendingVolumeCommand = new StreamVolumeCommand( streamType, index, flags, device); } else { onSetStreamVolume(streamType, index, flags, device, caller); index = mStrea","date":"2024-11-06","objectID":"/posts/android-%E5%8E%9F%E7%94%9F%E5%AE%89%E5%85%A8%E9%9F%B3%E9%87%8F%E9%80%BB%E8%BE%91%E8%AE%BE%E8%AE%A1/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"android åŸç”Ÿå®‰å…¨éŸ³é‡é€»è¾‘è®¾è®¡","uri":"/posts/android-%E5%8E%9F%E7%94%9F%E5%AE%89%E5%85%A8%E9%9F%B3%E9%87%8F%E9%80%BB%E8%BE%91%E8%AE%BE%E8%AE%A1/#å®‰å…¨éŸ³é‡è§¦å‘"},{"categories":null,"collections":["Framework","WMS"],"content":"å®‰å…¨éŸ³é‡ç›¸å…³æµç¨‹ å®‰å…¨éŸ³é‡çš„ä¸»è¦æµç¨‹éƒ½åœ¨AudioServiceé‡Œé¢ï¼Œå…¶å¤§è‡´æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š MSG_CONFIGURE_SAFE_MEDIA_VOLUME_FORCED onSystemReady onConfigureSafeVolume checkSafeMediaVolume AudioManager adjustStreamVolume setStreamVolume showSafetyWarningH onSystemReady åˆå§‹åŒ– ç³»ç»Ÿå¯åŠ¨è¿‡ç¨‹ç•¥å»ä¸è¡¨ï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨å®Œæˆåä¼šè°ƒç”¨onSystemReadyï¼›åœ¨onSystemReadyä¸­ï¼Œserviceä¼šå‘é€ä¸€ä¸ªMSG_CONFIGURE_SAFE_MEDIA_VOLUME_FORCEDçš„msgï¼Œå¼ºåˆ¶é…ç½®å®‰å…¨éŸ³é‡ã€‚ public void onSystemReady() { ... sendMsg(mAudioHandler, MSG_CONFIGURE_SAFE_MEDIA_VOLUME_FORCED, SENDMSG_REPLACE, 0, 0, TAG, SystemProperties.getBoolean(\"audio.safemedia.bypass\", false) ? 0 : SAFE_VOLUME_CONFIGURE_TIMEOUT_MS); ... } å‘é€çš„MSG_CONFIGURE_SAFE_MEDIA_VOLUME_FORCEDä¼šè°ƒç”¨onConfigureSafeVolume()æ¥è¿›è¡Œå®‰å…¨éŸ³é‡çš„é…ç½® onConfigureSafeVolume() å®‰å…¨éŸ³é‡é…ç½® private void onConfigureSafeVolume(boolean force, String caller) { synchronized (mSafeMediaVolumeStateLock) { //Mobile contry codeï¼Œå›½å®¶ä»£ç ï¼Œä¸»è¦ç”¨æ¥åŒºåˆ†ä¸åŒå›½å®¶ï¼Œéƒ¨åˆ†å›½å®¶ç­–ç•¥å¯èƒ½ä¼šä¸ä¸€è‡´ int mcc = mContext.getResources().getConfiguration().mcc; if ((mMcc != mcc) || ((mMcc == 0) \u0026\u0026 force)) { //ä»config_safe_media_volume_indexä¸­è·å–å›æ¥çš„å®‰å…¨éŸ³é‡è§¦å‘é˜ˆå€¼ mSafeMediaVolumeIndex = mContext.getResources().getInteger( com.android.internal.R.integer.config_safe_media_volume_index) * 10; mSafeUsbMediaVolumeIndex = getSafeUsbMediaVolumeIndex(); //æ ¹æ®audio.safemedia.forceå±æ€§å€¼æˆ–è€…valueé…ç½®çš„å€¼æ¥å†³å®šæ˜¯å¦ä½¿èƒ½å®‰å…¨éŸ³é‡ boolean safeMediaVolumeEnabled = SystemProperties.getBoolean(\"audio.safemedia.force\", false) || mContext.getResources().getBoolean( com.android.internal.R.bool.config_safe_media_volume_enabled); //ç¡®è®¤æ˜¯å¦éœ€è¦bypassæ‰å®‰å…¨éŸ³é‡åŠŸèƒ½ boolean safeMediaVolumeBypass = SystemProperties.getBoolean(\"audio.safemedia.bypass\", false); // The persisted state is either \"disabled\" or \"active\": this is the state applied // next time we boot and cannot be \"inactive\" int persistedState; if (safeMediaVolumeEnabled \u0026\u0026 !safeMediaVolumeBypass) { persistedState = SAFE_MEDIA_VOLUME_ACTIVE; //è¿™ä¸ªå€¼åªèƒ½æ˜¯disableæˆ–è€…activeï¼Œä¸èƒ½æ˜¯inactiveï¼Œä¸»è¦ç”¨äºä¸‹æ¬¡å¯åŠ¨ã€‚ // The state can already be \"inactive\" here if the user has forced it before // the 30 seconds timeout for forced configuration. In this case we don't reset // it to \"active\". if (mSafeMediaVolumeState != SAFE_MEDIA_VOLUME_INACTIVE) { if (mMusicActiveMs == 0) { //mMusicActiveMsä¸»è¦ç”¨äºè®¡æ•°ï¼Œå½“å®‰å…¨éŸ³é‡å¼¹æ¡†å¼¹å‡ºæ—¶ï¼Œå¦‚æœæŒ‰äº†ç¡®å®šï¼Œè¿™ä¸ªå€¼ä¾¿å¼€å§‹é€’å¢ï¼Œå½“å…¶è¾¾åˆ°UNSAFE_VOLUME_MUSIC_ACTIVE_MS_MAXæ—¶ï¼Œåˆ™é‡æ–°ä½¿èƒ½å®‰å…¨éŸ³é‡ mSafeMediaVolumeState = SAFE_MEDIA_VOLUME_ACTIVE; enforceSafeMediaVolume(caller); } else { //è·‘åˆ°è¿™é‡Œåˆ™è¡¨ç¤ºå·²ç»å¼¹è¿‡å®‰å…¨éŸ³é‡è­¦ç¤ºäº†ï¼Œå¹¶ä¸”æŒ‰äº†ç¡®å®šï¼Œæ‰€ä»¥æŠŠå€¼è®¾ç½®ä¸ºinactive // We have existing playback time recorded, already confirmed. mSafeMediaVolumeState = SAFE_MEDIA_VOLUME_INACTIVE; } } } else { persistedState = SAFE_MEDIA_VOLUME_DISABLED; mSafeMediaVolumeState = SAFE_MEDIA_VOLUME_DISABLED; } mMcc = mcc; //æŒä¹…åŒ–å½“å‰å®‰å…¨éŸ³é‡çš„çŠ¶æ€ sendMsg(mAudioHandler, MSG_PERSIST_SAFE_VOLUME_STATE, SENDMSG_QUEUE, persistedState, 0, null, 0); } } } ç”±ä¸Šå¯çŸ¥ï¼ŒonConfigureSafeVolume()ä¸»è¦ç”¨äºé…ç½®å’Œä½¿èƒ½å®‰å…¨éŸ³é‡åŠŸèƒ½ï¼Œå¹¶ä¸”é€šè¿‡å‘é€MSG_PERSIST_SAFE_VOLUME_STATEæ¥æŒä¹…åŒ–å®‰å…¨éŸ³é‡é…ç½®çš„å€¼ï¼Œè¿™ä¸ªæŒä¹…åŒ–çš„å€¼åªèƒ½æ˜¯activeæˆ–è€…disabledã€‚ case MSG_PERSIST_SAFE_VOLUME_STATE: onPersistSafeVolumeState(msg.arg1); break; .... .... private void onPersistSafeVolumeState(int state) { Settings.Global.putInt(mContentResolver, Settings.Global.AUDIO_SAFE_VOLUME_STATE, state); } å®‰å…¨éŸ³é‡è§¦å‘ ä»å®é™…æ“ä½œå¯çŸ¥ï¼Œå®‰å…¨éŸ³é‡è§¦å‘æ¡ä»¶æ˜¯ï¼šéŸ³é‡å¢å¤§åˆ°æŒ‡å®šå€¼ã€‚ ä»è°ƒèŠ‚éŸ³é‡çš„ä»£ç å‡ºå‘ï¼Œåœ¨è°ƒç”¨mAudioManager.adjustStreamVolumeå’ŒmAudioManager.setStreamVolumeæ—¶ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°AudioServiceä¸­çš„åŒåæ–¹æ³•ï¼Œåœ¨æ‰§è¡Œè¯¥æ–¹æ³•çš„å†…éƒ¨ï¼š protected void adjustStreamVolume(int streamType, int direction, int flags, String callingPackage, String caller, int uid) { ... ... ... } else if ((direction == AudioManager.ADJUST_RAISE) \u0026\u0026 !checkSafeMediaVolume(streamTypeAlias, aliasIndex + step, device)) { Log.e(TAG, \"adjustStreamVolume() safe volume index = \" + oldIndex); mVolumeController.postDisplaySafeVolumeWarning(flags); .... ... private void setStreamVolume(int streamType, int index, int flags, String callingPackage, String caller, int uid) { .... .... if (!checkSafeMediaVolume(streamTypeAlias, index, device)) { mVolumeController.postDisplaySafeVolumeWarning(flags); mPendingVolumeCommand = new StreamVolumeCommand( streamType, index, flags, device); } else { onSetStreamVolume(streamType, index, flags, device, caller); index = mStrea","date":"2024-11-06","objectID":"/posts/android-%E5%8E%9F%E7%94%9F%E5%AE%89%E5%85%A8%E9%9F%B3%E9%87%8F%E9%80%BB%E8%BE%91%E8%AE%BE%E8%AE%A1/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"android åŸç”Ÿå®‰å…¨éŸ³é‡é€»è¾‘è®¾è®¡","uri":"/posts/android-%E5%8E%9F%E7%94%9F%E5%AE%89%E5%85%A8%E9%9F%B3%E9%87%8F%E9%80%BB%E8%BE%91%E8%AE%BE%E8%AE%A1/#uiéƒ¨åˆ†"},{"categories":null,"collections":["Framework","WMS"],"content":"å®‰å…¨éŸ³é‡ç›¸å…³æµç¨‹ å®‰å…¨éŸ³é‡çš„ä¸»è¦æµç¨‹éƒ½åœ¨AudioServiceé‡Œé¢ï¼Œå…¶å¤§è‡´æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š MSG_CONFIGURE_SAFE_MEDIA_VOLUME_FORCED onSystemReady onConfigureSafeVolume checkSafeMediaVolume AudioManager adjustStreamVolume setStreamVolume showSafetyWarningH onSystemReady åˆå§‹åŒ– ç³»ç»Ÿå¯åŠ¨è¿‡ç¨‹ç•¥å»ä¸è¡¨ï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨å®Œæˆåä¼šè°ƒç”¨onSystemReadyï¼›åœ¨onSystemReadyä¸­ï¼Œserviceä¼šå‘é€ä¸€ä¸ªMSG_CONFIGURE_SAFE_MEDIA_VOLUME_FORCEDçš„msgï¼Œå¼ºåˆ¶é…ç½®å®‰å…¨éŸ³é‡ã€‚ public void onSystemReady() { ... sendMsg(mAudioHandler, MSG_CONFIGURE_SAFE_MEDIA_VOLUME_FORCED, SENDMSG_REPLACE, 0, 0, TAG, SystemProperties.getBoolean(\"audio.safemedia.bypass\", false) ? 0 : SAFE_VOLUME_CONFIGURE_TIMEOUT_MS); ... } å‘é€çš„MSG_CONFIGURE_SAFE_MEDIA_VOLUME_FORCEDä¼šè°ƒç”¨onConfigureSafeVolume()æ¥è¿›è¡Œå®‰å…¨éŸ³é‡çš„é…ç½® onConfigureSafeVolume() å®‰å…¨éŸ³é‡é…ç½® private void onConfigureSafeVolume(boolean force, String caller) { synchronized (mSafeMediaVolumeStateLock) { //Mobile contry codeï¼Œå›½å®¶ä»£ç ï¼Œä¸»è¦ç”¨æ¥åŒºåˆ†ä¸åŒå›½å®¶ï¼Œéƒ¨åˆ†å›½å®¶ç­–ç•¥å¯èƒ½ä¼šä¸ä¸€è‡´ int mcc = mContext.getResources().getConfiguration().mcc; if ((mMcc != mcc) || ((mMcc == 0) \u0026\u0026 force)) { //ä»config_safe_media_volume_indexä¸­è·å–å›æ¥çš„å®‰å…¨éŸ³é‡è§¦å‘é˜ˆå€¼ mSafeMediaVolumeIndex = mContext.getResources().getInteger( com.android.internal.R.integer.config_safe_media_volume_index) * 10; mSafeUsbMediaVolumeIndex = getSafeUsbMediaVolumeIndex(); //æ ¹æ®audio.safemedia.forceå±æ€§å€¼æˆ–è€…valueé…ç½®çš„å€¼æ¥å†³å®šæ˜¯å¦ä½¿èƒ½å®‰å…¨éŸ³é‡ boolean safeMediaVolumeEnabled = SystemProperties.getBoolean(\"audio.safemedia.force\", false) || mContext.getResources().getBoolean( com.android.internal.R.bool.config_safe_media_volume_enabled); //ç¡®è®¤æ˜¯å¦éœ€è¦bypassæ‰å®‰å…¨éŸ³é‡åŠŸèƒ½ boolean safeMediaVolumeBypass = SystemProperties.getBoolean(\"audio.safemedia.bypass\", false); // The persisted state is either \"disabled\" or \"active\": this is the state applied // next time we boot and cannot be \"inactive\" int persistedState; if (safeMediaVolumeEnabled \u0026\u0026 !safeMediaVolumeBypass) { persistedState = SAFE_MEDIA_VOLUME_ACTIVE; //è¿™ä¸ªå€¼åªèƒ½æ˜¯disableæˆ–è€…activeï¼Œä¸èƒ½æ˜¯inactiveï¼Œä¸»è¦ç”¨äºä¸‹æ¬¡å¯åŠ¨ã€‚ // The state can already be \"inactive\" here if the user has forced it before // the 30 seconds timeout for forced configuration. In this case we don't reset // it to \"active\". if (mSafeMediaVolumeState != SAFE_MEDIA_VOLUME_INACTIVE) { if (mMusicActiveMs == 0) { //mMusicActiveMsä¸»è¦ç”¨äºè®¡æ•°ï¼Œå½“å®‰å…¨éŸ³é‡å¼¹æ¡†å¼¹å‡ºæ—¶ï¼Œå¦‚æœæŒ‰äº†ç¡®å®šï¼Œè¿™ä¸ªå€¼ä¾¿å¼€å§‹é€’å¢ï¼Œå½“å…¶è¾¾åˆ°UNSAFE_VOLUME_MUSIC_ACTIVE_MS_MAXæ—¶ï¼Œåˆ™é‡æ–°ä½¿èƒ½å®‰å…¨éŸ³é‡ mSafeMediaVolumeState = SAFE_MEDIA_VOLUME_ACTIVE; enforceSafeMediaVolume(caller); } else { //è·‘åˆ°è¿™é‡Œåˆ™è¡¨ç¤ºå·²ç»å¼¹è¿‡å®‰å…¨éŸ³é‡è­¦ç¤ºäº†ï¼Œå¹¶ä¸”æŒ‰äº†ç¡®å®šï¼Œæ‰€ä»¥æŠŠå€¼è®¾ç½®ä¸ºinactive // We have existing playback time recorded, already confirmed. mSafeMediaVolumeState = SAFE_MEDIA_VOLUME_INACTIVE; } } } else { persistedState = SAFE_MEDIA_VOLUME_DISABLED; mSafeMediaVolumeState = SAFE_MEDIA_VOLUME_DISABLED; } mMcc = mcc; //æŒä¹…åŒ–å½“å‰å®‰å…¨éŸ³é‡çš„çŠ¶æ€ sendMsg(mAudioHandler, MSG_PERSIST_SAFE_VOLUME_STATE, SENDMSG_QUEUE, persistedState, 0, null, 0); } } } ç”±ä¸Šå¯çŸ¥ï¼ŒonConfigureSafeVolume()ä¸»è¦ç”¨äºé…ç½®å’Œä½¿èƒ½å®‰å…¨éŸ³é‡åŠŸèƒ½ï¼Œå¹¶ä¸”é€šè¿‡å‘é€MSG_PERSIST_SAFE_VOLUME_STATEæ¥æŒä¹…åŒ–å®‰å…¨éŸ³é‡é…ç½®çš„å€¼ï¼Œè¿™ä¸ªæŒä¹…åŒ–çš„å€¼åªèƒ½æ˜¯activeæˆ–è€…disabledã€‚ case MSG_PERSIST_SAFE_VOLUME_STATE: onPersistSafeVolumeState(msg.arg1); break; .... .... private void onPersistSafeVolumeState(int state) { Settings.Global.putInt(mContentResolver, Settings.Global.AUDIO_SAFE_VOLUME_STATE, state); } å®‰å…¨éŸ³é‡è§¦å‘ ä»å®é™…æ“ä½œå¯çŸ¥ï¼Œå®‰å…¨éŸ³é‡è§¦å‘æ¡ä»¶æ˜¯ï¼šéŸ³é‡å¢å¤§åˆ°æŒ‡å®šå€¼ã€‚ ä»è°ƒèŠ‚éŸ³é‡çš„ä»£ç å‡ºå‘ï¼Œåœ¨è°ƒç”¨mAudioManager.adjustStreamVolumeå’ŒmAudioManager.setStreamVolumeæ—¶ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°AudioServiceä¸­çš„åŒåæ–¹æ³•ï¼Œåœ¨æ‰§è¡Œè¯¥æ–¹æ³•çš„å†…éƒ¨ï¼š protected void adjustStreamVolume(int streamType, int direction, int flags, String callingPackage, String caller, int uid) { ... ... ... } else if ((direction == AudioManager.ADJUST_RAISE) \u0026\u0026 !checkSafeMediaVolume(streamTypeAlias, aliasIndex + step, device)) { Log.e(TAG, \"adjustStreamVolume() safe volume index = \" + oldIndex); mVolumeController.postDisplaySafeVolumeWarning(flags); .... ... private void setStreamVolume(int streamType, int index, int flags, String callingPackage, String caller, int uid) { .... .... if (!checkSafeMediaVolume(streamTypeAlias, index, device)) { mVolumeController.postDisplaySafeVolumeWarning(flags); mPendingVolumeCommand = new StreamVolumeCommand( streamType, index, flags, device); } else { onSetStreamVolume(streamType, index, flags, device, caller); index = mStrea","date":"2024-11-06","objectID":"/posts/android-%E5%8E%9F%E7%94%9F%E5%AE%89%E5%85%A8%E9%9F%B3%E9%87%8F%E9%80%BB%E8%BE%91%E8%AE%BE%E8%AE%A1/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"android åŸç”Ÿå®‰å…¨éŸ³é‡é€»è¾‘è®¾è®¡","uri":"/posts/android-%E5%8E%9F%E7%94%9F%E5%AE%89%E5%85%A8%E9%9F%B3%E9%87%8F%E9%80%BB%E8%BE%91%E8%AE%BE%E8%AE%A1/#disablesafemediavolume"},{"categories":null,"collections":["Framework","WMS"],"content":"å°ç»“ ç®€å•æ¥è®²ï¼ŒAndroidåŸç”Ÿçš„å®‰å…¨éŸ³é‡åŠŸèƒ½é»˜è®¤å¼ºåˆ¶æ‰“å¼€ï¼Œåœ¨æ’å…¥è€³æœºåï¼ŒéŸ³é‡è°ƒèŠ‚åˆ°æŒ‡å®šé˜ˆå€¼æ—¶ï¼Œä¼šè§¦å‘éŸ³é‡è­¦å‘Šå¼¹æ¡†ï¼Œè¯¥å¼¹æ¡†ä¼šæŠ¢èµ°ç„¦ç‚¹ï¼Œä¸ç‚¹å‡»ç¡®å®šæˆ–å–æ¶ˆæ— æ³•è¿›è¡Œå…¶ä»–æ“ä½œï¼›åœ¨ç‚¹å‡»ç¡®å®šåï¼Œé»˜è®¤æ“ä½œè€…æœ¬äººå…è®¸è®¾å¤‡éŸ³é‡ç»§ç»­å¾€ä¸Šè°ƒï¼Œä½†æ­¤æ—¶ç³»ç»Ÿä¼šå¼€å§‹ä¸€ä¸ªé»˜è®¤ä¸º20åˆ†é’Ÿçš„å€’è®¡æ—¶ï¼Œåœ¨è¿™20åˆ†é’Ÿå†…éŸ³é‡éšæ„è°ƒèŠ‚éƒ½ä¸ä¼šè§¦å‘å®‰å…¨éŸ³é‡å¼¹æ¡†ï¼Œä½†20åˆ†é’Ÿç»“æŸåï¼ŒéŸ³é‡å¤§äºé˜ˆå€¼æ—¶ä¼šç»§ç»­è§¦å‘å®‰å…¨éŸ³é‡å¼¹æ¡†ï¼Œæé†’ä½¿ç”¨è€…æ³¨æ„ã€‚ ","date":"2024-11-06","objectID":"/posts/android-%E5%8E%9F%E7%94%9F%E5%AE%89%E5%85%A8%E9%9F%B3%E9%87%8F%E9%80%BB%E8%BE%91%E8%AE%BE%E8%AE%A1/:3:0","tags":["clippings","è½¬è½½","blog"],"title":"android åŸç”Ÿå®‰å…¨éŸ³é‡é€»è¾‘è®¾è®¡","uri":"/posts/android-%E5%8E%9F%E7%94%9F%E5%AE%89%E5%85%A8%E9%9F%B3%E9%87%8F%E9%80%BB%E8%BE%91%E8%AE%BE%E8%AE%A1/#å°ç»“"},{"categories":null,"collections":["çŠ¶æ€æ ","Framework"],"content":"èƒŒæ™¯ é¡¹ç›®ä¸­ä¸ºäº†é€‚åº”äº§å“å½¢æ€éœ€è¦å¯¹Androidç³»ç»ŸçŠ¶æ€æ ç³»ç»Ÿå›¾æ ‡ä»¥åŠæ—¶é’Ÿå’Œç”µæ± ç­‰åšå®¢åˆ¶åŒ–ï¼Œæ»¡è¶³ä¸åŒç”¨æˆ·ç¾¤ä½“çš„è§†è§‰ç‰¹æ€§ï¼Œé‚£åœ¨å®šåˆ¶è¿‡ç¨‹ä¸­éœ€è¦æ³¨æ„å“ªäº›äº‹é¡¹ï¼Ÿå›¾æ ‡iconæ˜¯å¦å¯ä»¥ä»»æ„å¤§å°ï¼ŸçŠ¶æ€æ å¤šé¢œè‰²æ¨¡å¼ä¸‹å›¾æ ‡å¦‚ä½•é€‚é…ï¼Ÿå¤æ‚çŠ¶æ€å›¾æ ‡å¦‚ä½•è°ƒæ•´é€»è¾‘ï¼Ÿ ","date":"2024-11-06","objectID":"/posts/android%E7%B3%BB%E7%BB%9F%E7%8A%B6%E6%80%81%E6%A0%8F%E5%AE%9A%E5%88%B6/:0:1","tags":["clippings","è½¬è½½","blog"],"title":"Androidç³»ç»ŸçŠ¶æ€æ å®šåˆ¶","uri":"/posts/android%E7%B3%BB%E7%BB%9F%E7%8A%B6%E6%80%81%E6%A0%8F%E5%AE%9A%E5%88%B6/#èƒŒæ™¯"},{"categories":null,"collections":["çŠ¶æ€æ ","Framework"],"content":"çŠ¶æ€æ æ˜¯ä»€ä¹ˆï¼Ÿ é¦–å…ˆæ¥çœ‹ä¸‹çŠ¶æ€æ è½½ä½“æ˜¯ä»€ä¹ˆï¼ŸçŠ¶æ€æ æœ¬è´¨å…¶å®å°±æ˜¯ä¸€ä¸ªæ‚¬æµ®çª—ï¼Œåœ¨systemuiåˆå§‹åŒ–æ—¶åˆ›å»ºæ˜¾ç¤ºã€‚SystemUI/src/com/android/systemui/statusbar/phone/StatusBar.java protected void inflateStatusBarWindow(Context context) { mStatusBarWindow = (StatusBarWindowView) mInjectionInflater.injectable( LayoutInflater.from(context)).inflate(R.layout.super_status_bar, null); } ç”±ä¸Šå¯çŸ¥çŠ¶æ€æ å°±æ˜¯ä½¿ç”¨super_status_bar.xmlå¸ƒå±€åˆ›å»ºçš„ä¸€ä¸ªæ‚¬æµ®çª—ã€‚è€Œè¿™ä¸ªå¸ƒå±€åŒ…å«äº†çŠ¶æ€æ æ‰€æœ‰å†…å®¹ï¼Œåº”ç”¨é€šçŸ¥ï¼Œç³»ç»Ÿå›¾æ ‡ï¼Œæ—¶é’Ÿç­‰ã€‚å…¶ä¸»ä½“å†…å®¹å¦‚ä¸‹ \u003ccom.android.systemui.statusbar.phone.StatusBarWindowView ... \u003cFrameLayout android:id=\"@+id/status_bar_container\" android:layout_width=\"match_parent\" android:layout_height=\"wrap_content\" /\u003e ... \u003c/com.android.systemui.statusbar.phone.StatusBarWindowView\u003e å…¶ä¸­åŒ…å«status_bar_container çš„framelayoutçš„å®¹å™¨å³ä¸ºçŠ¶æ€æ çš„viewï¼Œåœ¨ä»£ç ä¸­é€šè¿‡fragmentmanageræ›¿æ¢äº†äº†è¿™ä¸ªcontainerã€‚ protected void makeStatusBarView(@Nullable RegisterStatusBarResult result) { ... FragmentHostManager.get(mStatusBarWindow) .addTagListener(...).getFragmentManager() .beginTransaction() .replace(R.id.status_bar_container, new CollapsedStatusBarFragment(), CollapsedStatusBarFragment.TAG) .commit(); è€ŒCollapsedStatusBarFragmentçš„å®ç°å°±æ˜¯åŠ è½½äº†status_bar.xml è¿™ä¸ªå¸ƒå±€ã€‚ @Override public View onCreateView(LayoutInflater inflater, @Nullable ViewGroup container, Bundle savedInstanceState) { return inflater.inflate(R.layout.status_bar, container, false); } status_bar.xml å¸ƒå±€å†…å®¹å°±æ˜¯æ˜¾ç¤ºå‡ºæ¥çš„çŠ¶æ€æ å¸ƒå±€ã€‚è¿™æ ·çŠ¶æ€æ æ•´ä½“å¸ƒå±€å°±æ¯”è¾ƒæ¸…æ™°ï¼ŒåŒ…å«äº†åº”ç”¨é€šçŸ¥ï¼Œç³»ç»Ÿå›¾æ ‡, æ—¶é’Ÿï¼Œç”µæ± ç­‰ã€‚ \u003ccom.android.systemui.statusbar.phone.PhoneStatusBarView ... android:layout_height=\"@dimen/status_bar_height\" android:id=\"@+id/status_bar\" ... \u003e ... \u003cLinearLayout android:id=\"@+id/status_bar_contents\" ... \u003c!-- å·¦ä¾§æ˜¾ç¤ºåŒºåŸŸ æ•´ä½“æƒé‡åªå äº†1--\u003e \u003cFrameLayout android:layout_height=\"match_parent\" android:layout_width=\"0dp\" android:layout_weight=\"1\"\u003e ... \u003cLinearLayout android:id=\"@+id/status_bar_left_side\" ... \u003e \u003c!-- æ—¶é’Ÿ --\u003e \u003ccom.android.systemui.statusbar.policy.Clock android:id=\"@+id/clock\" ... android:textAppearance=\"@style/TextAppearance.StatusBar.Clock\" /\u003e \u003c!-- åº”ç”¨é€šçŸ¥iconåŒºåŸŸ --\u003e \u003ccom.android.systemui.statusbar.AlphaOptimizedFrameLayout android:id=\"@+id/notification_icon_area\" android:layout_width=\"0dp\" android:layout_height=\"match_parent\" android:layout_weight=\"1\" android:orientation=\"horizontal\" android:clipChildren=\"false\"/\u003e \u003c/LinearLayout\u003e \u003c/FrameLayout\u003e ... \u003c!-- ä¸­é—´iconæ˜¾ç¤ºåŒºåŸŸ --\u003e \u003ccom.android.systemui.statusbar.AlphaOptimizedFrameLayout android:id=\"@+id/centered_icon_area\" android:layout_width=\"wrap_content\" android:layout_height=\"match_parent\" android:orientation=\"horizontal\" android:clipChildren=\"false\" android:gravity=\"center_horizontal|center_vertical\"/\u003e \u003c!-- ç³»ç»Ÿiconæ˜¾ç¤ºåŒºåŸŸ--\u003e \u003ccom.android.keyguard.AlphaOptimizedLinearLayout android:id=\"@+id/system_icon_area\" android:layout_width=\"0dp\" android:layout_height=\"match_parent\" android:layout_weight=\"1\" android:orientation=\"horizontal\" android:gravity=\"center_vertical|end\" \u003e \u003c!-- ç³»ç»Ÿiconå®é™…æ˜¾ç¤ºå¸ƒå±€ --\u003e \u003cinclude layout=\"@layout/system_icons\" /\u003e \u003c/com.android.keyguard.AlphaOptimizedLinearLayout\u003e \u003c/LinearLayout\u003e ... \u003c/com.android.systemui.statusbar.phone.PhoneStatusBarView\u003e ç³»ç»ŸiconåŒºåŸŸ system_icons.xml \u003cLinearLayout xmlns:android=\"http://schemas.android.com/apk/res/android\" xmlns:systemui=\"http://schemas.android.com/apk/res-auto\" android:id=\"@+id/system_icons\" ...\u003e \u003ccom.android.systemui.statusbar.phone.StatusIconContainer android:id=\"@+id/statusIcons\" android:layout_width=\"0dp\" android:layout_weight=\"1\" .../\u003e \u003ccom.android.systemui.statusbar.phone.seewo.BatteryImageView android:id=\"@+id/battery\" .../\u003e \u003c/LinearLayout\u003e æ•´ä¸ªçŠ¶æ€æ æ•´ä½“å¸ƒå±€ç¤ºæ„å¦‚ä¸‹ï¼š å…¶ä¸­æˆ‘ä»¬éœ€è¦å®šåˆ¶çš„ä»UIè®¾è®¡ç¨¿ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ˜¯ä¸‰ä¸ªåŒºåŸŸï¼Œæ—¶é’Ÿï¼Œ ç³»ç»Ÿiconï¼Œç”µæ± ï¼Œ åº”ç”¨é€šçŸ¥åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ä¸éœ€è¦ï¼Œå¯ä»¥ç›´æ¥å»æ‰é€šçŸ¥ä¿¡æ¯åŠŸèƒ½ï¼Œå°±ä¸ä¼šæ˜¾ç¤ºå‡ºæ¥ã€‚clockå’Œbatteryéƒ½æ˜¯è‡ªå®šä¹‰æ§ä»¶ï¼Œæ¯”è¾ƒå¥½å¤„ç†ã€‚é‡ç‚¹çœ‹ä¸‹ç³»ç»Ÿiconå®ç°ã€‚ ç³»ç»ŸICONå¸ƒå±€ ç”±ä¸Šå®¢åˆ¶ç³»ç»Ÿå›¾æ ‡åŒºåŸŸåŒ…å«ä¸€ä¸ªstatusIcons çš„å®¹å™¨viewï¼Œè¿˜æœ‰battery æ˜¾ç¤ºviewã€‚ å…¶å¸ƒå±€ä¹Ÿæ˜¯è‡ªå®šä¹‰view, StatusIconContainer.java \u003ccom.android.systemui.statusbar.phone.StatusIconContainer android:id=\"@+id/statusIcons\" android:layout_width=\"0dp\" .../\u003e å…¶å®ç°æ˜¯åŸºäºAlphaOptimizedLinearLayoutå¸ƒå±€å®ç°çš„ä¸€ä¸ªè‡ªå®šä¹‰å¸ƒå±€ã€‚AlphaOptimizedLinearLayoutæ˜¯ç»§æ‰¿è‡ªLinearLayoutåªæ˜¯è¦†ç›–äº† public boolean hasOverlappingRendering() { return false; } è¯¥æ–¹æ³•ç”¨æ¥æ ‡è®°å½“å‰viewæ˜¯å¦å­˜åœ¨è¿‡åº¦ç»˜åˆ¶ï¼Œå­˜åœ¨è¿”å›tureï¼Œä¸å­˜åœ¨è¿”å›falseï¼Œé»˜è®¤è¿”å›ä¸ºtrueã€‚ åœ¨androidçš„Viewé‡Œæœ‰é€æ˜åº¦çš„","date":"2024-11-06","objectID":"/posts/android%E7%B3%BB%E7%BB%9F%E7%8A%B6%E6%80%81%E6%A0%8F%E5%AE%9A%E5%88%B6/:0:2","tags":["clippings","è½¬è½½","blog"],"title":"Androidç³»ç»ŸçŠ¶æ€æ å®šåˆ¶","uri":"/posts/android%E7%B3%BB%E7%BB%9F%E7%8A%B6%E6%80%81%E6%A0%8F%E5%AE%9A%E5%88%B6/#çŠ¶æ€æ æ˜¯ä»€ä¹ˆ"},{"categories":null,"collections":["çŠ¶æ€æ ","Framework"],"content":"çŠ¶æ€æ æ˜¯ä»€ä¹ˆï¼Ÿ é¦–å…ˆæ¥çœ‹ä¸‹çŠ¶æ€æ è½½ä½“æ˜¯ä»€ä¹ˆï¼ŸçŠ¶æ€æ æœ¬è´¨å…¶å®å°±æ˜¯ä¸€ä¸ªæ‚¬æµ®çª—ï¼Œåœ¨systemuiåˆå§‹åŒ–æ—¶åˆ›å»ºæ˜¾ç¤ºã€‚SystemUI/src/com/android/systemui/statusbar/phone/StatusBar.java protected void inflateStatusBarWindow(Context context) { mStatusBarWindow = (StatusBarWindowView) mInjectionInflater.injectable( LayoutInflater.from(context)).inflate(R.layout.super_status_bar, null); } ç”±ä¸Šå¯çŸ¥çŠ¶æ€æ å°±æ˜¯ä½¿ç”¨super_status_bar.xmlå¸ƒå±€åˆ›å»ºçš„ä¸€ä¸ªæ‚¬æµ®çª—ã€‚è€Œè¿™ä¸ªå¸ƒå±€åŒ…å«äº†çŠ¶æ€æ æ‰€æœ‰å†…å®¹ï¼Œåº”ç”¨é€šçŸ¥ï¼Œç³»ç»Ÿå›¾æ ‡ï¼Œæ—¶é’Ÿç­‰ã€‚å…¶ä¸»ä½“å†…å®¹å¦‚ä¸‹ ","date":"2024-11-06","objectID":"/posts/android%E7%B3%BB%E7%BB%9F%E7%8A%B6%E6%80%81%E6%A0%8F%E5%AE%9A%E5%88%B6/:0:2","tags":["clippings","è½¬è½½","blog"],"title":"Androidç³»ç»ŸçŠ¶æ€æ å®šåˆ¶","uri":"/posts/android%E7%B3%BB%E7%BB%9F%E7%8A%B6%E6%80%81%E6%A0%8F%E5%AE%9A%E5%88%B6/#ç³»ç»Ÿiconå¸ƒå±€"},{"categories":null,"collections":["çŠ¶æ€æ ","Framework"],"content":"çŠ¶æ€æ æ˜¯ä»€ä¹ˆï¼Ÿ é¦–å…ˆæ¥çœ‹ä¸‹çŠ¶æ€æ è½½ä½“æ˜¯ä»€ä¹ˆï¼ŸçŠ¶æ€æ æœ¬è´¨å…¶å®å°±æ˜¯ä¸€ä¸ªæ‚¬æµ®çª—ï¼Œåœ¨systemuiåˆå§‹åŒ–æ—¶åˆ›å»ºæ˜¾ç¤ºã€‚SystemUI/src/com/android/systemui/statusbar/phone/StatusBar.java protected void inflateStatusBarWindow(Context context) { mStatusBarWindow = (StatusBarWindowView) mInjectionInflater.injectable( LayoutInflater.from(context)).inflate(R.layout.super_status_bar, null); } ç”±ä¸Šå¯çŸ¥çŠ¶æ€æ å°±æ˜¯ä½¿ç”¨super_status_bar.xmlå¸ƒå±€åˆ›å»ºçš„ä¸€ä¸ªæ‚¬æµ®çª—ã€‚è€Œè¿™ä¸ªå¸ƒå±€åŒ…å«äº†çŠ¶æ€æ æ‰€æœ‰å†…å®¹ï¼Œåº”ç”¨é€šçŸ¥ï¼Œç³»ç»Ÿå›¾æ ‡ï¼Œæ—¶é’Ÿç­‰ã€‚å…¶ä¸»ä½“å†…å®¹å¦‚ä¸‹ ","date":"2024-11-06","objectID":"/posts/android%E7%B3%BB%E7%BB%9F%E7%8A%B6%E6%80%81%E6%A0%8F%E5%AE%9A%E5%88%B6/:0:2","tags":["clippings","è½¬è½½","blog"],"title":"Androidç³»ç»ŸçŠ¶æ€æ å®šåˆ¶","uri":"/posts/android%E7%B3%BB%E7%BB%9F%E7%8A%B6%E6%80%81%E6%A0%8F%E5%AE%9A%E5%88%B6/#statusiconcontainer--onmeasure"},{"categories":null,"collections":["çŠ¶æ€æ ","Framework"],"content":"çŠ¶æ€æ æ˜¯ä»€ä¹ˆï¼Ÿ é¦–å…ˆæ¥çœ‹ä¸‹çŠ¶æ€æ è½½ä½“æ˜¯ä»€ä¹ˆï¼ŸçŠ¶æ€æ æœ¬è´¨å…¶å®å°±æ˜¯ä¸€ä¸ªæ‚¬æµ®çª—ï¼Œåœ¨systemuiåˆå§‹åŒ–æ—¶åˆ›å»ºæ˜¾ç¤ºã€‚SystemUI/src/com/android/systemui/statusbar/phone/StatusBar.java protected void inflateStatusBarWindow(Context context) { mStatusBarWindow = (StatusBarWindowView) mInjectionInflater.injectable( LayoutInflater.from(context)).inflate(R.layout.super_status_bar, null); } ç”±ä¸Šå¯çŸ¥çŠ¶æ€æ å°±æ˜¯ä½¿ç”¨super_status_bar.xmlå¸ƒå±€åˆ›å»ºçš„ä¸€ä¸ªæ‚¬æµ®çª—ã€‚è€Œè¿™ä¸ªå¸ƒå±€åŒ…å«äº†çŠ¶æ€æ æ‰€æœ‰å†…å®¹ï¼Œåº”ç”¨é€šçŸ¥ï¼Œç³»ç»Ÿå›¾æ ‡ï¼Œæ—¶é’Ÿç­‰ã€‚å…¶ä¸»ä½“å†…å®¹å¦‚ä¸‹ ","date":"2024-11-06","objectID":"/posts/android%E7%B3%BB%E7%BB%9F%E7%8A%B6%E6%80%81%E6%A0%8F%E5%AE%9A%E5%88%B6/:0:2","tags":["clippings","è½¬è½½","blog"],"title":"Androidç³»ç»ŸçŠ¶æ€æ å®šåˆ¶","uri":"/posts/android%E7%B3%BB%E7%BB%9F%E7%8A%B6%E6%80%81%E6%A0%8F%E5%AE%9A%E5%88%B6/#statusiconcontainer-onlayout"},{"categories":null,"collections":["çŠ¶æ€æ ","Framework"],"content":"çŠ¶æ€æ æ˜¯ä»€ä¹ˆï¼Ÿ é¦–å…ˆæ¥çœ‹ä¸‹çŠ¶æ€æ è½½ä½“æ˜¯ä»€ä¹ˆï¼ŸçŠ¶æ€æ æœ¬è´¨å…¶å®å°±æ˜¯ä¸€ä¸ªæ‚¬æµ®çª—ï¼Œåœ¨systemuiåˆå§‹åŒ–æ—¶åˆ›å»ºæ˜¾ç¤ºã€‚SystemUI/src/com/android/systemui/statusbar/phone/StatusBar.java protected void inflateStatusBarWindow(Context context) { mStatusBarWindow = (StatusBarWindowView) mInjectionInflater.injectable( LayoutInflater.from(context)).inflate(R.layout.super_status_bar, null); } ç”±ä¸Šå¯çŸ¥çŠ¶æ€æ å°±æ˜¯ä½¿ç”¨super_status_bar.xmlå¸ƒå±€åˆ›å»ºçš„ä¸€ä¸ªæ‚¬æµ®çª—ã€‚è€Œè¿™ä¸ªå¸ƒå±€åŒ…å«äº†çŠ¶æ€æ æ‰€æœ‰å†…å®¹ï¼Œåº”ç”¨é€šçŸ¥ï¼Œç³»ç»Ÿå›¾æ ‡ï¼Œæ—¶é’Ÿç­‰ã€‚å…¶ä¸»ä½“å†…å®¹å¦‚ä¸‹ ","date":"2024-11-06","objectID":"/posts/android%E7%B3%BB%E7%BB%9F%E7%8A%B6%E6%80%81%E6%A0%8F%E5%AE%9A%E5%88%B6/:0:2","tags":["clippings","è½¬è½½","blog"],"title":"Androidç³»ç»ŸçŠ¶æ€æ å®šåˆ¶","uri":"/posts/android%E7%B3%BB%E7%BB%9F%E7%8A%B6%E6%80%81%E6%A0%8F%E5%AE%9A%E5%88%B6/#statusiconcontainer--ondraw"},{"categories":null,"collections":["çŠ¶æ€æ ","Framework"],"content":"çŠ¶æ€æ å›¾æ ‡æ˜¾ç¤ºé€»è¾‘æ§åˆ¶ çŠ¶æ€æ å›¾æ ‡æ˜¾ç¤ºé€»è¾‘æ˜¯é€šè¿‡ StatusBarIconControllerImpl è¿™ä¸ªç±»æ¥å®ç°ç®¡ç†ï¼Œ åœ¨å¯¹è±¡æ„é€ çš„æ—¶å€™é»˜è®¤åˆå§‹åŒ– public StatusBarIconControllerImpl(Context context) { super(context.getResources().getStringArray( com.android.internal.R.array.config_statusBarIcons)); ... } config_statusBarIcons è¿™ä¸ªarrayä¸­åŒ…å«äº†æ‰€æœ‰æ”¯æŒçš„iconã€‚å¦‚æœ‰éœ€è¦å®šåˆ¶å›¾æ ‡é¡ºåºå¯åœ¨è¿™ä¸ªåˆ—è¡¨ä¸­å¯¹å›¾æ ‡å¯¹åº”çš„itemè¿›è¡Œè°ƒæ•´ã€‚ \u003cstring-array name=\"config_statusBarIcons\"\u003e \u003citem\u003e\u003cxliff:g id=\"id\"\u003e@string/status_bar_alarm_clock\u003c/xliff:g\u003e\u003c/item\u003e ... \u003citem\u003e\u003cxliff:g id=\"id\"\u003e@string/status_bar_battery\u003c/xliff:g\u003e\u003c/item\u003e \u003citem\u003e\u003cxliff:g id=\"id\"\u003e@string/status_bar_sensors_off\u003c/xliff:g\u003e\u003c/item\u003e \u003c/string-array\u003e è¿™äº› iconå­—ä¸²ä¿¡æ¯å½“åšä¸€ä¸ªtitleä¿¡æ¯ï¼Œä¿å­˜åœ¨mSlotsåˆ—è¡¨ä¸­ã€‚è€ŒSlotä¸­åŒ…å«StatusBarIconHolder: public static class Slot { private final String mName; private StatusBarIconHolder mHolder; ... } public class StatusBarIconHolder { public static final int TYPE_ICON = 0; public static final int TYPE_WIFI = 1; public static final int TYPE_MOBILE = 2; private StatusBarIcon mIcon; private WifiIconState mWifiState; private MobileIconState mMobileState; ... } å¯åŠ¨mIconå³ä¸ºæ˜¾ç¤ºçš„å›¾æ ‡èµ„æºä¿å­˜ç±»ã€‚å…¶ä¸­åŒ…å«äº†å›¾æ ‡æ˜¾ç¤ºçŠ¶æ€ï¼Œæ ‡ç­¾ä¿¡æ¯ä»¥åŠçŠ¶æ€ä¿¡æ¯ç­‰ã€‚å°†å…¶éƒ½ä¿å­˜åœ¨mSlogsçš„åˆ—è¡¨ä¸­ï¼Œæ–¹ä¾¿ç®¡ç†æ˜¾ç¤ºã€‚ æ€»ç»“æ•°æ®ä¿å­˜é“¾æ¡ Slotsâ€“\u003e StatusBarIconHolder â€“\u003e StatusBarIcon; å…³é”®viewç®¡ç† åœ¨çŠ¶æ€æ åˆå§‹åŒ–çš„æ—¶å€™ CollapsedStatusBarFragment çš„viewåˆ›å»ºä¸­ onViewCreatedå¯¹ç³»ç»Ÿiconç®¡ç†è¿›è¡Œåˆå§‹åŒ–ã€‚ mDarkIconManager = new DarkIconManager(view.findViewById(R.id.statusIcons)); mDarkIconManager.setShouldLog(true); Dependency.get(StatusBarIconController.class).addIconGroup(mDarkIconManager); DarkIconManager æ„é€ å‡½æ•°ä¸­ä¼ å…¥äº†system_iconçš„å®¹å™¨viewgroup, è´Ÿè´£viewçš„å¢åŠ å’Œåˆ é™¤ã€‚StatusBarIconControllerç®¡ç†DarkIconManager. è¿™æ ·æ˜¾ç¤ºå›¾æ ‡åŒºåŸŸæ§åˆ¶éƒ¨åˆ†ä¸æ˜¾ç¤ºéƒ¨åˆ†å…³è”èµ·æ¥ã€‚ å›¾æ ‡å¦‚ä½•æ›´æ–°ï¼Ÿ æ§åˆ¶ç®¡ç†çš„å®ç°ç­–ç•¥ç±»éƒ½åœ¨ PhoneStatusBarPolicy è¿™ä¸ªé‡Œé¢å®ç°ã€‚ å…·ä½“å®ç°é€šè¿‡StatusBarIconControllerImplç±»å®ç°ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ¥å£æ›´æ–°æ˜¾ç¤ºå›¾æ ‡ã€‚ mIconController.setIcon(mSlotVolume, volumeIconId, volumeDescription); mIconController.setIconVisibility(mSlotVolume, volumeVisible); ä»¥éŸ³é‡æ›´æ–°ä¸ºä¾‹ã€‚setIconæµç¨‹åˆ†æã€‚ @Override public void setIcon(String slot, int resourceId, CharSequence contentDescription) { // æ£€æŸ¥æ˜¯å¦åœ¨åˆ—è¡¨ä¸­å­˜åœ¨holderï¼Œé»˜è®¤åˆå§‹æƒ…å†µä¸‹æ˜¯éƒ½æ²¡æœ‰holderçš„ï¼Œéœ€è¦æ–°å»º int index = getSlotIndex(slot); StatusBarIconHolder holder = getIcon(index, 0); if (holder == null) { å…ˆé€šè¿‡resoureidå’Œ contentDescriptionåˆ›å»ºä¸€ä¸ªStatusBarIconå®ä¾‹ StatusBarIcon icon = new StatusBarIcon(UserHandle.SYSTEM, mContext.getPackageName(), Icon.createWithResource( mContext, resourceId), 0, 0, contentDescription); // é€šè¿‡iconå°è£…ä¸€ä¸ªholderã€‚ holder = StatusBarIconHolder.fromIcon(icon); // å°†holderèµ‹å€¼ç»™mSlots setIcon(index, holder); } else { holder.getIcon().icon = Icon.createWithResource(mContext, resourceId); holder.getIcon().contentDescription = contentDescription; handleSet(index, holder); } } ä¼ å…¥slotä¸ºiconçš„titleï¼Œ resourceIdä¸ºèµ„æºæ–‡ä»¶ï¼ŒcontentDescriptionä¸ºæè¿°å­—ä¸²ã€‚å¦‚æœåˆ¤æ–­ä¸ºæ²¡æœ‰holderå°±ä¼šæ–°å»ºä¸€ä¸ªholderç±»ï¼Œå¹¶ä¼ å…¥mSlotsçš„åˆ—è¡¨ä¸­ã€‚ @Override public void setIcon(int index, @NonNull StatusBarIconHolder holder) { boolean isNew = getIcon(index, holder.getTag()) == null; super.setIcon(index, holder); if (isNew) { // é€šè¿‡tagåˆ¤æ–­å¦‚æœæ˜¯æ–°çš„å°±åŠ åˆ°systemiconä¸­ addSystemIcon(index, holder); } else { //å·²ç»å­˜åœ¨çš„ç›´æ¥è®¾ç½® handleSet(index, holder); } } private void addSystemIcon(int index, StatusBarIconHolder holder) { String slot = getSlotName(index); int viewIndex = getViewIndex(index, holder.getTag()); boolean blocked = mIconBlacklist.contains(slot); mIconGroups.forEach(l -\u003e l.onIconAdded(viewIndex, slot, blocked, holder)); } onIconAddedæ˜¯åœ¨DarkIconManagerä¸­å®ç°ã€‚ protected void onIconAdded(int index, String slot, boolean blocked, StatusBarIconHolder holder) { addHolder(index, slot, blocked, holder); } protected StatusIconDisplayable addHolder(int index, String slot, boolean blocked, StatusBarIconHolder holder) { switch (holder.getType()) { case TYPE_ICON: return addIcon(index, slot, blocked, holder.getIcon()); case TYPE_WIFI: return addSignalIcon(index, slot, holder.getWifiState()); case TYPE_MOBILE: return addMobileIcon(index, slot, holder.getMobileState()); } return null; } protected StatusBarIconView addIcon(int index, String slot, boolean blocked, StatusBarIcon icon) { StatusBarIconView view = onCreateStatusBarIconView(slot, blocked); view.set(icon); //mGroup å³ä¸ºçŠ¶æ€æ ç³»ç»Ÿå›¾æ ‡çš„å®¹å™¨viewã€‚è¿™é‡Œå°±å®Œæˆäº†viewçš„æ·»åŠ  mGroup.addView(view, in","date":"2024-11-06","objectID":"/posts/android%E7%B3%BB%E7%BB%9F%E7%8A%B6%E6%80%81%E6%A0%8F%E5%AE%9A%E5%88%B6/:0:3","tags":["clippings","è½¬è½½","blog"],"title":"Androidç³»ç»ŸçŠ¶æ€æ å®šåˆ¶","uri":"/posts/android%E7%B3%BB%E7%BB%9F%E7%8A%B6%E6%80%81%E6%A0%8F%E5%AE%9A%E5%88%B6/#çŠ¶æ€æ å›¾æ ‡æ˜¾ç¤ºé€»è¾‘æ§åˆ¶"},{"categories":null,"collections":["çŠ¶æ€æ ","Framework"],"content":"çŠ¶æ€æ å›¾æ ‡æ˜¾ç¤ºé€»è¾‘æ§åˆ¶ çŠ¶æ€æ å›¾æ ‡æ˜¾ç¤ºé€»è¾‘æ˜¯é€šè¿‡ StatusBarIconControllerImpl è¿™ä¸ªç±»æ¥å®ç°ç®¡ç†ï¼Œ åœ¨å¯¹è±¡æ„é€ çš„æ—¶å€™é»˜è®¤åˆå§‹åŒ– public StatusBarIconControllerImpl(Context context) { super(context.getResources().getStringArray( com.android.internal.R.array.config_statusBarIcons)); ... } config_statusBarIcons è¿™ä¸ªarrayä¸­åŒ…å«äº†æ‰€æœ‰æ”¯æŒçš„iconã€‚å¦‚æœ‰éœ€è¦å®šåˆ¶å›¾æ ‡é¡ºåºå¯åœ¨è¿™ä¸ªåˆ—è¡¨ä¸­å¯¹å›¾æ ‡å¯¹åº”çš„itemè¿›è¡Œè°ƒæ•´ã€‚ @string/status_bar_alarm_clock ... @string/status_bar_battery @string/status_bar_sensors_off è¿™äº› iconå­—ä¸²ä¿¡æ¯å½“åšä¸€ä¸ªtitleä¿¡æ¯ï¼Œä¿å­˜åœ¨mSlotsåˆ—è¡¨ä¸­ã€‚è€ŒSlotä¸­åŒ…å«StatusBarIconHolder: public static class Slot { private final String mName; private StatusBarIconHolder mHolder; ... } public class StatusBarIconHolder { public static final int TYPE_ICON = 0; public static final int TYPE_WIFI = 1; public static final int TYPE_MOBILE = 2; private StatusBarIcon mIcon; private WifiIconState mWifiState; private MobileIconState mMobileState; ... } å¯åŠ¨mIconå³ä¸ºæ˜¾ç¤ºçš„å›¾æ ‡èµ„æºä¿å­˜ç±»ã€‚å…¶ä¸­åŒ…å«äº†å›¾æ ‡æ˜¾ç¤ºçŠ¶æ€ï¼Œæ ‡ç­¾ä¿¡æ¯ä»¥åŠçŠ¶æ€ä¿¡æ¯ç­‰ã€‚å°†å…¶éƒ½ä¿å­˜åœ¨mSlogsçš„åˆ—è¡¨ä¸­ï¼Œæ–¹ä¾¿ç®¡ç†æ˜¾ç¤ºã€‚ æ€»ç»“æ•°æ®ä¿å­˜é“¾æ¡ Slotsâ€“\u003e StatusBarIconHolder â€“\u003e StatusBarIcon; å…³é”®viewç®¡ç† åœ¨çŠ¶æ€æ åˆå§‹åŒ–çš„æ—¶å€™ CollapsedStatusBarFragment çš„viewåˆ›å»ºä¸­ onViewCreatedå¯¹ç³»ç»Ÿiconç®¡ç†è¿›è¡Œåˆå§‹åŒ–ã€‚ mDarkIconManager = new DarkIconManager(view.findViewById(R.id.statusIcons)); mDarkIconManager.setShouldLog(true); Dependency.get(StatusBarIconController.class).addIconGroup(mDarkIconManager); DarkIconManager æ„é€ å‡½æ•°ä¸­ä¼ å…¥äº†system_iconçš„å®¹å™¨viewgroup, è´Ÿè´£viewçš„å¢åŠ å’Œåˆ é™¤ã€‚StatusBarIconControllerç®¡ç†DarkIconManager. è¿™æ ·æ˜¾ç¤ºå›¾æ ‡åŒºåŸŸæ§åˆ¶éƒ¨åˆ†ä¸æ˜¾ç¤ºéƒ¨åˆ†å…³è”èµ·æ¥ã€‚ å›¾æ ‡å¦‚ä½•æ›´æ–°ï¼Ÿ æ§åˆ¶ç®¡ç†çš„å®ç°ç­–ç•¥ç±»éƒ½åœ¨ PhoneStatusBarPolicy è¿™ä¸ªé‡Œé¢å®ç°ã€‚ å…·ä½“å®ç°é€šè¿‡StatusBarIconControllerImplç±»å®ç°ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ¥å£æ›´æ–°æ˜¾ç¤ºå›¾æ ‡ã€‚ mIconController.setIcon(mSlotVolume, volumeIconId, volumeDescription); mIconController.setIconVisibility(mSlotVolume, volumeVisible); ä»¥éŸ³é‡æ›´æ–°ä¸ºä¾‹ã€‚setIconæµç¨‹åˆ†æã€‚ @Override public void setIcon(String slot, int resourceId, CharSequence contentDescription) { // æ£€æŸ¥æ˜¯å¦åœ¨åˆ—è¡¨ä¸­å­˜åœ¨holderï¼Œé»˜è®¤åˆå§‹æƒ…å†µä¸‹æ˜¯éƒ½æ²¡æœ‰holderçš„ï¼Œéœ€è¦æ–°å»º int index = getSlotIndex(slot); StatusBarIconHolder holder = getIcon(index, 0); if (holder == null) { å…ˆé€šè¿‡resoureidå’Œ contentDescriptionåˆ›å»ºä¸€ä¸ªStatusBarIconå®ä¾‹ StatusBarIcon icon = new StatusBarIcon(UserHandle.SYSTEM, mContext.getPackageName(), Icon.createWithResource( mContext, resourceId), 0, 0, contentDescription); // é€šè¿‡iconå°è£…ä¸€ä¸ªholderã€‚ holder = StatusBarIconHolder.fromIcon(icon); // å°†holderèµ‹å€¼ç»™mSlots setIcon(index, holder); } else { holder.getIcon().icon = Icon.createWithResource(mContext, resourceId); holder.getIcon().contentDescription = contentDescription; handleSet(index, holder); } } ä¼ å…¥slotä¸ºiconçš„titleï¼Œ resourceIdä¸ºèµ„æºæ–‡ä»¶ï¼ŒcontentDescriptionä¸ºæè¿°å­—ä¸²ã€‚å¦‚æœåˆ¤æ–­ä¸ºæ²¡æœ‰holderå°±ä¼šæ–°å»ºä¸€ä¸ªholderç±»ï¼Œå¹¶ä¼ å…¥mSlotsçš„åˆ—è¡¨ä¸­ã€‚ @Override public void setIcon(int index, @NonNull StatusBarIconHolder holder) { boolean isNew = getIcon(index, holder.getTag()) == null; super.setIcon(index, holder); if (isNew) { // é€šè¿‡tagåˆ¤æ–­å¦‚æœæ˜¯æ–°çš„å°±åŠ åˆ°systemiconä¸­ addSystemIcon(index, holder); } else { //å·²ç»å­˜åœ¨çš„ç›´æ¥è®¾ç½® handleSet(index, holder); } } private void addSystemIcon(int index, StatusBarIconHolder holder) { String slot = getSlotName(index); int viewIndex = getViewIndex(index, holder.getTag()); boolean blocked = mIconBlacklist.contains(slot); mIconGroups.forEach(l -\u003e l.onIconAdded(viewIndex, slot, blocked, holder)); } onIconAddedæ˜¯åœ¨DarkIconManagerä¸­å®ç°ã€‚ protected void onIconAdded(int index, String slot, boolean blocked, StatusBarIconHolder holder) { addHolder(index, slot, blocked, holder); } protected StatusIconDisplayable addHolder(int index, String slot, boolean blocked, StatusBarIconHolder holder) { switch (holder.getType()) { case TYPE_ICON: return addIcon(index, slot, blocked, holder.getIcon()); case TYPE_WIFI: return addSignalIcon(index, slot, holder.getWifiState()); case TYPE_MOBILE: return addMobileIcon(index, slot, holder.getMobileState()); } return null; } protected StatusBarIconView addIcon(int index, String slot, boolean blocked, StatusBarIcon icon) { StatusBarIconView view = onCreateStatusBarIconView(slot, blocked); view.set(icon); //mGroup å³ä¸ºçŠ¶æ€æ ç³»ç»Ÿå›¾æ ‡çš„å®¹å™¨viewã€‚è¿™é‡Œå°±å®Œæˆäº†viewçš„æ·»åŠ  mGroup.addView(view, in","date":"2024-11-06","objectID":"/posts/android%E7%B3%BB%E7%BB%9F%E7%8A%B6%E6%80%81%E6%A0%8F%E5%AE%9A%E5%88%B6/:0:3","tags":["clippings","è½¬è½½","blog"],"title":"Androidç³»ç»ŸçŠ¶æ€æ å®šåˆ¶","uri":"/posts/android%E7%B3%BB%E7%BB%9F%E7%8A%B6%E6%80%81%E6%A0%8F%E5%AE%9A%E5%88%B6/#å…³é”®viewç®¡ç†"},{"categories":null,"collections":["çŠ¶æ€æ ","Framework"],"content":"çŠ¶æ€æ å›¾æ ‡æ˜¾ç¤ºé€»è¾‘æ§åˆ¶ çŠ¶æ€æ å›¾æ ‡æ˜¾ç¤ºé€»è¾‘æ˜¯é€šè¿‡ StatusBarIconControllerImpl è¿™ä¸ªç±»æ¥å®ç°ç®¡ç†ï¼Œ åœ¨å¯¹è±¡æ„é€ çš„æ—¶å€™é»˜è®¤åˆå§‹åŒ– public StatusBarIconControllerImpl(Context context) { super(context.getResources().getStringArray( com.android.internal.R.array.config_statusBarIcons)); ... } config_statusBarIcons è¿™ä¸ªarrayä¸­åŒ…å«äº†æ‰€æœ‰æ”¯æŒçš„iconã€‚å¦‚æœ‰éœ€è¦å®šåˆ¶å›¾æ ‡é¡ºåºå¯åœ¨è¿™ä¸ªåˆ—è¡¨ä¸­å¯¹å›¾æ ‡å¯¹åº”çš„itemè¿›è¡Œè°ƒæ•´ã€‚ @string/status_bar_alarm_clock ... @string/status_bar_battery @string/status_bar_sensors_off è¿™äº› iconå­—ä¸²ä¿¡æ¯å½“åšä¸€ä¸ªtitleä¿¡æ¯ï¼Œä¿å­˜åœ¨mSlotsåˆ—è¡¨ä¸­ã€‚è€ŒSlotä¸­åŒ…å«StatusBarIconHolder: public static class Slot { private final String mName; private StatusBarIconHolder mHolder; ... } public class StatusBarIconHolder { public static final int TYPE_ICON = 0; public static final int TYPE_WIFI = 1; public static final int TYPE_MOBILE = 2; private StatusBarIcon mIcon; private WifiIconState mWifiState; private MobileIconState mMobileState; ... } å¯åŠ¨mIconå³ä¸ºæ˜¾ç¤ºçš„å›¾æ ‡èµ„æºä¿å­˜ç±»ã€‚å…¶ä¸­åŒ…å«äº†å›¾æ ‡æ˜¾ç¤ºçŠ¶æ€ï¼Œæ ‡ç­¾ä¿¡æ¯ä»¥åŠçŠ¶æ€ä¿¡æ¯ç­‰ã€‚å°†å…¶éƒ½ä¿å­˜åœ¨mSlogsçš„åˆ—è¡¨ä¸­ï¼Œæ–¹ä¾¿ç®¡ç†æ˜¾ç¤ºã€‚ æ€»ç»“æ•°æ®ä¿å­˜é“¾æ¡ Slotsâ€“\u003e StatusBarIconHolder â€“\u003e StatusBarIcon; å…³é”®viewç®¡ç† åœ¨çŠ¶æ€æ åˆå§‹åŒ–çš„æ—¶å€™ CollapsedStatusBarFragment çš„viewåˆ›å»ºä¸­ onViewCreatedå¯¹ç³»ç»Ÿiconç®¡ç†è¿›è¡Œåˆå§‹åŒ–ã€‚ mDarkIconManager = new DarkIconManager(view.findViewById(R.id.statusIcons)); mDarkIconManager.setShouldLog(true); Dependency.get(StatusBarIconController.class).addIconGroup(mDarkIconManager); DarkIconManager æ„é€ å‡½æ•°ä¸­ä¼ å…¥äº†system_iconçš„å®¹å™¨viewgroup, è´Ÿè´£viewçš„å¢åŠ å’Œåˆ é™¤ã€‚StatusBarIconControllerç®¡ç†DarkIconManager. è¿™æ ·æ˜¾ç¤ºå›¾æ ‡åŒºåŸŸæ§åˆ¶éƒ¨åˆ†ä¸æ˜¾ç¤ºéƒ¨åˆ†å…³è”èµ·æ¥ã€‚ å›¾æ ‡å¦‚ä½•æ›´æ–°ï¼Ÿ æ§åˆ¶ç®¡ç†çš„å®ç°ç­–ç•¥ç±»éƒ½åœ¨ PhoneStatusBarPolicy è¿™ä¸ªé‡Œé¢å®ç°ã€‚ å…·ä½“å®ç°é€šè¿‡StatusBarIconControllerImplç±»å®ç°ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ¥å£æ›´æ–°æ˜¾ç¤ºå›¾æ ‡ã€‚ mIconController.setIcon(mSlotVolume, volumeIconId, volumeDescription); mIconController.setIconVisibility(mSlotVolume, volumeVisible); ä»¥éŸ³é‡æ›´æ–°ä¸ºä¾‹ã€‚setIconæµç¨‹åˆ†æã€‚ @Override public void setIcon(String slot, int resourceId, CharSequence contentDescription) { // æ£€æŸ¥æ˜¯å¦åœ¨åˆ—è¡¨ä¸­å­˜åœ¨holderï¼Œé»˜è®¤åˆå§‹æƒ…å†µä¸‹æ˜¯éƒ½æ²¡æœ‰holderçš„ï¼Œéœ€è¦æ–°å»º int index = getSlotIndex(slot); StatusBarIconHolder holder = getIcon(index, 0); if (holder == null) { å…ˆé€šè¿‡resoureidå’Œ contentDescriptionåˆ›å»ºä¸€ä¸ªStatusBarIconå®ä¾‹ StatusBarIcon icon = new StatusBarIcon(UserHandle.SYSTEM, mContext.getPackageName(), Icon.createWithResource( mContext, resourceId), 0, 0, contentDescription); // é€šè¿‡iconå°è£…ä¸€ä¸ªholderã€‚ holder = StatusBarIconHolder.fromIcon(icon); // å°†holderèµ‹å€¼ç»™mSlots setIcon(index, holder); } else { holder.getIcon().icon = Icon.createWithResource(mContext, resourceId); holder.getIcon().contentDescription = contentDescription; handleSet(index, holder); } } ä¼ å…¥slotä¸ºiconçš„titleï¼Œ resourceIdä¸ºèµ„æºæ–‡ä»¶ï¼ŒcontentDescriptionä¸ºæè¿°å­—ä¸²ã€‚å¦‚æœåˆ¤æ–­ä¸ºæ²¡æœ‰holderå°±ä¼šæ–°å»ºä¸€ä¸ªholderç±»ï¼Œå¹¶ä¼ å…¥mSlotsçš„åˆ—è¡¨ä¸­ã€‚ @Override public void setIcon(int index, @NonNull StatusBarIconHolder holder) { boolean isNew = getIcon(index, holder.getTag()) == null; super.setIcon(index, holder); if (isNew) { // é€šè¿‡tagåˆ¤æ–­å¦‚æœæ˜¯æ–°çš„å°±åŠ åˆ°systemiconä¸­ addSystemIcon(index, holder); } else { //å·²ç»å­˜åœ¨çš„ç›´æ¥è®¾ç½® handleSet(index, holder); } } private void addSystemIcon(int index, StatusBarIconHolder holder) { String slot = getSlotName(index); int viewIndex = getViewIndex(index, holder.getTag()); boolean blocked = mIconBlacklist.contains(slot); mIconGroups.forEach(l -\u003e l.onIconAdded(viewIndex, slot, blocked, holder)); } onIconAddedæ˜¯åœ¨DarkIconManagerä¸­å®ç°ã€‚ protected void onIconAdded(int index, String slot, boolean blocked, StatusBarIconHolder holder) { addHolder(index, slot, blocked, holder); } protected StatusIconDisplayable addHolder(int index, String slot, boolean blocked, StatusBarIconHolder holder) { switch (holder.getType()) { case TYPE_ICON: return addIcon(index, slot, blocked, holder.getIcon()); case TYPE_WIFI: return addSignalIcon(index, slot, holder.getWifiState()); case TYPE_MOBILE: return addMobileIcon(index, slot, holder.getMobileState()); } return null; } protected StatusBarIconView addIcon(int index, String slot, boolean blocked, StatusBarIcon icon) { StatusBarIconView view = onCreateStatusBarIconView(slot, blocked); view.set(icon); //mGroup å³ä¸ºçŠ¶æ€æ ç³»ç»Ÿå›¾æ ‡çš„å®¹å™¨viewã€‚è¿™é‡Œå°±å®Œæˆäº†viewçš„æ·»åŠ  mGroup.addView(view, in","date":"2024-11-06","objectID":"/posts/android%E7%B3%BB%E7%BB%9F%E7%8A%B6%E6%80%81%E6%A0%8F%E5%AE%9A%E5%88%B6/:0:3","tags":["clippings","è½¬è½½","blog"],"title":"Androidç³»ç»ŸçŠ¶æ€æ å®šåˆ¶","uri":"/posts/android%E7%B3%BB%E7%BB%9F%E7%8A%B6%E6%80%81%E6%A0%8F%E5%AE%9A%E5%88%B6/#å›¾æ ‡å¦‚ä½•æ›´æ–°"},{"categories":null,"collections":["çŠ¶æ€æ ","Framework"],"content":"å¦‚ä½•å®šåˆ¶ï¼Ÿ æ•°é‡å’Œé¡ºåº é€šè¿‡é…ç½® config_statusBarIcons å¢åˆ è‡ªå·±éœ€è¦çš„å›¾æ ‡ã€‚ çŠ¶æ€æ å¤§å°å®šåˆ¶ framework/base/core/res/res/values/dimens.xml é…ç½®é¡¹ è¯´æ˜ status_bar_height_portrait çŠ¶æ€æ é«˜åº¦ status_bar_system_icon_intrinsic_size ç³»ç»Ÿå›¾æ ‡æœŸæœ›å¤§å°ï¼Œ ç”¨äºiconçš„ç¼©æ”¾ï¼Œå’Œicon_sizeè®¾ç½®ä¸€æ ·å¤§å°å³å¯ status_bar_system_icon_size ç³»ç»Ÿå›¾æ ‡å¤§å° SystemUI/res/values/dimens.xml é…ç½®é¡¹ è¯´æ˜ status_bar_padding_start çŠ¶æ€æ ç¦»å·¦ä¾§ç©ºé—´ status_bar_padding_end çŠ¶æ€æ ç¦»å³ä¾§ç©ºé—´ signal_cluster_battery_padding ç³»ç»Ÿå›¾æ ‡ç¦»ç”µæ± å›¾æ ‡è·ç¦» å›¾æ ‡æ˜¾ç¤ºå®šåˆ¶ é€šè¿‡ä¸Šè¿°åˆ†æä»£ç  setIconæ‰¾åˆ°å¯¹åº”çš„iconè¿›è¡Œæ›¿æ¢è‡ªå·±é¡¹ç›®çš„iconï¼Œ StatusIconContainerä¸­éœ€è¦ä¿®æ”¹MAX_DOTSä¸º0ï¼Œä¸æ˜¾ç¤ºçœç•¥ç‚¹ã€‚å†onLayoutçš„æ—¶å€™éœ€è¦æ ¹æ®é¡¹ç›®è®¾ç½®iconçš„é—´è·ï¼Œ child.layoutä¸­å¢åŠ rå€¼ã€‚ æ˜¾ç¤ºé€»è¾‘ç­–ç•¥éƒ½åœ¨PhoneStatusBarPhicyä¸­å®ç°ï¼Œå°¤å…¶æ˜¯ç³»ç»ŸåŸç”Ÿæ²¡æœ‰æ”¯æŒçš„å›¾æ ‡é€»è¾‘ä¼šå®šåˆ¶è¾ƒå¤šã€‚ æ³¨æ„äº‹é¡¹ï¼š å›¾æ ‡é€‰æ‹©ï¼Œä½¿ç”¨æ–°çš„svgå›¾æ ‡æ—¶ï¼Œ å®½é«˜æœ€å¥½å’Œç³»ç»Ÿsystem_icon_sizeè®¾ç½®ä¸ºä¸€è‡´ï¼ŒåŸç”Ÿé€»è¾‘ä¼šæŠŠå›¾æ ‡ç¼©æ”¾åˆ°é«˜åº¦å’Œsystem_iconä¸€è‡´ï¼Œå€’æ˜¯å®½åº¦å´ä¿æŒäº†åŸæœ‰å›¾æ ‡å®½ï¼Œå¯¼è‡´æ˜¾ç¤ºå¸ƒå±€ä¸å¯¹ã€‚ ","date":"2024-11-06","objectID":"/posts/android%E7%B3%BB%E7%BB%9F%E7%8A%B6%E6%80%81%E6%A0%8F%E5%AE%9A%E5%88%B6/:0:4","tags":["clippings","è½¬è½½","blog"],"title":"Androidç³»ç»ŸçŠ¶æ€æ å®šåˆ¶","uri":"/posts/android%E7%B3%BB%E7%BB%9F%E7%8A%B6%E6%80%81%E6%A0%8F%E5%AE%9A%E5%88%B6/#å¦‚ä½•å®šåˆ¶"},{"categories":null,"collections":["çŠ¶æ€æ ","Framework"],"content":"å¦‚ä½•å®šåˆ¶ï¼Ÿ æ•°é‡å’Œé¡ºåº é€šè¿‡é…ç½® config_statusBarIcons å¢åˆ è‡ªå·±éœ€è¦çš„å›¾æ ‡ã€‚ çŠ¶æ€æ å¤§å°å®šåˆ¶ framework/base/core/res/res/values/dimens.xml é…ç½®é¡¹ è¯´æ˜ status_bar_height_portrait çŠ¶æ€æ é«˜åº¦ status_bar_system_icon_intrinsic_size ç³»ç»Ÿå›¾æ ‡æœŸæœ›å¤§å°ï¼Œ ç”¨äºiconçš„ç¼©æ”¾ï¼Œå’Œicon_sizeè®¾ç½®ä¸€æ ·å¤§å°å³å¯ status_bar_system_icon_size ç³»ç»Ÿå›¾æ ‡å¤§å° SystemUI/res/values/dimens.xml é…ç½®é¡¹ è¯´æ˜ status_bar_padding_start çŠ¶æ€æ ç¦»å·¦ä¾§ç©ºé—´ status_bar_padding_end çŠ¶æ€æ ç¦»å³ä¾§ç©ºé—´ signal_cluster_battery_padding ç³»ç»Ÿå›¾æ ‡ç¦»ç”µæ± å›¾æ ‡è·ç¦» å›¾æ ‡æ˜¾ç¤ºå®šåˆ¶ é€šè¿‡ä¸Šè¿°åˆ†æä»£ç  setIconæ‰¾åˆ°å¯¹åº”çš„iconè¿›è¡Œæ›¿æ¢è‡ªå·±é¡¹ç›®çš„iconï¼Œ StatusIconContainerä¸­éœ€è¦ä¿®æ”¹MAX_DOTSä¸º0ï¼Œä¸æ˜¾ç¤ºçœç•¥ç‚¹ã€‚å†onLayoutçš„æ—¶å€™éœ€è¦æ ¹æ®é¡¹ç›®è®¾ç½®iconçš„é—´è·ï¼Œ child.layoutä¸­å¢åŠ rå€¼ã€‚ æ˜¾ç¤ºé€»è¾‘ç­–ç•¥éƒ½åœ¨PhoneStatusBarPhicyä¸­å®ç°ï¼Œå°¤å…¶æ˜¯ç³»ç»ŸåŸç”Ÿæ²¡æœ‰æ”¯æŒçš„å›¾æ ‡é€»è¾‘ä¼šå®šåˆ¶è¾ƒå¤šã€‚ æ³¨æ„äº‹é¡¹ï¼š å›¾æ ‡é€‰æ‹©ï¼Œä½¿ç”¨æ–°çš„svgå›¾æ ‡æ—¶ï¼Œ å®½é«˜æœ€å¥½å’Œç³»ç»Ÿsystem_icon_sizeè®¾ç½®ä¸ºä¸€è‡´ï¼ŒåŸç”Ÿé€»è¾‘ä¼šæŠŠå›¾æ ‡ç¼©æ”¾åˆ°é«˜åº¦å’Œsystem_iconä¸€è‡´ï¼Œå€’æ˜¯å®½åº¦å´ä¿æŒäº†åŸæœ‰å›¾æ ‡å®½ï¼Œå¯¼è‡´æ˜¾ç¤ºå¸ƒå±€ä¸å¯¹ã€‚ ","date":"2024-11-06","objectID":"/posts/android%E7%B3%BB%E7%BB%9F%E7%8A%B6%E6%80%81%E6%A0%8F%E5%AE%9A%E5%88%B6/:0:4","tags":["clippings","è½¬è½½","blog"],"title":"Androidç³»ç»ŸçŠ¶æ€æ å®šåˆ¶","uri":"/posts/android%E7%B3%BB%E7%BB%9F%E7%8A%B6%E6%80%81%E6%A0%8F%E5%AE%9A%E5%88%B6/#æ³¨æ„äº‹é¡¹"},{"categories":"Android","collections":null,"content":" style: nestedList # TOC style (nestedList|inlineFirstLevel) maxLevel: 0 # Include headings up to the speficied level includeLinks: true # Make headings clickable debugInConsole: false # Print debug info in Obsidian console ","date":"2024-11-06","objectID":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/:0:0","tags":["blog","å®æˆ˜"],"title":"Archer\u0026ArcherIS APç­¾åæ–¹æ¡ˆæ€»ç»“","uri":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/#"},{"categories":"Android","collections":null,"content":"å…³äºAPç«¯ HSMç­¾åçš„é…ç½®è¯´æ˜ Archer é¡¹ç›®ç­¾åä½¿ç”¨çš„åŠ å¯†ç‹—æ¥è‡ªYubiHSM å…·ä½“çš„ä¸€äº›æ“ä½œè¯´æ˜éœ€è¦åˆ°å®˜ç½‘å¯»æ‰¾ï¼š YubiHSM2 ç”¨äºç­¾åçš„HSMé¡¹ç›®ç›®å‰æœ‰: Archer A11 Archer A13 ArcherIS ç¼–è¯‘çš„æœåŠ¡å™¨åˆ†åˆ«åœ¨åŒ—äº¬å’Œæ²ˆé˜³ åŒ—äº¬æœåŠ¡å™¨ ä¸Šæ’ç€ä¸¤ä¸ªåŠ å¯†ç‹— ä¸€ä¸ªåŠ å¯†ç‹— ç”¨äº ArcherIS ==serial=0016980259== ç›®å‰çš„usb serial noï¼š connector=yhusb://serial=0016980259 é…ç½®å’Œå¯†ç ï¼š [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so INIT_ARGS = \"connector=yhusb://serial=0016980259\" # PIN is the \u003ckey_id\u003e\u003ckey-password\u003e, by default this is 0001password. Meaning the default key_id is '0001' and the default password is 'password' # key_id = 0x2873 password = ef94cc600359806750df6595bbdf9652 # remove the 0x from the key_id and add the password to the end of it # PIN = \u003ckey_id\u003e\u003cpassword\u003e # PIN = \u003c2873\u003e\u003cef94cc600359806750df6595bbdf9652\u003e # PIN = 5147bb4dc2069b1094a80b0311a91afd72f8 PIN = \"5147bb4dc2069b1094a80b0311a91afd72f8\" init = 0 åˆ—å‡ºé‡Œé¢çš„pkcs11 keyçš„æƒ…å†µï¼š builder@builder:~/archeris_hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_connector.conf keytool -list -keystore NONE -storetype PKCS11 -storepass 5147bb4dc2069b1094a80b0311a91afd72f8 -providerClass sun.security.pkcs11.SunPKCS11 -providerArg ./conf/hsm_config.conf Keystore type: PKCS11 Keystore provider: SunPKCS11-yubihsm-pkcs Your keystore contains 9 entries is_platform, PrivateKeyEntry, Certificate fingerprint (SHA-256): 4A:EE:97:7C:1C:10:E4:1A:59:38:8F:3A:20:27:17:55:3C:EF:7E:7D:30:B4:10:B1:40:15:09:FC:4F:57:7D:79 media, PrivateKeyEntry, Certificate fingerprint (SHA-256): 90:02:EB:69:82:F9:B8:F1:6A:0F:02:2F:03:0E:F8:AC:6E:78:27:41:86:D1:D8:0F:87:39:A1:2D:40:49:2F:1C networkstack, PrivateKeyEntry, Certificate fingerprint (SHA-256): B7:7A:E1:E4:80:90:73:DC:C2:D1:09:BB:E8:28:81:65:29:BF:97:7C:33:07:73:53:8C:67:11:14:F8:69:17:49 partner, PrivateKeyEntry, Certificate fingerprint (SHA-256): 12:13:92:C9:91:78:7C:96:84:25:1C:A3:49:94:CF:E6:C8:E7:90:85:F7:E7:4D:15:A6:D9:D7:86:81:E1:51:51 platform, PrivateKeyEntry, Certificate fingerprint (SHA-256): D8:4F:01:E6:6F:5E:CD:05:4A:B3:67:0F:EA:5A:E1:FA:EA:A7:73:04:A2:9D:F1:C2:59:48:09:52:E5:FB:C4:6B release, PrivateKeyEntry, Certificate fingerprint (SHA-256): 09:55:75:AE:AE:A3:AE:20:BB:B9:43:2C:1D:47:73:09:BC:E4:22:A0:F3:60:38:0F:E0:31:2F:2C:FE:27:D9:3F shared, PrivateKeyEntry, Certificate fingerprint (SHA-256): 84:CE:CB:ED:38:A7:00:AB:D1:E4:71:0C:8C:51:0D:3F:77:D6:B2:CB:72:B3:96:94:83:7A:A8:8A:FE:C2:93:9B webview, PrivateKeyEntry, Certificate fingerprint (SHA-256): 06:DC:3A:86:59:EF:66:95:5B:C6:18:37:A3:D1:F3:5D:44:18:01:59:43:0D:3B:27:ED:B6:A7:D5:80:0C:7A:EA wrap_259, SecretKeyEntry, ç”¨é€”ï¼š ArcherIS AP apk ç­¾å ArcherIS releasekey otaç­¾å Archer A13 AP apk ç­¾å(è®¡åˆ’ä¸­ï¼ŒéªŒè¯ä¸­) Archer A13 ç›®å‰å»¶ç”¨A11 çš„é¡¹ç›® release ota é‡‡ç”¨ç›´æ¥ç”¨releasekeyçš„æ–¹æ¡ˆ ä¸€ä¸ªåŠ å¯†ç‹— ç”¨äº Archer ==551== connector=yhusb://serial=0016499551 [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so dynamic_path = /usr/lib/x86_64-linux-gnu/openssl-1.0.0/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so PIN = \"60d4458874be39d674225d861b3080f02068\" INIT_ARGS = \"connector=yhusb://serial=0016499551\" #INIT_ARGS = \"connector=http://localhost:12345\" init = 0 builder@builder:~/hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_connector.conf keytool -list -keystore NONE -storetype PKCS11 -storepass 60d4458874be39d674225d861b3080f02068 -providerClass sun.security.pkcs11.SunPKCS11 -providerArg ./conf/hsm_config.conf Keystore type: PKCS11 Keystore provider: SunPKCS11-yubihsm-pkcs Your keystore contains 0 entries ç”¨é€”ï¼š ArcherIS CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ Archer A11 CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ Archer A13 CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ æ²ˆé˜³æœåŠ¡å™¨ ä¸Šæ’ç€ä¸€ä¸ªåŠ å¯†ç‹— Archer A11çš„é¡¹ç›® ==561== [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so INIT_ARGS = \"connector=yhusb://serial=0016499561\" PIN = \"2873ef94cc600359806750df6595bbdf9652\" init = 0 builder@builder-PowerEdge-R740:~/hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_conne","date":"2024-11-06","objectID":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/:0:1","tags":["blog","å®æˆ˜"],"title":"Archer\u0026ArcherIS APç­¾åæ–¹æ¡ˆæ€»ç»“","uri":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/#å…³äºapç«¯-hsmç­¾åçš„é…ç½®è¯´æ˜"},{"categories":"Android","collections":null,"content":"å…³äºAPç«¯ HSMç­¾åçš„é…ç½®è¯´æ˜ Archer é¡¹ç›®ç­¾åä½¿ç”¨çš„åŠ å¯†ç‹—æ¥è‡ªYubiHSM å…·ä½“çš„ä¸€äº›æ“ä½œè¯´æ˜éœ€è¦åˆ°å®˜ç½‘å¯»æ‰¾ï¼š YubiHSM2 ç”¨äºç­¾åçš„HSMé¡¹ç›®ç›®å‰æœ‰: Archer A11 Archer A13 ArcherIS ç¼–è¯‘çš„æœåŠ¡å™¨åˆ†åˆ«åœ¨åŒ—äº¬å’Œæ²ˆé˜³ åŒ—äº¬æœåŠ¡å™¨ ä¸Šæ’ç€ä¸¤ä¸ªåŠ å¯†ç‹— ä¸€ä¸ªåŠ å¯†ç‹— ç”¨äº ArcherIS ==serial=0016980259== ç›®å‰çš„usb serial noï¼š connector=yhusb://serial=0016980259 é…ç½®å’Œå¯†ç ï¼š [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so INIT_ARGS = \"connector=yhusb://serial=0016980259\" # PIN is the , by default this is 0001password. Meaning the default key_id is '0001' and the default password is 'password' # key_id = 0x2873 password = ef94cc600359806750df6595bbdf9652 # remove the 0x from the key_id and add the password to the end of it # PIN = # PIN = \u003c2873\u003e # PIN = 5147bb4dc2069b1094a80b0311a91afd72f8 PIN = \"5147bb4dc2069b1094a80b0311a91afd72f8\" init = 0 åˆ—å‡ºé‡Œé¢çš„pkcs11 keyçš„æƒ…å†µï¼š builder@builder:~/archeris_hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_connector.conf keytool -list -keystore NONE -storetype PKCS11 -storepass 5147bb4dc2069b1094a80b0311a91afd72f8 -providerClass sun.security.pkcs11.SunPKCS11 -providerArg ./conf/hsm_config.conf Keystore type: PKCS11 Keystore provider: SunPKCS11-yubihsm-pkcs Your keystore contains 9 entries is_platform, PrivateKeyEntry, Certificate fingerprint (SHA-256): 4A:EE:97:7C:1C:10:E4:1A:59:38:8F:3A:20:27:17:55:3C:EF:7E:7D:30:B4:10:B1:40:15:09:FC:4F:57:7D:79 media, PrivateKeyEntry, Certificate fingerprint (SHA-256): 90:02:EB:69:82:F9:B8:F1:6A:0F:02:2F:03:0E:F8:AC:6E:78:27:41:86:D1:D8:0F:87:39:A1:2D:40:49:2F:1C networkstack, PrivateKeyEntry, Certificate fingerprint (SHA-256): B7:7A:E1:E4:80:90:73:DC:C2:D1:09:BB:E8:28:81:65:29:BF:97:7C:33:07:73:53:8C:67:11:14:F8:69:17:49 partner, PrivateKeyEntry, Certificate fingerprint (SHA-256): 12:13:92:C9:91:78:7C:96:84:25:1C:A3:49:94:CF:E6:C8:E7:90:85:F7:E7:4D:15:A6:D9:D7:86:81:E1:51:51 platform, PrivateKeyEntry, Certificate fingerprint (SHA-256): D8:4F:01:E6:6F:5E:CD:05:4A:B3:67:0F:EA:5A:E1:FA:EA:A7:73:04:A2:9D:F1:C2:59:48:09:52:E5:FB:C4:6B release, PrivateKeyEntry, Certificate fingerprint (SHA-256): 09:55:75:AE:AE:A3:AE:20:BB:B9:43:2C:1D:47:73:09:BC:E4:22:A0:F3:60:38:0F:E0:31:2F:2C:FE:27:D9:3F shared, PrivateKeyEntry, Certificate fingerprint (SHA-256): 84:CE:CB:ED:38:A7:00:AB:D1:E4:71:0C:8C:51:0D:3F:77:D6:B2:CB:72:B3:96:94:83:7A:A8:8A:FE:C2:93:9B webview, PrivateKeyEntry, Certificate fingerprint (SHA-256): 06:DC:3A:86:59:EF:66:95:5B:C6:18:37:A3:D1:F3:5D:44:18:01:59:43:0D:3B:27:ED:B6:A7:D5:80:0C:7A:EA wrap_259, SecretKeyEntry, ç”¨é€”ï¼š ArcherIS AP apk ç­¾å ArcherIS releasekey otaç­¾å Archer A13 AP apk ç­¾å(è®¡åˆ’ä¸­ï¼ŒéªŒè¯ä¸­) Archer A13 ç›®å‰å»¶ç”¨A11 çš„é¡¹ç›® release ota é‡‡ç”¨ç›´æ¥ç”¨releasekeyçš„æ–¹æ¡ˆ ä¸€ä¸ªåŠ å¯†ç‹— ç”¨äº Archer ==551== connector=yhusb://serial=0016499551 [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so dynamic_path = /usr/lib/x86_64-linux-gnu/openssl-1.0.0/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so PIN = \"60d4458874be39d674225d861b3080f02068\" INIT_ARGS = \"connector=yhusb://serial=0016499551\" #INIT_ARGS = \"connector=http://localhost:12345\" init = 0 builder@builder:~/hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_connector.conf keytool -list -keystore NONE -storetype PKCS11 -storepass 60d4458874be39d674225d861b3080f02068 -providerClass sun.security.pkcs11.SunPKCS11 -providerArg ./conf/hsm_config.conf Keystore type: PKCS11 Keystore provider: SunPKCS11-yubihsm-pkcs Your keystore contains 0 entries ç”¨é€”ï¼š ArcherIS CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ Archer A11 CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ Archer A13 CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ æ²ˆé˜³æœåŠ¡å™¨ ä¸Šæ’ç€ä¸€ä¸ªåŠ å¯†ç‹— Archer A11çš„é¡¹ç›® ==561== [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so INIT_ARGS = \"connector=yhusb://serial=0016499561\" PIN = \"2873ef94cc600359806750df6595bbdf9652\" init = 0 builder@builder-PowerEdge-R740:~/hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_conne","date":"2024-11-06","objectID":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/:0:1","tags":["blog","å®æˆ˜"],"title":"Archer\u0026ArcherIS APç­¾åæ–¹æ¡ˆæ€»ç»“","uri":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/#ç”¨äºç­¾åçš„hsmé¡¹ç›®ç›®å‰æœ‰"},{"categories":"Android","collections":null,"content":"å…³äºAPç«¯ HSMç­¾åçš„é…ç½®è¯´æ˜ Archer é¡¹ç›®ç­¾åä½¿ç”¨çš„åŠ å¯†ç‹—æ¥è‡ªYubiHSM å…·ä½“çš„ä¸€äº›æ“ä½œè¯´æ˜éœ€è¦åˆ°å®˜ç½‘å¯»æ‰¾ï¼š YubiHSM2 ç”¨äºç­¾åçš„HSMé¡¹ç›®ç›®å‰æœ‰: Archer A11 Archer A13 ArcherIS ç¼–è¯‘çš„æœåŠ¡å™¨åˆ†åˆ«åœ¨åŒ—äº¬å’Œæ²ˆé˜³ åŒ—äº¬æœåŠ¡å™¨ ä¸Šæ’ç€ä¸¤ä¸ªåŠ å¯†ç‹— ä¸€ä¸ªåŠ å¯†ç‹— ç”¨äº ArcherIS ==serial=0016980259== ç›®å‰çš„usb serial noï¼š connector=yhusb://serial=0016980259 é…ç½®å’Œå¯†ç ï¼š [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so INIT_ARGS = \"connector=yhusb://serial=0016980259\" # PIN is the , by default this is 0001password. Meaning the default key_id is '0001' and the default password is 'password' # key_id = 0x2873 password = ef94cc600359806750df6595bbdf9652 # remove the 0x from the key_id and add the password to the end of it # PIN = # PIN = \u003c2873\u003e # PIN = 5147bb4dc2069b1094a80b0311a91afd72f8 PIN = \"5147bb4dc2069b1094a80b0311a91afd72f8\" init = 0 åˆ—å‡ºé‡Œé¢çš„pkcs11 keyçš„æƒ…å†µï¼š builder@builder:~/archeris_hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_connector.conf keytool -list -keystore NONE -storetype PKCS11 -storepass 5147bb4dc2069b1094a80b0311a91afd72f8 -providerClass sun.security.pkcs11.SunPKCS11 -providerArg ./conf/hsm_config.conf Keystore type: PKCS11 Keystore provider: SunPKCS11-yubihsm-pkcs Your keystore contains 9 entries is_platform, PrivateKeyEntry, Certificate fingerprint (SHA-256): 4A:EE:97:7C:1C:10:E4:1A:59:38:8F:3A:20:27:17:55:3C:EF:7E:7D:30:B4:10:B1:40:15:09:FC:4F:57:7D:79 media, PrivateKeyEntry, Certificate fingerprint (SHA-256): 90:02:EB:69:82:F9:B8:F1:6A:0F:02:2F:03:0E:F8:AC:6E:78:27:41:86:D1:D8:0F:87:39:A1:2D:40:49:2F:1C networkstack, PrivateKeyEntry, Certificate fingerprint (SHA-256): B7:7A:E1:E4:80:90:73:DC:C2:D1:09:BB:E8:28:81:65:29:BF:97:7C:33:07:73:53:8C:67:11:14:F8:69:17:49 partner, PrivateKeyEntry, Certificate fingerprint (SHA-256): 12:13:92:C9:91:78:7C:96:84:25:1C:A3:49:94:CF:E6:C8:E7:90:85:F7:E7:4D:15:A6:D9:D7:86:81:E1:51:51 platform, PrivateKeyEntry, Certificate fingerprint (SHA-256): D8:4F:01:E6:6F:5E:CD:05:4A:B3:67:0F:EA:5A:E1:FA:EA:A7:73:04:A2:9D:F1:C2:59:48:09:52:E5:FB:C4:6B release, PrivateKeyEntry, Certificate fingerprint (SHA-256): 09:55:75:AE:AE:A3:AE:20:BB:B9:43:2C:1D:47:73:09:BC:E4:22:A0:F3:60:38:0F:E0:31:2F:2C:FE:27:D9:3F shared, PrivateKeyEntry, Certificate fingerprint (SHA-256): 84:CE:CB:ED:38:A7:00:AB:D1:E4:71:0C:8C:51:0D:3F:77:D6:B2:CB:72:B3:96:94:83:7A:A8:8A:FE:C2:93:9B webview, PrivateKeyEntry, Certificate fingerprint (SHA-256): 06:DC:3A:86:59:EF:66:95:5B:C6:18:37:A3:D1:F3:5D:44:18:01:59:43:0D:3B:27:ED:B6:A7:D5:80:0C:7A:EA wrap_259, SecretKeyEntry, ç”¨é€”ï¼š ArcherIS AP apk ç­¾å ArcherIS releasekey otaç­¾å Archer A13 AP apk ç­¾å(è®¡åˆ’ä¸­ï¼ŒéªŒè¯ä¸­) Archer A13 ç›®å‰å»¶ç”¨A11 çš„é¡¹ç›® release ota é‡‡ç”¨ç›´æ¥ç”¨releasekeyçš„æ–¹æ¡ˆ ä¸€ä¸ªåŠ å¯†ç‹— ç”¨äº Archer ==551== connector=yhusb://serial=0016499551 [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so dynamic_path = /usr/lib/x86_64-linux-gnu/openssl-1.0.0/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so PIN = \"60d4458874be39d674225d861b3080f02068\" INIT_ARGS = \"connector=yhusb://serial=0016499551\" #INIT_ARGS = \"connector=http://localhost:12345\" init = 0 builder@builder:~/hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_connector.conf keytool -list -keystore NONE -storetype PKCS11 -storepass 60d4458874be39d674225d861b3080f02068 -providerClass sun.security.pkcs11.SunPKCS11 -providerArg ./conf/hsm_config.conf Keystore type: PKCS11 Keystore provider: SunPKCS11-yubihsm-pkcs Your keystore contains 0 entries ç”¨é€”ï¼š ArcherIS CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ Archer A11 CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ Archer A13 CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ æ²ˆé˜³æœåŠ¡å™¨ ä¸Šæ’ç€ä¸€ä¸ªåŠ å¯†ç‹— Archer A11çš„é¡¹ç›® ==561== [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so INIT_ARGS = \"connector=yhusb://serial=0016499561\" PIN = \"2873ef94cc600359806750df6595bbdf9652\" init = 0 builder@builder-PowerEdge-R740:~/hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_conne","date":"2024-11-06","objectID":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/:0:1","tags":["blog","å®æˆ˜"],"title":"Archer\u0026ArcherIS APç­¾åæ–¹æ¡ˆæ€»ç»“","uri":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/#ç¼–è¯‘çš„æœåŠ¡å™¨åˆ†åˆ«åœ¨åŒ—äº¬å’Œæ²ˆé˜³"},{"categories":"Android","collections":null,"content":"å…³äºAPç«¯ HSMç­¾åçš„é…ç½®è¯´æ˜ Archer é¡¹ç›®ç­¾åä½¿ç”¨çš„åŠ å¯†ç‹—æ¥è‡ªYubiHSM å…·ä½“çš„ä¸€äº›æ“ä½œè¯´æ˜éœ€è¦åˆ°å®˜ç½‘å¯»æ‰¾ï¼š YubiHSM2 ç”¨äºç­¾åçš„HSMé¡¹ç›®ç›®å‰æœ‰: Archer A11 Archer A13 ArcherIS ç¼–è¯‘çš„æœåŠ¡å™¨åˆ†åˆ«åœ¨åŒ—äº¬å’Œæ²ˆé˜³ åŒ—äº¬æœåŠ¡å™¨ ä¸Šæ’ç€ä¸¤ä¸ªåŠ å¯†ç‹— ä¸€ä¸ªåŠ å¯†ç‹— ç”¨äº ArcherIS ==serial=0016980259== ç›®å‰çš„usb serial noï¼š connector=yhusb://serial=0016980259 é…ç½®å’Œå¯†ç ï¼š [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so INIT_ARGS = \"connector=yhusb://serial=0016980259\" # PIN is the , by default this is 0001password. Meaning the default key_id is '0001' and the default password is 'password' # key_id = 0x2873 password = ef94cc600359806750df6595bbdf9652 # remove the 0x from the key_id and add the password to the end of it # PIN = # PIN = \u003c2873\u003e # PIN = 5147bb4dc2069b1094a80b0311a91afd72f8 PIN = \"5147bb4dc2069b1094a80b0311a91afd72f8\" init = 0 åˆ—å‡ºé‡Œé¢çš„pkcs11 keyçš„æƒ…å†µï¼š builder@builder:~/archeris_hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_connector.conf keytool -list -keystore NONE -storetype PKCS11 -storepass 5147bb4dc2069b1094a80b0311a91afd72f8 -providerClass sun.security.pkcs11.SunPKCS11 -providerArg ./conf/hsm_config.conf Keystore type: PKCS11 Keystore provider: SunPKCS11-yubihsm-pkcs Your keystore contains 9 entries is_platform, PrivateKeyEntry, Certificate fingerprint (SHA-256): 4A:EE:97:7C:1C:10:E4:1A:59:38:8F:3A:20:27:17:55:3C:EF:7E:7D:30:B4:10:B1:40:15:09:FC:4F:57:7D:79 media, PrivateKeyEntry, Certificate fingerprint (SHA-256): 90:02:EB:69:82:F9:B8:F1:6A:0F:02:2F:03:0E:F8:AC:6E:78:27:41:86:D1:D8:0F:87:39:A1:2D:40:49:2F:1C networkstack, PrivateKeyEntry, Certificate fingerprint (SHA-256): B7:7A:E1:E4:80:90:73:DC:C2:D1:09:BB:E8:28:81:65:29:BF:97:7C:33:07:73:53:8C:67:11:14:F8:69:17:49 partner, PrivateKeyEntry, Certificate fingerprint (SHA-256): 12:13:92:C9:91:78:7C:96:84:25:1C:A3:49:94:CF:E6:C8:E7:90:85:F7:E7:4D:15:A6:D9:D7:86:81:E1:51:51 platform, PrivateKeyEntry, Certificate fingerprint (SHA-256): D8:4F:01:E6:6F:5E:CD:05:4A:B3:67:0F:EA:5A:E1:FA:EA:A7:73:04:A2:9D:F1:C2:59:48:09:52:E5:FB:C4:6B release, PrivateKeyEntry, Certificate fingerprint (SHA-256): 09:55:75:AE:AE:A3:AE:20:BB:B9:43:2C:1D:47:73:09:BC:E4:22:A0:F3:60:38:0F:E0:31:2F:2C:FE:27:D9:3F shared, PrivateKeyEntry, Certificate fingerprint (SHA-256): 84:CE:CB:ED:38:A7:00:AB:D1:E4:71:0C:8C:51:0D:3F:77:D6:B2:CB:72:B3:96:94:83:7A:A8:8A:FE:C2:93:9B webview, PrivateKeyEntry, Certificate fingerprint (SHA-256): 06:DC:3A:86:59:EF:66:95:5B:C6:18:37:A3:D1:F3:5D:44:18:01:59:43:0D:3B:27:ED:B6:A7:D5:80:0C:7A:EA wrap_259, SecretKeyEntry, ç”¨é€”ï¼š ArcherIS AP apk ç­¾å ArcherIS releasekey otaç­¾å Archer A13 AP apk ç­¾å(è®¡åˆ’ä¸­ï¼ŒéªŒè¯ä¸­) Archer A13 ç›®å‰å»¶ç”¨A11 çš„é¡¹ç›® release ota é‡‡ç”¨ç›´æ¥ç”¨releasekeyçš„æ–¹æ¡ˆ ä¸€ä¸ªåŠ å¯†ç‹— ç”¨äº Archer ==551== connector=yhusb://serial=0016499551 [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so dynamic_path = /usr/lib/x86_64-linux-gnu/openssl-1.0.0/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so PIN = \"60d4458874be39d674225d861b3080f02068\" INIT_ARGS = \"connector=yhusb://serial=0016499551\" #INIT_ARGS = \"connector=http://localhost:12345\" init = 0 builder@builder:~/hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_connector.conf keytool -list -keystore NONE -storetype PKCS11 -storepass 60d4458874be39d674225d861b3080f02068 -providerClass sun.security.pkcs11.SunPKCS11 -providerArg ./conf/hsm_config.conf Keystore type: PKCS11 Keystore provider: SunPKCS11-yubihsm-pkcs Your keystore contains 0 entries ç”¨é€”ï¼š ArcherIS CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ Archer A11 CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ Archer A13 CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ æ²ˆé˜³æœåŠ¡å™¨ ä¸Šæ’ç€ä¸€ä¸ªåŠ å¯†ç‹— Archer A11çš„é¡¹ç›® ==561== [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so INIT_ARGS = \"connector=yhusb://serial=0016499561\" PIN = \"2873ef94cc600359806750df6595bbdf9652\" init = 0 builder@builder-PowerEdge-R740:~/hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_conne","date":"2024-11-06","objectID":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/:0:1","tags":["blog","å®æˆ˜"],"title":"Archer\u0026ArcherIS APç­¾åæ–¹æ¡ˆæ€»ç»“","uri":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/#åŒ—äº¬æœåŠ¡å™¨"},{"categories":"Android","collections":null,"content":"å…³äºAPç«¯ HSMç­¾åçš„é…ç½®è¯´æ˜ Archer é¡¹ç›®ç­¾åä½¿ç”¨çš„åŠ å¯†ç‹—æ¥è‡ªYubiHSM å…·ä½“çš„ä¸€äº›æ“ä½œè¯´æ˜éœ€è¦åˆ°å®˜ç½‘å¯»æ‰¾ï¼š YubiHSM2 ç”¨äºç­¾åçš„HSMé¡¹ç›®ç›®å‰æœ‰: Archer A11 Archer A13 ArcherIS ç¼–è¯‘çš„æœåŠ¡å™¨åˆ†åˆ«åœ¨åŒ—äº¬å’Œæ²ˆé˜³ åŒ—äº¬æœåŠ¡å™¨ ä¸Šæ’ç€ä¸¤ä¸ªåŠ å¯†ç‹— ä¸€ä¸ªåŠ å¯†ç‹— ç”¨äº ArcherIS ==serial=0016980259== ç›®å‰çš„usb serial noï¼š connector=yhusb://serial=0016980259 é…ç½®å’Œå¯†ç ï¼š [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so INIT_ARGS = \"connector=yhusb://serial=0016980259\" # PIN is the , by default this is 0001password. Meaning the default key_id is '0001' and the default password is 'password' # key_id = 0x2873 password = ef94cc600359806750df6595bbdf9652 # remove the 0x from the key_id and add the password to the end of it # PIN = # PIN = \u003c2873\u003e # PIN = 5147bb4dc2069b1094a80b0311a91afd72f8 PIN = \"5147bb4dc2069b1094a80b0311a91afd72f8\" init = 0 åˆ—å‡ºé‡Œé¢çš„pkcs11 keyçš„æƒ…å†µï¼š builder@builder:~/archeris_hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_connector.conf keytool -list -keystore NONE -storetype PKCS11 -storepass 5147bb4dc2069b1094a80b0311a91afd72f8 -providerClass sun.security.pkcs11.SunPKCS11 -providerArg ./conf/hsm_config.conf Keystore type: PKCS11 Keystore provider: SunPKCS11-yubihsm-pkcs Your keystore contains 9 entries is_platform, PrivateKeyEntry, Certificate fingerprint (SHA-256): 4A:EE:97:7C:1C:10:E4:1A:59:38:8F:3A:20:27:17:55:3C:EF:7E:7D:30:B4:10:B1:40:15:09:FC:4F:57:7D:79 media, PrivateKeyEntry, Certificate fingerprint (SHA-256): 90:02:EB:69:82:F9:B8:F1:6A:0F:02:2F:03:0E:F8:AC:6E:78:27:41:86:D1:D8:0F:87:39:A1:2D:40:49:2F:1C networkstack, PrivateKeyEntry, Certificate fingerprint (SHA-256): B7:7A:E1:E4:80:90:73:DC:C2:D1:09:BB:E8:28:81:65:29:BF:97:7C:33:07:73:53:8C:67:11:14:F8:69:17:49 partner, PrivateKeyEntry, Certificate fingerprint (SHA-256): 12:13:92:C9:91:78:7C:96:84:25:1C:A3:49:94:CF:E6:C8:E7:90:85:F7:E7:4D:15:A6:D9:D7:86:81:E1:51:51 platform, PrivateKeyEntry, Certificate fingerprint (SHA-256): D8:4F:01:E6:6F:5E:CD:05:4A:B3:67:0F:EA:5A:E1:FA:EA:A7:73:04:A2:9D:F1:C2:59:48:09:52:E5:FB:C4:6B release, PrivateKeyEntry, Certificate fingerprint (SHA-256): 09:55:75:AE:AE:A3:AE:20:BB:B9:43:2C:1D:47:73:09:BC:E4:22:A0:F3:60:38:0F:E0:31:2F:2C:FE:27:D9:3F shared, PrivateKeyEntry, Certificate fingerprint (SHA-256): 84:CE:CB:ED:38:A7:00:AB:D1:E4:71:0C:8C:51:0D:3F:77:D6:B2:CB:72:B3:96:94:83:7A:A8:8A:FE:C2:93:9B webview, PrivateKeyEntry, Certificate fingerprint (SHA-256): 06:DC:3A:86:59:EF:66:95:5B:C6:18:37:A3:D1:F3:5D:44:18:01:59:43:0D:3B:27:ED:B6:A7:D5:80:0C:7A:EA wrap_259, SecretKeyEntry, ç”¨é€”ï¼š ArcherIS AP apk ç­¾å ArcherIS releasekey otaç­¾å Archer A13 AP apk ç­¾å(è®¡åˆ’ä¸­ï¼ŒéªŒè¯ä¸­) Archer A13 ç›®å‰å»¶ç”¨A11 çš„é¡¹ç›® release ota é‡‡ç”¨ç›´æ¥ç”¨releasekeyçš„æ–¹æ¡ˆ ä¸€ä¸ªåŠ å¯†ç‹— ç”¨äº Archer ==551== connector=yhusb://serial=0016499551 [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so dynamic_path = /usr/lib/x86_64-linux-gnu/openssl-1.0.0/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so PIN = \"60d4458874be39d674225d861b3080f02068\" INIT_ARGS = \"connector=yhusb://serial=0016499551\" #INIT_ARGS = \"connector=http://localhost:12345\" init = 0 builder@builder:~/hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_connector.conf keytool -list -keystore NONE -storetype PKCS11 -storepass 60d4458874be39d674225d861b3080f02068 -providerClass sun.security.pkcs11.SunPKCS11 -providerArg ./conf/hsm_config.conf Keystore type: PKCS11 Keystore provider: SunPKCS11-yubihsm-pkcs Your keystore contains 0 entries ç”¨é€”ï¼š ArcherIS CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ Archer A11 CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ Archer A13 CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ æ²ˆé˜³æœåŠ¡å™¨ ä¸Šæ’ç€ä¸€ä¸ªåŠ å¯†ç‹— Archer A11çš„é¡¹ç›® ==561== [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so INIT_ARGS = \"connector=yhusb://serial=0016499561\" PIN = \"2873ef94cc600359806750df6595bbdf9652\" init = 0 builder@builder-PowerEdge-R740:~/hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_conne","date":"2024-11-06","objectID":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/:0:1","tags":["blog","å®æˆ˜"],"title":"Archer\u0026ArcherIS APç­¾åæ–¹æ¡ˆæ€»ç»“","uri":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/#ä¸€ä¸ªåŠ å¯†ç‹—-ç”¨äº-archeris--serial0016980259"},{"categories":"Android","collections":null,"content":"å…³äºAPç«¯ HSMç­¾åçš„é…ç½®è¯´æ˜ Archer é¡¹ç›®ç­¾åä½¿ç”¨çš„åŠ å¯†ç‹—æ¥è‡ªYubiHSM å…·ä½“çš„ä¸€äº›æ“ä½œè¯´æ˜éœ€è¦åˆ°å®˜ç½‘å¯»æ‰¾ï¼š YubiHSM2 ç”¨äºç­¾åçš„HSMé¡¹ç›®ç›®å‰æœ‰: Archer A11 Archer A13 ArcherIS ç¼–è¯‘çš„æœåŠ¡å™¨åˆ†åˆ«åœ¨åŒ—äº¬å’Œæ²ˆé˜³ åŒ—äº¬æœåŠ¡å™¨ ä¸Šæ’ç€ä¸¤ä¸ªåŠ å¯†ç‹— ä¸€ä¸ªåŠ å¯†ç‹— ç”¨äº ArcherIS ==serial=0016980259== ç›®å‰çš„usb serial noï¼š connector=yhusb://serial=0016980259 é…ç½®å’Œå¯†ç ï¼š [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so INIT_ARGS = \"connector=yhusb://serial=0016980259\" # PIN is the , by default this is 0001password. Meaning the default key_id is '0001' and the default password is 'password' # key_id = 0x2873 password = ef94cc600359806750df6595bbdf9652 # remove the 0x from the key_id and add the password to the end of it # PIN = # PIN = \u003c2873\u003e # PIN = 5147bb4dc2069b1094a80b0311a91afd72f8 PIN = \"5147bb4dc2069b1094a80b0311a91afd72f8\" init = 0 åˆ—å‡ºé‡Œé¢çš„pkcs11 keyçš„æƒ…å†µï¼š builder@builder:~/archeris_hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_connector.conf keytool -list -keystore NONE -storetype PKCS11 -storepass 5147bb4dc2069b1094a80b0311a91afd72f8 -providerClass sun.security.pkcs11.SunPKCS11 -providerArg ./conf/hsm_config.conf Keystore type: PKCS11 Keystore provider: SunPKCS11-yubihsm-pkcs Your keystore contains 9 entries is_platform, PrivateKeyEntry, Certificate fingerprint (SHA-256): 4A:EE:97:7C:1C:10:E4:1A:59:38:8F:3A:20:27:17:55:3C:EF:7E:7D:30:B4:10:B1:40:15:09:FC:4F:57:7D:79 media, PrivateKeyEntry, Certificate fingerprint (SHA-256): 90:02:EB:69:82:F9:B8:F1:6A:0F:02:2F:03:0E:F8:AC:6E:78:27:41:86:D1:D8:0F:87:39:A1:2D:40:49:2F:1C networkstack, PrivateKeyEntry, Certificate fingerprint (SHA-256): B7:7A:E1:E4:80:90:73:DC:C2:D1:09:BB:E8:28:81:65:29:BF:97:7C:33:07:73:53:8C:67:11:14:F8:69:17:49 partner, PrivateKeyEntry, Certificate fingerprint (SHA-256): 12:13:92:C9:91:78:7C:96:84:25:1C:A3:49:94:CF:E6:C8:E7:90:85:F7:E7:4D:15:A6:D9:D7:86:81:E1:51:51 platform, PrivateKeyEntry, Certificate fingerprint (SHA-256): D8:4F:01:E6:6F:5E:CD:05:4A:B3:67:0F:EA:5A:E1:FA:EA:A7:73:04:A2:9D:F1:C2:59:48:09:52:E5:FB:C4:6B release, PrivateKeyEntry, Certificate fingerprint (SHA-256): 09:55:75:AE:AE:A3:AE:20:BB:B9:43:2C:1D:47:73:09:BC:E4:22:A0:F3:60:38:0F:E0:31:2F:2C:FE:27:D9:3F shared, PrivateKeyEntry, Certificate fingerprint (SHA-256): 84:CE:CB:ED:38:A7:00:AB:D1:E4:71:0C:8C:51:0D:3F:77:D6:B2:CB:72:B3:96:94:83:7A:A8:8A:FE:C2:93:9B webview, PrivateKeyEntry, Certificate fingerprint (SHA-256): 06:DC:3A:86:59:EF:66:95:5B:C6:18:37:A3:D1:F3:5D:44:18:01:59:43:0D:3B:27:ED:B6:A7:D5:80:0C:7A:EA wrap_259, SecretKeyEntry, ç”¨é€”ï¼š ArcherIS AP apk ç­¾å ArcherIS releasekey otaç­¾å Archer A13 AP apk ç­¾å(è®¡åˆ’ä¸­ï¼ŒéªŒè¯ä¸­) Archer A13 ç›®å‰å»¶ç”¨A11 çš„é¡¹ç›® release ota é‡‡ç”¨ç›´æ¥ç”¨releasekeyçš„æ–¹æ¡ˆ ä¸€ä¸ªåŠ å¯†ç‹— ç”¨äº Archer ==551== connector=yhusb://serial=0016499551 [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so dynamic_path = /usr/lib/x86_64-linux-gnu/openssl-1.0.0/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so PIN = \"60d4458874be39d674225d861b3080f02068\" INIT_ARGS = \"connector=yhusb://serial=0016499551\" #INIT_ARGS = \"connector=http://localhost:12345\" init = 0 builder@builder:~/hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_connector.conf keytool -list -keystore NONE -storetype PKCS11 -storepass 60d4458874be39d674225d861b3080f02068 -providerClass sun.security.pkcs11.SunPKCS11 -providerArg ./conf/hsm_config.conf Keystore type: PKCS11 Keystore provider: SunPKCS11-yubihsm-pkcs Your keystore contains 0 entries ç”¨é€”ï¼š ArcherIS CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ Archer A11 CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ Archer A13 CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ æ²ˆé˜³æœåŠ¡å™¨ ä¸Šæ’ç€ä¸€ä¸ªåŠ å¯†ç‹— Archer A11çš„é¡¹ç›® ==561== [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so INIT_ARGS = \"connector=yhusb://serial=0016499561\" PIN = \"2873ef94cc600359806750df6595bbdf9652\" init = 0 builder@builder-PowerEdge-R740:~/hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_conne","date":"2024-11-06","objectID":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/:0:1","tags":["blog","å®æˆ˜"],"title":"Archer\u0026ArcherIS APç­¾åæ–¹æ¡ˆæ€»ç»“","uri":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/#ä¸€ä¸ªåŠ å¯†ç‹—-ç”¨äº-archer---551"},{"categories":"Android","collections":null,"content":"å…³äºAPç«¯ HSMç­¾åçš„é…ç½®è¯´æ˜ Archer é¡¹ç›®ç­¾åä½¿ç”¨çš„åŠ å¯†ç‹—æ¥è‡ªYubiHSM å…·ä½“çš„ä¸€äº›æ“ä½œè¯´æ˜éœ€è¦åˆ°å®˜ç½‘å¯»æ‰¾ï¼š YubiHSM2 ç”¨äºç­¾åçš„HSMé¡¹ç›®ç›®å‰æœ‰: Archer A11 Archer A13 ArcherIS ç¼–è¯‘çš„æœåŠ¡å™¨åˆ†åˆ«åœ¨åŒ—äº¬å’Œæ²ˆé˜³ åŒ—äº¬æœåŠ¡å™¨ ä¸Šæ’ç€ä¸¤ä¸ªåŠ å¯†ç‹— ä¸€ä¸ªåŠ å¯†ç‹— ç”¨äº ArcherIS ==serial=0016980259== ç›®å‰çš„usb serial noï¼š connector=yhusb://serial=0016980259 é…ç½®å’Œå¯†ç ï¼š [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so INIT_ARGS = \"connector=yhusb://serial=0016980259\" # PIN is the , by default this is 0001password. Meaning the default key_id is '0001' and the default password is 'password' # key_id = 0x2873 password = ef94cc600359806750df6595bbdf9652 # remove the 0x from the key_id and add the password to the end of it # PIN = # PIN = \u003c2873\u003e # PIN = 5147bb4dc2069b1094a80b0311a91afd72f8 PIN = \"5147bb4dc2069b1094a80b0311a91afd72f8\" init = 0 åˆ—å‡ºé‡Œé¢çš„pkcs11 keyçš„æƒ…å†µï¼š builder@builder:~/archeris_hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_connector.conf keytool -list -keystore NONE -storetype PKCS11 -storepass 5147bb4dc2069b1094a80b0311a91afd72f8 -providerClass sun.security.pkcs11.SunPKCS11 -providerArg ./conf/hsm_config.conf Keystore type: PKCS11 Keystore provider: SunPKCS11-yubihsm-pkcs Your keystore contains 9 entries is_platform, PrivateKeyEntry, Certificate fingerprint (SHA-256): 4A:EE:97:7C:1C:10:E4:1A:59:38:8F:3A:20:27:17:55:3C:EF:7E:7D:30:B4:10:B1:40:15:09:FC:4F:57:7D:79 media, PrivateKeyEntry, Certificate fingerprint (SHA-256): 90:02:EB:69:82:F9:B8:F1:6A:0F:02:2F:03:0E:F8:AC:6E:78:27:41:86:D1:D8:0F:87:39:A1:2D:40:49:2F:1C networkstack, PrivateKeyEntry, Certificate fingerprint (SHA-256): B7:7A:E1:E4:80:90:73:DC:C2:D1:09:BB:E8:28:81:65:29:BF:97:7C:33:07:73:53:8C:67:11:14:F8:69:17:49 partner, PrivateKeyEntry, Certificate fingerprint (SHA-256): 12:13:92:C9:91:78:7C:96:84:25:1C:A3:49:94:CF:E6:C8:E7:90:85:F7:E7:4D:15:A6:D9:D7:86:81:E1:51:51 platform, PrivateKeyEntry, Certificate fingerprint (SHA-256): D8:4F:01:E6:6F:5E:CD:05:4A:B3:67:0F:EA:5A:E1:FA:EA:A7:73:04:A2:9D:F1:C2:59:48:09:52:E5:FB:C4:6B release, PrivateKeyEntry, Certificate fingerprint (SHA-256): 09:55:75:AE:AE:A3:AE:20:BB:B9:43:2C:1D:47:73:09:BC:E4:22:A0:F3:60:38:0F:E0:31:2F:2C:FE:27:D9:3F shared, PrivateKeyEntry, Certificate fingerprint (SHA-256): 84:CE:CB:ED:38:A7:00:AB:D1:E4:71:0C:8C:51:0D:3F:77:D6:B2:CB:72:B3:96:94:83:7A:A8:8A:FE:C2:93:9B webview, PrivateKeyEntry, Certificate fingerprint (SHA-256): 06:DC:3A:86:59:EF:66:95:5B:C6:18:37:A3:D1:F3:5D:44:18:01:59:43:0D:3B:27:ED:B6:A7:D5:80:0C:7A:EA wrap_259, SecretKeyEntry, ç”¨é€”ï¼š ArcherIS AP apk ç­¾å ArcherIS releasekey otaç­¾å Archer A13 AP apk ç­¾å(è®¡åˆ’ä¸­ï¼ŒéªŒè¯ä¸­) Archer A13 ç›®å‰å»¶ç”¨A11 çš„é¡¹ç›® release ota é‡‡ç”¨ç›´æ¥ç”¨releasekeyçš„æ–¹æ¡ˆ ä¸€ä¸ªåŠ å¯†ç‹— ç”¨äº Archer ==551== connector=yhusb://serial=0016499551 [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so dynamic_path = /usr/lib/x86_64-linux-gnu/openssl-1.0.0/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so PIN = \"60d4458874be39d674225d861b3080f02068\" INIT_ARGS = \"connector=yhusb://serial=0016499551\" #INIT_ARGS = \"connector=http://localhost:12345\" init = 0 builder@builder:~/hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_connector.conf keytool -list -keystore NONE -storetype PKCS11 -storepass 60d4458874be39d674225d861b3080f02068 -providerClass sun.security.pkcs11.SunPKCS11 -providerArg ./conf/hsm_config.conf Keystore type: PKCS11 Keystore provider: SunPKCS11-yubihsm-pkcs Your keystore contains 0 entries ç”¨é€”ï¼š ArcherIS CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ Archer A11 CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ Archer A13 CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ æ²ˆé˜³æœåŠ¡å™¨ ä¸Šæ’ç€ä¸€ä¸ªåŠ å¯†ç‹— Archer A11çš„é¡¹ç›® ==561== [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so INIT_ARGS = \"connector=yhusb://serial=0016499561\" PIN = \"2873ef94cc600359806750df6595bbdf9652\" init = 0 builder@builder-PowerEdge-R740:~/hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_conne","date":"2024-11-06","objectID":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/:0:1","tags":["blog","å®æˆ˜"],"title":"Archer\u0026ArcherIS APç­¾åæ–¹æ¡ˆæ€»ç»“","uri":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/#æ²ˆé˜³æœåŠ¡å™¨"},{"categories":"Android","collections":null,"content":"å…³äºAPç«¯ HSMç­¾åçš„é…ç½®è¯´æ˜ Archer é¡¹ç›®ç­¾åä½¿ç”¨çš„åŠ å¯†ç‹—æ¥è‡ªYubiHSM å…·ä½“çš„ä¸€äº›æ“ä½œè¯´æ˜éœ€è¦åˆ°å®˜ç½‘å¯»æ‰¾ï¼š YubiHSM2 ç”¨äºç­¾åçš„HSMé¡¹ç›®ç›®å‰æœ‰: Archer A11 Archer A13 ArcherIS ç¼–è¯‘çš„æœåŠ¡å™¨åˆ†åˆ«åœ¨åŒ—äº¬å’Œæ²ˆé˜³ åŒ—äº¬æœåŠ¡å™¨ ä¸Šæ’ç€ä¸¤ä¸ªåŠ å¯†ç‹— ä¸€ä¸ªåŠ å¯†ç‹— ç”¨äº ArcherIS ==serial=0016980259== ç›®å‰çš„usb serial noï¼š connector=yhusb://serial=0016980259 é…ç½®å’Œå¯†ç ï¼š [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so INIT_ARGS = \"connector=yhusb://serial=0016980259\" # PIN is the , by default this is 0001password. Meaning the default key_id is '0001' and the default password is 'password' # key_id = 0x2873 password = ef94cc600359806750df6595bbdf9652 # remove the 0x from the key_id and add the password to the end of it # PIN = # PIN = \u003c2873\u003e # PIN = 5147bb4dc2069b1094a80b0311a91afd72f8 PIN = \"5147bb4dc2069b1094a80b0311a91afd72f8\" init = 0 åˆ—å‡ºé‡Œé¢çš„pkcs11 keyçš„æƒ…å†µï¼š builder@builder:~/archeris_hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_connector.conf keytool -list -keystore NONE -storetype PKCS11 -storepass 5147bb4dc2069b1094a80b0311a91afd72f8 -providerClass sun.security.pkcs11.SunPKCS11 -providerArg ./conf/hsm_config.conf Keystore type: PKCS11 Keystore provider: SunPKCS11-yubihsm-pkcs Your keystore contains 9 entries is_platform, PrivateKeyEntry, Certificate fingerprint (SHA-256): 4A:EE:97:7C:1C:10:E4:1A:59:38:8F:3A:20:27:17:55:3C:EF:7E:7D:30:B4:10:B1:40:15:09:FC:4F:57:7D:79 media, PrivateKeyEntry, Certificate fingerprint (SHA-256): 90:02:EB:69:82:F9:B8:F1:6A:0F:02:2F:03:0E:F8:AC:6E:78:27:41:86:D1:D8:0F:87:39:A1:2D:40:49:2F:1C networkstack, PrivateKeyEntry, Certificate fingerprint (SHA-256): B7:7A:E1:E4:80:90:73:DC:C2:D1:09:BB:E8:28:81:65:29:BF:97:7C:33:07:73:53:8C:67:11:14:F8:69:17:49 partner, PrivateKeyEntry, Certificate fingerprint (SHA-256): 12:13:92:C9:91:78:7C:96:84:25:1C:A3:49:94:CF:E6:C8:E7:90:85:F7:E7:4D:15:A6:D9:D7:86:81:E1:51:51 platform, PrivateKeyEntry, Certificate fingerprint (SHA-256): D8:4F:01:E6:6F:5E:CD:05:4A:B3:67:0F:EA:5A:E1:FA:EA:A7:73:04:A2:9D:F1:C2:59:48:09:52:E5:FB:C4:6B release, PrivateKeyEntry, Certificate fingerprint (SHA-256): 09:55:75:AE:AE:A3:AE:20:BB:B9:43:2C:1D:47:73:09:BC:E4:22:A0:F3:60:38:0F:E0:31:2F:2C:FE:27:D9:3F shared, PrivateKeyEntry, Certificate fingerprint (SHA-256): 84:CE:CB:ED:38:A7:00:AB:D1:E4:71:0C:8C:51:0D:3F:77:D6:B2:CB:72:B3:96:94:83:7A:A8:8A:FE:C2:93:9B webview, PrivateKeyEntry, Certificate fingerprint (SHA-256): 06:DC:3A:86:59:EF:66:95:5B:C6:18:37:A3:D1:F3:5D:44:18:01:59:43:0D:3B:27:ED:B6:A7:D5:80:0C:7A:EA wrap_259, SecretKeyEntry, ç”¨é€”ï¼š ArcherIS AP apk ç­¾å ArcherIS releasekey otaç­¾å Archer A13 AP apk ç­¾å(è®¡åˆ’ä¸­ï¼ŒéªŒè¯ä¸­) Archer A13 ç›®å‰å»¶ç”¨A11 çš„é¡¹ç›® release ota é‡‡ç”¨ç›´æ¥ç”¨releasekeyçš„æ–¹æ¡ˆ ä¸€ä¸ªåŠ å¯†ç‹— ç”¨äº Archer ==551== connector=yhusb://serial=0016499551 [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so dynamic_path = /usr/lib/x86_64-linux-gnu/openssl-1.0.0/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so PIN = \"60d4458874be39d674225d861b3080f02068\" INIT_ARGS = \"connector=yhusb://serial=0016499551\" #INIT_ARGS = \"connector=http://localhost:12345\" init = 0 builder@builder:~/hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_connector.conf keytool -list -keystore NONE -storetype PKCS11 -storepass 60d4458874be39d674225d861b3080f02068 -providerClass sun.security.pkcs11.SunPKCS11 -providerArg ./conf/hsm_config.conf Keystore type: PKCS11 Keystore provider: SunPKCS11-yubihsm-pkcs Your keystore contains 0 entries ç”¨é€”ï¼š ArcherIS CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ Archer A11 CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ Archer A13 CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ æ²ˆé˜³æœåŠ¡å™¨ ä¸Šæ’ç€ä¸€ä¸ªåŠ å¯†ç‹— Archer A11çš„é¡¹ç›® ==561== [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so INIT_ARGS = \"connector=yhusb://serial=0016499561\" PIN = \"2873ef94cc600359806750df6595bbdf9652\" init = 0 builder@builder-PowerEdge-R740:~/hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_conne","date":"2024-11-06","objectID":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/:0:1","tags":["blog","å®æˆ˜"],"title":"Archer\u0026ArcherIS APç­¾åæ–¹æ¡ˆæ€»ç»“","uri":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/#archer-a11çš„é¡¹ç›®-561"},{"categories":"Android","collections":null,"content":"å…³äºAPç«¯ HSMç­¾åçš„é…ç½®è¯´æ˜ Archer é¡¹ç›®ç­¾åä½¿ç”¨çš„åŠ å¯†ç‹—æ¥è‡ªYubiHSM å…·ä½“çš„ä¸€äº›æ“ä½œè¯´æ˜éœ€è¦åˆ°å®˜ç½‘å¯»æ‰¾ï¼š YubiHSM2 ç”¨äºç­¾åçš„HSMé¡¹ç›®ç›®å‰æœ‰: Archer A11 Archer A13 ArcherIS ç¼–è¯‘çš„æœåŠ¡å™¨åˆ†åˆ«åœ¨åŒ—äº¬å’Œæ²ˆé˜³ åŒ—äº¬æœåŠ¡å™¨ ä¸Šæ’ç€ä¸¤ä¸ªåŠ å¯†ç‹— ä¸€ä¸ªåŠ å¯†ç‹— ç”¨äº ArcherIS ==serial=0016980259== ç›®å‰çš„usb serial noï¼š connector=yhusb://serial=0016980259 é…ç½®å’Œå¯†ç ï¼š [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so INIT_ARGS = \"connector=yhusb://serial=0016980259\" # PIN is the , by default this is 0001password. Meaning the default key_id is '0001' and the default password is 'password' # key_id = 0x2873 password = ef94cc600359806750df6595bbdf9652 # remove the 0x from the key_id and add the password to the end of it # PIN = # PIN = \u003c2873\u003e # PIN = 5147bb4dc2069b1094a80b0311a91afd72f8 PIN = \"5147bb4dc2069b1094a80b0311a91afd72f8\" init = 0 åˆ—å‡ºé‡Œé¢çš„pkcs11 keyçš„æƒ…å†µï¼š builder@builder:~/archeris_hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_connector.conf keytool -list -keystore NONE -storetype PKCS11 -storepass 5147bb4dc2069b1094a80b0311a91afd72f8 -providerClass sun.security.pkcs11.SunPKCS11 -providerArg ./conf/hsm_config.conf Keystore type: PKCS11 Keystore provider: SunPKCS11-yubihsm-pkcs Your keystore contains 9 entries is_platform, PrivateKeyEntry, Certificate fingerprint (SHA-256): 4A:EE:97:7C:1C:10:E4:1A:59:38:8F:3A:20:27:17:55:3C:EF:7E:7D:30:B4:10:B1:40:15:09:FC:4F:57:7D:79 media, PrivateKeyEntry, Certificate fingerprint (SHA-256): 90:02:EB:69:82:F9:B8:F1:6A:0F:02:2F:03:0E:F8:AC:6E:78:27:41:86:D1:D8:0F:87:39:A1:2D:40:49:2F:1C networkstack, PrivateKeyEntry, Certificate fingerprint (SHA-256): B7:7A:E1:E4:80:90:73:DC:C2:D1:09:BB:E8:28:81:65:29:BF:97:7C:33:07:73:53:8C:67:11:14:F8:69:17:49 partner, PrivateKeyEntry, Certificate fingerprint (SHA-256): 12:13:92:C9:91:78:7C:96:84:25:1C:A3:49:94:CF:E6:C8:E7:90:85:F7:E7:4D:15:A6:D9:D7:86:81:E1:51:51 platform, PrivateKeyEntry, Certificate fingerprint (SHA-256): D8:4F:01:E6:6F:5E:CD:05:4A:B3:67:0F:EA:5A:E1:FA:EA:A7:73:04:A2:9D:F1:C2:59:48:09:52:E5:FB:C4:6B release, PrivateKeyEntry, Certificate fingerprint (SHA-256): 09:55:75:AE:AE:A3:AE:20:BB:B9:43:2C:1D:47:73:09:BC:E4:22:A0:F3:60:38:0F:E0:31:2F:2C:FE:27:D9:3F shared, PrivateKeyEntry, Certificate fingerprint (SHA-256): 84:CE:CB:ED:38:A7:00:AB:D1:E4:71:0C:8C:51:0D:3F:77:D6:B2:CB:72:B3:96:94:83:7A:A8:8A:FE:C2:93:9B webview, PrivateKeyEntry, Certificate fingerprint (SHA-256): 06:DC:3A:86:59:EF:66:95:5B:C6:18:37:A3:D1:F3:5D:44:18:01:59:43:0D:3B:27:ED:B6:A7:D5:80:0C:7A:EA wrap_259, SecretKeyEntry, ç”¨é€”ï¼š ArcherIS AP apk ç­¾å ArcherIS releasekey otaç­¾å Archer A13 AP apk ç­¾å(è®¡åˆ’ä¸­ï¼ŒéªŒè¯ä¸­) Archer A13 ç›®å‰å»¶ç”¨A11 çš„é¡¹ç›® release ota é‡‡ç”¨ç›´æ¥ç”¨releasekeyçš„æ–¹æ¡ˆ ä¸€ä¸ªåŠ å¯†ç‹— ç”¨äº Archer ==551== connector=yhusb://serial=0016499551 [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so dynamic_path = /usr/lib/x86_64-linux-gnu/openssl-1.0.0/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so PIN = \"60d4458874be39d674225d861b3080f02068\" INIT_ARGS = \"connector=yhusb://serial=0016499551\" #INIT_ARGS = \"connector=http://localhost:12345\" init = 0 builder@builder:~/hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_connector.conf keytool -list -keystore NONE -storetype PKCS11 -storepass 60d4458874be39d674225d861b3080f02068 -providerClass sun.security.pkcs11.SunPKCS11 -providerArg ./conf/hsm_config.conf Keystore type: PKCS11 Keystore provider: SunPKCS11-yubihsm-pkcs Your keystore contains 0 entries ç”¨é€”ï¼š ArcherIS CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ Archer A11 CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ Archer A13 CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ æ²ˆé˜³æœåŠ¡å™¨ ä¸Šæ’ç€ä¸€ä¸ªåŠ å¯†ç‹— Archer A11çš„é¡¹ç›® ==561== [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so INIT_ARGS = \"connector=yhusb://serial=0016499561\" PIN = \"2873ef94cc600359806750df6595bbdf9652\" init = 0 builder@builder-PowerEdge-R740:~/hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_conne","date":"2024-11-06","objectID":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/:0:1","tags":["blog","å®æˆ˜"],"title":"Archer\u0026ArcherIS APç­¾åæ–¹æ¡ˆæ€»ç»“","uri":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/#å¯¹æ¯”æ€»ç»“"},{"categories":"Android","collections":null,"content":"å…³äºAPç«¯ HSMç­¾åçš„é…ç½®è¯´æ˜ Archer é¡¹ç›®ç­¾åä½¿ç”¨çš„åŠ å¯†ç‹—æ¥è‡ªYubiHSM å…·ä½“çš„ä¸€äº›æ“ä½œè¯´æ˜éœ€è¦åˆ°å®˜ç½‘å¯»æ‰¾ï¼š YubiHSM2 ç”¨äºç­¾åçš„HSMé¡¹ç›®ç›®å‰æœ‰: Archer A11 Archer A13 ArcherIS ç¼–è¯‘çš„æœåŠ¡å™¨åˆ†åˆ«åœ¨åŒ—äº¬å’Œæ²ˆé˜³ åŒ—äº¬æœåŠ¡å™¨ ä¸Šæ’ç€ä¸¤ä¸ªåŠ å¯†ç‹— ä¸€ä¸ªåŠ å¯†ç‹— ç”¨äº ArcherIS ==serial=0016980259== ç›®å‰çš„usb serial noï¼š connector=yhusb://serial=0016980259 é…ç½®å’Œå¯†ç ï¼š [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so INIT_ARGS = \"connector=yhusb://serial=0016980259\" # PIN is the , by default this is 0001password. Meaning the default key_id is '0001' and the default password is 'password' # key_id = 0x2873 password = ef94cc600359806750df6595bbdf9652 # remove the 0x from the key_id and add the password to the end of it # PIN = # PIN = \u003c2873\u003e # PIN = 5147bb4dc2069b1094a80b0311a91afd72f8 PIN = \"5147bb4dc2069b1094a80b0311a91afd72f8\" init = 0 åˆ—å‡ºé‡Œé¢çš„pkcs11 keyçš„æƒ…å†µï¼š builder@builder:~/archeris_hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_connector.conf keytool -list -keystore NONE -storetype PKCS11 -storepass 5147bb4dc2069b1094a80b0311a91afd72f8 -providerClass sun.security.pkcs11.SunPKCS11 -providerArg ./conf/hsm_config.conf Keystore type: PKCS11 Keystore provider: SunPKCS11-yubihsm-pkcs Your keystore contains 9 entries is_platform, PrivateKeyEntry, Certificate fingerprint (SHA-256): 4A:EE:97:7C:1C:10:E4:1A:59:38:8F:3A:20:27:17:55:3C:EF:7E:7D:30:B4:10:B1:40:15:09:FC:4F:57:7D:79 media, PrivateKeyEntry, Certificate fingerprint (SHA-256): 90:02:EB:69:82:F9:B8:F1:6A:0F:02:2F:03:0E:F8:AC:6E:78:27:41:86:D1:D8:0F:87:39:A1:2D:40:49:2F:1C networkstack, PrivateKeyEntry, Certificate fingerprint (SHA-256): B7:7A:E1:E4:80:90:73:DC:C2:D1:09:BB:E8:28:81:65:29:BF:97:7C:33:07:73:53:8C:67:11:14:F8:69:17:49 partner, PrivateKeyEntry, Certificate fingerprint (SHA-256): 12:13:92:C9:91:78:7C:96:84:25:1C:A3:49:94:CF:E6:C8:E7:90:85:F7:E7:4D:15:A6:D9:D7:86:81:E1:51:51 platform, PrivateKeyEntry, Certificate fingerprint (SHA-256): D8:4F:01:E6:6F:5E:CD:05:4A:B3:67:0F:EA:5A:E1:FA:EA:A7:73:04:A2:9D:F1:C2:59:48:09:52:E5:FB:C4:6B release, PrivateKeyEntry, Certificate fingerprint (SHA-256): 09:55:75:AE:AE:A3:AE:20:BB:B9:43:2C:1D:47:73:09:BC:E4:22:A0:F3:60:38:0F:E0:31:2F:2C:FE:27:D9:3F shared, PrivateKeyEntry, Certificate fingerprint (SHA-256): 84:CE:CB:ED:38:A7:00:AB:D1:E4:71:0C:8C:51:0D:3F:77:D6:B2:CB:72:B3:96:94:83:7A:A8:8A:FE:C2:93:9B webview, PrivateKeyEntry, Certificate fingerprint (SHA-256): 06:DC:3A:86:59:EF:66:95:5B:C6:18:37:A3:D1:F3:5D:44:18:01:59:43:0D:3B:27:ED:B6:A7:D5:80:0C:7A:EA wrap_259, SecretKeyEntry, ç”¨é€”ï¼š ArcherIS AP apk ç­¾å ArcherIS releasekey otaç­¾å Archer A13 AP apk ç­¾å(è®¡åˆ’ä¸­ï¼ŒéªŒè¯ä¸­) Archer A13 ç›®å‰å»¶ç”¨A11 çš„é¡¹ç›® release ota é‡‡ç”¨ç›´æ¥ç”¨releasekeyçš„æ–¹æ¡ˆ ä¸€ä¸ªåŠ å¯†ç‹— ç”¨äº Archer ==551== connector=yhusb://serial=0016499551 [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so dynamic_path = /usr/lib/x86_64-linux-gnu/openssl-1.0.0/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so PIN = \"60d4458874be39d674225d861b3080f02068\" INIT_ARGS = \"connector=yhusb://serial=0016499551\" #INIT_ARGS = \"connector=http://localhost:12345\" init = 0 builder@builder:~/hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_connector.conf keytool -list -keystore NONE -storetype PKCS11 -storepass 60d4458874be39d674225d861b3080f02068 -providerClass sun.security.pkcs11.SunPKCS11 -providerArg ./conf/hsm_config.conf Keystore type: PKCS11 Keystore provider: SunPKCS11-yubihsm-pkcs Your keystore contains 0 entries ç”¨é€”ï¼š ArcherIS CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ Archer A11 CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ Archer A13 CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ æ²ˆé˜³æœåŠ¡å™¨ ä¸Šæ’ç€ä¸€ä¸ªåŠ å¯†ç‹— Archer A11çš„é¡¹ç›® ==561== [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so INIT_ARGS = \"connector=yhusb://serial=0016499561\" PIN = \"2873ef94cc600359806750df6595bbdf9652\" init = 0 builder@builder-PowerEdge-R740:~/hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_conne","date":"2024-11-06","objectID":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/:0:1","tags":["blog","å®æˆ˜"],"title":"Archer\u0026ArcherIS APç­¾åæ–¹æ¡ˆæ€»ç»“","uri":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/#ä¸€-platform-key-ä¸å…¶ä»–key"},{"categories":"Android","collections":null,"content":"å…³äºAPç«¯ HSMç­¾åçš„é…ç½®è¯´æ˜ Archer é¡¹ç›®ç­¾åä½¿ç”¨çš„åŠ å¯†ç‹—æ¥è‡ªYubiHSM å…·ä½“çš„ä¸€äº›æ“ä½œè¯´æ˜éœ€è¦åˆ°å®˜ç½‘å¯»æ‰¾ï¼š YubiHSM2 ç”¨äºç­¾åçš„HSMé¡¹ç›®ç›®å‰æœ‰: Archer A11 Archer A13 ArcherIS ç¼–è¯‘çš„æœåŠ¡å™¨åˆ†åˆ«åœ¨åŒ—äº¬å’Œæ²ˆé˜³ åŒ—äº¬æœåŠ¡å™¨ ä¸Šæ’ç€ä¸¤ä¸ªåŠ å¯†ç‹— ä¸€ä¸ªåŠ å¯†ç‹— ç”¨äº ArcherIS ==serial=0016980259== ç›®å‰çš„usb serial noï¼š connector=yhusb://serial=0016980259 é…ç½®å’Œå¯†ç ï¼š [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so INIT_ARGS = \"connector=yhusb://serial=0016980259\" # PIN is the , by default this is 0001password. Meaning the default key_id is '0001' and the default password is 'password' # key_id = 0x2873 password = ef94cc600359806750df6595bbdf9652 # remove the 0x from the key_id and add the password to the end of it # PIN = # PIN = \u003c2873\u003e # PIN = 5147bb4dc2069b1094a80b0311a91afd72f8 PIN = \"5147bb4dc2069b1094a80b0311a91afd72f8\" init = 0 åˆ—å‡ºé‡Œé¢çš„pkcs11 keyçš„æƒ…å†µï¼š builder@builder:~/archeris_hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_connector.conf keytool -list -keystore NONE -storetype PKCS11 -storepass 5147bb4dc2069b1094a80b0311a91afd72f8 -providerClass sun.security.pkcs11.SunPKCS11 -providerArg ./conf/hsm_config.conf Keystore type: PKCS11 Keystore provider: SunPKCS11-yubihsm-pkcs Your keystore contains 9 entries is_platform, PrivateKeyEntry, Certificate fingerprint (SHA-256): 4A:EE:97:7C:1C:10:E4:1A:59:38:8F:3A:20:27:17:55:3C:EF:7E:7D:30:B4:10:B1:40:15:09:FC:4F:57:7D:79 media, PrivateKeyEntry, Certificate fingerprint (SHA-256): 90:02:EB:69:82:F9:B8:F1:6A:0F:02:2F:03:0E:F8:AC:6E:78:27:41:86:D1:D8:0F:87:39:A1:2D:40:49:2F:1C networkstack, PrivateKeyEntry, Certificate fingerprint (SHA-256): B7:7A:E1:E4:80:90:73:DC:C2:D1:09:BB:E8:28:81:65:29:BF:97:7C:33:07:73:53:8C:67:11:14:F8:69:17:49 partner, PrivateKeyEntry, Certificate fingerprint (SHA-256): 12:13:92:C9:91:78:7C:96:84:25:1C:A3:49:94:CF:E6:C8:E7:90:85:F7:E7:4D:15:A6:D9:D7:86:81:E1:51:51 platform, PrivateKeyEntry, Certificate fingerprint (SHA-256): D8:4F:01:E6:6F:5E:CD:05:4A:B3:67:0F:EA:5A:E1:FA:EA:A7:73:04:A2:9D:F1:C2:59:48:09:52:E5:FB:C4:6B release, PrivateKeyEntry, Certificate fingerprint (SHA-256): 09:55:75:AE:AE:A3:AE:20:BB:B9:43:2C:1D:47:73:09:BC:E4:22:A0:F3:60:38:0F:E0:31:2F:2C:FE:27:D9:3F shared, PrivateKeyEntry, Certificate fingerprint (SHA-256): 84:CE:CB:ED:38:A7:00:AB:D1:E4:71:0C:8C:51:0D:3F:77:D6:B2:CB:72:B3:96:94:83:7A:A8:8A:FE:C2:93:9B webview, PrivateKeyEntry, Certificate fingerprint (SHA-256): 06:DC:3A:86:59:EF:66:95:5B:C6:18:37:A3:D1:F3:5D:44:18:01:59:43:0D:3B:27:ED:B6:A7:D5:80:0C:7A:EA wrap_259, SecretKeyEntry, ç”¨é€”ï¼š ArcherIS AP apk ç­¾å ArcherIS releasekey otaç­¾å Archer A13 AP apk ç­¾å(è®¡åˆ’ä¸­ï¼ŒéªŒè¯ä¸­) Archer A13 ç›®å‰å»¶ç”¨A11 çš„é¡¹ç›® release ota é‡‡ç”¨ç›´æ¥ç”¨releasekeyçš„æ–¹æ¡ˆ ä¸€ä¸ªåŠ å¯†ç‹— ç”¨äº Archer ==551== connector=yhusb://serial=0016499551 [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so dynamic_path = /usr/lib/x86_64-linux-gnu/openssl-1.0.0/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so PIN = \"60d4458874be39d674225d861b3080f02068\" INIT_ARGS = \"connector=yhusb://serial=0016499551\" #INIT_ARGS = \"connector=http://localhost:12345\" init = 0 builder@builder:~/hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_connector.conf keytool -list -keystore NONE -storetype PKCS11 -storepass 60d4458874be39d674225d861b3080f02068 -providerClass sun.security.pkcs11.SunPKCS11 -providerArg ./conf/hsm_config.conf Keystore type: PKCS11 Keystore provider: SunPKCS11-yubihsm-pkcs Your keystore contains 0 entries ç”¨é€”ï¼š ArcherIS CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ Archer A11 CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ Archer A13 CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ æ²ˆé˜³æœåŠ¡å™¨ ä¸Šæ’ç€ä¸€ä¸ªåŠ å¯†ç‹— Archer A11çš„é¡¹ç›® ==561== [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so INIT_ARGS = \"connector=yhusb://serial=0016499561\" PIN = \"2873ef94cc600359806750df6595bbdf9652\" init = 0 builder@builder-PowerEdge-R740:~/hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_conne","date":"2024-11-06","objectID":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/:0:1","tags":["blog","å®æˆ˜"],"title":"Archer\u0026ArcherIS APç­¾åæ–¹æ¡ˆæ€»ç»“","uri":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/#äºŒ-release-key"},{"categories":"Android","collections":null,"content":"å…³äºAPç«¯ HSMç­¾åçš„é…ç½®è¯´æ˜ Archer é¡¹ç›®ç­¾åä½¿ç”¨çš„åŠ å¯†ç‹—æ¥è‡ªYubiHSM å…·ä½“çš„ä¸€äº›æ“ä½œè¯´æ˜éœ€è¦åˆ°å®˜ç½‘å¯»æ‰¾ï¼š YubiHSM2 ç”¨äºç­¾åçš„HSMé¡¹ç›®ç›®å‰æœ‰: Archer A11 Archer A13 ArcherIS ç¼–è¯‘çš„æœåŠ¡å™¨åˆ†åˆ«åœ¨åŒ—äº¬å’Œæ²ˆé˜³ åŒ—äº¬æœåŠ¡å™¨ ä¸Šæ’ç€ä¸¤ä¸ªåŠ å¯†ç‹— ä¸€ä¸ªåŠ å¯†ç‹— ç”¨äº ArcherIS ==serial=0016980259== ç›®å‰çš„usb serial noï¼š connector=yhusb://serial=0016980259 é…ç½®å’Œå¯†ç ï¼š [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so INIT_ARGS = \"connector=yhusb://serial=0016980259\" # PIN is the , by default this is 0001password. Meaning the default key_id is '0001' and the default password is 'password' # key_id = 0x2873 password = ef94cc600359806750df6595bbdf9652 # remove the 0x from the key_id and add the password to the end of it # PIN = # PIN = \u003c2873\u003e # PIN = 5147bb4dc2069b1094a80b0311a91afd72f8 PIN = \"5147bb4dc2069b1094a80b0311a91afd72f8\" init = 0 åˆ—å‡ºé‡Œé¢çš„pkcs11 keyçš„æƒ…å†µï¼š builder@builder:~/archeris_hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_connector.conf keytool -list -keystore NONE -storetype PKCS11 -storepass 5147bb4dc2069b1094a80b0311a91afd72f8 -providerClass sun.security.pkcs11.SunPKCS11 -providerArg ./conf/hsm_config.conf Keystore type: PKCS11 Keystore provider: SunPKCS11-yubihsm-pkcs Your keystore contains 9 entries is_platform, PrivateKeyEntry, Certificate fingerprint (SHA-256): 4A:EE:97:7C:1C:10:E4:1A:59:38:8F:3A:20:27:17:55:3C:EF:7E:7D:30:B4:10:B1:40:15:09:FC:4F:57:7D:79 media, PrivateKeyEntry, Certificate fingerprint (SHA-256): 90:02:EB:69:82:F9:B8:F1:6A:0F:02:2F:03:0E:F8:AC:6E:78:27:41:86:D1:D8:0F:87:39:A1:2D:40:49:2F:1C networkstack, PrivateKeyEntry, Certificate fingerprint (SHA-256): B7:7A:E1:E4:80:90:73:DC:C2:D1:09:BB:E8:28:81:65:29:BF:97:7C:33:07:73:53:8C:67:11:14:F8:69:17:49 partner, PrivateKeyEntry, Certificate fingerprint (SHA-256): 12:13:92:C9:91:78:7C:96:84:25:1C:A3:49:94:CF:E6:C8:E7:90:85:F7:E7:4D:15:A6:D9:D7:86:81:E1:51:51 platform, PrivateKeyEntry, Certificate fingerprint (SHA-256): D8:4F:01:E6:6F:5E:CD:05:4A:B3:67:0F:EA:5A:E1:FA:EA:A7:73:04:A2:9D:F1:C2:59:48:09:52:E5:FB:C4:6B release, PrivateKeyEntry, Certificate fingerprint (SHA-256): 09:55:75:AE:AE:A3:AE:20:BB:B9:43:2C:1D:47:73:09:BC:E4:22:A0:F3:60:38:0F:E0:31:2F:2C:FE:27:D9:3F shared, PrivateKeyEntry, Certificate fingerprint (SHA-256): 84:CE:CB:ED:38:A7:00:AB:D1:E4:71:0C:8C:51:0D:3F:77:D6:B2:CB:72:B3:96:94:83:7A:A8:8A:FE:C2:93:9B webview, PrivateKeyEntry, Certificate fingerprint (SHA-256): 06:DC:3A:86:59:EF:66:95:5B:C6:18:37:A3:D1:F3:5D:44:18:01:59:43:0D:3B:27:ED:B6:A7:D5:80:0C:7A:EA wrap_259, SecretKeyEntry, ç”¨é€”ï¼š ArcherIS AP apk ç­¾å ArcherIS releasekey otaç­¾å Archer A13 AP apk ç­¾å(è®¡åˆ’ä¸­ï¼ŒéªŒè¯ä¸­) Archer A13 ç›®å‰å»¶ç”¨A11 çš„é¡¹ç›® release ota é‡‡ç”¨ç›´æ¥ç”¨releasekeyçš„æ–¹æ¡ˆ ä¸€ä¸ªåŠ å¯†ç‹— ç”¨äº Archer ==551== connector=yhusb://serial=0016499551 [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so dynamic_path = /usr/lib/x86_64-linux-gnu/openssl-1.0.0/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so PIN = \"60d4458874be39d674225d861b3080f02068\" INIT_ARGS = \"connector=yhusb://serial=0016499551\" #INIT_ARGS = \"connector=http://localhost:12345\" init = 0 builder@builder:~/hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_connector.conf keytool -list -keystore NONE -storetype PKCS11 -storepass 60d4458874be39d674225d861b3080f02068 -providerClass sun.security.pkcs11.SunPKCS11 -providerArg ./conf/hsm_config.conf Keystore type: PKCS11 Keystore provider: SunPKCS11-yubihsm-pkcs Your keystore contains 0 entries ç”¨é€”ï¼š ArcherIS CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ Archer A11 CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ Archer A13 CP SecureBoot åº”è¯¥ä¹Ÿæ˜¯ç”¨çš„è¯¥åŠ å¯†ç‹—ã€‚ æ²ˆé˜³æœåŠ¡å™¨ ä¸Šæ’ç€ä¸€ä¸ªåŠ å¯†ç‹— Archer A11çš„é¡¹ç›® ==561== [pkcs11_section] engine_id = pkcs11 #dynamic_path = /usr/lib/ssl/engines/libpkcs11.so MODULE_PATH = /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so INIT_ARGS = \"connector=yhusb://serial=0016499561\" PIN = \"2873ef94cc600359806750df6595bbdf9652\" init = 0 builder@builder-PowerEdge-R740:~/hsm_apk_signer$ YUBIHSM_PKCS11_CONF=./conf/yubihsm_conne","date":"2024-11-06","objectID":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/:0:1","tags":["blog","å®æˆ˜"],"title":"Archer\u0026ArcherIS APç­¾åæ–¹æ¡ˆæ€»ç»“","uri":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/#ä¸‰-archer---551-çš„æƒ…å†µ"},{"categories":"Android","collections":null,"content":"ç­¾åæ–¹æ¡ˆ å…³äºHSMçš„ç­¾åæ–¹æ¡ˆï¼Œæ¦‚è¦çš„è¯´å°±æ˜¯åŸæ¥æ”¾åœ¨build/security/ ä¸‹é¢çš„ ç§é’¥å’Œè¯ä¹¦å¯¹ã€‚ å®¢æˆ·ç”±äºå®‰å…¨çš„å› ç´ ï¼Œä¸å¤–å‘ç›¸å…³çš„ç§é’¥ã€‚ é‚£ä¹ˆç§é’¥é€šè¿‡å†™å…¥ HSM è¿™ç§åŠ å¯†Uç›˜(åŠ å¯†ç‹—)ï¼Œé€šè¿‡ç§é’¥å»ç­¾åçš„å·¥ä½œï¼Œå°±äº¤ç»™äº†åŠ å¯†Uç›˜æ¥å¤„ç†äº†ã€‚ é‚£ä¹ˆåœ¨æºç ç¼–è¯‘è¿‡ç¨‹ä¸­ä½¿ç”¨äº† build/security/ ä¸‹é¢keyçš„å·¥ä½œæœ‰ä»¥ä¸‹å‡ ç‚¹ï¼ˆCPç«¯çš„é•œåƒç­¾åæ²¡æœ‰é‡‡ç”¨é‡Œé¢çš„keyï¼Œæœ‰é¢å¤–çš„keyï¼Œåœ¨è¿™é‡Œä¸è®¨è®ºï¼‰ APKçš„ç­¾åå·¥ä½œ otaåŒ…çš„ç­¾åå·¥ä½œ è¿‡å¾€æ–¹æ¡ˆé€‰æ‹©è¯´æ˜ é‚£ä¹ˆè¦åšçš„å·¥ä½œå°±æ˜¯æŠŠä¸Šé¢çš„ä¸¤ä¸ªç­¾åæµç¨‹ï¼Œä»æœ¬åœ°ç­¾åä¿®æ”¹åˆ°é€šè¿‡åŠ å¯†ç‹—å»ç­¾åã€‚ é‚£ä¹ˆä¹‹å‰çš„å·¥ç¨‹å¸ˆåœ¨ä¿®æ”¹ç­¾åæµç¨‹çš„æ—¶å€™é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯Android æºç çš„ç¼–è¯‘æ˜¯å¤šçº¿ç¨‹çš„ï¼Œä¸€èˆ¬CPU æ ¸å¿ƒè¶Šå¤šï¼Œçº¿ç¨‹è¶Šå¤šã€‚å¯èƒ½åœ¨ç¼–è¯‘apkçš„æ—¶å€™ï¼Œä¼šæœ‰å¤šä¸ªåº”ç”¨å»åŒæ—¶ç­¾åï¼Œè€ŒåŠ å¯†ç‹—æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„ç­¾åç³»ç»Ÿã€‚è¿™é‡Œå°±ä¼šé‡åˆ°å†²çªé—®é¢˜ã€‚ ç›®å‰é‡‡å–çš„æ–¹æ¡ˆï¼Œå°±æ˜¯å¯åŠ¨ä¸€ä¸ªç­¾åæœåŠ¡ï¼Œç”¨æ¥æä¾›ç­¾åå·¥ä½œï¼Œä¼ å…¥ç­¾åæ–‡ä»¶ï¼Œå’Œç­¾åç§˜é’¥åˆ«åã€‚æŠŠè¿™äº›éœ€æ±‚åŠ å…¥é˜Ÿåˆ—ä¸­ï¼ŒæŒ‰ç…§é¡ºåºå»ç­¾åã€‚è¿™æ ·å°±ä¸ä¼šæœ‰å†²çªé—®é¢˜ã€‚ ç­¾åæœåŠ¡ä¸Šä¼ äº†æºç ï¼Œåœ¨é¡¹ç›®è·¯å¾„ï¼š build/soong/cmd/hsm_signer APKçš„ç­¾åå·¥ä½œ hsm ä¸Šæ”¯æŒé€šè¿‡apksigner è¿›è¡Œ PKCS11 çš„ç­¾åï¼Œå…·ä½“å‘½ä»¤å¦‚ä¸‹ï¼Œé‡Œé¢åŒ…å«äº†åŠ å¯†ç‹—çš„ serial noï¼Œè¿˜æœ‰å¯†ç ã€‚ #!/bin/sh sudo YUBIHSM_PKCS11_CONF=simt_connector.conf \\ /home/kailoma/Android/Sdk/build-tools/31.0.0/apksigner sign \\ --provider-class sun.security.pkcs11.SunPKCS11 \\ --provider-arg simt_yubihsm.conf \\ --ks NONE \\ --ks-pass pass:5147bb4dc2069b1094a80b0311a91afd72f8 \\ --ks-type pkcs11 \\ --ks-key-alias \u003ckey-alias\u003e \\ --min-sdk-version 17 \\ --max-sdk-version 30 \\ --v1-signing-enabled true \\ --v2-signing-enabled true \\ -v \\ -out \u003cpath-to-output-apk-file\u003e-signed.apk \\ -in \u003cpath-to-input-apk-file\u003e.apk; è¿™éƒ¨åˆ†å®ç°æ˜¯åœ¨åŠ å¯†æœåŠ¡é‡Œé¢ï¼Œé€šå¸¸AOSP ç¼–è¯‘æ˜¯é€šè¿‡è°ƒç”¨åŠ å¯†æœåŠ¡æ¥å®ç°çš„ï¼š curl -d \"key_alias=platform\u0026apk_unsigned_path=/home/builder/huangwentao/temp/CIT.apk\u0026apk_signed_path=/home/builder/huangwentao/temp/CIT_PLATFORM.apk\" http://localhost:8886/hsm_apk_sign è¿™ä¸ªä¾‹å­é‡Œé¢å°±æ˜¯ï¼šè®¿é—®äº† localhost 8886 ç«¯å£çš„ hsm_apk_signæœåŠ¡ ç„¶ååœ¨æºç  SignApk.java é‡Œé¢ï¼š ProcessBuilder processBuilder = new ProcessBuilder(); processBuilder.command(\"bash\", \"-c\", \"curl -d \\\"key_alias=\" + keyAlias + \"\u0026apk_unsigned_path=\" + unsignedApkPath + \"\u0026apk_signed_path=\" + signedApkPath + \"\\\" http://localhost:8886/hsm_apk_sign\"); try { Process process = processBuilder.start(); StringBuilder output = new StringBuilder(); BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream())); String line; while ((line = reader.readLine()) != null) { output.append(line + \"\\n\"); } otaåŒ…çš„ç­¾åå·¥ä½œ é‡‡ç”¨å®˜ç½‘æç¤ºè¿›è¡Œç­¾å otaåŒ…çš„ç­¾åå·¥ä½œï¼Œä¸æ˜¯è°ƒç”¨apksigner HSMå®˜ç½‘çš„è¯´æ˜é‡Œé¢ï¼Œpkcs11å¯ä»¥é‡‡ç”¨pkcs11-tool export YUBIHSM_PKCS11_CONF=~/huangwentao/qcm6490-archer-IS-00034-dev-r/build/soong/cmd/hsm_signer/conf/yubihsm_connector.conf #-m SHA256-RSA-PKCS /usr/bin/pkcs11-tool --module /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so --login -p 5147bb4dc2069b1094a80b0311a91afd72f8 --sign --id 0032 -i sig.bin -o signed-new.bin otaçš„ç­¾åé‡Œé¢çš„sig.bin å°±æ˜¯é’ˆå¯¹payload.binè¿›è¡Œçš„sha256 hashå€¼ã€‚æ‰€ä»¥åœ¨ç­¾åçš„æ—¶å€™ï¼Œä¸ç”¨å†åŠ -m SHA256-RSA-PKCSï¼Œå¦åˆ™éªŒç­¾ä¼šå‡ºé”™ã€‚ ç¼–è¯‘æ•´åŒ…çš„æ—¶å€™ï¼Œä¼šæœ‰sig.bin ä»¥åŠç­¾åæ–‡ä»¶sig_signed.bin å‡ºæ¥ã€‚æˆ‘ä»¬é€šè¿‡ od -tx1 æ¥æŸ¥çœ‹äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ sig.bin äºŒè¿›åˆ¶ï¼š builder@builder:~/huangwentao/buildtemp/after$ cat sig.bin |od -tx1 0000000 05 ef dd 77 4f 7f 1d 11 59 cc fc dd 9d c7 25 be 0000020 2a a9 16 5b 5d 9a dd 32 5b 46 c6 f1 93 16 f0 8f 0000040 sig.bin hash256åçš„äºŒè¿›åˆ¶ï¼š builder@builder:~/huangwentao/buildtemp/after$ openssl sha256 -binary sig.bin |od -tx1 0000000 20 c3 0a eb ac 21 1f 23 11 a4 8e dd 66 6e ae 1f 0000020 fc b5 72 fd 3f f8 15 09 e1 71 41 1d fb 21 93 e8 0000040 ç­¾åæ·»åŠ  sha256åçš„ç­¾åÂ /usr/bin/pkcs11-tool â€“module /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so â€“login -p 5147bb4dc2069b1094a80b0311a91afd72f8 â€“signÂ â€“id 0032Â -m SHA256-RSA-PKCS -i sig.bin -o sig_signed256.bin ç„¶åé€šè¿‡å…¬é’¥å»è§£ç ï¼Œå‘ç°å’Œsig.binÂ hash 256çš„æ˜¯ä¸€è‡´çš„ã€‚ builder@builder:~/huangwentao/buildtemp/after$ openssl rsautl -verify -pubin -inkey key-pub.key -in sig_signed256.bin |od -tx1 0000000 30 31 30 0d 06 09 60 86 48 01 65 03 04 02 01 05 0000020 00 04 20 20 c3 0a eb ac 21 1f 23 11 a4 8e dd 66 0000040 6e ae 1f fc b5 72 fd 3f f8 15 09 e1 71 41 1d fb 0000060 21 93 e8 åœ¨main å‡½æ•°é‡Œé¢æ·»åŠ å‚æ•°ï¼Œé‡‡ç”¨ pkcs11-tool å»ç­¾å @@ -1200,6 +1212,21 @@ def GenerateAbOtaPackage(target_file, output_file, source_file=None): def main(argv): + #ArcherIs code for yubihsm by 00169 at 20230423 begin + if os.path.exists(\"./.build_with_yubihsm\") : + #wentao + cmd = [\"pwd\"] + common.RunAndCheckOutput(cmd) + print(\"hsm py version 002 yubihsm exist ,use yubihsm build tools pkcs11-tool instend \") + print(\"yubihsm before argv :\",argv) + argv.insert(0, '-v') + argv.insert(1, '--payload_signer') + argv.insert(2, '/usr/bin/pkcs11-tool') + #argv.insert(3, '--payload_sign","date":"2024-11-06","objectID":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/:0:2","tags":["blog","å®æˆ˜"],"title":"Archer\u0026ArcherIS APç­¾åæ–¹æ¡ˆæ€»ç»“","uri":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/#ç­¾åæ–¹æ¡ˆ"},{"categories":"Android","collections":null,"content":"ç­¾åæ–¹æ¡ˆ å…³äºHSMçš„ç­¾åæ–¹æ¡ˆï¼Œæ¦‚è¦çš„è¯´å°±æ˜¯åŸæ¥æ”¾åœ¨build/security/ ä¸‹é¢çš„ ç§é’¥å’Œè¯ä¹¦å¯¹ã€‚ å®¢æˆ·ç”±äºå®‰å…¨çš„å› ç´ ï¼Œä¸å¤–å‘ç›¸å…³çš„ç§é’¥ã€‚ é‚£ä¹ˆç§é’¥é€šè¿‡å†™å…¥ HSM è¿™ç§åŠ å¯†Uç›˜(åŠ å¯†ç‹—)ï¼Œé€šè¿‡ç§é’¥å»ç­¾åçš„å·¥ä½œï¼Œå°±äº¤ç»™äº†åŠ å¯†Uç›˜æ¥å¤„ç†äº†ã€‚ é‚£ä¹ˆåœ¨æºç ç¼–è¯‘è¿‡ç¨‹ä¸­ä½¿ç”¨äº† build/security/ ä¸‹é¢keyçš„å·¥ä½œæœ‰ä»¥ä¸‹å‡ ç‚¹ï¼ˆCPç«¯çš„é•œåƒç­¾åæ²¡æœ‰é‡‡ç”¨é‡Œé¢çš„keyï¼Œæœ‰é¢å¤–çš„keyï¼Œåœ¨è¿™é‡Œä¸è®¨è®ºï¼‰ APKçš„ç­¾åå·¥ä½œ otaåŒ…çš„ç­¾åå·¥ä½œ è¿‡å¾€æ–¹æ¡ˆé€‰æ‹©è¯´æ˜ é‚£ä¹ˆè¦åšçš„å·¥ä½œå°±æ˜¯æŠŠä¸Šé¢çš„ä¸¤ä¸ªç­¾åæµç¨‹ï¼Œä»æœ¬åœ°ç­¾åä¿®æ”¹åˆ°é€šè¿‡åŠ å¯†ç‹—å»ç­¾åã€‚ é‚£ä¹ˆä¹‹å‰çš„å·¥ç¨‹å¸ˆåœ¨ä¿®æ”¹ç­¾åæµç¨‹çš„æ—¶å€™é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯Android æºç çš„ç¼–è¯‘æ˜¯å¤šçº¿ç¨‹çš„ï¼Œä¸€èˆ¬CPU æ ¸å¿ƒè¶Šå¤šï¼Œçº¿ç¨‹è¶Šå¤šã€‚å¯èƒ½åœ¨ç¼–è¯‘apkçš„æ—¶å€™ï¼Œä¼šæœ‰å¤šä¸ªåº”ç”¨å»åŒæ—¶ç­¾åï¼Œè€ŒåŠ å¯†ç‹—æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„ç­¾åç³»ç»Ÿã€‚è¿™é‡Œå°±ä¼šé‡åˆ°å†²çªé—®é¢˜ã€‚ ç›®å‰é‡‡å–çš„æ–¹æ¡ˆï¼Œå°±æ˜¯å¯åŠ¨ä¸€ä¸ªç­¾åæœåŠ¡ï¼Œç”¨æ¥æä¾›ç­¾åå·¥ä½œï¼Œä¼ å…¥ç­¾åæ–‡ä»¶ï¼Œå’Œç­¾åç§˜é’¥åˆ«åã€‚æŠŠè¿™äº›éœ€æ±‚åŠ å…¥é˜Ÿåˆ—ä¸­ï¼ŒæŒ‰ç…§é¡ºåºå»ç­¾åã€‚è¿™æ ·å°±ä¸ä¼šæœ‰å†²çªé—®é¢˜ã€‚ ç­¾åæœåŠ¡ä¸Šä¼ äº†æºç ï¼Œåœ¨é¡¹ç›®è·¯å¾„ï¼š build/soong/cmd/hsm_signer APKçš„ç­¾åå·¥ä½œ hsm ä¸Šæ”¯æŒé€šè¿‡apksigner è¿›è¡Œ PKCS11 çš„ç­¾åï¼Œå…·ä½“å‘½ä»¤å¦‚ä¸‹ï¼Œé‡Œé¢åŒ…å«äº†åŠ å¯†ç‹—çš„ serial noï¼Œè¿˜æœ‰å¯†ç ã€‚ #!/bin/sh sudo YUBIHSM_PKCS11_CONF=simt_connector.conf \\ /home/kailoma/Android/Sdk/build-tools/31.0.0/apksigner sign \\ --provider-class sun.security.pkcs11.SunPKCS11 \\ --provider-arg simt_yubihsm.conf \\ --ks NONE \\ --ks-pass pass:5147bb4dc2069b1094a80b0311a91afd72f8 \\ --ks-type pkcs11 \\ --ks-key-alias \\ --min-sdk-version 17 \\ --max-sdk-version 30 \\ --v1-signing-enabled true \\ --v2-signing-enabled true \\ -v \\ -out -signed.apk \\ -in .apk; è¿™éƒ¨åˆ†å®ç°æ˜¯åœ¨åŠ å¯†æœåŠ¡é‡Œé¢ï¼Œé€šå¸¸AOSP ç¼–è¯‘æ˜¯é€šè¿‡è°ƒç”¨åŠ å¯†æœåŠ¡æ¥å®ç°çš„ï¼š curl -d \"key_alias=platform\u0026apk_unsigned_path=/home/builder/huangwentao/temp/CIT.apk\u0026apk_signed_path=/home/builder/huangwentao/temp/CIT_PLATFORM.apk\" http://localhost:8886/hsm_apk_sign è¿™ä¸ªä¾‹å­é‡Œé¢å°±æ˜¯ï¼šè®¿é—®äº† localhost 8886 ç«¯å£çš„ hsm_apk_signæœåŠ¡ ç„¶ååœ¨æºç  SignApk.java é‡Œé¢ï¼š ProcessBuilder processBuilder = new ProcessBuilder(); processBuilder.command(\"bash\", \"-c\", \"curl -d \\\"key_alias=\" + keyAlias + \"\u0026apk_unsigned_path=\" + unsignedApkPath + \"\u0026apk_signed_path=\" + signedApkPath + \"\\\" http://localhost:8886/hsm_apk_sign\"); try { Process process = processBuilder.start(); StringBuilder output = new StringBuilder(); BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream())); String line; while ((line = reader.readLine()) != null) { output.append(line + \"\\n\"); } otaåŒ…çš„ç­¾åå·¥ä½œ é‡‡ç”¨å®˜ç½‘æç¤ºè¿›è¡Œç­¾å otaåŒ…çš„ç­¾åå·¥ä½œï¼Œä¸æ˜¯è°ƒç”¨apksigner HSMå®˜ç½‘çš„è¯´æ˜é‡Œé¢ï¼Œpkcs11å¯ä»¥é‡‡ç”¨pkcs11-tool export YUBIHSM_PKCS11_CONF=~/huangwentao/qcm6490-archer-IS-00034-dev-r/build/soong/cmd/hsm_signer/conf/yubihsm_connector.conf #-m SHA256-RSA-PKCS /usr/bin/pkcs11-tool --module /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so --login -p 5147bb4dc2069b1094a80b0311a91afd72f8 --sign --id 0032 -i sig.bin -o signed-new.bin otaçš„ç­¾åé‡Œé¢çš„sig.bin å°±æ˜¯é’ˆå¯¹payload.binè¿›è¡Œçš„sha256 hashå€¼ã€‚æ‰€ä»¥åœ¨ç­¾åçš„æ—¶å€™ï¼Œä¸ç”¨å†åŠ -m SHA256-RSA-PKCSï¼Œå¦åˆ™éªŒç­¾ä¼šå‡ºé”™ã€‚ ç¼–è¯‘æ•´åŒ…çš„æ—¶å€™ï¼Œä¼šæœ‰sig.bin ä»¥åŠç­¾åæ–‡ä»¶sig_signed.bin å‡ºæ¥ã€‚æˆ‘ä»¬é€šè¿‡ od -tx1 æ¥æŸ¥çœ‹äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ sig.bin äºŒè¿›åˆ¶ï¼š builder@builder:~/huangwentao/buildtemp/after$ cat sig.bin |od -tx1 0000000 05 ef dd 77 4f 7f 1d 11 59 cc fc dd 9d c7 25 be 0000020 2a a9 16 5b 5d 9a dd 32 5b 46 c6 f1 93 16 f0 8f 0000040 sig.bin hash256åçš„äºŒè¿›åˆ¶ï¼š builder@builder:~/huangwentao/buildtemp/after$ openssl sha256 -binary sig.bin |od -tx1 0000000 20 c3 0a eb ac 21 1f 23 11 a4 8e dd 66 6e ae 1f 0000020 fc b5 72 fd 3f f8 15 09 e1 71 41 1d fb 21 93 e8 0000040 ç­¾åæ·»åŠ  sha256åçš„ç­¾åÂ /usr/bin/pkcs11-tool â€“module /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so â€“login -p 5147bb4dc2069b1094a80b0311a91afd72f8 â€“signÂ â€“id 0032Â -m SHA256-RSA-PKCS -i sig.bin -o sig_signed256.bin ç„¶åé€šè¿‡å…¬é’¥å»è§£ç ï¼Œå‘ç°å’Œsig.binÂ hash 256çš„æ˜¯ä¸€è‡´çš„ã€‚ builder@builder:~/huangwentao/buildtemp/after$ openssl rsautl -verify -pubin -inkey key-pub.key -in sig_signed256.bin |od -tx1 0000000 30 31 30 0d 06 09 60 86 48 01 65 03 04 02 01 05 0000020 00 04 20 20 c3 0a eb ac 21 1f 23 11 a4 8e dd 66 0000040 6e ae 1f fc b5 72 fd 3f f8 15 09 e1 71 41 1d fb 0000060 21 93 e8 åœ¨main å‡½æ•°é‡Œé¢æ·»åŠ å‚æ•°ï¼Œé‡‡ç”¨ pkcs11-tool å»ç­¾å @@ -1200,6 +1212,21 @@ def GenerateAbOtaPackage(target_file, output_file, source_file=None): def main(argv): + #ArcherIs code for yubihsm by 00169 at 20230423 begin + if os.path.exists(\"./.build_with_yubihsm\") : + #wentao + cmd = [\"pwd\"] + common.RunAndCheckOutput(cmd) + print(\"hsm py version 002 yubihsm exist ,use yubihsm build tools pkcs11-tool instend \") + print(\"yubihsm before argv :\",argv) + argv.insert(0, '-v') + argv.insert(1, '--payload_signer') + argv.insert(2, '/usr/bin/pkcs11-tool') + #argv.insert(3, '--payload_sign","date":"2024-11-06","objectID":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/:0:2","tags":["blog","å®æˆ˜"],"title":"Archer\u0026ArcherIS APç­¾åæ–¹æ¡ˆæ€»ç»“","uri":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/#è¿‡å¾€æ–¹æ¡ˆé€‰æ‹©è¯´æ˜"},{"categories":"Android","collections":null,"content":"ç­¾åæ–¹æ¡ˆ å…³äºHSMçš„ç­¾åæ–¹æ¡ˆï¼Œæ¦‚è¦çš„è¯´å°±æ˜¯åŸæ¥æ”¾åœ¨build/security/ ä¸‹é¢çš„ ç§é’¥å’Œè¯ä¹¦å¯¹ã€‚ å®¢æˆ·ç”±äºå®‰å…¨çš„å› ç´ ï¼Œä¸å¤–å‘ç›¸å…³çš„ç§é’¥ã€‚ é‚£ä¹ˆç§é’¥é€šè¿‡å†™å…¥ HSM è¿™ç§åŠ å¯†Uç›˜(åŠ å¯†ç‹—)ï¼Œé€šè¿‡ç§é’¥å»ç­¾åçš„å·¥ä½œï¼Œå°±äº¤ç»™äº†åŠ å¯†Uç›˜æ¥å¤„ç†äº†ã€‚ é‚£ä¹ˆåœ¨æºç ç¼–è¯‘è¿‡ç¨‹ä¸­ä½¿ç”¨äº† build/security/ ä¸‹é¢keyçš„å·¥ä½œæœ‰ä»¥ä¸‹å‡ ç‚¹ï¼ˆCPç«¯çš„é•œåƒç­¾åæ²¡æœ‰é‡‡ç”¨é‡Œé¢çš„keyï¼Œæœ‰é¢å¤–çš„keyï¼Œåœ¨è¿™é‡Œä¸è®¨è®ºï¼‰ APKçš„ç­¾åå·¥ä½œ otaåŒ…çš„ç­¾åå·¥ä½œ è¿‡å¾€æ–¹æ¡ˆé€‰æ‹©è¯´æ˜ é‚£ä¹ˆè¦åšçš„å·¥ä½œå°±æ˜¯æŠŠä¸Šé¢çš„ä¸¤ä¸ªç­¾åæµç¨‹ï¼Œä»æœ¬åœ°ç­¾åä¿®æ”¹åˆ°é€šè¿‡åŠ å¯†ç‹—å»ç­¾åã€‚ é‚£ä¹ˆä¹‹å‰çš„å·¥ç¨‹å¸ˆåœ¨ä¿®æ”¹ç­¾åæµç¨‹çš„æ—¶å€™é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯Android æºç çš„ç¼–è¯‘æ˜¯å¤šçº¿ç¨‹çš„ï¼Œä¸€èˆ¬CPU æ ¸å¿ƒè¶Šå¤šï¼Œçº¿ç¨‹è¶Šå¤šã€‚å¯èƒ½åœ¨ç¼–è¯‘apkçš„æ—¶å€™ï¼Œä¼šæœ‰å¤šä¸ªåº”ç”¨å»åŒæ—¶ç­¾åï¼Œè€ŒåŠ å¯†ç‹—æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„ç­¾åç³»ç»Ÿã€‚è¿™é‡Œå°±ä¼šé‡åˆ°å†²çªé—®é¢˜ã€‚ ç›®å‰é‡‡å–çš„æ–¹æ¡ˆï¼Œå°±æ˜¯å¯åŠ¨ä¸€ä¸ªç­¾åæœåŠ¡ï¼Œç”¨æ¥æä¾›ç­¾åå·¥ä½œï¼Œä¼ å…¥ç­¾åæ–‡ä»¶ï¼Œå’Œç­¾åç§˜é’¥åˆ«åã€‚æŠŠè¿™äº›éœ€æ±‚åŠ å…¥é˜Ÿåˆ—ä¸­ï¼ŒæŒ‰ç…§é¡ºåºå»ç­¾åã€‚è¿™æ ·å°±ä¸ä¼šæœ‰å†²çªé—®é¢˜ã€‚ ç­¾åæœåŠ¡ä¸Šä¼ äº†æºç ï¼Œåœ¨é¡¹ç›®è·¯å¾„ï¼š build/soong/cmd/hsm_signer APKçš„ç­¾åå·¥ä½œ hsm ä¸Šæ”¯æŒé€šè¿‡apksigner è¿›è¡Œ PKCS11 çš„ç­¾åï¼Œå…·ä½“å‘½ä»¤å¦‚ä¸‹ï¼Œé‡Œé¢åŒ…å«äº†åŠ å¯†ç‹—çš„ serial noï¼Œè¿˜æœ‰å¯†ç ã€‚ #!/bin/sh sudo YUBIHSM_PKCS11_CONF=simt_connector.conf \\ /home/kailoma/Android/Sdk/build-tools/31.0.0/apksigner sign \\ --provider-class sun.security.pkcs11.SunPKCS11 \\ --provider-arg simt_yubihsm.conf \\ --ks NONE \\ --ks-pass pass:5147bb4dc2069b1094a80b0311a91afd72f8 \\ --ks-type pkcs11 \\ --ks-key-alias \\ --min-sdk-version 17 \\ --max-sdk-version 30 \\ --v1-signing-enabled true \\ --v2-signing-enabled true \\ -v \\ -out -signed.apk \\ -in .apk; è¿™éƒ¨åˆ†å®ç°æ˜¯åœ¨åŠ å¯†æœåŠ¡é‡Œé¢ï¼Œé€šå¸¸AOSP ç¼–è¯‘æ˜¯é€šè¿‡è°ƒç”¨åŠ å¯†æœåŠ¡æ¥å®ç°çš„ï¼š curl -d \"key_alias=platform\u0026apk_unsigned_path=/home/builder/huangwentao/temp/CIT.apk\u0026apk_signed_path=/home/builder/huangwentao/temp/CIT_PLATFORM.apk\" http://localhost:8886/hsm_apk_sign è¿™ä¸ªä¾‹å­é‡Œé¢å°±æ˜¯ï¼šè®¿é—®äº† localhost 8886 ç«¯å£çš„ hsm_apk_signæœåŠ¡ ç„¶ååœ¨æºç  SignApk.java é‡Œé¢ï¼š ProcessBuilder processBuilder = new ProcessBuilder(); processBuilder.command(\"bash\", \"-c\", \"curl -d \\\"key_alias=\" + keyAlias + \"\u0026apk_unsigned_path=\" + unsignedApkPath + \"\u0026apk_signed_path=\" + signedApkPath + \"\\\" http://localhost:8886/hsm_apk_sign\"); try { Process process = processBuilder.start(); StringBuilder output = new StringBuilder(); BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream())); String line; while ((line = reader.readLine()) != null) { output.append(line + \"\\n\"); } otaåŒ…çš„ç­¾åå·¥ä½œ é‡‡ç”¨å®˜ç½‘æç¤ºè¿›è¡Œç­¾å otaåŒ…çš„ç­¾åå·¥ä½œï¼Œä¸æ˜¯è°ƒç”¨apksigner HSMå®˜ç½‘çš„è¯´æ˜é‡Œé¢ï¼Œpkcs11å¯ä»¥é‡‡ç”¨pkcs11-tool export YUBIHSM_PKCS11_CONF=~/huangwentao/qcm6490-archer-IS-00034-dev-r/build/soong/cmd/hsm_signer/conf/yubihsm_connector.conf #-m SHA256-RSA-PKCS /usr/bin/pkcs11-tool --module /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so --login -p 5147bb4dc2069b1094a80b0311a91afd72f8 --sign --id 0032 -i sig.bin -o signed-new.bin otaçš„ç­¾åé‡Œé¢çš„sig.bin å°±æ˜¯é’ˆå¯¹payload.binè¿›è¡Œçš„sha256 hashå€¼ã€‚æ‰€ä»¥åœ¨ç­¾åçš„æ—¶å€™ï¼Œä¸ç”¨å†åŠ -m SHA256-RSA-PKCSï¼Œå¦åˆ™éªŒç­¾ä¼šå‡ºé”™ã€‚ ç¼–è¯‘æ•´åŒ…çš„æ—¶å€™ï¼Œä¼šæœ‰sig.bin ä»¥åŠç­¾åæ–‡ä»¶sig_signed.bin å‡ºæ¥ã€‚æˆ‘ä»¬é€šè¿‡ od -tx1 æ¥æŸ¥çœ‹äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ sig.bin äºŒè¿›åˆ¶ï¼š builder@builder:~/huangwentao/buildtemp/after$ cat sig.bin |od -tx1 0000000 05 ef dd 77 4f 7f 1d 11 59 cc fc dd 9d c7 25 be 0000020 2a a9 16 5b 5d 9a dd 32 5b 46 c6 f1 93 16 f0 8f 0000040 sig.bin hash256åçš„äºŒè¿›åˆ¶ï¼š builder@builder:~/huangwentao/buildtemp/after$ openssl sha256 -binary sig.bin |od -tx1 0000000 20 c3 0a eb ac 21 1f 23 11 a4 8e dd 66 6e ae 1f 0000020 fc b5 72 fd 3f f8 15 09 e1 71 41 1d fb 21 93 e8 0000040 ç­¾åæ·»åŠ  sha256åçš„ç­¾åÂ /usr/bin/pkcs11-tool â€“module /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so â€“login -p 5147bb4dc2069b1094a80b0311a91afd72f8 â€“signÂ â€“id 0032Â -m SHA256-RSA-PKCS -i sig.bin -o sig_signed256.bin ç„¶åé€šè¿‡å…¬é’¥å»è§£ç ï¼Œå‘ç°å’Œsig.binÂ hash 256çš„æ˜¯ä¸€è‡´çš„ã€‚ builder@builder:~/huangwentao/buildtemp/after$ openssl rsautl -verify -pubin -inkey key-pub.key -in sig_signed256.bin |od -tx1 0000000 30 31 30 0d 06 09 60 86 48 01 65 03 04 02 01 05 0000020 00 04 20 20 c3 0a eb ac 21 1f 23 11 a4 8e dd 66 0000040 6e ae 1f fc b5 72 fd 3f f8 15 09 e1 71 41 1d fb 0000060 21 93 e8 åœ¨main å‡½æ•°é‡Œé¢æ·»åŠ å‚æ•°ï¼Œé‡‡ç”¨ pkcs11-tool å»ç­¾å @@ -1200,6 +1212,21 @@ def GenerateAbOtaPackage(target_file, output_file, source_file=None): def main(argv): + #ArcherIs code for yubihsm by 00169 at 20230423 begin + if os.path.exists(\"./.build_with_yubihsm\") : + #wentao + cmd = [\"pwd\"] + common.RunAndCheckOutput(cmd) + print(\"hsm py version 002 yubihsm exist ,use yubihsm build tools pkcs11-tool instend \") + print(\"yubihsm before argv :\",argv) + argv.insert(0, '-v') + argv.insert(1, '--payload_signer') + argv.insert(2, '/usr/bin/pkcs11-tool') + #argv.insert(3, '--payload_sign","date":"2024-11-06","objectID":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/:0:2","tags":["blog","å®æˆ˜"],"title":"Archer\u0026ArcherIS APç­¾åæ–¹æ¡ˆæ€»ç»“","uri":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/#apkçš„ç­¾åå·¥ä½œ"},{"categories":"Android","collections":null,"content":"ç­¾åæ–¹æ¡ˆ å…³äºHSMçš„ç­¾åæ–¹æ¡ˆï¼Œæ¦‚è¦çš„è¯´å°±æ˜¯åŸæ¥æ”¾åœ¨build/security/ ä¸‹é¢çš„ ç§é’¥å’Œè¯ä¹¦å¯¹ã€‚ å®¢æˆ·ç”±äºå®‰å…¨çš„å› ç´ ï¼Œä¸å¤–å‘ç›¸å…³çš„ç§é’¥ã€‚ é‚£ä¹ˆç§é’¥é€šè¿‡å†™å…¥ HSM è¿™ç§åŠ å¯†Uç›˜(åŠ å¯†ç‹—)ï¼Œé€šè¿‡ç§é’¥å»ç­¾åçš„å·¥ä½œï¼Œå°±äº¤ç»™äº†åŠ å¯†Uç›˜æ¥å¤„ç†äº†ã€‚ é‚£ä¹ˆåœ¨æºç ç¼–è¯‘è¿‡ç¨‹ä¸­ä½¿ç”¨äº† build/security/ ä¸‹é¢keyçš„å·¥ä½œæœ‰ä»¥ä¸‹å‡ ç‚¹ï¼ˆCPç«¯çš„é•œåƒç­¾åæ²¡æœ‰é‡‡ç”¨é‡Œé¢çš„keyï¼Œæœ‰é¢å¤–çš„keyï¼Œåœ¨è¿™é‡Œä¸è®¨è®ºï¼‰ APKçš„ç­¾åå·¥ä½œ otaåŒ…çš„ç­¾åå·¥ä½œ è¿‡å¾€æ–¹æ¡ˆé€‰æ‹©è¯´æ˜ é‚£ä¹ˆè¦åšçš„å·¥ä½œå°±æ˜¯æŠŠä¸Šé¢çš„ä¸¤ä¸ªç­¾åæµç¨‹ï¼Œä»æœ¬åœ°ç­¾åä¿®æ”¹åˆ°é€šè¿‡åŠ å¯†ç‹—å»ç­¾åã€‚ é‚£ä¹ˆä¹‹å‰çš„å·¥ç¨‹å¸ˆåœ¨ä¿®æ”¹ç­¾åæµç¨‹çš„æ—¶å€™é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯Android æºç çš„ç¼–è¯‘æ˜¯å¤šçº¿ç¨‹çš„ï¼Œä¸€èˆ¬CPU æ ¸å¿ƒè¶Šå¤šï¼Œçº¿ç¨‹è¶Šå¤šã€‚å¯èƒ½åœ¨ç¼–è¯‘apkçš„æ—¶å€™ï¼Œä¼šæœ‰å¤šä¸ªåº”ç”¨å»åŒæ—¶ç­¾åï¼Œè€ŒåŠ å¯†ç‹—æ˜¯ä¸€ä¸ªå•çº¿ç¨‹çš„ç­¾åç³»ç»Ÿã€‚è¿™é‡Œå°±ä¼šé‡åˆ°å†²çªé—®é¢˜ã€‚ ç›®å‰é‡‡å–çš„æ–¹æ¡ˆï¼Œå°±æ˜¯å¯åŠ¨ä¸€ä¸ªç­¾åæœåŠ¡ï¼Œç”¨æ¥æä¾›ç­¾åå·¥ä½œï¼Œä¼ å…¥ç­¾åæ–‡ä»¶ï¼Œå’Œç­¾åç§˜é’¥åˆ«åã€‚æŠŠè¿™äº›éœ€æ±‚åŠ å…¥é˜Ÿåˆ—ä¸­ï¼ŒæŒ‰ç…§é¡ºåºå»ç­¾åã€‚è¿™æ ·å°±ä¸ä¼šæœ‰å†²çªé—®é¢˜ã€‚ ç­¾åæœåŠ¡ä¸Šä¼ äº†æºç ï¼Œåœ¨é¡¹ç›®è·¯å¾„ï¼š build/soong/cmd/hsm_signer APKçš„ç­¾åå·¥ä½œ hsm ä¸Šæ”¯æŒé€šè¿‡apksigner è¿›è¡Œ PKCS11 çš„ç­¾åï¼Œå…·ä½“å‘½ä»¤å¦‚ä¸‹ï¼Œé‡Œé¢åŒ…å«äº†åŠ å¯†ç‹—çš„ serial noï¼Œè¿˜æœ‰å¯†ç ã€‚ #!/bin/sh sudo YUBIHSM_PKCS11_CONF=simt_connector.conf \\ /home/kailoma/Android/Sdk/build-tools/31.0.0/apksigner sign \\ --provider-class sun.security.pkcs11.SunPKCS11 \\ --provider-arg simt_yubihsm.conf \\ --ks NONE \\ --ks-pass pass:5147bb4dc2069b1094a80b0311a91afd72f8 \\ --ks-type pkcs11 \\ --ks-key-alias \\ --min-sdk-version 17 \\ --max-sdk-version 30 \\ --v1-signing-enabled true \\ --v2-signing-enabled true \\ -v \\ -out -signed.apk \\ -in .apk; è¿™éƒ¨åˆ†å®ç°æ˜¯åœ¨åŠ å¯†æœåŠ¡é‡Œé¢ï¼Œé€šå¸¸AOSP ç¼–è¯‘æ˜¯é€šè¿‡è°ƒç”¨åŠ å¯†æœåŠ¡æ¥å®ç°çš„ï¼š curl -d \"key_alias=platform\u0026apk_unsigned_path=/home/builder/huangwentao/temp/CIT.apk\u0026apk_signed_path=/home/builder/huangwentao/temp/CIT_PLATFORM.apk\" http://localhost:8886/hsm_apk_sign è¿™ä¸ªä¾‹å­é‡Œé¢å°±æ˜¯ï¼šè®¿é—®äº† localhost 8886 ç«¯å£çš„ hsm_apk_signæœåŠ¡ ç„¶ååœ¨æºç  SignApk.java é‡Œé¢ï¼š ProcessBuilder processBuilder = new ProcessBuilder(); processBuilder.command(\"bash\", \"-c\", \"curl -d \\\"key_alias=\" + keyAlias + \"\u0026apk_unsigned_path=\" + unsignedApkPath + \"\u0026apk_signed_path=\" + signedApkPath + \"\\\" http://localhost:8886/hsm_apk_sign\"); try { Process process = processBuilder.start(); StringBuilder output = new StringBuilder(); BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream())); String line; while ((line = reader.readLine()) != null) { output.append(line + \"\\n\"); } otaåŒ…çš„ç­¾åå·¥ä½œ é‡‡ç”¨å®˜ç½‘æç¤ºè¿›è¡Œç­¾å otaåŒ…çš„ç­¾åå·¥ä½œï¼Œä¸æ˜¯è°ƒç”¨apksigner HSMå®˜ç½‘çš„è¯´æ˜é‡Œé¢ï¼Œpkcs11å¯ä»¥é‡‡ç”¨pkcs11-tool export YUBIHSM_PKCS11_CONF=~/huangwentao/qcm6490-archer-IS-00034-dev-r/build/soong/cmd/hsm_signer/conf/yubihsm_connector.conf #-m SHA256-RSA-PKCS /usr/bin/pkcs11-tool --module /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so --login -p 5147bb4dc2069b1094a80b0311a91afd72f8 --sign --id 0032 -i sig.bin -o signed-new.bin otaçš„ç­¾åé‡Œé¢çš„sig.bin å°±æ˜¯é’ˆå¯¹payload.binè¿›è¡Œçš„sha256 hashå€¼ã€‚æ‰€ä»¥åœ¨ç­¾åçš„æ—¶å€™ï¼Œä¸ç”¨å†åŠ -m SHA256-RSA-PKCSï¼Œå¦åˆ™éªŒç­¾ä¼šå‡ºé”™ã€‚ ç¼–è¯‘æ•´åŒ…çš„æ—¶å€™ï¼Œä¼šæœ‰sig.bin ä»¥åŠç­¾åæ–‡ä»¶sig_signed.bin å‡ºæ¥ã€‚æˆ‘ä»¬é€šè¿‡ od -tx1 æ¥æŸ¥çœ‹äºŒè¿›åˆ¶æ–‡ä»¶ã€‚ sig.bin äºŒè¿›åˆ¶ï¼š builder@builder:~/huangwentao/buildtemp/after$ cat sig.bin |od -tx1 0000000 05 ef dd 77 4f 7f 1d 11 59 cc fc dd 9d c7 25 be 0000020 2a a9 16 5b 5d 9a dd 32 5b 46 c6 f1 93 16 f0 8f 0000040 sig.bin hash256åçš„äºŒè¿›åˆ¶ï¼š builder@builder:~/huangwentao/buildtemp/after$ openssl sha256 -binary sig.bin |od -tx1 0000000 20 c3 0a eb ac 21 1f 23 11 a4 8e dd 66 6e ae 1f 0000020 fc b5 72 fd 3f f8 15 09 e1 71 41 1d fb 21 93 e8 0000040 ç­¾åæ·»åŠ  sha256åçš„ç­¾åÂ /usr/bin/pkcs11-tool â€“module /usr/lib/x86_64-linux-gnu/pkcs11/yubihsm_pkcs11.so â€“login -p 5147bb4dc2069b1094a80b0311a91afd72f8 â€“signÂ â€“id 0032Â -m SHA256-RSA-PKCS -i sig.bin -o sig_signed256.bin ç„¶åé€šè¿‡å…¬é’¥å»è§£ç ï¼Œå‘ç°å’Œsig.binÂ hash 256çš„æ˜¯ä¸€è‡´çš„ã€‚ builder@builder:~/huangwentao/buildtemp/after$ openssl rsautl -verify -pubin -inkey key-pub.key -in sig_signed256.bin |od -tx1 0000000 30 31 30 0d 06 09 60 86 48 01 65 03 04 02 01 05 0000020 00 04 20 20 c3 0a eb ac 21 1f 23 11 a4 8e dd 66 0000040 6e ae 1f fc b5 72 fd 3f f8 15 09 e1 71 41 1d fb 0000060 21 93 e8 åœ¨main å‡½æ•°é‡Œé¢æ·»åŠ å‚æ•°ï¼Œé‡‡ç”¨ pkcs11-tool å»ç­¾å @@ -1200,6 +1212,21 @@ def GenerateAbOtaPackage(target_file, output_file, source_file=None): def main(argv): + #ArcherIs code for yubihsm by 00169 at 20230423 begin + if os.path.exists(\"./.build_with_yubihsm\") : + #wentao + cmd = [\"pwd\"] + common.RunAndCheckOutput(cmd) + print(\"hsm py version 002 yubihsm exist ,use yubihsm build tools pkcs11-tool instend \") + print(\"yubihsm before argv :\",argv) + argv.insert(0, '-v') + argv.insert(1, '--payload_signer') + argv.insert(2, '/usr/bin/pkcs11-tool') + #argv.insert(3, '--payload_sign","date":"2024-11-06","objectID":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/:0:2","tags":["blog","å®æˆ˜"],"title":"Archer\u0026ArcherIS APç­¾åæ–¹æ¡ˆæ€»ç»“","uri":"/posts/archerarcheris-ap%E7%AD%BE%E5%90%8D%E6%96%B9%E6%A1%88%E6%80%BB%E7%BB%93/#otaåŒ…çš„ç­¾åå·¥ä½œ-é‡‡ç”¨å®˜ç½‘æç¤ºè¿›è¡Œç­¾å"},{"categories":"ubuntu","collections":null,"content":"#obsidian style: nestedList # TOC style (nestedList|inlineFirstLevel) maxLevel: 0 # Include headings up to the speficied level includeLinks: true # Make headings clickable debugInConsole: false # Print debug info in Obsidian console ","date":"2024-11-06","objectID":"/posts/dataview-%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/:0:0","tags":["obsidian","blog"],"title":"dataview ä½¿ç”¨æŠ€å·§","uri":"/posts/dataview-%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/#"},{"categories":"ubuntu","collections":null,"content":"dateview å¯ä»¥ç”¨æ¥ç”Ÿæˆç›®å½• èŠ‚é€‰ï¼šå¿«é€Ÿèšåˆ Obsidian ç¬”è®°ï¼Œè¯•è¯•ç”¨ Dataview ç”Ÿæˆç›®å½• ä»¥ä¸‹æ˜¯ä¸€äº›åœºæ™¯ï¼š ç”ŸæˆåŒ…å«åŒæ ·å…³é”®å­—çš„ç¬”è®°çš„ç›®å½• ç”ŸæˆåŒä¸€ä¸ªæ ‡ç­¾çš„ç¬”è®°çš„ç›®å½• ç”ŸæˆåŒä¸€ä¸ªä½œè€…çš„ä¹¦ç›®çš„ç›®å½• è¿™æ—¶å€™ï¼ŒDataview å°±æ´¾ä¸Šç”¨åœºäº†ã€‚ Dataview å¯ä»¥ç”Ÿæˆ MOCï¼Œæˆ–è€…ä½ ä¹Ÿå¯ä»¥è·Ÿæˆ‘ä¸€æ ·ï¼Œä¸å»ç®¡ MOC æ˜¯ä»€ä¹ˆï¼Œå°±æŠŠå®ƒå½“ä½œä¸€ä¸ªç›®å½•ã€‚ æˆ‘ä»¬çŸ¥é“ï¼Œç›®å½•æ˜¯ä¸€ç¯‡æ–‡ç« çš„æ¦‚è§ˆã€‚Dataview å…¶å®ç”Ÿæˆäº†ä½ çš„å¤šç¯‡æ–‡ç« ç›®å½•ã€‚ å¦‚æœä½ æœ‰è¿™ç§éœ€è¦çš„è¯ï¼Œå°±æ¥ç€çœ‹ä¸‹å»å§ã€‚ å®‰è£…æ’ä»¶ ä»æ–‡ä»¶å åœºæ™¯ï¼šå‡è®¾ï¼Œç°åœ¨ä½ æœ‰å¤šç¯‡å…³äºã€ä¹ æƒ¯ã€‘çš„ç¬”è®°ï¼Œå¹¶ä¸”è¿™äº›ç¬”è®°çš„åç§°ä¸­éƒ½æœ‰ ã€Œä¹ æƒ¯ã€ ä¸¤ä¸ªå­—ã€‚è®°å½•äº†å¥½å‡ ä¸ªä¹ æƒ¯å…»æˆçš„æ–¹æ³•ï¼Œä»Šå¤©ä½ å¿½ç„¶æ„è¯†åˆ°ï¼Œå…³äºä¹ æƒ¯çš„æ–¹æ³•è®ºå·²ç»çœ‹äº†å¥½å‡ ä¸ªäº†ï¼Œæƒ³æŠŠå®ƒä»¬åˆ—å‡ºæ¥æ”¾åˆ°ä¸€èµ·çœ‹çœ‹èƒ½ä¸èƒ½äº§ç”Ÿä»€ä¹ˆåŒ–å­¦æ•ˆæœã€‚ è€è§„çŸ©ï¼Œå…ˆè´´ä¸€ä¸ªè¯­æ³•å’Œæ•ˆæœå›¾ï¼š list from \"å·¥å…·\" where contains(file.name,\"Dataview\") sort file.ctime listï¼šä½ åˆ›å»ºäº†ä¸€ä¸ªåˆ—è¡¨ / æ¸…å•ã€‚ fromï¼šç•™ç©ºå°±æ˜¯ä¸ç­›é€‰æ–‡ä»¶å¤¹å’Œæ ‡ç­¾ï¼Œä»æ‰€æœ‰ç¬”è®°æ–‡ä»¶å»æ‰¾ã€‚ where æ¡ä»¶ï¼šåŒ¹é…ï¼ˆcontainsï¼‰äº†æ–‡ä»¶åï¼ˆfile.nameï¼‰ä¸­åŒ…å«ã€Œä¹ æƒ¯ã€ä¸¤ä¸ªå­—çš„ç¬”è®° å¦‚æœä½ éœ€è¦æ’åºï¼Œå°±å†™ sortï¼Œä¸éœ€è¦ï¼Œç•™ç©ºå°±å¯ä»¥ã€‚ Dataview ä½¿ç”¨ yml çš„å…ƒç´  where å’Œ sort å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ä½ åœ¨ yml ä¸­è®¾ç½®çš„ key äº†ã€‚çœ‹çœ‹ä¸‹é¢çš„å†™æ³•ï¼š ä¸Šé¢ä¾æ¬¡æ˜¯ï¼šåŒ…å«ä½œè€…ä¸ºã€Œé²è¿…ã€çš„åŸç¬”è®°ã€èšåˆä½œè€…ä¸ºã€Œé²è¿…ã€çš„ç›®å½•ç¼–è¾‘æ¨¡å¼ã€èšåˆä½œè€…ä¸ºã€Œé²è¿…ã€çš„ç›®å½•é¢„è§ˆæ¨¡å¼ã€‚ å—¯å“¼ï¼Œé²è¿…åˆé›†å°±åšå¥½äº†ã€‚ æ‰©å±•ï¼šåˆ›å»ºä¸€ä¸ªä¹¦ç›®åˆ—è¡¨å§ï¼ ä¸Šé¢ä½ å·²ç»å­¦ä¼šäº†é™åˆ¶æ£€ç´¢èŒƒå›´ã€æ¨¡ç³Šæœç´¢æ–‡ä»¶åæ¥åˆ›å»ºåˆ—è¡¨ï¼Œå­¦ä¼šäº†ä»æ ‡ç­¾åˆ›å»ºåˆ—è¡¨ï¼Œè¿˜å­¦ä¼šäº†ç”¨ yml å®šä¹‰çš„ key å½“ä½œå­—æ®µåšæ¡ä»¶ï¼ŒåŸºæœ¬çš„æ£€ç´¢è¯­æ³•ä½ å·²ç»å­¦ä¼šå•¦ã€‚ ç°åœ¨æˆ‘ä»¬æƒ³åœ¨å±•ç¤ºå½¢å¼ä¸Šæœ‰æ‰€æ”¹å˜ï¼Œæ¯”å¦‚ä¹¦ç›®åˆ—è¡¨ã€‚æˆ‘ä¸æƒ³åªå±•ç¤ºä½œå“çš„åå­—ï¼Œæˆ‘è¿˜æƒ³å±•ç¤ºä½œè€…ã€é˜…è¯»æ—¥æœŸã€æ ‡ç­¾ã€‚ è¿˜è®°å¾—ä¸Šé¢åˆ—è¡¨ä¸­çš„å±•ç¤ºå½¢å¼å—ï¼Ÿ å¯¹ï¼Œå°±æ˜¯ Dataview è¯­æ³•çš„ç¬¬ä¸€è¡Œé‚£ä¸ª ï¼Œç°åœ¨æˆ‘ä»¬æ¥å˜ä¸€ä¸‹ï¼Œå†™ä¸ª å§ã€‚ ä¸è¿‡æˆ‘ä»¬çš„è¯­æ³•æœ‰ä¸€ç‚¹å°å°çš„æ”¹åŠ¨ã€‚æ—¢ç„¶æ˜¯ tableï¼Œé‚£ä¹ˆåˆ—åå°±å¿…ä¸å¯å°‘ã€‚ å…ˆè´´ä¸€ä¸‹ä»£ç çœ‹çœ‹å§: ","date":"2024-11-06","objectID":"/posts/dataview-%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/:0:1","tags":["obsidian","blog"],"title":"dataview ä½¿ç”¨æŠ€å·§","uri":"/posts/dataview-%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/#dateview-å¯ä»¥ç”¨æ¥ç”Ÿæˆç›®å½•"},{"categories":"ubuntu","collections":null,"content":"dateview å¯ä»¥ç”¨æ¥ç”Ÿæˆç›®å½• èŠ‚é€‰ï¼šå¿«é€Ÿèšåˆ Obsidian ç¬”è®°ï¼Œè¯•è¯•ç”¨ Dataview ç”Ÿæˆç›®å½• ä»¥ä¸‹æ˜¯ä¸€äº›åœºæ™¯ï¼š ç”ŸæˆåŒ…å«åŒæ ·å…³é”®å­—çš„ç¬”è®°çš„ç›®å½• ç”ŸæˆåŒä¸€ä¸ªæ ‡ç­¾çš„ç¬”è®°çš„ç›®å½• ç”ŸæˆåŒä¸€ä¸ªä½œè€…çš„ä¹¦ç›®çš„ç›®å½• è¿™æ—¶å€™ï¼ŒDataview å°±æ´¾ä¸Šç”¨åœºäº†ã€‚ Dataview å¯ä»¥ç”Ÿæˆ MOCï¼Œæˆ–è€…ä½ ä¹Ÿå¯ä»¥è·Ÿæˆ‘ä¸€æ ·ï¼Œä¸å»ç®¡ MOC æ˜¯ä»€ä¹ˆï¼Œå°±æŠŠå®ƒå½“ä½œä¸€ä¸ªç›®å½•ã€‚ æˆ‘ä»¬çŸ¥é“ï¼Œç›®å½•æ˜¯ä¸€ç¯‡æ–‡ç« çš„æ¦‚è§ˆã€‚Dataview å…¶å®ç”Ÿæˆäº†ä½ çš„å¤šç¯‡æ–‡ç« ç›®å½•ã€‚ å¦‚æœä½ æœ‰è¿™ç§éœ€è¦çš„è¯ï¼Œå°±æ¥ç€çœ‹ä¸‹å»å§ã€‚ å®‰è£…æ’ä»¶ ä»æ–‡ä»¶å åœºæ™¯ï¼šå‡è®¾ï¼Œç°åœ¨ä½ æœ‰å¤šç¯‡å…³äºã€ä¹ æƒ¯ã€‘çš„ç¬”è®°ï¼Œå¹¶ä¸”è¿™äº›ç¬”è®°çš„åç§°ä¸­éƒ½æœ‰ ã€Œä¹ æƒ¯ã€ ä¸¤ä¸ªå­—ã€‚è®°å½•äº†å¥½å‡ ä¸ªä¹ æƒ¯å…»æˆçš„æ–¹æ³•ï¼Œä»Šå¤©ä½ å¿½ç„¶æ„è¯†åˆ°ï¼Œå…³äºä¹ æƒ¯çš„æ–¹æ³•è®ºå·²ç»çœ‹äº†å¥½å‡ ä¸ªäº†ï¼Œæƒ³æŠŠå®ƒä»¬åˆ—å‡ºæ¥æ”¾åˆ°ä¸€èµ·çœ‹çœ‹èƒ½ä¸èƒ½äº§ç”Ÿä»€ä¹ˆåŒ–å­¦æ•ˆæœã€‚ è€è§„çŸ©ï¼Œå…ˆè´´ä¸€ä¸ªè¯­æ³•å’Œæ•ˆæœå›¾ï¼š list from \"å·¥å…·\" where contains(file.name,\"Dataview\") sort file.ctime listï¼šä½ åˆ›å»ºäº†ä¸€ä¸ªåˆ—è¡¨ / æ¸…å•ã€‚ fromï¼šç•™ç©ºå°±æ˜¯ä¸ç­›é€‰æ–‡ä»¶å¤¹å’Œæ ‡ç­¾ï¼Œä»æ‰€æœ‰ç¬”è®°æ–‡ä»¶å»æ‰¾ã€‚ where æ¡ä»¶ï¼šåŒ¹é…ï¼ˆcontainsï¼‰äº†æ–‡ä»¶åï¼ˆfile.nameï¼‰ä¸­åŒ…å«ã€Œä¹ æƒ¯ã€ä¸¤ä¸ªå­—çš„ç¬”è®° å¦‚æœä½ éœ€è¦æ’åºï¼Œå°±å†™ sortï¼Œä¸éœ€è¦ï¼Œç•™ç©ºå°±å¯ä»¥ã€‚ Dataview ä½¿ç”¨ yml çš„å…ƒç´  where å’Œ sort å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ä½ åœ¨ yml ä¸­è®¾ç½®çš„ key äº†ã€‚çœ‹çœ‹ä¸‹é¢çš„å†™æ³•ï¼š ä¸Šé¢ä¾æ¬¡æ˜¯ï¼šåŒ…å«ä½œè€…ä¸ºã€Œé²è¿…ã€çš„åŸç¬”è®°ã€èšåˆä½œè€…ä¸ºã€Œé²è¿…ã€çš„ç›®å½•ç¼–è¾‘æ¨¡å¼ã€èšåˆä½œè€…ä¸ºã€Œé²è¿…ã€çš„ç›®å½•é¢„è§ˆæ¨¡å¼ã€‚ å—¯å“¼ï¼Œé²è¿…åˆé›†å°±åšå¥½äº†ã€‚ æ‰©å±•ï¼šåˆ›å»ºä¸€ä¸ªä¹¦ç›®åˆ—è¡¨å§ï¼ ä¸Šé¢ä½ å·²ç»å­¦ä¼šäº†é™åˆ¶æ£€ç´¢èŒƒå›´ã€æ¨¡ç³Šæœç´¢æ–‡ä»¶åæ¥åˆ›å»ºåˆ—è¡¨ï¼Œå­¦ä¼šäº†ä»æ ‡ç­¾åˆ›å»ºåˆ—è¡¨ï¼Œè¿˜å­¦ä¼šäº†ç”¨ yml å®šä¹‰çš„ key å½“ä½œå­—æ®µåšæ¡ä»¶ï¼ŒåŸºæœ¬çš„æ£€ç´¢è¯­æ³•ä½ å·²ç»å­¦ä¼šå•¦ã€‚ ç°åœ¨æˆ‘ä»¬æƒ³åœ¨å±•ç¤ºå½¢å¼ä¸Šæœ‰æ‰€æ”¹å˜ï¼Œæ¯”å¦‚ä¹¦ç›®åˆ—è¡¨ã€‚æˆ‘ä¸æƒ³åªå±•ç¤ºä½œå“çš„åå­—ï¼Œæˆ‘è¿˜æƒ³å±•ç¤ºä½œè€…ã€é˜…è¯»æ—¥æœŸã€æ ‡ç­¾ã€‚ è¿˜è®°å¾—ä¸Šé¢åˆ—è¡¨ä¸­çš„å±•ç¤ºå½¢å¼å—ï¼Ÿ å¯¹ï¼Œå°±æ˜¯ Dataview è¯­æ³•çš„ç¬¬ä¸€è¡Œé‚£ä¸ª ï¼Œç°åœ¨æˆ‘ä»¬æ¥å˜ä¸€ä¸‹ï¼Œå†™ä¸ª å§ã€‚ ä¸è¿‡æˆ‘ä»¬çš„è¯­æ³•æœ‰ä¸€ç‚¹å°å°çš„æ”¹åŠ¨ã€‚æ—¢ç„¶æ˜¯ tableï¼Œé‚£ä¹ˆåˆ—åå°±å¿…ä¸å¯å°‘ã€‚ å…ˆè´´ä¸€ä¸‹ä»£ç çœ‹çœ‹å§: ","date":"2024-11-06","objectID":"/posts/dataview-%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/:0:1","tags":["obsidian","blog"],"title":"dataview ä½¿ç”¨æŠ€å·§","uri":"/posts/dataview-%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/#ä»æ–‡ä»¶å"},{"categories":null,"collections":"å·¥å…·","content":"1. Perfetto æ˜¯ä»€ä¹ˆï¼Ÿ Perfetto æ˜¯ google ä» Android10 å¼€å§‹å¼•å…¥çš„ä¸€ä¸ªå…¨æ–°çš„å¹³å°çº§è·Ÿè¸ªåˆ†æå·¥å…·ã€‚å®ƒå¯ä»¥è®°å½• Android ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­çš„å…³é”®æ•°æ®ï¼Œå¹¶é€šè¿‡å›¾å½¢åŒ–çš„å½¢å¼å±•ç¤ºè¿™äº›æ•°æ®ã€‚Perfetto ä¸ä»…å¯ç”¨äºç³»ç»Ÿçº§çš„æ€§èƒ½åˆ†æï¼Œä¹Ÿæ˜¯æˆ‘ä»¬å­¦ä¹ ç³»ç»Ÿæºç æµç¨‹çš„å¥½å¸®æ‰‹ã€‚ Perfetto ç®—æ˜¯Systraceçš„å‡çº§ç‰ˆæœ¬ï¼Œå¯ä»¥ç›´è§‚çš„çœ‹åˆ°è·¨è¿›ç¨‹çš„è°ƒç”¨æ–¹å¼ã€‚ ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:1:0","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#1-perfetto-æ˜¯ä»€ä¹ˆ"},{"categories":null,"collections":"å·¥å…·","content":"2. å¦‚ä½•æŠ“å– Trace ä½¿ç”¨ Perfetto ä¸€èˆ¬åˆ†ä¸¤æ­¥è¿›è¡Œï¼š æ”¶é›†æ‰‹æœºè¿è¡Œè¿‡ç¨‹ä¸­çš„ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯é€šå¸¸ç§°ä¹‹ä¸º Traceï¼Œæ”¶é›†çš„è¿‡ç¨‹ç§°ä¹‹ä¸ºæŠ“å– Traceã€‚ ä½¿ç”¨ Perfetto æ‰“å¼€ Traceï¼Œåˆ†æ Trace æœ¬èŠ‚ä»‹ç»å¦‚ä½•æŠ“å– Trace ã€‚ ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:2:0","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#2-å¦‚ä½•æŠ“å–-trace"},{"categories":null,"collections":"å·¥å…·","content":"2.1 ä½¿ç”¨å‘½ä»¤è¡ŒæŠ“å– Trace 2.1.1 ä½¿ç”¨ perfetto å‘½ä»¤æŠ“å– é¦–å…ˆä½¿ç”¨ usb çº¿å°†ç”µè„‘å’Œæ‰‹æœºè¿æ¥ï¼Œç¡®ä¿ adb shell å‘½ä»¤èƒ½æ­£å¸¸å·¥ä½œã€‚ æ¥ç€æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š adbÂ shellÂ perfettoÂ -oÂ /data/misc/perfetto-traces/trace_file.perfetto-traceÂ tÂ 20sÂ \\Â schedÂ freqÂ idleÂ amÂ wmÂ gfxÂ viewÂ binder_driverÂ halÂ dalvikÂ cameraÂ inputÂ resÂ memory è¿™ä¸ªå‘½ä»¤ä¼šå¯åŠ¨ä¸€ä¸ª 20 ç§’é’Ÿçš„è·Ÿè¸ªï¼Œæ”¶é›†æŒ‡å®šçš„æ•°æ®æºä¿¡æ¯ï¼Œå¹¶å°†è·Ÿè¸ªæ–‡ä»¶ä¿å­˜åˆ° /data/misc/perfetto-traces/trace_file.perfetto-trace ,æ‰§è¡Œå®Œä¼šåœ¨åå°æ‰§è¡Œã€‚ æœ€åï¼ŒæŠŠ trace æ–‡ä»¶ pull å‡ºæ¥ï¼š adbÂ pullÂ /data/misc/perfetto-traces/trace_file.perfetto-trace æ•´ä¸ªæŠ“å–è¿‡ç¨‹å°±å®Œæˆäº†ã€‚ ä¹Ÿå¯ä»¥åšæˆæ‰‹æœºçš„å†…ç½®çš„åŠŸèƒ½ï¼Œæ‰§è¡Œshellå‘½ä»¤æ¥ç¦»çº¿æŠ“å»traceã€‚ 2.1.2 ä½¿ç”¨ record_android_trace å‘½ä»¤æŠ“å– record_android_trace æ˜¯ Perfetto å›¢é˜Ÿæä¾›çš„ä¸€ä¸ªç®€åŒ–è„šæœ¬ï¼Œä½¿å¾—æˆ‘ä»¬çš„æŠ“å–å·¥ä½œæ›´åŠ ç®€å•ã€‚record_android_trace åœ¨æºç è·¯å¾„ä¸‹é¢ä¹Ÿæœ‰ã€‚ curlÂ -OÂ https://raw.githubusercontent.com/google/perfetto/master/tools/record_android_tracechmodÂ u+xÂ record_android_trace ./record_android_traceÂ -oÂ trace_file.perfetto-traceÂ -tÂ 10sÂ -bÂ 64mbÂ \\Â schedÂ freqÂ idleÂ amÂ wmÂ gfxÂ viewÂ binder_driverÂ halÂ dalvikÂ cameraÂ inputÂ resÂ memory record_android_trace å‘½ä»¤èƒ½è‡ªåŠ¨å¤„ç†å¥½è·¯å¾„ï¼ŒæŠ“å–å®Œæˆåè‡ªåŠ¨æ‰“å¼€ Trace æ–‡ä»¶ã€‚ ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:2:1","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#21-ä½¿ç”¨å‘½ä»¤è¡ŒæŠ“å–-trace"},{"categories":null,"collections":"å·¥å…·","content":"2.1 ä½¿ç”¨å‘½ä»¤è¡ŒæŠ“å– Trace 2.1.1 ä½¿ç”¨ perfetto å‘½ä»¤æŠ“å– é¦–å…ˆä½¿ç”¨ usb çº¿å°†ç”µè„‘å’Œæ‰‹æœºè¿æ¥ï¼Œç¡®ä¿ adb shell å‘½ä»¤èƒ½æ­£å¸¸å·¥ä½œã€‚ æ¥ç€æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š adbÂ shellÂ perfettoÂ -oÂ /data/misc/perfetto-traces/trace_file.perfetto-traceÂ tÂ 20sÂ \\Â schedÂ freqÂ idleÂ amÂ wmÂ gfxÂ viewÂ binder_driverÂ halÂ dalvikÂ cameraÂ inputÂ resÂ memory è¿™ä¸ªå‘½ä»¤ä¼šå¯åŠ¨ä¸€ä¸ª 20 ç§’é’Ÿçš„è·Ÿè¸ªï¼Œæ”¶é›†æŒ‡å®šçš„æ•°æ®æºä¿¡æ¯ï¼Œå¹¶å°†è·Ÿè¸ªæ–‡ä»¶ä¿å­˜åˆ° /data/misc/perfetto-traces/trace_file.perfetto-trace ,æ‰§è¡Œå®Œä¼šåœ¨åå°æ‰§è¡Œã€‚ æœ€åï¼ŒæŠŠ trace æ–‡ä»¶ pull å‡ºæ¥ï¼š adbÂ pullÂ /data/misc/perfetto-traces/trace_file.perfetto-trace æ•´ä¸ªæŠ“å–è¿‡ç¨‹å°±å®Œæˆäº†ã€‚ ä¹Ÿå¯ä»¥åšæˆæ‰‹æœºçš„å†…ç½®çš„åŠŸèƒ½ï¼Œæ‰§è¡Œshellå‘½ä»¤æ¥ç¦»çº¿æŠ“å»traceã€‚ 2.1.2 ä½¿ç”¨ record_android_trace å‘½ä»¤æŠ“å– record_android_trace æ˜¯ Perfetto å›¢é˜Ÿæä¾›çš„ä¸€ä¸ªç®€åŒ–è„šæœ¬ï¼Œä½¿å¾—æˆ‘ä»¬çš„æŠ“å–å·¥ä½œæ›´åŠ ç®€å•ã€‚record_android_trace åœ¨æºç è·¯å¾„ä¸‹é¢ä¹Ÿæœ‰ã€‚ curlÂ -OÂ https://raw.githubusercontent.com/google/perfetto/master/tools/record_android_tracechmodÂ u+xÂ record_android_trace ./record_android_traceÂ -oÂ trace_file.perfetto-traceÂ -tÂ 10sÂ -bÂ 64mbÂ \\Â schedÂ freqÂ idleÂ amÂ wmÂ gfxÂ viewÂ binder_driverÂ halÂ dalvikÂ cameraÂ inputÂ resÂ memory record_android_trace å‘½ä»¤èƒ½è‡ªåŠ¨å¤„ç†å¥½è·¯å¾„ï¼ŒæŠ“å–å®Œæˆåè‡ªåŠ¨æ‰“å¼€ Trace æ–‡ä»¶ã€‚ ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:2:1","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#211-ä½¿ç”¨-perfetto-å‘½ä»¤æŠ“å–"},{"categories":null,"collections":"å·¥å…·","content":"2.1 ä½¿ç”¨å‘½ä»¤è¡ŒæŠ“å– Trace 2.1.1 ä½¿ç”¨ perfetto å‘½ä»¤æŠ“å– é¦–å…ˆä½¿ç”¨ usb çº¿å°†ç”µè„‘å’Œæ‰‹æœºè¿æ¥ï¼Œç¡®ä¿ adb shell å‘½ä»¤èƒ½æ­£å¸¸å·¥ä½œã€‚ æ¥ç€æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š adbÂ shellÂ perfettoÂ -oÂ /data/misc/perfetto-traces/trace_file.perfetto-traceÂ tÂ 20sÂ \\Â schedÂ freqÂ idleÂ amÂ wmÂ gfxÂ viewÂ binder_driverÂ halÂ dalvikÂ cameraÂ inputÂ resÂ memory è¿™ä¸ªå‘½ä»¤ä¼šå¯åŠ¨ä¸€ä¸ª 20 ç§’é’Ÿçš„è·Ÿè¸ªï¼Œæ”¶é›†æŒ‡å®šçš„æ•°æ®æºä¿¡æ¯ï¼Œå¹¶å°†è·Ÿè¸ªæ–‡ä»¶ä¿å­˜åˆ° /data/misc/perfetto-traces/trace_file.perfetto-trace ,æ‰§è¡Œå®Œä¼šåœ¨åå°æ‰§è¡Œã€‚ æœ€åï¼ŒæŠŠ trace æ–‡ä»¶ pull å‡ºæ¥ï¼š adbÂ pullÂ /data/misc/perfetto-traces/trace_file.perfetto-trace æ•´ä¸ªæŠ“å–è¿‡ç¨‹å°±å®Œæˆäº†ã€‚ ä¹Ÿå¯ä»¥åšæˆæ‰‹æœºçš„å†…ç½®çš„åŠŸèƒ½ï¼Œæ‰§è¡Œshellå‘½ä»¤æ¥ç¦»çº¿æŠ“å»traceã€‚ 2.1.2 ä½¿ç”¨ record_android_trace å‘½ä»¤æŠ“å– record_android_trace æ˜¯ Perfetto å›¢é˜Ÿæä¾›çš„ä¸€ä¸ªç®€åŒ–è„šæœ¬ï¼Œä½¿å¾—æˆ‘ä»¬çš„æŠ“å–å·¥ä½œæ›´åŠ ç®€å•ã€‚record_android_trace åœ¨æºç è·¯å¾„ä¸‹é¢ä¹Ÿæœ‰ã€‚ curlÂ -OÂ https://raw.githubusercontent.com/google/perfetto/master/tools/record_android_tracechmodÂ u+xÂ record_android_trace ./record_android_traceÂ -oÂ trace_file.perfetto-traceÂ -tÂ 10sÂ -bÂ 64mbÂ \\Â schedÂ freqÂ idleÂ amÂ wmÂ gfxÂ viewÂ binder_driverÂ halÂ dalvikÂ cameraÂ inputÂ resÂ memory record_android_trace å‘½ä»¤èƒ½è‡ªåŠ¨å¤„ç†å¥½è·¯å¾„ï¼ŒæŠ“å–å®Œæˆåè‡ªåŠ¨æ‰“å¼€ Trace æ–‡ä»¶ã€‚ ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:2:1","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#212-ä½¿ç”¨-record_android_trace-å‘½ä»¤æŠ“å–"},{"categories":null,"collections":"å·¥å…·","content":"2.2 ä½¿ç”¨ UI å·¥å…·æŠ“å– 2.2.1 Perfetto UI æŠ“å– Perfetto ä¹Ÿæä¾›äº†å›¾å½¢åŒ–çš„å·¥å…·æ¥æŠ“å– Traceã€‚ è¯¥å·¥å…·ä»¥ç½‘ç«™çš„æ–¹å¼æä¾›ï¼šhttps://ui.perfetto.dev/#!/record æ‰“å¼€åï¼Œç¬¬ä¸€æ­¥ï¼Œå®ŒæˆåŸºæœ¬çš„è®¾ç½®ï¼š å·¦ä¾§ tab æ ï¼Œé€‰æ‹© Record new trace é€‰é¡¹ã€‚ ä½¿ç”¨ usb çº¿è¿æ¥å¥½æ‰‹æœºå’Œç”µè„‘åï¼Œé€‰é¡¹å¥½ç›®æ ‡å¹³å°ã€‚ é€‰æ‹©æŠ“å–çš„æ¨¡å¼ã€‚ Stop when fullï¼ŒæŠ“å–çš„ trace è¾¾åˆ°è®¾ç½®çš„å®¹é‡åå°±åœæ­¢ã€‚ Ring bufferï¼Œç¯å½¢ç¼“å­˜ï¼Œè®¾ç½®çš„å®¹é‡æ»¡äº†åä¼šè¢«è¦†ç›–ã€‚ Long Traceï¼Œä»»æ€§ï¼Œä¸€ç›´è®°å½•ã€‚ ç¬¬äºŒæ­¥ï¼Œé…ç½®æˆ‘ä»¬è¦æŠ“å–çš„å†…å®¹ï¼š ç®­å¤´æŒ‡å‘çš„å†…å®¹å…¨éƒ¨é€‰ä¸­ï¼Œè¿™éƒ¨åˆ†ä¸»è¦æ˜¯ App ç›¸å…³çš„å†…å®¹ã€‚ æŠŠè°ƒç”¨æ ˆé€‰ä¸Šï¼Œè¿™å¯¹æˆ‘ä»¬åˆ†æä»£ç å¾ˆæœ‰å¸®åŠ©ã€‚ æœ€åç‚¹å‡»ï¼Œå³ä¸Šè§’çš„ Start Recording å°±å¼€å§‹æŠ“å–äº†ã€‚ ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:2:2","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#22-ä½¿ç”¨-ui-å·¥å…·æŠ“å–"},{"categories":null,"collections":"å·¥å…·","content":"2.2 ä½¿ç”¨ UI å·¥å…·æŠ“å– 2.2.1 Perfetto UI æŠ“å– Perfetto ä¹Ÿæä¾›äº†å›¾å½¢åŒ–çš„å·¥å…·æ¥æŠ“å– Traceã€‚ è¯¥å·¥å…·ä»¥ç½‘ç«™çš„æ–¹å¼æä¾›ï¼šhttps://ui.perfetto.dev/#!/record æ‰“å¼€åï¼Œç¬¬ä¸€æ­¥ï¼Œå®ŒæˆåŸºæœ¬çš„è®¾ç½®ï¼š å·¦ä¾§ tab æ ï¼Œé€‰æ‹© Record new trace é€‰é¡¹ã€‚ ä½¿ç”¨ usb çº¿è¿æ¥å¥½æ‰‹æœºå’Œç”µè„‘åï¼Œé€‰é¡¹å¥½ç›®æ ‡å¹³å°ã€‚ é€‰æ‹©æŠ“å–çš„æ¨¡å¼ã€‚ Stop when fullï¼ŒæŠ“å–çš„ trace è¾¾åˆ°è®¾ç½®çš„å®¹é‡åå°±åœæ­¢ã€‚ Ring bufferï¼Œç¯å½¢ç¼“å­˜ï¼Œè®¾ç½®çš„å®¹é‡æ»¡äº†åä¼šè¢«è¦†ç›–ã€‚ Long Traceï¼Œä»»æ€§ï¼Œä¸€ç›´è®°å½•ã€‚ ç¬¬äºŒæ­¥ï¼Œé…ç½®æˆ‘ä»¬è¦æŠ“å–çš„å†…å®¹ï¼š ç®­å¤´æŒ‡å‘çš„å†…å®¹å…¨éƒ¨é€‰ä¸­ï¼Œè¿™éƒ¨åˆ†ä¸»è¦æ˜¯ App ç›¸å…³çš„å†…å®¹ã€‚ æŠŠè°ƒç”¨æ ˆé€‰ä¸Šï¼Œè¿™å¯¹æˆ‘ä»¬åˆ†æä»£ç å¾ˆæœ‰å¸®åŠ©ã€‚ æœ€åç‚¹å‡»ï¼Œå³ä¸Šè§’çš„ Start Recording å°±å¼€å§‹æŠ“å–äº†ã€‚ ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:2:2","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#221-perfetto-ui-æŠ“å–"},{"categories":null,"collections":"å·¥å…·","content":"2.3 ä½¿ç”¨é…ç½®æ–‡ä»¶ç®€åŒ–å‘½ä»¤è¡ŒæŠ“å– åœ¨ä½¿ç”¨ Perfetto UI æŠ“å–æ—¶ï¼Œå½“æˆ‘ä»¬é…ç½®å¥½ä»¥åã€‚ è¿›å…¥åˆ° Recording commandï¼Œç„¶åæŠŠå³ä¾§ä¸¤ä¸ª EOF ä¹‹é—´çš„å†…å®¹å¤åˆ¶ä¸‹æ¥ï¼Œä¿å­˜åœ¨ config.pbtx é…ç½®æ–‡ä»¶ä¸­ã€‚ æ¥ç€å°±å¯ä»¥ç”¨è¿™ä¸ªé…ç½®æ–‡ä»¶æ¥æŠ“å– Trace äº†ï¼š ./record_android_traceÂ -cÂ config.pbtxÂ -oÂ trace_file.perfetto-traceÂ -tÂ 10sÂ -bÂ 64mb ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:2:3","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#23-ä½¿ç”¨é…ç½®æ–‡ä»¶ç®€åŒ–å‘½ä»¤è¡ŒæŠ“å–"},{"categories":null,"collections":"å·¥å…·","content":"3. Perfetto ä½¿ç”¨åŸºç¡€ ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:3:0","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#3-perfetto-ä½¿ç”¨åŸºç¡€"},{"categories":null,"collections":"å·¥å…·","content":"3.1 è¿›å…¥ Perfetto Trace ç•Œé¢ ä½¿ç”¨ record_android_trace å‘½ä»¤æˆ–è€… Perfetto UI æŠ“å– Trace åï¼Œä¼šè‡ªåŠ¨æ‰“å¼€ Perfetto Trace ç•Œé¢ã€‚ ä½¿ç”¨ perfetto å‘½ä»¤æŠ“å– Trace åï¼Œéœ€è¦æ‰‹åŠ¨æ‰“å¼€ Perfetto Trace ç•Œé¢ã€‚æ‰“å¼€çš„æ–¹æ³•å¦‚ä¸‹ï¼š ä½¿ç”¨æµè§ˆå™¨æ‰“å¼€ https://ui.perfetto.dev/ï¼Œç•Œé¢å¦‚ä¸‹ï¼š å¯ä»¥æŠŠ trace æ–‡ä»¶ç›´æ¥æ‹–åˆ°æµè§ˆå™¨ä¸­ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å·¦ä¸Šè§’çš„ Open trace file æ‰“å¼€ trace æ–‡ä»¶ã€‚ ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:3:1","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#31-è¿›å…¥-perfetto-trace-ç•Œé¢"},{"categories":null,"collections":"å·¥å…·","content":"3.2 Perfetto Trace ç•Œé¢åŸºæœ¬å†…å®¹ Perfetto Trace ç•Œé¢å¤§è‡´å¯åˆ†ä¸º 4 ä¸ªåŒºåŸŸï¼š æ“ä½œåŒºï¼Œä¸»è¦ç”¨åˆ° Current Trace ä¸‹çš„å‡ ä¸ªé€‰é¡¹ï¼š Show timeline ï¼šæ˜¾ç¤ºå½“å‰ Traceï¼Œåˆ‡åˆ°äº†åˆ«çš„ç•Œé¢ä¹‹åï¼Œå†ç‚¹è¿™ä¸ªå°±ä¼šå›åˆ° Trace View ç•Œé¢ã€‚ Queryï¼šå†™ SQL æŸ¥è¯¢è¯­å¥å’ŒæŸ¥çœ‹æ‰§è¡Œç»“æœçš„åœ°æ–¹ã€‚ Metricsï¼šå®˜æ–¹é»˜è®¤å¸®ä½ å†™å¥½çš„ä¸€äº›åˆ†æç»“æœã€‚ Info and stats ï¼šå½“å‰ Trace å’Œæ‰‹æœº App çš„ä¸€äº›ä¿¡æ¯ã€‚ ä¿¡æ¯åŒºï¼šæ—¶é—´ä¸æœç´¢ã€‚ Trace å†…å®¹åŒºï¼šå›¾å½¢åŒ–å±•ç¤º Trace çš„åŒºåŸŸã€‚ ä¿¡æ¯åŒºï¼šå±•ç¤ºTrace å†…å®¹åŒºä¸­é€‰æ‹©ä¸­çš„å…ƒç´ çš„è¯¦ç»†ä¿¡æ¯ã€‚ åœ¨ Trace å†…å®¹åŒºä¸­ï¼Œå¯ä»¥é€šè¿‡ w/s æŒ‰é”®ç¼©å°æ”¾å¤§ç•Œé¢ï¼Œ a/d ç§»åŠ¨ç•Œé¢ã€‚ Trace å†…å®¹åŒºä¸­ä¸»è¦æœ‰ä»¥ä¸‹ä¸€äº›å…ƒç´ ï¼š ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:3:2","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#32-perfetto-trace-ç•Œé¢åŸºæœ¬å†…å®¹"},{"categories":null,"collections":"å·¥å…·","content":"3.2.1 sliceï¼Œç‰‡æ®µ é¼ æ ‡å•å‡»åä¼šæœ‰ä¸€ä¸ªé»‘æ¡†åŒ…å›´ä½ï¼Œä¿¡æ¯åŒºä¼šæ˜¾ç¤ºç›¸å…³ä¿¡æ¯ï¼š slice ä»£è¡¨äº†ä¸€æ®µä»£ç çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œèµ·äº Trace.traceBegin \\ ï¼Œç»ˆäº Trace.traceEnd \\ ATRACE_END Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER,Â \"bindApplication\");Â AppBindDataÂ dataÂ =Â (AppBindData)msg.obj;Â handleBindApplication(data);Â Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); çº¿ç¨‹çŠ¶æ€æŸ¥çœ‹ æ·±ç»¿è‰² : è¿è¡Œä¸­ï¼ˆRunningï¼‰ åœ¨RunningçŠ¶æ€å°±ä»£è¡¨ç€å¤„äºcpuä¸Šçš„è¿è¡Œä¸­ çŠ¶æ€ä½œç”¨ï¼šçœ‹æŸä¸ªæ–¹æ³•æ˜¯å¦è€—æ—¶ï¼Œå¯ä»¥é€šè¿‡æµ‹é‡Runningæ—¶é—´é•¿çŸ­åˆ¤æ–­ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œç«å“å¯¹æ¯”çœ‹çœ‹cpuèƒ½åŠ›å¦‚ä½•ï¼Œæˆ–è€…å‰åå¯¹æ¯”å„ä¸ªå¤§å°æ ¸cpuå½±å“æ–¹æ³•çš„è€—æ—¶ æµ…ç»¿è‰² : å¯è¿è¡Œï¼ˆRunnableï¼‰ ä»£è¡¨çº¿ç¨‹å¯ä»¥è¿è¡Œä½†å½“å‰æ²¡æœ‰çœŸæ­£è¿è¡Œä¸­ï¼Œéœ€è¦ç­‰å¾… cpu è°ƒåº¦ï¼Œè¿™ä¸ªæ—¶é—´é•¿çŸ­ä»£è¡¨ç€cpuè°ƒåº¦å¿«æ…¢ é‡è¦ä½œç”¨ï¼šç‚¹å‡»Runnableè¿™ä¸ªå—ï¼Œä¸‹é¢ä¿¡æ¯ä¼šæ˜¾ç¤ºå½“å‰çº¿ç¨‹å”¤é†’è€…æ˜¯è°ï¼Œå³å¯ä»¥æ¸…æ¥šçŸ¥é“æ•´ä¸ªçº¿ç¨‹ä¹‹é—´å”¤é†’é€»è¾‘ã€‚ ç™½è‰²/æ— è‰²: ç¡çœ ä¸­ï¼ˆSleepingï¼‰ ä»£è¡¨å½“å‰çº¿ç¨‹æ²¡æœ‰å·¥ä½œå¯ä»¥åšï¼Œç­‰å¾…äº‹ä»¶é©±åŠ¨å¹²è´§ï¼Œæ¯”å¦‚looperå°±æ˜¯å¤§éƒ¨åˆ†æ—¶é—´ç¡çœ ï¼Œå°éƒ¨åˆ†æ—¶é—´æœ‰æ¶ˆæ¯åå¤„ç†æ¶ˆæ¯ æ©™è‰²Uninterruptible Sleep (IO) ä»£è¡¨ä¸å¯ä»¥ä¸­æ–­çš„ä¼‘çœ çŠ¶æ€ï¼Œä¸€èˆ¬çº¿ç¨‹åœ¨IOæ“ä½œä¸Šé˜»å¡äº† ä¸å¯ä¸­æ–­çŠ¶æ€å®é™…ä¸Šæ˜¯ç³»ç»Ÿå¯¹è¿›ç¨‹å’Œç¡¬ä»¶è®¾å¤‡çš„ä¸€ç§ä¿æŠ¤æœºåˆ¶ã€‚æ¯”å¦‚ï¼Œå½“ä¸€ä¸ªè¿›ç¨‹å‘ç£ç›˜è¯»å†™æ•°æ®æ—¶ï¼Œä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œåœ¨å¾—åˆ°ç£ç›˜å›å¤å‰ï¼Œå®ƒæ˜¯ä¸èƒ½è¢«å…¶ä»–è¿›ç¨‹æˆ–è€…ä¸­æ–­æ‰“æ–­çš„ã€‚ ç´«çº¢è‰²Uninterruptible Sleep (Non IO) ä¸å¯ä¸­æ–­çš„ä¼‘çœ çŠ¶æ€ï¼ŒéIOå¯¼è‡´ï¼Œåœ¨ç­‰å†…æ ¸é”ã€‚é€šå¸¸æ˜¯ä½å†…å­˜å¯¼è‡´ç­‰å¾…ã€å„ç§å„æ ·çš„å†…æ ¸é”ã€‚ Uninterruptibleæƒ…å†µéƒ½å¯ä»¥ç‚¹å‡»åçœ‹åˆ°blockedæ–¹æ³•æ˜¯å“ªä¸ª Blocked function jbd2_log_wait_commit ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:3:3","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#321-sliceç‰‡æ®µ"},{"categories":null,"collections":"å·¥å…·","content":"3.2.1 sliceï¼Œç‰‡æ®µ é¼ æ ‡å•å‡»åä¼šæœ‰ä¸€ä¸ªé»‘æ¡†åŒ…å›´ä½ï¼Œä¿¡æ¯åŒºä¼šæ˜¾ç¤ºç›¸å…³ä¿¡æ¯ï¼š slice ä»£è¡¨äº†ä¸€æ®µä»£ç çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œèµ·äº Trace.traceBegin \\ ï¼Œç»ˆäº Trace.traceEnd \\ ATRACE_END Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER,Â \"bindApplication\");Â AppBindDataÂ dataÂ =Â (AppBindData)msg.obj;Â handleBindApplication(data);Â Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); çº¿ç¨‹çŠ¶æ€æŸ¥çœ‹ æ·±ç»¿è‰² : è¿è¡Œä¸­ï¼ˆRunningï¼‰ åœ¨RunningçŠ¶æ€å°±ä»£è¡¨ç€å¤„äºcpuä¸Šçš„è¿è¡Œä¸­ çŠ¶æ€ä½œç”¨ï¼šçœ‹æŸä¸ªæ–¹æ³•æ˜¯å¦è€—æ—¶ï¼Œå¯ä»¥é€šè¿‡æµ‹é‡Runningæ—¶é—´é•¿çŸ­åˆ¤æ–­ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œç«å“å¯¹æ¯”çœ‹çœ‹cpuèƒ½åŠ›å¦‚ä½•ï¼Œæˆ–è€…å‰åå¯¹æ¯”å„ä¸ªå¤§å°æ ¸cpuå½±å“æ–¹æ³•çš„è€—æ—¶ æµ…ç»¿è‰² : å¯è¿è¡Œï¼ˆRunnableï¼‰ ä»£è¡¨çº¿ç¨‹å¯ä»¥è¿è¡Œä½†å½“å‰æ²¡æœ‰çœŸæ­£è¿è¡Œä¸­ï¼Œéœ€è¦ç­‰å¾… cpu è°ƒåº¦ï¼Œè¿™ä¸ªæ—¶é—´é•¿çŸ­ä»£è¡¨ç€cpuè°ƒåº¦å¿«æ…¢ é‡è¦ä½œç”¨ï¼šç‚¹å‡»Runnableè¿™ä¸ªå—ï¼Œä¸‹é¢ä¿¡æ¯ä¼šæ˜¾ç¤ºå½“å‰çº¿ç¨‹å”¤é†’è€…æ˜¯è°ï¼Œå³å¯ä»¥æ¸…æ¥šçŸ¥é“æ•´ä¸ªçº¿ç¨‹ä¹‹é—´å”¤é†’é€»è¾‘ã€‚ ç™½è‰²/æ— è‰²: ç¡çœ ä¸­ï¼ˆSleepingï¼‰ ä»£è¡¨å½“å‰çº¿ç¨‹æ²¡æœ‰å·¥ä½œå¯ä»¥åšï¼Œç­‰å¾…äº‹ä»¶é©±åŠ¨å¹²è´§ï¼Œæ¯”å¦‚looperå°±æ˜¯å¤§éƒ¨åˆ†æ—¶é—´ç¡çœ ï¼Œå°éƒ¨åˆ†æ—¶é—´æœ‰æ¶ˆæ¯åå¤„ç†æ¶ˆæ¯ æ©™è‰²Uninterruptible Sleep (IO) ä»£è¡¨ä¸å¯ä»¥ä¸­æ–­çš„ä¼‘çœ çŠ¶æ€ï¼Œä¸€èˆ¬çº¿ç¨‹åœ¨IOæ“ä½œä¸Šé˜»å¡äº† ä¸å¯ä¸­æ–­çŠ¶æ€å®é™…ä¸Šæ˜¯ç³»ç»Ÿå¯¹è¿›ç¨‹å’Œç¡¬ä»¶è®¾å¤‡çš„ä¸€ç§ä¿æŠ¤æœºåˆ¶ã€‚æ¯”å¦‚ï¼Œå½“ä¸€ä¸ªè¿›ç¨‹å‘ç£ç›˜è¯»å†™æ•°æ®æ—¶ï¼Œä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œåœ¨å¾—åˆ°ç£ç›˜å›å¤å‰ï¼Œå®ƒæ˜¯ä¸èƒ½è¢«å…¶ä»–è¿›ç¨‹æˆ–è€…ä¸­æ–­æ‰“æ–­çš„ã€‚ ç´«çº¢è‰²Uninterruptible Sleep (Non IO) ä¸å¯ä¸­æ–­çš„ä¼‘çœ çŠ¶æ€ï¼ŒéIOå¯¼è‡´ï¼Œåœ¨ç­‰å†…æ ¸é”ã€‚é€šå¸¸æ˜¯ä½å†…å­˜å¯¼è‡´ç­‰å¾…ã€å„ç§å„æ ·çš„å†…æ ¸é”ã€‚ Uninterruptibleæƒ…å†µéƒ½å¯ä»¥ç‚¹å‡»åçœ‹åˆ°blockedæ–¹æ³•æ˜¯å“ªä¸ª Blocked function jbd2_log_wait_commit ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:3:3","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#çº¿ç¨‹çŠ¶æ€æŸ¥çœ‹"},{"categories":null,"collections":"å·¥å…·","content":"3.2.1 sliceï¼Œç‰‡æ®µ é¼ æ ‡å•å‡»åä¼šæœ‰ä¸€ä¸ªé»‘æ¡†åŒ…å›´ä½ï¼Œä¿¡æ¯åŒºä¼šæ˜¾ç¤ºç›¸å…³ä¿¡æ¯ï¼š slice ä»£è¡¨äº†ä¸€æ®µä»£ç çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œèµ·äº Trace.traceBegin \\ ï¼Œç»ˆäº Trace.traceEnd \\ ATRACE_END Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER,Â \"bindApplication\");Â AppBindDataÂ dataÂ =Â (AppBindData)msg.obj;Â handleBindApplication(data);Â Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); çº¿ç¨‹çŠ¶æ€æŸ¥çœ‹ æ·±ç»¿è‰² : è¿è¡Œä¸­ï¼ˆRunningï¼‰ åœ¨RunningçŠ¶æ€å°±ä»£è¡¨ç€å¤„äºcpuä¸Šçš„è¿è¡Œä¸­ çŠ¶æ€ä½œç”¨ï¼šçœ‹æŸä¸ªæ–¹æ³•æ˜¯å¦è€—æ—¶ï¼Œå¯ä»¥é€šè¿‡æµ‹é‡Runningæ—¶é—´é•¿çŸ­åˆ¤æ–­ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œç«å“å¯¹æ¯”çœ‹çœ‹cpuèƒ½åŠ›å¦‚ä½•ï¼Œæˆ–è€…å‰åå¯¹æ¯”å„ä¸ªå¤§å°æ ¸cpuå½±å“æ–¹æ³•çš„è€—æ—¶ æµ…ç»¿è‰² : å¯è¿è¡Œï¼ˆRunnableï¼‰ ä»£è¡¨çº¿ç¨‹å¯ä»¥è¿è¡Œä½†å½“å‰æ²¡æœ‰çœŸæ­£è¿è¡Œä¸­ï¼Œéœ€è¦ç­‰å¾… cpu è°ƒåº¦ï¼Œè¿™ä¸ªæ—¶é—´é•¿çŸ­ä»£è¡¨ç€cpuè°ƒåº¦å¿«æ…¢ é‡è¦ä½œç”¨ï¼šç‚¹å‡»Runnableè¿™ä¸ªå—ï¼Œä¸‹é¢ä¿¡æ¯ä¼šæ˜¾ç¤ºå½“å‰çº¿ç¨‹å”¤é†’è€…æ˜¯è°ï¼Œå³å¯ä»¥æ¸…æ¥šçŸ¥é“æ•´ä¸ªçº¿ç¨‹ä¹‹é—´å”¤é†’é€»è¾‘ã€‚ ç™½è‰²/æ— è‰²: ç¡çœ ä¸­ï¼ˆSleepingï¼‰ ä»£è¡¨å½“å‰çº¿ç¨‹æ²¡æœ‰å·¥ä½œå¯ä»¥åšï¼Œç­‰å¾…äº‹ä»¶é©±åŠ¨å¹²è´§ï¼Œæ¯”å¦‚looperå°±æ˜¯å¤§éƒ¨åˆ†æ—¶é—´ç¡çœ ï¼Œå°éƒ¨åˆ†æ—¶é—´æœ‰æ¶ˆæ¯åå¤„ç†æ¶ˆæ¯ æ©™è‰²Uninterruptible Sleep (IO) ä»£è¡¨ä¸å¯ä»¥ä¸­æ–­çš„ä¼‘çœ çŠ¶æ€ï¼Œä¸€èˆ¬çº¿ç¨‹åœ¨IOæ“ä½œä¸Šé˜»å¡äº† ä¸å¯ä¸­æ–­çŠ¶æ€å®é™…ä¸Šæ˜¯ç³»ç»Ÿå¯¹è¿›ç¨‹å’Œç¡¬ä»¶è®¾å¤‡çš„ä¸€ç§ä¿æŠ¤æœºåˆ¶ã€‚æ¯”å¦‚ï¼Œå½“ä¸€ä¸ªè¿›ç¨‹å‘ç£ç›˜è¯»å†™æ•°æ®æ—¶ï¼Œä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œåœ¨å¾—åˆ°ç£ç›˜å›å¤å‰ï¼Œå®ƒæ˜¯ä¸èƒ½è¢«å…¶ä»–è¿›ç¨‹æˆ–è€…ä¸­æ–­æ‰“æ–­çš„ã€‚ ç´«çº¢è‰²Uninterruptible Sleep (Non IO) ä¸å¯ä¸­æ–­çš„ä¼‘çœ çŠ¶æ€ï¼ŒéIOå¯¼è‡´ï¼Œåœ¨ç­‰å†…æ ¸é”ã€‚é€šå¸¸æ˜¯ä½å†…å­˜å¯¼è‡´ç­‰å¾…ã€å„ç§å„æ ·çš„å†…æ ¸é”ã€‚ Uninterruptibleæƒ…å†µéƒ½å¯ä»¥ç‚¹å‡»åçœ‹åˆ°blockedæ–¹æ³•æ˜¯å“ªä¸ª Blocked function jbd2_log_wait_commit ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:3:3","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#æ·±ç»¿è‰²--è¿è¡Œä¸­running"},{"categories":null,"collections":"å·¥å…·","content":"3.2.1 sliceï¼Œç‰‡æ®µ é¼ æ ‡å•å‡»åä¼šæœ‰ä¸€ä¸ªé»‘æ¡†åŒ…å›´ä½ï¼Œä¿¡æ¯åŒºä¼šæ˜¾ç¤ºç›¸å…³ä¿¡æ¯ï¼š slice ä»£è¡¨äº†ä¸€æ®µä»£ç çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œèµ·äº Trace.traceBegin \\ ï¼Œç»ˆäº Trace.traceEnd \\ ATRACE_END Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER,Â \"bindApplication\");Â AppBindDataÂ dataÂ =Â (AppBindData)msg.obj;Â handleBindApplication(data);Â Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); çº¿ç¨‹çŠ¶æ€æŸ¥çœ‹ æ·±ç»¿è‰² : è¿è¡Œä¸­ï¼ˆRunningï¼‰ åœ¨RunningçŠ¶æ€å°±ä»£è¡¨ç€å¤„äºcpuä¸Šçš„è¿è¡Œä¸­ çŠ¶æ€ä½œç”¨ï¼šçœ‹æŸä¸ªæ–¹æ³•æ˜¯å¦è€—æ—¶ï¼Œå¯ä»¥é€šè¿‡æµ‹é‡Runningæ—¶é—´é•¿çŸ­åˆ¤æ–­ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œç«å“å¯¹æ¯”çœ‹çœ‹cpuèƒ½åŠ›å¦‚ä½•ï¼Œæˆ–è€…å‰åå¯¹æ¯”å„ä¸ªå¤§å°æ ¸cpuå½±å“æ–¹æ³•çš„è€—æ—¶ æµ…ç»¿è‰² : å¯è¿è¡Œï¼ˆRunnableï¼‰ ä»£è¡¨çº¿ç¨‹å¯ä»¥è¿è¡Œä½†å½“å‰æ²¡æœ‰çœŸæ­£è¿è¡Œä¸­ï¼Œéœ€è¦ç­‰å¾… cpu è°ƒåº¦ï¼Œè¿™ä¸ªæ—¶é—´é•¿çŸ­ä»£è¡¨ç€cpuè°ƒåº¦å¿«æ…¢ é‡è¦ä½œç”¨ï¼šç‚¹å‡»Runnableè¿™ä¸ªå—ï¼Œä¸‹é¢ä¿¡æ¯ä¼šæ˜¾ç¤ºå½“å‰çº¿ç¨‹å”¤é†’è€…æ˜¯è°ï¼Œå³å¯ä»¥æ¸…æ¥šçŸ¥é“æ•´ä¸ªçº¿ç¨‹ä¹‹é—´å”¤é†’é€»è¾‘ã€‚ ç™½è‰²/æ— è‰²: ç¡çœ ä¸­ï¼ˆSleepingï¼‰ ä»£è¡¨å½“å‰çº¿ç¨‹æ²¡æœ‰å·¥ä½œå¯ä»¥åšï¼Œç­‰å¾…äº‹ä»¶é©±åŠ¨å¹²è´§ï¼Œæ¯”å¦‚looperå°±æ˜¯å¤§éƒ¨åˆ†æ—¶é—´ç¡çœ ï¼Œå°éƒ¨åˆ†æ—¶é—´æœ‰æ¶ˆæ¯åå¤„ç†æ¶ˆæ¯ æ©™è‰²Uninterruptible Sleep (IO) ä»£è¡¨ä¸å¯ä»¥ä¸­æ–­çš„ä¼‘çœ çŠ¶æ€ï¼Œä¸€èˆ¬çº¿ç¨‹åœ¨IOæ“ä½œä¸Šé˜»å¡äº† ä¸å¯ä¸­æ–­çŠ¶æ€å®é™…ä¸Šæ˜¯ç³»ç»Ÿå¯¹è¿›ç¨‹å’Œç¡¬ä»¶è®¾å¤‡çš„ä¸€ç§ä¿æŠ¤æœºåˆ¶ã€‚æ¯”å¦‚ï¼Œå½“ä¸€ä¸ªè¿›ç¨‹å‘ç£ç›˜è¯»å†™æ•°æ®æ—¶ï¼Œä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œåœ¨å¾—åˆ°ç£ç›˜å›å¤å‰ï¼Œå®ƒæ˜¯ä¸èƒ½è¢«å…¶ä»–è¿›ç¨‹æˆ–è€…ä¸­æ–­æ‰“æ–­çš„ã€‚ ç´«çº¢è‰²Uninterruptible Sleep (Non IO) ä¸å¯ä¸­æ–­çš„ä¼‘çœ çŠ¶æ€ï¼ŒéIOå¯¼è‡´ï¼Œåœ¨ç­‰å†…æ ¸é”ã€‚é€šå¸¸æ˜¯ä½å†…å­˜å¯¼è‡´ç­‰å¾…ã€å„ç§å„æ ·çš„å†…æ ¸é”ã€‚ Uninterruptibleæƒ…å†µéƒ½å¯ä»¥ç‚¹å‡»åçœ‹åˆ°blockedæ–¹æ³•æ˜¯å“ªä¸ª Blocked function jbd2_log_wait_commit ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:3:3","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#æµ…ç»¿è‰²--å¯è¿è¡Œrunnable"},{"categories":null,"collections":"å·¥å…·","content":"3.2.1 sliceï¼Œç‰‡æ®µ é¼ æ ‡å•å‡»åä¼šæœ‰ä¸€ä¸ªé»‘æ¡†åŒ…å›´ä½ï¼Œä¿¡æ¯åŒºä¼šæ˜¾ç¤ºç›¸å…³ä¿¡æ¯ï¼š slice ä»£è¡¨äº†ä¸€æ®µä»£ç çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œèµ·äº Trace.traceBegin \\ ï¼Œç»ˆäº Trace.traceEnd \\ ATRACE_END Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER,Â \"bindApplication\");Â AppBindDataÂ dataÂ =Â (AppBindData)msg.obj;Â handleBindApplication(data);Â Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); çº¿ç¨‹çŠ¶æ€æŸ¥çœ‹ æ·±ç»¿è‰² : è¿è¡Œä¸­ï¼ˆRunningï¼‰ åœ¨RunningçŠ¶æ€å°±ä»£è¡¨ç€å¤„äºcpuä¸Šçš„è¿è¡Œä¸­ çŠ¶æ€ä½œç”¨ï¼šçœ‹æŸä¸ªæ–¹æ³•æ˜¯å¦è€—æ—¶ï¼Œå¯ä»¥é€šè¿‡æµ‹é‡Runningæ—¶é—´é•¿çŸ­åˆ¤æ–­ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œç«å“å¯¹æ¯”çœ‹çœ‹cpuèƒ½åŠ›å¦‚ä½•ï¼Œæˆ–è€…å‰åå¯¹æ¯”å„ä¸ªå¤§å°æ ¸cpuå½±å“æ–¹æ³•çš„è€—æ—¶ æµ…ç»¿è‰² : å¯è¿è¡Œï¼ˆRunnableï¼‰ ä»£è¡¨çº¿ç¨‹å¯ä»¥è¿è¡Œä½†å½“å‰æ²¡æœ‰çœŸæ­£è¿è¡Œä¸­ï¼Œéœ€è¦ç­‰å¾… cpu è°ƒåº¦ï¼Œè¿™ä¸ªæ—¶é—´é•¿çŸ­ä»£è¡¨ç€cpuè°ƒåº¦å¿«æ…¢ é‡è¦ä½œç”¨ï¼šç‚¹å‡»Runnableè¿™ä¸ªå—ï¼Œä¸‹é¢ä¿¡æ¯ä¼šæ˜¾ç¤ºå½“å‰çº¿ç¨‹å”¤é†’è€…æ˜¯è°ï¼Œå³å¯ä»¥æ¸…æ¥šçŸ¥é“æ•´ä¸ªçº¿ç¨‹ä¹‹é—´å”¤é†’é€»è¾‘ã€‚ ç™½è‰²/æ— è‰²: ç¡çœ ä¸­ï¼ˆSleepingï¼‰ ä»£è¡¨å½“å‰çº¿ç¨‹æ²¡æœ‰å·¥ä½œå¯ä»¥åšï¼Œç­‰å¾…äº‹ä»¶é©±åŠ¨å¹²è´§ï¼Œæ¯”å¦‚looperå°±æ˜¯å¤§éƒ¨åˆ†æ—¶é—´ç¡çœ ï¼Œå°éƒ¨åˆ†æ—¶é—´æœ‰æ¶ˆæ¯åå¤„ç†æ¶ˆæ¯ æ©™è‰²Uninterruptible Sleep (IO) ä»£è¡¨ä¸å¯ä»¥ä¸­æ–­çš„ä¼‘çœ çŠ¶æ€ï¼Œä¸€èˆ¬çº¿ç¨‹åœ¨IOæ“ä½œä¸Šé˜»å¡äº† ä¸å¯ä¸­æ–­çŠ¶æ€å®é™…ä¸Šæ˜¯ç³»ç»Ÿå¯¹è¿›ç¨‹å’Œç¡¬ä»¶è®¾å¤‡çš„ä¸€ç§ä¿æŠ¤æœºåˆ¶ã€‚æ¯”å¦‚ï¼Œå½“ä¸€ä¸ªè¿›ç¨‹å‘ç£ç›˜è¯»å†™æ•°æ®æ—¶ï¼Œä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œåœ¨å¾—åˆ°ç£ç›˜å›å¤å‰ï¼Œå®ƒæ˜¯ä¸èƒ½è¢«å…¶ä»–è¿›ç¨‹æˆ–è€…ä¸­æ–­æ‰“æ–­çš„ã€‚ ç´«çº¢è‰²Uninterruptible Sleep (Non IO) ä¸å¯ä¸­æ–­çš„ä¼‘çœ çŠ¶æ€ï¼ŒéIOå¯¼è‡´ï¼Œåœ¨ç­‰å†…æ ¸é”ã€‚é€šå¸¸æ˜¯ä½å†…å­˜å¯¼è‡´ç­‰å¾…ã€å„ç§å„æ ·çš„å†…æ ¸é”ã€‚ Uninterruptibleæƒ…å†µéƒ½å¯ä»¥ç‚¹å‡»åçœ‹åˆ°blockedæ–¹æ³•æ˜¯å“ªä¸ª Blocked function jbd2_log_wait_commit ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:3:3","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#ç™½è‰²æ— è‰²-ç¡çœ ä¸­sleeping"},{"categories":null,"collections":"å·¥å…·","content":"3.2.1 sliceï¼Œç‰‡æ®µ é¼ æ ‡å•å‡»åä¼šæœ‰ä¸€ä¸ªé»‘æ¡†åŒ…å›´ä½ï¼Œä¿¡æ¯åŒºä¼šæ˜¾ç¤ºç›¸å…³ä¿¡æ¯ï¼š slice ä»£è¡¨äº†ä¸€æ®µä»£ç çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œèµ·äº Trace.traceBegin \\ ï¼Œç»ˆäº Trace.traceEnd \\ ATRACE_END Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER,Â \"bindApplication\");Â AppBindDataÂ dataÂ =Â (AppBindData)msg.obj;Â handleBindApplication(data);Â Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); çº¿ç¨‹çŠ¶æ€æŸ¥çœ‹ æ·±ç»¿è‰² : è¿è¡Œä¸­ï¼ˆRunningï¼‰ åœ¨RunningçŠ¶æ€å°±ä»£è¡¨ç€å¤„äºcpuä¸Šçš„è¿è¡Œä¸­ çŠ¶æ€ä½œç”¨ï¼šçœ‹æŸä¸ªæ–¹æ³•æ˜¯å¦è€—æ—¶ï¼Œå¯ä»¥é€šè¿‡æµ‹é‡Runningæ—¶é—´é•¿çŸ­åˆ¤æ–­ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œç«å“å¯¹æ¯”çœ‹çœ‹cpuèƒ½åŠ›å¦‚ä½•ï¼Œæˆ–è€…å‰åå¯¹æ¯”å„ä¸ªå¤§å°æ ¸cpuå½±å“æ–¹æ³•çš„è€—æ—¶ æµ…ç»¿è‰² : å¯è¿è¡Œï¼ˆRunnableï¼‰ ä»£è¡¨çº¿ç¨‹å¯ä»¥è¿è¡Œä½†å½“å‰æ²¡æœ‰çœŸæ­£è¿è¡Œä¸­ï¼Œéœ€è¦ç­‰å¾… cpu è°ƒåº¦ï¼Œè¿™ä¸ªæ—¶é—´é•¿çŸ­ä»£è¡¨ç€cpuè°ƒåº¦å¿«æ…¢ é‡è¦ä½œç”¨ï¼šç‚¹å‡»Runnableè¿™ä¸ªå—ï¼Œä¸‹é¢ä¿¡æ¯ä¼šæ˜¾ç¤ºå½“å‰çº¿ç¨‹å”¤é†’è€…æ˜¯è°ï¼Œå³å¯ä»¥æ¸…æ¥šçŸ¥é“æ•´ä¸ªçº¿ç¨‹ä¹‹é—´å”¤é†’é€»è¾‘ã€‚ ç™½è‰²/æ— è‰²: ç¡çœ ä¸­ï¼ˆSleepingï¼‰ ä»£è¡¨å½“å‰çº¿ç¨‹æ²¡æœ‰å·¥ä½œå¯ä»¥åšï¼Œç­‰å¾…äº‹ä»¶é©±åŠ¨å¹²è´§ï¼Œæ¯”å¦‚looperå°±æ˜¯å¤§éƒ¨åˆ†æ—¶é—´ç¡çœ ï¼Œå°éƒ¨åˆ†æ—¶é—´æœ‰æ¶ˆæ¯åå¤„ç†æ¶ˆæ¯ æ©™è‰²Uninterruptible Sleep (IO) ä»£è¡¨ä¸å¯ä»¥ä¸­æ–­çš„ä¼‘çœ çŠ¶æ€ï¼Œä¸€èˆ¬çº¿ç¨‹åœ¨IOæ“ä½œä¸Šé˜»å¡äº† ä¸å¯ä¸­æ–­çŠ¶æ€å®é™…ä¸Šæ˜¯ç³»ç»Ÿå¯¹è¿›ç¨‹å’Œç¡¬ä»¶è®¾å¤‡çš„ä¸€ç§ä¿æŠ¤æœºåˆ¶ã€‚æ¯”å¦‚ï¼Œå½“ä¸€ä¸ªè¿›ç¨‹å‘ç£ç›˜è¯»å†™æ•°æ®æ—¶ï¼Œä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œåœ¨å¾—åˆ°ç£ç›˜å›å¤å‰ï¼Œå®ƒæ˜¯ä¸èƒ½è¢«å…¶ä»–è¿›ç¨‹æˆ–è€…ä¸­æ–­æ‰“æ–­çš„ã€‚ ç´«çº¢è‰²Uninterruptible Sleep (Non IO) ä¸å¯ä¸­æ–­çš„ä¼‘çœ çŠ¶æ€ï¼ŒéIOå¯¼è‡´ï¼Œåœ¨ç­‰å†…æ ¸é”ã€‚é€šå¸¸æ˜¯ä½å†…å­˜å¯¼è‡´ç­‰å¾…ã€å„ç§å„æ ·çš„å†…æ ¸é”ã€‚ Uninterruptibleæƒ…å†µéƒ½å¯ä»¥ç‚¹å‡»åçœ‹åˆ°blockedæ–¹æ³•æ˜¯å“ªä¸ª Blocked function jbd2_log_wait_commit ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:3:3","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#æ©™è‰²uninterruptible-sleep-io"},{"categories":null,"collections":"å·¥å…·","content":"3.2.1 sliceï¼Œç‰‡æ®µ é¼ æ ‡å•å‡»åä¼šæœ‰ä¸€ä¸ªé»‘æ¡†åŒ…å›´ä½ï¼Œä¿¡æ¯åŒºä¼šæ˜¾ç¤ºç›¸å…³ä¿¡æ¯ï¼š slice ä»£è¡¨äº†ä¸€æ®µä»£ç çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œèµ·äº Trace.traceBegin \\ ï¼Œç»ˆäº Trace.traceEnd \\ ATRACE_END Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER,Â \"bindApplication\");Â AppBindDataÂ dataÂ =Â (AppBindData)msg.obj;Â handleBindApplication(data);Â Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER); çº¿ç¨‹çŠ¶æ€æŸ¥çœ‹ æ·±ç»¿è‰² : è¿è¡Œä¸­ï¼ˆRunningï¼‰ åœ¨RunningçŠ¶æ€å°±ä»£è¡¨ç€å¤„äºcpuä¸Šçš„è¿è¡Œä¸­ çŠ¶æ€ä½œç”¨ï¼šçœ‹æŸä¸ªæ–¹æ³•æ˜¯å¦è€—æ—¶ï¼Œå¯ä»¥é€šè¿‡æµ‹é‡Runningæ—¶é—´é•¿çŸ­åˆ¤æ–­ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œç«å“å¯¹æ¯”çœ‹çœ‹cpuèƒ½åŠ›å¦‚ä½•ï¼Œæˆ–è€…å‰åå¯¹æ¯”å„ä¸ªå¤§å°æ ¸cpuå½±å“æ–¹æ³•çš„è€—æ—¶ æµ…ç»¿è‰² : å¯è¿è¡Œï¼ˆRunnableï¼‰ ä»£è¡¨çº¿ç¨‹å¯ä»¥è¿è¡Œä½†å½“å‰æ²¡æœ‰çœŸæ­£è¿è¡Œä¸­ï¼Œéœ€è¦ç­‰å¾… cpu è°ƒåº¦ï¼Œè¿™ä¸ªæ—¶é—´é•¿çŸ­ä»£è¡¨ç€cpuè°ƒåº¦å¿«æ…¢ é‡è¦ä½œç”¨ï¼šç‚¹å‡»Runnableè¿™ä¸ªå—ï¼Œä¸‹é¢ä¿¡æ¯ä¼šæ˜¾ç¤ºå½“å‰çº¿ç¨‹å”¤é†’è€…æ˜¯è°ï¼Œå³å¯ä»¥æ¸…æ¥šçŸ¥é“æ•´ä¸ªçº¿ç¨‹ä¹‹é—´å”¤é†’é€»è¾‘ã€‚ ç™½è‰²/æ— è‰²: ç¡çœ ä¸­ï¼ˆSleepingï¼‰ ä»£è¡¨å½“å‰çº¿ç¨‹æ²¡æœ‰å·¥ä½œå¯ä»¥åšï¼Œç­‰å¾…äº‹ä»¶é©±åŠ¨å¹²è´§ï¼Œæ¯”å¦‚looperå°±æ˜¯å¤§éƒ¨åˆ†æ—¶é—´ç¡çœ ï¼Œå°éƒ¨åˆ†æ—¶é—´æœ‰æ¶ˆæ¯åå¤„ç†æ¶ˆæ¯ æ©™è‰²Uninterruptible Sleep (IO) ä»£è¡¨ä¸å¯ä»¥ä¸­æ–­çš„ä¼‘çœ çŠ¶æ€ï¼Œä¸€èˆ¬çº¿ç¨‹åœ¨IOæ“ä½œä¸Šé˜»å¡äº† ä¸å¯ä¸­æ–­çŠ¶æ€å®é™…ä¸Šæ˜¯ç³»ç»Ÿå¯¹è¿›ç¨‹å’Œç¡¬ä»¶è®¾å¤‡çš„ä¸€ç§ä¿æŠ¤æœºåˆ¶ã€‚æ¯”å¦‚ï¼Œå½“ä¸€ä¸ªè¿›ç¨‹å‘ç£ç›˜è¯»å†™æ•°æ®æ—¶ï¼Œä¸ºäº†ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œåœ¨å¾—åˆ°ç£ç›˜å›å¤å‰ï¼Œå®ƒæ˜¯ä¸èƒ½è¢«å…¶ä»–è¿›ç¨‹æˆ–è€…ä¸­æ–­æ‰“æ–­çš„ã€‚ ç´«çº¢è‰²Uninterruptible Sleep (Non IO) ä¸å¯ä¸­æ–­çš„ä¼‘çœ çŠ¶æ€ï¼ŒéIOå¯¼è‡´ï¼Œåœ¨ç­‰å†…æ ¸é”ã€‚é€šå¸¸æ˜¯ä½å†…å­˜å¯¼è‡´ç­‰å¾…ã€å„ç§å„æ ·çš„å†…æ ¸é”ã€‚ Uninterruptibleæƒ…å†µéƒ½å¯ä»¥ç‚¹å‡»åçœ‹åˆ°blockedæ–¹æ³•æ˜¯å“ªä¸ª Blocked function jbd2_log_wait_commit ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:3:3","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#ç´«çº¢è‰²uninterruptible-sleep-non-io"},{"categories":null,"collections":"å·¥å…·","content":"3.2.2 counterï¼Œè®¡æ•°å™¨ ç”¨äºè®°å½•ä¸€äº›å…³é”®æ•°æ®ã€‚ å¯¹åº”äºä»£ç ä¸­çš„ Trace.traceCounter/ATRACE_INTï¼š ATRACE_INT(ftl::Concat(\"HW_VSYNC_\",Â displayIdOpt-\u003evalue).c_str(),Â displayData.vsyncTraceToggle); ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:3:4","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#322-counterè®¡æ•°å™¨"},{"categories":null,"collections":"å·¥å…·","content":"3.2.3 CPU Sched Sliceï¼Œ cpu è°ƒåº¦ç‰‡æ®µ ç”¨äºå±•ç¤º cpu çš„è°ƒåº¦æƒ…å†µã€‚ ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:3:5","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#323-cpu-sched-slice-cpu-è°ƒåº¦ç‰‡æ®µ"},{"categories":null,"collections":"å·¥å…·","content":"3.2.4 thread_stateï¼Œçº¿ç¨‹çŠ¶æ€ ç‚¹å‡»ç‰‡æ®µä¸Šæ–¹çº¿ç¨‹è°ƒåº¦ä¿¡æ¯ç‰‡æ®µ(Running)ï¼Œå¯ä»¥çœ‹åˆ°çº¿ç¨‹å½“å‰è¿è¡Œåœ¨å“ªä¸ªCPUä¸Šã€‚ ç‚¹å‡»ä¿¡æ¯åŒºä¸­çš„ Running on CPU 7 æ—è¾¹çš„æ–œç®­å¤´ï¼š å¯ä»¥åœ¨ CPU è°ƒåº¦ä¸­çœ‹åˆ°è¯¥è¿è¡Œç‰‡æ®µã€‚ å†æ¬¡ç‚¹å‡»æ–œç®­å¤´ï¼Œå¯ä»¥å›åˆ°åŸæ¥ä½ç½®ã€‚ è¿™é‡Œçš„ thread_state å®é™…æ˜¯æˆ‘ä»¬çš„ä¸»çº¿ç¨‹ï¼Œç”±ç”¨æˆ·ç‚¹å‡»å±å¹•å”¤é†’è¿è¡Œï¼Œå®é™…å¾ˆå¤šçº¿ç¨‹éƒ½æ˜¯ç”±å…¶ä»–çº¿ç¨‹/è¿›ç¨‹å”¤é†’çš„ï¼Œæ¯”å¦‚åœ¨ CPU è°ƒåº¦ä¸­é€‰æ‹©ä¸€ä¸ª Sliceï¼š è¿™é‡Œçš„æ„æ€æ˜¯å½“å‰ thread ç”± Pï¼ˆProcessï¼‰/system/bin/surfaceflinger [584] ä¸­çš„ Tï¼ˆThreadï¼‰app [689] å”¤é†’ã€‚ çº¿ç¨‹ä»å°±ç»ªåˆ°è¿è¡Œå»¶è¿Ÿäº† 48us 381ns ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:3:6","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#324-thread_stateçº¿ç¨‹çŠ¶æ€"},{"categories":null,"collections":"å·¥å…·","content":"3.3 Perfetto Trace ç•Œé¢åŸºæœ¬æ“ä½œ W : æ”¾å¤§ perfetto , æ”¾å¤§å¯ä»¥æ›´å¥½åœ°çœ‹æ¸…å±€éƒ¨ç»†èŠ‚ S : ç¼©å° perfetto, ç¼©å°ä»¥æŸ¥çœ‹æ•´ä½“ A : å·¦ç§» D : å³ç§» M : é«˜äº®é€‰ä¸­å½“å‰é¼ æ ‡ç‚¹å‡»çš„æ®µ Fï¼šå¿«é€Ÿæ”¾å¤§åˆ°é€‰æ‹©ä½ç½® SHIFT + é¼ æ ‡ å¯ä»¥æ‹–åŠ¨ ç”¨å¾—æœ€å¤šçš„å…¶å®å°±æ˜¯æ·»åŠ æ ‡è®°ã€‚ å½“æˆ‘ä»¬é€‰ä¸­ä¸€ä¸ªç‰‡æ®µæ—¶ï¼Œç‚¹å‡» mï¼Œå°±å¯ä»¥åšä¸€ä¸ªä¸´æ—¶çš„æ ‡è®°ï¼Œå½“æ ‡è®°å¦ä¸€ä¸ªç‰‡æ®µä»¥åï¼Œå‰ä¸€ä¸ªä¸´æ—¶æ ‡è®°å°±ä¼šå–æ¶ˆã€‚ é€‰ä¸­ä¸€ä¸ªç‰‡æ®µä»¥åï¼Œå¦‚æœç‚¹å‡» shift + mï¼Œå°±ä¼šæ·»åŠ ä¸€ä¸ªæ™®é€šæ ‡è®°ã€‚ æ ‡è®°ä»¥åï¼Œä¼šå‡ºç°ä¸¤ä¸ªå°ä¸‰è§’ï¼š ç‚¹å‡»å°ä¸‰è§’åï¼Œä¿¡æ¯åŒºä¼šå‡ºç°ä¸€ä¸ª remove æŒ‰é”®ï¼š ç‚¹å‡»å³å¯å–æ¶ˆã€‚ 3.4 è·¨è¿›ç¨‹é€šè®¯çš„å‘èµ·ç«¯ä¸æ¥å—ç«¯è·³è½¬ å‘èµ·ç«¯å¦‚ä¸‹ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç‚¹å‡»è·³è½¬åˆ°æ¥æ”¶ç«¯ ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:3:7","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#33-perfetto-trace-ç•Œé¢åŸºæœ¬æ“ä½œ"},{"categories":null,"collections":"å·¥å…·","content":"3.3 Perfetto Trace ç•Œé¢åŸºæœ¬æ“ä½œ W : æ”¾å¤§ perfetto , æ”¾å¤§å¯ä»¥æ›´å¥½åœ°çœ‹æ¸…å±€éƒ¨ç»†èŠ‚ S : ç¼©å° perfetto, ç¼©å°ä»¥æŸ¥çœ‹æ•´ä½“ A : å·¦ç§» D : å³ç§» M : é«˜äº®é€‰ä¸­å½“å‰é¼ æ ‡ç‚¹å‡»çš„æ®µ Fï¼šå¿«é€Ÿæ”¾å¤§åˆ°é€‰æ‹©ä½ç½® SHIFT + é¼ æ ‡ å¯ä»¥æ‹–åŠ¨ ç”¨å¾—æœ€å¤šçš„å…¶å®å°±æ˜¯æ·»åŠ æ ‡è®°ã€‚ å½“æˆ‘ä»¬é€‰ä¸­ä¸€ä¸ªç‰‡æ®µæ—¶ï¼Œç‚¹å‡» mï¼Œå°±å¯ä»¥åšä¸€ä¸ªä¸´æ—¶çš„æ ‡è®°ï¼Œå½“æ ‡è®°å¦ä¸€ä¸ªç‰‡æ®µä»¥åï¼Œå‰ä¸€ä¸ªä¸´æ—¶æ ‡è®°å°±ä¼šå–æ¶ˆã€‚ é€‰ä¸­ä¸€ä¸ªç‰‡æ®µä»¥åï¼Œå¦‚æœç‚¹å‡» shift + mï¼Œå°±ä¼šæ·»åŠ ä¸€ä¸ªæ™®é€šæ ‡è®°ã€‚ æ ‡è®°ä»¥åï¼Œä¼šå‡ºç°ä¸¤ä¸ªå°ä¸‰è§’ï¼š ç‚¹å‡»å°ä¸‰è§’åï¼Œä¿¡æ¯åŒºä¼šå‡ºç°ä¸€ä¸ª remove æŒ‰é”®ï¼š ç‚¹å‡»å³å¯å–æ¶ˆã€‚ 3.4 è·¨è¿›ç¨‹é€šè®¯çš„å‘èµ·ç«¯ä¸æ¥å—ç«¯è·³è½¬ å‘èµ·ç«¯å¦‚ä¸‹ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç‚¹å‡»è·³è½¬åˆ°æ¥æ”¶ç«¯ ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:3:7","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#34-è·¨è¿›ç¨‹é€šè®¯çš„å‘èµ·ç«¯ä¸æ¥å—ç«¯è·³è½¬"},{"categories":null,"collections":"å·¥å…·","content":"4. å¦‚ä½•æ·»åŠ trace Log ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:4:0","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#4-å¦‚ä½•æ·»åŠ trace-log"},{"categories":null,"collections":"å·¥å…·","content":"4.1 ä½¿ç”¨atraceç›¸å…³ç±»æ–¹æ³•ä»‹ç» è¿™é‡Œè¿˜éœ€è¦çœ‹å¯¹åº”çš„traceæºç æ˜¯æœ€å…¨é¢çš„ è·¯å¾„ï¼šsystem/core/libcutils/include/cutils/trace.h /* * Copyright (C) 2012 The Android Open Source Project * * Licensed under the Apache License, Version 2.0 (the \"License\"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an \"AS IS\" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */ #ifndef _LIBS_CUTILS_TRACE_H #define _LIBS_CUTILS_TRACE_H #include \u003cinttypes.h\u003e #include \u003cstdatomic.h\u003e #include \u003cstdbool.h\u003e #include \u003cstdint.h\u003e #include \u003cstdio.h\u003e #include \u003csys/cdefs.h\u003e #include \u003csys/types.h\u003e #include \u003cunistd.h\u003e #include \u003ccutils/compiler.h\u003e __BEGIN_DECLS /** * The ATRACE_TAG macro can be defined before including this header to trace * using one of the tags defined below. It must be defined to one of the * following ATRACE_TAG_* macros. The trace tag is used to filter tracing in * userland to avoid some of the runtime cost of tracing when it is not desired. * * Defining ATRACE_TAG to be ATRACE_TAG_ALWAYS will result in the tracing always * being enabled - this should ONLY be done for debug code, as userland tracing * has a performance cost even when the trace is not being recorded. Defining * ATRACE_TAG to be ATRACE_TAG_NEVER or leaving ATRACE_TAG undefined will result * in the tracing always being disabled. * * ATRACE_TAG_HAL should be bitwise ORed with the relevant tags for tracing * within a hardware module. For example a camera hardware module would set: * #define ATRACE_TAG (ATRACE_TAG_CAMERA | ATRACE_TAG_HAL) * * Keep these in sync with frameworks/base/core/java/android/os/Trace.java. */ #define ATRACE_TAG_NEVER 0 // This tag is never enabled. #define ATRACE_TAG_ALWAYS (1\u003c\u003c0) // This tag is always enabled. #define ATRACE_TAG_GRAPHICS (1\u003c\u003c1) #define ATRACE_TAG_INPUT (1\u003c\u003c2) #define ATRACE_TAG_VIEW (1\u003c\u003c3) #define ATRACE_TAG_WEBVIEW (1\u003c\u003c4) #define ATRACE_TAG_WINDOW_MANAGER (1\u003c\u003c5) #define ATRACE_TAG_ACTIVITY_MANAGER (1\u003c\u003c6) #define ATRACE_TAG_SYNC_MANAGER (1\u003c\u003c7) #define ATRACE_TAG_AUDIO (1\u003c\u003c8) #define ATRACE_TAG_VIDEO (1\u003c\u003c9) #define ATRACE_TAG_CAMERA (1\u003c\u003c10) #define ATRACE_TAG_HAL (1\u003c\u003c11) #define ATRACE_TAG_APP (1\u003c\u003c12) #define ATRACE_TAG_RESOURCES (1\u003c\u003c13) #define ATRACE_TAG_DALVIK (1\u003c\u003c14) #define ATRACE_TAG_RS (1\u003c\u003c15) #define ATRACE_TAG_BIONIC (1\u003c\u003c16) #define ATRACE_TAG_POWER (1\u003c\u003c17) #define ATRACE_TAG_PACKAGE_MANAGER (1\u003c\u003c18) #define ATRACE_TAG_SYSTEM_SERVER (1\u003c\u003c19) #define ATRACE_TAG_DATABASE (1\u003c\u003c20) #define ATRACE_TAG_NETWORK (1\u003c\u003c21) #define ATRACE_TAG_ADB (1\u003c\u003c22) #define ATRACE_TAG_VIBRATOR (1\u003c\u003c23) #define ATRACE_TAG_AIDL (1\u003c\u003c24) #define ATRACE_TAG_NNAPI (1\u003c\u003c25) #define ATRACE_TAG_RRO (1\u003c\u003c26) #define ATRACE_TAG_THERMAL (1 \u003c\u003c 27) #define ATRACE_TAG_LAST ATRACE_TAG_THERMAL // Reserved for initialization. #define ATRACE_TAG_NOT_READY (1ULL\u003c\u003c63) #define ATRACE_TAG_VALID_MASK ((ATRACE_TAG_LAST - 1) | ATRACE_TAG_LAST) #ifndef ATRACE_TAG #define ATRACE_TAG ATRACE_TAG_NEVER #elif ATRACE_TAG \u003e ATRACE_TAG_VALID_MASK #error ATRACE_TAG must be defined to be one of the tags defined in cutils/trace.h #endif /** * Opens the trace file for writing and reads the property for initial tags. * The atrace.tags.enableflags property sets the tags to trace. * This function should not be explicitly called, the first call to any normal * trace function will cause it to be run safely. */ void atrace_setup(); /** * If tracing is ready, set atrace_enabled_tags to the system property * debug.atrace.tags.enableflags. Can be used as a sysprop change callback. */ void atrace_update_tags(); /** * Set whether tracing is enabled for the current process. This is used to * prevent tracing within the Zygote process. */ void atrace_set_tracing_enabled(bool enabled); /**","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:4:1","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#41-ä½¿ç”¨atraceç›¸å…³ç±»æ–¹æ³•ä»‹ç»"},{"categories":null,"collections":"å·¥å…·","content":"4.2 æ¯”å¦‚å¸¸è§çš„å‡ ä¸ªæ–¹æ³•ï¼š 4.2.1 ATRACE_CALL() è¿™ä¸ªæ–¹æ³•ï¼Œä»£è¡¨å¯¹ä¸€ä¸ªfunctionçš„å¼€å¤´å’Œç»“å°¾è¿›è¡Œtagï¼Œå®ƒçš„æºç å¦‚ä¸‹ #define ATRACE_CALL() ATRACE_NAME(FUNCTION) å³æœ¬è´¨è°ƒç”¨çš„æ˜¯ATRACE_NAME 4.2.2 ATRACE_NAMEæ–¹æ³• è°ƒç”¨å¦‚ä¸‹ï¼š æ•ˆæœå¦‚ä¸‹ï¼š 4.2.3 traceç›¸å…³å®æˆ˜ä½¿ç”¨ï¼š 1ã€å¼•å…¥ç›¸å…³çš„å¤´æ–‡ä»¶åŠç›¸å…³åº“ #include \u003cutils/Trace.h\u003e ç¼–è¯‘æ—¶å€™è¿˜å¾—è€ƒç‡ç›¸å…³utilsçš„libæ˜¯å¦å¼•å…¥ å¦‚è¿™é‡Œä»¥æˆªå›¾ä»£ç ä¸ºä¾‹å°±æœ‰å¼•å…¥libutils frameworks/base/cmds/screencap/Android.bp cc_binary { name: \"screencap\", srcs: [\"screencap.cpp\"], shared_libs: [ \"libcutils\", \"libutils\", \"libbinder\", \"libjnigraphics\", \"libui\", \"libgui\", ], cflags: [ \"-Wall\", \"-Werror\", \"-Wunused\", \"-Wunreachable-code\", ], } 2ã€å®šä¹‰å¥½ç›¸å…³çš„TAG #undef ATRACE_TAG #define ATRACE_TAG ATRACE_TAG_GRAPHICS è¿™é‡Œå°±é€‰äº†ä¸€ä¸ªATRACE_TAG_GRAPHICSå³graphicsè¿™ä¸ªç»„ 3ã€è°ƒç”¨ç›¸å…³actraceæ–¹æ³• ATRACE_CALL ATRACE_NAME ä¸€èˆ¬é’ˆå¯¹æ•´ä¸ªæ–¹æ³•æˆ–è€…å•ç‹¬ä½œç”¨åŸŸï¼ŒATRACE_CALLå’ŒATRACE_NAMEæœ¬è´¨æ²¡æœ‰åŒºåˆ«ï¼Œåªæ˜¯æŠŠåå­—å˜æˆäº†functionçš„name å…·ä½“æ•ˆæœå¦‚ä¸‹ï¼š ä¼˜ç‚¹ï¼šåªéœ€è¦ä¸€ä¸ªè°ƒç”¨æ—¢å¯ä»¥å®ç°tagæ‰“å°ï¼Œè‡ªåŠ¨è·Ÿéšä½œç”¨åŸŸè¿›è¡Œtagçš„ç»“æŸ ç¼ºç‚¹ï¼šéœ€è¦è‡ªå·±ç†Ÿç»ƒæŒæ¡å¥½ä½œç”¨åŸŸï¼Œæ²¡æœ‰å¯ä»¥æ‰‹åŠ¨æ§åˆ¶çš„tagç»“æŸçš„ç‚¹ 4ã€ç›¸å…³çµæ´»æ§åˆ¶å¼€å§‹ä¸ç»“æŸçš„traceæ–¹æ³• ç›´æ¥ä½¿ç”¨atrace_beginå’Œatrace_endæ–¹æ³•ï¼Œä½¿ç”¨å¦‚ä¸‹ï¼š GraphicBuffer::GraphicBuffer() : BASE(), mOwner(ownData), mBufferMapper(GraphicBufferMapper::get()), mInitCheck(NO_ERROR), mId(getUniqueId()), mGenerationNumber(0) { ATRACE_NAME(\"GraphicBuffer::GraphicBuffer()1\"); atrace_begin(ATRACE_TAG, \"GraphicBuffer 1\"); width = height = stride = format = usage_deprecated = 0; atrace_end(ATRACE_TAG); usage = 0; layerCount = 0; handle = nullptr; } åŒæ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨å¯¹åº”å®å®šä¹‰ï¼š ATRACE_BEGIN(name); ATRACE_END(); æ‰§è¡Œåæ•ˆæœå¦‚ä¸‹ï¼š ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:4:2","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#42-æ¯”å¦‚å¸¸è§çš„å‡ ä¸ªæ–¹æ³•"},{"categories":null,"collections":"å·¥å…·","content":"4.2 æ¯”å¦‚å¸¸è§çš„å‡ ä¸ªæ–¹æ³•ï¼š 4.2.1 ATRACE_CALL() è¿™ä¸ªæ–¹æ³•ï¼Œä»£è¡¨å¯¹ä¸€ä¸ªfunctionçš„å¼€å¤´å’Œç»“å°¾è¿›è¡Œtagï¼Œå®ƒçš„æºç å¦‚ä¸‹ #define ATRACE_CALL() ATRACE_NAME(FUNCTION) å³æœ¬è´¨è°ƒç”¨çš„æ˜¯ATRACE_NAME 4.2.2 ATRACE_NAMEæ–¹æ³• è°ƒç”¨å¦‚ä¸‹ï¼š æ•ˆæœå¦‚ä¸‹ï¼š 4.2.3 traceç›¸å…³å®æˆ˜ä½¿ç”¨ï¼š 1ã€å¼•å…¥ç›¸å…³çš„å¤´æ–‡ä»¶åŠç›¸å…³åº“ #include ç¼–è¯‘æ—¶å€™è¿˜å¾—è€ƒç‡ç›¸å…³utilsçš„libæ˜¯å¦å¼•å…¥ å¦‚è¿™é‡Œä»¥æˆªå›¾ä»£ç ä¸ºä¾‹å°±æœ‰å¼•å…¥libutils frameworks/base/cmds/screencap/Android.bp cc_binary { name: \"screencap\", srcs: [\"screencap.cpp\"], shared_libs: [ \"libcutils\", \"libutils\", \"libbinder\", \"libjnigraphics\", \"libui\", \"libgui\", ], cflags: [ \"-Wall\", \"-Werror\", \"-Wunused\", \"-Wunreachable-code\", ], } 2ã€å®šä¹‰å¥½ç›¸å…³çš„TAG #undef ATRACE_TAG #define ATRACE_TAG ATRACE_TAG_GRAPHICS è¿™é‡Œå°±é€‰äº†ä¸€ä¸ªATRACE_TAG_GRAPHICSå³graphicsè¿™ä¸ªç»„ 3ã€è°ƒç”¨ç›¸å…³actraceæ–¹æ³• ATRACE_CALL ATRACE_NAME ä¸€èˆ¬é’ˆå¯¹æ•´ä¸ªæ–¹æ³•æˆ–è€…å•ç‹¬ä½œç”¨åŸŸï¼ŒATRACE_CALLå’ŒATRACE_NAMEæœ¬è´¨æ²¡æœ‰åŒºåˆ«ï¼Œåªæ˜¯æŠŠåå­—å˜æˆäº†functionçš„name å…·ä½“æ•ˆæœå¦‚ä¸‹ï¼š ä¼˜ç‚¹ï¼šåªéœ€è¦ä¸€ä¸ªè°ƒç”¨æ—¢å¯ä»¥å®ç°tagæ‰“å°ï¼Œè‡ªåŠ¨è·Ÿéšä½œç”¨åŸŸè¿›è¡Œtagçš„ç»“æŸ ç¼ºç‚¹ï¼šéœ€è¦è‡ªå·±ç†Ÿç»ƒæŒæ¡å¥½ä½œç”¨åŸŸï¼Œæ²¡æœ‰å¯ä»¥æ‰‹åŠ¨æ§åˆ¶çš„tagç»“æŸçš„ç‚¹ 4ã€ç›¸å…³çµæ´»æ§åˆ¶å¼€å§‹ä¸ç»“æŸçš„traceæ–¹æ³• ç›´æ¥ä½¿ç”¨atrace_beginå’Œatrace_endæ–¹æ³•ï¼Œä½¿ç”¨å¦‚ä¸‹ï¼š GraphicBuffer::GraphicBuffer() : BASE(), mOwner(ownData), mBufferMapper(GraphicBufferMapper::get()), mInitCheck(NO_ERROR), mId(getUniqueId()), mGenerationNumber(0) { ATRACE_NAME(\"GraphicBuffer::GraphicBuffer()1\"); atrace_begin(ATRACE_TAG, \"GraphicBuffer 1\"); width = height = stride = format = usage_deprecated = 0; atrace_end(ATRACE_TAG); usage = 0; layerCount = 0; handle = nullptr; } åŒæ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨å¯¹åº”å®å®šä¹‰ï¼š ATRACE_BEGIN(name); ATRACE_END(); æ‰§è¡Œåæ•ˆæœå¦‚ä¸‹ï¼š ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:4:2","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#421-atrace_call"},{"categories":null,"collections":"å·¥å…·","content":"4.2 æ¯”å¦‚å¸¸è§çš„å‡ ä¸ªæ–¹æ³•ï¼š 4.2.1 ATRACE_CALL() è¿™ä¸ªæ–¹æ³•ï¼Œä»£è¡¨å¯¹ä¸€ä¸ªfunctionçš„å¼€å¤´å’Œç»“å°¾è¿›è¡Œtagï¼Œå®ƒçš„æºç å¦‚ä¸‹ #define ATRACE_CALL() ATRACE_NAME(FUNCTION) å³æœ¬è´¨è°ƒç”¨çš„æ˜¯ATRACE_NAME 4.2.2 ATRACE_NAMEæ–¹æ³• è°ƒç”¨å¦‚ä¸‹ï¼š æ•ˆæœå¦‚ä¸‹ï¼š 4.2.3 traceç›¸å…³å®æˆ˜ä½¿ç”¨ï¼š 1ã€å¼•å…¥ç›¸å…³çš„å¤´æ–‡ä»¶åŠç›¸å…³åº“ #include ç¼–è¯‘æ—¶å€™è¿˜å¾—è€ƒç‡ç›¸å…³utilsçš„libæ˜¯å¦å¼•å…¥ å¦‚è¿™é‡Œä»¥æˆªå›¾ä»£ç ä¸ºä¾‹å°±æœ‰å¼•å…¥libutils frameworks/base/cmds/screencap/Android.bp cc_binary { name: \"screencap\", srcs: [\"screencap.cpp\"], shared_libs: [ \"libcutils\", \"libutils\", \"libbinder\", \"libjnigraphics\", \"libui\", \"libgui\", ], cflags: [ \"-Wall\", \"-Werror\", \"-Wunused\", \"-Wunreachable-code\", ], } 2ã€å®šä¹‰å¥½ç›¸å…³çš„TAG #undef ATRACE_TAG #define ATRACE_TAG ATRACE_TAG_GRAPHICS è¿™é‡Œå°±é€‰äº†ä¸€ä¸ªATRACE_TAG_GRAPHICSå³graphicsè¿™ä¸ªç»„ 3ã€è°ƒç”¨ç›¸å…³actraceæ–¹æ³• ATRACE_CALL ATRACE_NAME ä¸€èˆ¬é’ˆå¯¹æ•´ä¸ªæ–¹æ³•æˆ–è€…å•ç‹¬ä½œç”¨åŸŸï¼ŒATRACE_CALLå’ŒATRACE_NAMEæœ¬è´¨æ²¡æœ‰åŒºåˆ«ï¼Œåªæ˜¯æŠŠåå­—å˜æˆäº†functionçš„name å…·ä½“æ•ˆæœå¦‚ä¸‹ï¼š ä¼˜ç‚¹ï¼šåªéœ€è¦ä¸€ä¸ªè°ƒç”¨æ—¢å¯ä»¥å®ç°tagæ‰“å°ï¼Œè‡ªåŠ¨è·Ÿéšä½œç”¨åŸŸè¿›è¡Œtagçš„ç»“æŸ ç¼ºç‚¹ï¼šéœ€è¦è‡ªå·±ç†Ÿç»ƒæŒæ¡å¥½ä½œç”¨åŸŸï¼Œæ²¡æœ‰å¯ä»¥æ‰‹åŠ¨æ§åˆ¶çš„tagç»“æŸçš„ç‚¹ 4ã€ç›¸å…³çµæ´»æ§åˆ¶å¼€å§‹ä¸ç»“æŸçš„traceæ–¹æ³• ç›´æ¥ä½¿ç”¨atrace_beginå’Œatrace_endæ–¹æ³•ï¼Œä½¿ç”¨å¦‚ä¸‹ï¼š GraphicBuffer::GraphicBuffer() : BASE(), mOwner(ownData), mBufferMapper(GraphicBufferMapper::get()), mInitCheck(NO_ERROR), mId(getUniqueId()), mGenerationNumber(0) { ATRACE_NAME(\"GraphicBuffer::GraphicBuffer()1\"); atrace_begin(ATRACE_TAG, \"GraphicBuffer 1\"); width = height = stride = format = usage_deprecated = 0; atrace_end(ATRACE_TAG); usage = 0; layerCount = 0; handle = nullptr; } åŒæ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨å¯¹åº”å®å®šä¹‰ï¼š ATRACE_BEGIN(name); ATRACE_END(); æ‰§è¡Œåæ•ˆæœå¦‚ä¸‹ï¼š ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:4:2","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#422-atrace_nameæ–¹æ³•"},{"categories":null,"collections":"å·¥å…·","content":"4.2 æ¯”å¦‚å¸¸è§çš„å‡ ä¸ªæ–¹æ³•ï¼š 4.2.1 ATRACE_CALL() è¿™ä¸ªæ–¹æ³•ï¼Œä»£è¡¨å¯¹ä¸€ä¸ªfunctionçš„å¼€å¤´å’Œç»“å°¾è¿›è¡Œtagï¼Œå®ƒçš„æºç å¦‚ä¸‹ #define ATRACE_CALL() ATRACE_NAME(FUNCTION) å³æœ¬è´¨è°ƒç”¨çš„æ˜¯ATRACE_NAME 4.2.2 ATRACE_NAMEæ–¹æ³• è°ƒç”¨å¦‚ä¸‹ï¼š æ•ˆæœå¦‚ä¸‹ï¼š 4.2.3 traceç›¸å…³å®æˆ˜ä½¿ç”¨ï¼š 1ã€å¼•å…¥ç›¸å…³çš„å¤´æ–‡ä»¶åŠç›¸å…³åº“ #include ç¼–è¯‘æ—¶å€™è¿˜å¾—è€ƒç‡ç›¸å…³utilsçš„libæ˜¯å¦å¼•å…¥ å¦‚è¿™é‡Œä»¥æˆªå›¾ä»£ç ä¸ºä¾‹å°±æœ‰å¼•å…¥libutils frameworks/base/cmds/screencap/Android.bp cc_binary { name: \"screencap\", srcs: [\"screencap.cpp\"], shared_libs: [ \"libcutils\", \"libutils\", \"libbinder\", \"libjnigraphics\", \"libui\", \"libgui\", ], cflags: [ \"-Wall\", \"-Werror\", \"-Wunused\", \"-Wunreachable-code\", ], } 2ã€å®šä¹‰å¥½ç›¸å…³çš„TAG #undef ATRACE_TAG #define ATRACE_TAG ATRACE_TAG_GRAPHICS è¿™é‡Œå°±é€‰äº†ä¸€ä¸ªATRACE_TAG_GRAPHICSå³graphicsè¿™ä¸ªç»„ 3ã€è°ƒç”¨ç›¸å…³actraceæ–¹æ³• ATRACE_CALL ATRACE_NAME ä¸€èˆ¬é’ˆå¯¹æ•´ä¸ªæ–¹æ³•æˆ–è€…å•ç‹¬ä½œç”¨åŸŸï¼ŒATRACE_CALLå’ŒATRACE_NAMEæœ¬è´¨æ²¡æœ‰åŒºåˆ«ï¼Œåªæ˜¯æŠŠåå­—å˜æˆäº†functionçš„name å…·ä½“æ•ˆæœå¦‚ä¸‹ï¼š ä¼˜ç‚¹ï¼šåªéœ€è¦ä¸€ä¸ªè°ƒç”¨æ—¢å¯ä»¥å®ç°tagæ‰“å°ï¼Œè‡ªåŠ¨è·Ÿéšä½œç”¨åŸŸè¿›è¡Œtagçš„ç»“æŸ ç¼ºç‚¹ï¼šéœ€è¦è‡ªå·±ç†Ÿç»ƒæŒæ¡å¥½ä½œç”¨åŸŸï¼Œæ²¡æœ‰å¯ä»¥æ‰‹åŠ¨æ§åˆ¶çš„tagç»“æŸçš„ç‚¹ 4ã€ç›¸å…³çµæ´»æ§åˆ¶å¼€å§‹ä¸ç»“æŸçš„traceæ–¹æ³• ç›´æ¥ä½¿ç”¨atrace_beginå’Œatrace_endæ–¹æ³•ï¼Œä½¿ç”¨å¦‚ä¸‹ï¼š GraphicBuffer::GraphicBuffer() : BASE(), mOwner(ownData), mBufferMapper(GraphicBufferMapper::get()), mInitCheck(NO_ERROR), mId(getUniqueId()), mGenerationNumber(0) { ATRACE_NAME(\"GraphicBuffer::GraphicBuffer()1\"); atrace_begin(ATRACE_TAG, \"GraphicBuffer 1\"); width = height = stride = format = usage_deprecated = 0; atrace_end(ATRACE_TAG); usage = 0; layerCount = 0; handle = nullptr; } åŒæ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨å¯¹åº”å®å®šä¹‰ï¼š ATRACE_BEGIN(name); ATRACE_END(); æ‰§è¡Œåæ•ˆæœå¦‚ä¸‹ï¼š ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:4:2","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#423-traceç›¸å…³å®æˆ˜ä½¿ç”¨"},{"categories":null,"collections":"å·¥å…·","content":"4.3 javaç«¯çš„traceæ‰“å° appå±‚é¢æ—¶å€™ä¹Ÿæœ‰traceæ‰“å°æ–¹å¼ Trace.traceBegin(Trace.TRACE_TAG_ALWAYS,\"aaaaa\");//å¼€å§‹trace å­—ç¬¦ä¸ºaaaaa Trace.traceEnd(Trace.TRACE_TAG_ALWAYS);//ç»“æŸtrace æºç å¦‚ä¸‹ï¼š frameworks/base/core/java/android/os/Trace.java /** * Writes a trace message to indicate that a given section of code has * begun. Must be followed by a call to {@link #traceEnd} using the same * tag. * * @param traceTag The trace tag. * @param methodName The method name to appear in the trace. * * @hide */ @UnsupportedAppUsage @SystemApi(client = MODULE_LIBRARIES) public static void traceBegin(long traceTag, @NonNull String methodName) { if (isTagEnabled(traceTag)) { nativeTraceBegin(traceTag, methodName); } } /** * Writes a trace message to indicate that the current method has ended. * Must be called exactly once for each call to {@link #traceBegin} using the same tag. * * @param traceTag The trace tag. * * @hide */ @UnsupportedAppUsage @SystemApi(client = MODULE_LIBRARIES) public static void traceEnd(long traceTag) { if (isTagEnabled(traceTag)) { nativeTraceEnd(traceTag); } } å…·ä½“ä½¿ç”¨æ–¹æ³•ï¼š protected void onStart() { Trace.traceBegin(Trace.TRACE_TAG_ALWAYS,\"Settings Home onStart()\"); ((SettingsApplication) getApplication()).setHomeActivity(this); super.onStart(); doAidlHalCall(); Trace.traceEnd(Trace.TRACE_TAG_ALWAYS); } ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:4:3","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#43-javaç«¯çš„traceæ‰“å°"},{"categories":null,"collections":"å·¥å…·","content":"å‚è€ƒèµ„æ–™ perfetto å®˜æ–¹æ–‡æ¡£ Android Perfetto ç³»åˆ— 1ï¼šPerfetto å·¥å…·ç®€ä»‹ Android Perfetto ç³»åˆ— 3ï¼šç†Ÿæ‚‰ Perfetto View Perfettoåˆ†æè¿›é˜¶ perfetto/systraceåŸºç¡€çŸ¥è¯†è®²è§£ ä½¿ç”¨ Perfetto åˆ†æä½ çš„ Android åº”ç”¨æ€§èƒ½ ","date":"2024-11-06","objectID":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/:5:0","tags":["clippings","è½¬è½½","å·¥å…·","blog"],"title":"Perfetto ä½¿ç”¨æŒ‡å—","uri":"/posts/perfetto-%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#å‚è€ƒèµ„æ–™"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"è¯¥æ–‡ç« ä¸ºçª—å£å±‚çº§ç»“æ„ç³»åˆ—æ–‡ç« çš„æ€»ç»“ï¼Œé‡æ–°å›çœ‹è¿™æ–¹é¢å†…å®¹çš„æ—¶å€™æˆ‘è‡ªå·±ä¹Ÿæœ‰äº†ä¸€äº›æ–°çš„æ„Ÿæ‚Ÿï¼Œå¸Œæœ›é€šè¿‡æœ¬æ¬¡æ€»ç»“èƒ½è®©å¤§å®¶å†æ¬¡å¯¹çª—å£æœ‰ä¸€ä¸ªå…¨é¢çš„è®¤è¯†ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œå±å¹•ä¸Šæœ€èµ·ç åŒ…å«ä¸‰ä¸ªçª—å£ï¼ŒStatusBarçª—å£ã€Activityçª—å£ä»¥åŠNavigationBarçª—å£ï¼š æˆ‘ä»¬æƒ³è¦äº†è§£çª—å£ï¼Œå¯ä»¥æŒ‰ç…§ä»å°åˆ°å¤§ï¼Œä»è¡¨åˆ°é‡Œçš„é¡ºåºè¿›è¡Œï¼š 1ï¼‰ã€å¾®è§‚è§’åº¦ï¼Œæ¢ç©¶å•ä¸ªçª—å£å†…éƒ¨çš„ç»„æˆã€‚ 2ï¼‰ã€å®è§‚è§’åº¦ï¼Œæ¢ç©¶WMSå¦‚ä½•ç®¡ç†å±å¹•ä¸Šæ˜¾ç¤ºçš„è¯¸å¤šçª—å£ã€‚ 3ï¼‰ã€åº•å±‚è§’åº¦ï¼Œæ¢ç©¶SurfaceFlingerå¦‚ä½•ç®¡ç†çª—å£ï¼Œå’ŒWMSåœ¨è¿™æ–¹é¢æœ‰ä½•è”ç³»ã€‚ è‡³äºçª—å£ï¼Œæˆ‘ä»¬å…ˆç†è§£å®ƒä¸ºä¸€å—åœ¨å±å¹•ä¸Šå¯ä»¥æ˜¾ç¤ºå›¾åƒçš„åŒºåŸŸã€‚ ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"1 å¾®è§‚ä¸‹çš„Window â€”â€” Viewå±‚çº§ç»“æ„ çª—å£æœ¬èº«ä½œä¸ºViewå¯¹è±¡çš„å®¹å™¨åªæ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼ŒçœŸæ­£å¯è§çš„åˆ™æ˜¯Viewå¯¹è±¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¢ç©¶å•ä¸ªçª—å£çš„è¡¨ç°å½¢å¼ï¼Œå…¶å®å°±æ˜¯æ¢ç©¶ç»„æˆçª—å£çš„Viewå±‚çº§ç»“æ„ã€‚ è¿™é‡Œæˆ‘ä»¬å†™ä¸€ä¸ªå•é€‰æŒ‰é’®ç»„ï¼š \u003cRadioGroup android:id=\"@+id/radio_group\" android:layout_width=\"300dp\" android:layout_height=\"wrap_content\" android:layout_marginTop=\"50dp\" android:layout_marginStart=\"20dp\" android:background=\"@color/material_dynamic_neutral70\"\u003e \u003cRadioButton android:id=\"@+id/radio_button1\" android:layout_width=\"wrap_content\" android:layout_height=\"wrap_content\" android:text=\"A\" /\u003e \u003cRadioButton android:id=\"@+id/radio_button2\" android:layout_width=\"wrap_content\" android:layout_height=\"wrap_content\" android:text=\"B\" /\u003e \u003cRadioButton android:id=\"@+id/radio_button3\" android:layout_width=\"wrap_content\" android:layout_height=\"wrap_content\" android:text=\"C\" /\u003e \u003c/RadioGroup\u003e çœ‹èµ·æ¥æ˜¯è¿™æ ·å­ï¼š è¿™å·²ç»æ˜¯ä¸€ä¸ªç®€å•çš„Viewå±‚çº§ç»“æ„äº†ï¼Œçˆ¶Viewä¸ºRadioGroupï¼Œå…¶ä¸­æœ‰3ä¸ªRadioButtionçš„å­Viewï¼Œé‚£ä¹ˆå®ƒçš„å±‚çº§ç»“æ„å°±æ˜¯ï¼š æˆ‘ä¹‹å‰ä¹ æƒ¯ç”¨æ ‘çŠ¶å›¾çš„å½¢å¼ï¼š ä¸è¿‡ä¼¼ä¹è¿˜æ˜¯ç¬¬ä¸€ç§è¡¨ç°å½¢å¼æ›´å¥½ï¼Œèƒ½å¤Ÿæ›´åŠ ç›´è§‚çš„åæ˜ ä¸Šä¸‹çº§çš„å…³ç³»ï¼Œåé¢æè¿°å±‚çº§ç»“æ„çš„æ—¶å€™æˆ‘ä»ç„¶ç”¨æ ‘çŠ¶å›¾çš„ä¸€äº›å«æ³•ã€‚ Androidå¯¹æ­¤å±‚çº§ç»“æ„çš„å»ºç«‹æä¾›äº†å“ªäº›æ”¯æŒå‘¢ï¼Ÿ ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#1-å¾®è§‚ä¸‹çš„window--viewå±‚çº§ç»“æ„"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"1.1 æ¯ä¸€ä¸ªUIå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªView æ¯”å¦‚è¿™é‡Œçš„å•é€‰æŒ‰é’®RadioButtonç±»ï¼Œå®ƒçš„ç»§æ‰¿å…³ç³»ä¸ºï¼š RadioButtion -\u003e CompoundButton -\u003e Button -\u003e TextView -\u003e View RadioGroupç±»çš„ç»§æ‰¿å…³ç³»ä¸ºï¼š RadioGroup -\u003e LinearLayout -\u003e ViewGroup -\u003e View å°±åƒæ¯ä¸€ä¸ªç±»çš„åŸºç±»æ˜¯Objectä¸€æ ·ï¼Œæ¯ä¸€ä¸ªç”¨æ¥ç»„æˆActivityç•Œé¢çš„UIå…ƒç´ ï¼Œå…¶åŸºç±»éƒ½æ˜¯Viewç±»ï¼Œå› æ­¤æˆ‘ä¸ªäººå–œæ¬¢ç§°è¿™äº›ç”±UIå…ƒç´ æ­å»ºçš„ç»„ç»‡æ¶æ„ä¸ºViewå±‚çº§ç»“æ„ï¼Œå±‚çº§ç»“æ„é‡Œçš„æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªViewã€‚ ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#11-æ¯ä¸€ä¸ªuiå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªview"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"1.2 çˆ¶Viewå’Œå­View ä»¥åˆšåˆšçš„å•é€‰æŒ‰é’®ç»„ä¸ºä¾‹ï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªRadioGroupåŒ…å«äº†3ä¸ªRadioButtionï¼Œçˆ¶Viewä¸ºRadioGroupï¼Œå­Viewä¸º3ä¸ªRadioButtionã€‚ å›çœ‹RadioGroupï¼Œå®ƒæ˜¯ä¸€ç§ç‰¹æ®Šçš„Viewï¼Œç»§æ‰¿è‡ªViewGroupï¼ŒViewGroupé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ä¸€ç§èƒ½å¤ŸåŒ…å«å…¶å®ƒViewçš„ç‰¹æ®ŠViewï¼Œå®ƒæœ‰ä¸€ä¸ªViewæ•°ç»„ç±»å‹çš„æˆå‘˜å˜é‡mChildrenï¼š // frameworks\\base\\core\\java\\android\\view\\ViewGroup.java // Child views of this ViewGroup @UnsupportedAppUsage(maxTargetSdk = Build.VERSION_CODES.P) private View[] mChildren; ç”¨æ¥ä¿å­˜å®ƒå®¹çº³çš„å­Viewã€‚ æ—¢ç„¶çˆ¶Viewæœ‰ä¸€ä¸ªmChildrenç”¨æ¥æ‹¿åˆ°å­Viewå¯¹è±¡ï¼Œé‚£ä¹ˆå­Viewä¹Ÿåº”è¯¥æœ‰ä¸€ä¸ªæˆå‘˜å˜é‡ç”¨æ¥ä¿å­˜çˆ¶Viewçš„å¼•ç”¨ï¼Œå®é™…ä¸Šä¹Ÿçš„ç¡®å¦‚æ­¤ï¼ŒViewä¸­ä¹Ÿå®šä¹‰äº†ä¸€ä¸ªViewParentç±»å‹çš„æˆå‘˜å˜é‡mParentç”¨æ¥æŒ‡å‘å½“å‰Viewçš„çˆ¶Viewï¼š // frameworks\\base\\core\\java\\android\\view\\View.java /** * The parent this view is attached to. * {@hide} * * @see #getParent() */ @UnsupportedAppUsage(maxTargetSdk = Build.VERSION_CODES.P) protected ViewParent mParent; ViewParentæ˜¯ä¸€ä¸ªæ¥å£ç±»ï¼Œå®šä¹‰ä¸€ä¸ªèƒ½å¤Ÿä½œä¸ºçˆ¶Viewçš„ç±»çš„é€šç”¨æ¥å£ï¼Œè¿™é‡Œçœ‹åˆ°ViewGroupå°±å®ç°äº†è¿™ä¸ªæ¥å£ç±»ï¼š // frameworks\\base\\core\\java\\android\\view\\ViewGroup.java public abstract class ViewGroup extends View implements ViewParent, ViewManager é‚£ä¹ˆä¸ºä»€ä¹ˆä¸è®©Viewæ¥å®ç°ViewParentæ¥å£ï¼Œè€Œè®©ViewGroupæ¥å®ç°å‘¢ï¼Ÿä¸éš¾æƒ³åˆ°ï¼Œå¯¹äºå‚ä¸å»ºç«‹Viewå±‚çº§ç»“æ„çš„Viewæ¥è¯´ï¼Œå…¶å®å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç±»å°±åƒRadioButtionä¸€æ ·ï¼Œå®ƒä»¬æ˜¯Viewå±‚çº§ç»“æ„ä¸­çš„æœ€å°å•ä½ï¼Œæˆ–è€…å«åšViewå±‚çº§ç»“æ„ä¸­çš„å¶èŠ‚ç‚¹ï¼Œæ— æ³•ä½œä¸ºçˆ¶Viewå†å»å®¹çº³å…¶å®ƒå­Viewã€‚è€Œå¯¹äºRadioGroupï¼Œå®ƒä»¬ä½œä¸ºçˆ¶Viewå¯ä»¥å®¹çº³å…¶å®ƒå­Viewï¼Œåœ¨Viewå±‚çº§ç»“æ„ä¸­å……å½“ä¸­é—´èŠ‚ç‚¹ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥ä½œä¸ºå¶èŠ‚ç‚¹ï¼‰ã€‚ æœ€åè¯´ä¸‹å¦‚ä½•å‘ViewGroupä¸­æ·»åŠ å­Viewï¼Œç”¨çš„æ˜¯ViewGroup.addChildæ–¹æ³•ï¼š /** * Adds a child view with the specified layout parameters. * * \u003cp\u003e\u003cstrong\u003eNote:\u003c/strong\u003e do not invoke this method from * {@link #draw(android.graphics.Canvas)}, {@link #onDraw(android.graphics.Canvas)}, * {@link #dispatchDraw(android.graphics.Canvas)} or any related method.\u003c/p\u003e * * @param child the child view to add * @param index the position at which to add the child or -1 to add last * @param params the layout parameters to set on the child */ public void addView(View child, int index, LayoutParams params) æœ€ç»ˆä¼šå°†childå‚æ•°ä»£è¡¨çš„å­ViewåŠ å…¥åˆ°å½“å‰VIewGroup.mChildrenä¸­ï¼ŒåŒæ—¶å°†å­Viewçš„mParentæŒ‡å‘å½“å‰ViewGroupã€‚ LayoutInflaterè§£æxmlæ–‡ä»¶ï¼Œå…¶å®ä¹Ÿæ˜¯å®ä¾‹åŒ–xmlä¸­å®šä¹‰çš„Viewï¼Œç„¶åé€šè¿‡ViewGroup.addChildæ–¹æ³•å°†å­Viewæ·»åŠ åˆ°çˆ¶Viewä¸­ï¼Œä»¥è¿™ç§æ–¹å¼å°†xmlæ–‡ä»¶ä¸­å®šä¹‰çš„Viewå±‚çº§ç»“æ„å»ºç«‹èµ·æ¥ã€‚ ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:1:2","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#12-çˆ¶viewå’Œå­view"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"1.3 æ ¹View å¯¹äºæ‰€æœ‰ç»„æˆåŒä¸€ä¸ªActivityç•Œé¢çš„UIå…ƒç´ ï¼Œå®ƒä»¬éƒ½åœ¨åŒä¸€ä¸ªå±‚çº§ç»“æ„ä¸­ï¼Œè‡ªç„¶å®ƒä»¬éƒ½æœ‰ä¸€ä¸ªå…±åŒçš„æ ¹Viewï¼Œé‚£è¿™ä¸ªæ ¹Viewæ˜¯è°ï¼Ÿ æˆ‘ä»¬æ–°å»ºä¸€ä¸ªActivityï¼Œä¸€èˆ¬æ¥è¯´éƒ½åœ¨å…¶onCreateæ–¹æ³•ä¸­å»åŠ è½½å…¶å¸ƒå±€ï¼Œæ¯”å¦‚åƒè¿™æ ·ï¼š @Override protected void onCreate(@Nullable Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_pip); } é‚£é€šè¿‡è§£æè¿™ä¸ª R.layout.activity_pip å¯¹åº”çš„xmlæ–‡ä»¶æ‰€ç”Ÿæˆçš„Viewå°±æ˜¯æ ¹Viewå—ï¼Œä»ç„¶æ‹¿è¿™é‡Œçš„demoè¿›è¡ŒéªŒè¯ï¼Œæˆ‘è‡ªå·±å®šä¹‰çš„actiivty_pip.xmlæ˜¯ä¸€ä¸ªLInearLayoutï¼Œé‡Œé¢åŒ…å«äº†ä¸¤ä¸ªå•é€‰æŒ‰é’®ç»„ã€‚éœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸ªLinearLayoutæœ‰ä¸€ä¸ªä¸ä¸ºâ€œmatch_parentâ€çš„è‡ªå®šä¹‰é«˜åº¦ï¼Œå¹¶ä¸”è®¾ç½®äº†ä¸€ä¸ªèƒŒæ™¯è‰²ï¼Œå…¶å±‚çº§ç»“æ„ä¸ºï¼š çœ‹ä¸‹å®é™…æƒ…å†µï¼š å¯¹äºå®ƒæ²¡æœ‰è¦†ç›–åˆ°çš„åŒºåŸŸï¼Œä»æœ‰ä¸€ä¸ªç™½è‰²èƒŒæ™¯ï¼Œè¯´æ˜è¿™ä¸ªLinearLayoutå¹¶ä¸æ˜¯æ ¹Viewã€‚ å¦‚æœæƒ³è¦æ‰¾åˆ°æ ¹Viewï¼Œå°±éœ€è¦å»è·Ÿè¸ªActivity.setContentViewæµç¨‹ï¼Œè¿™ä¸ªæµç¨‹æˆ‘ä¹‹å‰æœ‰æ€»ç»“è¿‡æ–‡æ¡£ï¼Œè¿™é‡Œå°±ä¸å†å…·ä½“å™è¿°ï¼Œç›´æ¥æ”¾ç»“è®ºï¼Œæ˜¯DecorViewã€‚ ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:1:3","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#13-æ ¹view"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"1.4 Viewå±‚çº§ç»“æ„çš„ç”Ÿæˆ çœ‹ä¸‹Viewå±‚çº§ç»“æ„ç”Ÿæˆçš„æµç¨‹ï¼Œå³Activity.setContentViewæ–¹æ³•æµç¨‹ï¼Œåªè¯´å…³é”®éƒ¨åˆ†ã€‚ 1ï¼‰ã€åˆ›å»ºDecorViewå®ä¾‹ã€‚ 2ï¼‰ã€æ ¹æ®Activityè¯·æ±‚çš„featureï¼ˆæ¯”å¦‚æ˜¯å¦éœ€è¦æ ‡é¢˜ã€å›¾æ ‡ï¼‰æ¥å†³å®šDecorViewçš„ç›´æ¥å­Viewçš„å¸ƒå±€ç±»å‹ï¼Œæˆ‘è¿™é‡Œçš„æ˜¯ R.layout.screen_simpleï¼š // frameworks/base/core/res/res/layout/screen_simple.xml \u003cLinearLayout xmlns:android=\"http://schemas.android.com/apk/res/android\" android:layout_width=\"match_parent\" android:layout_height=\"match_parent\" android:fitsSystemWindows=\"true\" android:orientation=\"vertical\"\u003e \u003cViewStub android:id=\"@+id/action_mode_bar_stub\" android:inflatedId=\"@+id/action_mode_bar\" android:layout=\"@layout/action_mode_bar\" android:layout_width=\"match_parent\" android:layout_height=\"wrap_content\" android:theme=\"?attr/actionBarTheme\" /\u003e \u003cFrameLayout android:id=\"@android:id/content\" android:layout_width=\"match_parent\" android:layout_height=\"match_parent\" android:foregroundInsidePadding=\"false\" android:foregroundGravity=\"fill_horizontal|top\" android:foreground=\"?android:attr/windowContentOverlay\" /\u003e \u003c/LinearLayout\u003e å…·ä½“ä¸ºä¸€ä¸ªLinearLayoutåŒ…å«ä¸€ä¸ªViewStubå’ŒFrameLayoutã€‚ æ¥ç€å°†è¿™ä¸ªxmlå®ä¾‹åŒ–ä¸ºä¸€ä¸ªViewå±‚çº§ç»“æ„ï¼Œå°†è¯¥å±‚çº§ç»“æ„çš„æ ¹èŠ‚ç‚¹ä½œä¸ºå­ViewåŠ å…¥åˆ°DecorViewä¸­ï¼š 3ï¼‰ã€æ¥ç€é€šè¿‡LayoutInflater.inflateè§£ææˆ‘ä»¬é€šè¿‡Activity.setContentViewä¼ å…¥çš„xmlæ–‡ä»¶ï¼ŒæŒ‡å®šå…¶çˆ¶Viewä¸ºä¸Šä¸€æ­¥è§£æçš„screen_simple.xmlä¸­å®šä¹‰çš„IDä¸ºï¼š /** * The ID that the main layout in the XML layout file should have. */ public static final int ID_ANDROID_CONTENT = com.android.internal.R.id.content; çš„Viewï¼Œå°†æˆ‘ä»¬è‡ªå®šä¹‰çš„å¸ƒå±€ä½œä¸ºå­Viewæ·»åŠ åˆ°è¯¥Viewä¸Šï¼Œç”Ÿæˆæœ€ç»ˆçš„å±‚çº§ç»“æ„ï¼š ç”¨â€Legacy Layout Inspectorâ€œæ’ä»¶çœ‹æ˜¯ï¼š 4ï¼‰ã€å›çœ‹æˆ‘ä»¬ä¹‹å‰çš„Activityç•Œé¢ï¼š èƒ½çœ‹åˆ°é¡¶éƒ¨å’Œåº•éƒ¨åˆ†åˆ«è¿˜æœ‰ä¸€ä¸ªåŒºåŸŸï¼Œå¦‚æœæˆ‘ä»¬çš„Activityä¸è¦æ±‚éšè—çŠ¶æ€æ å’Œå¯¼èˆªæ ï¼Œé‚£ä¹ˆä¼šåˆ›å»ºä¸¤ä¸ªViewï¼š çŠ¶æ€æ èƒŒæ™¯åŒºåŸŸï¼Œcom.android.internal.R.id.statusBarBackgroundã€‚ å¯¼èˆªæ èƒŒæ™¯åŒºåŸŸï¼Œcom.android.internal.R.id.navigationBarBackgroundã€‚ å½“çŠ¶æ€æ çª—å£å’Œå¯¼èˆªæ çª—å£ç›–åœ¨æˆ‘ä»¬çš„Activityçª—å£ä¸Šæ—¶ï¼Œè¿™ä¸¤ä¸ªåŒºåŸŸå°±æ˜¯å®ƒä»¬çš„èƒŒæ™¯ã€‚ DecorViewå°†è¿™ä¸¤ä¸ªViewä½œä¸ºå­ViewåŠ å…¥å…¶ä¸­ï¼Œå’Œå­˜æ”¾æˆ‘ä»¬è‡ªå®šä¹‰å¸ƒå±€çš„LinearLayoutï¼ˆå†…éƒ¨å±‚çº§è¢«æŠ˜å ï¼‰åŒçº§ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š å¹¶ä¸”å¯¹LinearLayoutè®¾ç½®å†…å¤–è¾¹è·ï¼Œä»è€Œé¿å…æˆ‘ä»¬çš„è‡ªå®šä¹‰åŒºåŸŸä¼¸å»¶åˆ°è¿™äº›ä¸ºç³»ç»Ÿçª—å£é¢„ç•™çš„èƒŒæ™¯åŒºåŸŸä¸­ï¼Œä»¥é˜²æˆ‘ä»¬æœŸæœ›æ˜¾ç¤ºçš„å†…å®¹è¢«è¿™äº›ç³»ç»Ÿçª—å£è¦†ç›–ã€‚ ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:1:4","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#14-viewå±‚çº§ç»“æ„çš„ç”Ÿæˆ"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"1.5 ViewRootImpl â€”â€” å®é™…çš„æ ¹èŠ‚ç‚¹ï¼Ÿ ViewRootImplï¼Œä¸ç®¡æ˜¯å¼€å‘Appè¿˜æ˜¯åšFrameworkï¼Œéƒ½å°‘ä¸äº†è·Ÿå®ƒæ‰“äº¤é“ï¼Œä»åå­—ä¸Šæ¥çœ‹ï¼Œå®ƒä¼¼ä¹æ˜¯ä½œä¸ºæ ¹Viewçš„è§’è‰²æ‰€å­˜åœ¨ï¼Œé‚£ä¹ˆäº‹å®ä¸Šå¦‚ä½•å‘¢ï¼Ÿ ä¸ç®¡æ˜¯Activityçª—å£è¿˜æ˜¯éActivityçª—å£ï¼Œæœ€ç»ˆéƒ½è¦é€šè¿‡ViewRootImpl.setViewå‘WMSæ³¨å†Œçª—å£ï¼š /** * We have one child */ public void setView(View view, WindowManager.LayoutParams attrs, View panelParentView, int userId) { synchronized (this) { if (mView == null) { mView = view; // ...... try { // ...... res = mWindowSession.addToDisplayAsUser(mWindow, mWindowAttributes, getHostVisibility(), mDisplay.getDisplayId(), userId, mInsetsController.getRequestedVisibilities(), inputChannel, mTempInsets, mTempControls); // ...... } // ...... view.assignParent(this); // ...... } } } å€¼å¾—æ³¨æ„çš„æ˜¯ä»¥ä¸‹å‡ ç‚¹ï¼š 1ï¼‰ã€å°†Viewç±»å‹çš„ä¼ å‚viewèµ‹å€¼ç»™Viewç±»å‹çš„æˆå‘˜å˜é‡mViewï¼Œè¿™é‡Œçš„ä¼ å‚viewæ˜¯ä¸€ä¸ªçª—å£çš„Viewå±‚çº§ç»“æ„çš„é¡¶çº§Viewï¼Œå¯¹äºActivityçª—å£æ¥è¯´ï¼Œå°±æ˜¯DecorViewï¼Œè€Œå¯¹äºéActivityçª—å£ï¼Œå¦‚çŠ¶æ€æ å’Œå¯¼èˆªæ ï¼Œè¿™äº›çª—å£çš„Viewå±‚çº§ç»“æ„å®Œå…¨ç”±å®ƒä»¬è‡ªå®šä¹‰ï¼Œä¸ä¼šåƒActivityçª—å£é‚£æ ·å†ç”±Frameworkç»™å®ƒä»¬å¤–é¢å†å¥—å‡ ä¸ªlayoutï¼Œè¿™é‡Œçš„ä¼ å‚viewå°±æ˜¯è¿™äº›çª—å£çš„è‡ªå®šä¹‰Viewå±‚çº§ç»“æ„çš„é¡¶çº§Viewã€‚ åç»­ViewRootImplå°±å¯ä»¥é€šè¿‡å…¶æˆå‘˜å˜é‡mViewæ‹¿åˆ°é¡¶çº§Viewã€‚ 2ï¼‰ã€æ¥ç€é€šè¿‡IWindowSession.addToDisplayAsUserå‘WMSæ·»åŠ çª—å£ã€‚ 3ï¼‰ã€æœ€åè°ƒç”¨View.assignParentæ–¹æ³•ï¼Œå°†ä¼ å‚Viewçš„mParentæŒ‡å‘å½“å‰ViewRootImplï¼š @UnsupportedAppUsage void assignParent(ViewParent parent) { if (mParent == null) { mParent = parent; } // ....... } é‚£ä¹ˆå¯¹äºActivityçª—å£æ¥è¯´ï¼Œå…¶DecorViewè¿˜æœ‰ä¸€ä¸ªçˆ¶Viewï¼ŒViewRootImplï¼Ÿ ä½†æ˜¯å†çœ‹ViewRootImplçš„å®šä¹‰ï¼š public final class ViewRootImpl implements ViewParent, View.AttachInfo.Callbacks, ThreadedRenderer.DrawCallbacks, AttachedSurfaceControl { ViewRootImplå¹¶ä¸æ˜¯ä¸€ä¸ªViewå¯¹è±¡ï¼Œå› æ­¤å®ƒå¹¶æ²¡æœ‰ä¸€ä¸ªå¯è§†çš„å†…å®¹ã€‚ ViewRootImplä¹Ÿä¸æ˜¯ä¸€ä¸ªViewGroupï¼Œå› æ­¤æ²¡æœ‰mChildrenæ¥ä¿å­˜å…¶å­Viewï¼Œæ‰€ä»¥å®ƒæ‰æ–°å»ºäº†ä¸€ä¸ªmViewæˆå‘˜å˜é‡æ¥ä¿å­˜å…¶å”¯ä¸€çš„å­Viewï¼Œå¯¹äºActivityçª—å£æ¥è¯´ï¼ŒViewRootImplçš„å”¯ä¸€å­Viewå°±æ˜¯DecorViewã€‚ é‚£ä¹ˆæŠŠViewRootImplè§†ä¸ºçœŸæ­£çš„æ ¹Viewï¼Œè™½ä¹Ÿæœªå°ä¸å¯ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„ï¼Œæˆ‘ä»¬ä¹‹å‰è¯´çš„ä»¥DecorViewä¸ºæ ¹èŠ‚ç‚¹çš„Viewå±‚çº§ç»“æ„ï¼Œå®ƒçš„æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªå¯è§†çš„Viewï¼Œè€ŒViewRootImplåªæ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼Œç›¸æ¯”äºDecorViewè¿™ç§â€œå®ä½“â€æ ¹èŠ‚ç‚¹ï¼Œå®ƒæ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„æ ¹èŠ‚ç‚¹ã€‚è¿™ä¸ç¦è®©äººæ€è€ƒï¼ŒViewRootImplä¸ºå•¥è¦è¿™ä¹ˆå–åï¼Ÿ é‚£å°±è¦çœ‹çœ‹ViewRootImplæ‰®æ¼”äº†æ€æ ·çš„è§’è‰²ï¼Œä¸Šé¢åˆ†æè¿‡ï¼ŒViewRootImplä¿å­˜äº†Viewå±‚çº§ç»“æ„çš„é¡¶çº§Viewçš„å¼•ç”¨ï¼ˆä¸ºæ•°ä¸å¤šçš„ä¿å­˜é¡¶çº§Viewå¼•ç”¨çš„åœ°æ–¹ä¹‹ä¸€ï¼‰ï¼Œé‚£ä¹ˆå¾ˆå¤šéœ€è¦éå†Viewå±‚çº§ç»“æ„çš„æµç¨‹éƒ½ä¼šä»ViewRootImplå‘èµ·ã€‚æ¯”å¦‚ï¼Œç»å…¸çš„measureæµç¨‹ï¼Œä¾¿æ˜¯é€šè¿‡ViewRootImpl.performMeasureæ–¹æ³•å‘èµ·ï¼š private void performMeasure(int childWidthMeasureSpec, int childHeightMeasureSpec) { if (mView == null) { return; } Trace.traceBegin(Trace.TRACE_TAG_VIEW, \"measure\"); try { mView.measure(childWidthMeasureSpec, childHeightMeasureSpec); } finally { Trace.traceEnd(Trace.TRACE_TAG_VIEW); } } ViewRootImplå…ˆè°ƒç”¨å…¶ç›´æ¥å­Viewçš„measureæ–¹æ³•ï¼Œå†ç”±è¯¥å­Viewè°ƒç”¨å­å­Viewçš„measureæ–¹æ³•ï¼Œä¾æ¬¡ç±»æ¨ï¼Œæœ€ç»ˆæ•´ä¸ªViewå±‚çº§ç»“æ„ä¸­çš„æ‰€æœ‰Viewçš„measureæ–¹æ³•éƒ½èƒ½å¤Ÿå¾—åˆ°è°ƒç”¨ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œlayoutæµç¨‹å’Œdrawæµç¨‹ï¼ŒInputäº‹ä»¶çš„ä¼ é€’ä»¥åŠInsetsçš„æ›´æ–°ï¼Œå¤§éƒ¨åˆ†éœ€è¦éå†Viewå±‚çº§ç»“æ„çš„æµç¨‹ï¼Œèµ·ç‚¹éƒ½æ˜¯åœ¨ViewRootImplã€‚ å°½ç®¡å¦‚æ­¤ï¼Œå¯¹äºActivityçª—å£ï¼Œæˆ‘ä¸ªäººä»ç„¶å€¾å‘äºç§°DecorViewä¸ºçš„Viewå±‚çº§ç»“æ„çš„æ ¹Viewã€‚ ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:1:5","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#15-viewrootimpl--å®é™…çš„æ ¹èŠ‚ç‚¹"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"1.6 Freeformçš„å®ç° è¿™é‡Œæ ¹æ®Freeformçš„å®ç°æ–¹å¼ï¼Œæ¥éªŒè¯ä¸€ä¸‹æˆ‘ä»¬ä¸Šé¢çš„åˆ†æå†…å®¹ã€‚ è¿™é‡Œåªå…³å¿ƒFreeformæ˜¯å¦‚ä½•ä¸ºActivityæ·»åŠ åŒ…å«æœ€å¤§åŒ–æŒ‰é’®å’Œé€€å‡ºæŒ‰é’®çš„æ ‡é¢˜æ ã€‚ å¦‚æœè®©æˆ‘ä»¬è‡ªå·±å†™ä¸€ä¸ªè¿™ä¸ªå½¢å¼çš„ç•Œé¢ï¼Œä¹Ÿéå¸¸å®¹æ˜“ï¼Œåªéœ€è¦ä¸€ä¸ªLInearLayoutåŒ…å«ä¸¤ä¸ªButtonå³å¯ï¼š ä½†æ˜¯å¦‚æœæƒ³è¦ä¸ºæ¯ä¸€ä¸ªè¿›å…¥Freeformçš„Activityéƒ½è‡ªåŠ¨è®¾ç½®è¿™æ ·ä¸€ä¸ªæ ‡é¢˜æ ï¼Œå°±å¾—é Frameworkå»ç»Ÿä¸€å¤„ç†ã€‚ googleçš„åšæ³•å¦‚ä¸‹ï¼š 1ï¼‰ã€å®ä¾‹åŒ–ä¸€ä¸ªDecorCaptionViewï¼Œå®ƒé€šè¿‡xmlæ–‡ä»¶å®šä¹‰ï¼š \u003ccom.android.internal.widget.DecorCaptionView xmlns:android=\"http://schemas.android.com/apk/res/android\" android:orientation=\"vertical\" android:layout_width=\"match_parent\" android:layout_height=\"match_parent\" android:descendantFocusability=\"beforeDescendants\" \u003e \u003cLinearLayout android:id=\"@+id/caption\" android:layout_width=\"match_parent\" android:layout_height=\"wrap_content\" android:gravity=\"end\" android:background=\"@drawable/decor_caption_title\" android:focusable=\"false\" android:descendantFocusability=\"blocksDescendants\" \u003e \u003cButton android:id=\"@+id/maximize_window\" android:layout_width=\"32dp\" android:layout_height=\"32dp\" android:layout_margin=\"5dp\" android:padding=\"4dp\" android:layout_gravity=\"center_vertical|end\" android:contentDescription=\"@string/maximize_button_text\" android:background=\"@drawable/decor_maximize_button_dark\" /\u003e \u003cButton android:id=\"@+id/close_window\" android:layout_width=\"32dp\" android:layout_height=\"32dp\" android:layout_margin=\"5dp\" android:padding=\"4dp\" android:layout_gravity=\"center_vertical|end\" android:contentDescription=\"@string/close_button_text\" android:background=\"@drawable/decor_close_button_dark\" /\u003e \u003c/LinearLayout\u003e \u003c/com.android.internal.widget.DecorCaptionView\u003e æœ‰ä¸€ä¸ªLInearLayoutï¼ŒåŒ…å«äº†ä¸¤ä¸ªæŒ‰é’®ï¼š 2ï¼‰ã€å®ä¾‹åŒ–ä¸€ä¸ªDecorCaptionViewåï¼Œæˆ‘ä»¬åŸå…ˆçš„Activityçª—å£å±‚çº§ç»“æ„æ˜¯ï¼ˆå¿½ç•¥å…·ä½“çš„ç»†èŠ‚éƒ¨åˆ†ï¼‰ï¼š æ¥ç€DecorViewå°†DecorCaptionViewä½œä¸ºå­Viewæ·»åŠ è¿›æ¥ï¼Œæ¥ç€å°†åŸå…ˆçš„å”¯ä¸€å­Viewç§»é™¤ï¼Œå¹¶ä¸”å°†å…¶ä½œä¸ºå­Viewæ·»åŠ åˆ°DecorCaptionViewä¸­ï¼Œå³ï¼š ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:1:6","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#16-freeformçš„å®ç°"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"2 å®è§‚ä¸‹çš„Window â€”â€” WindowContainerå±‚çº§ç»“æ„ ä¸Šä¸€èŠ‚ä»¥å¾®è§‚çš„è§’åº¦å»æ¢ç©¶ä¸€ä¸ªçª—å£çš„ç»„æˆï¼Œå³Viewå±‚çº§ç»“æ„ã€‚ è¿™ä¸€èŠ‚ä»¥å®è§‚çš„è§’åº¦ï¼ŒæŠŠçª—å£å½“ä½œWMSçª—å£ä½“ç³»ä¸‹çš„æœ€å°å•ä½ï¼Œå»æ¢ç©¶WMSæ˜¯å¦‚ä½•ç®¡ç†çª—å£çš„ã€‚ ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:2:0","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#2-å®è§‚ä¸‹çš„window--windowcontainerå±‚çº§ç»“æ„"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"2.1 çª—å£ â€”â€” WindowStateç±» /** A window in the window manager. */ public class WindowState extends WindowContainer\u003cWindowState\u003e implements WindowManagerPolicy.WindowState, InsetsControlTarget { åœ¨WMSçª—å£ä½“ç³»ä¸­ï¼Œä¸€ä¸ªWindowStateå¯¹è±¡å°±ä»£è¡¨äº†ä¸€ä¸ªçª—å£ã€‚ è¿™é‡Œçœ‹åˆ°ï¼ŒWindowStateç»§æ‰¿è‡ªWindowContainerã€‚ ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:2:1","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#21-çª—å£--windowstateç±»"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"2.2 çª—å£å®¹å™¨ç±» â€”â€” WindowContainerç±» /** * Defines common functionality for classes that can hold windows directly or through their * children in a hierarchy form. * The test class is {@link WindowContainerTests} which must be kept up-to-date and ran anytime * changes are made to this class. */ class WindowContainer\u003cE extends WindowContainer\u003e extends ConfigurationContainer\u003cE\u003e implements Comparable\u003cWindowContainer\u003e, Animatable, SurfaceFreezer.Freezable { WindowContainerå®šä¹‰äº†èƒ½å¤Ÿç›´æ¥æˆ–è€…é—´æ¥ä»¥å±‚çº§ç»“æ„çš„å½¢å¼æŒæœ‰çª—å£çš„ç±»çš„é€šç”¨åŠŸèƒ½ã€‚ ä»ç±»çš„å®šä¹‰å’Œåç§°ï¼Œå¯ä»¥çœ‹åˆ°WindowContaineræ˜¯ä¸€ä¸ªå®¹å™¨ç±»ï¼Œå¯ä»¥å®¹çº³WindowContaineråŠå…¶å­ç±»å¯¹è±¡ã€‚å¦‚æœæœ‰ä¸€ä¸ªå®¹å™¨ç±»æƒ³ä½œä¸ºWindowStateçš„å®¹å™¨ï¼Œé‚£ä¹ˆè¿™ä¸ªå®¹å™¨ç±»éœ€è¦ç»§æ‰¿WindowContaineræˆ–å…¶å­ç±»ã€‚ ç»§ç»­çœ‹ä¸‹ï¼ŒWindowContainerä¸ºäº†èƒ½å¤Ÿä½œä¸ºä¸€ä¸ªå®¹å™¨ç±»ï¼Œæä¾›äº†å“ªäº›æ”¯æŒï¼š /** * The parent of this window container. * For removing or setting new parent {@link #setParent} should be used, because it also * performs configuration updates based on new parent's settings. */ private WindowContainer\u003cWindowContainer\u003e mParent = null; // ...... // List of children for this window container. List is in z-order as the children appear on // screen with the top-most window container at the tail of the list. protected final WindowList\u003cE\u003e mChildren = new WindowList\u003cE\u003e(); mParentï¼Œä¿å­˜çš„æ˜¯å½“å‰WindowContainerçš„çˆ¶WindowContainerçš„å¼•ç”¨ï¼Œå¯ä»¥ç±»æ¯”äºView.mParentã€‚ mChidlrenï¼Œä¿å­˜çš„æ˜¯å½“å‰WindowContainerä½œä¸ºä¸€ä¸ªå®¹å™¨ï¼Œæ‰€åŒ…å«çš„å­WindowContainerï¼Œå¯ä»¥ç±»æ¯”äºViewGroup.mChildrenã€‚å®ƒæ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œåˆ—è¡¨çš„é¡ºåºåæ˜ äº†å­å®¹å™¨åœ¨Zè½´ä¸Šçš„é¡ºåºï¼Œè¶Šé è¿‘é˜Ÿå°¾å±‚çº§è¶Šé«˜ã€‚ è¿™ä¸¤ä¸ªæˆå‘˜å˜é‡ä¸ºç”ŸæˆWindowContainerå±‚çº§ç»“æ„æä¾›äº†æ”¯æŒï¼Œå°±åƒæ ¹æ®View.mParentå’ŒViewGroup.mChildrenåˆ›å»ºViewå±‚çº§ç»“æ„é‚£æ ·ã€‚ å®¹å™¨è¿™ä¸ªæ¦‚å¿µéå¸¸é‡è¦ï¼Œç†è§£äº†å®ƒæ‰èƒ½ç†è§£WindowContainerå±‚çº§ç»“æ„çš„ç»„ç»‡å½¢å¼ã€‚ä¸ºäº†ç†è§£å®¹å™¨è¿™ä¸ªæ¦‚å¿µï¼Œå¯ä»¥æŠŠWindowContaineræ¯”ä½œä¸€ä¸ªå †æ ˆï¼Œè¿™é‡Œä¸¾å‡ ä¸ªä¾‹å­æ–¹ä¾¿ç†è§£ï¼š 1ï¼‰ã€å½“å‰WindowContainerå·²ç»è¿ç»­æ·»åŠ äº†ä¸¤ä¸ªå­å®¹å™¨ï¼ŒWindowContainer_Aä»¥åŠWindowContainer_Bï¼Œç»§ç»­æ·»åŠ WindowContainer_Cï¼Œå°±å¯ä»¥çœ‹ä½œæ˜¯åƒå½“å‰å †æ ˆæ ˆé¡¶å…¥æ ˆä¸€ä¸ªWindowContainer_Cï¼š è¿™é‡Œç”¨å †æ ˆæ¥è¡¨ç¤ºä¸€ä¸ªWindowContainerä¹Ÿæ˜¯å› ä¸ºå †æ ˆæ¯”è¾ƒèƒ½å¤Ÿç›´è§‚çš„åæ˜ WindowContainerå†…éƒ¨çš„Zè½´é¡ºåºï¼ŒWindowContainerå±‚çº§ç»“æ„å’ŒViewå±‚çº§ç»“æ„æ˜¯æœ‰ç›¸ä¼¼ä¹‹å¤„çš„ï¼ŒViewGroupä¹Ÿå¯ä»¥çœ‹ä½œæ˜¯Viewçš„å®¹å™¨ï¼Œä½†æ˜¯æˆ‘ä¸ªäººæ„Ÿè§‰Viewå±‚çº§ç»“æ„ä¸­çš„Zè½´è¿™ä¸ªæ¦‚å¿µç¨å¾®å¼±äº†ä¸€ç‚¹ï¼Œæ‰€ä»¥ä¹‹å‰æ²¡æœ‰ç”¨å †æ ˆçš„è¡¨ç°å½¢å¼ã€‚ å †æ ˆçš„è¡¨ç°å½¢å¼è™½å¥½ï¼Œä½†æ˜¯å½“å±‚çº§ç»“æ„ç¨å¾®å¤æ‚ä¸€ç‚¹çš„è¯ï¼Œç”»èµ·æ¥å°±éå¸¸éº»çƒ¦ï¼Œè€Œä¸”å‘ˆç°å‡ºæ¥çš„å½¢å¼ä¹Ÿä¸å¤Ÿç›´è§‚ï¼Œè¿™é‡Œè½¬ä¸ºæˆ‘ä¸ªäººæ¯”è¾ƒä¹ æƒ¯çš„å±‚çº§ç»“æ„å›¾ï¼š è¿™ä¸ªå›¾å…¶å®ä¹Ÿèƒ½åæ˜ å±‚çº§é¡ºåºï¼Œè¿™é‡Œæ˜¯WindowContainer_Cé«˜äºWindowContainer_Bé«˜äºWindowContainer_Aã€‚ 2ï¼‰ã€ç¨å¾®æ‰©å±•ä¸€ç‚¹ï¼Œå½“å‰WindowContaineræœ‰ä¸¤ä¸ªå­WindowContainerï¼ŒåŒæ—¶è¿™ä¸¤ä¸ªå­WindowContainerä¹Ÿåˆ†åˆ«æœ‰å„è‡ªçš„å­WindowContainerã€‚ è½¬ä¸ºå±‚çº§ç»“æ„å›¾ï¼š æœ‰ä¸¤ç‚¹éœ€è¦æ³¨æ„ï¼š ä½äºåŒä¸€ä¸ªçˆ¶å®¹å™¨ä¸­çš„WindowContainerå¯ä»¥ç›´æ¥è¿›è¡Œæ¯”è¾ƒã€‚åœ¨WindowContainer_Bä¸­ï¼Œå¾ˆæ˜æ˜¾çš„èƒ½å¤Ÿçœ‹åˆ°WindowContainer_Gé«˜äºWindowContainer_Fé«˜äºWindowContainer_Eã€‚ ä½äºä¸åŒçˆ¶å®¹å™¨çš„ä¸¤ä¸ªWindowContainerä¸èƒ½ç›´æ¥è¿›è¡Œæ¯”è¾ƒã€‚è¿™é‡Œå¦‚æœæˆ‘ä»¬æƒ³æ¯”è¾ƒWindowContainer_Gå’ŒWindowContainer_Dè°çš„å±‚çº§é«˜ï¼Œå°±éœ€è¦æ¯”è¾ƒå®ƒä»¬ä¸¤ä¸ªçš„çˆ¶å®¹å™¨è°çš„å±‚çº§é«˜ã€‚è¿™é‡Œçœ‹åˆ°WindowContainer_Aå’ŒWindowContainer_Béƒ½ä½äºåŒä¸€ä¸ªçˆ¶å®¹å™¨ä¸­ï¼Œæ‰€ä»¥å¯ä»¥å¾—å‡ºWindowContainer_Bé«˜äºWindowContainer_Aï¼Œè¿›è€ŒWindowContainer_Gé«˜äºWindowContainer_Dã€‚å¦‚æœWindowContainer_Aå’ŒWindowContainer_Bä¹Ÿæ²¡æœ‰å¤„äºåŒä¸€ä¸ªçˆ¶å®¹å™¨ä¸­ï¼Œé‚£ä¹ˆå°±å¾—ç»§ç»­æ²¿ç€å±‚çº§ç»“æ„å›¾å¾€ä¸Šæ‰¾ï¼Œç›´åˆ°æ‰¾å‡ºå¤„äºåŒä¸€ä¸ªèŠ‚ç‚¹ä¸‹çš„ä¸¤ä¸ªçˆ¶å®¹å™¨ã€‚ æ­¤æ—¶å›çœ‹WindowStateç±»çš„å®šä¹‰ï¼š public class WindowState extends WindowContainer\u003cWindowState\u003e æœ‰äº†æ–°çš„å‘ç°ï¼Œå³WindowStateæœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œä¸è¿‡è¿™é‡ŒæŒ‡æ˜äº†WindowStateä½œä¸ºå®¹å™¨ç±»å¯ä»¥æŒæœ‰çš„å®¹å™¨ç±»å‹é™å®šä¸ºWindowStateç±»å‹ï¼Œå³WindowStateä½œä¸ºçˆ¶å®¹å™¨ï¼Œå…¶ä¸­åªèƒ½å­˜æ”¾WindowStateç±»å‹çš„WindowContainerã€‚ äº‹å®ä¸Šä¹Ÿçš„ç¡®å¦‚æ­¤ï¼ŒAndroidæ˜¯æœ‰çˆ¶çª—å£å’Œå­çª—å£çš„æ¦‚å¿µçš„ï¼Œæ¯”å¦‚æ‰“å¼€ä¸€ä¸ªMessageçš„å¼¹çª—ï¼š æŸ¥çœ‹PopupWindowçš„ä¿¡æ¯ï¼š Window #6 Window{193e28f u0 PopupWindow:b98815a}: // ...... mParentWindow=Window{bfc77c9 u0 com.google.android.apps.messaging/com.google.android.apps.messaging.ui.ConversationListActivity} mLayoutAttached=true çˆ¶çª—å£ä¸ºActivityå¯¹åº”çš„çª—å£ã€‚ å†æŸ¥çœ‹å±‚çº§ä¿¡æ¯ï¼š #0 6b8748a com.google.android.apps.messaging/com.google.android.apps.messaging.ui.ConversationListActivity type=standard mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612] #0 3c3dfc1 PopupWindow:a760a0c type=standard mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612] è½¬ä¸ºWindowContainerå±‚çº§ç»“æ„å›¾ä¸ºï¼š è¿™é‡Œè¡¨ç¤ºWindowStateåå­—çš„å½¢å¼ä¸€èˆ¬æ˜¯å“ˆå¸Œå€¼åŠ ä¸ŠåŒ…åæˆ–ç±»åæˆ–çª—å£åç§°ã€‚ ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:2:2","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#22-çª—å£å®¹å™¨ç±»--windowcontainerç±»"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"2.3 WindowStateçš„å®¹å™¨ â€”â€” WindowTokenã€ActivityRecordå’ŒWallpaperWindowToken WindowContaineræ˜¯èƒ½å¤Ÿç›´æ¥æˆ–è€…é—´æ¥æŒæœ‰WindowStateçš„å®¹å™¨ç±»çš„é€šç”¨åŸºç±»ï¼Œé—´æ¥æŒæœ‰WindowStateçš„å®¹å™¨ç±»æš‚ä¸”ä¸æï¼Œè‚¯å®šå¾ˆå¤šï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥æŒæœ‰WindowStateçš„ç±»æœ‰å“ªäº›å‘¢ï¼Ÿ ç­”æ¡ˆæ˜¯WindowTokenï¼ˆé™¤äº†ä¸Šé¢æåˆ°çš„å­çª—å£çš„æ¦‚å¿µï¼‰ï¼Œå¹¶ä¸”WindowTokenè¡ç”Ÿäº†ä¸¤ä¸ªå­ç±»ï¼ŒActivityRecordå’ŒWallpaperWindowTokenï¼Œç”¨æ¥å¯¹çª—å£è¿›è¡Œæ›´ç²¾ç»†çš„åˆ†ç±»ã€‚ 2.3.1 Appçª—å£å’ŒéAppçª—å£ é¦–å…ˆçª—å£å¯ä»¥åˆ†ä¸ºAppçª—å£å’ŒéAppçª—å£ï¼š Appçª—å£ï¼Œå½“Appåˆ›å»ºActivityã€Dialogæˆ–è€…PopupWindowçš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šä¸ºè‡ªåŠ¨ä¸ºå…¶åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„çª—å£ï¼Œæ˜¯æ™®é€šçš„Appçª—å£ã€‚ éAppçª—å£ï¼Œæ˜¯ç³»ç»Ÿä¸ºäº†ç‰¹å®šç›®çš„è€Œä½¿ç”¨çš„ç‰¹æ®Šç±»å‹çš„çª—å£ï¼Œå¯ä»¥ç†è§£ä¸ºç³»ç»Ÿçª—å£ï¼Œå¦‚çŠ¶æ€æ ã€å¯¼èˆªæ ä»¥åŠå£çº¸çª—å£é‚£äº›ã€‚ å…·ä½“å¦‚ä½•åˆ’åˆ†ï¼Œåˆ™æ˜¯çœ‹çª—å£çš„ç±»å‹ï¼Œå³å®šä¹‰åœ¨WindowManager.LayoutParamsä¸­çš„æˆå‘˜å˜é‡typeï¼š @WindowType public int type; çª—å£ç±»å‹ä»FIRST_APPLICATION_WINDOWï¼ˆ1ï¼‰åˆ°LAST_APPLICATION_WINDOWï¼ˆ99ï¼‰çš„çª—å£ä¸ºAppçª—å£ã€‚ çª—å£ç±»å‹ä»FIRST_SYSTEM_WINDOWï¼ˆ2000ï¼‰åˆ°LAST_SYSTEM_WINDOWï¼ˆ2999ï¼‰çš„çª—å£ä¸ºç³»ç»Ÿçª—å£ã€‚ å…¶å®é™¤æ­¤ä¹‹å¤–åªæœ‰ä¸€ç§ç‰¹æ®Šç±»å‹çš„çª—å£ï¼Œå­çª—å£ï¼Œçª—å£ç±»å‹ä»FIRST_SUB_WINDOWï¼ˆ1000ï¼‰åˆ°LAST_SUB_WINDOWï¼ˆ1999ï¼‰ã€‚è¿™ä¸ªç±»å‹çš„çª—å£å¿…é¡»ä¾é™„äºä¸€ä¸ªçˆ¶çª—å£ï¼Œæ¯”å¦‚åˆšåˆšæåˆ°çš„PopupWindowã€‚è¿™ç±»çª—å£å±äºAppçª—å£è¿˜æ˜¯éAppçª—å£ï¼Œå®Œå…¨çœ‹å…¶çˆ¶çª—å£å½’äºå“ªç±»ã€‚ é‚£ä¹ˆä»¥æ­¤åˆ†ç±»ï¼ŒéAppçª—å£çš„å®¹å™¨ä¸ºWindowTokenï¼ŒAppçª—å£çš„å®¹å™¨ä¸ºActivityRecordï¼ˆå­çª—å£çš„å®¹å™¨ä¸ºçˆ¶çª—å£ï¼ŒWindowStateï¼‰ã€‚ 2.3.2 è¿›ä¸€æ­¥åˆ’åˆ† éAppçª—å£ä¸­ä¸€ç§ç‰¹æ®Šçš„çª—å£ï¼Œå£çº¸çª—å£ï¼Œç”±äºå…¶æ˜¯ä½œä¸ºActivityçš„èƒŒæ™¯å­˜åœ¨çš„ï¼Œå› æ­¤å®ƒçš„å±‚çº§åº”è¯¥å§‹ç»ˆä½äºAppçª—å£ã€‚è€Œé™¤å£çº¸çª—å£ä¹‹å¤–çš„éAppçª—å£ï¼Œå±‚çº§åˆ™é«˜äºAppçª—å£ã€‚ é‚£ä¹ˆæˆ‘ä»¬ç»“åˆçª—å£ç±»å‹ä»¥åŠå±‚çº§å…³ç³»ï¼Œå¯ä»¥å¯¹çª—å£è¿›ä¸€æ­¥åˆ’åˆ†ï¼š 1ï¼‰ã€Appä¹‹ä¸Šçš„çª—å£ï¼Œçˆ¶å®¹å™¨ä¸ºWindowTokenï¼Œå¦‚StatusBarï¼š #0 WindowToken{ef15750 android.os.BinderProxy@4562c02} type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1440,2960] #0 d3cbd49 StatusBar type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1440,2960] 2ï¼‰ã€Appçª—å£ï¼Œçˆ¶å®¹å™¨ä¸ºActivityRecordï¼Œå¦‚Messageç›¸å…³Activityçš„çª—å£ï¼š #0 ActivityRecord{bc0999c u0 com.google.android.apps.messaging/.main.MainActivity} t14} type=standard mode=fullscreen override-mode=undefined requested-bou nds=[0,0][0,0] bounds=[0,0][720,1612] #0 adb45c7 com.google.android.apps.messaging/com.google.android.apps.messaging.main.MainActivity type=standard mode=fullscreen override-mode=undefined req uested-bounds=[0,0][0,0] bounds=[0,0][720,1612] 3ï¼‰ã€Appä¹‹ä¸‹çš„çª—å£ï¼Œçˆ¶å®¹å™¨ä¸ºWallpaperWindowTokenï¼Œå¦‚ImageWallpaperçª—å£ï¼š #0 WallpaperWindowToken{145ca49 token=android.os.Binder@a727850} type=undefined mode=fullscreen override-mode=fullscreen requested-bounds=[0,0][0,0] bounds= [0,0][720,1612] #0 ae9c947 com.android.systemui.ImageWallpaper type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612] ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:2:3","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#23-windowstateçš„å®¹å™¨--windowtokenactivityrecordå’Œwallpaperwindowtoken"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"2.3 WindowStateçš„å®¹å™¨ â€”â€” WindowTokenã€ActivityRecordå’ŒWallpaperWindowToken WindowContaineræ˜¯èƒ½å¤Ÿç›´æ¥æˆ–è€…é—´æ¥æŒæœ‰WindowStateçš„å®¹å™¨ç±»çš„é€šç”¨åŸºç±»ï¼Œé—´æ¥æŒæœ‰WindowStateçš„å®¹å™¨ç±»æš‚ä¸”ä¸æï¼Œè‚¯å®šå¾ˆå¤šï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥æŒæœ‰WindowStateçš„ç±»æœ‰å“ªäº›å‘¢ï¼Ÿ ç­”æ¡ˆæ˜¯WindowTokenï¼ˆé™¤äº†ä¸Šé¢æåˆ°çš„å­çª—å£çš„æ¦‚å¿µï¼‰ï¼Œå¹¶ä¸”WindowTokenè¡ç”Ÿäº†ä¸¤ä¸ªå­ç±»ï¼ŒActivityRecordå’ŒWallpaperWindowTokenï¼Œç”¨æ¥å¯¹çª—å£è¿›è¡Œæ›´ç²¾ç»†çš„åˆ†ç±»ã€‚ 2.3.1 Appçª—å£å’ŒéAppçª—å£ é¦–å…ˆçª—å£å¯ä»¥åˆ†ä¸ºAppçª—å£å’ŒéAppçª—å£ï¼š Appçª—å£ï¼Œå½“Appåˆ›å»ºActivityã€Dialogæˆ–è€…PopupWindowçš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šä¸ºè‡ªåŠ¨ä¸ºå…¶åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„çª—å£ï¼Œæ˜¯æ™®é€šçš„Appçª—å£ã€‚ éAppçª—å£ï¼Œæ˜¯ç³»ç»Ÿä¸ºäº†ç‰¹å®šç›®çš„è€Œä½¿ç”¨çš„ç‰¹æ®Šç±»å‹çš„çª—å£ï¼Œå¯ä»¥ç†è§£ä¸ºç³»ç»Ÿçª—å£ï¼Œå¦‚çŠ¶æ€æ ã€å¯¼èˆªæ ä»¥åŠå£çº¸çª—å£é‚£äº›ã€‚ å…·ä½“å¦‚ä½•åˆ’åˆ†ï¼Œåˆ™æ˜¯çœ‹çª—å£çš„ç±»å‹ï¼Œå³å®šä¹‰åœ¨WindowManager.LayoutParamsä¸­çš„æˆå‘˜å˜é‡typeï¼š @WindowType public int type; çª—å£ç±»å‹ä»FIRST_APPLICATION_WINDOWï¼ˆ1ï¼‰åˆ°LAST_APPLICATION_WINDOWï¼ˆ99ï¼‰çš„çª—å£ä¸ºAppçª—å£ã€‚ çª—å£ç±»å‹ä»FIRST_SYSTEM_WINDOWï¼ˆ2000ï¼‰åˆ°LAST_SYSTEM_WINDOWï¼ˆ2999ï¼‰çš„çª—å£ä¸ºç³»ç»Ÿçª—å£ã€‚ å…¶å®é™¤æ­¤ä¹‹å¤–åªæœ‰ä¸€ç§ç‰¹æ®Šç±»å‹çš„çª—å£ï¼Œå­çª—å£ï¼Œçª—å£ç±»å‹ä»FIRST_SUB_WINDOWï¼ˆ1000ï¼‰åˆ°LAST_SUB_WINDOWï¼ˆ1999ï¼‰ã€‚è¿™ä¸ªç±»å‹çš„çª—å£å¿…é¡»ä¾é™„äºä¸€ä¸ªçˆ¶çª—å£ï¼Œæ¯”å¦‚åˆšåˆšæåˆ°çš„PopupWindowã€‚è¿™ç±»çª—å£å±äºAppçª—å£è¿˜æ˜¯éAppçª—å£ï¼Œå®Œå…¨çœ‹å…¶çˆ¶çª—å£å½’äºå“ªç±»ã€‚ é‚£ä¹ˆä»¥æ­¤åˆ†ç±»ï¼ŒéAppçª—å£çš„å®¹å™¨ä¸ºWindowTokenï¼ŒAppçª—å£çš„å®¹å™¨ä¸ºActivityRecordï¼ˆå­çª—å£çš„å®¹å™¨ä¸ºçˆ¶çª—å£ï¼ŒWindowStateï¼‰ã€‚ 2.3.2 è¿›ä¸€æ­¥åˆ’åˆ† éAppçª—å£ä¸­ä¸€ç§ç‰¹æ®Šçš„çª—å£ï¼Œå£çº¸çª—å£ï¼Œç”±äºå…¶æ˜¯ä½œä¸ºActivityçš„èƒŒæ™¯å­˜åœ¨çš„ï¼Œå› æ­¤å®ƒçš„å±‚çº§åº”è¯¥å§‹ç»ˆä½äºAppçª—å£ã€‚è€Œé™¤å£çº¸çª—å£ä¹‹å¤–çš„éAppçª—å£ï¼Œå±‚çº§åˆ™é«˜äºAppçª—å£ã€‚ é‚£ä¹ˆæˆ‘ä»¬ç»“åˆçª—å£ç±»å‹ä»¥åŠå±‚çº§å…³ç³»ï¼Œå¯ä»¥å¯¹çª—å£è¿›ä¸€æ­¥åˆ’åˆ†ï¼š 1ï¼‰ã€Appä¹‹ä¸Šçš„çª—å£ï¼Œçˆ¶å®¹å™¨ä¸ºWindowTokenï¼Œå¦‚StatusBarï¼š #0 WindowToken{ef15750 android.os.BinderProxy@4562c02} type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1440,2960] #0 d3cbd49 StatusBar type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1440,2960] 2ï¼‰ã€Appçª—å£ï¼Œçˆ¶å®¹å™¨ä¸ºActivityRecordï¼Œå¦‚Messageç›¸å…³Activityçš„çª—å£ï¼š #0 ActivityRecord{bc0999c u0 com.google.android.apps.messaging/.main.MainActivity} t14} type=standard mode=fullscreen override-mode=undefined requested-bou nds=[0,0][0,0] bounds=[0,0][720,1612] #0 adb45c7 com.google.android.apps.messaging/com.google.android.apps.messaging.main.MainActivity type=standard mode=fullscreen override-mode=undefined req uested-bounds=[0,0][0,0] bounds=[0,0][720,1612] 3ï¼‰ã€Appä¹‹ä¸‹çš„çª—å£ï¼Œçˆ¶å®¹å™¨ä¸ºWallpaperWindowTokenï¼Œå¦‚ImageWallpaperçª—å£ï¼š #0 WallpaperWindowToken{145ca49 token=android.os.Binder@a727850} type=undefined mode=fullscreen override-mode=fullscreen requested-bounds=[0,0][0,0] bounds= [0,0][720,1612] #0 ae9c947 com.android.systemui.ImageWallpaper type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612] ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:2:3","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#231-appçª—å£å’Œéappçª—å£"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"2.3 WindowStateçš„å®¹å™¨ â€”â€” WindowTokenã€ActivityRecordå’ŒWallpaperWindowToken WindowContaineræ˜¯èƒ½å¤Ÿç›´æ¥æˆ–è€…é—´æ¥æŒæœ‰WindowStateçš„å®¹å™¨ç±»çš„é€šç”¨åŸºç±»ï¼Œé—´æ¥æŒæœ‰WindowStateçš„å®¹å™¨ç±»æš‚ä¸”ä¸æï¼Œè‚¯å®šå¾ˆå¤šï¼Œé‚£ä¹ˆå¯ä»¥ç›´æ¥æŒæœ‰WindowStateçš„ç±»æœ‰å“ªäº›å‘¢ï¼Ÿ ç­”æ¡ˆæ˜¯WindowTokenï¼ˆé™¤äº†ä¸Šé¢æåˆ°çš„å­çª—å£çš„æ¦‚å¿µï¼‰ï¼Œå¹¶ä¸”WindowTokenè¡ç”Ÿäº†ä¸¤ä¸ªå­ç±»ï¼ŒActivityRecordå’ŒWallpaperWindowTokenï¼Œç”¨æ¥å¯¹çª—å£è¿›è¡Œæ›´ç²¾ç»†çš„åˆ†ç±»ã€‚ 2.3.1 Appçª—å£å’ŒéAppçª—å£ é¦–å…ˆçª—å£å¯ä»¥åˆ†ä¸ºAppçª—å£å’ŒéAppçª—å£ï¼š Appçª—å£ï¼Œå½“Appåˆ›å»ºActivityã€Dialogæˆ–è€…PopupWindowçš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šä¸ºè‡ªåŠ¨ä¸ºå…¶åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„çª—å£ï¼Œæ˜¯æ™®é€šçš„Appçª—å£ã€‚ éAppçª—å£ï¼Œæ˜¯ç³»ç»Ÿä¸ºäº†ç‰¹å®šç›®çš„è€Œä½¿ç”¨çš„ç‰¹æ®Šç±»å‹çš„çª—å£ï¼Œå¯ä»¥ç†è§£ä¸ºç³»ç»Ÿçª—å£ï¼Œå¦‚çŠ¶æ€æ ã€å¯¼èˆªæ ä»¥åŠå£çº¸çª—å£é‚£äº›ã€‚ å…·ä½“å¦‚ä½•åˆ’åˆ†ï¼Œåˆ™æ˜¯çœ‹çª—å£çš„ç±»å‹ï¼Œå³å®šä¹‰åœ¨WindowManager.LayoutParamsä¸­çš„æˆå‘˜å˜é‡typeï¼š @WindowType public int type; çª—å£ç±»å‹ä»FIRST_APPLICATION_WINDOWï¼ˆ1ï¼‰åˆ°LAST_APPLICATION_WINDOWï¼ˆ99ï¼‰çš„çª—å£ä¸ºAppçª—å£ã€‚ çª—å£ç±»å‹ä»FIRST_SYSTEM_WINDOWï¼ˆ2000ï¼‰åˆ°LAST_SYSTEM_WINDOWï¼ˆ2999ï¼‰çš„çª—å£ä¸ºç³»ç»Ÿçª—å£ã€‚ å…¶å®é™¤æ­¤ä¹‹å¤–åªæœ‰ä¸€ç§ç‰¹æ®Šç±»å‹çš„çª—å£ï¼Œå­çª—å£ï¼Œçª—å£ç±»å‹ä»FIRST_SUB_WINDOWï¼ˆ1000ï¼‰åˆ°LAST_SUB_WINDOWï¼ˆ1999ï¼‰ã€‚è¿™ä¸ªç±»å‹çš„çª—å£å¿…é¡»ä¾é™„äºä¸€ä¸ªçˆ¶çª—å£ï¼Œæ¯”å¦‚åˆšåˆšæåˆ°çš„PopupWindowã€‚è¿™ç±»çª—å£å±äºAppçª—å£è¿˜æ˜¯éAppçª—å£ï¼Œå®Œå…¨çœ‹å…¶çˆ¶çª—å£å½’äºå“ªç±»ã€‚ é‚£ä¹ˆä»¥æ­¤åˆ†ç±»ï¼ŒéAppçª—å£çš„å®¹å™¨ä¸ºWindowTokenï¼ŒAppçª—å£çš„å®¹å™¨ä¸ºActivityRecordï¼ˆå­çª—å£çš„å®¹å™¨ä¸ºçˆ¶çª—å£ï¼ŒWindowStateï¼‰ã€‚ 2.3.2 è¿›ä¸€æ­¥åˆ’åˆ† éAppçª—å£ä¸­ä¸€ç§ç‰¹æ®Šçš„çª—å£ï¼Œå£çº¸çª—å£ï¼Œç”±äºå…¶æ˜¯ä½œä¸ºActivityçš„èƒŒæ™¯å­˜åœ¨çš„ï¼Œå› æ­¤å®ƒçš„å±‚çº§åº”è¯¥å§‹ç»ˆä½äºAppçª—å£ã€‚è€Œé™¤å£çº¸çª—å£ä¹‹å¤–çš„éAppçª—å£ï¼Œå±‚çº§åˆ™é«˜äºAppçª—å£ã€‚ é‚£ä¹ˆæˆ‘ä»¬ç»“åˆçª—å£ç±»å‹ä»¥åŠå±‚çº§å…³ç³»ï¼Œå¯ä»¥å¯¹çª—å£è¿›ä¸€æ­¥åˆ’åˆ†ï¼š 1ï¼‰ã€Appä¹‹ä¸Šçš„çª—å£ï¼Œçˆ¶å®¹å™¨ä¸ºWindowTokenï¼Œå¦‚StatusBarï¼š #0 WindowToken{ef15750 android.os.BinderProxy@4562c02} type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1440,2960] #0 d3cbd49 StatusBar type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1440,2960] 2ï¼‰ã€Appçª—å£ï¼Œçˆ¶å®¹å™¨ä¸ºActivityRecordï¼Œå¦‚Messageç›¸å…³Activityçš„çª—å£ï¼š #0 ActivityRecord{bc0999c u0 com.google.android.apps.messaging/.main.MainActivity} t14} type=standard mode=fullscreen override-mode=undefined requested-bou nds=[0,0][0,0] bounds=[0,0][720,1612] #0 adb45c7 com.google.android.apps.messaging/com.google.android.apps.messaging.main.MainActivity type=standard mode=fullscreen override-mode=undefined req uested-bounds=[0,0][0,0] bounds=[0,0][720,1612] 3ï¼‰ã€Appä¹‹ä¸‹çš„çª—å£ï¼Œçˆ¶å®¹å™¨ä¸ºWallpaperWindowTokenï¼Œå¦‚ImageWallpaperçª—å£ï¼š #0 WallpaperWindowToken{145ca49 token=android.os.Binder@a727850} type=undefined mode=fullscreen override-mode=fullscreen requested-bounds=[0,0][0,0] bounds= [0,0][720,1612] #0 ae9c947 com.android.systemui.ImageWallpaper type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612] ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:2:3","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#232-è¿›ä¸€æ­¥åˆ’åˆ†"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"2.4 ActivityRecordçš„å®¹å™¨ â€”â€” Task æŒ‰ç†è¯´è¿™ä¸€æ­¥åº”è¯¥ç»§ç»­åˆ†æWindowTokençš„çˆ¶å®¹å™¨äº†ï¼Œä½†æ˜¯ActivityRecordä½œä¸ºä¸€ç§ç‰¹æ®Šçš„WindowTokenï¼Œå®ƒè‡ªå·±æœ‰ä¸€ä¸ªç‰¹æ®Šçš„çˆ¶å®¹å™¨ï¼ŒTaskã€‚ Taskç±»çš„å®šä¹‰ä¸ºï¼š class Task extends WindowContainer\u003cWindowContainer\u003e { å†æ¬¡æ¸©ä¹ ä¸€ä¸‹googleå…³äºTaskçš„è¯´æ˜ï¼š ä»»åŠ¡ï¼ˆTaskï¼‰æ˜¯ç”¨æˆ·åœ¨æ‰§è¡ŒæŸé¡¹å·¥ä½œæ—¶ä¸ä¹‹äº’åŠ¨çš„ä¸€ç³»åˆ— Activity çš„é›†åˆã€‚è¿™äº› Activity æŒ‰ç…§æ¯ä¸ª Activity æ‰“å¼€çš„é¡ºåºæ’åˆ—åœ¨ä¸€ä¸ªè¿”å›å †æ ˆä¸­ã€‚ä¾‹å¦‚ï¼Œç”µå­é‚®ä»¶åº”ç”¨å¯èƒ½æœ‰ä¸€ä¸ª Activity æ¥æ˜¾ç¤ºæ–°é‚®ä»¶åˆ—è¡¨ã€‚å½“ç”¨æˆ·é€‰æ‹©ä¸€å°é‚®ä»¶æ—¶ï¼Œç³»ç»Ÿä¼šæ‰“å¼€ä¸€ä¸ªæ–°çš„ Activity æ¥æ˜¾ç¤ºè¯¥é‚®ä»¶ã€‚è¿™ä¸ªæ–°çš„ Activity ä¼šæ·»åŠ åˆ°è¿”å›å †æ ˆä¸­ã€‚å¦‚æœç”¨æˆ·æŒ‰è¿”å›æŒ‰é’®ï¼Œè¿™ä¸ªæ–°çš„ Activity å³ä¼šå®Œæˆå¹¶ä»å †æ ˆä¸­é€€å‡ºã€‚ å¤§å¤šæ•°Taskéƒ½ä»Launcherä¸Šå¯åŠ¨ã€‚å½“ç”¨æˆ·è½»è§¦Launcherä¸­çš„å›¾æ ‡ï¼ˆæˆ–ä¸»å±å¹•ä¸Šçš„å¿«æ·æ–¹å¼ï¼‰æ—¶ï¼Œè¯¥åº”ç”¨çš„Taskå°±ä¼šè½¬åˆ°å‰å°è¿è¡Œã€‚å¦‚æœè¯¥åº”ç”¨æ²¡æœ‰Taskå­˜åœ¨ï¼ˆåº”ç”¨æœ€è¿‘æ²¡æœ‰ä½¿ç”¨è¿‡ï¼‰ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Taskï¼Œå¹¶ä¸”è¯¥åº”ç”¨çš„â€œä¸»â€Activity å°†ä¼šä½œä¸ºå †æ ˆçš„æ ¹ Activity æ‰“å¼€ã€‚ åœ¨å½“å‰ Activity å¯åŠ¨å¦ä¸€ä¸ª Activity æ—¶ï¼Œæ–°çš„ Activity å°†è¢«æ¨é€åˆ°å †æ ˆé¡¶éƒ¨å¹¶è·å¾—ç„¦ç‚¹ã€‚ä¸Šä¸€ä¸ª Activity ä»ä¿ç•™åœ¨å †æ ˆä¸­ï¼Œä½†ä¼šåœæ­¢ã€‚å½“ Activity åœæ­¢æ—¶ï¼Œç³»ç»Ÿä¼šä¿ç•™å…¶ç•Œé¢çš„å½“å‰çŠ¶æ€ã€‚å½“ç”¨æˆ·æŒ‰è¿”å›æŒ‰ é’®æ—¶ï¼Œå½“å‰ Activity ä¼šä»å †æ ˆé¡¶éƒ¨é€€å‡ºï¼ˆè¯¥ Activity é”€æ¯ï¼‰ï¼Œä¸Šä¸€ä¸ª Activity ä¼šæ¢å¤ï¼ˆç•Œé¢ä¼šæ¢å¤åˆ°ä¸Šä¸€ä¸ªçŠ¶æ€ï¼‰ã€‚å †æ ˆä¸­çš„ Activity æ°¸è¿œä¸ä¼šé‡æ–°æ’åˆ—ï¼Œåªä¼šè¢«é€å…¥å’Œé€€å‡ºï¼Œåœ¨å½“å‰ Activity å¯åŠ¨æ—¶è¢«é€å…¥å †æ ˆï¼Œåœ¨ç”¨æˆ·ä½¿ç”¨è¿”å›æŒ‰é’®ç¦»å¼€æ—¶ä»å †æ ˆä¸­é€€å‡ºã€‚å› æ­¤ï¼Œè¿”å›å †æ ˆæŒ‰ç…§â€œåè¿›å…ˆå‡ºâ€çš„å¯¹è±¡ç»“æ„è¿ä½œã€‚å›¾ 1 å€ŸåŠ©ä¸€ä¸ªæ—¶é—´è½´ç›´è§‚åœ°æ˜¾ç¤ºäº†è¿™ç§è¡Œä¸ºã€‚è¯¥æ—¶é—´è½´æ˜¾ç¤ºäº† Activity ä¹‹é—´çš„è¿›å±•ä»¥åŠæ¯ä¸ªæ—¶é—´ç‚¹çš„å½“å‰è¿”å›å †æ ˆã€‚ å›¾ 1. æœ‰å…³Taskä¸­çš„æ¯ä¸ªæ–° Activity å¦‚ä½•æ·»åŠ åˆ°è¿”å›å †æ ˆçš„å›¾ç¤ºã€‚å½“ç”¨æˆ·æŒ‰è¿”å›æŒ‰é’®æ—¶ï¼Œå½“å‰ Activity ä¼šé”€æ¯ï¼Œä¸Šä¸€ä¸ª Activity å°†æ¢å¤ã€‚ å¦‚æœç”¨æˆ·ç»§ç»­æŒ‰è¿”å›ï¼Œåˆ™å †æ ˆä¸­çš„ Activity ä¼šé€ä¸ªé€€å‡ºï¼Œä»¥æ˜¾ç¤ºå‰ä¸€ä¸ª Activityï¼Œç›´åˆ°ç”¨æˆ·è¿”å›åˆ°ä¸»å±å¹•ï¼ˆæˆ–Taskå¼€å§‹æ—¶è¿è¡Œçš„ Activityï¼‰ã€‚ç§»é™¤å †æ ˆä¸­çš„æ‰€æœ‰ Activity åï¼Œè¯¥Taskå°†ä¸å¤å­˜åœ¨ã€‚ WMSä¸­çš„Taskç±»çš„æ¦‚å¿µå’Œä»¥ä¸Šè¯´æ˜åŸºæœ¬ä¸€è‡´ï¼Œç”¨æ¥ç®¡ç†ActivityRecordã€‚ è¿˜æ˜¯ä¸Šé¢çš„Messageï¼Œæƒ…å†µæ˜¯ï¼š #3 Task=14 type=standard mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612] #0 ActivityRecord{bc0999c u0 com.google.android.apps.messaging/.main.MainActivity} t14} type=standard mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612] #0 adb45c7 com.google.android.apps.messaging/com.google.android.apps.messaging.main.MainActivity type=standard mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612] æ¥ç€å†å¯åŠ¨Messageçš„å¦å¤–ä¸€ä¸ªç•Œé¢ï¼š #3 Task=14 type=standard mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612] #1 ActivityRecord{357651e u0 com.google.android.apps.messaging/.ui.appsettings.ApplicationSettingsActivity} t14} type=standard mode=fullscreen override-mod e=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612] #0 e611691 com.google.android.apps.messaging/com.google.android.apps.messaging.ui.appsettings.ApplicationSettingsActivity type=standard mode=fullscreen ov erride-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612] #0 ActivityRecord{bc0999c u0 com.google.android.apps.messaging/.main.MainActivity} t14} type=standard mode=fullscreen override-mode=undefined requested-bou nds=[0,0][0,0] bounds=[0,0][720,1612] #0 adb45c7 com.google.android.apps.messaging/com.google.android.apps.messaging.main.MainActivity type=standard mode=fullscreen override-mode=undefined req uested-bounds=[0,0][0,0] bounds=[0,0][720,1612] æ–°çš„ActivityRecordè¢«ç½®äºæ ˆé¡¶ï¼Œç›–åœ¨ä¹‹å‰çš„ActivityRecordä¸Šã€‚ Taskçš„åµŒå¥— Taskæ˜¯æ”¯æŒåµŒå¥—çš„ï¼Œä»Taskç±»çš„å®šä¹‰ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼ˆTaskæ˜¯WindowContainerçš„å®¹å™¨ï¼Œè€Œéåªèƒ½å®¹çº³ActivityRecordï¼‰ã€‚ 1ï¼‰ã€çœ‹ä¸‹å½“åªæœ‰ä¸€ä¸ªLauncherçš„æƒ…å†µï¼š #2 Task=1 type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2400] #0 Task=50 type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2400] #0 ActivityRecord{b864ccc u0 com.tcl.android.launcher/.uioverrides.TclQuickstepLauncher} t50} type=home mode=fullscreen override-mode=undefined requested- bounds=[0,0][0,0] bounds=[0,0][1080,2400] è¿™é‡Œçš„ç¤ºæ„å›¾å¿½ç•¥äº†ActivityRecordçš„ä¸‹ä¸€çº§ï¼ŒWindowStateã€‚ åªçœ‹åˆ°è¿™é‡Œå¯èƒ½æ— æ³•ç†è§£TaskåµŒå¥—çš„æ„ä¹‰ä½•åœ¨ã€‚ 2ï¼‰ã€æ¥ç€å¯åŠ¨Messageï¼š #1 DefaultTaskDisplayArea type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2400] #3 Task=61 type=standard mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2400] #0 ActivityRecord{fac1d1c u0 com.google.android.apps.messaging/.ui.ConversationListActivity} t61} type=standard mode=fullscreen override-mode=undefined req uested-bounds=[0,0][0,0] bounds=[0,0][1080,2400] #2 Task=1 type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2400] #0 Task=50 type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2400] #0 ActivityRe","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:2:4","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#24-activityrecordçš„å®¹å™¨--task"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"2.4 ActivityRecordçš„å®¹å™¨ â€”â€” Task æŒ‰ç†è¯´è¿™ä¸€æ­¥åº”è¯¥ç»§ç»­åˆ†æWindowTokençš„çˆ¶å®¹å™¨äº†ï¼Œä½†æ˜¯ActivityRecordä½œä¸ºä¸€ç§ç‰¹æ®Šçš„WindowTokenï¼Œå®ƒè‡ªå·±æœ‰ä¸€ä¸ªç‰¹æ®Šçš„çˆ¶å®¹å™¨ï¼ŒTaskã€‚ Taskç±»çš„å®šä¹‰ä¸ºï¼š class Task extends WindowContainer { å†æ¬¡æ¸©ä¹ ä¸€ä¸‹googleå…³äºTaskçš„è¯´æ˜ï¼š ä»»åŠ¡ï¼ˆTaskï¼‰æ˜¯ç”¨æˆ·åœ¨æ‰§è¡ŒæŸé¡¹å·¥ä½œæ—¶ä¸ä¹‹äº’åŠ¨çš„ä¸€ç³»åˆ— Activity çš„é›†åˆã€‚è¿™äº› Activity æŒ‰ç…§æ¯ä¸ª Activity æ‰“å¼€çš„é¡ºåºæ’åˆ—åœ¨ä¸€ä¸ªè¿”å›å †æ ˆä¸­ã€‚ä¾‹å¦‚ï¼Œç”µå­é‚®ä»¶åº”ç”¨å¯èƒ½æœ‰ä¸€ä¸ª Activity æ¥æ˜¾ç¤ºæ–°é‚®ä»¶åˆ—è¡¨ã€‚å½“ç”¨æˆ·é€‰æ‹©ä¸€å°é‚®ä»¶æ—¶ï¼Œç³»ç»Ÿä¼šæ‰“å¼€ä¸€ä¸ªæ–°çš„ Activity æ¥æ˜¾ç¤ºè¯¥é‚®ä»¶ã€‚è¿™ä¸ªæ–°çš„ Activity ä¼šæ·»åŠ åˆ°è¿”å›å †æ ˆä¸­ã€‚å¦‚æœç”¨æˆ·æŒ‰è¿”å›æŒ‰é’®ï¼Œè¿™ä¸ªæ–°çš„ Activity å³ä¼šå®Œæˆå¹¶ä»å †æ ˆä¸­é€€å‡ºã€‚ å¤§å¤šæ•°Taskéƒ½ä»Launcherä¸Šå¯åŠ¨ã€‚å½“ç”¨æˆ·è½»è§¦Launcherä¸­çš„å›¾æ ‡ï¼ˆæˆ–ä¸»å±å¹•ä¸Šçš„å¿«æ·æ–¹å¼ï¼‰æ—¶ï¼Œè¯¥åº”ç”¨çš„Taskå°±ä¼šè½¬åˆ°å‰å°è¿è¡Œã€‚å¦‚æœè¯¥åº”ç”¨æ²¡æœ‰Taskå­˜åœ¨ï¼ˆåº”ç”¨æœ€è¿‘æ²¡æœ‰ä½¿ç”¨è¿‡ï¼‰ï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Taskï¼Œå¹¶ä¸”è¯¥åº”ç”¨çš„â€œä¸»â€Activity å°†ä¼šä½œä¸ºå †æ ˆçš„æ ¹ Activity æ‰“å¼€ã€‚ åœ¨å½“å‰ Activity å¯åŠ¨å¦ä¸€ä¸ª Activity æ—¶ï¼Œæ–°çš„ Activity å°†è¢«æ¨é€åˆ°å †æ ˆé¡¶éƒ¨å¹¶è·å¾—ç„¦ç‚¹ã€‚ä¸Šä¸€ä¸ª Activity ä»ä¿ç•™åœ¨å †æ ˆä¸­ï¼Œä½†ä¼šåœæ­¢ã€‚å½“ Activity åœæ­¢æ—¶ï¼Œç³»ç»Ÿä¼šä¿ç•™å…¶ç•Œé¢çš„å½“å‰çŠ¶æ€ã€‚å½“ç”¨æˆ·æŒ‰è¿”å›æŒ‰ é’®æ—¶ï¼Œå½“å‰ Activity ä¼šä»å †æ ˆé¡¶éƒ¨é€€å‡ºï¼ˆè¯¥ Activity é”€æ¯ï¼‰ï¼Œä¸Šä¸€ä¸ª Activity ä¼šæ¢å¤ï¼ˆç•Œé¢ä¼šæ¢å¤åˆ°ä¸Šä¸€ä¸ªçŠ¶æ€ï¼‰ã€‚å †æ ˆä¸­çš„ Activity æ°¸è¿œä¸ä¼šé‡æ–°æ’åˆ—ï¼Œåªä¼šè¢«é€å…¥å’Œé€€å‡ºï¼Œåœ¨å½“å‰ Activity å¯åŠ¨æ—¶è¢«é€å…¥å †æ ˆï¼Œåœ¨ç”¨æˆ·ä½¿ç”¨è¿”å›æŒ‰é’®ç¦»å¼€æ—¶ä»å †æ ˆä¸­é€€å‡ºã€‚å› æ­¤ï¼Œè¿”å›å †æ ˆæŒ‰ç…§â€œåè¿›å…ˆå‡ºâ€çš„å¯¹è±¡ç»“æ„è¿ä½œã€‚å›¾ 1 å€ŸåŠ©ä¸€ä¸ªæ—¶é—´è½´ç›´è§‚åœ°æ˜¾ç¤ºäº†è¿™ç§è¡Œä¸ºã€‚è¯¥æ—¶é—´è½´æ˜¾ç¤ºäº† Activity ä¹‹é—´çš„è¿›å±•ä»¥åŠæ¯ä¸ªæ—¶é—´ç‚¹çš„å½“å‰è¿”å›å †æ ˆã€‚ å›¾ 1. æœ‰å…³Taskä¸­çš„æ¯ä¸ªæ–° Activity å¦‚ä½•æ·»åŠ åˆ°è¿”å›å †æ ˆçš„å›¾ç¤ºã€‚å½“ç”¨æˆ·æŒ‰è¿”å›æŒ‰é’®æ—¶ï¼Œå½“å‰ Activity ä¼šé”€æ¯ï¼Œä¸Šä¸€ä¸ª Activity å°†æ¢å¤ã€‚ å¦‚æœç”¨æˆ·ç»§ç»­æŒ‰è¿”å›ï¼Œåˆ™å †æ ˆä¸­çš„ Activity ä¼šé€ä¸ªé€€å‡ºï¼Œä»¥æ˜¾ç¤ºå‰ä¸€ä¸ª Activityï¼Œç›´åˆ°ç”¨æˆ·è¿”å›åˆ°ä¸»å±å¹•ï¼ˆæˆ–Taskå¼€å§‹æ—¶è¿è¡Œçš„ Activityï¼‰ã€‚ç§»é™¤å †æ ˆä¸­çš„æ‰€æœ‰ Activity åï¼Œè¯¥Taskå°†ä¸å¤å­˜åœ¨ã€‚ WMSä¸­çš„Taskç±»çš„æ¦‚å¿µå’Œä»¥ä¸Šè¯´æ˜åŸºæœ¬ä¸€è‡´ï¼Œç”¨æ¥ç®¡ç†ActivityRecordã€‚ è¿˜æ˜¯ä¸Šé¢çš„Messageï¼Œæƒ…å†µæ˜¯ï¼š #3 Task=14 type=standard mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612] #0 ActivityRecord{bc0999c u0 com.google.android.apps.messaging/.main.MainActivity} t14} type=standard mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612] #0 adb45c7 com.google.android.apps.messaging/com.google.android.apps.messaging.main.MainActivity type=standard mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612] æ¥ç€å†å¯åŠ¨Messageçš„å¦å¤–ä¸€ä¸ªç•Œé¢ï¼š #3 Task=14 type=standard mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612] #1 ActivityRecord{357651e u0 com.google.android.apps.messaging/.ui.appsettings.ApplicationSettingsActivity} t14} type=standard mode=fullscreen override-mod e=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612] #0 e611691 com.google.android.apps.messaging/com.google.android.apps.messaging.ui.appsettings.ApplicationSettingsActivity type=standard mode=fullscreen ov erride-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612] #0 ActivityRecord{bc0999c u0 com.google.android.apps.messaging/.main.MainActivity} t14} type=standard mode=fullscreen override-mode=undefined requested-bou nds=[0,0][0,0] bounds=[0,0][720,1612] #0 adb45c7 com.google.android.apps.messaging/com.google.android.apps.messaging.main.MainActivity type=standard mode=fullscreen override-mode=undefined req uested-bounds=[0,0][0,0] bounds=[0,0][720,1612] æ–°çš„ActivityRecordè¢«ç½®äºæ ˆé¡¶ï¼Œç›–åœ¨ä¹‹å‰çš„ActivityRecordä¸Šã€‚ Taskçš„åµŒå¥— Taskæ˜¯æ”¯æŒåµŒå¥—çš„ï¼Œä»Taskç±»çš„å®šä¹‰ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼ˆTaskæ˜¯WindowContainerçš„å®¹å™¨ï¼Œè€Œéåªèƒ½å®¹çº³ActivityRecordï¼‰ã€‚ 1ï¼‰ã€çœ‹ä¸‹å½“åªæœ‰ä¸€ä¸ªLauncherçš„æƒ…å†µï¼š #2 Task=1 type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2400] #0 Task=50 type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2400] #0 ActivityRecord{b864ccc u0 com.tcl.android.launcher/.uioverrides.TclQuickstepLauncher} t50} type=home mode=fullscreen override-mode=undefined requested- bounds=[0,0][0,0] bounds=[0,0][1080,2400] è¿™é‡Œçš„ç¤ºæ„å›¾å¿½ç•¥äº†ActivityRecordçš„ä¸‹ä¸€çº§ï¼ŒWindowStateã€‚ åªçœ‹åˆ°è¿™é‡Œå¯èƒ½æ— æ³•ç†è§£TaskåµŒå¥—çš„æ„ä¹‰ä½•åœ¨ã€‚ 2ï¼‰ã€æ¥ç€å¯åŠ¨Messageï¼š #1 DefaultTaskDisplayArea type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2400] #3 Task=61 type=standard mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2400] #0 ActivityRecord{fac1d1c u0 com.google.android.apps.messaging/.ui.ConversationListActivity} t61} type=standard mode=fullscreen override-mode=undefined req uested-bounds=[0,0][0,0] bounds=[0,0][1080,2400] #2 Task=1 type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2400] #0 Task=50 type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1080,2400] #0 ActivityRe","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:2:4","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#taskçš„åµŒå¥—"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"2.5 Taskçš„å®¹å™¨ â€”â€” TaskDisplayArea /** * {@link DisplayArea} that represents a section of a screen that contains app window containers. * * The children can be either {@link Task} or {@link TaskDisplayArea}. */ final class TaskDisplayArea extends DisplayArea\u003cWindowContainer\u003e TaskDisplayAreaä»£è¡¨äº†å±å¹•ä¸Šçš„ä¸€ä¸ªåŒ…å«Appç±»å‹çš„WindowContainerçš„åŒºåŸŸã€‚å®ƒçš„å­èŠ‚ç‚¹å¯ä»¥æ˜¯Taskï¼Œæˆ–è€…æ˜¯TaskDisplayAreaã€‚ä½†æ˜¯ç›®å‰åœ¨ä»£ç ä¸­ï¼Œæˆ‘çœ‹åˆ°åˆ›å»ºTaskDisplayAreaçš„åœ°æ–¹åªæœ‰ä¸€å¤„ï¼Œè¯¥å¤„åˆ›å»ºäº†ä¸€ä¸ªåä¸ºâ€œDefaultTaskDisplayAreaâ€çš„TaskDisplayAreaå¯¹è±¡ï¼Œé™¤æ­¤ä¹‹å¤–å¹¶æ²¡æœ‰å‘ç°å…¶ä»–åœ°æ–¹æœ‰åˆ›å»ºTaskDisplayAreaå¯¹è±¡çš„åœ°æ–¹ï¼Œè‡ªç„¶ä¹Ÿæ²¡æœ‰æ‰¾åˆ°æœ‰å…³TaskDisplayAreaåµŒå¥—çš„ç—•è¿¹ã€‚ å› æ­¤ç›®å‰å¯ä»¥è¯´ï¼ŒTaskDisplayAreaå­˜æ”¾Taskçš„å®¹å™¨ã€‚ åœ¨æ‰‹æœºçš„è¿‘æœŸä»»åŠ¡åˆ—è¡¨ç•Œé¢å°†æ‰€æœ‰Appéƒ½æ¸…æ‰åï¼ŒæŸ¥çœ‹ä¸€ä¸‹æ­¤æ—¶çš„TaskDisplayAreaæƒ…å†µï¼š #0 DefaultTaskDisplayArea type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1920,1200] #5 Task=1 type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1920,1200] #0 Task=8 type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1920,1200] #0 ActivityRecord{5e73ff4 u0 com.tcl.android.launcher/.Launcher t8} type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1920,1200] #1 ca4f5c4 com.tcl.android.launcher/com.tcl.android.launcher.Launcher type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1920,1200] #0 5784a50 com.tcl.android.launcher/com.tcl.android.launcher.Launcher type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1920,1200] #4 Task=2 type=undefined mode=fullscreen override-mode=fullscreen requested-bounds=[0,0][0,0] bounds=[0,0][1920,1200] #3 Task=3 type=undefined mode=multi-window override-mode=multi-window requested-bounds=[0,0][0,0] bounds=[0,0][1920,1200] #2 Task=4 type=undefined mode=multi-window override-mode=multi-window requested-bounds=[0,0][0,0] bounds=[0,0][1920,1200] #1 Task=5 type=undefined mode=split-screen-primary override-mode=split-screen-primary requested-bounds=[0,0][950,1200] bounds=[0,0][950,1200] #0 Task=6 type=undefined mode=split-screen-secondary override-mode=split-screen-secondary requested-bounds=[970,0][1920,1200] bounds=[970,0][1920,1200] é¢„æœŸåº”è¯¥æ˜¯DefaultTaskDisplayAreaçš„å­å®¹å™¨ï¼Œåªæœ‰Launcheråº”ç”¨å¯¹åº”çš„Task#1ï¼Œä½†æ˜¯å´å¤šTask#2ã€Task#3ã€Task#4ã€Task#5å’ŒTask#6è¿™å‡ ä¸ªTaskï¼Œå¹¶ä¸”è¿™å‡ ä¸ªTaskå¹¶æ²¡æœ‰æŒæœ‰ä»»ä½•ä¸€ä¸ªActivityRecordå¯¹è±¡ã€‚æ­£å¸¸æ¥è¯´ï¼ŒAppç«¯è°ƒç”¨startActivityåï¼ŒWMSä¼šä¸ºæ–°åˆ›å»ºçš„ActivityRecordå¯¹è±¡åˆ›å»ºTaskï¼Œç”¨æ¥å­˜æ”¾è¿™ä¸ªActivityRecordã€‚å½“Taskä¸­çš„æ‰€æœ‰ActivityRecordéƒ½è¢«ç§»é™¤åï¼Œè¿™ä¸ªTaskå°±ä¼šè¢«ç§»é™¤ï¼Œæ¯”å¦‚Messageå¯¹åº”çš„Taskã€‚ ä½†æ˜¯å¯¹äºTask#1ä¹‹ç±»çš„Taskæ¥è¯´å¹¶ä¸æ˜¯è¿™æ ·ã€‚è¿™äº›Taskæ˜¯WMSå¯åŠ¨åå°±ç”±TaskOrganizerControlleråˆ›å»ºçš„ï¼Œè¿™äº›Taskå¹¶æ²¡æœ‰å’ŒæŸä¸€å…·ä½“çš„Appè”ç³»èµ·æ¥ï¼Œå› æ­¤å½“å®ƒé‡Œé¢çš„å­WindowContainerè¢«ç§»é™¤åï¼Œè¿™ä¸ªTaskä¹Ÿä¸ä¼šè¢«é”€æ¯ã€‚æ¯”å¦‚åˆ†å±Task#5å’ŒTask#6ï¼š #1 Task=5 type=undefined mode=split-screen-primary override-mode=split-screen-primary requested-bounds=[0,0][950,1200] bounds=[0,0][950,1200] #0 Task=6 type=undefined mode=split-screen-secondary override-mode=split-screen-secondary requested-bounds=[970,0][1920,1200] bounds=[970,0][1920,1200] è¿™ä¸¤ä¸ªTaskç”±TaskOrganizerControllerå¯åŠ¨ï¼Œç”¨æ¥ç®¡ç†ç³»ç»Ÿè¿›å…¥åˆ†å±åï¼Œéœ€è¦è·Ÿéšç³»ç»Ÿè¿›å…¥åˆ†å±æ¨¡å¼çš„é‚£äº›Appå¯¹åº”çš„Taskï¼Œä¹Ÿå°±æ˜¯è¯´è¿™äº›Appå¯¹åº”çš„Taskçš„çˆ¶å®¹å™¨ä¼šä»DefaultTaskDisplayAreaå˜ä¸ºTask#3å’ŒTask#2ã€‚ Taskçš„è°ƒåº¦ Taskçš„è°ƒåº¦å…¶å®ä¹Ÿéå¸¸ç®€å•ï¼Œè¿™é‡Œæ‹¿ä¸€ä¸ªå®é™…çš„ä¾‹å­è¯´æ˜ã€‚ 1ï¼‰ã€æˆ‘å…ˆä»Launcherå¯åŠ¨Messageï¼Œæ¥ç€é€šè¿‡adbå¯åŠ¨æˆ‘è‡ªå·±å†™çš„DemoAppï¼Œé‚£ä¹ˆæ­¤æ—¶è¿™ä¸‰ä¸ªTaskçš„é¡ºåºä»é«˜åˆ°ä½åˆ†åˆ«æ˜¯ï¼šDemoApp -\u003e Message -\u003e Launcherï¼Œå¦‚å›¾æ‰€ç¤ºï¼š 2ï¼‰ã€æ¥ç€æˆ‘åœ¨DemoAppç•Œé¢ä¸‹ç‚¹å‡»Backé”®ï¼Œæ­¤æ—¶çš„è¡Œä¸ºæ˜¯ï¼š DemoAppæ‰€åœ¨çš„Task#64ï¼Œè·‘åˆ°äº†TaskDisplayAreaçš„æ ˆåº•ï¼Œå…¶å®ƒTaské¡ºåºä¸å˜ï¼Œé‚£ä¹ˆæœ€ç»ˆæ˜¯Messageå‡ºç°åœ¨äº†å‰å°ã€‚ è¿™æ˜¯å› ä¸ºæˆ‘ä»¬é‡å†™äº†Activityçš„onBackPressedæ–¹æ³•ï¼š @Override public void onBackPressed() { moveTaskToBack(true); } å½“æ¥æ”¶åˆ°Backäº‹ä»¶çš„æ—¶å€™ï¼Œå°†Activityæ‰€åœ¨çš„Taskç§»åŠ¨åˆ°æœ€åï¼Œå…·ä½“çš„è¡Œä¸ºå°±æ˜¯ç§»åŠ¨åˆ°çˆ¶å®¹å™¨çš„æ ˆåº•ï¼Œä¹Ÿå°±æ˜¯TaskDisplayAreaçš„æ ˆåº•ã€‚ 3ï¼‰ã€è¿™é‡Œæˆ‘ä»¬æ›´æ”¹onBackPressedæ–¹æ³•çš„å†…å®¹ï¼š @Override public void onBackPressed() { Intent intent = new Intent(Intent.ACTION_MAIN); intent.addCategory(Intent.CATEGORY_HOME); intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK); startActivity(intent); } åœ¨æ¥æ”¶åˆ°Backé”®æ—¶å¯åŠ¨Launcherï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬å†æ¬¡ç‚¹å‡»Backé”®æ—¶ï¼Œè¡Œä¸ºæ˜¯ï¼š çœ‹åˆ°Launcheæ‰€åœ¨çš„Task#50ï¼Œä»¥åŠRootTaskï¼ŒTask#1ï¼Œä¸€èµ·ç§»åŠ¨åˆ°äº†å‰å°ï¼Œè€Œå…¶å®ƒTaskçš„é¡ºåºä¸å˜ã€‚ 4ï¼‰ã€æœ€åèƒ½çœ‹åˆ°ï¼ŒåŒæ ·çš„æ“ä½œï¼Œå¹¶ä¸”è‚‰çœ¼çœ‹åˆ°äº†åŒæ ·çš„è¡Œä¸ºï¼Œä½†æ˜¯TaskDisplayAreaå†…éƒ¨çš„Taskçš„é¡ºåºå´ä¸ä¸€æ ·ï¼šä¸€ä¸ªæ˜¯å°†å‰å°Appç§»åŠ¨åˆ°æ ˆåº•ï¼Œä¸€ä¸ªæ˜¯å°†åå°Appç§»åŠ¨åˆ°å‰å°ï¼Œæ‰€ä»¥å…·ä½“é—®é¢˜è¿˜æ˜¯è¦å…·ä½“åˆ†æã€‚ ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:2:5","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#25-taskçš„å®¹å™¨--taskdisplayarea"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"2.5 Taskçš„å®¹å™¨ â€”â€” TaskDisplayArea /** * {@link DisplayArea} that represents a section of a screen that contains app window containers. * * The children can be either {@link Task} or {@link TaskDisplayArea}. */ final class TaskDisplayArea extends DisplayArea TaskDisplayAreaä»£è¡¨äº†å±å¹•ä¸Šçš„ä¸€ä¸ªåŒ…å«Appç±»å‹çš„WindowContainerçš„åŒºåŸŸã€‚å®ƒçš„å­èŠ‚ç‚¹å¯ä»¥æ˜¯Taskï¼Œæˆ–è€…æ˜¯TaskDisplayAreaã€‚ä½†æ˜¯ç›®å‰åœ¨ä»£ç ä¸­ï¼Œæˆ‘çœ‹åˆ°åˆ›å»ºTaskDisplayAreaçš„åœ°æ–¹åªæœ‰ä¸€å¤„ï¼Œè¯¥å¤„åˆ›å»ºäº†ä¸€ä¸ªåä¸ºâ€œDefaultTaskDisplayAreaâ€çš„TaskDisplayAreaå¯¹è±¡ï¼Œé™¤æ­¤ä¹‹å¤–å¹¶æ²¡æœ‰å‘ç°å…¶ä»–åœ°æ–¹æœ‰åˆ›å»ºTaskDisplayAreaå¯¹è±¡çš„åœ°æ–¹ï¼Œè‡ªç„¶ä¹Ÿæ²¡æœ‰æ‰¾åˆ°æœ‰å…³TaskDisplayAreaåµŒå¥—çš„ç—•è¿¹ã€‚ å› æ­¤ç›®å‰å¯ä»¥è¯´ï¼ŒTaskDisplayAreaå­˜æ”¾Taskçš„å®¹å™¨ã€‚ åœ¨æ‰‹æœºçš„è¿‘æœŸä»»åŠ¡åˆ—è¡¨ç•Œé¢å°†æ‰€æœ‰Appéƒ½æ¸…æ‰åï¼ŒæŸ¥çœ‹ä¸€ä¸‹æ­¤æ—¶çš„TaskDisplayAreaæƒ…å†µï¼š #0 DefaultTaskDisplayArea type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1920,1200] #5 Task=1 type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1920,1200] #0 Task=8 type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1920,1200] #0 ActivityRecord{5e73ff4 u0 com.tcl.android.launcher/.Launcher t8} type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1920,1200] #1 ca4f5c4 com.tcl.android.launcher/com.tcl.android.launcher.Launcher type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1920,1200] #0 5784a50 com.tcl.android.launcher/com.tcl.android.launcher.Launcher type=home mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][1920,1200] #4 Task=2 type=undefined mode=fullscreen override-mode=fullscreen requested-bounds=[0,0][0,0] bounds=[0,0][1920,1200] #3 Task=3 type=undefined mode=multi-window override-mode=multi-window requested-bounds=[0,0][0,0] bounds=[0,0][1920,1200] #2 Task=4 type=undefined mode=multi-window override-mode=multi-window requested-bounds=[0,0][0,0] bounds=[0,0][1920,1200] #1 Task=5 type=undefined mode=split-screen-primary override-mode=split-screen-primary requested-bounds=[0,0][950,1200] bounds=[0,0][950,1200] #0 Task=6 type=undefined mode=split-screen-secondary override-mode=split-screen-secondary requested-bounds=[970,0][1920,1200] bounds=[970,0][1920,1200] é¢„æœŸåº”è¯¥æ˜¯DefaultTaskDisplayAreaçš„å­å®¹å™¨ï¼Œåªæœ‰Launcheråº”ç”¨å¯¹åº”çš„Task#1ï¼Œä½†æ˜¯å´å¤šTask#2ã€Task#3ã€Task#4ã€Task#5å’ŒTask#6è¿™å‡ ä¸ªTaskï¼Œå¹¶ä¸”è¿™å‡ ä¸ªTaskå¹¶æ²¡æœ‰æŒæœ‰ä»»ä½•ä¸€ä¸ªActivityRecordå¯¹è±¡ã€‚æ­£å¸¸æ¥è¯´ï¼ŒAppç«¯è°ƒç”¨startActivityåï¼ŒWMSä¼šä¸ºæ–°åˆ›å»ºçš„ActivityRecordå¯¹è±¡åˆ›å»ºTaskï¼Œç”¨æ¥å­˜æ”¾è¿™ä¸ªActivityRecordã€‚å½“Taskä¸­çš„æ‰€æœ‰ActivityRecordéƒ½è¢«ç§»é™¤åï¼Œè¿™ä¸ªTaskå°±ä¼šè¢«ç§»é™¤ï¼Œæ¯”å¦‚Messageå¯¹åº”çš„Taskã€‚ ä½†æ˜¯å¯¹äºTask#1ä¹‹ç±»çš„Taskæ¥è¯´å¹¶ä¸æ˜¯è¿™æ ·ã€‚è¿™äº›Taskæ˜¯WMSå¯åŠ¨åå°±ç”±TaskOrganizerControlleråˆ›å»ºçš„ï¼Œè¿™äº›Taskå¹¶æ²¡æœ‰å’ŒæŸä¸€å…·ä½“çš„Appè”ç³»èµ·æ¥ï¼Œå› æ­¤å½“å®ƒé‡Œé¢çš„å­WindowContainerè¢«ç§»é™¤åï¼Œè¿™ä¸ªTaskä¹Ÿä¸ä¼šè¢«é”€æ¯ã€‚æ¯”å¦‚åˆ†å±Task#5å’ŒTask#6ï¼š #1 Task=5 type=undefined mode=split-screen-primary override-mode=split-screen-primary requested-bounds=[0,0][950,1200] bounds=[0,0][950,1200] #0 Task=6 type=undefined mode=split-screen-secondary override-mode=split-screen-secondary requested-bounds=[970,0][1920,1200] bounds=[970,0][1920,1200] è¿™ä¸¤ä¸ªTaskç”±TaskOrganizerControllerå¯åŠ¨ï¼Œç”¨æ¥ç®¡ç†ç³»ç»Ÿè¿›å…¥åˆ†å±åï¼Œéœ€è¦è·Ÿéšç³»ç»Ÿè¿›å…¥åˆ†å±æ¨¡å¼çš„é‚£äº›Appå¯¹åº”çš„Taskï¼Œä¹Ÿå°±æ˜¯è¯´è¿™äº›Appå¯¹åº”çš„Taskçš„çˆ¶å®¹å™¨ä¼šä»DefaultTaskDisplayAreaå˜ä¸ºTask#3å’ŒTask#2ã€‚ Taskçš„è°ƒåº¦ Taskçš„è°ƒåº¦å…¶å®ä¹Ÿéå¸¸ç®€å•ï¼Œè¿™é‡Œæ‹¿ä¸€ä¸ªå®é™…çš„ä¾‹å­è¯´æ˜ã€‚ 1ï¼‰ã€æˆ‘å…ˆä»Launcherå¯åŠ¨Messageï¼Œæ¥ç€é€šè¿‡adbå¯åŠ¨æˆ‘è‡ªå·±å†™çš„DemoAppï¼Œé‚£ä¹ˆæ­¤æ—¶è¿™ä¸‰ä¸ªTaskçš„é¡ºåºä»é«˜åˆ°ä½åˆ†åˆ«æ˜¯ï¼šDemoApp -\u003e Message -\u003e Launcherï¼Œå¦‚å›¾æ‰€ç¤ºï¼š 2ï¼‰ã€æ¥ç€æˆ‘åœ¨DemoAppç•Œé¢ä¸‹ç‚¹å‡»Backé”®ï¼Œæ­¤æ—¶çš„è¡Œä¸ºæ˜¯ï¼š DemoAppæ‰€åœ¨çš„Task#64ï¼Œè·‘åˆ°äº†TaskDisplayAreaçš„æ ˆåº•ï¼Œå…¶å®ƒTaské¡ºåºä¸å˜ï¼Œé‚£ä¹ˆæœ€ç»ˆæ˜¯Messageå‡ºç°åœ¨äº†å‰å°ã€‚ è¿™æ˜¯å› ä¸ºæˆ‘ä»¬é‡å†™äº†Activityçš„onBackPressedæ–¹æ³•ï¼š @Override public void onBackPressed() { moveTaskToBack(true); } å½“æ¥æ”¶åˆ°Backäº‹ä»¶çš„æ—¶å€™ï¼Œå°†Activityæ‰€åœ¨çš„Taskç§»åŠ¨åˆ°æœ€åï¼Œå…·ä½“çš„è¡Œä¸ºå°±æ˜¯ç§»åŠ¨åˆ°çˆ¶å®¹å™¨çš„æ ˆåº•ï¼Œä¹Ÿå°±æ˜¯TaskDisplayAreaçš„æ ˆåº•ã€‚ 3ï¼‰ã€è¿™é‡Œæˆ‘ä»¬æ›´æ”¹onBackPressedæ–¹æ³•çš„å†…å®¹ï¼š @Override public void onBackPressed() { Intent intent = new Intent(Intent.ACTION_MAIN); intent.addCategory(Intent.CATEGORY_HOME); intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK); startActivity(intent); } åœ¨æ¥æ”¶åˆ°Backé”®æ—¶å¯åŠ¨Launcherï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬å†æ¬¡ç‚¹å‡»Backé”®æ—¶ï¼Œè¡Œä¸ºæ˜¯ï¼š çœ‹åˆ°Launcheæ‰€åœ¨çš„Task#50ï¼Œä»¥åŠRootTaskï¼ŒTask#1ï¼Œä¸€èµ·ç§»åŠ¨åˆ°äº†å‰å°ï¼Œè€Œå…¶å®ƒTaskçš„é¡ºåºä¸å˜ã€‚ 4ï¼‰ã€æœ€åèƒ½çœ‹åˆ°ï¼ŒåŒæ ·çš„æ“ä½œï¼Œå¹¶ä¸”è‚‰çœ¼çœ‹åˆ°äº†åŒæ ·çš„è¡Œä¸ºï¼Œä½†æ˜¯TaskDisplayAreaå†…éƒ¨çš„Taskçš„é¡ºåºå´ä¸ä¸€æ ·ï¼šä¸€ä¸ªæ˜¯å°†å‰å°Appç§»åŠ¨åˆ°æ ˆåº•ï¼Œä¸€ä¸ªæ˜¯å°†åå°Appç§»åŠ¨åˆ°å‰å°ï¼Œæ‰€ä»¥å…·ä½“é—®é¢˜è¿˜æ˜¯è¦å…·ä½“åˆ†æã€‚ ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:2:5","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#taskçš„è°ƒåº¦"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"2.6 DisplayAreaå±‚çº§ç»“æ„ èƒ½å¤Ÿå®¹çº³éAppçª—å£çš„çˆ¶å®¹å™¨ä¸ºDisplayArea.Tokensï¼š /** * DisplayArea that contains WindowTokens, and orders them according to their type. */ public static class Tokens extends DisplayArea\u003cWindowToken\u003e { å®¹çº³Appçª—å£çš„çˆ¶å®¹å™¨åˆ™æ˜¯Taskï¼Œå®¹çº³Taskçš„åˆ™æ˜¯TaskDisplayAreaï¼ŒTaskDisplayAreaä¹Ÿæ˜¯DisplayAreaçš„ä¸€ä¸ªå­ç±»ï¼š final class TaskDisplayArea extends DisplayArea\u003cWindowContainer\u003e é‚£ä¹ˆæˆ‘ä»¬æ¥ä¸‹æ¥ç ”ç©¶çš„å¯¹è±¡å°±æ˜¯DisplayAreaã€‚ DisplayAreaæœ¬èº«ä¹Ÿéå¸¸å¤æ‚ï¼Œæœ‰å¾ˆå¤šå­ç±»ï¼š è¿™é‡Œåªè¯´ä¸€ä¸‹æ¯”è¾ƒé‡è¦çš„å‡ ä¸ªç±»ï¼š 1ï¼‰ã€èƒ½ç›´æ¥å®¹çº³WindowTokençš„å®¹å™¨ï¼Œé™¤äº†åˆšåˆšè¯´çš„DisplayArea.Tokensç±»å’ŒTaskDisplayAreaï¼ˆä¸¥è°¨ç‚¹è¯´TaskDisplayAreaæ˜¯Taskçš„å®¹å™¨ï¼ŒTaskæ‰æ˜¯ActivityRecordçš„å®¹å™¨ï¼‰ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªDisplayArea.Tokensç±»çš„å­ç±»ï¼Œå®šä¹‰åœ¨DisplayContentä¸­çš„å†…éƒ¨ç±»ImeContainerï¼Œä¸“é—¨ç”¨æ¥å®¹çº³è¾“å…¥æ³•çª—å£ã€‚è¿™ä¸‰ä¸ªç±»ç”±äºèƒ½å¤Ÿå®¹çº³WindowTokenï¼Œæ‰€ä»¥åœ¨DisplayAreaå±‚çº§ç»“æ„ä¸­ä½œä¸ºå¶èŠ‚ç‚¹å­˜åœ¨ï¼ˆæœ€å°å•ä½ï¼Œæ— æ³•å†å®¹çº³å…¶å®ƒDisplayAreaå¯¹è±¡ï¼‰ï¼Œå°±åƒWindowStateæ˜¯ä½œä¸ºWindowContainerå±‚çº§ç»“æ„çš„æœ€å°å•ä½ä¸€æ ·ã€‚ 2ï¼‰ã€DisplayContentï¼Œä»£è¡¨ä¸€ä¸ªå±å¹•ï¼Œä½œä¸ºDisplayAreaå±‚çº§ç»“æ„çš„æ ¹èŠ‚ç‚¹æ‰€å­˜åœ¨ã€‚ 2.6.1 çª—å£å±‚çº§å€¼ æˆ‘ä»¬éƒ½çŸ¥é“çŠ¶æ€æ çª—å£çš„å±‚çº§æ˜¯æ¯”æ™®é€šçš„Appçª—å£å±‚çº§é«˜çš„ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·çš„ï¼Œä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰æƒ³è¿‡ã€‚ çœ‹ä¸€ä¸ªæ–¹æ³•ï¼ŒWindowManagerPolicy.getWindowLayerFromTypeLwï¼š /** * Returns the layer assignment for the window type. Allows you to control how different * kinds of windows are ordered on-screen. * * @param type The type of window being assigned. * @param canAddInternalSystemWindow If the owner window associated with the type we are * evaluating can add internal system windows. I.e they have * {@link Manifest.permission#INTERNAL_SYSTEM_WINDOW}. If true, alert window * types {@link android.view.WindowManager.LayoutParams#isSystemAlertWindowType(int)} * can be assigned layers greater than the layer for * {@link android.view.WindowManager.LayoutParams#TYPE_APPLICATION_OVERLAY} Else, their * layers would be lesser. * @param roundedCornerOverlay {#code true} to indicate that the owner window is rounded corner * overlay. * @return int An arbitrary integer used to order windows, with lower numbers below higher ones. */ default int getWindowLayerFromTypeLw(int type, boolean canAddInternalSystemWindow, boolean roundedCornerOverlay) { // Always put the rounded corner layer to the top most. if (roundedCornerOverlay \u0026\u0026 canAddInternalSystemWindow) { return getMaxWindowLayer(); } if (type \u003e= FIRST_APPLICATION_WINDOW \u0026\u0026 type \u003c= LAST_APPLICATION_WINDOW) { return APPLICATION_LAYER; } switch (type) { case TYPE_WALLPAPER: // wallpaper is at the bottom, though the window manager may move it. return 1; case TYPE_PRESENTATION: case TYPE_PRIVATE_PRESENTATION: case TYPE_DOCK_DIVIDER: case TYPE_QS_DIALOG: case TYPE_PHONE: return 3; case TYPE_SEARCH_BAR: case TYPE_VOICE_INTERACTION_STARTING: return 4; case TYPE_VOICE_INTERACTION: // voice interaction layer is almost immediately above apps. return 5; case TYPE_INPUT_CONSUMER: return 6; case TYPE_SYSTEM_DIALOG: return 7; case TYPE_TOAST: // toasts and the plugged-in battery thing return 8; case TYPE_PRIORITY_PHONE: // SIM errors and unlock. Not sure if this really should be in a high layer. return 9; case TYPE_SYSTEM_ALERT: // like the ANR / app crashed dialogs // Type is deprecated for non-system apps. For system apps, this type should be // in a higher layer than TYPE_APPLICATION_OVERLAY. return canAddInternalSystemWindow ? 13 : 10; case TYPE_APPLICATION_OVERLAY: return 12; case TYPE_INPUT_METHOD: // on-screen keyboards and other such input method user interfaces go here. return 15; case TYPE_INPUT_METHOD_DIALOG: // on-screen keyboards and other such input method user interfaces go here. return 16; case TYPE_STATUS_BAR: return 17; case TYPE_STATUS_BAR_ADDITIONAL: return 18; case TYPE_NOTIFICATION_SHADE: return 19; case TYPE_STATUS_BAR_SUB_PANEL: return 20; case TYPE_KEYGUARD_DIALOG: return 21; case TYPE_VOLUME_OVERLAY: // the on-screen volume indicator and controller shown when the user // changes the device volume return 22; case TYPE_SYSTEM_OVERLAY: // the on-screen volume indicator and controller shown when the user // changes the device volume return canAddInternalSystemWindow ? 23 : 11; case TYPE_NAVIGATION_BAR: // the navigation bar, if available, shows atop most things return 24; case TYPE_NAVIGATION_BAR_PANEL: // some panels (e.g. search) need to show on top of the navigatio","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:2:6","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#26-displayareaå±‚çº§ç»“æ„"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"2.6 DisplayAreaå±‚çº§ç»“æ„ èƒ½å¤Ÿå®¹çº³éAppçª—å£çš„çˆ¶å®¹å™¨ä¸ºDisplayArea.Tokensï¼š /** * DisplayArea that contains WindowTokens, and orders them according to their type. */ public static class Tokens extends DisplayArea { å®¹çº³Appçª—å£çš„çˆ¶å®¹å™¨åˆ™æ˜¯Taskï¼Œå®¹çº³Taskçš„åˆ™æ˜¯TaskDisplayAreaï¼ŒTaskDisplayAreaä¹Ÿæ˜¯DisplayAreaçš„ä¸€ä¸ªå­ç±»ï¼š final class TaskDisplayArea extends DisplayArea é‚£ä¹ˆæˆ‘ä»¬æ¥ä¸‹æ¥ç ”ç©¶çš„å¯¹è±¡å°±æ˜¯DisplayAreaã€‚ DisplayAreaæœ¬èº«ä¹Ÿéå¸¸å¤æ‚ï¼Œæœ‰å¾ˆå¤šå­ç±»ï¼š è¿™é‡Œåªè¯´ä¸€ä¸‹æ¯”è¾ƒé‡è¦çš„å‡ ä¸ªç±»ï¼š 1ï¼‰ã€èƒ½ç›´æ¥å®¹çº³WindowTokençš„å®¹å™¨ï¼Œé™¤äº†åˆšåˆšè¯´çš„DisplayArea.Tokensç±»å’ŒTaskDisplayAreaï¼ˆä¸¥è°¨ç‚¹è¯´TaskDisplayAreaæ˜¯Taskçš„å®¹å™¨ï¼ŒTaskæ‰æ˜¯ActivityRecordçš„å®¹å™¨ï¼‰ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªDisplayArea.Tokensç±»çš„å­ç±»ï¼Œå®šä¹‰åœ¨DisplayContentä¸­çš„å†…éƒ¨ç±»ImeContainerï¼Œä¸“é—¨ç”¨æ¥å®¹çº³è¾“å…¥æ³•çª—å£ã€‚è¿™ä¸‰ä¸ªç±»ç”±äºèƒ½å¤Ÿå®¹çº³WindowTokenï¼Œæ‰€ä»¥åœ¨DisplayAreaå±‚çº§ç»“æ„ä¸­ä½œä¸ºå¶èŠ‚ç‚¹å­˜åœ¨ï¼ˆæœ€å°å•ä½ï¼Œæ— æ³•å†å®¹çº³å…¶å®ƒDisplayAreaå¯¹è±¡ï¼‰ï¼Œå°±åƒWindowStateæ˜¯ä½œä¸ºWindowContainerå±‚çº§ç»“æ„çš„æœ€å°å•ä½ä¸€æ ·ã€‚ 2ï¼‰ã€DisplayContentï¼Œä»£è¡¨ä¸€ä¸ªå±å¹•ï¼Œä½œä¸ºDisplayAreaå±‚çº§ç»“æ„çš„æ ¹èŠ‚ç‚¹æ‰€å­˜åœ¨ã€‚ 2.6.1 çª—å£å±‚çº§å€¼ æˆ‘ä»¬éƒ½çŸ¥é“çŠ¶æ€æ çª—å£çš„å±‚çº§æ˜¯æ¯”æ™®é€šçš„Appçª—å£å±‚çº§é«˜çš„ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·çš„ï¼Œä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰æƒ³è¿‡ã€‚ çœ‹ä¸€ä¸ªæ–¹æ³•ï¼ŒWindowManagerPolicy.getWindowLayerFromTypeLwï¼š /** * Returns the layer assignment for the window type. Allows you to control how different * kinds of windows are ordered on-screen. * * @param type The type of window being assigned. * @param canAddInternalSystemWindow If the owner window associated with the type we are * evaluating can add internal system windows. I.e they have * {@link Manifest.permission#INTERNAL_SYSTEM_WINDOW}. If true, alert window * types {@link android.view.WindowManager.LayoutParams#isSystemAlertWindowType(int)} * can be assigned layers greater than the layer for * {@link android.view.WindowManager.LayoutParams#TYPE_APPLICATION_OVERLAY} Else, their * layers would be lesser. * @param roundedCornerOverlay {#code true} to indicate that the owner window is rounded corner * overlay. * @return int An arbitrary integer used to order windows, with lower numbers below higher ones. */ default int getWindowLayerFromTypeLw(int type, boolean canAddInternalSystemWindow, boolean roundedCornerOverlay) { // Always put the rounded corner layer to the top most. if (roundedCornerOverlay \u0026\u0026 canAddInternalSystemWindow) { return getMaxWindowLayer(); } if (type \u003e= FIRST_APPLICATION_WINDOW \u0026\u0026 type \u003c= LAST_APPLICATION_WINDOW) { return APPLICATION_LAYER; } switch (type) { case TYPE_WALLPAPER: // wallpaper is at the bottom, though the window manager may move it. return 1; case TYPE_PRESENTATION: case TYPE_PRIVATE_PRESENTATION: case TYPE_DOCK_DIVIDER: case TYPE_QS_DIALOG: case TYPE_PHONE: return 3; case TYPE_SEARCH_BAR: case TYPE_VOICE_INTERACTION_STARTING: return 4; case TYPE_VOICE_INTERACTION: // voice interaction layer is almost immediately above apps. return 5; case TYPE_INPUT_CONSUMER: return 6; case TYPE_SYSTEM_DIALOG: return 7; case TYPE_TOAST: // toasts and the plugged-in battery thing return 8; case TYPE_PRIORITY_PHONE: // SIM errors and unlock. Not sure if this really should be in a high layer. return 9; case TYPE_SYSTEM_ALERT: // like the ANR / app crashed dialogs // Type is deprecated for non-system apps. For system apps, this type should be // in a higher layer than TYPE_APPLICATION_OVERLAY. return canAddInternalSystemWindow ? 13 : 10; case TYPE_APPLICATION_OVERLAY: return 12; case TYPE_INPUT_METHOD: // on-screen keyboards and other such input method user interfaces go here. return 15; case TYPE_INPUT_METHOD_DIALOG: // on-screen keyboards and other such input method user interfaces go here. return 16; case TYPE_STATUS_BAR: return 17; case TYPE_STATUS_BAR_ADDITIONAL: return 18; case TYPE_NOTIFICATION_SHADE: return 19; case TYPE_STATUS_BAR_SUB_PANEL: return 20; case TYPE_KEYGUARD_DIALOG: return 21; case TYPE_VOLUME_OVERLAY: // the on-screen volume indicator and controller shown when the user // changes the device volume return 22; case TYPE_SYSTEM_OVERLAY: // the on-screen volume indicator and controller shown when the user // changes the device volume return canAddInternalSystemWindow ? 23 : 11; case TYPE_NAVIGATION_BAR: // the navigation bar, if available, shows atop most things return 24; case TYPE_NAVIGATION_BAR_PANEL: // some panels (e.g. search) need to show on top of the navigatio","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:2:6","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#261-çª—å£å±‚çº§å€¼"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"2.6 DisplayAreaå±‚çº§ç»“æ„ èƒ½å¤Ÿå®¹çº³éAppçª—å£çš„çˆ¶å®¹å™¨ä¸ºDisplayArea.Tokensï¼š /** * DisplayArea that contains WindowTokens, and orders them according to their type. */ public static class Tokens extends DisplayArea { å®¹çº³Appçª—å£çš„çˆ¶å®¹å™¨åˆ™æ˜¯Taskï¼Œå®¹çº³Taskçš„åˆ™æ˜¯TaskDisplayAreaï¼ŒTaskDisplayAreaä¹Ÿæ˜¯DisplayAreaçš„ä¸€ä¸ªå­ç±»ï¼š final class TaskDisplayArea extends DisplayArea é‚£ä¹ˆæˆ‘ä»¬æ¥ä¸‹æ¥ç ”ç©¶çš„å¯¹è±¡å°±æ˜¯DisplayAreaã€‚ DisplayAreaæœ¬èº«ä¹Ÿéå¸¸å¤æ‚ï¼Œæœ‰å¾ˆå¤šå­ç±»ï¼š è¿™é‡Œåªè¯´ä¸€ä¸‹æ¯”è¾ƒé‡è¦çš„å‡ ä¸ªç±»ï¼š 1ï¼‰ã€èƒ½ç›´æ¥å®¹çº³WindowTokençš„å®¹å™¨ï¼Œé™¤äº†åˆšåˆšè¯´çš„DisplayArea.Tokensç±»å’ŒTaskDisplayAreaï¼ˆä¸¥è°¨ç‚¹è¯´TaskDisplayAreaæ˜¯Taskçš„å®¹å™¨ï¼ŒTaskæ‰æ˜¯ActivityRecordçš„å®¹å™¨ï¼‰ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªDisplayArea.Tokensç±»çš„å­ç±»ï¼Œå®šä¹‰åœ¨DisplayContentä¸­çš„å†…éƒ¨ç±»ImeContainerï¼Œä¸“é—¨ç”¨æ¥å®¹çº³è¾“å…¥æ³•çª—å£ã€‚è¿™ä¸‰ä¸ªç±»ç”±äºèƒ½å¤Ÿå®¹çº³WindowTokenï¼Œæ‰€ä»¥åœ¨DisplayAreaå±‚çº§ç»“æ„ä¸­ä½œä¸ºå¶èŠ‚ç‚¹å­˜åœ¨ï¼ˆæœ€å°å•ä½ï¼Œæ— æ³•å†å®¹çº³å…¶å®ƒDisplayAreaå¯¹è±¡ï¼‰ï¼Œå°±åƒWindowStateæ˜¯ä½œä¸ºWindowContainerå±‚çº§ç»“æ„çš„æœ€å°å•ä½ä¸€æ ·ã€‚ 2ï¼‰ã€DisplayContentï¼Œä»£è¡¨ä¸€ä¸ªå±å¹•ï¼Œä½œä¸ºDisplayAreaå±‚çº§ç»“æ„çš„æ ¹èŠ‚ç‚¹æ‰€å­˜åœ¨ã€‚ 2.6.1 çª—å£å±‚çº§å€¼ æˆ‘ä»¬éƒ½çŸ¥é“çŠ¶æ€æ çª—å£çš„å±‚çº§æ˜¯æ¯”æ™®é€šçš„Appçª—å£å±‚çº§é«˜çš„ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·çš„ï¼Œä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰æƒ³è¿‡ã€‚ çœ‹ä¸€ä¸ªæ–¹æ³•ï¼ŒWindowManagerPolicy.getWindowLayerFromTypeLwï¼š /** * Returns the layer assignment for the window type. Allows you to control how different * kinds of windows are ordered on-screen. * * @param type The type of window being assigned. * @param canAddInternalSystemWindow If the owner window associated with the type we are * evaluating can add internal system windows. I.e they have * {@link Manifest.permission#INTERNAL_SYSTEM_WINDOW}. If true, alert window * types {@link android.view.WindowManager.LayoutParams#isSystemAlertWindowType(int)} * can be assigned layers greater than the layer for * {@link android.view.WindowManager.LayoutParams#TYPE_APPLICATION_OVERLAY} Else, their * layers would be lesser. * @param roundedCornerOverlay {#code true} to indicate that the owner window is rounded corner * overlay. * @return int An arbitrary integer used to order windows, with lower numbers below higher ones. */ default int getWindowLayerFromTypeLw(int type, boolean canAddInternalSystemWindow, boolean roundedCornerOverlay) { // Always put the rounded corner layer to the top most. if (roundedCornerOverlay \u0026\u0026 canAddInternalSystemWindow) { return getMaxWindowLayer(); } if (type \u003e= FIRST_APPLICATION_WINDOW \u0026\u0026 type \u003c= LAST_APPLICATION_WINDOW) { return APPLICATION_LAYER; } switch (type) { case TYPE_WALLPAPER: // wallpaper is at the bottom, though the window manager may move it. return 1; case TYPE_PRESENTATION: case TYPE_PRIVATE_PRESENTATION: case TYPE_DOCK_DIVIDER: case TYPE_QS_DIALOG: case TYPE_PHONE: return 3; case TYPE_SEARCH_BAR: case TYPE_VOICE_INTERACTION_STARTING: return 4; case TYPE_VOICE_INTERACTION: // voice interaction layer is almost immediately above apps. return 5; case TYPE_INPUT_CONSUMER: return 6; case TYPE_SYSTEM_DIALOG: return 7; case TYPE_TOAST: // toasts and the plugged-in battery thing return 8; case TYPE_PRIORITY_PHONE: // SIM errors and unlock. Not sure if this really should be in a high layer. return 9; case TYPE_SYSTEM_ALERT: // like the ANR / app crashed dialogs // Type is deprecated for non-system apps. For system apps, this type should be // in a higher layer than TYPE_APPLICATION_OVERLAY. return canAddInternalSystemWindow ? 13 : 10; case TYPE_APPLICATION_OVERLAY: return 12; case TYPE_INPUT_METHOD: // on-screen keyboards and other such input method user interfaces go here. return 15; case TYPE_INPUT_METHOD_DIALOG: // on-screen keyboards and other such input method user interfaces go here. return 16; case TYPE_STATUS_BAR: return 17; case TYPE_STATUS_BAR_ADDITIONAL: return 18; case TYPE_NOTIFICATION_SHADE: return 19; case TYPE_STATUS_BAR_SUB_PANEL: return 20; case TYPE_KEYGUARD_DIALOG: return 21; case TYPE_VOLUME_OVERLAY: // the on-screen volume indicator and controller shown when the user // changes the device volume return 22; case TYPE_SYSTEM_OVERLAY: // the on-screen volume indicator and controller shown when the user // changes the device volume return canAddInternalSystemWindow ? 23 : 11; case TYPE_NAVIGATION_BAR: // the navigation bar, if available, shows atop most things return 24; case TYPE_NAVIGATION_BAR_PANEL: // some panels (e.g. search) need to show on top of the navigatio","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:2:6","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#262-displayareaå±‚çº§ç»“æ„çš„ç”Ÿæˆ"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"2.7 WindowContainerå±‚çº§ç»“æ„æ ¹èŠ‚ç‚¹ â€”â€” RootWindowContainer å›çœ‹ä¸Šé¢çš„WindowContainerå±‚çº§ç»“æ„å›¾ï¼Œèƒ½çœ‹åˆ°æ ¹èŠ‚ç‚¹ä¸ºRootWindowContainerï¼Œè€ŒéDisplayAreaå±‚çº§ç»“æ„çš„æ ¹èŠ‚ç‚¹DisplayContentï¼Œæ¯•ç«ŸDisplayContentåªä»£è¡¨ä¸€å—å±å¹•ï¼Œè€ŒAndroidæ˜¯æ”¯æŒå¤šå±å¹•çš„ï¼Œå±•å¼€æ¥è¯´å°±æ˜¯åŒ…æ‹¬ä¸€ä¸ªå†…éƒ¨å±å¹•ï¼ˆå†…ç½®äºæ‰‹æœºæˆ–å¹³æ¿ç”µè„‘ä¸­çš„å±å¹•ï¼‰ã€ä¸€ä¸ªå¤–éƒ¨å±å¹•ï¼ˆå¦‚é€šè¿‡ HDMI è¿æ¥çš„ç”µè§†ï¼‰ä»¥åŠä¸€ä¸ªæˆ–å¤šä¸ªè™šæ‹Ÿå±å¹•ã€‚ é‚£ä¹ˆå°±éœ€è¦ä¸€ä¸ªDisplayContentçš„å®¹å™¨å‡ºç°ï¼Œè¿™ä¸ªè§’è‰²è‡ªç„¶ä¹Ÿå°±æ˜¯RootWindowContaineräº†ï¼Œä»åå­—ä¹Ÿèƒ½çœ‹å‡ºæ¥ï¼Œå®ƒæ˜¯ä½œä¸ºWindowContainerå±‚çº§ç»“æ„çš„æ ¹èŠ‚ç‚¹æ‰€å­˜åœ¨çš„ï¼š /** Root {@link WindowContainer} for the device. */ class RootWindowContainer extends WindowContainer\u003cDisplayContent\u003e implements DisplayManager.DisplayListener é‚£ä¹ˆå¦‚æœæˆ‘ä»¬åœ¨å¼€å‘è€…é€‰é¡¹é‡Œé€šè¿‡â€œSimulate secondary displaysâ€å¼€å¯å¦ä¸€ä¸ªè™šæ‹Ÿå±å¹•ï¼Œæ­¤æ—¶çš„æƒ…å†µæ˜¯ï¼š ROOT type=undefined mode=fullscreen override-mode=undefined requested-bounds=[0,0][0,0] bounds=[0,0][720,1612] #1 Display 0 name=\"Built-in screen\" type=undefined mode=fullscreen override-mode=fullscreen requested-bounds=[0,0][720,1612] bounds=[0,0][720,1612] #0 Display 2 name=\"Overlay #1\" type=undefined mode=fullscreen override-mode=fullscreen requested-bounds=[0,0][720,480] bounds=[0,0][720,480] è½¬ä¸ºå±‚çº§ç»“æ„å›¾ï¼š â€œRootâ€å³RootWindowContainerï¼Œâ€œDisplay 0â€ä»£è¡¨é»˜è®¤å±å¹•ï¼Œâ€œDisplay 2â€æ˜¯æˆ‘ä»¬å¼€å¯çš„è™šæ‹Ÿå±å¹•ã€‚ ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:2:7","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#27-windowcontainerå±‚çº§ç»“æ„æ ¹èŠ‚ç‚¹--rootwindowcontainer"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"2.8 å°ç»“ åœ¨ä»£ç æœç´¢WindowContainerçš„ç»§æ‰¿å…³ç³»ï¼Œå¯ä»¥å¾—åˆ°ï¼š é™¤äº†ä¸å‚ä¸WindowContainerå±‚çº§ç»“æ„çš„WindowingLayerContainerä¹‹å¤–ï¼Œå…¶ä»–ç±»éƒ½åœ¨æœ¬æ–‡æœ‰æåŠï¼Œç”¨ç±»å›¾æ€»ç»“ä¸ºï¼š é™¤äº†WindowStateå¯ä»¥æ˜¾ç¤ºå›¾åƒå¤–ï¼Œå¤§éƒ¨åˆ†çš„WindowContainerï¼Œå¦‚WindowTokenã€TaskDisplayAreaæ˜¯ä¸ä¼šæœ‰å†…å®¹æ˜¾ç¤ºçš„ï¼Œéƒ½åªæ˜¯ä¸€ä¸ªæŠ½è±¡çš„å®¹å™¨æ¦‚å¿µï¼Œè¯´ç™½äº†å°±æ˜¯ä¸€ä¸ªæ”¶çº³ç”¨çš„å®¹å™¨ã€‚æç«¯ç‚¹è¯´ï¼ŒWMSå¦‚æœåªä¸ºäº†ç®¡ç†çª—å£ï¼ŒWMSä¹Ÿå¯ä»¥ä¸åˆ›å»ºè¿™äº›ä¸ªWindowContainerç±»ï¼Œç›´æ¥ç”¨ä¸€ä¸ªWindowStateçš„åˆ—è¡¨ç®¡ç†å±å¹•ä¸Šçš„æ‰€æœ‰çª—å£ã€‚ä½†æ˜¯ä¸ºäº†æ›´æœ‰é€»è¾‘åœ°ç®¡ç†å±å¹•ä¸Šæ˜¾ç¤ºçš„çª—å£ï¼Œæ¯”å¦‚å“ªäº›çª—å£å±äºåŒä¸€ä¸ªActivityï¼Ÿå“ªäº›Activityå±äºåŒä¸€ä¸ªAppï¼Ÿå¦‚ä½•å°†Appçª—å£å’ŒéAppçª—å£æ¸…æ¥šå¾—åˆ†éš”å¼€ï¼Ÿå› æ­¤è¿˜æ˜¯éœ€è¦åˆ›å»ºå„ç§å„æ ·çš„çª—å£å®¹å™¨ç±»ï¼Œå³WindowContaineråŠå…¶å­ç±»ï¼Œæ¥å¯¹WindowStateè¿›è¡Œåˆ†ç±»ï¼Œå¹¶ä¸”æ¯ä¸€ç§WindowContaineré€šå¸¸éƒ½ç”±å¦å¤–ä¸€ç§ä¸“é—¨çš„WindowContaineræ¥ç®¡ç†ï¼Œä»è€Œå¯¹çª—å£è¿›è¡Œå±‚æ¬¡åŒ–çš„ç®¡ç†ã€‚è¿™ç§å±‚æ¬¡åŒ–ç®¡ç†ä¿è¯äº†æ¯ä¸€ä¸ªWiindowContaineréƒ½ä¼šåœ¨å…¶å¯¹åº”çš„çˆ¶å®¹å™¨ä¸­è¿›è¡Œè°ƒæ•´è€Œä¸ä¼šè¶Šç•Œã€‚è¿™ä¸ªä¸€ç‚¹å¾ˆé‡è¦ï¼Œæ¯”å¦‚æˆ‘ç‚¹å‡»HOMEé”®å›åˆ°Launcherï¼Œæ­¤æ—¶TaskDisplayAreaå°±ä¼šæŠŠLauncherå¯¹åº”çš„Taskï¼Œç§»åŠ¨åˆ°å®ƒæ‰€å¯¹åº”çš„å †æ ˆé¡¶éƒ¨ï¼Œè€Œè¿™ä¸ªè°ƒæ•´ä»…é™äºTaskDisplayAreaå†…éƒ¨ï¼ˆå› ä¸ºTaskDisplayAreaæ˜¯Taskçš„å®¹å™¨ï¼‰ï¼Œè¿™å°±ä¿è¯äº†å†æ€ä¹ˆè°ƒæ•´Launcherï¼ŒLauncherçš„çª—å£ä¹Ÿæ°¸è¿œä¸å¯èƒ½é«˜äºStatusBarçª—å£ï¼Œä¹Ÿä¸ä¼šä½äºWallpaperçª—å£ã€‚ å¦å¤–è¿™ä¸ªå±‚çº§ç»“æ„å»ºç«‹èµ·æ¥åï¼Œå¯¹çª—å£çš„éå†ä¹Ÿæ˜¯åŸºäºè¿™ä¸ªå±‚çº§ç»“æ„ã€‚æ¯”å¦‚å‘ç”Ÿè½¬å±åï¼ŒDisplayContentä¼šåŸºäºæ–°çš„å±å¹•æ–¹å‘é‡æ–°è®¡ç®—Configurationï¼Œç„¶åæŒ‰ç…§è¿™ä¸ªå±‚çº§ç»“æ„çš„é¡ºåºï¼Œä¾æ¬¡æŠŠè¿™ä¸ªæ–°è®¡ç®—çš„Configurationå‘ç»™æ¯ä¸€ä¸ªWindowContainerï¼Œæœ€ç»ˆæ¯ä¸€ä¸ªWindowContaineréƒ½èƒ½åŸºäºæ–°çš„Configurationæ›´æ–°è‡ªå·±çš„Configurationï¼Œè€Œéæ¯ä¸€ä¸ªWindowContaineréƒ½éœ€è¦é‡æ–°å»è®¡ç®—ä¸€æ¬¡Configurationï¼Œå¹¶ä¸”å¤§éƒ¨åˆ†çš„æ›´æ–°å…¶å®éƒ½æ˜¯ç›´æ¥æ‹¿ä»çˆ¶å®¹å™¨ä¼ è¿‡æ¥çš„Configurationèµ‹å€¼ç»™è‡ªå·±çš„Configurationï¼ˆç›¸å½“äºå®Œå…¨ç»§æ‰¿äº†çˆ¶å®¹å™¨çš„Configurationï¼Œå½“ç„¶ä¼šæœ‰ä¸€äº›WindowContainerä¼šæ˜¾å¼çš„å£°æ˜è‡ªå·±æœ‰ç‹¬ç‰¹çš„ç­–ç•¥ï¼Œä¸ä¼šå®Œå…¨ç»§æ‰¿çˆ¶å®¹å™¨çš„Configurationï¼Œä½†è¿™åªæ˜¯å°‘æ•°ï¼‰ã€‚è¿™ä½“ç°å®¹å™¨çš„ä¸€ä¸ªç‰¹æ€§ï¼Œå³ç»§æ‰¿ç‰¹æ€§ï¼Œæ¯”å¦‚ä½ æŠŠä¸€ä¸ªç›’å­ç¿»è½¬ï¼Œé‚£ä¹ˆç›’å­é‡Œçš„å°ç›’å­ä¹Ÿä¼šè·Ÿç€ç¿»è½¬ï¼Œè€Œä¸æ˜¯æ¯ä¸€ä¸ªå°ç›’å­å†å»è€ƒè™‘è¦ä¸è¦ç¿»è½¬ã€‚å†ä¸¾ä¸€ä¸ªä¾‹å­å°±æ˜¯ï¼Œåˆ†å±æ¨¡å¼ä¸‹ï¼Œæˆ‘ä»¬åªéœ€è¦è®¡ç®—å¥½åˆ†å±Taskçš„boundsï¼ŒTaské‡Œçš„ActivityRecordä»¥åŠActivityRecordé‡Œçš„WindowStateï¼Œä¼šè‡ªåŠ¨ç»§æ‰¿Taskçš„Configurationï¼Œå˜æˆå’ŒTaskåŒæ ·çš„å¤§å°ï¼ˆå¤§ç›’å­ç¼©å°åï¼Œé‡Œé¢çš„å°ç›’å­ä¼šè·Ÿéšå¤§ç›’å­ç¼©å°ï¼‰ã€‚ ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:2:8","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#28-å°ç»“"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"3 Windowçš„åº•å±‚å®ç° â€”â€” Layerå±‚çº§ç»“æ„ ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:3:0","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#3-windowçš„åº•å±‚å®ç°--layerå±‚çº§ç»“æ„"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"3.1 LayeråŸºç¡€æ¦‚å¿µ ä¹‹å‰æˆ‘ä»¬å¯èƒ½ä¼šè®¤ä¸ºçª—å£å°±æ˜¯å±å¹•ä¸Šä¸€å—æ˜¾ç¤ºå›¾åƒçš„åŒºåŸŸï¼Œè¿™ä¸ªå½“ç„¶ä¸é”™ï¼Œä½†æ˜¯åä¹‹ä¸ä¸€æ ·æˆç«‹ï¼Œå³å±å¹•ä¸Šä¸€å—æ˜¾ç¤ºå›¾åƒçš„åŒºåŸŸä¸ä¸€å®šå°±æ˜¯ä¸€ä¸ªçª—å£ï¼Œä½†æ˜¯å®ƒä¸€å®šæ˜¯ä¸€ä¸ªLayerã€‚è‡³äºLayerï¼Œåˆ™ä¸€ä¸ªæ¯”çª—å£æ›´åº•å±‚çš„å®ç°ï¼Œä»£è¡¨å±å¹•ä¸Šä¸€å—æ˜¾ç¤ºå†…å®¹çš„åŒºåŸŸï¼š SurfaceFlingerå¦‚æœè¦å°†æ‰€æœ‰Layerè¿›è¡Œåˆæˆï¼Œé‚£ä¹ˆéœ€è¦çŸ¥é“æ¯ä¸€ä¸ªLayerçš„ä¸¤ä¸ªåŸºæœ¬ä¿¡æ¯ï¼š æ˜¾ç¤ºè¾¹æ¡†/è¾¹ç•Œï¼Œå³è¯¥Layeråœ¨å±å¹•ä¸Šçš„æ˜¾ç¤ºä½ç½®ï¼ˆxå’Œyï¼‰å’Œå¤§å°ï¼ˆwå’Œhï¼‰ã€‚ æ˜¾ç¤ºå†…å®¹ï¼Œå³è¯¥Layeræ‰€ç»˜åˆ¶å›¾åƒçš„å›¾å½¢æ•°æ®ï¼Œä¿å­˜åœ¨Layeræ‹¥æœ‰çš„å›¾å½¢ç¼“å†²åŒºä¸­ã€‚ è¿™ä¸¤ä¸ªä¿¡æ¯éœ€è¦WMSå’ŒAppè¿™ä¸¤æ–¹åˆ†åˆ«æä¾›ï¼š WMSä½œä¸ºçª—å£ç®¡ç†æœåŠ¡ï¼Œæ¯ä¸€ä¸ªçª—å£è¦æ˜¾ç¤ºå¤šå¤§ï¼Œæ˜¾ç¤ºåœ¨å“ªå„¿ï¼Œè‡ªç„¶æ˜¯ç”±å®ƒæ¥å†³å®šã€‚ Appå†³å®šå®ƒå®šä¹‰çš„æ¯ä¸€ä¸ªç•Œé¢çš„å…·ä½“ç»˜åˆ¶å†…å®¹ï¼Œè¿™ä¸ªä¹Ÿä¸ç”¨å¤šè¯´ã€‚ SurfaceFlingeræ‹¿åˆ°ä»WMSå’ŒAppä¼ è¿‡æ¥çš„æ•°æ®ï¼Œå°†æ‰€æœ‰Layeråˆæˆé€æ˜¾ã€‚ é‚£ä¹ˆè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¤„äºä¸åŒçš„è¿›ç¨‹çš„Appã€WMSä»¥åŠSurfaceFlingerï¼Œé€šè¿‡ä»€ä¹ˆæ–¹å¼æ¥è¿›è¡Œä¿¡æ¯ä¼ é€’ï¼Ÿ 1ï¼‰ã€å½“Appè¿›å…¥å‰å°æ—¶ï¼ŒWMSä¼šå‘SurfaceFlingerè¯·æ±‚ä¸ºAppåˆ›å»ºLayerã€‚ 2ï¼‰ã€SurfaceFlingeråˆ›å»ºLayeråï¼Œè¿”å›ç»™WMSä¸€ä¸ªè¯¥Layerå¯¹åº”çš„SurfaceControlå¯¹è±¡ã€‚WMSæŒæœ‰è¿™äº›SurfaceControlï¼Œå¹¶ä¸”åç»­å¯ä»¥é€šè¿‡SurfaceControlå‘SurfaceFlingeræä¾›çª—å£å…ƒæ•°æ®ï¼Œç”¨æ¥æ§åˆ¶Appåœ¨å±å¹•ä¸Šçš„å¤–è§‚ã€‚ 3ï¼‰ã€WMSå°†SurfaceControlå‘é€ç»™Appï¼ŒAppä¼šæ ¹æ®SurfaceControlåˆ›å»ºBufferQueueå’ŒSurfaceã€‚SurfaceæŒæœ‰ä¸€ç»„å›¾å½¢ç¼“å†²åŒºï¼Œå¹¶ä¸”é“¾æ¥äº†BufferQueueä¸­çš„å›¾åƒç”Ÿäº§è€…BufferQueueProducerï¼Œåç»­ç”±å®ƒä»¬æ¥å‘SurfaceFlingeræä¾›ç»˜åˆ¶äº†å†…å®¹çš„å›¾å½¢ç¼“å†²åŒºã€‚ æ€»çš„æ¥è¯´ï¼ŒSurfaceFlingeræ¶ˆè´¹Surfaceç”Ÿäº§çš„å›¾åƒç¼“å†²åŒºï¼Œå¹¶ä½¿ç”¨WMSé€šè¿‡SurfaceControlæä¾›çš„çª—å£å…ƒæ•°æ®ï¼Œæ¥å¯¹Layerè¿›è¡Œåˆæˆï¼Œå› æ­¤Layeræ˜¯Surfaceï¼ˆåŒ…å« BufferQueueï¼‰å’ŒSurfaceControlï¼ˆåŒ…å«æ˜¾ç¤ºè¾¹æ¡†ç­‰çª—å£å…ƒæ•°æ®ï¼‰çš„ç»„åˆã€‚ ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:3:1","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#31-layeråŸºç¡€æ¦‚å¿µ"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"3.2 Layerå±‚çº§ç»“æ„ å†æ¥çœ‹ä¸€æ®µSurfaceFlingerçš„ä¿¡æ¯ï¼š + EffectLayer (Task=16#0) uid=1000 Region TransparentRegion (this=0 count=0) Region VisibleRegion (this=0 count=0) Region SurfaceDamageRegion (this=0 count=0) layerStack= 0, z= 11, pos=(0,0), size=( -1, -1), crop=[ 0, 0, 0, 0], cornerRadius=0.000000, isProtected=0, isTrustedOverlay=0, isOpaque=0, invalidate=0, dataspace=De fault, defaultPixelFormat=Unknown/None, backgroundBlurRadius=0, color=(-1.000,-1.000,-1.000,1.000), flags=0x00000000, tr=[1.00, 0.00][0.00, 1.00], mBounds=[0.00, 0.00, 1200.00, 1920.00], l ayerId=0 parent=DefaultTaskDisplayArea#0 zOrderRelativeOf=none activeBuffer=[ 0x 0: 0,Unknown/None], tr=[0.00, 0.00][0.00, 0.00] queued-frames=0, mRefreshPending=0, metadata={taskId:16}, cornerRadiusCrop=[0.00, 0.00, 0.00, 0.00], shadowRa dius=0.000, + ContainerLayer (1c7dd1d ActivityRecordInputSink com.android.settings/.Settings#0) uid=1000 Region TransparentRegion (this=0 count=0) Region VisibleRegion (this=0 count=0) Region SurfaceDamageRegion (this=0 count=0) layerStack= 0, z=-2147483648, pos=(0,0), size=( -1, -1), crop=[ 0, 0, -1, -1], cornerRadius=0.000000, isProtected=0, isTrustedOverlay=0, isOpaque=0, invalidate=1, dataspace= Default, defaultPixelFormat=Unknown/None, backgroundBlurRadius=0, color=(0.000,0.000,0.000,1.000), flags=0x00000000, tr=[1.00, 0.00][0.00, 1.00], mBounds=[0.00, 0.00, 1200.00, 1920.00], la yerId=0 parent=ActivityRecord{8e62b92 u0 com.android.settings/.Settings t16}#0 zOrderRelativeOf=none activeBuffer=[ 0x 0: 0,Unknown/None], tr=[0.00, 0.00][0.00, 0.00] queued-frames=0, mRefreshPending=0, metadata={}, cornerRadiusCrop=[0.00, 0.00, 0.00, 0.00], shadowRadius=0.00 0, + ContainerLayer (ActivityRecord{8e62b92 u0 com.android.settings/.Settings t16}#0) uid=1000 Region TransparentRegion (this=0 count=0) Region VisibleRegion (this=0 count=0) Region SurfaceDamageRegion (this=0 count=0) layerStack= 0, z= 0, pos=(0,0), size=( -1, -1), crop=[ 0, 0, -1, -1], cornerRadius=0.000000, isProtected=0, isTrustedOverlay=0, isOpaque=0, invalidate=1, dataspace=De fault, defaultPixelFormat=Unknown/None, backgroundBlurRadius=0, color=(0.000,0.000,0.000,1.000), flags=0x00000000, tr=[1.00, 0.00][0.00, 1.00], mBounds=[0.00, 0.00, 1200.00, 1920.00], laye rId=0 parent=Task=16#0 zOrderRelativeOf=none activeBuffer=[ 0x 0: 0,Unknown/None], tr=[0.00, 0.00][0.00, 0.00] queued-frames=0, mRefreshPending=0, metadata={}, cornerRadiusCrop=[0.00, 0.00, 0.00, 0.00], shadowRadius=0.00 0, + ContainerLayer (5cadaf2 com.android.settings/com.android.settings.Settings#0) uid=1000 Region TransparentRegion (this=0 count=0) Region VisibleRegion (this=0 count=0) Region SurfaceDamageRegion (this=0 count=0) layerStack= 0, z= 0, pos=(0,0), size=( -1, -1), crop=[ 0, 0, -1, -1], cornerRadius=0.000000, isProtected=0, isTrustedOverlay=0, isOpaque=0, invalidate=1, dataspace=De fault, defaultPixelFormat=Unknown/None, backgroundBlurRadius=0, color=(0.000,0.000,0.000,1.000), flags=0x00000000, tr=[1.00, 0.00][0.00, 1.00], mBounds=[0.00, 0.00, 1200.00, 1920.00], laye rId=0 parent=ActivityRecord{8e62b92 u0 com.android.settings/.Settings t16}#0 zOrderRelativeOf=none activeBuffer=[ 0x 0: 0,Unknown/None], tr=[0.00, 0.00][0.00, 0.00] queued-frames=0, mRefreshPending=0, metadata={}, cornerRadiusCrop=[0.00, 0.00, 0.00, 0.00], shadowRadius=0.00 0, + BufferStateLayer (com.android.settings/com.android.settings.Settings#0) uid=1000 Region TransparentRegion (this=0 count=0) Region VisibleRegion (this=0 count=1) [ 0, 0, 1200, 1920] Region SurfaceDamageRegion (this=0 count=1) [ 0, 286, 1200, 1824] layerStack= 0, z= 0, pos=(0,0), size=(1200,1920), crop=[ 0, 0, -1, -1], cornerRadius=0.000000, isProtected=0, isTrustedOverlay=0, isOpaque=1, invalidate=0, dataspace=De fault, defaultPixelFormat=RGBA_8888, backgroundBlurRadius=0, color=(0.000,0.000,0.000,1.000), flags=0x00000102, tr=[1.00, 0.00][0.00, 1.00], mBounds=[0.00, 0.00, 1200.00, 1920.00], layerId =0 parent=5cadaf2 com.android.settings/com.android.settings.Settings#0 zOrderRelativeOf","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:3:2","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#32-layerå±‚çº§ç»“æ„"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"3.3 Leash ä»¥ä¸€ä¸ªä»Launcherå¯åŠ¨Settingsçš„åŠ¨ç”»è¿‡ç¨‹ä¸ºä¾‹æ¥è¯´æ˜ä¸€ä¸‹Leashçš„ç”¨æ³•ï¼Œç”±äºæ˜¯Appä»åå°ç§»åŠ¨åˆ°å‰å°ï¼Œå› æ­¤åŠ¨ç”»çš„ä¸»ä½“æ˜¯Taskã€‚ 3.3.1 åŠ¨ç”»å‰ åŠ¨ç”»å‰Task#16ç›¸å…³çš„å±‚çº§ç»“æ„æ˜¯ï¼š Task#16çš„Layerå±‚çº§ç»“æ„ï¼Œæˆ‘ä»¬ä¸Šé¢ä¹Ÿè¯´æ˜è¿‡äº†ï¼Œè¿™é‡Œé¢å¤–åŠ å…¥äº†å®ƒçš„çˆ¶Layerï¼ŒDefaultTaskDisplayAreaã€‚ æ­¤æ—¶æ²¡æœ‰BufferStateLayerï¼Œå› ä¸ºæ­¤æ—¶Settingsè¿˜åœ¨åå°ï¼Œçª—å£å¹¶æ²¡æœ‰ç»˜åˆ¶ã€‚ 3.3.2 åŠ¨ç”»ä¸­ åŠ¨ç”»è¿‡ç¨‹ä¸­Task#16ç›¸å…³çš„å±‚çº§ç»“æ„æ˜¯ï¼š è¿™é‡Œå¤šäº†ä¸¤ä¸ªLayerï¼š BufferStateLayerï¼Œçª—å£ç»˜åˆ¶å®Œæˆåæ‰å¼€å§‹çš„åŠ¨ç”»ï¼Œæ‰€ä»¥åŠ¨ç”»è¿‡ç¨‹ä¸­BufferStateLayerå·²ç»åœ¨äº†ã€‚ ä¸€ä¸ªåä¸ºâ€animation-leash of app_transitionâ€œçš„Layerï¼Œä¸”è¯¥Layeræ’åœ¨äº†DefaultTaskDisplayAreaå’ŒTaskä¸­é—´ã€‚ Leashçš„è¿™ç§è¡Œä¸ºæœ‰ç‚¹åƒæˆ‘ä»¬ä¹‹å‰åˆ†æFreeformçš„æ—¶å€™DecorCaptionViewçš„åšæ³•ï¼š 1ï¼‰ã€å…ˆåˆ›å»ºä¸€ä¸ªLeashï¼Œç„¶åæŒ‡å®šè¯¥Leashå¯¹åº”çš„Layerçš„çˆ¶Layerä¸ºåŠ¨ç”»çš„ä¸»ä½“ï¼ˆè¿™ä¸ªä¾‹å­æ˜¯Taskï¼‰çš„çˆ¶Layerï¼ˆDefaultTaskDisplayAreaï¼‰ã€‚ 2ï¼‰ã€æ¥ç€å°†Taskå¯¹åº”çš„Layerä»åŸçˆ¶Layerï¼ˆDefaultTaskDisplayAreaï¼‰ä¸Šå‰¥ç¦»ï¼Œå˜ä¸ºLeashçš„å­Layerï¼ˆå°†ä¸€ä¸ªå­Layerä»åŸçˆ¶Layeré‡å®šå‘åˆ°ä¸€ä¸ªæ–°çš„çˆ¶Layerä¸Šï¼Œç§°ä¸ºreparentæ“ä½œï¼‰ã€‚ ä»è€Œå®ç°åœ¨DefaultTaskDisplayAreaå’ŒTaskä¸­æ’è¿›ä¸€ä¸ªLeashçš„æ“ä½œã€‚ æ³¨æ„æ­¤æ—¶æ‰§è¡ŒåŠ¨ç”»çš„å¯¹è±¡æ˜¯Leashï¼Œè€ŒéTaskã€‚ä½†ç”±äºTaskçš„çˆ¶Layeræ˜¯Leashï¼Œæ‰€ä»¥Leashç§»åŠ¨ï¼ŒTaskä¼šè·Ÿç€ç§»åŠ¨ï¼Œæˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ°çš„BufferStateLayerä¹Ÿä¼šè·Ÿç€ç§»åŠ¨ã€‚ 3.3.3 åŠ¨ç”»å åŠ¨ç”»ç»“æŸåTask#16ç›¸å…³çš„å±‚çº§ç»“æ„æ˜¯ï¼š åŠ¨ç”»ç»“æŸï¼ŒLeashå·²ç»å®Œæˆäº†å®ƒçš„ä»»åŠ¡ï¼Œå¯ä»¥æ’¤äº†ï¼Œä½†æ˜¯åœ¨æ’¤ä¹‹å‰éœ€è¦å°†ç»‘å®šåœ¨Leashä¸Šçš„Taské‡æ–°reparentå›åŸçˆ¶Layerä¸Šï¼ˆDefaultTaskDisplayAreaï¼‰ã€‚ 3.3.4 å°ç»“ ä¸Šé¢çš„ä¾‹å­å¤§è‡´è¯´æ˜äº†Leashçš„è¿è¡Œæœºåˆ¶ï¼Œè¿™å…¶ä¸­æœ‰3ä¸ªLayerå‚ä¸ï¼Œä¸€ä¸ªæ˜¯åŠ¨ç”»ä¸»ä½“ï¼ˆTaskï¼‰ï¼Œä¸€ä¸ªæ˜¯åŠ¨ç”»ä¸»ä½“çš„çˆ¶Layerï¼ˆDefaultTaskDisplayAreaï¼‰ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯Leashã€‚ Leashçš„ä½œç”¨å³æ˜¯ä»£æ›¿åŠ¨ç”»çš„ä¸»ä½“å»æ‰§è¡ŒåŠ¨ç”»ï¼š 1ï¼‰ã€åˆ›å»ºLeashï¼Œå°†Leashç»‘å®šåˆ°åŠ¨ç”»ä¸»ä½“çš„çˆ¶Layerä¸Šï¼ŒåŠ¨ç”»ä¸»ä½“åˆ™reparentåˆ°Leashä¸Šã€‚ 2ï¼‰ã€å¯¹Leashè¿›è¡ŒåŠ¨ç”»ï¼Œè€ŒéåŠ¨ç”»ä¸»ä½“ã€‚ 3ï¼‰ã€åŠ¨ç”»ç»“æŸåï¼Œå°†åŠ¨ç”»ä¸»ä½“reparentå›åŸçˆ¶Layerä¸Šï¼Œç§»é™¤Leashã€‚ è‡³äºä¸ºä»€ä¹ˆè¦æLeashè¿™ä¹ˆä¸€ä¸ªä¸œè¥¿å‡ºæ¥ï¼Œæˆ‘ä¸ªäººè®¤ä¸ºæ˜¯ï¼Œå¦‚æœç›´æ¥å¯¹åŠ¨ç”»ä¸»ä½“æ‰§è¡ŒåŠ¨ç”»ï¼Œé‚£ä¹ˆå°±ä¼šæ¶‰åŠä¸€ä¸ªæ¢å¤çš„æ“ä½œã€‚æ¯”å¦‚è¯´å¯¹Activityé—´çš„åˆ‡æ¢ï¼Œå¦‚æœä¸ç”¨Leashç›´æ¥å¯¹Activityè¿›è¡Œæ“ä½œï¼Œé‚£ä¹ˆæƒ…å†µæ˜¯ï¼šæ—§çš„Activityåˆ‡èµ°çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šæœ‰ä¸€ä¸ªå‘å·¦å¹³ç§»çš„åŠ¨ç”»ï¼Œåç»­å¦‚æœæˆ‘ä»¬æƒ³è¦è¿™ä¸ªæ—§çš„Activityé‡æ–°å‡ºç°ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸ä»…éœ€è¦å°†å®ƒæ˜¾ç¤ºå‡ºæ¥ï¼Œè¿˜éœ€è¦å°†å®ƒä»ä¹‹å‰çš„åŠ¨ç”»ç»“æŸä½ç½®å‘å³å¹³ç§»ï¼Œè¿™æ ·å®ƒæ‰èƒ½å‡ºç°åœ¨å±å¹•ä¸Šã€‚å¹¶ä¸”æˆ‘ä»¬çš„åŠ¨ç”»è¶Šå¤æ‚ï¼Œæ¢å¤éœ€è¦çš„æ­¥éª¤ä¹Ÿå°±è¶Šå¤šã€‚ å¦‚æœæˆ‘ä»¬æŠŠåŠ¨ç”»ä¸»ä½“reparentåˆ°Leashä¸Šï¼Œç„¶åå¯¹Leashè¿›è¡Œç›¸åŒçš„åŠ¨ç”»ï¼Œä¸ä»…èƒ½è¾¾åˆ°åŒæ ·çš„æ•ˆæœï¼Œè€Œä¸”ä¸ç®¡æˆ‘ä»¬å¯¹Leashå¦‚ä½•è¿›è¡ŒåŠ¨ç”»ï¼Œåªè¦åœ¨åŠ¨ç”»ç»“æŸåå°†åŠ¨ç”»ä¸»ä½“reparentå›åŸæ¥çš„çˆ¶Layerä¸Šï¼Œå°±å¯ä»¥æ¢å¤åŸçŠ¶ï¼Œè€Œä¸ç”¨åƒä¸Šé¢ä¸€æ ·è€ƒè™‘è¦åšå¤šå°‘ç›¸åçš„æ“ä½œæ‰èƒ½æ¢å¤åŸçŠ¶ã€‚ æœ€åï¼ŒLeashç†è®ºä¸Šå¯ä»¥è¢«åº”ç”¨åˆ°ä»»ä½•å¸Œæœ›è¿›è¡ŒåŠ¨ç”»çš„Surfaceä¸Šï¼Œæ¯”å¦‚è¿™é‡Œä¸¾çš„ä¾‹å­æ˜¯åº”ç”¨åˆ°äº†Taskä¸Šï¼Œå› ä¸ºè¿™ä¸ªåŠ¨ç”»å‘ç”ŸäºAppé—´çš„åˆ‡æ¢è¿‡ç¨‹ä¸­ã€‚å¦‚æœæ˜¯Activityé—´çš„åˆ‡æ¢ï¼Œé‚£ä¹ˆLeashå°±å¯ä»¥åº”ç”¨åˆ°ActivityRecordï¼ŒåŒæ ·WindowStateä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä¸»è¦çœ‹åŠ¨ç”»çš„ä¸»ä½“æ˜¯æ•´ä¸ªAppï¼Ÿè¿˜æ˜¯å•ä¸ªActivityï¼Ÿè¿˜æ˜¯æŸä¸ªçª—å£ï¼Ÿ ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:3:3","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#33-leash"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"3.3 Leash ä»¥ä¸€ä¸ªä»Launcherå¯åŠ¨Settingsçš„åŠ¨ç”»è¿‡ç¨‹ä¸ºä¾‹æ¥è¯´æ˜ä¸€ä¸‹Leashçš„ç”¨æ³•ï¼Œç”±äºæ˜¯Appä»åå°ç§»åŠ¨åˆ°å‰å°ï¼Œå› æ­¤åŠ¨ç”»çš„ä¸»ä½“æ˜¯Taskã€‚ 3.3.1 åŠ¨ç”»å‰ åŠ¨ç”»å‰Task#16ç›¸å…³çš„å±‚çº§ç»“æ„æ˜¯ï¼š Task#16çš„Layerå±‚çº§ç»“æ„ï¼Œæˆ‘ä»¬ä¸Šé¢ä¹Ÿè¯´æ˜è¿‡äº†ï¼Œè¿™é‡Œé¢å¤–åŠ å…¥äº†å®ƒçš„çˆ¶Layerï¼ŒDefaultTaskDisplayAreaã€‚ æ­¤æ—¶æ²¡æœ‰BufferStateLayerï¼Œå› ä¸ºæ­¤æ—¶Settingsè¿˜åœ¨åå°ï¼Œçª—å£å¹¶æ²¡æœ‰ç»˜åˆ¶ã€‚ 3.3.2 åŠ¨ç”»ä¸­ åŠ¨ç”»è¿‡ç¨‹ä¸­Task#16ç›¸å…³çš„å±‚çº§ç»“æ„æ˜¯ï¼š è¿™é‡Œå¤šäº†ä¸¤ä¸ªLayerï¼š BufferStateLayerï¼Œçª—å£ç»˜åˆ¶å®Œæˆåæ‰å¼€å§‹çš„åŠ¨ç”»ï¼Œæ‰€ä»¥åŠ¨ç”»è¿‡ç¨‹ä¸­BufferStateLayerå·²ç»åœ¨äº†ã€‚ ä¸€ä¸ªåä¸ºâ€animation-leash of app_transitionâ€œçš„Layerï¼Œä¸”è¯¥Layeræ’åœ¨äº†DefaultTaskDisplayAreaå’ŒTaskä¸­é—´ã€‚ Leashçš„è¿™ç§è¡Œä¸ºæœ‰ç‚¹åƒæˆ‘ä»¬ä¹‹å‰åˆ†æFreeformçš„æ—¶å€™DecorCaptionViewçš„åšæ³•ï¼š 1ï¼‰ã€å…ˆåˆ›å»ºä¸€ä¸ªLeashï¼Œç„¶åæŒ‡å®šè¯¥Leashå¯¹åº”çš„Layerçš„çˆ¶Layerä¸ºåŠ¨ç”»çš„ä¸»ä½“ï¼ˆè¿™ä¸ªä¾‹å­æ˜¯Taskï¼‰çš„çˆ¶Layerï¼ˆDefaultTaskDisplayAreaï¼‰ã€‚ 2ï¼‰ã€æ¥ç€å°†Taskå¯¹åº”çš„Layerä»åŸçˆ¶Layerï¼ˆDefaultTaskDisplayAreaï¼‰ä¸Šå‰¥ç¦»ï¼Œå˜ä¸ºLeashçš„å­Layerï¼ˆå°†ä¸€ä¸ªå­Layerä»åŸçˆ¶Layeré‡å®šå‘åˆ°ä¸€ä¸ªæ–°çš„çˆ¶Layerä¸Šï¼Œç§°ä¸ºreparentæ“ä½œï¼‰ã€‚ ä»è€Œå®ç°åœ¨DefaultTaskDisplayAreaå’ŒTaskä¸­æ’è¿›ä¸€ä¸ªLeashçš„æ“ä½œã€‚ æ³¨æ„æ­¤æ—¶æ‰§è¡ŒåŠ¨ç”»çš„å¯¹è±¡æ˜¯Leashï¼Œè€ŒéTaskã€‚ä½†ç”±äºTaskçš„çˆ¶Layeræ˜¯Leashï¼Œæ‰€ä»¥Leashç§»åŠ¨ï¼ŒTaskä¼šè·Ÿç€ç§»åŠ¨ï¼Œæˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ°çš„BufferStateLayerä¹Ÿä¼šè·Ÿç€ç§»åŠ¨ã€‚ 3.3.3 åŠ¨ç”»å åŠ¨ç”»ç»“æŸåTask#16ç›¸å…³çš„å±‚çº§ç»“æ„æ˜¯ï¼š åŠ¨ç”»ç»“æŸï¼ŒLeashå·²ç»å®Œæˆäº†å®ƒçš„ä»»åŠ¡ï¼Œå¯ä»¥æ’¤äº†ï¼Œä½†æ˜¯åœ¨æ’¤ä¹‹å‰éœ€è¦å°†ç»‘å®šåœ¨Leashä¸Šçš„Taské‡æ–°reparentå›åŸçˆ¶Layerä¸Šï¼ˆDefaultTaskDisplayAreaï¼‰ã€‚ 3.3.4 å°ç»“ ä¸Šé¢çš„ä¾‹å­å¤§è‡´è¯´æ˜äº†Leashçš„è¿è¡Œæœºåˆ¶ï¼Œè¿™å…¶ä¸­æœ‰3ä¸ªLayerå‚ä¸ï¼Œä¸€ä¸ªæ˜¯åŠ¨ç”»ä¸»ä½“ï¼ˆTaskï¼‰ï¼Œä¸€ä¸ªæ˜¯åŠ¨ç”»ä¸»ä½“çš„çˆ¶Layerï¼ˆDefaultTaskDisplayAreaï¼‰ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯Leashã€‚ Leashçš„ä½œç”¨å³æ˜¯ä»£æ›¿åŠ¨ç”»çš„ä¸»ä½“å»æ‰§è¡ŒåŠ¨ç”»ï¼š 1ï¼‰ã€åˆ›å»ºLeashï¼Œå°†Leashç»‘å®šåˆ°åŠ¨ç”»ä¸»ä½“çš„çˆ¶Layerä¸Šï¼ŒåŠ¨ç”»ä¸»ä½“åˆ™reparentåˆ°Leashä¸Šã€‚ 2ï¼‰ã€å¯¹Leashè¿›è¡ŒåŠ¨ç”»ï¼Œè€ŒéåŠ¨ç”»ä¸»ä½“ã€‚ 3ï¼‰ã€åŠ¨ç”»ç»“æŸåï¼Œå°†åŠ¨ç”»ä¸»ä½“reparentå›åŸçˆ¶Layerä¸Šï¼Œç§»é™¤Leashã€‚ è‡³äºä¸ºä»€ä¹ˆè¦æLeashè¿™ä¹ˆä¸€ä¸ªä¸œè¥¿å‡ºæ¥ï¼Œæˆ‘ä¸ªäººè®¤ä¸ºæ˜¯ï¼Œå¦‚æœç›´æ¥å¯¹åŠ¨ç”»ä¸»ä½“æ‰§è¡ŒåŠ¨ç”»ï¼Œé‚£ä¹ˆå°±ä¼šæ¶‰åŠä¸€ä¸ªæ¢å¤çš„æ“ä½œã€‚æ¯”å¦‚è¯´å¯¹Activityé—´çš„åˆ‡æ¢ï¼Œå¦‚æœä¸ç”¨Leashç›´æ¥å¯¹Activityè¿›è¡Œæ“ä½œï¼Œé‚£ä¹ˆæƒ…å†µæ˜¯ï¼šæ—§çš„Activityåˆ‡èµ°çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šæœ‰ä¸€ä¸ªå‘å·¦å¹³ç§»çš„åŠ¨ç”»ï¼Œåç»­å¦‚æœæˆ‘ä»¬æƒ³è¦è¿™ä¸ªæ—§çš„Activityé‡æ–°å‡ºç°ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸ä»…éœ€è¦å°†å®ƒæ˜¾ç¤ºå‡ºæ¥ï¼Œè¿˜éœ€è¦å°†å®ƒä»ä¹‹å‰çš„åŠ¨ç”»ç»“æŸä½ç½®å‘å³å¹³ç§»ï¼Œè¿™æ ·å®ƒæ‰èƒ½å‡ºç°åœ¨å±å¹•ä¸Šã€‚å¹¶ä¸”æˆ‘ä»¬çš„åŠ¨ç”»è¶Šå¤æ‚ï¼Œæ¢å¤éœ€è¦çš„æ­¥éª¤ä¹Ÿå°±è¶Šå¤šã€‚ å¦‚æœæˆ‘ä»¬æŠŠåŠ¨ç”»ä¸»ä½“reparentåˆ°Leashä¸Šï¼Œç„¶åå¯¹Leashè¿›è¡Œç›¸åŒçš„åŠ¨ç”»ï¼Œä¸ä»…èƒ½è¾¾åˆ°åŒæ ·çš„æ•ˆæœï¼Œè€Œä¸”ä¸ç®¡æˆ‘ä»¬å¯¹Leashå¦‚ä½•è¿›è¡ŒåŠ¨ç”»ï¼Œåªè¦åœ¨åŠ¨ç”»ç»“æŸåå°†åŠ¨ç”»ä¸»ä½“reparentå›åŸæ¥çš„çˆ¶Layerä¸Šï¼Œå°±å¯ä»¥æ¢å¤åŸçŠ¶ï¼Œè€Œä¸ç”¨åƒä¸Šé¢ä¸€æ ·è€ƒè™‘è¦åšå¤šå°‘ç›¸åçš„æ“ä½œæ‰èƒ½æ¢å¤åŸçŠ¶ã€‚ æœ€åï¼ŒLeashç†è®ºä¸Šå¯ä»¥è¢«åº”ç”¨åˆ°ä»»ä½•å¸Œæœ›è¿›è¡ŒåŠ¨ç”»çš„Surfaceä¸Šï¼Œæ¯”å¦‚è¿™é‡Œä¸¾çš„ä¾‹å­æ˜¯åº”ç”¨åˆ°äº†Taskä¸Šï¼Œå› ä¸ºè¿™ä¸ªåŠ¨ç”»å‘ç”ŸäºAppé—´çš„åˆ‡æ¢è¿‡ç¨‹ä¸­ã€‚å¦‚æœæ˜¯Activityé—´çš„åˆ‡æ¢ï¼Œé‚£ä¹ˆLeashå°±å¯ä»¥åº”ç”¨åˆ°ActivityRecordï¼ŒåŒæ ·WindowStateä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä¸»è¦çœ‹åŠ¨ç”»çš„ä¸»ä½“æ˜¯æ•´ä¸ªAppï¼Ÿè¿˜æ˜¯å•ä¸ªActivityï¼Ÿè¿˜æ˜¯æŸä¸ªçª—å£ï¼Ÿ ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:3:3","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#331-åŠ¨ç”»å‰"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"3.3 Leash ä»¥ä¸€ä¸ªä»Launcherå¯åŠ¨Settingsçš„åŠ¨ç”»è¿‡ç¨‹ä¸ºä¾‹æ¥è¯´æ˜ä¸€ä¸‹Leashçš„ç”¨æ³•ï¼Œç”±äºæ˜¯Appä»åå°ç§»åŠ¨åˆ°å‰å°ï¼Œå› æ­¤åŠ¨ç”»çš„ä¸»ä½“æ˜¯Taskã€‚ 3.3.1 åŠ¨ç”»å‰ åŠ¨ç”»å‰Task#16ç›¸å…³çš„å±‚çº§ç»“æ„æ˜¯ï¼š Task#16çš„Layerå±‚çº§ç»“æ„ï¼Œæˆ‘ä»¬ä¸Šé¢ä¹Ÿè¯´æ˜è¿‡äº†ï¼Œè¿™é‡Œé¢å¤–åŠ å…¥äº†å®ƒçš„çˆ¶Layerï¼ŒDefaultTaskDisplayAreaã€‚ æ­¤æ—¶æ²¡æœ‰BufferStateLayerï¼Œå› ä¸ºæ­¤æ—¶Settingsè¿˜åœ¨åå°ï¼Œçª—å£å¹¶æ²¡æœ‰ç»˜åˆ¶ã€‚ 3.3.2 åŠ¨ç”»ä¸­ åŠ¨ç”»è¿‡ç¨‹ä¸­Task#16ç›¸å…³çš„å±‚çº§ç»“æ„æ˜¯ï¼š è¿™é‡Œå¤šäº†ä¸¤ä¸ªLayerï¼š BufferStateLayerï¼Œçª—å£ç»˜åˆ¶å®Œæˆåæ‰å¼€å§‹çš„åŠ¨ç”»ï¼Œæ‰€ä»¥åŠ¨ç”»è¿‡ç¨‹ä¸­BufferStateLayerå·²ç»åœ¨äº†ã€‚ ä¸€ä¸ªåä¸ºâ€animation-leash of app_transitionâ€œçš„Layerï¼Œä¸”è¯¥Layeræ’åœ¨äº†DefaultTaskDisplayAreaå’ŒTaskä¸­é—´ã€‚ Leashçš„è¿™ç§è¡Œä¸ºæœ‰ç‚¹åƒæˆ‘ä»¬ä¹‹å‰åˆ†æFreeformçš„æ—¶å€™DecorCaptionViewçš„åšæ³•ï¼š 1ï¼‰ã€å…ˆåˆ›å»ºä¸€ä¸ªLeashï¼Œç„¶åæŒ‡å®šè¯¥Leashå¯¹åº”çš„Layerçš„çˆ¶Layerä¸ºåŠ¨ç”»çš„ä¸»ä½“ï¼ˆè¿™ä¸ªä¾‹å­æ˜¯Taskï¼‰çš„çˆ¶Layerï¼ˆDefaultTaskDisplayAreaï¼‰ã€‚ 2ï¼‰ã€æ¥ç€å°†Taskå¯¹åº”çš„Layerä»åŸçˆ¶Layerï¼ˆDefaultTaskDisplayAreaï¼‰ä¸Šå‰¥ç¦»ï¼Œå˜ä¸ºLeashçš„å­Layerï¼ˆå°†ä¸€ä¸ªå­Layerä»åŸçˆ¶Layeré‡å®šå‘åˆ°ä¸€ä¸ªæ–°çš„çˆ¶Layerä¸Šï¼Œç§°ä¸ºreparentæ“ä½œï¼‰ã€‚ ä»è€Œå®ç°åœ¨DefaultTaskDisplayAreaå’ŒTaskä¸­æ’è¿›ä¸€ä¸ªLeashçš„æ“ä½œã€‚ æ³¨æ„æ­¤æ—¶æ‰§è¡ŒåŠ¨ç”»çš„å¯¹è±¡æ˜¯Leashï¼Œè€ŒéTaskã€‚ä½†ç”±äºTaskçš„çˆ¶Layeræ˜¯Leashï¼Œæ‰€ä»¥Leashç§»åŠ¨ï¼ŒTaskä¼šè·Ÿç€ç§»åŠ¨ï¼Œæˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ°çš„BufferStateLayerä¹Ÿä¼šè·Ÿç€ç§»åŠ¨ã€‚ 3.3.3 åŠ¨ç”»å åŠ¨ç”»ç»“æŸåTask#16ç›¸å…³çš„å±‚çº§ç»“æ„æ˜¯ï¼š åŠ¨ç”»ç»“æŸï¼ŒLeashå·²ç»å®Œæˆäº†å®ƒçš„ä»»åŠ¡ï¼Œå¯ä»¥æ’¤äº†ï¼Œä½†æ˜¯åœ¨æ’¤ä¹‹å‰éœ€è¦å°†ç»‘å®šåœ¨Leashä¸Šçš„Taské‡æ–°reparentå›åŸçˆ¶Layerä¸Šï¼ˆDefaultTaskDisplayAreaï¼‰ã€‚ 3.3.4 å°ç»“ ä¸Šé¢çš„ä¾‹å­å¤§è‡´è¯´æ˜äº†Leashçš„è¿è¡Œæœºåˆ¶ï¼Œè¿™å…¶ä¸­æœ‰3ä¸ªLayerå‚ä¸ï¼Œä¸€ä¸ªæ˜¯åŠ¨ç”»ä¸»ä½“ï¼ˆTaskï¼‰ï¼Œä¸€ä¸ªæ˜¯åŠ¨ç”»ä¸»ä½“çš„çˆ¶Layerï¼ˆDefaultTaskDisplayAreaï¼‰ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯Leashã€‚ Leashçš„ä½œç”¨å³æ˜¯ä»£æ›¿åŠ¨ç”»çš„ä¸»ä½“å»æ‰§è¡ŒåŠ¨ç”»ï¼š 1ï¼‰ã€åˆ›å»ºLeashï¼Œå°†Leashç»‘å®šåˆ°åŠ¨ç”»ä¸»ä½“çš„çˆ¶Layerä¸Šï¼ŒåŠ¨ç”»ä¸»ä½“åˆ™reparentåˆ°Leashä¸Šã€‚ 2ï¼‰ã€å¯¹Leashè¿›è¡ŒåŠ¨ç”»ï¼Œè€ŒéåŠ¨ç”»ä¸»ä½“ã€‚ 3ï¼‰ã€åŠ¨ç”»ç»“æŸåï¼Œå°†åŠ¨ç”»ä¸»ä½“reparentå›åŸçˆ¶Layerä¸Šï¼Œç§»é™¤Leashã€‚ è‡³äºä¸ºä»€ä¹ˆè¦æLeashè¿™ä¹ˆä¸€ä¸ªä¸œè¥¿å‡ºæ¥ï¼Œæˆ‘ä¸ªäººè®¤ä¸ºæ˜¯ï¼Œå¦‚æœç›´æ¥å¯¹åŠ¨ç”»ä¸»ä½“æ‰§è¡ŒåŠ¨ç”»ï¼Œé‚£ä¹ˆå°±ä¼šæ¶‰åŠä¸€ä¸ªæ¢å¤çš„æ“ä½œã€‚æ¯”å¦‚è¯´å¯¹Activityé—´çš„åˆ‡æ¢ï¼Œå¦‚æœä¸ç”¨Leashç›´æ¥å¯¹Activityè¿›è¡Œæ“ä½œï¼Œé‚£ä¹ˆæƒ…å†µæ˜¯ï¼šæ—§çš„Activityåˆ‡èµ°çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šæœ‰ä¸€ä¸ªå‘å·¦å¹³ç§»çš„åŠ¨ç”»ï¼Œåç»­å¦‚æœæˆ‘ä»¬æƒ³è¦è¿™ä¸ªæ—§çš„Activityé‡æ–°å‡ºç°ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸ä»…éœ€è¦å°†å®ƒæ˜¾ç¤ºå‡ºæ¥ï¼Œè¿˜éœ€è¦å°†å®ƒä»ä¹‹å‰çš„åŠ¨ç”»ç»“æŸä½ç½®å‘å³å¹³ç§»ï¼Œè¿™æ ·å®ƒæ‰èƒ½å‡ºç°åœ¨å±å¹•ä¸Šã€‚å¹¶ä¸”æˆ‘ä»¬çš„åŠ¨ç”»è¶Šå¤æ‚ï¼Œæ¢å¤éœ€è¦çš„æ­¥éª¤ä¹Ÿå°±è¶Šå¤šã€‚ å¦‚æœæˆ‘ä»¬æŠŠåŠ¨ç”»ä¸»ä½“reparentåˆ°Leashä¸Šï¼Œç„¶åå¯¹Leashè¿›è¡Œç›¸åŒçš„åŠ¨ç”»ï¼Œä¸ä»…èƒ½è¾¾åˆ°åŒæ ·çš„æ•ˆæœï¼Œè€Œä¸”ä¸ç®¡æˆ‘ä»¬å¯¹Leashå¦‚ä½•è¿›è¡ŒåŠ¨ç”»ï¼Œåªè¦åœ¨åŠ¨ç”»ç»“æŸåå°†åŠ¨ç”»ä¸»ä½“reparentå›åŸæ¥çš„çˆ¶Layerä¸Šï¼Œå°±å¯ä»¥æ¢å¤åŸçŠ¶ï¼Œè€Œä¸ç”¨åƒä¸Šé¢ä¸€æ ·è€ƒè™‘è¦åšå¤šå°‘ç›¸åçš„æ“ä½œæ‰èƒ½æ¢å¤åŸçŠ¶ã€‚ æœ€åï¼ŒLeashç†è®ºä¸Šå¯ä»¥è¢«åº”ç”¨åˆ°ä»»ä½•å¸Œæœ›è¿›è¡ŒåŠ¨ç”»çš„Surfaceä¸Šï¼Œæ¯”å¦‚è¿™é‡Œä¸¾çš„ä¾‹å­æ˜¯åº”ç”¨åˆ°äº†Taskä¸Šï¼Œå› ä¸ºè¿™ä¸ªåŠ¨ç”»å‘ç”ŸäºAppé—´çš„åˆ‡æ¢è¿‡ç¨‹ä¸­ã€‚å¦‚æœæ˜¯Activityé—´çš„åˆ‡æ¢ï¼Œé‚£ä¹ˆLeashå°±å¯ä»¥åº”ç”¨åˆ°ActivityRecordï¼ŒåŒæ ·WindowStateä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä¸»è¦çœ‹åŠ¨ç”»çš„ä¸»ä½“æ˜¯æ•´ä¸ªAppï¼Ÿè¿˜æ˜¯å•ä¸ªActivityï¼Ÿè¿˜æ˜¯æŸä¸ªçª—å£ï¼Ÿ ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:3:3","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#332-åŠ¨ç”»ä¸­"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"3.3 Leash ä»¥ä¸€ä¸ªä»Launcherå¯åŠ¨Settingsçš„åŠ¨ç”»è¿‡ç¨‹ä¸ºä¾‹æ¥è¯´æ˜ä¸€ä¸‹Leashçš„ç”¨æ³•ï¼Œç”±äºæ˜¯Appä»åå°ç§»åŠ¨åˆ°å‰å°ï¼Œå› æ­¤åŠ¨ç”»çš„ä¸»ä½“æ˜¯Taskã€‚ 3.3.1 åŠ¨ç”»å‰ åŠ¨ç”»å‰Task#16ç›¸å…³çš„å±‚çº§ç»“æ„æ˜¯ï¼š Task#16çš„Layerå±‚çº§ç»“æ„ï¼Œæˆ‘ä»¬ä¸Šé¢ä¹Ÿè¯´æ˜è¿‡äº†ï¼Œè¿™é‡Œé¢å¤–åŠ å…¥äº†å®ƒçš„çˆ¶Layerï¼ŒDefaultTaskDisplayAreaã€‚ æ­¤æ—¶æ²¡æœ‰BufferStateLayerï¼Œå› ä¸ºæ­¤æ—¶Settingsè¿˜åœ¨åå°ï¼Œçª—å£å¹¶æ²¡æœ‰ç»˜åˆ¶ã€‚ 3.3.2 åŠ¨ç”»ä¸­ åŠ¨ç”»è¿‡ç¨‹ä¸­Task#16ç›¸å…³çš„å±‚çº§ç»“æ„æ˜¯ï¼š è¿™é‡Œå¤šäº†ä¸¤ä¸ªLayerï¼š BufferStateLayerï¼Œçª—å£ç»˜åˆ¶å®Œæˆåæ‰å¼€å§‹çš„åŠ¨ç”»ï¼Œæ‰€ä»¥åŠ¨ç”»è¿‡ç¨‹ä¸­BufferStateLayerå·²ç»åœ¨äº†ã€‚ ä¸€ä¸ªåä¸ºâ€animation-leash of app_transitionâ€œçš„Layerï¼Œä¸”è¯¥Layeræ’åœ¨äº†DefaultTaskDisplayAreaå’ŒTaskä¸­é—´ã€‚ Leashçš„è¿™ç§è¡Œä¸ºæœ‰ç‚¹åƒæˆ‘ä»¬ä¹‹å‰åˆ†æFreeformçš„æ—¶å€™DecorCaptionViewçš„åšæ³•ï¼š 1ï¼‰ã€å…ˆåˆ›å»ºä¸€ä¸ªLeashï¼Œç„¶åæŒ‡å®šè¯¥Leashå¯¹åº”çš„Layerçš„çˆ¶Layerä¸ºåŠ¨ç”»çš„ä¸»ä½“ï¼ˆè¿™ä¸ªä¾‹å­æ˜¯Taskï¼‰çš„çˆ¶Layerï¼ˆDefaultTaskDisplayAreaï¼‰ã€‚ 2ï¼‰ã€æ¥ç€å°†Taskå¯¹åº”çš„Layerä»åŸçˆ¶Layerï¼ˆDefaultTaskDisplayAreaï¼‰ä¸Šå‰¥ç¦»ï¼Œå˜ä¸ºLeashçš„å­Layerï¼ˆå°†ä¸€ä¸ªå­Layerä»åŸçˆ¶Layeré‡å®šå‘åˆ°ä¸€ä¸ªæ–°çš„çˆ¶Layerä¸Šï¼Œç§°ä¸ºreparentæ“ä½œï¼‰ã€‚ ä»è€Œå®ç°åœ¨DefaultTaskDisplayAreaå’ŒTaskä¸­æ’è¿›ä¸€ä¸ªLeashçš„æ“ä½œã€‚ æ³¨æ„æ­¤æ—¶æ‰§è¡ŒåŠ¨ç”»çš„å¯¹è±¡æ˜¯Leashï¼Œè€ŒéTaskã€‚ä½†ç”±äºTaskçš„çˆ¶Layeræ˜¯Leashï¼Œæ‰€ä»¥Leashç§»åŠ¨ï¼ŒTaskä¼šè·Ÿç€ç§»åŠ¨ï¼Œæˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ°çš„BufferStateLayerä¹Ÿä¼šè·Ÿç€ç§»åŠ¨ã€‚ 3.3.3 åŠ¨ç”»å åŠ¨ç”»ç»“æŸåTask#16ç›¸å…³çš„å±‚çº§ç»“æ„æ˜¯ï¼š åŠ¨ç”»ç»“æŸï¼ŒLeashå·²ç»å®Œæˆäº†å®ƒçš„ä»»åŠ¡ï¼Œå¯ä»¥æ’¤äº†ï¼Œä½†æ˜¯åœ¨æ’¤ä¹‹å‰éœ€è¦å°†ç»‘å®šåœ¨Leashä¸Šçš„Taské‡æ–°reparentå›åŸçˆ¶Layerä¸Šï¼ˆDefaultTaskDisplayAreaï¼‰ã€‚ 3.3.4 å°ç»“ ä¸Šé¢çš„ä¾‹å­å¤§è‡´è¯´æ˜äº†Leashçš„è¿è¡Œæœºåˆ¶ï¼Œè¿™å…¶ä¸­æœ‰3ä¸ªLayerå‚ä¸ï¼Œä¸€ä¸ªæ˜¯åŠ¨ç”»ä¸»ä½“ï¼ˆTaskï¼‰ï¼Œä¸€ä¸ªæ˜¯åŠ¨ç”»ä¸»ä½“çš„çˆ¶Layerï¼ˆDefaultTaskDisplayAreaï¼‰ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯Leashã€‚ Leashçš„ä½œç”¨å³æ˜¯ä»£æ›¿åŠ¨ç”»çš„ä¸»ä½“å»æ‰§è¡ŒåŠ¨ç”»ï¼š 1ï¼‰ã€åˆ›å»ºLeashï¼Œå°†Leashç»‘å®šåˆ°åŠ¨ç”»ä¸»ä½“çš„çˆ¶Layerä¸Šï¼ŒåŠ¨ç”»ä¸»ä½“åˆ™reparentåˆ°Leashä¸Šã€‚ 2ï¼‰ã€å¯¹Leashè¿›è¡ŒåŠ¨ç”»ï¼Œè€ŒéåŠ¨ç”»ä¸»ä½“ã€‚ 3ï¼‰ã€åŠ¨ç”»ç»“æŸåï¼Œå°†åŠ¨ç”»ä¸»ä½“reparentå›åŸçˆ¶Layerä¸Šï¼Œç§»é™¤Leashã€‚ è‡³äºä¸ºä»€ä¹ˆè¦æLeashè¿™ä¹ˆä¸€ä¸ªä¸œè¥¿å‡ºæ¥ï¼Œæˆ‘ä¸ªäººè®¤ä¸ºæ˜¯ï¼Œå¦‚æœç›´æ¥å¯¹åŠ¨ç”»ä¸»ä½“æ‰§è¡ŒåŠ¨ç”»ï¼Œé‚£ä¹ˆå°±ä¼šæ¶‰åŠä¸€ä¸ªæ¢å¤çš„æ“ä½œã€‚æ¯”å¦‚è¯´å¯¹Activityé—´çš„åˆ‡æ¢ï¼Œå¦‚æœä¸ç”¨Leashç›´æ¥å¯¹Activityè¿›è¡Œæ“ä½œï¼Œé‚£ä¹ˆæƒ…å†µæ˜¯ï¼šæ—§çš„Activityåˆ‡èµ°çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šæœ‰ä¸€ä¸ªå‘å·¦å¹³ç§»çš„åŠ¨ç”»ï¼Œåç»­å¦‚æœæˆ‘ä»¬æƒ³è¦è¿™ä¸ªæ—§çš„Activityé‡æ–°å‡ºç°ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸ä»…éœ€è¦å°†å®ƒæ˜¾ç¤ºå‡ºæ¥ï¼Œè¿˜éœ€è¦å°†å®ƒä»ä¹‹å‰çš„åŠ¨ç”»ç»“æŸä½ç½®å‘å³å¹³ç§»ï¼Œè¿™æ ·å®ƒæ‰èƒ½å‡ºç°åœ¨å±å¹•ä¸Šã€‚å¹¶ä¸”æˆ‘ä»¬çš„åŠ¨ç”»è¶Šå¤æ‚ï¼Œæ¢å¤éœ€è¦çš„æ­¥éª¤ä¹Ÿå°±è¶Šå¤šã€‚ å¦‚æœæˆ‘ä»¬æŠŠåŠ¨ç”»ä¸»ä½“reparentåˆ°Leashä¸Šï¼Œç„¶åå¯¹Leashè¿›è¡Œç›¸åŒçš„åŠ¨ç”»ï¼Œä¸ä»…èƒ½è¾¾åˆ°åŒæ ·çš„æ•ˆæœï¼Œè€Œä¸”ä¸ç®¡æˆ‘ä»¬å¯¹Leashå¦‚ä½•è¿›è¡ŒåŠ¨ç”»ï¼Œåªè¦åœ¨åŠ¨ç”»ç»“æŸåå°†åŠ¨ç”»ä¸»ä½“reparentå›åŸæ¥çš„çˆ¶Layerä¸Šï¼Œå°±å¯ä»¥æ¢å¤åŸçŠ¶ï¼Œè€Œä¸ç”¨åƒä¸Šé¢ä¸€æ ·è€ƒè™‘è¦åšå¤šå°‘ç›¸åçš„æ“ä½œæ‰èƒ½æ¢å¤åŸçŠ¶ã€‚ æœ€åï¼ŒLeashç†è®ºä¸Šå¯ä»¥è¢«åº”ç”¨åˆ°ä»»ä½•å¸Œæœ›è¿›è¡ŒåŠ¨ç”»çš„Surfaceä¸Šï¼Œæ¯”å¦‚è¿™é‡Œä¸¾çš„ä¾‹å­æ˜¯åº”ç”¨åˆ°äº†Taskä¸Šï¼Œå› ä¸ºè¿™ä¸ªåŠ¨ç”»å‘ç”ŸäºAppé—´çš„åˆ‡æ¢è¿‡ç¨‹ä¸­ã€‚å¦‚æœæ˜¯Activityé—´çš„åˆ‡æ¢ï¼Œé‚£ä¹ˆLeashå°±å¯ä»¥åº”ç”¨åˆ°ActivityRecordï¼ŒåŒæ ·WindowStateä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä¸»è¦çœ‹åŠ¨ç”»çš„ä¸»ä½“æ˜¯æ•´ä¸ªAppï¼Ÿè¿˜æ˜¯å•ä¸ªActivityï¼Ÿè¿˜æ˜¯æŸä¸ªçª—å£ï¼Ÿ ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:3:3","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#333-åŠ¨ç”»å"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"3.3 Leash ä»¥ä¸€ä¸ªä»Launcherå¯åŠ¨Settingsçš„åŠ¨ç”»è¿‡ç¨‹ä¸ºä¾‹æ¥è¯´æ˜ä¸€ä¸‹Leashçš„ç”¨æ³•ï¼Œç”±äºæ˜¯Appä»åå°ç§»åŠ¨åˆ°å‰å°ï¼Œå› æ­¤åŠ¨ç”»çš„ä¸»ä½“æ˜¯Taskã€‚ 3.3.1 åŠ¨ç”»å‰ åŠ¨ç”»å‰Task#16ç›¸å…³çš„å±‚çº§ç»“æ„æ˜¯ï¼š Task#16çš„Layerå±‚çº§ç»“æ„ï¼Œæˆ‘ä»¬ä¸Šé¢ä¹Ÿè¯´æ˜è¿‡äº†ï¼Œè¿™é‡Œé¢å¤–åŠ å…¥äº†å®ƒçš„çˆ¶Layerï¼ŒDefaultTaskDisplayAreaã€‚ æ­¤æ—¶æ²¡æœ‰BufferStateLayerï¼Œå› ä¸ºæ­¤æ—¶Settingsè¿˜åœ¨åå°ï¼Œçª—å£å¹¶æ²¡æœ‰ç»˜åˆ¶ã€‚ 3.3.2 åŠ¨ç”»ä¸­ åŠ¨ç”»è¿‡ç¨‹ä¸­Task#16ç›¸å…³çš„å±‚çº§ç»“æ„æ˜¯ï¼š è¿™é‡Œå¤šäº†ä¸¤ä¸ªLayerï¼š BufferStateLayerï¼Œçª—å£ç»˜åˆ¶å®Œæˆåæ‰å¼€å§‹çš„åŠ¨ç”»ï¼Œæ‰€ä»¥åŠ¨ç”»è¿‡ç¨‹ä¸­BufferStateLayerå·²ç»åœ¨äº†ã€‚ ä¸€ä¸ªåä¸ºâ€animation-leash of app_transitionâ€œçš„Layerï¼Œä¸”è¯¥Layeræ’åœ¨äº†DefaultTaskDisplayAreaå’ŒTaskä¸­é—´ã€‚ Leashçš„è¿™ç§è¡Œä¸ºæœ‰ç‚¹åƒæˆ‘ä»¬ä¹‹å‰åˆ†æFreeformçš„æ—¶å€™DecorCaptionViewçš„åšæ³•ï¼š 1ï¼‰ã€å…ˆåˆ›å»ºä¸€ä¸ªLeashï¼Œç„¶åæŒ‡å®šè¯¥Leashå¯¹åº”çš„Layerçš„çˆ¶Layerä¸ºåŠ¨ç”»çš„ä¸»ä½“ï¼ˆè¿™ä¸ªä¾‹å­æ˜¯Taskï¼‰çš„çˆ¶Layerï¼ˆDefaultTaskDisplayAreaï¼‰ã€‚ 2ï¼‰ã€æ¥ç€å°†Taskå¯¹åº”çš„Layerä»åŸçˆ¶Layerï¼ˆDefaultTaskDisplayAreaï¼‰ä¸Šå‰¥ç¦»ï¼Œå˜ä¸ºLeashçš„å­Layerï¼ˆå°†ä¸€ä¸ªå­Layerä»åŸçˆ¶Layeré‡å®šå‘åˆ°ä¸€ä¸ªæ–°çš„çˆ¶Layerä¸Šï¼Œç§°ä¸ºreparentæ“ä½œï¼‰ã€‚ ä»è€Œå®ç°åœ¨DefaultTaskDisplayAreaå’ŒTaskä¸­æ’è¿›ä¸€ä¸ªLeashçš„æ“ä½œã€‚ æ³¨æ„æ­¤æ—¶æ‰§è¡ŒåŠ¨ç”»çš„å¯¹è±¡æ˜¯Leashï¼Œè€ŒéTaskã€‚ä½†ç”±äºTaskçš„çˆ¶Layeræ˜¯Leashï¼Œæ‰€ä»¥Leashç§»åŠ¨ï¼ŒTaskä¼šè·Ÿç€ç§»åŠ¨ï¼Œæˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ°çš„BufferStateLayerä¹Ÿä¼šè·Ÿç€ç§»åŠ¨ã€‚ 3.3.3 åŠ¨ç”»å åŠ¨ç”»ç»“æŸåTask#16ç›¸å…³çš„å±‚çº§ç»“æ„æ˜¯ï¼š åŠ¨ç”»ç»“æŸï¼ŒLeashå·²ç»å®Œæˆäº†å®ƒçš„ä»»åŠ¡ï¼Œå¯ä»¥æ’¤äº†ï¼Œä½†æ˜¯åœ¨æ’¤ä¹‹å‰éœ€è¦å°†ç»‘å®šåœ¨Leashä¸Šçš„Taské‡æ–°reparentå›åŸçˆ¶Layerä¸Šï¼ˆDefaultTaskDisplayAreaï¼‰ã€‚ 3.3.4 å°ç»“ ä¸Šé¢çš„ä¾‹å­å¤§è‡´è¯´æ˜äº†Leashçš„è¿è¡Œæœºåˆ¶ï¼Œè¿™å…¶ä¸­æœ‰3ä¸ªLayerå‚ä¸ï¼Œä¸€ä¸ªæ˜¯åŠ¨ç”»ä¸»ä½“ï¼ˆTaskï¼‰ï¼Œä¸€ä¸ªæ˜¯åŠ¨ç”»ä¸»ä½“çš„çˆ¶Layerï¼ˆDefaultTaskDisplayAreaï¼‰ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯Leashã€‚ Leashçš„ä½œç”¨å³æ˜¯ä»£æ›¿åŠ¨ç”»çš„ä¸»ä½“å»æ‰§è¡ŒåŠ¨ç”»ï¼š 1ï¼‰ã€åˆ›å»ºLeashï¼Œå°†Leashç»‘å®šåˆ°åŠ¨ç”»ä¸»ä½“çš„çˆ¶Layerä¸Šï¼ŒåŠ¨ç”»ä¸»ä½“åˆ™reparentåˆ°Leashä¸Šã€‚ 2ï¼‰ã€å¯¹Leashè¿›è¡ŒåŠ¨ç”»ï¼Œè€ŒéåŠ¨ç”»ä¸»ä½“ã€‚ 3ï¼‰ã€åŠ¨ç”»ç»“æŸåï¼Œå°†åŠ¨ç”»ä¸»ä½“reparentå›åŸçˆ¶Layerä¸Šï¼Œç§»é™¤Leashã€‚ è‡³äºä¸ºä»€ä¹ˆè¦æLeashè¿™ä¹ˆä¸€ä¸ªä¸œè¥¿å‡ºæ¥ï¼Œæˆ‘ä¸ªäººè®¤ä¸ºæ˜¯ï¼Œå¦‚æœç›´æ¥å¯¹åŠ¨ç”»ä¸»ä½“æ‰§è¡ŒåŠ¨ç”»ï¼Œé‚£ä¹ˆå°±ä¼šæ¶‰åŠä¸€ä¸ªæ¢å¤çš„æ“ä½œã€‚æ¯”å¦‚è¯´å¯¹Activityé—´çš„åˆ‡æ¢ï¼Œå¦‚æœä¸ç”¨Leashç›´æ¥å¯¹Activityè¿›è¡Œæ“ä½œï¼Œé‚£ä¹ˆæƒ…å†µæ˜¯ï¼šæ—§çš„Activityåˆ‡èµ°çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šæœ‰ä¸€ä¸ªå‘å·¦å¹³ç§»çš„åŠ¨ç”»ï¼Œåç»­å¦‚æœæˆ‘ä»¬æƒ³è¦è¿™ä¸ªæ—§çš„Activityé‡æ–°å‡ºç°ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸ä»…éœ€è¦å°†å®ƒæ˜¾ç¤ºå‡ºæ¥ï¼Œè¿˜éœ€è¦å°†å®ƒä»ä¹‹å‰çš„åŠ¨ç”»ç»“æŸä½ç½®å‘å³å¹³ç§»ï¼Œè¿™æ ·å®ƒæ‰èƒ½å‡ºç°åœ¨å±å¹•ä¸Šã€‚å¹¶ä¸”æˆ‘ä»¬çš„åŠ¨ç”»è¶Šå¤æ‚ï¼Œæ¢å¤éœ€è¦çš„æ­¥éª¤ä¹Ÿå°±è¶Šå¤šã€‚ å¦‚æœæˆ‘ä»¬æŠŠåŠ¨ç”»ä¸»ä½“reparentåˆ°Leashä¸Šï¼Œç„¶åå¯¹Leashè¿›è¡Œç›¸åŒçš„åŠ¨ç”»ï¼Œä¸ä»…èƒ½è¾¾åˆ°åŒæ ·çš„æ•ˆæœï¼Œè€Œä¸”ä¸ç®¡æˆ‘ä»¬å¯¹Leashå¦‚ä½•è¿›è¡ŒåŠ¨ç”»ï¼Œåªè¦åœ¨åŠ¨ç”»ç»“æŸåå°†åŠ¨ç”»ä¸»ä½“reparentå›åŸæ¥çš„çˆ¶Layerä¸Šï¼Œå°±å¯ä»¥æ¢å¤åŸçŠ¶ï¼Œè€Œä¸ç”¨åƒä¸Šé¢ä¸€æ ·è€ƒè™‘è¦åšå¤šå°‘ç›¸åçš„æ“ä½œæ‰èƒ½æ¢å¤åŸçŠ¶ã€‚ æœ€åï¼ŒLeashç†è®ºä¸Šå¯ä»¥è¢«åº”ç”¨åˆ°ä»»ä½•å¸Œæœ›è¿›è¡ŒåŠ¨ç”»çš„Surfaceä¸Šï¼Œæ¯”å¦‚è¿™é‡Œä¸¾çš„ä¾‹å­æ˜¯åº”ç”¨åˆ°äº†Taskä¸Šï¼Œå› ä¸ºè¿™ä¸ªåŠ¨ç”»å‘ç”ŸäºAppé—´çš„åˆ‡æ¢è¿‡ç¨‹ä¸­ã€‚å¦‚æœæ˜¯Activityé—´çš„åˆ‡æ¢ï¼Œé‚£ä¹ˆLeashå°±å¯ä»¥åº”ç”¨åˆ°ActivityRecordï¼ŒåŒæ ·WindowStateä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä¸»è¦çœ‹åŠ¨ç”»çš„ä¸»ä½“æ˜¯æ•´ä¸ªAppï¼Ÿè¿˜æ˜¯å•ä¸ªActivityï¼Ÿè¿˜æ˜¯æŸä¸ªçª—å£ï¼Ÿ ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:3:3","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#334-å°ç»“"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"3.4 DimLayerå’Œç›¸å¯¹å±‚çº§ DimLayerçš„æœ¬è´¨æ˜¯ä¸€ä¸ªEffectLayerï¼Œé»˜è®¤æ˜¯ä¸€ä¸ªçº¯é»‘Layerï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®Layerçš„é€æ˜åº¦æ¥æ–½åŠ é˜´å½±æ•ˆæœï¼Œæˆ–è€…è®¾ç½®Layeræ¨¡ç³ŠåŠå¾„æ¥æ–½åŠ æ¨¡ç³Šæ•ˆæœã€‚ æ¥çœ‹ä¸€ä¸ªå®é™…åº”ç”¨çš„ä¾‹å­ï¼ŒFilesï¼š æ­¤æ—¶Filesæœ‰ä¸¤ä¸ªçª—å£ï¼Œå­çª—å£ç›–åœ¨ä¸»çª—å£ä¸Šï¼Œå¹¶ä¸”æ­¤æ—¶å­çª—å£å£°æ˜äº†ä¸€ä¸ªç‰¹æ®Šçª—å£æ ‡å¿—ä½ï¼š /** Window flag: everything behind this window will be dimmed. * Use {@link #dimAmount} to control the amount of dim. */ public static final int FLAG_DIM_BEHIND = 0x00000002; è¯¥çª—å£æ ‡å¿—ä½çš„ä½œç”¨æ˜¯ï¼Œå°†å£°æ˜äº†è¯¥æ ‡å¿—ä½çš„çª—å£çš„åé¢æ‰€æœ‰å†…å®¹éƒ½å˜æš—ï¼Œå› æ­¤æœ€ç»ˆçš„æ•ˆæœå°±æ˜¯å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå³ä¸»çª—å£è¢«è’™ä¸Šäº†ä¸€å±‚é˜´å½±æ•ˆæœã€‚ æ­¤æ—¶çš„çª—å£å±‚çº§ç»“æ„å›¾æ˜¯ï¼š åœ¨è¿™ä¸ªå±‚çº§ç»“æ„å›¾ä¸­ï¼Œåªæœ‰å¯è§çš„Layeræ‰è¢«æ ‡è®°äº†é¢œè‰²ï¼Œæ­¤æ—¶å¯è§Layerçš„Zè½´é¡ºåºæ˜¯ï¼šå­çª—å£ \u003e DImLayer \u003e ä¸»çª—å£ã€‚ ä¸»çª—å£å’Œå­çª—å£å¯¹åº”çš„ä¸¤ä¸ªBufferStateLayerä¸ç”¨å¤šè¯´ï¼Œè¿™é‡Œä¸»è¦çœ‹ä¸‹DimLayerï¼Œç›¸å…³ä¿¡æ¯å¦‚ä¸‹ï¼š + EffectLayer (Dim Layer for - Task=36#0) uid=1000 z= -1 color=(0.000,0.000,0.000,0.600) parent=Task=36#0 zOrderRelativeOf=f19c0b8 com.google.android.apps.nbu.files/com.google.android.apps.nbu.files.home.HomeActivity#0 alphaå€¼ä¸º0.6ï¼Œä¸Šé¢æˆ‘ä»¬ä¹Ÿæåˆ°è¿‡ï¼ŒEffectLayeré»˜è®¤æ˜¯ä¸€ä¸ªçº¯é»‘çš„Layerï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®å®ƒçš„é€æ˜åº¦æ¥è¾¾åˆ°å˜æš—çš„æ•ˆæœï¼ˆé€æ˜åº¦ä¸º1åˆ™ä¼šå®Œå…¨é®ä½åé¢çš„å†…å®¹ï¼‰ã€‚ DimLayerçš„çˆ¶Layeræ˜¯Task#36ï¼Œè¿™ä¸ªè·Ÿä¸Šå±‚çš„å®ç°æœ‰å…³ç³»ï¼Œç›®å‰æ˜¯Taskå’ŒDisplayAreaæ”¯æŒåˆ›å»ºè¿™ä¹ˆä¸€ä¸ªDimLayerã€‚ è¿™é‡Œè®¾ç½®äº†DimLayerçš„ç›¸å¯¹å±‚çº§ä¸ºå­çª—å£WindowStateè¿™ä¸€çº§å¯¹åº”çš„ContainerLayerï¼ŒContainerLayer (f19c0b8 com.google.android.apps.nbu.files/com.google.android.apps.nbu.files.home.HomeActivity#0)ã€‚è®¾ç½®ä¸€ä¸ªLayerçš„ç›¸å¯¹å±‚çº§ï¼Œç›¸å½“äºæ˜¯å°†è¯¥Layerä»å…¶åŸæ¥çš„çˆ¶Layerä¸Šå‰¥ç¦»ï¼Œè¿™é‡Œæ˜¯ EffectLayer (Task=36#0)ï¼Œç„¶åå°†è¿™ä¸ªç›¸å¯¹å±‚çº§çš„Layerä½œä¸ºçˆ¶Layerï¼Œè¿™é‡Œæ˜¯ ContainerLayer (f19c0b8 com.google.android.apps.nbu.files/com.google.android.apps.nbu.files.home.HomeActivity#0)ï¼Œé‡æ–°ç»‘å®šåˆ°è¿™ä¸ªçˆ¶Layerä¸Šé¢ã€‚æ‰€ä»¥è¿™é‡Œèƒ½å¤Ÿçœ‹åˆ°è™½ç„¶DimLayerçš„çˆ¶Layeræ˜¯ EffectLayer (Task=36#0)ï¼Œä½†æ˜¯åœ¨å®é™…ä¸Šçš„å±‚çº§ç»“æ„ä¸­ï¼ŒDimLayeræ˜¯ä½œä¸ºäº† ContainerLayer (f19c0b8 com.google.android.apps.nbu.files/com.google.android.apps.nbu.files.home.HomeActivity#0) çš„å­Layerã€‚ å½“ç„¶åªè®¾ç½®ç›¸å¯¹å±‚çº§è¿˜ä¸å¤Ÿï¼Œè¿˜éœ€è¦å°†DimLayerçš„å±‚çº§å€¼è®¾ç½®ä¸º-1ï¼Œè¿™æ ·å®ƒæ‰ä¸ä¼šæŠŠå­çª—å£ä¹Ÿç›–ä½ï¼Œå¹¶ä¸”èƒ½å¤Ÿé®ä½å±‚çº§æ¯”å­çª—å£ä½çš„Layerã€‚ 3.4.1 DimLayerå±‚çº§å€¼ä»-1ä¿®æ”¹ä¸º100 è¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨ä¿®æ”¹DimLayerçš„å®ç°ï¼Œå°†å…¶å±‚çº§å€¼ä»-1ä¿®æ”¹ä¸º100ï¼Œé‚£ä¹ˆæ˜¾ç¤ºæ•ˆæœä¸ºï¼š æ­¤æ—¶é˜´å½±æ•ˆæœä¸ä»…è¦†ç›–äº†ä¸»çª—å£ï¼Œè¿å­çª—å£ä¹Ÿè¦†ç›–äº†ï¼Œå±‚çº§ç»“æ„å›¾ä¸ºï¼š å¾ˆæ˜¾ç„¶ï¼Œå½“è®¾ç½®EffectLayerçš„å±‚çº§å€¼ä¸º100åï¼Œå®ƒå°±å˜æˆäº†å­çª—å£ä¸­å±‚çº§å€¼æœ€é«˜çš„Layerï¼Œæ—¢ç„¶æ¯”å­çª—å£å¯¹åº”çš„BufferStateLayerå±‚çº§å€¼è¿˜é«˜ï¼Œè‡ªç„¶ä¼šæŠŠæ•´ä¸ªActivityéƒ½é®ä½ï¼Œç¬¦åˆé¢„æœŸã€‚ 3.4.2 DimLayerç›¸å¯¹å±‚çº§ä»å­çª—å£ä¿®æ”¹ä¸ºä¸»çª—å£ è¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨ä¿®æ”¹DimLayerçš„å®ç°ï¼Œå°†å…¶ç›¸å¯¹å±‚çº§çš„å¯¹è±¡ä»å­çª—å£ä¿®æ”¹ä¸ºä¸»çª—å£ï¼Œé‚£ä¹ˆæ˜¾ç¤ºæ•ˆæœä¸ºï¼š æ­¤æ—¶é˜´å½±æ•ˆæœæ¶ˆå¤±ï¼Œå±‚çº§ç»“æ„å›¾ä¸ºï¼š å°†EffectLayerçš„ç›¸å¯¹å±‚çº§çš„å¯¹è±¡ä»å­çª—å£ä¿®æ”¹ä¸ºä¸»çª—å£ï¼Œå®ƒå°±å˜æˆäº†å­çª—å£ä¸­å±‚çº§å€¼æœ€ä½çš„Layerï¼Œè‡ªç„¶æ— æ³•å†é®æŒ¡ä»»ä½•Layerï¼Œå¹¶ä¸”è¢«å…¨å±çš„ä¸»çª—å£å®Œå…¨é®æŒ¡ä»è€Œæ— æ³•æ˜¾ç¤ºï¼Œç¬¦åˆé¢„æœŸã€‚ 3.4.3 å°ç»“ ç›¸å¯¹å±‚çº§çš„å‡ºç°ï¼Œä½¿å¾—Layerçš„å±‚çº§é¡ºåºè°ƒæ•´æ›´åŠ çµæ´»ï¼Œå¹¶ä¸”åç»­å¦‚æœä¸éœ€è¦ç›¸å¯¹å±‚çº§äº†ï¼Œä¹Ÿä¸éœ€è¦æ‰§è¡Œç¹ççš„â€å…ˆå°†å½“å‰Layerä»ç›¸å¯¹å±‚çº§Layerä¸Šç§»é™¤ï¼Œå†é‡æ–°ç»‘å®šå›åŸçˆ¶Layerâ€œçš„æ“ä½œï¼Œç›´æ¥è®¾ç½®ä¸€ä¸‹å±‚çº§å€¼å°±å¯ä»¥å°†ç›¸å¯¹å±‚çº§Layerç§»é™¤äº†ã€‚ å¦å¤–ä½ ä¹Ÿå¯ä»¥æ ¹æ®éœ€è¦ï¼Œä¸ºDimLayerè®¾ç½®ä¸åŒçš„ç›¸å¯¹å±‚çº§å¯¹è±¡ï¼Œä»è€Œå®ç°å°†æŸä¸ªå­çª—å£å˜æš—ï¼Œæˆ–è€…å°†æŸä¸ªActivityå˜æš—ï¼Œæˆ–è€…å°†æ•´ä¸ªAppå˜æš—ã€‚ ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:3:4","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#34-dimlayerå’Œç›¸å¯¹å±‚çº§"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"3.4 DimLayerå’Œç›¸å¯¹å±‚çº§ DimLayerçš„æœ¬è´¨æ˜¯ä¸€ä¸ªEffectLayerï¼Œé»˜è®¤æ˜¯ä¸€ä¸ªçº¯é»‘Layerï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®Layerçš„é€æ˜åº¦æ¥æ–½åŠ é˜´å½±æ•ˆæœï¼Œæˆ–è€…è®¾ç½®Layeræ¨¡ç³ŠåŠå¾„æ¥æ–½åŠ æ¨¡ç³Šæ•ˆæœã€‚ æ¥çœ‹ä¸€ä¸ªå®é™…åº”ç”¨çš„ä¾‹å­ï¼ŒFilesï¼š æ­¤æ—¶Filesæœ‰ä¸¤ä¸ªçª—å£ï¼Œå­çª—å£ç›–åœ¨ä¸»çª—å£ä¸Šï¼Œå¹¶ä¸”æ­¤æ—¶å­çª—å£å£°æ˜äº†ä¸€ä¸ªç‰¹æ®Šçª—å£æ ‡å¿—ä½ï¼š /** Window flag: everything behind this window will be dimmed. * Use {@link #dimAmount} to control the amount of dim. */ public static final int FLAG_DIM_BEHIND = 0x00000002; è¯¥çª—å£æ ‡å¿—ä½çš„ä½œç”¨æ˜¯ï¼Œå°†å£°æ˜äº†è¯¥æ ‡å¿—ä½çš„çª—å£çš„åé¢æ‰€æœ‰å†…å®¹éƒ½å˜æš—ï¼Œå› æ­¤æœ€ç»ˆçš„æ•ˆæœå°±æ˜¯å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå³ä¸»çª—å£è¢«è’™ä¸Šäº†ä¸€å±‚é˜´å½±æ•ˆæœã€‚ æ­¤æ—¶çš„çª—å£å±‚çº§ç»“æ„å›¾æ˜¯ï¼š åœ¨è¿™ä¸ªå±‚çº§ç»“æ„å›¾ä¸­ï¼Œåªæœ‰å¯è§çš„Layeræ‰è¢«æ ‡è®°äº†é¢œè‰²ï¼Œæ­¤æ—¶å¯è§Layerçš„Zè½´é¡ºåºæ˜¯ï¼šå­çª—å£ \u003e DImLayer \u003e ä¸»çª—å£ã€‚ ä¸»çª—å£å’Œå­çª—å£å¯¹åº”çš„ä¸¤ä¸ªBufferStateLayerä¸ç”¨å¤šè¯´ï¼Œè¿™é‡Œä¸»è¦çœ‹ä¸‹DimLayerï¼Œç›¸å…³ä¿¡æ¯å¦‚ä¸‹ï¼š + EffectLayer (Dim Layer for - Task=36#0) uid=1000 z= -1 color=(0.000,0.000,0.000,0.600) parent=Task=36#0 zOrderRelativeOf=f19c0b8 com.google.android.apps.nbu.files/com.google.android.apps.nbu.files.home.HomeActivity#0 alphaå€¼ä¸º0.6ï¼Œä¸Šé¢æˆ‘ä»¬ä¹Ÿæåˆ°è¿‡ï¼ŒEffectLayeré»˜è®¤æ˜¯ä¸€ä¸ªçº¯é»‘çš„Layerï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®å®ƒçš„é€æ˜åº¦æ¥è¾¾åˆ°å˜æš—çš„æ•ˆæœï¼ˆé€æ˜åº¦ä¸º1åˆ™ä¼šå®Œå…¨é®ä½åé¢çš„å†…å®¹ï¼‰ã€‚ DimLayerçš„çˆ¶Layeræ˜¯Task#36ï¼Œè¿™ä¸ªè·Ÿä¸Šå±‚çš„å®ç°æœ‰å…³ç³»ï¼Œç›®å‰æ˜¯Taskå’ŒDisplayAreaæ”¯æŒåˆ›å»ºè¿™ä¹ˆä¸€ä¸ªDimLayerã€‚ è¿™é‡Œè®¾ç½®äº†DimLayerçš„ç›¸å¯¹å±‚çº§ä¸ºå­çª—å£WindowStateè¿™ä¸€çº§å¯¹åº”çš„ContainerLayerï¼ŒContainerLayer (f19c0b8 com.google.android.apps.nbu.files/com.google.android.apps.nbu.files.home.HomeActivity#0)ã€‚è®¾ç½®ä¸€ä¸ªLayerçš„ç›¸å¯¹å±‚çº§ï¼Œç›¸å½“äºæ˜¯å°†è¯¥Layerä»å…¶åŸæ¥çš„çˆ¶Layerä¸Šå‰¥ç¦»ï¼Œè¿™é‡Œæ˜¯ EffectLayer (Task=36#0)ï¼Œç„¶åå°†è¿™ä¸ªç›¸å¯¹å±‚çº§çš„Layerä½œä¸ºçˆ¶Layerï¼Œè¿™é‡Œæ˜¯ ContainerLayer (f19c0b8 com.google.android.apps.nbu.files/com.google.android.apps.nbu.files.home.HomeActivity#0)ï¼Œé‡æ–°ç»‘å®šåˆ°è¿™ä¸ªçˆ¶Layerä¸Šé¢ã€‚æ‰€ä»¥è¿™é‡Œèƒ½å¤Ÿçœ‹åˆ°è™½ç„¶DimLayerçš„çˆ¶Layeræ˜¯ EffectLayer (Task=36#0)ï¼Œä½†æ˜¯åœ¨å®é™…ä¸Šçš„å±‚çº§ç»“æ„ä¸­ï¼ŒDimLayeræ˜¯ä½œä¸ºäº† ContainerLayer (f19c0b8 com.google.android.apps.nbu.files/com.google.android.apps.nbu.files.home.HomeActivity#0) çš„å­Layerã€‚ å½“ç„¶åªè®¾ç½®ç›¸å¯¹å±‚çº§è¿˜ä¸å¤Ÿï¼Œè¿˜éœ€è¦å°†DimLayerçš„å±‚çº§å€¼è®¾ç½®ä¸º-1ï¼Œè¿™æ ·å®ƒæ‰ä¸ä¼šæŠŠå­çª—å£ä¹Ÿç›–ä½ï¼Œå¹¶ä¸”èƒ½å¤Ÿé®ä½å±‚çº§æ¯”å­çª—å£ä½çš„Layerã€‚ 3.4.1 DimLayerå±‚çº§å€¼ä»-1ä¿®æ”¹ä¸º100 è¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨ä¿®æ”¹DimLayerçš„å®ç°ï¼Œå°†å…¶å±‚çº§å€¼ä»-1ä¿®æ”¹ä¸º100ï¼Œé‚£ä¹ˆæ˜¾ç¤ºæ•ˆæœä¸ºï¼š æ­¤æ—¶é˜´å½±æ•ˆæœä¸ä»…è¦†ç›–äº†ä¸»çª—å£ï¼Œè¿å­çª—å£ä¹Ÿè¦†ç›–äº†ï¼Œå±‚çº§ç»“æ„å›¾ä¸ºï¼š å¾ˆæ˜¾ç„¶ï¼Œå½“è®¾ç½®EffectLayerçš„å±‚çº§å€¼ä¸º100åï¼Œå®ƒå°±å˜æˆäº†å­çª—å£ä¸­å±‚çº§å€¼æœ€é«˜çš„Layerï¼Œæ—¢ç„¶æ¯”å­çª—å£å¯¹åº”çš„BufferStateLayerå±‚çº§å€¼è¿˜é«˜ï¼Œè‡ªç„¶ä¼šæŠŠæ•´ä¸ªActivityéƒ½é®ä½ï¼Œç¬¦åˆé¢„æœŸã€‚ 3.4.2 DimLayerç›¸å¯¹å±‚çº§ä»å­çª—å£ä¿®æ”¹ä¸ºä¸»çª—å£ è¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨ä¿®æ”¹DimLayerçš„å®ç°ï¼Œå°†å…¶ç›¸å¯¹å±‚çº§çš„å¯¹è±¡ä»å­çª—å£ä¿®æ”¹ä¸ºä¸»çª—å£ï¼Œé‚£ä¹ˆæ˜¾ç¤ºæ•ˆæœä¸ºï¼š æ­¤æ—¶é˜´å½±æ•ˆæœæ¶ˆå¤±ï¼Œå±‚çº§ç»“æ„å›¾ä¸ºï¼š å°†EffectLayerçš„ç›¸å¯¹å±‚çº§çš„å¯¹è±¡ä»å­çª—å£ä¿®æ”¹ä¸ºä¸»çª—å£ï¼Œå®ƒå°±å˜æˆäº†å­çª—å£ä¸­å±‚çº§å€¼æœ€ä½çš„Layerï¼Œè‡ªç„¶æ— æ³•å†é®æŒ¡ä»»ä½•Layerï¼Œå¹¶ä¸”è¢«å…¨å±çš„ä¸»çª—å£å®Œå…¨é®æŒ¡ä»è€Œæ— æ³•æ˜¾ç¤ºï¼Œç¬¦åˆé¢„æœŸã€‚ 3.4.3 å°ç»“ ç›¸å¯¹å±‚çº§çš„å‡ºç°ï¼Œä½¿å¾—Layerçš„å±‚çº§é¡ºåºè°ƒæ•´æ›´åŠ çµæ´»ï¼Œå¹¶ä¸”åç»­å¦‚æœä¸éœ€è¦ç›¸å¯¹å±‚çº§äº†ï¼Œä¹Ÿä¸éœ€è¦æ‰§è¡Œç¹ççš„â€å…ˆå°†å½“å‰Layerä»ç›¸å¯¹å±‚çº§Layerä¸Šç§»é™¤ï¼Œå†é‡æ–°ç»‘å®šå›åŸçˆ¶Layerâ€œçš„æ“ä½œï¼Œç›´æ¥è®¾ç½®ä¸€ä¸‹å±‚çº§å€¼å°±å¯ä»¥å°†ç›¸å¯¹å±‚çº§Layerç§»é™¤äº†ã€‚ å¦å¤–ä½ ä¹Ÿå¯ä»¥æ ¹æ®éœ€è¦ï¼Œä¸ºDimLayerè®¾ç½®ä¸åŒçš„ç›¸å¯¹å±‚çº§å¯¹è±¡ï¼Œä»è€Œå®ç°å°†æŸä¸ªå­çª—å£å˜æš—ï¼Œæˆ–è€…å°†æŸä¸ªActivityå˜æš—ï¼Œæˆ–è€…å°†æ•´ä¸ªAppå˜æš—ã€‚ ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:3:4","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#341-dimlayerå±‚çº§å€¼ä»-1ä¿®æ”¹ä¸º100"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"3.4 DimLayerå’Œç›¸å¯¹å±‚çº§ DimLayerçš„æœ¬è´¨æ˜¯ä¸€ä¸ªEffectLayerï¼Œé»˜è®¤æ˜¯ä¸€ä¸ªçº¯é»‘Layerï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®Layerçš„é€æ˜åº¦æ¥æ–½åŠ é˜´å½±æ•ˆæœï¼Œæˆ–è€…è®¾ç½®Layeræ¨¡ç³ŠåŠå¾„æ¥æ–½åŠ æ¨¡ç³Šæ•ˆæœã€‚ æ¥çœ‹ä¸€ä¸ªå®é™…åº”ç”¨çš„ä¾‹å­ï¼ŒFilesï¼š æ­¤æ—¶Filesæœ‰ä¸¤ä¸ªçª—å£ï¼Œå­çª—å£ç›–åœ¨ä¸»çª—å£ä¸Šï¼Œå¹¶ä¸”æ­¤æ—¶å­çª—å£å£°æ˜äº†ä¸€ä¸ªç‰¹æ®Šçª—å£æ ‡å¿—ä½ï¼š /** Window flag: everything behind this window will be dimmed. * Use {@link #dimAmount} to control the amount of dim. */ public static final int FLAG_DIM_BEHIND = 0x00000002; è¯¥çª—å£æ ‡å¿—ä½çš„ä½œç”¨æ˜¯ï¼Œå°†å£°æ˜äº†è¯¥æ ‡å¿—ä½çš„çª—å£çš„åé¢æ‰€æœ‰å†…å®¹éƒ½å˜æš—ï¼Œå› æ­¤æœ€ç»ˆçš„æ•ˆæœå°±æ˜¯å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå³ä¸»çª—å£è¢«è’™ä¸Šäº†ä¸€å±‚é˜´å½±æ•ˆæœã€‚ æ­¤æ—¶çš„çª—å£å±‚çº§ç»“æ„å›¾æ˜¯ï¼š åœ¨è¿™ä¸ªå±‚çº§ç»“æ„å›¾ä¸­ï¼Œåªæœ‰å¯è§çš„Layeræ‰è¢«æ ‡è®°äº†é¢œè‰²ï¼Œæ­¤æ—¶å¯è§Layerçš„Zè½´é¡ºåºæ˜¯ï¼šå­çª—å£ \u003e DImLayer \u003e ä¸»çª—å£ã€‚ ä¸»çª—å£å’Œå­çª—å£å¯¹åº”çš„ä¸¤ä¸ªBufferStateLayerä¸ç”¨å¤šè¯´ï¼Œè¿™é‡Œä¸»è¦çœ‹ä¸‹DimLayerï¼Œç›¸å…³ä¿¡æ¯å¦‚ä¸‹ï¼š + EffectLayer (Dim Layer for - Task=36#0) uid=1000 z= -1 color=(0.000,0.000,0.000,0.600) parent=Task=36#0 zOrderRelativeOf=f19c0b8 com.google.android.apps.nbu.files/com.google.android.apps.nbu.files.home.HomeActivity#0 alphaå€¼ä¸º0.6ï¼Œä¸Šé¢æˆ‘ä»¬ä¹Ÿæåˆ°è¿‡ï¼ŒEffectLayeré»˜è®¤æ˜¯ä¸€ä¸ªçº¯é»‘çš„Layerï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®å®ƒçš„é€æ˜åº¦æ¥è¾¾åˆ°å˜æš—çš„æ•ˆæœï¼ˆé€æ˜åº¦ä¸º1åˆ™ä¼šå®Œå…¨é®ä½åé¢çš„å†…å®¹ï¼‰ã€‚ DimLayerçš„çˆ¶Layeræ˜¯Task#36ï¼Œè¿™ä¸ªè·Ÿä¸Šå±‚çš„å®ç°æœ‰å…³ç³»ï¼Œç›®å‰æ˜¯Taskå’ŒDisplayAreaæ”¯æŒåˆ›å»ºè¿™ä¹ˆä¸€ä¸ªDimLayerã€‚ è¿™é‡Œè®¾ç½®äº†DimLayerçš„ç›¸å¯¹å±‚çº§ä¸ºå­çª—å£WindowStateè¿™ä¸€çº§å¯¹åº”çš„ContainerLayerï¼ŒContainerLayer (f19c0b8 com.google.android.apps.nbu.files/com.google.android.apps.nbu.files.home.HomeActivity#0)ã€‚è®¾ç½®ä¸€ä¸ªLayerçš„ç›¸å¯¹å±‚çº§ï¼Œç›¸å½“äºæ˜¯å°†è¯¥Layerä»å…¶åŸæ¥çš„çˆ¶Layerä¸Šå‰¥ç¦»ï¼Œè¿™é‡Œæ˜¯ EffectLayer (Task=36#0)ï¼Œç„¶åå°†è¿™ä¸ªç›¸å¯¹å±‚çº§çš„Layerä½œä¸ºçˆ¶Layerï¼Œè¿™é‡Œæ˜¯ ContainerLayer (f19c0b8 com.google.android.apps.nbu.files/com.google.android.apps.nbu.files.home.HomeActivity#0)ï¼Œé‡æ–°ç»‘å®šåˆ°è¿™ä¸ªçˆ¶Layerä¸Šé¢ã€‚æ‰€ä»¥è¿™é‡Œèƒ½å¤Ÿçœ‹åˆ°è™½ç„¶DimLayerçš„çˆ¶Layeræ˜¯ EffectLayer (Task=36#0)ï¼Œä½†æ˜¯åœ¨å®é™…ä¸Šçš„å±‚çº§ç»“æ„ä¸­ï¼ŒDimLayeræ˜¯ä½œä¸ºäº† ContainerLayer (f19c0b8 com.google.android.apps.nbu.files/com.google.android.apps.nbu.files.home.HomeActivity#0) çš„å­Layerã€‚ å½“ç„¶åªè®¾ç½®ç›¸å¯¹å±‚çº§è¿˜ä¸å¤Ÿï¼Œè¿˜éœ€è¦å°†DimLayerçš„å±‚çº§å€¼è®¾ç½®ä¸º-1ï¼Œè¿™æ ·å®ƒæ‰ä¸ä¼šæŠŠå­çª—å£ä¹Ÿç›–ä½ï¼Œå¹¶ä¸”èƒ½å¤Ÿé®ä½å±‚çº§æ¯”å­çª—å£ä½çš„Layerã€‚ 3.4.1 DimLayerå±‚çº§å€¼ä»-1ä¿®æ”¹ä¸º100 è¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨ä¿®æ”¹DimLayerçš„å®ç°ï¼Œå°†å…¶å±‚çº§å€¼ä»-1ä¿®æ”¹ä¸º100ï¼Œé‚£ä¹ˆæ˜¾ç¤ºæ•ˆæœä¸ºï¼š æ­¤æ—¶é˜´å½±æ•ˆæœä¸ä»…è¦†ç›–äº†ä¸»çª—å£ï¼Œè¿å­çª—å£ä¹Ÿè¦†ç›–äº†ï¼Œå±‚çº§ç»“æ„å›¾ä¸ºï¼š å¾ˆæ˜¾ç„¶ï¼Œå½“è®¾ç½®EffectLayerçš„å±‚çº§å€¼ä¸º100åï¼Œå®ƒå°±å˜æˆäº†å­çª—å£ä¸­å±‚çº§å€¼æœ€é«˜çš„Layerï¼Œæ—¢ç„¶æ¯”å­çª—å£å¯¹åº”çš„BufferStateLayerå±‚çº§å€¼è¿˜é«˜ï¼Œè‡ªç„¶ä¼šæŠŠæ•´ä¸ªActivityéƒ½é®ä½ï¼Œç¬¦åˆé¢„æœŸã€‚ 3.4.2 DimLayerç›¸å¯¹å±‚çº§ä»å­çª—å£ä¿®æ”¹ä¸ºä¸»çª—å£ è¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨ä¿®æ”¹DimLayerçš„å®ç°ï¼Œå°†å…¶ç›¸å¯¹å±‚çº§çš„å¯¹è±¡ä»å­çª—å£ä¿®æ”¹ä¸ºä¸»çª—å£ï¼Œé‚£ä¹ˆæ˜¾ç¤ºæ•ˆæœä¸ºï¼š æ­¤æ—¶é˜´å½±æ•ˆæœæ¶ˆå¤±ï¼Œå±‚çº§ç»“æ„å›¾ä¸ºï¼š å°†EffectLayerçš„ç›¸å¯¹å±‚çº§çš„å¯¹è±¡ä»å­çª—å£ä¿®æ”¹ä¸ºä¸»çª—å£ï¼Œå®ƒå°±å˜æˆäº†å­çª—å£ä¸­å±‚çº§å€¼æœ€ä½çš„Layerï¼Œè‡ªç„¶æ— æ³•å†é®æŒ¡ä»»ä½•Layerï¼Œå¹¶ä¸”è¢«å…¨å±çš„ä¸»çª—å£å®Œå…¨é®æŒ¡ä»è€Œæ— æ³•æ˜¾ç¤ºï¼Œç¬¦åˆé¢„æœŸã€‚ 3.4.3 å°ç»“ ç›¸å¯¹å±‚çº§çš„å‡ºç°ï¼Œä½¿å¾—Layerçš„å±‚çº§é¡ºåºè°ƒæ•´æ›´åŠ çµæ´»ï¼Œå¹¶ä¸”åç»­å¦‚æœä¸éœ€è¦ç›¸å¯¹å±‚çº§äº†ï¼Œä¹Ÿä¸éœ€è¦æ‰§è¡Œç¹ççš„â€å…ˆå°†å½“å‰Layerä»ç›¸å¯¹å±‚çº§Layerä¸Šç§»é™¤ï¼Œå†é‡æ–°ç»‘å®šå›åŸçˆ¶Layerâ€œçš„æ“ä½œï¼Œç›´æ¥è®¾ç½®ä¸€ä¸‹å±‚çº§å€¼å°±å¯ä»¥å°†ç›¸å¯¹å±‚çº§Layerç§»é™¤äº†ã€‚ å¦å¤–ä½ ä¹Ÿå¯ä»¥æ ¹æ®éœ€è¦ï¼Œä¸ºDimLayerè®¾ç½®ä¸åŒçš„ç›¸å¯¹å±‚çº§å¯¹è±¡ï¼Œä»è€Œå®ç°å°†æŸä¸ªå­çª—å£å˜æš—ï¼Œæˆ–è€…å°†æŸä¸ªActivityå˜æš—ï¼Œæˆ–è€…å°†æ•´ä¸ªAppå˜æš—ã€‚ ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:3:4","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#342-dimlayerç›¸å¯¹å±‚çº§ä»å­çª—å£ä¿®æ”¹ä¸ºä¸»çª—å£"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"3.4 DimLayerå’Œç›¸å¯¹å±‚çº§ DimLayerçš„æœ¬è´¨æ˜¯ä¸€ä¸ªEffectLayerï¼Œé»˜è®¤æ˜¯ä¸€ä¸ªçº¯é»‘Layerï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®Layerçš„é€æ˜åº¦æ¥æ–½åŠ é˜´å½±æ•ˆæœï¼Œæˆ–è€…è®¾ç½®Layeræ¨¡ç³ŠåŠå¾„æ¥æ–½åŠ æ¨¡ç³Šæ•ˆæœã€‚ æ¥çœ‹ä¸€ä¸ªå®é™…åº”ç”¨çš„ä¾‹å­ï¼ŒFilesï¼š æ­¤æ—¶Filesæœ‰ä¸¤ä¸ªçª—å£ï¼Œå­çª—å£ç›–åœ¨ä¸»çª—å£ä¸Šï¼Œå¹¶ä¸”æ­¤æ—¶å­çª—å£å£°æ˜äº†ä¸€ä¸ªç‰¹æ®Šçª—å£æ ‡å¿—ä½ï¼š /** Window flag: everything behind this window will be dimmed. * Use {@link #dimAmount} to control the amount of dim. */ public static final int FLAG_DIM_BEHIND = 0x00000002; è¯¥çª—å£æ ‡å¿—ä½çš„ä½œç”¨æ˜¯ï¼Œå°†å£°æ˜äº†è¯¥æ ‡å¿—ä½çš„çª—å£çš„åé¢æ‰€æœ‰å†…å®¹éƒ½å˜æš—ï¼Œå› æ­¤æœ€ç»ˆçš„æ•ˆæœå°±æ˜¯å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå³ä¸»çª—å£è¢«è’™ä¸Šäº†ä¸€å±‚é˜´å½±æ•ˆæœã€‚ æ­¤æ—¶çš„çª—å£å±‚çº§ç»“æ„å›¾æ˜¯ï¼š åœ¨è¿™ä¸ªå±‚çº§ç»“æ„å›¾ä¸­ï¼Œåªæœ‰å¯è§çš„Layeræ‰è¢«æ ‡è®°äº†é¢œè‰²ï¼Œæ­¤æ—¶å¯è§Layerçš„Zè½´é¡ºåºæ˜¯ï¼šå­çª—å£ \u003e DImLayer \u003e ä¸»çª—å£ã€‚ ä¸»çª—å£å’Œå­çª—å£å¯¹åº”çš„ä¸¤ä¸ªBufferStateLayerä¸ç”¨å¤šè¯´ï¼Œè¿™é‡Œä¸»è¦çœ‹ä¸‹DimLayerï¼Œç›¸å…³ä¿¡æ¯å¦‚ä¸‹ï¼š + EffectLayer (Dim Layer for - Task=36#0) uid=1000 z= -1 color=(0.000,0.000,0.000,0.600) parent=Task=36#0 zOrderRelativeOf=f19c0b8 com.google.android.apps.nbu.files/com.google.android.apps.nbu.files.home.HomeActivity#0 alphaå€¼ä¸º0.6ï¼Œä¸Šé¢æˆ‘ä»¬ä¹Ÿæåˆ°è¿‡ï¼ŒEffectLayeré»˜è®¤æ˜¯ä¸€ä¸ªçº¯é»‘çš„Layerï¼Œæˆ‘ä»¬éœ€è¦è®¾ç½®å®ƒçš„é€æ˜åº¦æ¥è¾¾åˆ°å˜æš—çš„æ•ˆæœï¼ˆé€æ˜åº¦ä¸º1åˆ™ä¼šå®Œå…¨é®ä½åé¢çš„å†…å®¹ï¼‰ã€‚ DimLayerçš„çˆ¶Layeræ˜¯Task#36ï¼Œè¿™ä¸ªè·Ÿä¸Šå±‚çš„å®ç°æœ‰å…³ç³»ï¼Œç›®å‰æ˜¯Taskå’ŒDisplayAreaæ”¯æŒåˆ›å»ºè¿™ä¹ˆä¸€ä¸ªDimLayerã€‚ è¿™é‡Œè®¾ç½®äº†DimLayerçš„ç›¸å¯¹å±‚çº§ä¸ºå­çª—å£WindowStateè¿™ä¸€çº§å¯¹åº”çš„ContainerLayerï¼ŒContainerLayer (f19c0b8 com.google.android.apps.nbu.files/com.google.android.apps.nbu.files.home.HomeActivity#0)ã€‚è®¾ç½®ä¸€ä¸ªLayerçš„ç›¸å¯¹å±‚çº§ï¼Œç›¸å½“äºæ˜¯å°†è¯¥Layerä»å…¶åŸæ¥çš„çˆ¶Layerä¸Šå‰¥ç¦»ï¼Œè¿™é‡Œæ˜¯ EffectLayer (Task=36#0)ï¼Œç„¶åå°†è¿™ä¸ªç›¸å¯¹å±‚çº§çš„Layerä½œä¸ºçˆ¶Layerï¼Œè¿™é‡Œæ˜¯ ContainerLayer (f19c0b8 com.google.android.apps.nbu.files/com.google.android.apps.nbu.files.home.HomeActivity#0)ï¼Œé‡æ–°ç»‘å®šåˆ°è¿™ä¸ªçˆ¶Layerä¸Šé¢ã€‚æ‰€ä»¥è¿™é‡Œèƒ½å¤Ÿçœ‹åˆ°è™½ç„¶DimLayerçš„çˆ¶Layeræ˜¯ EffectLayer (Task=36#0)ï¼Œä½†æ˜¯åœ¨å®é™…ä¸Šçš„å±‚çº§ç»“æ„ä¸­ï¼ŒDimLayeræ˜¯ä½œä¸ºäº† ContainerLayer (f19c0b8 com.google.android.apps.nbu.files/com.google.android.apps.nbu.files.home.HomeActivity#0) çš„å­Layerã€‚ å½“ç„¶åªè®¾ç½®ç›¸å¯¹å±‚çº§è¿˜ä¸å¤Ÿï¼Œè¿˜éœ€è¦å°†DimLayerçš„å±‚çº§å€¼è®¾ç½®ä¸º-1ï¼Œè¿™æ ·å®ƒæ‰ä¸ä¼šæŠŠå­çª—å£ä¹Ÿç›–ä½ï¼Œå¹¶ä¸”èƒ½å¤Ÿé®ä½å±‚çº§æ¯”å­çª—å£ä½çš„Layerã€‚ 3.4.1 DimLayerå±‚çº§å€¼ä»-1ä¿®æ”¹ä¸º100 è¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨ä¿®æ”¹DimLayerçš„å®ç°ï¼Œå°†å…¶å±‚çº§å€¼ä»-1ä¿®æ”¹ä¸º100ï¼Œé‚£ä¹ˆæ˜¾ç¤ºæ•ˆæœä¸ºï¼š æ­¤æ—¶é˜´å½±æ•ˆæœä¸ä»…è¦†ç›–äº†ä¸»çª—å£ï¼Œè¿å­çª—å£ä¹Ÿè¦†ç›–äº†ï¼Œå±‚çº§ç»“æ„å›¾ä¸ºï¼š å¾ˆæ˜¾ç„¶ï¼Œå½“è®¾ç½®EffectLayerçš„å±‚çº§å€¼ä¸º100åï¼Œå®ƒå°±å˜æˆäº†å­çª—å£ä¸­å±‚çº§å€¼æœ€é«˜çš„Layerï¼Œæ—¢ç„¶æ¯”å­çª—å£å¯¹åº”çš„BufferStateLayerå±‚çº§å€¼è¿˜é«˜ï¼Œè‡ªç„¶ä¼šæŠŠæ•´ä¸ªActivityéƒ½é®ä½ï¼Œç¬¦åˆé¢„æœŸã€‚ 3.4.2 DimLayerç›¸å¯¹å±‚çº§ä»å­çª—å£ä¿®æ”¹ä¸ºä¸»çª—å£ è¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨ä¿®æ”¹DimLayerçš„å®ç°ï¼Œå°†å…¶ç›¸å¯¹å±‚çº§çš„å¯¹è±¡ä»å­çª—å£ä¿®æ”¹ä¸ºä¸»çª—å£ï¼Œé‚£ä¹ˆæ˜¾ç¤ºæ•ˆæœä¸ºï¼š æ­¤æ—¶é˜´å½±æ•ˆæœæ¶ˆå¤±ï¼Œå±‚çº§ç»“æ„å›¾ä¸ºï¼š å°†EffectLayerçš„ç›¸å¯¹å±‚çº§çš„å¯¹è±¡ä»å­çª—å£ä¿®æ”¹ä¸ºä¸»çª—å£ï¼Œå®ƒå°±å˜æˆäº†å­çª—å£ä¸­å±‚çº§å€¼æœ€ä½çš„Layerï¼Œè‡ªç„¶æ— æ³•å†é®æŒ¡ä»»ä½•Layerï¼Œå¹¶ä¸”è¢«å…¨å±çš„ä¸»çª—å£å®Œå…¨é®æŒ¡ä»è€Œæ— æ³•æ˜¾ç¤ºï¼Œç¬¦åˆé¢„æœŸã€‚ 3.4.3 å°ç»“ ç›¸å¯¹å±‚çº§çš„å‡ºç°ï¼Œä½¿å¾—Layerçš„å±‚çº§é¡ºåºè°ƒæ•´æ›´åŠ çµæ´»ï¼Œå¹¶ä¸”åç»­å¦‚æœä¸éœ€è¦ç›¸å¯¹å±‚çº§äº†ï¼Œä¹Ÿä¸éœ€è¦æ‰§è¡Œç¹ççš„â€å…ˆå°†å½“å‰Layerä»ç›¸å¯¹å±‚çº§Layerä¸Šç§»é™¤ï¼Œå†é‡æ–°ç»‘å®šå›åŸçˆ¶Layerâ€œçš„æ“ä½œï¼Œç›´æ¥è®¾ç½®ä¸€ä¸‹å±‚çº§å€¼å°±å¯ä»¥å°†ç›¸å¯¹å±‚çº§Layerç§»é™¤äº†ã€‚ å¦å¤–ä½ ä¹Ÿå¯ä»¥æ ¹æ®éœ€è¦ï¼Œä¸ºDimLayerè®¾ç½®ä¸åŒçš„ç›¸å¯¹å±‚çº§å¯¹è±¡ï¼Œä»è€Œå®ç°å°†æŸä¸ªå­çª—å£å˜æš—ï¼Œæˆ–è€…å°†æŸä¸ªActivityå˜æš—ï¼Œæˆ–è€…å°†æ•´ä¸ªAppå˜æš—ã€‚ ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:3:4","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#343-å°ç»“"},{"categories":null,"collections":["WMS","å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"4 æ€»ç»“ è¿™é‡Œæˆ‘æŒ‰ç…§è‡ªå·±çš„ç†è§£ç”»äº†ä¸€ä¸‹Androidæ¶æ„å›¾ï¼Œä¸»è¦æ˜¯å¯¹çœ‹ä¸‹Frameworkè¿™å—ï¼š é¡¶å±‚æ˜¯åŸºäºApplicationFrameworkå±‚çš„Appså±‚ï¼ŒApplicationFrameworkæ˜¯è¿è¡Œåœ¨Appè¿›ç¨‹çš„Frameworkä»£ç ï¼Œå¦‚å››å¤§ç»„ä»¶ï¼Œå„ç§Managerã€‚åœ¨è¿™ä¸€å±‚ï¼Œå±å¹•ä¸Šçš„ä¸€å—æ˜¾ç¤ºåŒºåŸŸï¼Œå…¸å‹ä»£è¡¨æ˜¯Activityï¼Œä½†æ˜¯Activityæ¯•ç«Ÿæ˜¯ä¸€ä¸ªç»¼åˆæ€§æ¯”è¾ƒå¼ºçš„æ¦‚å¿µï¼Œå…·ä½“åˆ°å†…å®¹æ˜¾ç¤ºè¿™å—è¿˜æ˜¯ç”±Windowç±»è´Ÿè´£ï¼ŒWindowåˆ™æ˜¯å®¹çº³Viewå¯¹è±¡çš„å®¹å™¨ã€‚æˆ‘ä»¬è¦äº†è§£å±å¹•çš„å†…å®¹æ˜¯å¦‚ä½•ç»„æˆçš„ï¼Œé¦–å…ˆéœ€è¦çŸ¥é“çš„å°±æ˜¯ç»„æˆå±å¹•çš„æœ€å°å•ä½ â€”â€” Windowï¼Œçš„å†…éƒ¨æ„é€ ï¼Œå³æˆ‘ä»¬ä»‹ç»çš„ç¬¬ä¸€éƒ¨åˆ†ï¼ŒViewå±‚çº§ç»“æ„ã€‚ æ¥ç€æ˜¯ç³»ç»ŸæœåŠ¡ï¼Œå…¶ä¸­ç³»ç»ŸæœåŠ¡æ—¢æœ‰åŸºäºJavaçš„WMSä¹‹ç±»ï¼ˆæˆ‘ä¹ æƒ¯å«åšJavaFrameworkï¼‰ï¼Œä¹Ÿæœ‰åŸºäºC++çš„SurfaceFlingerä¹‹ç±»ï¼ˆæˆ‘ä¹ æƒ¯å«åšNativeFrameworkï¼‰ï¼š JavaFrameworkï¼Œåœ¨è¿™ä¸€å±‚ï¼Œå±å¹•ä¸Šçš„ä¸€å—æ˜¾ç¤ºåŒºåŸŸï¼Œå…¸å‹ä»£è¡¨æ˜¯WindowStateï¼Œå½“ç„¶æ›´åŠ é€šç”¨çš„ç»“æ„æ˜¯WindowContainerã€‚WMSä½œä¸ºç®¡ç†çª—å£çš„æœåŠ¡ï¼Œå®ƒéœ€è¦æŠŠå±å¹•ä¸Šçš„æ‰€æœ‰çª—å£æŒ‰ç…§ä¸€å®šçš„è§„åˆ™ç³»ç»ŸåŒ–çš„ç»„ç»‡èµ·æ¥ï¼Œå³æˆ‘ä»¬ä»‹ç»çš„ç¬¬äºŒéƒ¨åˆ†ï¼ŒWindowContainerå±‚çº§ç»“æ„ã€‚è¿™æ ·SurfaceFlingerå°±åªéœ€è¦æ“å¿ƒåˆæˆLayerçš„ç›¸å…³äº‹åŠ¡å°±è¡Œäº†ï¼Œä¸éœ€è¦å»å…³å¿ƒå¦‚ä½•å»å»ºç«‹å¦‚æ­¤åºå¤§çš„ä¸€ä¸ªå±‚çº§ç»“æ„ã€‚ NativeFrameworkï¼Œåœ¨è¿™ä¸€å±‚ï¼Œå±å¹•ä¸Šçš„ä¸€å—æ˜¾ç¤ºåŒºåŸŸï¼Œå…¸å‹ä»£è¡¨æ˜¯BufferStateLayerï¼Œå½“å‰æ›´åŠ é€šç”¨çš„ç»“æ„æ˜¯Layerã€‚SurfaceFlingerå¯¹Layerè¿›è¡Œåˆæˆéœ€è¦åŸºäºLayerå±‚çº§ç»“æ„ï¼Œè€ŒLayerå±‚çº§ç»“æ„çš„åŸºæœ¬æ¡†æ¶å°±æ˜¯WindowContainerå±‚çº§ç»“æ„ï¼Œå¦å¤–WMSä¹Ÿå¯ä»¥é€šè¿‡SurfaceControlæ¥åœ¨Layerå±‚çº§ç»“æ„é‡Œè¿›è¡Œä¸€äº›å±€éƒ¨çš„è°ƒæ•´ã€‚ è½¬è½½ï¼šhttps://blog.csdn.net/ukynho/article/details/132327216 ","date":"2024-11-06","objectID":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/:4:0","tags":["clippings","blog","è½¬è½½"],"title":"ã€Android 12ã€‘è®¤è¯†çª—å£_android çª—å£æ¨¡å¼ çª—å£å±‚çº§-CSDNåšå®¢","uri":"/posts/%E8%AE%A4%E8%AF%86%E7%AA%97%E5%8F%A3-%E7%AA%97%E5%8F%A3%E6%A8%A1%E5%BC%8F-%E7%AA%97%E5%8F%A3%E5%B1%82%E7%BA%A7android-12-csdn%E5%8D%9A%E5%AE%A2/#4-æ€»ç»“"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"æ•´ä½“æ¡†æ¶ VsyncConfigurationï¼šä¸€äº›åŸºæœ¬å‚æ•°çš„é…ç½®ç±»ï¼Œæ¯”å¦‚PhaseOffsetsã€WorkDurationç­‰ã€‚ Schedulerï¼šä½œä¸ºSFç”Ÿæˆå’Œæ´¾å‘VSyncçš„æ•´ä½“è°ƒåº¦å™¨ï¼Œä¸»è¦é¢å‘SurfaceFlingeræä¾›VSyncç›¸å…³æ¥å£ã€‚ScheduleråŒ…å«å¯¹æ‰€æœ‰å±å¹•çš„VSyncçš„æ§åˆ¶ã€‚æœ¬èº«æ˜¯MessageQueueçš„å­ç±»ã€‚ Refresh****RateSelectorï¼šæ¯ä¸ªDisplayå±å¹•å¯¹åº”ä¸€ä¸ªRefreshRateSelectorï¼Œç”¨äºåŸºäºå±å¹•æ”¯æŒçš„åˆ·æ–°ç‡èŒƒå›´ï¼Œé€‰æ‹©ä¸€ä¸ªåˆé€‚çš„Refresh Rateå’ŒFrame Rateï¼Œå¹¶ä¼šä¼ é€’ç»™VSyncScheduleä½œä¸ºè½¯ä»¶VSyncç”Ÿæˆçš„é‡è¦å› ç´ ã€‚ VsyncScheduleï¼šVsyncç”Ÿæˆçš„è°ƒåº¦å™¨ã€‚æ¯ä¸ªå±å¹•å¯¹åº”ä¸€ä¸ªVsyncScheduleã€‚åŒ…å«ä¸€ä¸ªTrackerï¼ˆVSyncPredictorï¼‰ã€ä¸€ä¸ªDispatchï¼ˆVSyncDispatchTimerQueueï¼‰ã€ä¸€ä¸ªControllerï¼ˆVSyncReactorï¼‰ã€‚ä¸€æ–¹é¢å¯¹æ¥ç¡¬ä»¶VSyncä¿¡å·çš„æ¥æ”¶ã€å¼€å…³ï¼Œä¸€æ–¹é¢å¯¹æ¥è½¯ä»¶VSyncçš„è®¡ç®—ã€è¾“å‡ºã€‚ VSyncPredictor ï¼šåœ¨VsyncScheduleçš„è¯­å¢ƒä¸­ä¸ºä¸€ä¸ªTrackerï¼Œæ˜¯è´Ÿè´£ç»¼åˆå„æ–¹å› ç´ æ ¹æ®ç®—æ³•ç”±ç¡¬ä»¶VSyncè®¡ç®—å‡ºè½¯ä»¶VSyncå‘¨æœŸçš„å·¥å…·ç±»ã€‚ VSyncDispatchTimerQueueï¼šåœ¨VsyncScheduleçš„è¯­å¢ƒä¸­ä¸ºä¸€ä¸ªDispatherï¼Œè´Ÿè´£å°†VSyncåˆ†å‘åˆ°ä½¿ç”¨è€…ã€‚ VSyncCallbackRegistrationï¼šä»£è¡¨ä¸€ä¸ªVSyncä½¿ç”¨è€…çš„æ³¨å†Œã€‚æ¯”å¦‚å¸¸è§çš„é’ˆå¯¹ä¸Šå±‚åº”ç”¨çš„VSYNC-appã€é’ˆå¯¹SurfaceFlingeråˆæˆçš„VSYNC-sfï¼Œéƒ½å¯¹åº”ä¸€ä¸ªVSyncCallbackRegistrationã€‚å¦å¤–åœ¨å®¢æˆ·ç«¯ï¼Œè¿˜æœ‰ä¸€ä¸ªVSYNC-appSfã€‚ EventThreadï¼šå¤„ç†å®¢æˆ·ç«¯åº”ç”¨VSYNCçš„ä¸€ä¸ªç‹¬ç«‹çº¿ç¨‹ã€‚æœŸå†…ç»´æŠ¤ä¸€ä¸ªä¸æ–­è¯·æ±‚VSYNCçš„æ­»å¾ªç¯ã€‚æ¯”å¦‚VSYNC-appï¼Œä¸€æ–¹é¢ï¼Œé€šè¿‡VSyncCallbackRegistrationå»ç”³è¯·ä¸‹ä¸€æ¬¡VSYNCï¼Œå¦ä¸€æ–¹é¢ï¼Œå½“VSYNCç”Ÿæˆï¼Œé€šè¿‡Connectionå°†VSYNCå‘é€ç»™DisplayEventReceiverï¼Œä¹Ÿå°±æ˜¯VSYNCçš„ç»ˆç«¯æ¥æ”¶è€…ã€‚ä¸€èˆ¬æƒ…å†µä¸‹æœ‰ä¸¤ä¸ªEventThreadï¼Œä¸€ä¸ªæ˜¯é’ˆå¯¹å®¢æˆ·ç«¯åº”ç”¨ä¾§çš„VSYNC-appï¼Œå¦ä¸€ä¸ªæ˜¯å®¢æˆ·ç«¯æƒ³ä½¿ç”¨SFåŒæ­¥ä¿¡å·çš„VSYNC-appSfã€‚ DisplayEventReceiverï¼šé€šè¿‡socketæœºåˆ¶æä¾›äº†ä¸€ä¸ªSFä¸å®¢æˆ·ç«¯åº”ç”¨ä¼ é€’VSYNCçš„é€šé“ã€‚åœ¨æœåŠ¡ç«¯ï¼ŒEventThreadé€šè¿‡DisplayEventReceiverå‘é€VSYNCäº‹ä»¶ï¼Œåœ¨å®¢æˆ·ç«¯ï¼ŒChoreographeré€šè¿‡DisplayEventReceiveræ¥æ”¶åˆ°VSYNCåï¼Œä¸‹å‘ç»™ViewRootImpé©±åŠ¨ä¸‹ä¸€æ¬¡ç»˜åˆ¶æ¸²æŸ“ã€‚ Android 13ä»¥åï¼ŒVSYNCæ¶æ„å˜åŒ–ä¹‹ä¸€æ˜¯ç»™SFä½¿ç”¨çš„VSYNC-sfä¿¡å·ï¼Œä¸å†é€šè¿‡EventThreadç»´æŠ¤ï¼Œè€Œæ˜¯ç›´æ¥åœ¨Scheduleå†…ç»´æŠ¤ã€‚ä¾›å®¢æˆ·ç«¯åº”ç”¨ä½¿ç”¨çš„VSYN-appä»ç„¶ç”±EventThreadç»´æŠ¤ï¼Œå¦å¤–ï¼Œæ–°å¢äº†ä¸€ä¸ªVSYN-appSfä¿¡å·ï¼Œä¹Ÿæ˜¯ç”±EventThreadç»´æŠ¤ã€‚ä¸»è¦ä½œç”¨æ˜¯å¦‚æœå®¢æˆ·ç«¯æƒ³ä½¿ç”¨SFåŒæ­¥çš„ä¿¡å·ï¼Œå¯ä»¥åˆ‡æ¢åˆ°VSYNC-appSfè¿™ä¸ªä¿¡å·æºæ¥ã€‚åœ¨Android 13ä¹‹å‰ï¼Œè¿™ä¸ªæœºåˆ¶æ˜¯é€šè¿‡VSYNC-sfå®ç°çš„ï¼ŒAndroid 13åå°†SFä¸“é—¨ä½¿ç”¨çš„VSYNC-sfä»EventThreadå‰¥ç¦»å‡ºæ¥ç›´æ¥ç”±Scheduleç»´æŠ¤ï¼ŒVSYN-appSfåˆ™ä¸“é—¨é’ˆå¯¹å®¢æˆ·ç«¯ã€‚ ","date":"2024-11-06","objectID":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-vsync1-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"Android 14 - ç»˜åˆ¶ä½“ç³» - VSyncï¼ˆ1ï¼‰-CSDNåšå®¢","uri":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-vsync1-csdn%E5%8D%9A%E5%AE%A2/#æ•´ä½“æ¡†æ¶"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"å…³é”®****å‚æ•° åœ¨æ¢ç´¢VSyncæœºåˆ¶å‰ï¼Œéœ€è¦å¯¹ä¸€äº›å…³é”®å‚æ•°çš„æ¦‚å¿µæœ‰æ‰€äº†è§£ï¼Œä»dumpsys SurfaceFlingerå…¥æ‰‹ï¼š å±å¹•åˆ·æ–°ç‡ ColorModeï¼šè®¾å¤‡æ”¯æŒçš„ColorModeï¼›å¯æ ¹æ®ç³»ç»Ÿè®¾ç½®æˆ–åº”ç”¨è‡ªèº«è®¾å®šçš„é¢œè‰²æ¨¡å¼æœ€ç»ˆå†³å®šä½¿ç”¨é‚£ä¸ªColorModeã€‚ deviceProductInfoï¼š å±å¹•è®¾å¤‡ä¿¡æ¯ï¼›manufacturerPnpId=QCMä¸ºPlug and Playå³æ’å³ç”¨è®¾å¤‡å”¯ä¸€è¯†åˆ«ç ã€‚ activeModeï¼šå½“å‰ä½¿ç”¨çš„å¸§ç‡æ¨¡å¼ displayModesï¼šå½“å‰å±å¹•æ”¯æŒçš„å¸§ç‡æ¨¡å¼ã€‚ä»æ‰“å°çš„ä¿¡æ¯çœ‹æ”¯æŒ60Hzã€90Hzä¸¤ç§å¸§ç‡ displayManagerPolicyï¼šå½“å‰é‡‡ç”¨çš„å¸§ç‡ç®¡ç†ç­–ç•¥ã€‚primaryRangesä»£è¡¨çš„æ˜¯åœ¨é€‰å–å¸§ç‡æ—¶ï¼Œé€šå¸¸é‡‡çº³çš„èŒƒå›´ï¼Œå¦‚æœç”¨æˆ·é€šè¿‡setFrameRateæ‰‹åŠ¨æŒ‡å®šä¸€ä¸ªå¸§ç‡ï¼Œå…¶å¯èƒ½è¶…å‡ºprimaryRangesçš„èŒƒå›´ï¼›appRequestRangesä»£è¡¨ç”¨æˆ·å¯ä»¥æŒ‡å®šçš„å¸§ç‡èŒƒå›´ã€‚æœ€ç»ˆçš„å¸§ç‡å¯èƒ½è¶…è¿‡primaryRangesï¼Œä½†ç»ä¸ä¼šè¶…è¿‡appRequestRangesã€‚ ","date":"2024-11-06","objectID":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-vsync1-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"Android 14 - ç»˜åˆ¶ä½“ç³» - VSyncï¼ˆ1ï¼‰-CSDNåšå®¢","uri":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-vsync1-csdn%E5%8D%9A%E5%AE%A2/#å…³é”®å‚æ•°"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"å…³é”®****å‚æ•° åœ¨æ¢ç´¢VSyncæœºåˆ¶å‰ï¼Œéœ€è¦å¯¹ä¸€äº›å…³é”®å‚æ•°çš„æ¦‚å¿µæœ‰æ‰€äº†è§£ï¼Œä»dumpsys SurfaceFlingerå…¥æ‰‹ï¼š å±å¹•åˆ·æ–°ç‡ ColorModeï¼šè®¾å¤‡æ”¯æŒçš„ColorModeï¼›å¯æ ¹æ®ç³»ç»Ÿè®¾ç½®æˆ–åº”ç”¨è‡ªèº«è®¾å®šçš„é¢œè‰²æ¨¡å¼æœ€ç»ˆå†³å®šä½¿ç”¨é‚£ä¸ªColorModeã€‚ deviceProductInfoï¼š å±å¹•è®¾å¤‡ä¿¡æ¯ï¼›manufacturerPnpId=QCMä¸ºPlug and Playå³æ’å³ç”¨è®¾å¤‡å”¯ä¸€è¯†åˆ«ç ã€‚ activeModeï¼šå½“å‰ä½¿ç”¨çš„å¸§ç‡æ¨¡å¼ displayModesï¼šå½“å‰å±å¹•æ”¯æŒçš„å¸§ç‡æ¨¡å¼ã€‚ä»æ‰“å°çš„ä¿¡æ¯çœ‹æ”¯æŒ60Hzã€90Hzä¸¤ç§å¸§ç‡ displayManagerPolicyï¼šå½“å‰é‡‡ç”¨çš„å¸§ç‡ç®¡ç†ç­–ç•¥ã€‚primaryRangesä»£è¡¨çš„æ˜¯åœ¨é€‰å–å¸§ç‡æ—¶ï¼Œé€šå¸¸é‡‡çº³çš„èŒƒå›´ï¼Œå¦‚æœç”¨æˆ·é€šè¿‡setFrameRateæ‰‹åŠ¨æŒ‡å®šä¸€ä¸ªå¸§ç‡ï¼Œå…¶å¯èƒ½è¶…å‡ºprimaryRangesçš„èŒƒå›´ï¼›appRequestRangesä»£è¡¨ç”¨æˆ·å¯ä»¥æŒ‡å®šçš„å¸§ç‡èŒƒå›´ã€‚æœ€ç»ˆçš„å¸§ç‡å¯èƒ½è¶…è¿‡primaryRangesï¼Œä½†ç»ä¸ä¼šè¶…è¿‡appRequestRangesã€‚ ","date":"2024-11-06","objectID":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-vsync1-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"Android 14 - ç»˜åˆ¶ä½“ç³» - VSyncï¼ˆ1ï¼‰-CSDNåšå®¢","uri":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-vsync1-csdn%E5%8D%9A%E5%AE%A2/#å±å¹•åˆ·æ–°ç‡"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"ä¸»è¦ç»„ä»¶çš„åˆå§‹åŒ– SurfaceFlingerçš„åˆå§‹åŒ– SurfaceFlingerçš„å¯åŠ¨æºäºSystemServeræ‰§è¡Œmain_surfaceflinger.cppçš„mainæ–¹æ³•ï¼š int main(int, char**) { ... sp\u003cSurfaceFlinger\u003e flinger = surfaceflinger::createSurfaceFlinger(); ... flinger-\u003einit(); ... } surfaceflinger::createSurfaceFlinger()çš„å®ç°åœ¨platform/frameworks/native/services/surfaceflinger/SurfaceFlingerFactory.cpp sp\u003cSurfaceFlinger\u003e createSurfaceFlinger() { static DefaultFactory factory; return sp\u003cSurfaceFlinger\u003e::make(factory); } éšåï¼Œè°ƒç”¨SurfaceFlingerçš„initæ–¹æ³•ï¼š platform/frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp void SurfaceFlinger::init() FTL_FAKE_GUARD(kMainThreadContext) { ... sp\u003cconst DisplayDevice\u003e display; if (const auto indexOpt = mCurrentState.getDisplayIndex(getPrimaryDisplayIdLocked())) { const auto\u0026 displays = mCurrentState.displays; const auto\u0026 token = displays.keyAt(*indexOpt); const auto\u0026 state = displays.valueAt(*indexOpt); processDisplayAdded(token, state); mDrawingState.displays.add(token, state); display = getDefaultDisplayDeviceLocked(); } ... initScheduler(display); ... } æ„å»ºRefreshRateSelector ä¸Šé¢çš„ä»£ç ä¸­è°ƒç”¨äº†processDisplayAddedæ·»åŠ ä¸»å±å¹•ï¼Œåç»­æŒ‚è½½ä¸€ä¸ªæ–°å±å¹•ä¹Ÿä¼šèµ°æ­¤æµç¨‹ï¼š void SurfaceFlinger::processDisplayAdded(const wp\u003cIBinder\u003e\u0026 displayToken, const DisplayDeviceState\u0026 state) { ... auto display = setupNewDisplayDeviceInternal(displayToken, std::move(compositionDisplay), state, displaySurface, producer); ... } sp\u003cDisplayDevice\u003e SurfaceFlinger::setupNewDisplayDeviceInternal( const wp\u003cIBinder\u003e\u0026 displayToken, std::shared_ptr\u003ccompositionengine::Display\u003e compositionDisplay, const DisplayDeviceState\u0026 state, const sp\u003ccompositionengine::DisplaySurface\u003e\u0026 displaySurface, const sp\u003cIGraphicBufferProducer\u003e\u0026 producer) { ... creationArgs.refreshRateSelector = mPhysicalDisplays.get(physical-\u003eid) .transform(\u0026PhysicalDisplay::snapshotRef) .transform([\u0026](const display::DisplaySnapshot\u0026 snapshot) { return std::make_shared\u003c scheduler::RefreshRateSelector\u003e(snapshot.displayModes(), creationArgs.activeModeId, config); }) .value_or(nullptr); ... sp\u003cDisplayDevice\u003e display = getFactory().createDisplayDevice(creationArgs); } ä¸Šé¢ä¸ºæ¯ä¸ªDisplayéƒ½æ„å»ºäº†ä¸€ä¸ªrefreshRateSelectorï¼Œå³RefreshRateSelector åˆå§‹åŒ–****Scheduler VSyncç›¸å…³åˆå§‹åŒ–ï¼Œéƒ½åœ¨initSchedulerä¸­ void SurfaceFlinger::initScheduler(const sp\u003cconst DisplayDevice\u003e\u0026 display) { const auto activeMode = display-\u003erefreshRateSelector().getActiveMode(); const Fps activeRefreshRate = activeMode.fps; // åˆ›å»ºé…ç½® mVsyncConfiguration = getFactory().createVsyncConfiguration(activeRefreshRate); // åˆ›å»ºScheduler mScheduler = std::make_unique\u003cScheduler\u003e(static_cast\u003cICompositor\u0026\u003e(*this), static_cast\u003cISchedulerCallback\u0026\u003e(*this), features, std::move(modulatorPtr)); // æ³¨å†Œå±å¹•ï¼Œä¸ºæ¯ä¸ªå±å¹•æ„å»ºä¸€ä¸ªVsyncScheduleå¯¹è±¡ mScheduler-\u003eregisterDisplay(display-\u003egetPhysicalId(), display-\u003eholdRefreshRateSelector()); mScheduler-\u003estartTimers(); // åˆ›å»ºVSYNC-appå¯¹åº”çš„EventThread mAppConnectionHandle = mScheduler-\u003ecreateEventThread(Scheduler::Cycle::Render, mFrameTimeline-\u003egetTokenManager(), /* workDuration */ configs.late.appWorkDuration, /* readyDuration */ configs.late.sfWorkDuration); // åˆ›å»ºVSYNC-appSfå¯¹åº”çš„EventThread mSfConnectionHandle = mScheduler-\u003ecreateEventThread(Scheduler::Cycle::LastComposite, mFrameTimeline-\u003egetTokenManager(), /* workDuration */ activeRefreshRate.getPeriod(), /* readyDuration */ configs.late.sfWorkDuration); // åˆ›å»ºVSYNC-sfå¯¹åº”çš„è°ƒåº¦å™¨ mScheduler-\u003einitVsync(mScheduler-\u003egetVsyncSchedule()-\u003egetDispatch(), *mFrameTimeline-\u003egetTokenManager(), configs.late.sfWorkDuration); ... } VsyncScheduleçš„åˆ›å»ºåœ¨Scheduler::registerDisplayä¸­ platform/frameworks/native/services/surfaceflinger/Scheduler/Scheduler.cpp void Scheduler::registerDisplay(PhysicalDisplayId displayId, RefreshRateSelectorPtr selectorPtr) { auto schedulePtr = std::make_shared\u003cVsyncSchedule\u003e(displayId, mFeatures, [this](PhysicalDisplayId id, bool enable) { onHardwareVsyncRequest(id, enable); }); registerDisplayInternal(displayId, std::move(selectorPtr), std::move(schedulePtr)); } VsyncScheduleæ„é€ å‡½æ•°çš„åˆå§‹åŒ–ï¼š platform/frameworks/native/services/surfaceflinger/Scheduler/VsyncSchedule.cpp VsyncSchedule::Vsy","date":"2024-11-06","objectID":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-vsync1-csdn%E5%8D%9A%E5%AE%A2/:1:2","tags":["clippings","è½¬è½½","blog"],"title":"Android 14 - ç»˜åˆ¶ä½“ç³» - VSyncï¼ˆ1ï¼‰-CSDNåšå®¢","uri":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-vsync1-csdn%E5%8D%9A%E5%AE%A2/#ä¸»è¦ç»„ä»¶çš„åˆå§‹åŒ–"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"ä¸»è¦ç»„ä»¶çš„åˆå§‹åŒ– SurfaceFlingerçš„åˆå§‹åŒ– SurfaceFlingerçš„å¯åŠ¨æºäºSystemServeræ‰§è¡Œmain_surfaceflinger.cppçš„mainæ–¹æ³•ï¼š int main(int, char**) { ... sp flinger = surfaceflinger::createSurfaceFlinger(); ... flinger-\u003einit(); ... } surfaceflinger::createSurfaceFlinger()çš„å®ç°åœ¨platform/frameworks/native/services/surfaceflinger/SurfaceFlingerFactory.cpp sp createSurfaceFlinger() { static DefaultFactory factory; return sp::make(factory); } éšåï¼Œè°ƒç”¨SurfaceFlingerçš„initæ–¹æ³•ï¼š platform/frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp void SurfaceFlinger::init() FTL_FAKE_GUARD(kMainThreadContext) { ... sp display; if (const auto indexOpt = mCurrentState.getDisplayIndex(getPrimaryDisplayIdLocked())) { const auto\u0026 displays = mCurrentState.displays; const auto\u0026 token = displays.keyAt(*indexOpt); const auto\u0026 state = displays.valueAt(*indexOpt); processDisplayAdded(token, state); mDrawingState.displays.add(token, state); display = getDefaultDisplayDeviceLocked(); } ... initScheduler(display); ... } æ„å»ºRefreshRateSelector ä¸Šé¢çš„ä»£ç ä¸­è°ƒç”¨äº†processDisplayAddedæ·»åŠ ä¸»å±å¹•ï¼Œåç»­æŒ‚è½½ä¸€ä¸ªæ–°å±å¹•ä¹Ÿä¼šèµ°æ­¤æµç¨‹ï¼š void SurfaceFlinger::processDisplayAdded(const wp\u0026 displayToken, const DisplayDeviceState\u0026 state) { ... auto display = setupNewDisplayDeviceInternal(displayToken, std::move(compositionDisplay), state, displaySurface, producer); ... } sp SurfaceFlinger::setupNewDisplayDeviceInternal( const wp\u0026 displayToken, std::shared_ptr compositionDisplay, const DisplayDeviceState\u0026 state, const sp\u0026 displaySurface, const sp\u0026 producer) { ... creationArgs.refreshRateSelector = mPhysicalDisplays.get(physical-\u003eid) .transform(\u0026PhysicalDisplay::snapshotRef) .transform([\u0026](const display::DisplaySnapshot\u0026 snapshot) { return std::make_shared\u003c scheduler::RefreshRateSelector\u003e(snapshot.displayModes(), creationArgs.activeModeId, config); }) .value_or(nullptr); ... sp display = getFactory().createDisplayDevice(creationArgs); } ä¸Šé¢ä¸ºæ¯ä¸ªDisplayéƒ½æ„å»ºäº†ä¸€ä¸ªrefreshRateSelectorï¼Œå³RefreshRateSelector åˆå§‹åŒ–****Scheduler VSyncç›¸å…³åˆå§‹åŒ–ï¼Œéƒ½åœ¨initSchedulerä¸­ void SurfaceFlinger::initScheduler(const sp\u0026 display) { const auto activeMode = display-\u003erefreshRateSelector().getActiveMode(); const Fps activeRefreshRate = activeMode.fps; // åˆ›å»ºé…ç½® mVsyncConfiguration = getFactory().createVsyncConfiguration(activeRefreshRate); // åˆ›å»ºScheduler mScheduler = std::make_unique(static_cast(*this), static_cast(*this), features, std::move(modulatorPtr)); // æ³¨å†Œå±å¹•ï¼Œä¸ºæ¯ä¸ªå±å¹•æ„å»ºä¸€ä¸ªVsyncScheduleå¯¹è±¡ mScheduler-\u003eregisterDisplay(display-\u003egetPhysicalId(), display-\u003eholdRefreshRateSelector()); mScheduler-\u003estartTimers(); // åˆ›å»ºVSYNC-appå¯¹åº”çš„EventThread mAppConnectionHandle = mScheduler-\u003ecreateEventThread(Scheduler::Cycle::Render, mFrameTimeline-\u003egetTokenManager(), /* workDuration */ configs.late.appWorkDuration, /* readyDuration */ configs.late.sfWorkDuration); // åˆ›å»ºVSYNC-appSfå¯¹åº”çš„EventThread mSfConnectionHandle = mScheduler-\u003ecreateEventThread(Scheduler::Cycle::LastComposite, mFrameTimeline-\u003egetTokenManager(), /* workDuration */ activeRefreshRate.getPeriod(), /* readyDuration */ configs.late.sfWorkDuration); // åˆ›å»ºVSYNC-sfå¯¹åº”çš„è°ƒåº¦å™¨ mScheduler-\u003einitVsync(mScheduler-\u003egetVsyncSchedule()-\u003egetDispatch(), *mFrameTimeline-\u003egetTokenManager(), configs.late.sfWorkDuration); ... } VsyncScheduleçš„åˆ›å»ºåœ¨Scheduler::registerDisplayä¸­ platform/frameworks/native/services/surfaceflinger/Scheduler/Scheduler.cpp void Scheduler::registerDisplay(PhysicalDisplayId displayId, RefreshRateSelectorPtr selectorPtr) { auto schedulePtr = std::make_shared(displayId, mFeatures, [this](PhysicalDisplayId id, bool enable) { onHardwareVsyncRequest(id, enable); }); registerDisplayInternal(displayId, std::move(selectorPtr), std::move(schedulePtr)); } VsyncScheduleæ„é€ å‡½æ•°çš„åˆå§‹åŒ–ï¼š platform/frameworks/native/services/surfaceflinger/Scheduler/VsyncSchedule.cpp VsyncSchedule::Vsy","date":"2024-11-06","objectID":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-vsync1-csdn%E5%8D%9A%E5%AE%A2/:1:2","tags":["clippings","è½¬è½½","blog"],"title":"Android 14 - ç»˜åˆ¶ä½“ç³» - VSyncï¼ˆ1ï¼‰-CSDNåšå®¢","uri":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-vsync1-csdn%E5%8D%9A%E5%AE%A2/#surfaceflingerçš„åˆå§‹åŒ–"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"ä¸»è¦ç»„ä»¶çš„åˆå§‹åŒ– SurfaceFlingerçš„åˆå§‹åŒ– SurfaceFlingerçš„å¯åŠ¨æºäºSystemServeræ‰§è¡Œmain_surfaceflinger.cppçš„mainæ–¹æ³•ï¼š int main(int, char**) { ... sp flinger = surfaceflinger::createSurfaceFlinger(); ... flinger-\u003einit(); ... } surfaceflinger::createSurfaceFlinger()çš„å®ç°åœ¨platform/frameworks/native/services/surfaceflinger/SurfaceFlingerFactory.cpp sp createSurfaceFlinger() { static DefaultFactory factory; return sp::make(factory); } éšåï¼Œè°ƒç”¨SurfaceFlingerçš„initæ–¹æ³•ï¼š platform/frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp void SurfaceFlinger::init() FTL_FAKE_GUARD(kMainThreadContext) { ... sp display; if (const auto indexOpt = mCurrentState.getDisplayIndex(getPrimaryDisplayIdLocked())) { const auto\u0026 displays = mCurrentState.displays; const auto\u0026 token = displays.keyAt(*indexOpt); const auto\u0026 state = displays.valueAt(*indexOpt); processDisplayAdded(token, state); mDrawingState.displays.add(token, state); display = getDefaultDisplayDeviceLocked(); } ... initScheduler(display); ... } æ„å»ºRefreshRateSelector ä¸Šé¢çš„ä»£ç ä¸­è°ƒç”¨äº†processDisplayAddedæ·»åŠ ä¸»å±å¹•ï¼Œåç»­æŒ‚è½½ä¸€ä¸ªæ–°å±å¹•ä¹Ÿä¼šèµ°æ­¤æµç¨‹ï¼š void SurfaceFlinger::processDisplayAdded(const wp\u0026 displayToken, const DisplayDeviceState\u0026 state) { ... auto display = setupNewDisplayDeviceInternal(displayToken, std::move(compositionDisplay), state, displaySurface, producer); ... } sp SurfaceFlinger::setupNewDisplayDeviceInternal( const wp\u0026 displayToken, std::shared_ptr compositionDisplay, const DisplayDeviceState\u0026 state, const sp\u0026 displaySurface, const sp\u0026 producer) { ... creationArgs.refreshRateSelector = mPhysicalDisplays.get(physical-\u003eid) .transform(\u0026PhysicalDisplay::snapshotRef) .transform([\u0026](const display::DisplaySnapshot\u0026 snapshot) { return std::make_shared\u003c scheduler::RefreshRateSelector\u003e(snapshot.displayModes(), creationArgs.activeModeId, config); }) .value_or(nullptr); ... sp display = getFactory().createDisplayDevice(creationArgs); } ä¸Šé¢ä¸ºæ¯ä¸ªDisplayéƒ½æ„å»ºäº†ä¸€ä¸ªrefreshRateSelectorï¼Œå³RefreshRateSelector åˆå§‹åŒ–****Scheduler VSyncç›¸å…³åˆå§‹åŒ–ï¼Œéƒ½åœ¨initSchedulerä¸­ void SurfaceFlinger::initScheduler(const sp\u0026 display) { const auto activeMode = display-\u003erefreshRateSelector().getActiveMode(); const Fps activeRefreshRate = activeMode.fps; // åˆ›å»ºé…ç½® mVsyncConfiguration = getFactory().createVsyncConfiguration(activeRefreshRate); // åˆ›å»ºScheduler mScheduler = std::make_unique(static_cast(*this), static_cast(*this), features, std::move(modulatorPtr)); // æ³¨å†Œå±å¹•ï¼Œä¸ºæ¯ä¸ªå±å¹•æ„å»ºä¸€ä¸ªVsyncScheduleå¯¹è±¡ mScheduler-\u003eregisterDisplay(display-\u003egetPhysicalId(), display-\u003eholdRefreshRateSelector()); mScheduler-\u003estartTimers(); // åˆ›å»ºVSYNC-appå¯¹åº”çš„EventThread mAppConnectionHandle = mScheduler-\u003ecreateEventThread(Scheduler::Cycle::Render, mFrameTimeline-\u003egetTokenManager(), /* workDuration */ configs.late.appWorkDuration, /* readyDuration */ configs.late.sfWorkDuration); // åˆ›å»ºVSYNC-appSfå¯¹åº”çš„EventThread mSfConnectionHandle = mScheduler-\u003ecreateEventThread(Scheduler::Cycle::LastComposite, mFrameTimeline-\u003egetTokenManager(), /* workDuration */ activeRefreshRate.getPeriod(), /* readyDuration */ configs.late.sfWorkDuration); // åˆ›å»ºVSYNC-sfå¯¹åº”çš„è°ƒåº¦å™¨ mScheduler-\u003einitVsync(mScheduler-\u003egetVsyncSchedule()-\u003egetDispatch(), *mFrameTimeline-\u003egetTokenManager(), configs.late.sfWorkDuration); ... } VsyncScheduleçš„åˆ›å»ºåœ¨Scheduler::registerDisplayä¸­ platform/frameworks/native/services/surfaceflinger/Scheduler/Scheduler.cpp void Scheduler::registerDisplay(PhysicalDisplayId displayId, RefreshRateSelectorPtr selectorPtr) { auto schedulePtr = std::make_shared(displayId, mFeatures, [this](PhysicalDisplayId id, bool enable) { onHardwareVsyncRequest(id, enable); }); registerDisplayInternal(displayId, std::move(selectorPtr), std::move(schedulePtr)); } VsyncScheduleæ„é€ å‡½æ•°çš„åˆå§‹åŒ–ï¼š platform/frameworks/native/services/surfaceflinger/Scheduler/VsyncSchedule.cpp VsyncSchedule::Vsy","date":"2024-11-06","objectID":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-vsync1-csdn%E5%8D%9A%E5%AE%A2/:1:2","tags":["clippings","è½¬è½½","blog"],"title":"Android 14 - ç»˜åˆ¶ä½“ç³» - VSyncï¼ˆ1ï¼‰-CSDNåšå®¢","uri":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-vsync1-csdn%E5%8D%9A%E5%AE%A2/#æ„å»ºrefreshrateselector"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"ä¸»è¦ç»„ä»¶çš„åˆå§‹åŒ– SurfaceFlingerçš„åˆå§‹åŒ– SurfaceFlingerçš„å¯åŠ¨æºäºSystemServeræ‰§è¡Œmain_surfaceflinger.cppçš„mainæ–¹æ³•ï¼š int main(int, char**) { ... sp flinger = surfaceflinger::createSurfaceFlinger(); ... flinger-\u003einit(); ... } surfaceflinger::createSurfaceFlinger()çš„å®ç°åœ¨platform/frameworks/native/services/surfaceflinger/SurfaceFlingerFactory.cpp sp createSurfaceFlinger() { static DefaultFactory factory; return sp::make(factory); } éšåï¼Œè°ƒç”¨SurfaceFlingerçš„initæ–¹æ³•ï¼š platform/frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp void SurfaceFlinger::init() FTL_FAKE_GUARD(kMainThreadContext) { ... sp display; if (const auto indexOpt = mCurrentState.getDisplayIndex(getPrimaryDisplayIdLocked())) { const auto\u0026 displays = mCurrentState.displays; const auto\u0026 token = displays.keyAt(*indexOpt); const auto\u0026 state = displays.valueAt(*indexOpt); processDisplayAdded(token, state); mDrawingState.displays.add(token, state); display = getDefaultDisplayDeviceLocked(); } ... initScheduler(display); ... } æ„å»ºRefreshRateSelector ä¸Šé¢çš„ä»£ç ä¸­è°ƒç”¨äº†processDisplayAddedæ·»åŠ ä¸»å±å¹•ï¼Œåç»­æŒ‚è½½ä¸€ä¸ªæ–°å±å¹•ä¹Ÿä¼šèµ°æ­¤æµç¨‹ï¼š void SurfaceFlinger::processDisplayAdded(const wp\u0026 displayToken, const DisplayDeviceState\u0026 state) { ... auto display = setupNewDisplayDeviceInternal(displayToken, std::move(compositionDisplay), state, displaySurface, producer); ... } sp SurfaceFlinger::setupNewDisplayDeviceInternal( const wp\u0026 displayToken, std::shared_ptr compositionDisplay, const DisplayDeviceState\u0026 state, const sp\u0026 displaySurface, const sp\u0026 producer) { ... creationArgs.refreshRateSelector = mPhysicalDisplays.get(physical-\u003eid) .transform(\u0026PhysicalDisplay::snapshotRef) .transform([\u0026](const display::DisplaySnapshot\u0026 snapshot) { return std::make_shared\u003c scheduler::RefreshRateSelector\u003e(snapshot.displayModes(), creationArgs.activeModeId, config); }) .value_or(nullptr); ... sp display = getFactory().createDisplayDevice(creationArgs); } ä¸Šé¢ä¸ºæ¯ä¸ªDisplayéƒ½æ„å»ºäº†ä¸€ä¸ªrefreshRateSelectorï¼Œå³RefreshRateSelector åˆå§‹åŒ–****Scheduler VSyncç›¸å…³åˆå§‹åŒ–ï¼Œéƒ½åœ¨initSchedulerä¸­ void SurfaceFlinger::initScheduler(const sp\u0026 display) { const auto activeMode = display-\u003erefreshRateSelector().getActiveMode(); const Fps activeRefreshRate = activeMode.fps; // åˆ›å»ºé…ç½® mVsyncConfiguration = getFactory().createVsyncConfiguration(activeRefreshRate); // åˆ›å»ºScheduler mScheduler = std::make_unique(static_cast(*this), static_cast(*this), features, std::move(modulatorPtr)); // æ³¨å†Œå±å¹•ï¼Œä¸ºæ¯ä¸ªå±å¹•æ„å»ºä¸€ä¸ªVsyncScheduleå¯¹è±¡ mScheduler-\u003eregisterDisplay(display-\u003egetPhysicalId(), display-\u003eholdRefreshRateSelector()); mScheduler-\u003estartTimers(); // åˆ›å»ºVSYNC-appå¯¹åº”çš„EventThread mAppConnectionHandle = mScheduler-\u003ecreateEventThread(Scheduler::Cycle::Render, mFrameTimeline-\u003egetTokenManager(), /* workDuration */ configs.late.appWorkDuration, /* readyDuration */ configs.late.sfWorkDuration); // åˆ›å»ºVSYNC-appSfå¯¹åº”çš„EventThread mSfConnectionHandle = mScheduler-\u003ecreateEventThread(Scheduler::Cycle::LastComposite, mFrameTimeline-\u003egetTokenManager(), /* workDuration */ activeRefreshRate.getPeriod(), /* readyDuration */ configs.late.sfWorkDuration); // åˆ›å»ºVSYNC-sfå¯¹åº”çš„è°ƒåº¦å™¨ mScheduler-\u003einitVsync(mScheduler-\u003egetVsyncSchedule()-\u003egetDispatch(), *mFrameTimeline-\u003egetTokenManager(), configs.late.sfWorkDuration); ... } VsyncScheduleçš„åˆ›å»ºåœ¨Scheduler::registerDisplayä¸­ platform/frameworks/native/services/surfaceflinger/Scheduler/Scheduler.cpp void Scheduler::registerDisplay(PhysicalDisplayId displayId, RefreshRateSelectorPtr selectorPtr) { auto schedulePtr = std::make_shared(displayId, mFeatures, [this](PhysicalDisplayId id, bool enable) { onHardwareVsyncRequest(id, enable); }); registerDisplayInternal(displayId, std::move(selectorPtr), std::move(schedulePtr)); } VsyncScheduleæ„é€ å‡½æ•°çš„åˆå§‹åŒ–ï¼š platform/frameworks/native/services/surfaceflinger/Scheduler/VsyncSchedule.cpp VsyncSchedule::Vsy","date":"2024-11-06","objectID":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-vsync1-csdn%E5%8D%9A%E5%AE%A2/:1:2","tags":["clippings","è½¬è½½","blog"],"title":"Android 14 - ç»˜åˆ¶ä½“ç³» - VSyncï¼ˆ1ï¼‰-CSDNåšå®¢","uri":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-vsync1-csdn%E5%8D%9A%E5%AE%A2/#åˆå§‹åŒ–scheduler"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"VSYNC-appçš„è¯·æ±‚æµç¨‹ VSYNC-appç”±EventThreadç»´æŠ¤ã€‚VSYNC-appçš„è§¦å‘æœ‰å¤šç§å› ç´ ï¼ŒåŒ…æ‹¬æ–°å±å¹•æŒ‚è½½ã€å®¢æˆ·ç«¯ä¸»åŠ¨è¯·æ±‚ã€EVentThreadçº¿ç¨‹å†…éƒ¨è‡ªå‘ã€‚ ä»¥EventThreadå†…éƒ¨è‡ªå‘ä¸ºä¾‹ï¼š void EventThread::threadMain(std::unique_lock\u003cstd::mutex\u003e\u0026 lock) { DisplayEventConsumers consumers; while (mState != State::Quit) { std::optional\u003cDisplayEventReceiver::Event\u003e event; // Determine next event to dispatch. if (!mPendingEvents.empty()) { event = mPendingEvents.front(); mPendingEvents.pop_front(); if (event-\u003eheader.type == DisplayEventReceiver::DISPLAY_EVENT_HOTPLUG) { if (event-\u003ehotplug.connected \u0026\u0026 !mVSyncState) { mVSyncState.emplace(event-\u003eheader.displayId); } else if (!event-\u003ehotplug.connected \u0026\u0026 mVSyncState \u0026\u0026 mVSyncState-\u003edisplayId == event-\u003eheader.displayId) { mVSyncState.reset(); } } } bool vsyncRequested = false; // Find connections that should consume this event. auto it = mDisplayEventConnections.begin(); while (it != mDisplayEventConnections.end()) { if (const auto connection = it-\u003epromote()) { if (event \u0026\u0026 shouldConsumeEvent(*event, connection)) { consumers.push_back(connection); } vsyncRequested |= connection-\u003evsyncRequest != VSyncRequest::None; ++it; } else { it = mDisplayEventConnections.erase(it); } } if (!consumers.empty()) { dispatchEvent(*event, consumers); consumers.clear(); } if (mVSyncState \u0026\u0026 vsyncRequested) { mState = mVSyncState-\u003esynthetic ? State::SyntheticVSync : State::VSync; } else { ALOGW_IF(!mVSyncState, \"Ignoring VSYNC request while display is disconnected\"); mState = State::Idle; } if (mState == State::VSync) { const auto scheduleResult = mVsyncRegistration.schedule({.workDuration = mWorkDuration.get().count(), .readyDuration = mReadyDuration.count(), .earliestVsync = mLastVsyncCallbackTime.ns()}); LOG_ALWAYS_FATAL_IF(!scheduleResult, \"Error scheduling callback\"); } else { mVsyncRegistration.cancel(); } if (!mPendingEvents.empty()) { continue; } // Wait for event or client registration/request. if (mState == State::Idle) { mCondition.wait(lock); } else { // Generate a fake VSYNC after a long timeout in case the driver stalls. When the // display is off, keep feeding clients at 60 Hz. const std::chrono::nanoseconds timeout = mState == State::SyntheticVSync ? 16ms : 1000ms; if (mCondition.wait_for(lock, timeout) == std::cv_status::timeout) { if (mState == State::VSync) { ALOGW(\"Faking VSYNC due to driver stall for thread %s\", mThreadName); } LOG_FATAL_IF(!mVSyncState); const auto now = systemTime(SYSTEM_TIME_MONOTONIC); const auto deadlineTimestamp = now + timeout.count(); const auto expectedVSyncTime = deadlineTimestamp + timeout.count(); mPendingEvents.push_back(makeVSync(mVSyncState-\u003edisplayId, now, ++mVSyncState-\u003ecount, expectedVSyncTime, deadlineTimestamp)); } } } // cancel any pending vsync event before exiting mVsyncRegistration.cancel(); } è§¦å‘VSYNCè¯·æ±‚çš„æ˜¯ï¼š const auto scheduleResult = mVsyncRegistration.schedule({.workDuration = mWorkDuration.get().count(), .readyDuration = mReadyDuration.count(), .earliestVsync = mLastVsyncCallbackTime.ns()}); LOG_ALWAYS_FATAL_IF(!scheduleResult, â€œError scheduling callbackâ€); platform/frameworks/native/services/surfaceflinger/Scheduler/VSyncDispatchTimerQueue.cpp ScheduleResult VSyncCallbackRegistration::schedule(VSyncDispatch::ScheduleTiming scheduleTiming) { if (!mToken) { return std::nullopt; } return mDispatch-\u003eschedule(*mToken, scheduleTiming); } mDispatchæ˜¯VSyncDispatchTimerQueueï¼Œåœ¨åŒä¸€ä¸ªæ–‡ä»¶é‡Œï¼š platform/frameworks/native/services/surfaceflinger/Scheduler/VSyncDispatchTimerQueue.cpp ScheduleResult VSyncDispatchTimerQueue::schedule(CallbackToken token, ScheduleTiming scheduleTiming) { std::lock_guard lock(mMutex); return scheduleLocked(token, scheduleTiming); } ScheduleResult VSyncDispatchTimerQueue::scheduleLocked(CallbackToken token, ScheduleTiming scheduleTiming) { auto it = mCallbacks.find(token); if (it == mCallbacks.end()) { return {}; } auto\u0026 callback = it-\u003esecond; auto const now = mTimeKeeper-\u003enow(); /* If the timer thread will run soon, we'll apply this work update via the callback * timer recalculation to avoid cancelling a callba","date":"2024-11-06","objectID":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-vsync1-csdn%E5%8D%9A%E5%AE%A2/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"Android 14 - ç»˜åˆ¶ä½“ç³» - VSyncï¼ˆ1ï¼‰-CSDNåšå®¢","uri":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-vsync1-csdn%E5%8D%9A%E5%AE%A2/#vsync-appçš„è¯·æ±‚æµç¨‹"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"VSYNC-appçš„åˆ†å‘è¿‡ç¨‹ åœ¨ä¹‹å‰çš„threadMainæ–¹æ³•ä¸­ï¼Œæœ‰ä»£ç ï¼š if (!mPendingEvents.empty()) { event = mPendingEvents.front(); mPendingEvents.pop_front(); if (event-\u003eheader.type == DisplayEventReceiver::DISPLAY_EVENT_HOTPLUG) { if (event-\u003ehotplug.connected \u0026\u0026 !mVSyncState) { mVSyncState.emplace(event-\u003eheader.displayId); } else if (!event-\u003ehotplug.connected \u0026\u0026 mVSyncState \u0026\u0026 mVSyncState-\u003edisplayId == event-\u003eheader.displayId) { mVSyncState.reset(); } } } ... if (!consumers.empty()) { dispatchEvent(*event, consumers); consumers.clear(); } void EventThread::dispatchEvent(const DisplayEventReceiver::Event\u0026 event, const DisplayEventConsumers\u0026 consumers) { for (const auto\u0026 consumer : consumers) { DisplayEventReceiver::Event copy = event; if (event.header.type == DisplayEventReceiver::DISPLAY_EVENT_VSYNC) { const int64_t frameInterval = mGetVsyncPeriodFunction(consumer-\u003emOwnerUid); copy.vsync.vsyncData.frameInterval = frameInterval; generateFrameTimeline(copy.vsync.vsyncData, frameInterval, copy.header.timestamp, event.vsync.vsyncData.preferredExpectedPresentationTime(), event.vsync.vsyncData.preferredDeadlineTimestamp()); } switch (consumer-\u003epostEvent(copy)) { case NO_ERROR: break; case -EAGAIN: // TODO: Try again if pipe is full. ALOGW(\"Failed dispatching %s for %s\", toString(event).c_str(), toString(*consumer).c_str()); break; default: // Treat EPIPE and other errors as fatal. removeDisplayEventConnectionLocked(consumer); } } } è¿™é‡Œçš„consumerä¸ºEventThreadConnection platform/frameworks/native/services/surfaceflinger/Scheduler/EventThread.cpp status_t EventThreadConnection::postEvent(const DisplayEventReceiver::Event\u0026 event) { constexpr auto toStatus = [](ssize_t size) { return size \u003c 0 ? status_t(size) : status_t(NO_ERROR); }; if (event.header.type == DisplayEventReceiver::DISPLAY_EVENT_FRAME_RATE_OVERRIDE || event.header.type == DisplayEventReceiver::DISPLAY_EVENT_FRAME_RATE_OVERRIDE_FLUSH) { mPendingEvents.emplace_back(event); if (event.header.type == DisplayEventReceiver::DISPLAY_EVENT_FRAME_RATE_OVERRIDE) { return status_t(NO_ERROR); } auto size = DisplayEventReceiver::sendEvents(\u0026mChannel, mPendingEvents.data(), mPendingEvents.size()); mPendingEvents.clear(); return toStatus(size); } auto size = DisplayEventReceiver::sendEvents(\u0026mChannel, \u0026event, 1); return toStatus(size); } DisplayEventReceiver::sendEventsæœ€ç»ˆå‘ç»™å®¢æˆ·ç«¯ã€‚ ssize_t DisplayEventReceiver::sendEvents(gui::BitTube* dataChannel, Event const* events, size_t count) { return gui::BitTube::sendObjects(dataChannel, events, count); } BitTubeé€šè¿‡socketå°†äº‹ä»¶åˆ†å‘åˆ°å®¢æˆ·ç«¯çš„Choreographerã€‚ ","date":"2024-11-06","objectID":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-vsync1-csdn%E5%8D%9A%E5%AE%A2/:3:0","tags":["clippings","è½¬è½½","blog"],"title":"Android 14 - ç»˜åˆ¶ä½“ç³» - VSyncï¼ˆ1ï¼‰-CSDNåšå®¢","uri":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-vsync1-csdn%E5%8D%9A%E5%AE%A2/#vsync-appçš„åˆ†å‘è¿‡ç¨‹"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"VSYNC-sfçš„è¯·æ±‚å’Œåˆ†å‘ VSYNC-sfçš„è§¦å‘ç‚¹åœ¨SurfaceFlinger::initSchedulerè°ƒç”¨MessageQueue::initVsync platform/frameworks/native/services/surfaceflinger/Scheduler/MessageQueue.cpp void MessageQueue::initVsync(std::shared_ptr\u003cscheduler::VSyncDispatch\u003e dispatch, frametimeline::TokenManager\u0026 tokenManager, std::chrono::nanoseconds workDuration) { std::unique_ptr\u003cscheduler::VSyncCallbackRegistration\u003e oldRegistration; { std::lock_guard lock(mVsync.mutex); mVsync.workDuration = workDuration; mVsync.tokenManager = \u0026tokenManager; oldRegistration = onNewVsyncScheduleLocked(std::move(dispatch)); } // See comments in onNewVsyncSchedule. Today, oldRegistration should be // empty, but nothing prevents us from calling initVsync multiple times, so // go ahead and destruct it outside the lock for safety. oldRegistration.reset(); } platform/frameworks/native/services/surfaceflinger/Scheduler/MessageQueue.cpp std::unique_ptr\u003cscheduler::VSyncCallbackRegistration\u003e MessageQueue::onNewVsyncScheduleLocked( std::shared_ptr\u003cscheduler::VSyncDispatch\u003e dispatch) { const bool reschedule = mVsync.registration \u0026\u0026 mVsync.registration-\u003ecancel() == scheduler::CancelResult::Cancelled; auto oldRegistration = std::move(mVsync.registration); mVsync.registration = std::make_unique\u003c scheduler::VSyncCallbackRegistration\u003e(std::move(dispatch), std::bind(\u0026MessageQueue::vsyncCallback, this, std::placeholders::_1, std::placeholders::_2, std::placeholders::_3), \"sf\"); if (reschedule) { mVsync.scheduledFrameTime = mVsync.registration-\u003eschedule({.workDuration = mVsync.workDuration.get().count(), .readyDuration = 0, .earliestVsync = mVsync.lastCallbackTime.ns()}); } return oldRegistration; } å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œå¯¹VSYNCä¿¡å·å‘½åä¸ºâ€œsfâ€ã€‚mVsync.registration-\u003escheduleæ­¤å¤„è°ƒç”¨VSyncçš„ç”Ÿæˆè¿‡ç¨‹ï¼Œä¸å‰é¢çš„VSync-appç›¸åŒã€‚ä½†è¿™é‡Œçš„å›è°ƒå‡½æ•°æ˜¯vsyncCallback platform/frameworks/native/services/surfaceflinger/Scheduler/MessageQueue.cpp void MessageQueue::vsyncCallback(nsecs_t vsyncTime, nsecs_t targetWakeupTime, nsecs_t readyTime) { ATRACE_CALL(); // Trace VSYNC-sf mVsync.value = (mVsync.value + 1) % 2; const auto expectedVsyncTime = TimePoint::fromNs(vsyncTime); { std::lock_guard lock(mVsync.mutex); mVsync.lastCallbackTime = expectedVsyncTime; mVsync.scheduledFrameTime.reset(); } const auto vsyncId = VsyncId{mVsync.tokenManager-\u003egenerateTokenForPredictions( {targetWakeupTime, readyTime, vsyncTime})}; mHandler-\u003edispatchFrame(vsyncId, expectedVsyncTime); } MessageQueueæœ¬èº«æ˜¯ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—çš„å®ç°ç±»ã€‚è¿™é‡Œçœ‹åˆ°æ”¶åˆ°VSyncå›è°ƒåï¼Œé€šè¿‡mHandler-\u003edispatchFrameæŠ›åˆ°é˜Ÿåˆ—é‡Œå»äº†ã€‚æœ€ç»ˆä¼šæ‰§è¡Œ platform/frameworks/native/services/surfaceflinger/Scheduler/MessageQueue.cpp void MessageQueue::Handler::handleMessage(const Message\u0026) { mFramePending.store(false); mQueue.onFrameSignal(mQueue.mCompositor, mVsyncId, mExpectedVsyncTime); } æœ€åå›è°ƒ platform/frameworks/native/services/surfaceflinger/Scheduler/Scheduler.cpp void Scheduler::onFrameSignal(ICompositor\u0026 compositor, VsyncId vsyncId, TimePoint expectedVsyncTime) { ... if (!compositor.commit(pacesetterId, targets)) return; ... const auto resultsPerDisplay = compositor.composite(pacesetterId, targeters); } è¿™é‡Œçš„compositoræ˜¯SurfaceFlingerã€‚æ¥ä¸‹æ¥å°±æ˜¯ç”±SFè¿›è¡Œåˆæˆå·¥ä½œäº†ã€‚ ","date":"2024-11-06","objectID":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-vsync1-csdn%E5%8D%9A%E5%AE%A2/:4:0","tags":["clippings","è½¬è½½","blog"],"title":"Android 14 - ç»˜åˆ¶ä½“ç³» - VSyncï¼ˆ1ï¼‰-CSDNåšå®¢","uri":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-vsync1-csdn%E5%8D%9A%E5%AE%A2/#vsync-sfçš„è¯·æ±‚å’Œåˆ†å‘"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"ä¸€ã€Surfaceä»‹ç» åœ¨Androidç³»ç»Ÿä¸­ï¼ŒSurfaceæ˜¯ä¸€ç§ç”¨äºå›¾å½¢å’Œè§†é¢‘æ¸²æŸ“çš„æŠ½è±¡æ¦‚å¿µï¼Œå®ƒå¯ä»¥ç”¨æ¥å°†åº”ç”¨ç¨‹åºç»˜åˆ¶çš„å›¾å½¢æˆ–è§†é¢‘æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚ä¸€ä¸ªSurfaceä»£è¡¨ä¸€ä¸ªå±å¹•è¡¨é¢ï¼Œå¯ä»¥æ˜¯æ•´ä¸ªå±å¹•æˆ–è€…åº”ç”¨ç¨‹åºUIçš„ä¸€ä¸ªç‹¬ç«‹çª—å£ã€‚ Surfaceé€šè¿‡ä¸€ä¸ªSurfaceHolderå¯¹è±¡æ¥æä¾›è®¿é—®æ¥å£ã€‚SurfaceHolderç®¡ç†äº†Surfaceçš„ç”Ÿå‘½å‘¨æœŸå’Œç»˜ç”»ä¿¡æ¯ï¼Œå¹¶æä¾›äº†é”å®š(SurfaceHolder.lockCanvas())å’Œè§£é”(SurfaceHolder.lockCanvas())å’Œè§£é”(SurfaceHolder.unlockCanvasAndPost())Canvaså¯¹è±¡æ¥å£ï¼Œä½¿å¾—åº”ç”¨ç¨‹åºå¯ä»¥ç›´æ¥åœ¨Surfaceä¸Šè¿›è¡Œç»˜åˆ¶æ“ä½œã€‚ ä¸€ä¸ªSurfaceå¯ä»¥åŒ…å«å¤šä¸ªBufferï¼Œæ¯ä¸ªBufferéƒ½åŒ…å«äº†ä¸€ä¸ªå›¾åƒæˆ–è§†é¢‘çš„å‰¯æœ¬ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥åœ¨ä¸€ä¸ªBufferä¸­æ¸²æŸ“å›¾å½¢æˆ–è§†é¢‘æ•°æ®ï¼Œè€Œä½¿ç”¨å¦ä¸€ä¸ªBufferæ—¶ï¼Œåªéœ€è¦å°†ç»˜å›¾ä¿¡æ¯æäº¤åï¼Œå³å¯ç›´æ¥æ˜¾ç¤ºå¦ä¸€ä¸ªBufferçš„å›¾åƒæˆ–è§†é¢‘å†…å®¹ï¼Œä»è€Œæé«˜äº†æ¸²æŸ“æ•ˆç‡å’Œæ€§èƒ½ã€‚ åœ¨Androidç³»ç»Ÿä¸­ï¼ŒSurfaceè¿˜è¢«å¹¿æ³›ç”¨äºå¤šåª’ä½“ã€æ¸¸æˆå’Œå›¾å½¢æ¸²æŸ“ç­‰åº”ç”¨ç¨‹åºåœºæ™¯ã€‚ä¾‹å¦‚ï¼ŒMediaCodecå’ŒMediaPlayerç±»ä½¿ç”¨Surfaceä½œä¸ºè§†é¢‘è¾“å‡ºçš„ç›®æ ‡ï¼ŒOpenGL ESåº“ä¹Ÿä½¿ç”¨Surfaceä½œä¸ºæ¸²æŸ“ç›®æ ‡ï¼Œè€Œæ¸¸æˆå¼•æ“ä¸­ä¹Ÿå¸¸å¸¸ä¼šä½¿ç”¨Surfaceä½œä¸ºæ¸¸æˆç”»é¢çš„è¾“å‡ºç›®æ ‡ã€‚ ","date":"2024-11-06","objectID":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","blog","è½¬è½½"],"title":"Android Surface-CSDNåšå®¢","uri":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/#ä¸€surfaceä»‹ç»"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"surfaceå’Œsurfaceflingerä¹‹é—´çš„å…³ç³» ä¸€ä¸ªsurfaceä¸surfaceflingerä¸­ä¸€ä¸ªlayerä¸€ä¸€å¯¹åº”ã€‚layerä¸­æœ‰bufferqueueç”¨äºæ¥æ”¶surfaceé€šè¿‡producerå‘è¿‡æ¥çš„å›¾å½¢æ•°æ®ã€‚ ","date":"2024-11-06","objectID":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","blog","è½¬è½½"],"title":"Android Surface-CSDNåšå®¢","uri":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/#surfaceå’Œsurfaceflingerä¹‹é—´çš„å…³ç³»"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"surfaceçš„ç»˜åˆ¶æµç¨‹ surfaceçš„ç»˜åˆ¶æµç¨‹åˆ†åˆ«LockCanvas-\u003edrawBitmap-\u003eUnlockCanvasAndPostå‡ ä¸ªé˜¶æ®µï¼Œæœ€åé€šçŸ¥SurfaceFlingerè¿›è¡Œåˆæˆï¼Œæ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š ","date":"2024-11-06","objectID":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/:1:2","tags":["clippings","blog","è½¬è½½"],"title":"Android Surface-CSDNåšå®¢","uri":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/#surfaceçš„ç»˜åˆ¶æµç¨‹"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"ä¸‰ã€Surfaceç›¸å…³ç±»å’Œæ¥å£ ","date":"2024-11-06","objectID":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/:2:0","tags":["clippings","blog","è½¬è½½"],"title":"Android Surface-CSDNåšå®¢","uri":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/#ä¸‰surfaceç›¸å…³ç±»å’Œæ¥å£"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"JAVAç±» Surface Surfaceæ˜¯Androidä¸­ç”¨äºè¡¨ç¤ºä¸€ä¸ªå›¾åƒç¼“å†²åŒºçš„ç±»ï¼ŒSurfaceåŒ…æ‹¬JAVAéƒ¨åˆ†ï¼ŒJNIå’ŒC++éƒ¨åˆ†ã€‚ Surfaceä»£ç ä½äºï¼š frameworks/base/core/java/android/view/Surface.java Surfaceçš„å®šä¹‰ï¼š public class Surface implements Parcelable {} SurfaceControl SurfaceControlæ˜¯ä¸€ä¸ªç”¨äºåˆ›å»ºå’Œç®¡ç†Surfaceçš„ç±»ï¼Œå…¶ä¸­çš„Surfaceå¯¹è±¡å°±æ˜¯ä¸€ä¸ªç”¨äºå›¾åƒå±•ç¤ºçš„æ‰¿è½½å™¨ã€‚è€ŒSurfaceControlå¯¹è±¡ï¼Œåˆ™æ˜¯ç”¨äºå¯¹Surfaceå¯¹è±¡è¿›è¡Œæ“ä½œçš„æ§åˆ¶å™¨ã€‚ä½¿ç”¨SurfaceControlï¼Œåº”ç”¨ç¨‹åºå¯ä»¥æ ¹æ®éœ€è¦åˆ›å»ºæ–°çš„Surfaceï¼Œæˆ–å°†ç°æœ‰çš„Surfaceä¸å½“å‰ä¼šè¯è¿›è¡Œå…³è”ï¼Œé€šè¿‡SurfaceControlå¯ä»¥å¯¹Surfaceå±æ€§è¿›è¡Œè®¾ç½®ï¼Œä¾‹å¦‚å¯¹Surfaceè¿›è¡Œè£å‰ªã€è®¾ç½®Surfaceä½ç½®å’Œå¤§å°ã€è®¾ç½®Surfaceçš„é€æ˜åº¦ç­‰ã€‚ SurfaceControlé€šè¿‡SurfaceSessionæ¥å’ŒSurfaceFlingerè¿›è¡Œäº¤äº’ã€å®Œæˆå¯¹Surfaceçš„åˆ›å»ºã€è®¾ç½®å’Œæ§åˆ¶ç­‰æ“ä½œï¼ŒSurfaceControlåŒ…æ‹¬JAVAéƒ¨åˆ†ï¼ŒJNIå’ŒC++éƒ¨åˆ†ã€‚ SurfaceControlä»£ç ä½äºï¼š frameworks/base/core/java/android/view/SurfaceControl.java SurfaceControlçš„å®šä¹‰ï¼š public final class SurfaceControl implements Parcelable {public static class Builder {}} SurfaceSession SurfaceSessionæ˜¯Androidç³»ç»Ÿä¸­ä¸å›¾å½¢è¡¨é¢ç›¸å…³çš„ä¸€ä¸ªå…³é”®ç±»ï¼Œå®ƒæä¾›äº†ä¸SurfaceFlingeræœåŠ¡é€šä¿¡ä»¥åˆ›å»ºå’Œç®¡ç†å›¾å½¢è¡¨é¢è¿æ¥çš„APIï¼ŒSurfaceSessionçš„ä¸»è¦ä½œç”¨åŒ…æ‹¬ï¼š åˆ›å»ºå’Œç®¡ç†å›¾å½¢è¡¨é¢è¿æ¥ï¼šSurfaceSessionå……å½“äº†åº”ç”¨ç¨‹åºå’Œç³»ç»Ÿçº§SurfaceFlingeræœåŠ¡ä¹‹é—´çš„ä¸­ä»‹ï¼Œé€šè¿‡IPCæœºåˆ¶ä¸SurfaceFlingeré€šä¿¡ï¼Œåˆ›å»ºå’Œç®¡ç†å›¾å½¢è¡¨é¢è¿æ¥ã€‚ åˆ†é…å’Œç®¡ç†è¡¨é¢æ ‡è¯†ç¬¦ï¼šå›¾å½¢è¡¨é¢åœ¨Androidç³»ç»Ÿä¸­æ˜¯ç”±å”¯ä¸€çš„æ ‡è¯†ç¬¦æ¥è¿›è¡Œè¯†åˆ«çš„å’Œç®¡ç†çš„ï¼ŒSurfaceSessionç±»ä¼šåˆ†é…å’Œç®¡ç†è¿™äº›æ ‡è¯†ç¬¦ï¼Œé¿å…è¡¨é¢ä¹‹é—´å‡ºç°å†²çªå’Œé‡å¤é—®é¢˜ ã€‚åŒæ—¶ï¼ŒSurfaceSessionè¿˜ä¼šå°†æ¯ä¸ªè¡¨é¢ä¸å…¶æ‰€å±çš„è¿›ç¨‹å…³è”èµ·æ¥ï¼Œä»¥ç¡®ä¿å®‰å…¨å’Œå¯é çš„è¡¨é¢äº¤äº’ã€‚ æä¾›ä¸è¡¨é¢ç›¸å…³çš„APIæ¥å£ï¼šSurfaceSessionç±»æä¾›äº†ä¸€ç³»åˆ—ä¸è¡¨é¢ç›¸å…³çš„APIæ¥å£ï¼ŒåŒ…æ‹¬åˆ›å»ºå’Œè®¾ç½®è¡¨é¢å±æ€§ï¼Œé€šè¿‡BufferQueueå’ŒIGraphicBufferProducerè¿›è¡Œè¡¨é¢ç¼“å†²åŒºç®¡ç†å’Œäº¤äº’ç­‰ã€‚è¿™äº›APIæ¥å£ä¸ºå¼€å‘äººå‘˜æä¾›äº†æ–¹ä¾¿çš„æ–¹æ³•æ¥åˆ›å»ºå’Œç®¡ç†è¡¨é¢ï¼ŒåŒæ—¶å®ç°äº†å†…éƒ¨å’Œå¤–éƒ¨ä¹‹é—´çš„éš”ç¦»ï¼Œç¡®ä¿äº†ç³»ç»Ÿçš„å®‰å…¨å’Œç¨³å®šæ€§ã€‚ SurfaceSessionä»£ç ä½äºï¼š frameworks/base/core/java/android/view/SurfaceSession.java SurfaceSessionçš„å®šä¹‰ï¼š public final class SurfaceSession {} ","date":"2024-11-06","objectID":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/:2:1","tags":["clippings","blog","è½¬è½½"],"title":"Android Surface-CSDNåšå®¢","uri":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/#javaç±»"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"JAVAç±» Surface Surfaceæ˜¯Androidä¸­ç”¨äºè¡¨ç¤ºä¸€ä¸ªå›¾åƒç¼“å†²åŒºçš„ç±»ï¼ŒSurfaceåŒ…æ‹¬JAVAéƒ¨åˆ†ï¼ŒJNIå’ŒC++éƒ¨åˆ†ã€‚ Surfaceä»£ç ä½äºï¼š frameworks/base/core/java/android/view/Surface.java Surfaceçš„å®šä¹‰ï¼š public class Surface implements Parcelable {} SurfaceControl SurfaceControlæ˜¯ä¸€ä¸ªç”¨äºåˆ›å»ºå’Œç®¡ç†Surfaceçš„ç±»ï¼Œå…¶ä¸­çš„Surfaceå¯¹è±¡å°±æ˜¯ä¸€ä¸ªç”¨äºå›¾åƒå±•ç¤ºçš„æ‰¿è½½å™¨ã€‚è€ŒSurfaceControlå¯¹è±¡ï¼Œåˆ™æ˜¯ç”¨äºå¯¹Surfaceå¯¹è±¡è¿›è¡Œæ“ä½œçš„æ§åˆ¶å™¨ã€‚ä½¿ç”¨SurfaceControlï¼Œåº”ç”¨ç¨‹åºå¯ä»¥æ ¹æ®éœ€è¦åˆ›å»ºæ–°çš„Surfaceï¼Œæˆ–å°†ç°æœ‰çš„Surfaceä¸å½“å‰ä¼šè¯è¿›è¡Œå…³è”ï¼Œé€šè¿‡SurfaceControlå¯ä»¥å¯¹Surfaceå±æ€§è¿›è¡Œè®¾ç½®ï¼Œä¾‹å¦‚å¯¹Surfaceè¿›è¡Œè£å‰ªã€è®¾ç½®Surfaceä½ç½®å’Œå¤§å°ã€è®¾ç½®Surfaceçš„é€æ˜åº¦ç­‰ã€‚ SurfaceControlé€šè¿‡SurfaceSessionæ¥å’ŒSurfaceFlingerè¿›è¡Œäº¤äº’ã€å®Œæˆå¯¹Surfaceçš„åˆ›å»ºã€è®¾ç½®å’Œæ§åˆ¶ç­‰æ“ä½œï¼ŒSurfaceControlåŒ…æ‹¬JAVAéƒ¨åˆ†ï¼ŒJNIå’ŒC++éƒ¨åˆ†ã€‚ SurfaceControlä»£ç ä½äºï¼š frameworks/base/core/java/android/view/SurfaceControl.java SurfaceControlçš„å®šä¹‰ï¼š public final class SurfaceControl implements Parcelable {public static class Builder {}} SurfaceSession SurfaceSessionæ˜¯Androidç³»ç»Ÿä¸­ä¸å›¾å½¢è¡¨é¢ç›¸å…³çš„ä¸€ä¸ªå…³é”®ç±»ï¼Œå®ƒæä¾›äº†ä¸SurfaceFlingeræœåŠ¡é€šä¿¡ä»¥åˆ›å»ºå’Œç®¡ç†å›¾å½¢è¡¨é¢è¿æ¥çš„APIï¼ŒSurfaceSessionçš„ä¸»è¦ä½œç”¨åŒ…æ‹¬ï¼š åˆ›å»ºå’Œç®¡ç†å›¾å½¢è¡¨é¢è¿æ¥ï¼šSurfaceSessionå……å½“äº†åº”ç”¨ç¨‹åºå’Œç³»ç»Ÿçº§SurfaceFlingeræœåŠ¡ä¹‹é—´çš„ä¸­ä»‹ï¼Œé€šè¿‡IPCæœºåˆ¶ä¸SurfaceFlingeré€šä¿¡ï¼Œåˆ›å»ºå’Œç®¡ç†å›¾å½¢è¡¨é¢è¿æ¥ã€‚ åˆ†é…å’Œç®¡ç†è¡¨é¢æ ‡è¯†ç¬¦ï¼šå›¾å½¢è¡¨é¢åœ¨Androidç³»ç»Ÿä¸­æ˜¯ç”±å”¯ä¸€çš„æ ‡è¯†ç¬¦æ¥è¿›è¡Œè¯†åˆ«çš„å’Œç®¡ç†çš„ï¼ŒSurfaceSessionç±»ä¼šåˆ†é…å’Œç®¡ç†è¿™äº›æ ‡è¯†ç¬¦ï¼Œé¿å…è¡¨é¢ä¹‹é—´å‡ºç°å†²çªå’Œé‡å¤é—®é¢˜ ã€‚åŒæ—¶ï¼ŒSurfaceSessionè¿˜ä¼šå°†æ¯ä¸ªè¡¨é¢ä¸å…¶æ‰€å±çš„è¿›ç¨‹å…³è”èµ·æ¥ï¼Œä»¥ç¡®ä¿å®‰å…¨å’Œå¯é çš„è¡¨é¢äº¤äº’ã€‚ æä¾›ä¸è¡¨é¢ç›¸å…³çš„APIæ¥å£ï¼šSurfaceSessionç±»æä¾›äº†ä¸€ç³»åˆ—ä¸è¡¨é¢ç›¸å…³çš„APIæ¥å£ï¼ŒåŒ…æ‹¬åˆ›å»ºå’Œè®¾ç½®è¡¨é¢å±æ€§ï¼Œé€šè¿‡BufferQueueå’ŒIGraphicBufferProducerè¿›è¡Œè¡¨é¢ç¼“å†²åŒºç®¡ç†å’Œäº¤äº’ç­‰ã€‚è¿™äº›APIæ¥å£ä¸ºå¼€å‘äººå‘˜æä¾›äº†æ–¹ä¾¿çš„æ–¹æ³•æ¥åˆ›å»ºå’Œç®¡ç†è¡¨é¢ï¼ŒåŒæ—¶å®ç°äº†å†…éƒ¨å’Œå¤–éƒ¨ä¹‹é—´çš„éš”ç¦»ï¼Œç¡®ä¿äº†ç³»ç»Ÿçš„å®‰å…¨å’Œç¨³å®šæ€§ã€‚ SurfaceSessionä»£ç ä½äºï¼š frameworks/base/core/java/android/view/SurfaceSession.java SurfaceSessionçš„å®šä¹‰ï¼š public final class SurfaceSession {} ","date":"2024-11-06","objectID":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/:2:1","tags":["clippings","blog","è½¬è½½"],"title":"Android Surface-CSDNåšå®¢","uri":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/#surface"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"JAVAç±» Surface Surfaceæ˜¯Androidä¸­ç”¨äºè¡¨ç¤ºä¸€ä¸ªå›¾åƒç¼“å†²åŒºçš„ç±»ï¼ŒSurfaceåŒ…æ‹¬JAVAéƒ¨åˆ†ï¼ŒJNIå’ŒC++éƒ¨åˆ†ã€‚ Surfaceä»£ç ä½äºï¼š frameworks/base/core/java/android/view/Surface.java Surfaceçš„å®šä¹‰ï¼š public class Surface implements Parcelable {} SurfaceControl SurfaceControlæ˜¯ä¸€ä¸ªç”¨äºåˆ›å»ºå’Œç®¡ç†Surfaceçš„ç±»ï¼Œå…¶ä¸­çš„Surfaceå¯¹è±¡å°±æ˜¯ä¸€ä¸ªç”¨äºå›¾åƒå±•ç¤ºçš„æ‰¿è½½å™¨ã€‚è€ŒSurfaceControlå¯¹è±¡ï¼Œåˆ™æ˜¯ç”¨äºå¯¹Surfaceå¯¹è±¡è¿›è¡Œæ“ä½œçš„æ§åˆ¶å™¨ã€‚ä½¿ç”¨SurfaceControlï¼Œåº”ç”¨ç¨‹åºå¯ä»¥æ ¹æ®éœ€è¦åˆ›å»ºæ–°çš„Surfaceï¼Œæˆ–å°†ç°æœ‰çš„Surfaceä¸å½“å‰ä¼šè¯è¿›è¡Œå…³è”ï¼Œé€šè¿‡SurfaceControlå¯ä»¥å¯¹Surfaceå±æ€§è¿›è¡Œè®¾ç½®ï¼Œä¾‹å¦‚å¯¹Surfaceè¿›è¡Œè£å‰ªã€è®¾ç½®Surfaceä½ç½®å’Œå¤§å°ã€è®¾ç½®Surfaceçš„é€æ˜åº¦ç­‰ã€‚ SurfaceControlé€šè¿‡SurfaceSessionæ¥å’ŒSurfaceFlingerè¿›è¡Œäº¤äº’ã€å®Œæˆå¯¹Surfaceçš„åˆ›å»ºã€è®¾ç½®å’Œæ§åˆ¶ç­‰æ“ä½œï¼ŒSurfaceControlåŒ…æ‹¬JAVAéƒ¨åˆ†ï¼ŒJNIå’ŒC++éƒ¨åˆ†ã€‚ SurfaceControlä»£ç ä½äºï¼š frameworks/base/core/java/android/view/SurfaceControl.java SurfaceControlçš„å®šä¹‰ï¼š public final class SurfaceControl implements Parcelable {public static class Builder {}} SurfaceSession SurfaceSessionæ˜¯Androidç³»ç»Ÿä¸­ä¸å›¾å½¢è¡¨é¢ç›¸å…³çš„ä¸€ä¸ªå…³é”®ç±»ï¼Œå®ƒæä¾›äº†ä¸SurfaceFlingeræœåŠ¡é€šä¿¡ä»¥åˆ›å»ºå’Œç®¡ç†å›¾å½¢è¡¨é¢è¿æ¥çš„APIï¼ŒSurfaceSessionçš„ä¸»è¦ä½œç”¨åŒ…æ‹¬ï¼š åˆ›å»ºå’Œç®¡ç†å›¾å½¢è¡¨é¢è¿æ¥ï¼šSurfaceSessionå……å½“äº†åº”ç”¨ç¨‹åºå’Œç³»ç»Ÿçº§SurfaceFlingeræœåŠ¡ä¹‹é—´çš„ä¸­ä»‹ï¼Œé€šè¿‡IPCæœºåˆ¶ä¸SurfaceFlingeré€šä¿¡ï¼Œåˆ›å»ºå’Œç®¡ç†å›¾å½¢è¡¨é¢è¿æ¥ã€‚ åˆ†é…å’Œç®¡ç†è¡¨é¢æ ‡è¯†ç¬¦ï¼šå›¾å½¢è¡¨é¢åœ¨Androidç³»ç»Ÿä¸­æ˜¯ç”±å”¯ä¸€çš„æ ‡è¯†ç¬¦æ¥è¿›è¡Œè¯†åˆ«çš„å’Œç®¡ç†çš„ï¼ŒSurfaceSessionç±»ä¼šåˆ†é…å’Œç®¡ç†è¿™äº›æ ‡è¯†ç¬¦ï¼Œé¿å…è¡¨é¢ä¹‹é—´å‡ºç°å†²çªå’Œé‡å¤é—®é¢˜ ã€‚åŒæ—¶ï¼ŒSurfaceSessionè¿˜ä¼šå°†æ¯ä¸ªè¡¨é¢ä¸å…¶æ‰€å±çš„è¿›ç¨‹å…³è”èµ·æ¥ï¼Œä»¥ç¡®ä¿å®‰å…¨å’Œå¯é çš„è¡¨é¢äº¤äº’ã€‚ æä¾›ä¸è¡¨é¢ç›¸å…³çš„APIæ¥å£ï¼šSurfaceSessionç±»æä¾›äº†ä¸€ç³»åˆ—ä¸è¡¨é¢ç›¸å…³çš„APIæ¥å£ï¼ŒåŒ…æ‹¬åˆ›å»ºå’Œè®¾ç½®è¡¨é¢å±æ€§ï¼Œé€šè¿‡BufferQueueå’ŒIGraphicBufferProducerè¿›è¡Œè¡¨é¢ç¼“å†²åŒºç®¡ç†å’Œäº¤äº’ç­‰ã€‚è¿™äº›APIæ¥å£ä¸ºå¼€å‘äººå‘˜æä¾›äº†æ–¹ä¾¿çš„æ–¹æ³•æ¥åˆ›å»ºå’Œç®¡ç†è¡¨é¢ï¼ŒåŒæ—¶å®ç°äº†å†…éƒ¨å’Œå¤–éƒ¨ä¹‹é—´çš„éš”ç¦»ï¼Œç¡®ä¿äº†ç³»ç»Ÿçš„å®‰å…¨å’Œç¨³å®šæ€§ã€‚ SurfaceSessionä»£ç ä½äºï¼š frameworks/base/core/java/android/view/SurfaceSession.java SurfaceSessionçš„å®šä¹‰ï¼š public final class SurfaceSession {} ","date":"2024-11-06","objectID":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/:2:1","tags":["clippings","blog","è½¬è½½"],"title":"Android Surface-CSDNåšå®¢","uri":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/#surfacecontrol"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"JAVAç±» Surface Surfaceæ˜¯Androidä¸­ç”¨äºè¡¨ç¤ºä¸€ä¸ªå›¾åƒç¼“å†²åŒºçš„ç±»ï¼ŒSurfaceåŒ…æ‹¬JAVAéƒ¨åˆ†ï¼ŒJNIå’ŒC++éƒ¨åˆ†ã€‚ Surfaceä»£ç ä½äºï¼š frameworks/base/core/java/android/view/Surface.java Surfaceçš„å®šä¹‰ï¼š public class Surface implements Parcelable {} SurfaceControl SurfaceControlæ˜¯ä¸€ä¸ªç”¨äºåˆ›å»ºå’Œç®¡ç†Surfaceçš„ç±»ï¼Œå…¶ä¸­çš„Surfaceå¯¹è±¡å°±æ˜¯ä¸€ä¸ªç”¨äºå›¾åƒå±•ç¤ºçš„æ‰¿è½½å™¨ã€‚è€ŒSurfaceControlå¯¹è±¡ï¼Œåˆ™æ˜¯ç”¨äºå¯¹Surfaceå¯¹è±¡è¿›è¡Œæ“ä½œçš„æ§åˆ¶å™¨ã€‚ä½¿ç”¨SurfaceControlï¼Œåº”ç”¨ç¨‹åºå¯ä»¥æ ¹æ®éœ€è¦åˆ›å»ºæ–°çš„Surfaceï¼Œæˆ–å°†ç°æœ‰çš„Surfaceä¸å½“å‰ä¼šè¯è¿›è¡Œå…³è”ï¼Œé€šè¿‡SurfaceControlå¯ä»¥å¯¹Surfaceå±æ€§è¿›è¡Œè®¾ç½®ï¼Œä¾‹å¦‚å¯¹Surfaceè¿›è¡Œè£å‰ªã€è®¾ç½®Surfaceä½ç½®å’Œå¤§å°ã€è®¾ç½®Surfaceçš„é€æ˜åº¦ç­‰ã€‚ SurfaceControlé€šè¿‡SurfaceSessionæ¥å’ŒSurfaceFlingerè¿›è¡Œäº¤äº’ã€å®Œæˆå¯¹Surfaceçš„åˆ›å»ºã€è®¾ç½®å’Œæ§åˆ¶ç­‰æ“ä½œï¼ŒSurfaceControlåŒ…æ‹¬JAVAéƒ¨åˆ†ï¼ŒJNIå’ŒC++éƒ¨åˆ†ã€‚ SurfaceControlä»£ç ä½äºï¼š frameworks/base/core/java/android/view/SurfaceControl.java SurfaceControlçš„å®šä¹‰ï¼š public final class SurfaceControl implements Parcelable {public static class Builder {}} SurfaceSession SurfaceSessionæ˜¯Androidç³»ç»Ÿä¸­ä¸å›¾å½¢è¡¨é¢ç›¸å…³çš„ä¸€ä¸ªå…³é”®ç±»ï¼Œå®ƒæä¾›äº†ä¸SurfaceFlingeræœåŠ¡é€šä¿¡ä»¥åˆ›å»ºå’Œç®¡ç†å›¾å½¢è¡¨é¢è¿æ¥çš„APIï¼ŒSurfaceSessionçš„ä¸»è¦ä½œç”¨åŒ…æ‹¬ï¼š åˆ›å»ºå’Œç®¡ç†å›¾å½¢è¡¨é¢è¿æ¥ï¼šSurfaceSessionå……å½“äº†åº”ç”¨ç¨‹åºå’Œç³»ç»Ÿçº§SurfaceFlingeræœåŠ¡ä¹‹é—´çš„ä¸­ä»‹ï¼Œé€šè¿‡IPCæœºåˆ¶ä¸SurfaceFlingeré€šä¿¡ï¼Œåˆ›å»ºå’Œç®¡ç†å›¾å½¢è¡¨é¢è¿æ¥ã€‚ åˆ†é…å’Œç®¡ç†è¡¨é¢æ ‡è¯†ç¬¦ï¼šå›¾å½¢è¡¨é¢åœ¨Androidç³»ç»Ÿä¸­æ˜¯ç”±å”¯ä¸€çš„æ ‡è¯†ç¬¦æ¥è¿›è¡Œè¯†åˆ«çš„å’Œç®¡ç†çš„ï¼ŒSurfaceSessionç±»ä¼šåˆ†é…å’Œç®¡ç†è¿™äº›æ ‡è¯†ç¬¦ï¼Œé¿å…è¡¨é¢ä¹‹é—´å‡ºç°å†²çªå’Œé‡å¤é—®é¢˜ ã€‚åŒæ—¶ï¼ŒSurfaceSessionè¿˜ä¼šå°†æ¯ä¸ªè¡¨é¢ä¸å…¶æ‰€å±çš„è¿›ç¨‹å…³è”èµ·æ¥ï¼Œä»¥ç¡®ä¿å®‰å…¨å’Œå¯é çš„è¡¨é¢äº¤äº’ã€‚ æä¾›ä¸è¡¨é¢ç›¸å…³çš„APIæ¥å£ï¼šSurfaceSessionç±»æä¾›äº†ä¸€ç³»åˆ—ä¸è¡¨é¢ç›¸å…³çš„APIæ¥å£ï¼ŒåŒ…æ‹¬åˆ›å»ºå’Œè®¾ç½®è¡¨é¢å±æ€§ï¼Œé€šè¿‡BufferQueueå’ŒIGraphicBufferProducerè¿›è¡Œè¡¨é¢ç¼“å†²åŒºç®¡ç†å’Œäº¤äº’ç­‰ã€‚è¿™äº›APIæ¥å£ä¸ºå¼€å‘äººå‘˜æä¾›äº†æ–¹ä¾¿çš„æ–¹æ³•æ¥åˆ›å»ºå’Œç®¡ç†è¡¨é¢ï¼ŒåŒæ—¶å®ç°äº†å†…éƒ¨å’Œå¤–éƒ¨ä¹‹é—´çš„éš”ç¦»ï¼Œç¡®ä¿äº†ç³»ç»Ÿçš„å®‰å…¨å’Œç¨³å®šæ€§ã€‚ SurfaceSessionä»£ç ä½äºï¼š frameworks/base/core/java/android/view/SurfaceSession.java SurfaceSessionçš„å®šä¹‰ï¼š public final class SurfaceSession {} ","date":"2024-11-06","objectID":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/:2:1","tags":["clippings","blog","è½¬è½½"],"title":"Android Surface-CSDNåšå®¢","uri":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/#surfacesession"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"C++ç±» Surface Surfaceæ˜¯Androidä¸­ç”¨äºè¡¨ç¤ºä¸€ä¸ªå›¾åƒç¼“å†²åŒºçš„ç±»ï¼ŒSurfaceåŒ…æ‹¬JAVAéƒ¨åˆ†ï¼ŒJNIå’ŒC++éƒ¨åˆ†ã€‚ Surfaceä»£ç ä½äºï¼š frameworks/base/core/jni/android_view_Surface.cpp framework/native/libs/gui/Surface.cpp frameworks/native/include/gui/Surface.h Surfaceçš„å®šä¹‰ï¼š class Surface : public ANativeObjectBase\u003cANativeWindow, Surface, RefBase\u003e {} Surfaceæ–¹æ³•ï¼š int connect(int api, const sp\u003cIProducerListener\u003e\u0026 listener)ï¼šè¿æ¥ int Surface::disconnect(int api, IGraphicBufferProducer::DisconnectMode mode) ï¼šæ–­å¼€ int queueBuffers(const std::vector\u003cBatchQueuedBuffer\u003e\u0026 buffers)ï¼šç”Ÿäº§è€…å¡«å……ç¼“å­˜åŒºå¹¶è¿”å›ç»™é˜Ÿåˆ— int dequeueBuffers(std::vector\u003cBatchBuffer\u003e* buffers)ï¼šç”Ÿäº§è€…è¯·æ±‚ä¸€å—ç©ºé—²çš„ç¼“å­˜åŒº int cancelBuffers(const std::vector\u003cBatchBuffer\u003e\u0026 buffers)ï¼šå…³é—­ç¼“å†²åŒº SurfaceControl SurfaceControlæ˜¯ä¸€ä¸ªç”¨äºåˆ›å»ºå’Œç®¡ç†Surfaceçš„ç±»ï¼Œå…¶ä¸­çš„Surfaceå¯¹è±¡å°±æ˜¯ä¸€ä¸ªç”¨äºå›¾åƒå±•ç¤ºçš„æ‰¿è½½å™¨ã€‚è€ŒSurfaceControlå¯¹è±¡ï¼Œåˆ™æ˜¯ç”¨äºå¯¹Surfaceå¯¹è±¡è¿›è¡Œæ“ä½œçš„æ§åˆ¶å™¨ã€‚ä½¿ç”¨SurfaceControlï¼Œåº”ç”¨ç¨‹åºå¯ä»¥æ ¹æ®éœ€è¦åˆ›å»ºæ–°çš„Surfaceï¼Œæˆ–å°†ç°æœ‰çš„Surfaceä¸å½“å‰ä¼šè¯è¿›è¡Œå…³è”ï¼Œé€šè¿‡SurfaceControlå¯ä»¥å¯¹Surfaceå±æ€§è¿›è¡Œè®¾ç½®ï¼Œä¾‹å¦‚å¯¹Surfaceè¿›è¡Œè£å‰ªã€è®¾ç½®Surfaceä½ç½®å’Œå¤§å°ã€è®¾ç½®Surfaceçš„é€æ˜åº¦ç­‰ã€‚ SurfaceControlé€šè¿‡SurfaceSessionæ¥å’ŒSurfaceFlingerè¿›è¡Œäº¤äº’ã€å®Œæˆå¯¹Surfaceçš„åˆ›å»ºã€è®¾ç½®å’Œæ§åˆ¶ç­‰æ“ä½œï¼ŒSurfaceControlåŒ…æ‹¬JAVAéƒ¨åˆ†ï¼ŒJNIå’ŒC++éƒ¨åˆ†ã€‚ SurfaceControlä»£ç ä½äºï¼š frameworks/base/core/jni/android_view_SurfaceControl.cpp frameworks/native/libs/gui/SurfaceControl.cpp frameworks/native/include/gui/SurfaceControl.h SurfaceControlçš„å®šä¹‰ï¼š public final class SurfaceControl implements Parcelable { } class SurfaceControl : public RefBase{ } ComposerService This holds our connection to the composer service (i.e. SurfaceFlinger). ComposerServiceä»£ç ä½äºï¼š frameworks/native/libs/gui/include/private/gui/ComposerService.h ComposerServiceçš„å®šä¹‰ï¼š class ComposerService : public Singleton\u003cComposerService\u003e {} ComposerServiceAIDL This holds our connection to the composer service (i.e. SurfaceFlinger). ComposerServiceAIDL ä»£ç ä½äºï¼š frameworks/native/libs/gui/include/private/gui/ComposerServiceAIDL .h ComposerServiceAIDL çš„å®šä¹‰ï¼š class ComposerServiceAIDL : public Singleton\u003cComposerServiceAIDL\u003e {} ","date":"2024-11-06","objectID":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/:2:2","tags":["clippings","blog","è½¬è½½"],"title":"Android Surface-CSDNåšå®¢","uri":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/#cç±»"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"C++ç±» Surface Surfaceæ˜¯Androidä¸­ç”¨äºè¡¨ç¤ºä¸€ä¸ªå›¾åƒç¼“å†²åŒºçš„ç±»ï¼ŒSurfaceåŒ…æ‹¬JAVAéƒ¨åˆ†ï¼ŒJNIå’ŒC++éƒ¨åˆ†ã€‚ Surfaceä»£ç ä½äºï¼š frameworks/base/core/jni/android_view_Surface.cpp framework/native/libs/gui/Surface.cpp frameworks/native/include/gui/Surface.h Surfaceçš„å®šä¹‰ï¼š class Surface : public ANativeObjectBase {} Surfaceæ–¹æ³•ï¼š int connect(int api, const sp\u0026 listener)ï¼šè¿æ¥ int Surface::disconnect(int api, IGraphicBufferProducer::DisconnectMode mode) ï¼šæ–­å¼€ int queueBuffers(const std::vector\u0026 buffers)ï¼šç”Ÿäº§è€…å¡«å……ç¼“å­˜åŒºå¹¶è¿”å›ç»™é˜Ÿåˆ— int dequeueBuffers(std::vector* buffers)ï¼šç”Ÿäº§è€…è¯·æ±‚ä¸€å—ç©ºé—²çš„ç¼“å­˜åŒº int cancelBuffers(const std::vector\u0026 buffers)ï¼šå…³é—­ç¼“å†²åŒº SurfaceControl SurfaceControlæ˜¯ä¸€ä¸ªç”¨äºåˆ›å»ºå’Œç®¡ç†Surfaceçš„ç±»ï¼Œå…¶ä¸­çš„Surfaceå¯¹è±¡å°±æ˜¯ä¸€ä¸ªç”¨äºå›¾åƒå±•ç¤ºçš„æ‰¿è½½å™¨ã€‚è€ŒSurfaceControlå¯¹è±¡ï¼Œåˆ™æ˜¯ç”¨äºå¯¹Surfaceå¯¹è±¡è¿›è¡Œæ“ä½œçš„æ§åˆ¶å™¨ã€‚ä½¿ç”¨SurfaceControlï¼Œåº”ç”¨ç¨‹åºå¯ä»¥æ ¹æ®éœ€è¦åˆ›å»ºæ–°çš„Surfaceï¼Œæˆ–å°†ç°æœ‰çš„Surfaceä¸å½“å‰ä¼šè¯è¿›è¡Œå…³è”ï¼Œé€šè¿‡SurfaceControlå¯ä»¥å¯¹Surfaceå±æ€§è¿›è¡Œè®¾ç½®ï¼Œä¾‹å¦‚å¯¹Surfaceè¿›è¡Œè£å‰ªã€è®¾ç½®Surfaceä½ç½®å’Œå¤§å°ã€è®¾ç½®Surfaceçš„é€æ˜åº¦ç­‰ã€‚ SurfaceControlé€šè¿‡SurfaceSessionæ¥å’ŒSurfaceFlingerè¿›è¡Œäº¤äº’ã€å®Œæˆå¯¹Surfaceçš„åˆ›å»ºã€è®¾ç½®å’Œæ§åˆ¶ç­‰æ“ä½œï¼ŒSurfaceControlåŒ…æ‹¬JAVAéƒ¨åˆ†ï¼ŒJNIå’ŒC++éƒ¨åˆ†ã€‚ SurfaceControlä»£ç ä½äºï¼š frameworks/base/core/jni/android_view_SurfaceControl.cpp frameworks/native/libs/gui/SurfaceControl.cpp frameworks/native/include/gui/SurfaceControl.h SurfaceControlçš„å®šä¹‰ï¼š public final class SurfaceControl implements Parcelable { } class SurfaceControl : public RefBase{ } ComposerService This holds our connection to the composer service (i.e. SurfaceFlinger). ComposerServiceä»£ç ä½äºï¼š frameworks/native/libs/gui/include/private/gui/ComposerService.h ComposerServiceçš„å®šä¹‰ï¼š class ComposerService : public Singleton {} ComposerServiceAIDL This holds our connection to the composer service (i.e. SurfaceFlinger). ComposerServiceAIDL ä»£ç ä½äºï¼š frameworks/native/libs/gui/include/private/gui/ComposerServiceAIDL .h ComposerServiceAIDL çš„å®šä¹‰ï¼š class ComposerServiceAIDL : public Singleton {} ","date":"2024-11-06","objectID":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/:2:2","tags":["clippings","blog","è½¬è½½"],"title":"Android Surface-CSDNåšå®¢","uri":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/#surface-1"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"C++ç±» Surface Surfaceæ˜¯Androidä¸­ç”¨äºè¡¨ç¤ºä¸€ä¸ªå›¾åƒç¼“å†²åŒºçš„ç±»ï¼ŒSurfaceåŒ…æ‹¬JAVAéƒ¨åˆ†ï¼ŒJNIå’ŒC++éƒ¨åˆ†ã€‚ Surfaceä»£ç ä½äºï¼š frameworks/base/core/jni/android_view_Surface.cpp framework/native/libs/gui/Surface.cpp frameworks/native/include/gui/Surface.h Surfaceçš„å®šä¹‰ï¼š class Surface : public ANativeObjectBase {} Surfaceæ–¹æ³•ï¼š int connect(int api, const sp\u0026 listener)ï¼šè¿æ¥ int Surface::disconnect(int api, IGraphicBufferProducer::DisconnectMode mode) ï¼šæ–­å¼€ int queueBuffers(const std::vector\u0026 buffers)ï¼šç”Ÿäº§è€…å¡«å……ç¼“å­˜åŒºå¹¶è¿”å›ç»™é˜Ÿåˆ— int dequeueBuffers(std::vector* buffers)ï¼šç”Ÿäº§è€…è¯·æ±‚ä¸€å—ç©ºé—²çš„ç¼“å­˜åŒº int cancelBuffers(const std::vector\u0026 buffers)ï¼šå…³é—­ç¼“å†²åŒº SurfaceControl SurfaceControlæ˜¯ä¸€ä¸ªç”¨äºåˆ›å»ºå’Œç®¡ç†Surfaceçš„ç±»ï¼Œå…¶ä¸­çš„Surfaceå¯¹è±¡å°±æ˜¯ä¸€ä¸ªç”¨äºå›¾åƒå±•ç¤ºçš„æ‰¿è½½å™¨ã€‚è€ŒSurfaceControlå¯¹è±¡ï¼Œåˆ™æ˜¯ç”¨äºå¯¹Surfaceå¯¹è±¡è¿›è¡Œæ“ä½œçš„æ§åˆ¶å™¨ã€‚ä½¿ç”¨SurfaceControlï¼Œåº”ç”¨ç¨‹åºå¯ä»¥æ ¹æ®éœ€è¦åˆ›å»ºæ–°çš„Surfaceï¼Œæˆ–å°†ç°æœ‰çš„Surfaceä¸å½“å‰ä¼šè¯è¿›è¡Œå…³è”ï¼Œé€šè¿‡SurfaceControlå¯ä»¥å¯¹Surfaceå±æ€§è¿›è¡Œè®¾ç½®ï¼Œä¾‹å¦‚å¯¹Surfaceè¿›è¡Œè£å‰ªã€è®¾ç½®Surfaceä½ç½®å’Œå¤§å°ã€è®¾ç½®Surfaceçš„é€æ˜åº¦ç­‰ã€‚ SurfaceControlé€šè¿‡SurfaceSessionæ¥å’ŒSurfaceFlingerè¿›è¡Œäº¤äº’ã€å®Œæˆå¯¹Surfaceçš„åˆ›å»ºã€è®¾ç½®å’Œæ§åˆ¶ç­‰æ“ä½œï¼ŒSurfaceControlåŒ…æ‹¬JAVAéƒ¨åˆ†ï¼ŒJNIå’ŒC++éƒ¨åˆ†ã€‚ SurfaceControlä»£ç ä½äºï¼š frameworks/base/core/jni/android_view_SurfaceControl.cpp frameworks/native/libs/gui/SurfaceControl.cpp frameworks/native/include/gui/SurfaceControl.h SurfaceControlçš„å®šä¹‰ï¼š public final class SurfaceControl implements Parcelable { } class SurfaceControl : public RefBase{ } ComposerService This holds our connection to the composer service (i.e. SurfaceFlinger). ComposerServiceä»£ç ä½äºï¼š frameworks/native/libs/gui/include/private/gui/ComposerService.h ComposerServiceçš„å®šä¹‰ï¼š class ComposerService : public Singleton {} ComposerServiceAIDL This holds our connection to the composer service (i.e. SurfaceFlinger). ComposerServiceAIDL ä»£ç ä½äºï¼š frameworks/native/libs/gui/include/private/gui/ComposerServiceAIDL .h ComposerServiceAIDL çš„å®šä¹‰ï¼š class ComposerServiceAIDL : public Singleton {} ","date":"2024-11-06","objectID":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/:2:2","tags":["clippings","blog","è½¬è½½"],"title":"Android Surface-CSDNåšå®¢","uri":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/#surfacecontrol-1"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"C++ç±» Surface Surfaceæ˜¯Androidä¸­ç”¨äºè¡¨ç¤ºä¸€ä¸ªå›¾åƒç¼“å†²åŒºçš„ç±»ï¼ŒSurfaceåŒ…æ‹¬JAVAéƒ¨åˆ†ï¼ŒJNIå’ŒC++éƒ¨åˆ†ã€‚ Surfaceä»£ç ä½äºï¼š frameworks/base/core/jni/android_view_Surface.cpp framework/native/libs/gui/Surface.cpp frameworks/native/include/gui/Surface.h Surfaceçš„å®šä¹‰ï¼š class Surface : public ANativeObjectBase {} Surfaceæ–¹æ³•ï¼š int connect(int api, const sp\u0026 listener)ï¼šè¿æ¥ int Surface::disconnect(int api, IGraphicBufferProducer::DisconnectMode mode) ï¼šæ–­å¼€ int queueBuffers(const std::vector\u0026 buffers)ï¼šç”Ÿäº§è€…å¡«å……ç¼“å­˜åŒºå¹¶è¿”å›ç»™é˜Ÿåˆ— int dequeueBuffers(std::vector* buffers)ï¼šç”Ÿäº§è€…è¯·æ±‚ä¸€å—ç©ºé—²çš„ç¼“å­˜åŒº int cancelBuffers(const std::vector\u0026 buffers)ï¼šå…³é—­ç¼“å†²åŒº SurfaceControl SurfaceControlæ˜¯ä¸€ä¸ªç”¨äºåˆ›å»ºå’Œç®¡ç†Surfaceçš„ç±»ï¼Œå…¶ä¸­çš„Surfaceå¯¹è±¡å°±æ˜¯ä¸€ä¸ªç”¨äºå›¾åƒå±•ç¤ºçš„æ‰¿è½½å™¨ã€‚è€ŒSurfaceControlå¯¹è±¡ï¼Œåˆ™æ˜¯ç”¨äºå¯¹Surfaceå¯¹è±¡è¿›è¡Œæ“ä½œçš„æ§åˆ¶å™¨ã€‚ä½¿ç”¨SurfaceControlï¼Œåº”ç”¨ç¨‹åºå¯ä»¥æ ¹æ®éœ€è¦åˆ›å»ºæ–°çš„Surfaceï¼Œæˆ–å°†ç°æœ‰çš„Surfaceä¸å½“å‰ä¼šè¯è¿›è¡Œå…³è”ï¼Œé€šè¿‡SurfaceControlå¯ä»¥å¯¹Surfaceå±æ€§è¿›è¡Œè®¾ç½®ï¼Œä¾‹å¦‚å¯¹Surfaceè¿›è¡Œè£å‰ªã€è®¾ç½®Surfaceä½ç½®å’Œå¤§å°ã€è®¾ç½®Surfaceçš„é€æ˜åº¦ç­‰ã€‚ SurfaceControlé€šè¿‡SurfaceSessionæ¥å’ŒSurfaceFlingerè¿›è¡Œäº¤äº’ã€å®Œæˆå¯¹Surfaceçš„åˆ›å»ºã€è®¾ç½®å’Œæ§åˆ¶ç­‰æ“ä½œï¼ŒSurfaceControlåŒ…æ‹¬JAVAéƒ¨åˆ†ï¼ŒJNIå’ŒC++éƒ¨åˆ†ã€‚ SurfaceControlä»£ç ä½äºï¼š frameworks/base/core/jni/android_view_SurfaceControl.cpp frameworks/native/libs/gui/SurfaceControl.cpp frameworks/native/include/gui/SurfaceControl.h SurfaceControlçš„å®šä¹‰ï¼š public final class SurfaceControl implements Parcelable { } class SurfaceControl : public RefBase{ } ComposerService This holds our connection to the composer service (i.e. SurfaceFlinger). ComposerServiceä»£ç ä½äºï¼š frameworks/native/libs/gui/include/private/gui/ComposerService.h ComposerServiceçš„å®šä¹‰ï¼š class ComposerService : public Singleton {} ComposerServiceAIDL This holds our connection to the composer service (i.e. SurfaceFlinger). ComposerServiceAIDL ä»£ç ä½äºï¼š frameworks/native/libs/gui/include/private/gui/ComposerServiceAIDL .h ComposerServiceAIDL çš„å®šä¹‰ï¼š class ComposerServiceAIDL : public Singleton {} ","date":"2024-11-06","objectID":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/:2:2","tags":["clippings","blog","è½¬è½½"],"title":"Android Surface-CSDNåšå®¢","uri":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/#composerservice"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"C++ç±» Surface Surfaceæ˜¯Androidä¸­ç”¨äºè¡¨ç¤ºä¸€ä¸ªå›¾åƒç¼“å†²åŒºçš„ç±»ï¼ŒSurfaceåŒ…æ‹¬JAVAéƒ¨åˆ†ï¼ŒJNIå’ŒC++éƒ¨åˆ†ã€‚ Surfaceä»£ç ä½äºï¼š frameworks/base/core/jni/android_view_Surface.cpp framework/native/libs/gui/Surface.cpp frameworks/native/include/gui/Surface.h Surfaceçš„å®šä¹‰ï¼š class Surface : public ANativeObjectBase {} Surfaceæ–¹æ³•ï¼š int connect(int api, const sp\u0026 listener)ï¼šè¿æ¥ int Surface::disconnect(int api, IGraphicBufferProducer::DisconnectMode mode) ï¼šæ–­å¼€ int queueBuffers(const std::vector\u0026 buffers)ï¼šç”Ÿäº§è€…å¡«å……ç¼“å­˜åŒºå¹¶è¿”å›ç»™é˜Ÿåˆ— int dequeueBuffers(std::vector* buffers)ï¼šç”Ÿäº§è€…è¯·æ±‚ä¸€å—ç©ºé—²çš„ç¼“å­˜åŒº int cancelBuffers(const std::vector\u0026 buffers)ï¼šå…³é—­ç¼“å†²åŒº SurfaceControl SurfaceControlæ˜¯ä¸€ä¸ªç”¨äºåˆ›å»ºå’Œç®¡ç†Surfaceçš„ç±»ï¼Œå…¶ä¸­çš„Surfaceå¯¹è±¡å°±æ˜¯ä¸€ä¸ªç”¨äºå›¾åƒå±•ç¤ºçš„æ‰¿è½½å™¨ã€‚è€ŒSurfaceControlå¯¹è±¡ï¼Œåˆ™æ˜¯ç”¨äºå¯¹Surfaceå¯¹è±¡è¿›è¡Œæ“ä½œçš„æ§åˆ¶å™¨ã€‚ä½¿ç”¨SurfaceControlï¼Œåº”ç”¨ç¨‹åºå¯ä»¥æ ¹æ®éœ€è¦åˆ›å»ºæ–°çš„Surfaceï¼Œæˆ–å°†ç°æœ‰çš„Surfaceä¸å½“å‰ä¼šè¯è¿›è¡Œå…³è”ï¼Œé€šè¿‡SurfaceControlå¯ä»¥å¯¹Surfaceå±æ€§è¿›è¡Œè®¾ç½®ï¼Œä¾‹å¦‚å¯¹Surfaceè¿›è¡Œè£å‰ªã€è®¾ç½®Surfaceä½ç½®å’Œå¤§å°ã€è®¾ç½®Surfaceçš„é€æ˜åº¦ç­‰ã€‚ SurfaceControlé€šè¿‡SurfaceSessionæ¥å’ŒSurfaceFlingerè¿›è¡Œäº¤äº’ã€å®Œæˆå¯¹Surfaceçš„åˆ›å»ºã€è®¾ç½®å’Œæ§åˆ¶ç­‰æ“ä½œï¼ŒSurfaceControlåŒ…æ‹¬JAVAéƒ¨åˆ†ï¼ŒJNIå’ŒC++éƒ¨åˆ†ã€‚ SurfaceControlä»£ç ä½äºï¼š frameworks/base/core/jni/android_view_SurfaceControl.cpp frameworks/native/libs/gui/SurfaceControl.cpp frameworks/native/include/gui/SurfaceControl.h SurfaceControlçš„å®šä¹‰ï¼š public final class SurfaceControl implements Parcelable { } class SurfaceControl : public RefBase{ } ComposerService This holds our connection to the composer service (i.e. SurfaceFlinger). ComposerServiceä»£ç ä½äºï¼š frameworks/native/libs/gui/include/private/gui/ComposerService.h ComposerServiceçš„å®šä¹‰ï¼š class ComposerService : public Singleton {} ComposerServiceAIDL This holds our connection to the composer service (i.e. SurfaceFlinger). ComposerServiceAIDL ä»£ç ä½äºï¼š frameworks/native/libs/gui/include/private/gui/ComposerServiceAIDL .h ComposerServiceAIDL çš„å®šä¹‰ï¼š class ComposerServiceAIDL : public Singleton {} ","date":"2024-11-06","objectID":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/:2:2","tags":["clippings","blog","è½¬è½½"],"title":"Android Surface-CSDNåšå®¢","uri":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/#composerserviceaidl"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"ä¸‰ã€Surfaceç›¸å…³æµç¨‹åˆ†æ ","date":"2024-11-06","objectID":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/:3:0","tags":["clippings","blog","è½¬è½½"],"title":"Android Surface-CSDNåšå®¢","uri":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/#ä¸‰surfaceç›¸å…³æµç¨‹åˆ†æ"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"[[Android13 Surfaceåˆ›å»ºæµç¨‹åˆ†æ-CSDNåšå®¢]] ","date":"2024-11-06","objectID":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/:3:1","tags":["clippings","blog","è½¬è½½"],"title":"Android Surface-CSDNåšå®¢","uri":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/#android13-surfaceåˆ›å»ºæµç¨‹åˆ†æ-csdnåšå®¢"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"[[Android13 SurfaceControlåˆ›å»ºæµç¨‹åˆ†æ-CSDNåšå®¢]] ","date":"2024-11-06","objectID":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/:3:2","tags":["clippings","blog","è½¬è½½"],"title":"Android Surface-CSDNåšå®¢","uri":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/#android13-surfacecontrolåˆ›å»ºæµç¨‹åˆ†æ-csdnåšå®¢"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"[[Android13 Surface connectæµç¨‹åˆ†æ-CSDNåšå®¢]] ","date":"2024-11-06","objectID":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/:3:3","tags":["clippings","blog","è½¬è½½"],"title":"Android Surface-CSDNåšå®¢","uri":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/#android13-surface-connectæµç¨‹åˆ†æ-csdnåšå®¢"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"[[Android13 Surface lockCanvasæµç¨‹åˆ†æ-CSDNåšå®¢]] ","date":"2024-11-06","objectID":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/:3:4","tags":["clippings","blog","è½¬è½½"],"title":"Android Surface-CSDNåšå®¢","uri":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/#android13-surface-lockcanvasæµç¨‹åˆ†æ-csdnåšå®¢"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"[[Android13 Surface unlockCanvasAndPostæµç¨‹åˆ†æ-CSDNåšå®¢]] ","date":"2024-11-06","objectID":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/:3:5","tags":["clippings","blog","è½¬è½½"],"title":"Android Surface-CSDNåšå®¢","uri":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/#android13-surface-unlockcanvasandpostæµç¨‹åˆ†æ-csdnåšå®¢"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"[[Android13 Surface dequeueBufferæµç¨‹åˆ†æ-CSDNåšå®¢]] ","date":"2024-11-06","objectID":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/:3:6","tags":["clippings","blog","è½¬è½½"],"title":"Android Surface-CSDNåšå®¢","uri":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/#android13-surface-dequeuebufferæµç¨‹åˆ†æ-csdnåšå®¢"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"[[Android13 Surface queueBufferæµç¨‹åˆ†æ-CSDNåšå®¢]] ","date":"2024-11-06","objectID":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/:3:7","tags":["clippings","blog","è½¬è½½"],"title":"Android Surface-CSDNåšå®¢","uri":"/posts/android-surface-csdn%E5%8D%9A%E5%AE%A2/#android13-surface-queuebufferæµç¨‹åˆ†æ-csdnåšå®¢"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"èƒŒæ™¯ï¼š è®¾æƒ³ä¸€ä¸‹ï¼Œå‡å¦‚æˆ‘ä»¬åˆå¦‚ä¸‹åœºæ™¯ï¼Œä¸€ä¸ªé—ªé»‘ä¸€ç¬é—´çš„é—®é¢˜ï¼Œæ­£å¸¸æˆ‘ä»¬çœ‹åˆ°é»‘å±å†»å±é—®é¢˜ï¼Œæ˜¯ä¸æ˜¯æ—¶åˆ»æƒ³åˆ°æ˜¯è¦æ¥dumpsys SurfaceFlingerå’Œdumpsys window windowsç›¸å…³çš„ä¿¡æ¯æ¥è¾…åŠ©æˆ‘ä»¬åˆ†æé—®é¢˜ï¼Œä½†å¥ˆä½•è¿™ä¸ªæ˜¯ä¸ªç¬æ—¶é—®é¢˜ã€‚ã€‚ã€‚æˆ‘ä»¬dumpsyså¾ˆéš¾æŠ“ä½é‚£ä¸€ç¬é—´ï¼Œè€Œä¸”å³ä½¿æŠ“åˆ°äº†é»‘ä¸€ç¬é—´çš„ï¼Œæˆ‘ä»¬æœ‰æ—¶å€™åˆ†æä¹Ÿè¦åˆé»‘å±å‰ä¸€å¸§åä¸€å¸§ç›¸å…³ç­‰æ‰å¯ä»¥åˆ†æè¿›ä¸€æ­¥åŸå› ã€‚ æ‰€ä»¥åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šé‡åˆ°å„ç§å„æ ·çš„çª—å£é—®é¢˜ï¼Œæ¯”å¦‚åŠ¨ç”»å¼‚å¸¸ã€çª—å£å¼‚å¸¸ã€é—ªå±ã€é—ªé»‘ã€é»‘å±ã€é”™ä½æ˜¾ç¤ºâ€¦ å¯¹äºè¿™äº›é—®é¢˜ï¼Œæ·»åŠ æ—¥å¿—ï¼Œè°ƒè¯•åˆ†æä»£ç ç­‰æ‰‹æ®µå»è§£å†³ï¼Œä½†è¿™äº› UI é—®é¢˜å¾€å¾€å‡ºç°åœ¨ä¸€ç¬é—´ï¼Œå¾ˆéš¾æŠŠæ¡å‡ºç°çš„æ—¶æœºï¼Œå½•åˆ¶ä¸‹æ¥çš„æ—¥å¿—å¾€å¾€ä¹Ÿæ˜¯å·¨å¤§çš„ï¼Œä»æµ·é‡çš„æ—¥å¿—ä¸­æå–æœ‰æ•ˆçš„ä¿¡æ¯æ˜¯ä¸€ä¸ªæ¯ç‡¥ä¸”ç¹ççš„äº‹æƒ…ï¼Œè€Œä¸”ä¹Ÿæ ¹æœ¬æ²¡æœ‰åŠæ³•æŠŠæ˜¾ç¤ºæ—¶é—´æˆ³å’Œæ—¥å¿—æ—¶é—´æˆ³å®Œå…¨å¯¹å¥½ã€‚ Android ä¹Ÿæ„è¯†åˆ°äº†è¿™ä¸ªé—®é¢˜ï¼ŒWinScope çš„å‡ºç°æœ‰æ•ˆçš„å¸®åŠ©æˆ‘ä»¬è·Ÿè¸ªçª—å£å’Œæ˜¾ç¤ºé—®é¢˜ã€‚å®ƒå‘å¼€å‘è€…æä¾›ä¸€ä¸ªå¯è§†åŒ–çš„å·¥å…·ï¼Œè®©å¼€å‘è€…èƒ½ä½¿ç”¨å·¥å…·è·Ÿè¸ªæ•´ä¸ªç•Œé¢çš„å˜åŒ–è¿‡ç¨‹ã€‚ ","date":"2024-11-06","objectID":"/posts/winscope%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D-csdn%E5%8D%9A%E5%AE%A2/:0:1","tags":["clippings","è½¬è½½","blog"],"title":"androidè½¦æœºæ‰‹æœºé»‘å±é—ªé»‘ç»ˆç»“è€…-Winscopeå·¥å…·ä½¿ç”¨ä»‹ç»-CSDNåšå®¢","uri":"/posts/winscope%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D-csdn%E5%8D%9A%E5%AE%A2/#èƒŒæ™¯"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"æ€ä¹ˆæŠ“winscopeç›¸å…³æ–‡ä»¶ï¼š ","date":"2024-11-06","objectID":"/posts/winscope%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D-csdn%E5%8D%9A%E5%AE%A2/:0:2","tags":["clippings","è½¬è½½","blog"],"title":"androidè½¦æœºæ‰‹æœºé»‘å±é—ªé»‘ç»ˆç»“è€…-Winscopeå·¥å…·ä½¿ç”¨ä»‹ç»-CSDNåšå®¢","uri":"/posts/winscope%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D-csdn%E5%8D%9A%E5%AE%A2/#æ€ä¹ˆæŠ“winscopeç›¸å…³æ–‡ä»¶"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"æŠ“å–winscope æŠŠè¿™é‡Œé¢çš„Winscope Traceå¼€å…³æ‰“å¼€ è¿™æ—¶å€™ä¸‹æ‹‰çŠ¶æ€æ å¤šäº†å®ƒçš„å›¾æ ‡ å½“æˆ‘ä»¬éœ€è¦å¼€å§‹æŠ“å–æ—¶å€™ç‚¹å‡»å›¾æ ‡æ—¢å¯ä»¥ ç„¶åå¼€å§‹æ“ä½œæ‰‹æœºå¤ç°å¯¹åº”çš„bugç°è±¡ï¼Œå¤ç°å®Œæ¯•åˆ™å†ç‚¹å‡»å›¾æ ‡å…³é—­ æœ€åä¼šå†ç³»ç»Ÿçš„å¦‚ä¸‹è·¯å¾„ç”Ÿæˆå¯¹åº”çš„winscopeæ–‡ä»¶ ","date":"2024-11-06","objectID":"/posts/winscope%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D-csdn%E5%8D%9A%E5%AE%A2/:0:3","tags":["clippings","è½¬è½½","blog"],"title":"androidè½¦æœºæ‰‹æœºé»‘å±é—ªé»‘ç»ˆç»“è€…-Winscopeå·¥å…·ä½¿ç”¨ä»‹ç»-CSDNåšå®¢","uri":"/posts/winscope%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D-csdn%E5%8D%9A%E5%AE%A2/#æŠ“å–winscope"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"ä½¿ç”¨chromeæµè§ˆå™¨åŠ è½½è§‚çœ‹winscope æ‰“å¼€ä½¿ç”¨é…å¥—æºç aospä¸­çš„winscopeçš„htmlæ–‡ä»¶ æ–‡ä»¶è·¯å¾„å¦‚ä¸‹ï¼š /home/test/aosp/prebuilts/misc/common/winscope/winscope.html æŠŠè¿™ä¸ªwinscope.htmlæ‰“å¼€ ç„¶åæŠŠæ‰‹æœºä¸Šçš„winscopeæŠ“å–çš„æ–‡ä»¶pullåˆ°æœ¬åœ° adb pull /data/misc/wmtrace å†ç‚¹å‡»å¦‚ä¸‹åŒºåŸŸï¼š é€‰æ‹©å¯¹åº”æ–‡ä»¶ï¼Œè¿™é‡Œä¸€èˆ¬å¸¸ç”¨æ˜¯SurfaceFlingerå’ŒWindowçš„ç›¸å…³ï¼š è¿™é‡Œæˆ‘ä»¬æœ€å¸¸è§çš„å°±æ˜¯SurfaceFlingerå’ŒWindowçš„åˆ†æ é€‰æ‹©åç‚¹å‡»Submit ç„¶åå°±å¯ä»¥ç›¸å½“äºå¯¹ç€å½•å±çš„æ¯ä¸€å¸§å›¾åƒçœ‹å¯¹åº”çš„surfaceflingerä¸­å„ä¸ªlayerçš„ä¿¡æ¯ï¼Œç›¸å½“äºæ¯ä¸€å¸§æˆ‘ä»¬éƒ½å¯ä»¥åˆå¯¹åº”çš„dumpsysæ•°æ®åˆ†æ ","date":"2024-11-06","objectID":"/posts/winscope%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D-csdn%E5%8D%9A%E5%AE%A2/:0:4","tags":["clippings","è½¬è½½","blog"],"title":"androidè½¦æœºæ‰‹æœºé»‘å±é—ªé»‘ç»ˆç»“è€…-Winscopeå·¥å…·ä½¿ç”¨ä»‹ç»-CSDNåšå®¢","uri":"/posts/winscope%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D-csdn%E5%8D%9A%E5%AE%A2/#ä½¿ç”¨chromeæµè§ˆå™¨åŠ è½½è§‚çœ‹winscope"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"4ã€åŸå› å¯»æ‰¾åŠè§£å†³åŠæ³• ä¸Šé¢å·²ç»åˆ†æäº†bugreportçš„åŸç†ï¼Œå®é™…æ˜¯å€ŸåŠ©dumpstateæ¥å®ç°è·å–é«˜æƒé™rootçš„ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œä¸ºå•¥wmtraceç›¸å…³æ–‡ä»¶å¤¹å‘¢ï¼Ÿè¿™ä¸ªé—®é¢˜å°±å¾—çœ‹dumpstateç›¸å…³æºç äº†ï¼š frameworks/native/cmds/dumpstate/dumpstate.cpp çœ‹åˆ°äº†å¦‚ä¸‹çš„ä»£ç ï¼š #define PSTORE_LAST_KMSG \"/sys/fs/pstore/console-ramoops\" #define ALT_PSTORE_LAST_KMSG \"/sys/fs/pstore/console-ramoops-0\" #define BLK_DEV_SYS_DIR \"/sys/block\" #define RECOVERY_DIR \"/cache/recovery\" #define RECOVERY_DATA_DIR \"/data/misc/recovery\" #define UPDATE_ENGINE_LOG_DIR \"/data/misc/update_engine_log\" #define LOGPERSIST_DATA_DIR \"/data/misc/logd\" #define PREREBOOT_DATA_DIR \"/data/misc/prereboot\" #define PROFILE_DATA_DIR_CUR \"/data/misc/profiles/cur\" #define PROFILE_DATA_DIR_REF \"/data/misc/profiles/ref\" #define XFRM_STAT_PROC_FILE \"/proc/net/xfrm_stat\" #define WLUTIL \"/vendor/xbin/wlutil\" #define WMTRACE_DATA_DIR \"/data/misc/wmtrace\" #define OTA_METADATA_DIR \"/metadata/ota\" #define SNAPSHOTCTL_LOG_DIR \"/data/misc/snapshotctl_log\" #define LINKERCONFIG_DIR \"/linkerconfig\" #define PACKAGE_DEX_USE_LIST \"/data/system/package-dex-usage.list\" #define SYSTEM_TRACE_SNAPSHOT \"/data/misc/perfetto-traces/bugreport/systrace.pftrace\" #define CGROUPFS_DIR \"/sys/fs/cgroup\" å¯ä»¥çœ‹åˆ°æœ‰åˆ—å‡ºä¸€ä¸ªä¸ªçš„dataç›¸å…³ç›®å½•ï¼Œæœ‰RECOVERY_DATA_DIRå’ŒWMTRACE_DATA_DIRï¼Œè¿™é‡Œé‡ç‚¹çœ‹çœ‹WMTRACE_DATA_DIRä¸ºå•¥æ²¡æœ‰è¢«å¯¼å‡ºçœ‹çœ‹æ˜¯å¦æœ‰ç›¸å…³çš„é™åˆ¶æ¡ä»¶ï¼š çœ‹åˆ°äº†å¦‚ä¸‹çš„ä»£ç ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªæ¡ä»¶å°±æ˜¯!PropertiesHelper::IsUserBuild() å³åªæœ‰åœ¨éuseræ‰‹æœºæ‰å¯ä»¥å¯¼å‡ºWMTRACE_DATA_DIRç›®å½• /* Add window and surface trace files. */ if (!PropertiesHelper::IsUserBuild()) { ds.AddDir(WMTRACE_DATA_DIR, false); } ä¿®æ”¹æ–¹æ¡ˆæ¢ç´¢ï¼š 1ã€ç›´æ¥åˆ é™¤ if (!PropertiesHelper::IsUserBuild()) æ¡ä»¶ï¼ˆæ¯”è¾ƒæš´åŠ›ä¸å®‰å…¨ï¼‰ //if (!PropertiesHelper::IsUserBuild()) { ds.AddDir(WMTRACE_DATA_DIR, false); // } 2ã€å¯ä»¥åŠ ä¸€ä¸ªæˆ–æ¡ä»¶ï¼ŒåŠ å…¥è‡ªå·±çš„æš—é—¨ï¼ˆå»ºè®®è¿™ç§ï¼‰ï¼Œæ¯”å¦‚è‡ªå·±ä¹Ÿæä¸€ä¸ªpropï¼Œå¯ä»¥é€šè¿‡adb shellæ”¹å˜çš„prop if (!PropertiesHelper::IsUserBuild() || isEnablePropï¼ˆï¼‰) { ds.AddDir(WMTRACE_DATA_DIR, false); } ","date":"2024-11-06","objectID":"/posts/winscope%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D-csdn%E5%8D%9A%E5%AE%A2/:0:5","tags":["clippings","è½¬è½½","blog"],"title":"androidè½¦æœºæ‰‹æœºé»‘å±é—ªé»‘ç»ˆç»“è€…-Winscopeå·¥å…·ä½¿ç”¨ä»‹ç»-CSDNåšå®¢","uri":"/posts/winscope%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8%E4%BB%8B%E7%BB%8D-csdn%E5%8D%9A%E5%AE%A2/#4åŸå› å¯»æ‰¾åŠè§£å†³åŠæ³•"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"èƒŒæ™¯ å‘ç°æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±å‘ç°åœ¨userç‰ˆæœ¬çš„æ‰‹æœºè®¾å¤‡ä¸Šå‘ç°æ— æ³•æŠ“å–ç›¸å…³çš„winscopeï¼Œå“ªæ€•å¯ä»¥æŠ“å–ä¹Ÿå‘ç°æ²¡åŠæ³•å¯¼å‡ºæ¥åˆ†æã€‚ ","date":"2024-11-06","objectID":"/posts/winscope%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0user%E7%89%88%E6%9C%AC%E4%B8%8A%E5%AF%BC%E5%87%BA%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1%E6%8E%A2%E8%AE%A8-csdn%E5%8D%9A%E5%AE%A2/:0:1","tags":["clippings","è½¬è½½","blog"],"title":"winscopeæ€ä¹ˆå®ç°userç‰ˆæœ¬ä¸Šå¯¼å‡ºæ–¹æ¡ˆè®¾è®¡æ¢è®¨","uri":"/posts/winscope%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0user%E7%89%88%E6%9C%AC%E4%B8%8A%E5%AF%BC%E5%87%BA%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1%E6%8E%A2%E8%AE%A8-csdn%E5%8D%9A%E5%AE%A2/#èƒŒæ™¯"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"1ã€useræ‰‹æœºä¸Šç½‘é¡µè·å–winscopeå¤±è´¥ winscopeåœ¨useræ‰‹æœºä¸Šçš„æ•ˆæœå¦‚ä¸‹ï¼š å¯ä»¥çœ‹å‡ºä¸€ç›´æ˜¯æ˜¾ç¤ºä¸ªerrorï¼Œä½†æ˜¯å…·ä½“æ˜¯å•¥åŸå› errorå‘¢ï¼Ÿ ä»æœåŠ¡ç«¯çš„pythonç¨‹åºè¾“å‡ºæ—¥æ—¥å¿—çœ‹çœ‹ï¼š æ˜æ˜¾çœ‹åˆ°å…¶å®æœåŠ¡ç«¯ä¹Ÿåªæ˜¯å»æ‰§è¡Œç›¸å…³çš„adb shellå‘½ä»¤ï¼Œåªä¸è¿‡è¿™ä¸ªå‘½ä»¤éœ€è¦æœ‰su rootè¿™æ ·é«˜çº§åˆ«çš„æƒé™ã€‚è‡ªç„¶åœ¨useræ‰‹æœºä¸Šæ˜¯æ²¡æœ‰çš„ ","date":"2024-11-06","objectID":"/posts/winscope%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0user%E7%89%88%E6%9C%AC%E4%B8%8A%E5%AF%BC%E5%87%BA%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1%E6%8E%A2%E8%AE%A8-csdn%E5%8D%9A%E5%AE%A2/:0:2","tags":["clippings","è½¬è½½","blog"],"title":"winscopeæ€ä¹ˆå®ç°userç‰ˆæœ¬ä¸Šå¯¼å‡ºæ–¹æ¡ˆè®¾è®¡æ¢è®¨","uri":"/posts/winscope%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0user%E7%89%88%E6%9C%AC%E4%B8%8A%E5%AF%BC%E5%87%BA%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1%E6%8E%A2%E8%AE%A8-csdn%E5%8D%9A%E5%AE%A2/#1useræ‰‹æœºä¸Šç½‘é¡µè·å–winscopeå¤±è´¥"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"2ã€æ‰‹æœºä¸Šå¯ä»¥æŠ“å–ï¼Œä½†æ˜¯æ— æƒé™è·å–æ–‡ä»¶ å¿«æ·æŒ‰é’®å¯ä»¥å»settingä¸­æ”¾å¼€ æŠ“å–å®Œæˆåæœ‰ç›¸å…³çš„traceæ–‡ä»¶ï¼š å¯ä»¥çœ‹åˆ°traceæ–‡ä»¶è¢«å¯¼å‡ºåˆ°äº† data/misc/wmtraceæ–‡ä»¶å¤¹ï¼Œé‚£ä¹ˆå°è¯•å–å‡º å‘ç°æœ‰å¦‚ä¸‹æƒé™é—®é¢˜ å¯ä»¥çœ‹å‡ºè¿™ä¸ªwmtraceæ–‡ä»¶å¤¹å‹æ ¹æ²¡æœ‰æƒé™å“ˆï¼Œè‡ªç„¶æ— æ³•å–å‡º ","date":"2024-11-06","objectID":"/posts/winscope%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0user%E7%89%88%E6%9C%AC%E4%B8%8A%E5%AF%BC%E5%87%BA%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1%E6%8E%A2%E8%AE%A8-csdn%E5%8D%9A%E5%AE%A2/:0:3","tags":["clippings","è½¬è½½","blog"],"title":"winscopeæ€ä¹ˆå®ç°userç‰ˆæœ¬ä¸Šå¯¼å‡ºæ–¹æ¡ˆè®¾è®¡æ¢è®¨","uri":"/posts/winscope%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0user%E7%89%88%E6%9C%AC%E4%B8%8A%E5%AF%BC%E5%87%BA%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1%E6%8E%A2%E8%AE%A8-csdn%E5%8D%9A%E5%AE%A2/#2æ‰‹æœºä¸Šå¯ä»¥æŠ“å–ä½†æ˜¯æ— æƒé™è·å–æ–‡ä»¶"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"3ã€å°è¯•æ¢ç´¢è§£å†³åŠæ³• ä½¿ç”¨bugreoportå‘½ä»¤ï¼š test@test:~$ adb bugreport /data/user_de/0/com.android.shell/files/bugreports/bugreport-crosshatch-SP1A.210812.016.C1-2022-06-28-12-21-13.zip: 1 file pulled. 27.7 MB/s (11790205 bytes in 0.406s) test@test:~$ adb pull /data/user_de/0/com.android.shell/files/bugreports/bugreport-crosshatch-SP1A.210812.016.C1-2022-06-28-12-21-13.zip /data/user_de/0/com.android.shell/files/bugreports/bugreport-crosshatch-SP1A.210812.016.C1-2022-06-28-12-21-13.zip: 1 file pulled. 27.7 MB/s (11790205 bytes in 0.406s) çœ‹çœ‹è¿™ä¸ªbugreportå‘½ä»¤å¯¼å‡ºçš„ç›¸å…³æ–‡ä»¶ï¼š å‘ç°FSæ–‡ä»¶å¤¹ä¸‹é¢æœ‰ä¸ªdataçš„æ–‡ä»¶å¤¹ï¼Œè¿˜æœ‰miscï¼Œå› ä¸ºæœ¬èº«miscæ ¹æœ¬adb shellæ˜¯æ²¡æœ‰æƒé™å¯ä»¥æŸ¥çœ‹çš„ï¼Œçœ‹ç€æ˜¯ä¸æ˜¯å¾ˆæœ‰å¸Œæœ›ã€‚ã€‚ ä½†æ˜¯æƒ…å†µå´å¦‚ä¸‹ï¼š åªæœ‰recoveryç›¸å…³ï¼Œæ²¡æœ‰çœ‹åˆ°wmtraceç›¸å…³æ–‡ä»¶å¤¹ ä½†æ˜¯æ˜æ˜å°±æ˜¯/data/misc/wmtraceè·¯å¾„ï¼Œä¸ºå•¥æ²¡æœ‰å¯¼å‡ºå‘¢ï¼Ÿ éœ€è¦çŸ¥é“è¿™ä¸ªåŸå› å°±å¿…é¡»è¦çœ‹æºç äº† é¦–å…ˆéœ€è¦äº†è§£ç‚¹bugreportå…¶å®æœ¬è´¨ä¸Šä¹Ÿæœ€å¤šåªèƒ½æœ‰shellæƒé™ï¼Œå› ä¸ºä¹Ÿå±äºadb shellæ‹‰èµ·çš„è¿›ç¨‹ï¼Œ ä½†æ˜¯ä¸ºå•¥å®ƒå¯ä»¥å¯¼å‡ºdata/misc/ä¸‹é¢ç›¸å…³æ–‡ä»¶å¤¹ ä¸ºäº†è§£å¯†è¿™ä¸ªæˆ‘ä»¬å¯ä»¥æ¥çœ‹çœ‹ç›¸å…³æºç  frameworks/native/cmds/bugreport/bugreport.cpp int main() { fprintf(stderr, \"=============================================================================\\n\"); fprintf(stderr, \"WARNING: Flat (text file, non-zipped) bugreports are deprecated.\\n\"); fprintf(stderr, \"WARNING: Please generate zipped bugreports instead.\\n\"); fprintf(stderr, \"WARNING: On the host use: adb bugreport filename.zip\\n\"); fprintf(stderr, \"WARNING: On the device use: bugreportz\\n\"); fprintf(stderr, \"WARNING: bugreportz will output the filename to use with adb pull.\\n\"); fprintf(stderr, \"=============================================================================\\n\\n\\n\"); return 0; } å¯ä»¥çœ‹å‡ºçš„è¿™é‡Œå…¶å®bugreportå·²ç»æ˜¯ä¸€ä¸ªç©ºå£³äº†ï¼ŒçœŸæ­£è¿˜æ˜¯bugreportzåœ¨èµ·ä½œç”¨ çœ‹çœ‹bugreportzçš„ç›¸å…³å‘½ä»¤ï¼š frameworks/native/cmds/bugreportz/main.cpp int main(int argc, char* argv[]) { //çœç•¥ // TODO: code below was copy-and-pasted from bugreport.cpp (except by the // timeout value); // should be reused instead. // Start the dumpstatez service. //å¯åŠ¨ç›¸å…³çš„ dumpstateæœåŠ¡ if (stream_data) { property_set(\"ctl.start\", \"dumpstate\"); } else { property_set(\"ctl.start\", \"dumpstatez\"); } // Socket will not be available until service starts. int s = -1; for (int i = 0; i \u003c 20; i++) { //ä¸dumpstateè¿›è¡Œæœ¬åœ°socketè·¨è¿›ç¨‹é€šè®¯ s = socket_local_client(\"dumpstate\", ANDROID_SOCKET_NAMESPACE_RESERVED, SOCK_STREAM); if (s \u003e= 0) break; // Try again in 1 second. sleep(1); } int ret; //socketæ¥å—ç›¸å…³çš„æ•°æ®è¿›è¡Œå¤„ç† if (stream_data) { ret = bugreportz_stream(s); } else { ret = bugreportz(s, show_progress); } return ret; } æ€»ç»“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š éªŒè¯æ–¹å¼ï¼š åœ¨æ‰§è¡Œbugreportå‘½ä»¤æ—¶å€™ï¼š test@test:~/aosp/frameworks/native/cmds$ adb bugreport [ 5%] generating bugreport-crosshatch-SP1A.210812.016.C1-2022-06-28-13-02-19.zip å¼€å¦ä¸€ä¸ªåœ¨ç»ˆç«¯è¿›è¡Œadb shellæŸ¥çœ‹ä¸€ä¸‹é˜¿dumpstateæœåŠ¡æ˜¯å•¥æƒé™ï¼š crosshatch:/ $ ps -A | grep dump root 16137 1 10878140 5172 0 0 S dumpstate æ˜æ˜¾çœ‹åˆ°æ˜¯ä¸€ä¸ªrootæƒé™çš„è¿›ç¨‹ ","date":"2024-11-06","objectID":"/posts/winscope%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0user%E7%89%88%E6%9C%AC%E4%B8%8A%E5%AF%BC%E5%87%BA%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1%E6%8E%A2%E8%AE%A8-csdn%E5%8D%9A%E5%AE%A2/:0:4","tags":["clippings","è½¬è½½","blog"],"title":"winscopeæ€ä¹ˆå®ç°userç‰ˆæœ¬ä¸Šå¯¼å‡ºæ–¹æ¡ˆè®¾è®¡æ¢è®¨","uri":"/posts/winscope%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0user%E7%89%88%E6%9C%AC%E4%B8%8A%E5%AF%BC%E5%87%BA%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1%E6%8E%A2%E8%AE%A8-csdn%E5%8D%9A%E5%AE%A2/#3å°è¯•æ¢ç´¢è§£å†³åŠæ³•"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"4ã€åŸå› å¯»æ‰¾åŠè§£å†³åŠæ³• ä¸Šé¢å·²ç»åˆ†æäº†bugreportçš„åŸç†ï¼Œå®é™…æ˜¯å€ŸåŠ©dumpstateæ¥å®ç°è·å–é«˜æƒé™rootçš„ï¼Œé‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œä¸ºå•¥wmtraceç›¸å…³æ–‡ä»¶å¤¹å‘¢ï¼Ÿè¿™ä¸ªé—®é¢˜å°±å¾—çœ‹dumpstateç›¸å…³æºç äº†ï¼š frameworks/native/cmds/dumpstate/dumpstate.cpp çœ‹åˆ°äº†å¦‚ä¸‹çš„ä»£ç ï¼š #define PSTORE_LAST_KMSG \"/sys/fs/pstore/console-ramoops\" #define ALT_PSTORE_LAST_KMSG \"/sys/fs/pstore/console-ramoops-0\" #define BLK_DEV_SYS_DIR \"/sys/block\" #define RECOVERY_DIR \"/cache/recovery\" #define RECOVERY_DATA_DIR \"/data/misc/recovery\" #define UPDATE_ENGINE_LOG_DIR \"/data/misc/update_engine_log\" #define LOGPERSIST_DATA_DIR \"/data/misc/logd\" #define PREREBOOT_DATA_DIR \"/data/misc/prereboot\" #define PROFILE_DATA_DIR_CUR \"/data/misc/profiles/cur\" #define PROFILE_DATA_DIR_REF \"/data/misc/profiles/ref\" #define XFRM_STAT_PROC_FILE \"/proc/net/xfrm_stat\" #define WLUTIL \"/vendor/xbin/wlutil\" #define WMTRACE_DATA_DIR \"/data/misc/wmtrace\" #define OTA_METADATA_DIR \"/metadata/ota\" #define SNAPSHOTCTL_LOG_DIR \"/data/misc/snapshotctl_log\" #define LINKERCONFIG_DIR \"/linkerconfig\" #define PACKAGE_DEX_USE_LIST \"/data/system/package-dex-usage.list\" #define SYSTEM_TRACE_SNAPSHOT \"/data/misc/perfetto-traces/bugreport/systrace.pftrace\" #define CGROUPFS_DIR \"/sys/fs/cgroup\" å¯ä»¥çœ‹åˆ°æœ‰åˆ—å‡ºä¸€ä¸ªä¸ªçš„dataç›¸å…³ç›®å½•ï¼Œæœ‰RECOVERY_DATA_DIRå’ŒWMTRACE_DATA_DIRï¼Œè¿™é‡Œé‡ç‚¹çœ‹çœ‹WMTRACE_DATA_DIRä¸ºå•¥æ²¡æœ‰è¢«å¯¼å‡ºçœ‹çœ‹æ˜¯å¦æœ‰ç›¸å…³çš„é™åˆ¶æ¡ä»¶ï¼š çœ‹åˆ°äº†å¦‚ä¸‹çš„ä»£ç ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªæ¡ä»¶å°±æ˜¯!PropertiesHelper::IsUserBuild() å³åªæœ‰åœ¨éuseræ‰‹æœºæ‰å¯ä»¥å¯¼å‡ºWMTRACE_DATA_DIRç›®å½• /* Add window and surface trace files. */ if (!PropertiesHelper::IsUserBuild()) { ds.AddDir(WMTRACE_DATA_DIR, false); } ä¿®æ”¹æ–¹æ¡ˆæ¢ç´¢ï¼š 1ã€ç›´æ¥åˆ é™¤ if (!PropertiesHelper::IsUserBuild()) æ¡ä»¶ï¼ˆæ¯”è¾ƒæš´åŠ›ä¸å®‰å…¨ï¼‰ //if (!PropertiesHelper::IsUserBuild()) { ds.AddDir(WMTRACE_DATA_DIR, false); // } 2ã€å¯ä»¥åŠ ä¸€ä¸ªæˆ–æ¡ä»¶ï¼ŒåŠ å…¥è‡ªå·±çš„æš—é—¨ï¼ˆå»ºè®®è¿™ç§ï¼‰ï¼Œæ¯”å¦‚è‡ªå·±ä¹Ÿæä¸€ä¸ªpropï¼Œå¯ä»¥é€šè¿‡adb shellæ”¹å˜çš„prop if (!PropertiesHelper::IsUserBuild() || isEnablePropï¼ˆï¼‰) { ds.AddDir(WMTRACE_DATA_DIR, false); } ","date":"2024-11-06","objectID":"/posts/winscope%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0user%E7%89%88%E6%9C%AC%E4%B8%8A%E5%AF%BC%E5%87%BA%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1%E6%8E%A2%E8%AE%A8-csdn%E5%8D%9A%E5%AE%A2/:0:5","tags":["clippings","è½¬è½½","blog"],"title":"winscopeæ€ä¹ˆå®ç°userç‰ˆæœ¬ä¸Šå¯¼å‡ºæ–¹æ¡ˆè®¾è®¡æ¢è®¨","uri":"/posts/winscope%E6%80%8E%E4%B9%88%E5%AE%9E%E7%8E%B0user%E7%89%88%E6%9C%AC%E4%B8%8A%E5%AF%BC%E5%87%BA%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1%E6%8E%A2%E8%AE%A8-csdn%E5%8D%9A%E5%AE%A2/#4åŸå› å¯»æ‰¾åŠè§£å†³åŠæ³•"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"binderè®¨è®ºçš„ä¸€äº›åœºæ™¯é¢è¯•é¢˜ é—®é¢˜1ï¼šbinderä¸­æœ‰å¤šä¸ªè¿›ç¨‹ä½œä¸ºå®¢æˆ·ç«¯é€šè¿‡servicemanagerè·å–serviceçš„bpbinderï¼Œbpbinderéƒ½ä¼šæœ‰ä¸€ä¸ªhandleï¼Œé‚£ä¹ˆå¤šä¸ªè¿›ç¨‹è·å–åŒä¸€ä¸ªserviceå¯¹åº”çš„handleä¸€æ ·ä¹ˆï¼Ÿ æ˜¯çš„ï¼Œå¤šä¸ªè¿›ç¨‹è·å–åŒä¸€ä¸ªæœåŠ¡å¯¹åº”çš„ BpBinder çš„ handle æ˜¯ä¸€æ ·çš„ã€‚ åœ¨ Android çš„ Binder IPC æœºåˆ¶ä¸­ï¼ŒServiceManager è´Ÿè´£ç®¡ç†ç³»ç»Ÿä¸­çš„å„ç§æœåŠ¡ã€‚å½“ä¸€ä¸ªå®¢æˆ·ç«¯è¿›ç¨‹è¯·æ±‚æŸä¸ªæœåŠ¡æ—¶ï¼Œå®ƒä¼šé€šè¿‡ ServiceManager è·å–åˆ°æœåŠ¡çš„ Binder å¼•ç”¨ï¼ˆå³ BpBinderï¼‰ï¼Œè¿™ä¸ªå¼•ç”¨åœ¨å†…éƒ¨åŒ…å«äº†ä¸€ä¸ª handleï¼Œè¯¥ handle æ˜¯ä¸€ä¸ªæ•´æ•°å€¼ï¼Œå”¯ä¸€æ ‡è¯†äº†è¿™ä¸ªæœåŠ¡åœ¨ Binder é©±åŠ¨ä¸­çš„ä½ç½®ã€‚ ç”±äºä¸åŒè¿›ç¨‹è·å–çš„éƒ½æ˜¯åŒä¸€ä¸ªæœåŠ¡çš„å¼•ç”¨ï¼Œæ‰€ä»¥å®ƒä»¬è·å–åˆ°çš„ BpBinder ä¸­çš„ handle æ˜¯ç›¸åŒçš„ã€‚è¿™ä¸ª handle ç”¨äºåœ¨ Binder é©±åŠ¨å±‚è¿›è¡Œé€šä¿¡æ—¶æ ‡è¯†ç›®æ ‡æœåŠ¡ï¼Œä»è€Œç¡®ä¿å®¢æˆ·ç«¯è¿›ç¨‹èƒ½å¤Ÿæ­£ç¡®åœ°ä¸ç›®æ ‡æœåŠ¡è¿›è¡Œäº¤äº’ã€‚ æ€»ç»“æ¥è¯´ï¼š ä¸åŒè¿›ç¨‹é€šè¿‡ ServiceManager è·å–åŒä¸€ä¸ªæœåŠ¡çš„ BpBinderã€‚ è¿™äº› BpBinder å¯¹è±¡ä¸­çš„ handle æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºå®ƒä»¬éƒ½æŒ‡å‘åŒä¸€ä¸ªæœåŠ¡ã€‚ è¿™ä¸ª handle æ˜¯ç”¨äºåœ¨åº•å±‚ Binder é©±åŠ¨ä¸­å”¯ä¸€æ ‡è¯†è¯¥æœåŠ¡çš„ã€‚ å¸Œæœ›è¿™ä¸ªå›ç­”èƒ½å¸®åˆ°ä½ ï¼å¦‚æœä½ æœ‰æ›´å¤šé—®é¢˜ï¼Œè¯·éšæ—¶æé—®ã€‚ é—®é¢˜2ï¼šè¯·é—®binderé€šè®¯è¿‡ç¨‹ä¸­æ˜¯å¦å¯ä»¥ä¼ é€’bpbinderå¯¹è±¡ï¼Ÿ æ˜¯çš„ï¼Œåœ¨ Binder é€šä¿¡è¿‡ç¨‹ä¸­å¯ä»¥ä¼ é€’ BpBinder å¯¹è±¡ã€‚ BpBinder æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯ä¾§çš„ Binder å¼•ç”¨ï¼Œå®ƒåœ¨è·¨è¿›ç¨‹é€šä¿¡ä¸­å¯ä»¥è¢«å½“ä½œæ™®é€šçš„ Binder å¯¹è±¡ä¼ é€’ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š åˆ›å»º BpBinder: å®¢æˆ·ç«¯è¿›ç¨‹é€šè¿‡ ServiceManager è·å–æœåŠ¡çš„ BpBinder å¼•ç”¨ã€‚ ä¼ é€’ BpBinder: åœ¨è¿›è¡Œ Binder é€šä¿¡æ—¶ï¼Œè¿™ä¸ª BpBinder å¯ä»¥ä½œä¸ºå‚æ•°é™„å¸¦åœ¨ Parcel ä¸­ä¼ é€’ç»™å…¶ä»–è¿›ç¨‹ã€‚ ä½¿ç”¨ BpBinder: æ¥æ”¶æ–¹è¿›ç¨‹ä¼šæ”¶åˆ°è¿™ä¸ª BpBinder å¼•ç”¨ï¼Œå¹¶å¯ä»¥é€šè¿‡å®ƒä¸åŸæœåŠ¡è¿›è¡Œé€šä¿¡ã€‚ è¿™ç§æœºåˆ¶ä½¿å¾— Binder èƒ½å¤Ÿçµæ´»åœ°æ”¯æŒå¯¹è±¡å¼•ç”¨çš„ä¼ é€’å’Œè·¨è¿›ç¨‹äº¤äº’ï¼Œæ˜¯ Android IPC çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ã€‚ é—®é¢˜3ï¼šè¯·é—®åŒbinder æœåŠ¡ç«¯è¿›ç¨‹è‡ªå·±è¿›ç¨‹å†…éƒ¨å¦‚æœè¿›è¡Œbinderè°ƒç”¨éœ€è¦ç»è¿‡binderé©±åŠ¨å—ï¼Œéœ€è¦å’Œä¸éœ€è¦è¯·è¯¦ç»†æè¿°ï¼Ÿ è¿™ä¸ªè¦çœ‹æƒ…å†µå’Œè°ƒç”¨æ–¹å¼ï¼š ä¸€ é€šè¿‡aidlçš„æ–¹å¼ï¼ŒAIDL æ¥å£ç”Ÿæˆçš„æ—¶å€™ï¼Œæœ‰åŒºåˆ†æ˜¯å¦æ˜¯æœ¬åœ°è¿›ç¨‹è¿˜æ˜¯è¿œç¨‹è¿›ç¨‹ Stub çš„ç©ºæ„é€ å‡½æ•°ã€‚è€ŒStub æœ¬èº«åˆæ˜¯Binder çš„å­ç±»ã€‚è°ƒç”¨äº†Binder çš„attachInterface æ–¹æ³•ã€‚ public Stub() { this.attachInterface(this, DESCRIPTOR); } public void attachInterface(@Nullable IInterface owner, @Nullable String descriptor) { mOwner = owner; mDescriptor = descriptor; } åˆ†åˆ«ä¿å­˜äº†å½“å‰ç±»çš„å®ä¾‹å¯¹è±¡ï¼ˆThisï¼‰å’Œå½“å‰ç±»æ¥å£æè¿°ç¬¦ï¼ˆDESCRIPTORï¼‰ï¼Œå…¶å®å°±æ˜¯ private static final java.lang.String DESCRIPTOR = â€œcom.example.aidlapplication.IMyAidlInterfaceâ€; å½“å‰ç±»çš„å…¨è·¯å¾„ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨ä½¿ç”¨aidl çš„æ—¶å€™æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¿…é¡»è¦ä¿è¯ç›¸åŒè·¯å¾„ä¸‹çš„åŸå› ï¼Œå› ä¸ºä»–è¢«ä¿å­˜ä¸‹æ¥ä½œä¸ºå‚æ•°ç”¨äºæ¯”å¯¹å½“å‰ç±»æ˜¯å¦æ˜¯æœ¬åœ°ç±»è¿˜æ˜¯è¿œç¨‹ã€‚ æ‰€ä»¥åœ¨ IMyAidlInterface iMyAidlInterface = IMyAidlInterface.Stub.asInterface(service) public static com.example.aidlapplication.IMyAidlInterface asInterface(android.os.IBinder obj) { if ((obj==null)) { return null; } android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR); if (((iin!=null)\u0026\u0026(iin instanceof com.example.aidlapplication.IMyAidlInterface))) { return ((com.example.aidlapplication.IMyAidlInterface)iin); } return new com.example.aidlapplication.IMyAidlInterface.Stub.Proxy(obj); } @Override public android.os.IBinder asBinder() { return this; } å‚è€ƒè¿™ç¯‡ï¼šandroid Binder queryLocalInterface æœ¬åœ°ä¸è¿œç¨‹-CSDNåšå®¢ äºŒ é€šè¿‡bind service è¿™ç§æ–¹å¼å¯èƒ½è¿˜æ˜¯è¦é€šè¿‡binderå»è°ƒç”¨ï¼Œä½†åœ¨binderé©±åŠ¨å†…éƒ¨ï¼Œå¯èƒ½è¿˜æ˜¯æœ‰ä¸€å®šçš„ä¼˜åŒ–æµç¨‹ã€‚ #TODO é—®é¢˜4ï¼šAndroid Appè¿›ç¨‹å¤©ç”Ÿæ”¯æŒbinderé€šè®¯çš„åŸç†æ˜¯ä»€ä¹ˆï¼Œåˆšå¼€å§‹åˆå§‹åŒ–æ—¶å€™è‡ªå¸¦äº†å‡ ä¸ªbinderçº¿ç¨‹ï¼Ÿ zygote å¯åŠ¨çš„æ—¶å€™å°±æ”¯æŒäº†binderé€šè®¯ï¼Œæ‰€æœ‰åé¢çš„appå­µåŒ–ä¹‹åï¼Œä¹Ÿä¼šè‡ªå¸¦binderé€šè®¯ã€‚ zygote åœ¨ initçš„æ—¶å€™ï¼š 1. å¯åŠ¨ ProcessState ProcessState::self() 2. å¯åŠ¨çº¿ç¨‹æ± ï¼šproc-\u003estartThreadPool(); virtual void onZygoteInit() { sp\u003cProcessState\u003e proc = ProcessState::self(); ALOGV(\"App process: starting thread pool.\\n\"); proc-\u003estartThreadPool(); } new ProcessState(kDefaultDriver); sp\u003cProcessState\u003e ProcessState::self() { Mutex::Autolock _l(gProcessMutex); if (gProcess != nullptr) { return gProcess; } gProcess = new ProcessState(kDefaultDriver); return gProcess; } mDriverFD(open_driver(driver)) æ‰“å¼€é©±åŠ¨ mMaxThreads(DEFAULT_MAX_BINDER_THREADS) æœ€å¤§çº¿ç¨‹æ•° mmap(0, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, 0); æ˜ å°„å†…å­˜ BINDER_VM_SIZE é»˜è®¤ 1M- 2PageSize ProcessState::ProcessState(const char *driver) : mDriverName(String8(driver)) , mDriverFD(open_driver(driver)) , mVMStart(MAP_FAILED) , mThreadCountLock(PTHREAD_MUTEX_INITIALIZER) , mThreadCountDecrement(PTHREAD_COND_INITIALIZER) , mExecutingThreadsCount(0) , mMaxThreads(DEFAULT_MAX_BINDER_THREADS) , mStarvationStartTimeMs(0) , mManagesContexts(false) , mBinderContextCheckFunc(NULL) , mBinderContextUserData(NULL) , mThreadPoolStarted(false) , mThreadPoolSeq(1) { if (mDriverFD \u003e= 0) { // mmap the binder, providing a chunk of virtual address space to receive transactions. mVMStart = mmap(0, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, 0); if (mVMStart == MAP_FAILED) { // *sigh* ALOGE(\"Using /dev/binder failed: unable to mmap transaction memory.\\n\"); close(mDriverFD); mDriverFD = -1; mDriverName.clear(); } } LOG_ALWAYS_FATAL_IF(mDriverFD \u003c 0, \"Binder driver could not be opened. Terminating.\"); } void IPCThreadState::joinThreadPool(b","date":"2024-11-06","objectID":"/posts/%E6%B1%87%E6%80%BBbinder%E7%9B%B8%E5%85%B3%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/:0:1","tags":["clippings","è½¬è½½","blog"],"title":"æ±‡æ€»binderç›¸å…³ä¸€äº›å¸¸è§é¢è¯•é¢˜-å®‰å“ç³»ç»Ÿå¸¸è§é¢è¯•é¢˜-CSDNåšå®¢","uri":"/posts/%E6%B1%87%E6%80%BBbinder%E7%9B%B8%E5%85%B3%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/#binderè®¨è®ºçš„ä¸€äº›åœºæ™¯é¢è¯•é¢˜"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"binderè®¨è®ºçš„ä¸€äº›åœºæ™¯é¢è¯•é¢˜ é—®é¢˜1ï¼šbinderä¸­æœ‰å¤šä¸ªè¿›ç¨‹ä½œä¸ºå®¢æˆ·ç«¯é€šè¿‡servicemanagerè·å–serviceçš„bpbinderï¼Œbpbinderéƒ½ä¼šæœ‰ä¸€ä¸ªhandleï¼Œé‚£ä¹ˆå¤šä¸ªè¿›ç¨‹è·å–åŒä¸€ä¸ªserviceå¯¹åº”çš„handleä¸€æ ·ä¹ˆï¼Ÿ æ˜¯çš„ï¼Œå¤šä¸ªè¿›ç¨‹è·å–åŒä¸€ä¸ªæœåŠ¡å¯¹åº”çš„ BpBinder çš„ handle æ˜¯ä¸€æ ·çš„ã€‚ åœ¨ Android çš„ Binder IPC æœºåˆ¶ä¸­ï¼ŒServiceManager è´Ÿè´£ç®¡ç†ç³»ç»Ÿä¸­çš„å„ç§æœåŠ¡ã€‚å½“ä¸€ä¸ªå®¢æˆ·ç«¯è¿›ç¨‹è¯·æ±‚æŸä¸ªæœåŠ¡æ—¶ï¼Œå®ƒä¼šé€šè¿‡ ServiceManager è·å–åˆ°æœåŠ¡çš„ Binder å¼•ç”¨ï¼ˆå³ BpBinderï¼‰ï¼Œè¿™ä¸ªå¼•ç”¨åœ¨å†…éƒ¨åŒ…å«äº†ä¸€ä¸ª handleï¼Œè¯¥ handle æ˜¯ä¸€ä¸ªæ•´æ•°å€¼ï¼Œå”¯ä¸€æ ‡è¯†äº†è¿™ä¸ªæœåŠ¡åœ¨ Binder é©±åŠ¨ä¸­çš„ä½ç½®ã€‚ ç”±äºä¸åŒè¿›ç¨‹è·å–çš„éƒ½æ˜¯åŒä¸€ä¸ªæœåŠ¡çš„å¼•ç”¨ï¼Œæ‰€ä»¥å®ƒä»¬è·å–åˆ°çš„ BpBinder ä¸­çš„ handle æ˜¯ç›¸åŒçš„ã€‚è¿™ä¸ª handle ç”¨äºåœ¨ Binder é©±åŠ¨å±‚è¿›è¡Œé€šä¿¡æ—¶æ ‡è¯†ç›®æ ‡æœåŠ¡ï¼Œä»è€Œç¡®ä¿å®¢æˆ·ç«¯è¿›ç¨‹èƒ½å¤Ÿæ­£ç¡®åœ°ä¸ç›®æ ‡æœåŠ¡è¿›è¡Œäº¤äº’ã€‚ æ€»ç»“æ¥è¯´ï¼š ä¸åŒè¿›ç¨‹é€šè¿‡ ServiceManager è·å–åŒä¸€ä¸ªæœåŠ¡çš„ BpBinderã€‚ è¿™äº› BpBinder å¯¹è±¡ä¸­çš„ handle æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºå®ƒä»¬éƒ½æŒ‡å‘åŒä¸€ä¸ªæœåŠ¡ã€‚ è¿™ä¸ª handle æ˜¯ç”¨äºåœ¨åº•å±‚ Binder é©±åŠ¨ä¸­å”¯ä¸€æ ‡è¯†è¯¥æœåŠ¡çš„ã€‚ å¸Œæœ›è¿™ä¸ªå›ç­”èƒ½å¸®åˆ°ä½ ï¼å¦‚æœä½ æœ‰æ›´å¤šé—®é¢˜ï¼Œè¯·éšæ—¶æé—®ã€‚ é—®é¢˜2ï¼šè¯·é—®binderé€šè®¯è¿‡ç¨‹ä¸­æ˜¯å¦å¯ä»¥ä¼ é€’bpbinderå¯¹è±¡ï¼Ÿ æ˜¯çš„ï¼Œåœ¨ Binder é€šä¿¡è¿‡ç¨‹ä¸­å¯ä»¥ä¼ é€’ BpBinder å¯¹è±¡ã€‚ BpBinder æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯ä¾§çš„ Binder å¼•ç”¨ï¼Œå®ƒåœ¨è·¨è¿›ç¨‹é€šä¿¡ä¸­å¯ä»¥è¢«å½“ä½œæ™®é€šçš„ Binder å¯¹è±¡ä¼ é€’ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š åˆ›å»º BpBinder: å®¢æˆ·ç«¯è¿›ç¨‹é€šè¿‡ ServiceManager è·å–æœåŠ¡çš„ BpBinder å¼•ç”¨ã€‚ ä¼ é€’ BpBinder: åœ¨è¿›è¡Œ Binder é€šä¿¡æ—¶ï¼Œè¿™ä¸ª BpBinder å¯ä»¥ä½œä¸ºå‚æ•°é™„å¸¦åœ¨ Parcel ä¸­ä¼ é€’ç»™å…¶ä»–è¿›ç¨‹ã€‚ ä½¿ç”¨ BpBinder: æ¥æ”¶æ–¹è¿›ç¨‹ä¼šæ”¶åˆ°è¿™ä¸ª BpBinder å¼•ç”¨ï¼Œå¹¶å¯ä»¥é€šè¿‡å®ƒä¸åŸæœåŠ¡è¿›è¡Œé€šä¿¡ã€‚ è¿™ç§æœºåˆ¶ä½¿å¾— Binder èƒ½å¤Ÿçµæ´»åœ°æ”¯æŒå¯¹è±¡å¼•ç”¨çš„ä¼ é€’å’Œè·¨è¿›ç¨‹äº¤äº’ï¼Œæ˜¯ Android IPC çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ã€‚ é—®é¢˜3ï¼šè¯·é—®åŒbinder æœåŠ¡ç«¯è¿›ç¨‹è‡ªå·±è¿›ç¨‹å†…éƒ¨å¦‚æœè¿›è¡Œbinderè°ƒç”¨éœ€è¦ç»è¿‡binderé©±åŠ¨å—ï¼Œéœ€è¦å’Œä¸éœ€è¦è¯·è¯¦ç»†æè¿°ï¼Ÿ è¿™ä¸ªè¦çœ‹æƒ…å†µå’Œè°ƒç”¨æ–¹å¼ï¼š ä¸€ é€šè¿‡aidlçš„æ–¹å¼ï¼ŒAIDL æ¥å£ç”Ÿæˆçš„æ—¶å€™ï¼Œæœ‰åŒºåˆ†æ˜¯å¦æ˜¯æœ¬åœ°è¿›ç¨‹è¿˜æ˜¯è¿œç¨‹è¿›ç¨‹ Stub çš„ç©ºæ„é€ å‡½æ•°ã€‚è€ŒStub æœ¬èº«åˆæ˜¯Binder çš„å­ç±»ã€‚è°ƒç”¨äº†Binder çš„attachInterface æ–¹æ³•ã€‚ public Stub() { this.attachInterface(this, DESCRIPTOR); } public void attachInterface(@Nullable IInterface owner, @Nullable String descriptor) { mOwner = owner; mDescriptor = descriptor; } åˆ†åˆ«ä¿å­˜äº†å½“å‰ç±»çš„å®ä¾‹å¯¹è±¡ï¼ˆThisï¼‰å’Œå½“å‰ç±»æ¥å£æè¿°ç¬¦ï¼ˆDESCRIPTORï¼‰ï¼Œå…¶å®å°±æ˜¯ private static final java.lang.String DESCRIPTOR = â€œcom.example.aidlapplication.IMyAidlInterfaceâ€; å½“å‰ç±»çš„å…¨è·¯å¾„ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨ä½¿ç”¨aidl çš„æ—¶å€™æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¿…é¡»è¦ä¿è¯ç›¸åŒè·¯å¾„ä¸‹çš„åŸå› ï¼Œå› ä¸ºä»–è¢«ä¿å­˜ä¸‹æ¥ä½œä¸ºå‚æ•°ç”¨äºæ¯”å¯¹å½“å‰ç±»æ˜¯å¦æ˜¯æœ¬åœ°ç±»è¿˜æ˜¯è¿œç¨‹ã€‚ æ‰€ä»¥åœ¨ IMyAidlInterface iMyAidlInterface = IMyAidlInterface.Stub.asInterface(service) public static com.example.aidlapplication.IMyAidlInterface asInterface(android.os.IBinder obj) { if ((obj==null)) { return null; } android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR); if (((iin!=null)\u0026\u0026(iin instanceof com.example.aidlapplication.IMyAidlInterface))) { return ((com.example.aidlapplication.IMyAidlInterface)iin); } return new com.example.aidlapplication.IMyAidlInterface.Stub.Proxy(obj); } @Override public android.os.IBinder asBinder() { return this; } å‚è€ƒè¿™ç¯‡ï¼šandroid Binder queryLocalInterface æœ¬åœ°ä¸è¿œç¨‹-CSDNåšå®¢ äºŒ é€šè¿‡bind service è¿™ç§æ–¹å¼å¯èƒ½è¿˜æ˜¯è¦é€šè¿‡binderå»è°ƒç”¨ï¼Œä½†åœ¨binderé©±åŠ¨å†…éƒ¨ï¼Œå¯èƒ½è¿˜æ˜¯æœ‰ä¸€å®šçš„ä¼˜åŒ–æµç¨‹ã€‚ #TODO é—®é¢˜4ï¼šAndroid Appè¿›ç¨‹å¤©ç”Ÿæ”¯æŒbinderé€šè®¯çš„åŸç†æ˜¯ä»€ä¹ˆï¼Œåˆšå¼€å§‹åˆå§‹åŒ–æ—¶å€™è‡ªå¸¦äº†å‡ ä¸ªbinderçº¿ç¨‹ï¼Ÿ zygote å¯åŠ¨çš„æ—¶å€™å°±æ”¯æŒäº†binderé€šè®¯ï¼Œæ‰€æœ‰åé¢çš„appå­µåŒ–ä¹‹åï¼Œä¹Ÿä¼šè‡ªå¸¦binderé€šè®¯ã€‚ zygote åœ¨ initçš„æ—¶å€™ï¼š 1. å¯åŠ¨ ProcessState ProcessState::self() 2. å¯åŠ¨çº¿ç¨‹æ± ï¼šproc-\u003estartThreadPool(); virtual void onZygoteInit() { sp proc = ProcessState::self(); ALOGV(\"App process: starting thread pool.\\n\"); proc-\u003estartThreadPool(); } new ProcessState(kDefaultDriver); sp ProcessState::self() { Mutex::Autolock _l(gProcessMutex); if (gProcess != nullptr) { return gProcess; } gProcess = new ProcessState(kDefaultDriver); return gProcess; } mDriverFD(open_driver(driver)) æ‰“å¼€é©±åŠ¨ mMaxThreads(DEFAULT_MAX_BINDER_THREADS) æœ€å¤§çº¿ç¨‹æ•° mmap(0, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, 0); æ˜ å°„å†…å­˜ BINDER_VM_SIZE é»˜è®¤ 1M- 2PageSize ProcessState::ProcessState(const char *driver) : mDriverName(String8(driver)) , mDriverFD(open_driver(driver)) , mVMStart(MAP_FAILED) , mThreadCountLock(PTHREAD_MUTEX_INITIALIZER) , mThreadCountDecrement(PTHREAD_COND_INITIALIZER) , mExecutingThreadsCount(0) , mMaxThreads(DEFAULT_MAX_BINDER_THREADS) , mStarvationStartTimeMs(0) , mManagesContexts(false) , mBinderContextCheckFunc(NULL) , mBinderContextUserData(NULL) , mThreadPoolStarted(false) , mThreadPoolSeq(1) { if (mDriverFD \u003e= 0) { // mmap the binder, providing a chunk of virtual address space to receive transactions. mVMStart = mmap(0, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, 0); if (mVMStart == MAP_FAILED) { // *sigh* ALOGE(\"Using /dev/binder failed: unable to mmap transaction memory.\\n\"); close(mDriverFD); mDriverFD = -1; mDriverName.clear(); } } LOG_ALWAYS_FATAL_IF(mDriverFD \u003c 0, \"Binder driver could not be opened. Terminating.\"); } void IPCThreadState::joinThreadPool(b","date":"2024-11-06","objectID":"/posts/%E6%B1%87%E6%80%BBbinder%E7%9B%B8%E5%85%B3%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/:0:1","tags":["clippings","è½¬è½½","blog"],"title":"æ±‡æ€»binderç›¸å…³ä¸€äº›å¸¸è§é¢è¯•é¢˜-å®‰å“ç³»ç»Ÿå¸¸è§é¢è¯•é¢˜-CSDNåšå®¢","uri":"/posts/%E6%B1%87%E6%80%BBbinder%E7%9B%B8%E5%85%B3%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/#é—®é¢˜1binderä¸­æœ‰å¤šä¸ªè¿›ç¨‹ä½œä¸ºå®¢æˆ·ç«¯é€šè¿‡servicemanagerè·å–serviceçš„bpbinderbpbinderéƒ½ä¼šæœ‰ä¸€ä¸ªhandleé‚£ä¹ˆå¤šä¸ªè¿›ç¨‹è·å–åŒä¸€ä¸ªserviceå¯¹åº”çš„handleä¸€æ ·ä¹ˆ"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"binderè®¨è®ºçš„ä¸€äº›åœºæ™¯é¢è¯•é¢˜ é—®é¢˜1ï¼šbinderä¸­æœ‰å¤šä¸ªè¿›ç¨‹ä½œä¸ºå®¢æˆ·ç«¯é€šè¿‡servicemanagerè·å–serviceçš„bpbinderï¼Œbpbinderéƒ½ä¼šæœ‰ä¸€ä¸ªhandleï¼Œé‚£ä¹ˆå¤šä¸ªè¿›ç¨‹è·å–åŒä¸€ä¸ªserviceå¯¹åº”çš„handleä¸€æ ·ä¹ˆï¼Ÿ æ˜¯çš„ï¼Œå¤šä¸ªè¿›ç¨‹è·å–åŒä¸€ä¸ªæœåŠ¡å¯¹åº”çš„ BpBinder çš„ handle æ˜¯ä¸€æ ·çš„ã€‚ åœ¨ Android çš„ Binder IPC æœºåˆ¶ä¸­ï¼ŒServiceManager è´Ÿè´£ç®¡ç†ç³»ç»Ÿä¸­çš„å„ç§æœåŠ¡ã€‚å½“ä¸€ä¸ªå®¢æˆ·ç«¯è¿›ç¨‹è¯·æ±‚æŸä¸ªæœåŠ¡æ—¶ï¼Œå®ƒä¼šé€šè¿‡ ServiceManager è·å–åˆ°æœåŠ¡çš„ Binder å¼•ç”¨ï¼ˆå³ BpBinderï¼‰ï¼Œè¿™ä¸ªå¼•ç”¨åœ¨å†…éƒ¨åŒ…å«äº†ä¸€ä¸ª handleï¼Œè¯¥ handle æ˜¯ä¸€ä¸ªæ•´æ•°å€¼ï¼Œå”¯ä¸€æ ‡è¯†äº†è¿™ä¸ªæœåŠ¡åœ¨ Binder é©±åŠ¨ä¸­çš„ä½ç½®ã€‚ ç”±äºä¸åŒè¿›ç¨‹è·å–çš„éƒ½æ˜¯åŒä¸€ä¸ªæœåŠ¡çš„å¼•ç”¨ï¼Œæ‰€ä»¥å®ƒä»¬è·å–åˆ°çš„ BpBinder ä¸­çš„ handle æ˜¯ç›¸åŒçš„ã€‚è¿™ä¸ª handle ç”¨äºåœ¨ Binder é©±åŠ¨å±‚è¿›è¡Œé€šä¿¡æ—¶æ ‡è¯†ç›®æ ‡æœåŠ¡ï¼Œä»è€Œç¡®ä¿å®¢æˆ·ç«¯è¿›ç¨‹èƒ½å¤Ÿæ­£ç¡®åœ°ä¸ç›®æ ‡æœåŠ¡è¿›è¡Œäº¤äº’ã€‚ æ€»ç»“æ¥è¯´ï¼š ä¸åŒè¿›ç¨‹é€šè¿‡ ServiceManager è·å–åŒä¸€ä¸ªæœåŠ¡çš„ BpBinderã€‚ è¿™äº› BpBinder å¯¹è±¡ä¸­çš„ handle æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºå®ƒä»¬éƒ½æŒ‡å‘åŒä¸€ä¸ªæœåŠ¡ã€‚ è¿™ä¸ª handle æ˜¯ç”¨äºåœ¨åº•å±‚ Binder é©±åŠ¨ä¸­å”¯ä¸€æ ‡è¯†è¯¥æœåŠ¡çš„ã€‚ å¸Œæœ›è¿™ä¸ªå›ç­”èƒ½å¸®åˆ°ä½ ï¼å¦‚æœä½ æœ‰æ›´å¤šé—®é¢˜ï¼Œè¯·éšæ—¶æé—®ã€‚ é—®é¢˜2ï¼šè¯·é—®binderé€šè®¯è¿‡ç¨‹ä¸­æ˜¯å¦å¯ä»¥ä¼ é€’bpbinderå¯¹è±¡ï¼Ÿ æ˜¯çš„ï¼Œåœ¨ Binder é€šä¿¡è¿‡ç¨‹ä¸­å¯ä»¥ä¼ é€’ BpBinder å¯¹è±¡ã€‚ BpBinder æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯ä¾§çš„ Binder å¼•ç”¨ï¼Œå®ƒåœ¨è·¨è¿›ç¨‹é€šä¿¡ä¸­å¯ä»¥è¢«å½“ä½œæ™®é€šçš„ Binder å¯¹è±¡ä¼ é€’ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š åˆ›å»º BpBinder: å®¢æˆ·ç«¯è¿›ç¨‹é€šè¿‡ ServiceManager è·å–æœåŠ¡çš„ BpBinder å¼•ç”¨ã€‚ ä¼ é€’ BpBinder: åœ¨è¿›è¡Œ Binder é€šä¿¡æ—¶ï¼Œè¿™ä¸ª BpBinder å¯ä»¥ä½œä¸ºå‚æ•°é™„å¸¦åœ¨ Parcel ä¸­ä¼ é€’ç»™å…¶ä»–è¿›ç¨‹ã€‚ ä½¿ç”¨ BpBinder: æ¥æ”¶æ–¹è¿›ç¨‹ä¼šæ”¶åˆ°è¿™ä¸ª BpBinder å¼•ç”¨ï¼Œå¹¶å¯ä»¥é€šè¿‡å®ƒä¸åŸæœåŠ¡è¿›è¡Œé€šä¿¡ã€‚ è¿™ç§æœºåˆ¶ä½¿å¾— Binder èƒ½å¤Ÿçµæ´»åœ°æ”¯æŒå¯¹è±¡å¼•ç”¨çš„ä¼ é€’å’Œè·¨è¿›ç¨‹äº¤äº’ï¼Œæ˜¯ Android IPC çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ã€‚ é—®é¢˜3ï¼šè¯·é—®åŒbinder æœåŠ¡ç«¯è¿›ç¨‹è‡ªå·±è¿›ç¨‹å†…éƒ¨å¦‚æœè¿›è¡Œbinderè°ƒç”¨éœ€è¦ç»è¿‡binderé©±åŠ¨å—ï¼Œéœ€è¦å’Œä¸éœ€è¦è¯·è¯¦ç»†æè¿°ï¼Ÿ è¿™ä¸ªè¦çœ‹æƒ…å†µå’Œè°ƒç”¨æ–¹å¼ï¼š ä¸€ é€šè¿‡aidlçš„æ–¹å¼ï¼ŒAIDL æ¥å£ç”Ÿæˆçš„æ—¶å€™ï¼Œæœ‰åŒºåˆ†æ˜¯å¦æ˜¯æœ¬åœ°è¿›ç¨‹è¿˜æ˜¯è¿œç¨‹è¿›ç¨‹ Stub çš„ç©ºæ„é€ å‡½æ•°ã€‚è€ŒStub æœ¬èº«åˆæ˜¯Binder çš„å­ç±»ã€‚è°ƒç”¨äº†Binder çš„attachInterface æ–¹æ³•ã€‚ public Stub() { this.attachInterface(this, DESCRIPTOR); } public void attachInterface(@Nullable IInterface owner, @Nullable String descriptor) { mOwner = owner; mDescriptor = descriptor; } åˆ†åˆ«ä¿å­˜äº†å½“å‰ç±»çš„å®ä¾‹å¯¹è±¡ï¼ˆThisï¼‰å’Œå½“å‰ç±»æ¥å£æè¿°ç¬¦ï¼ˆDESCRIPTORï¼‰ï¼Œå…¶å®å°±æ˜¯ private static final java.lang.String DESCRIPTOR = â€œcom.example.aidlapplication.IMyAidlInterfaceâ€; å½“å‰ç±»çš„å…¨è·¯å¾„ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨ä½¿ç”¨aidl çš„æ—¶å€™æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¿…é¡»è¦ä¿è¯ç›¸åŒè·¯å¾„ä¸‹çš„åŸå› ï¼Œå› ä¸ºä»–è¢«ä¿å­˜ä¸‹æ¥ä½œä¸ºå‚æ•°ç”¨äºæ¯”å¯¹å½“å‰ç±»æ˜¯å¦æ˜¯æœ¬åœ°ç±»è¿˜æ˜¯è¿œç¨‹ã€‚ æ‰€ä»¥åœ¨ IMyAidlInterface iMyAidlInterface = IMyAidlInterface.Stub.asInterface(service) public static com.example.aidlapplication.IMyAidlInterface asInterface(android.os.IBinder obj) { if ((obj==null)) { return null; } android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR); if (((iin!=null)\u0026\u0026(iin instanceof com.example.aidlapplication.IMyAidlInterface))) { return ((com.example.aidlapplication.IMyAidlInterface)iin); } return new com.example.aidlapplication.IMyAidlInterface.Stub.Proxy(obj); } @Override public android.os.IBinder asBinder() { return this; } å‚è€ƒè¿™ç¯‡ï¼šandroid Binder queryLocalInterface æœ¬åœ°ä¸è¿œç¨‹-CSDNåšå®¢ äºŒ é€šè¿‡bind service è¿™ç§æ–¹å¼å¯èƒ½è¿˜æ˜¯è¦é€šè¿‡binderå»è°ƒç”¨ï¼Œä½†åœ¨binderé©±åŠ¨å†…éƒ¨ï¼Œå¯èƒ½è¿˜æ˜¯æœ‰ä¸€å®šçš„ä¼˜åŒ–æµç¨‹ã€‚ #TODO é—®é¢˜4ï¼šAndroid Appè¿›ç¨‹å¤©ç”Ÿæ”¯æŒbinderé€šè®¯çš„åŸç†æ˜¯ä»€ä¹ˆï¼Œåˆšå¼€å§‹åˆå§‹åŒ–æ—¶å€™è‡ªå¸¦äº†å‡ ä¸ªbinderçº¿ç¨‹ï¼Ÿ zygote å¯åŠ¨çš„æ—¶å€™å°±æ”¯æŒäº†binderé€šè®¯ï¼Œæ‰€æœ‰åé¢çš„appå­µåŒ–ä¹‹åï¼Œä¹Ÿä¼šè‡ªå¸¦binderé€šè®¯ã€‚ zygote åœ¨ initçš„æ—¶å€™ï¼š 1. å¯åŠ¨ ProcessState ProcessState::self() 2. å¯åŠ¨çº¿ç¨‹æ± ï¼šproc-\u003estartThreadPool(); virtual void onZygoteInit() { sp proc = ProcessState::self(); ALOGV(\"App process: starting thread pool.\\n\"); proc-\u003estartThreadPool(); } new ProcessState(kDefaultDriver); sp ProcessState::self() { Mutex::Autolock _l(gProcessMutex); if (gProcess != nullptr) { return gProcess; } gProcess = new ProcessState(kDefaultDriver); return gProcess; } mDriverFD(open_driver(driver)) æ‰“å¼€é©±åŠ¨ mMaxThreads(DEFAULT_MAX_BINDER_THREADS) æœ€å¤§çº¿ç¨‹æ•° mmap(0, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, 0); æ˜ å°„å†…å­˜ BINDER_VM_SIZE é»˜è®¤ 1M- 2PageSize ProcessState::ProcessState(const char *driver) : mDriverName(String8(driver)) , mDriverFD(open_driver(driver)) , mVMStart(MAP_FAILED) , mThreadCountLock(PTHREAD_MUTEX_INITIALIZER) , mThreadCountDecrement(PTHREAD_COND_INITIALIZER) , mExecutingThreadsCount(0) , mMaxThreads(DEFAULT_MAX_BINDER_THREADS) , mStarvationStartTimeMs(0) , mManagesContexts(false) , mBinderContextCheckFunc(NULL) , mBinderContextUserData(NULL) , mThreadPoolStarted(false) , mThreadPoolSeq(1) { if (mDriverFD \u003e= 0) { // mmap the binder, providing a chunk of virtual address space to receive transactions. mVMStart = mmap(0, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, 0); if (mVMStart == MAP_FAILED) { // *sigh* ALOGE(\"Using /dev/binder failed: unable to mmap transaction memory.\\n\"); close(mDriverFD); mDriverFD = -1; mDriverName.clear(); } } LOG_ALWAYS_FATAL_IF(mDriverFD \u003c 0, \"Binder driver could not be opened. Terminating.\"); } void IPCThreadState::joinThreadPool(b","date":"2024-11-06","objectID":"/posts/%E6%B1%87%E6%80%BBbinder%E7%9B%B8%E5%85%B3%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/:0:1","tags":["clippings","è½¬è½½","blog"],"title":"æ±‡æ€»binderç›¸å…³ä¸€äº›å¸¸è§é¢è¯•é¢˜-å®‰å“ç³»ç»Ÿå¸¸è§é¢è¯•é¢˜-CSDNåšå®¢","uri":"/posts/%E6%B1%87%E6%80%BBbinder%E7%9B%B8%E5%85%B3%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/#é—®é¢˜2è¯·é—®binderé€šè®¯è¿‡ç¨‹ä¸­æ˜¯å¦å¯ä»¥ä¼ é€’bpbinderå¯¹è±¡"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"binderè®¨è®ºçš„ä¸€äº›åœºæ™¯é¢è¯•é¢˜ é—®é¢˜1ï¼šbinderä¸­æœ‰å¤šä¸ªè¿›ç¨‹ä½œä¸ºå®¢æˆ·ç«¯é€šè¿‡servicemanagerè·å–serviceçš„bpbinderï¼Œbpbinderéƒ½ä¼šæœ‰ä¸€ä¸ªhandleï¼Œé‚£ä¹ˆå¤šä¸ªè¿›ç¨‹è·å–åŒä¸€ä¸ªserviceå¯¹åº”çš„handleä¸€æ ·ä¹ˆï¼Ÿ æ˜¯çš„ï¼Œå¤šä¸ªè¿›ç¨‹è·å–åŒä¸€ä¸ªæœåŠ¡å¯¹åº”çš„ BpBinder çš„ handle æ˜¯ä¸€æ ·çš„ã€‚ åœ¨ Android çš„ Binder IPC æœºåˆ¶ä¸­ï¼ŒServiceManager è´Ÿè´£ç®¡ç†ç³»ç»Ÿä¸­çš„å„ç§æœåŠ¡ã€‚å½“ä¸€ä¸ªå®¢æˆ·ç«¯è¿›ç¨‹è¯·æ±‚æŸä¸ªæœåŠ¡æ—¶ï¼Œå®ƒä¼šé€šè¿‡ ServiceManager è·å–åˆ°æœåŠ¡çš„ Binder å¼•ç”¨ï¼ˆå³ BpBinderï¼‰ï¼Œè¿™ä¸ªå¼•ç”¨åœ¨å†…éƒ¨åŒ…å«äº†ä¸€ä¸ª handleï¼Œè¯¥ handle æ˜¯ä¸€ä¸ªæ•´æ•°å€¼ï¼Œå”¯ä¸€æ ‡è¯†äº†è¿™ä¸ªæœåŠ¡åœ¨ Binder é©±åŠ¨ä¸­çš„ä½ç½®ã€‚ ç”±äºä¸åŒè¿›ç¨‹è·å–çš„éƒ½æ˜¯åŒä¸€ä¸ªæœåŠ¡çš„å¼•ç”¨ï¼Œæ‰€ä»¥å®ƒä»¬è·å–åˆ°çš„ BpBinder ä¸­çš„ handle æ˜¯ç›¸åŒçš„ã€‚è¿™ä¸ª handle ç”¨äºåœ¨ Binder é©±åŠ¨å±‚è¿›è¡Œé€šä¿¡æ—¶æ ‡è¯†ç›®æ ‡æœåŠ¡ï¼Œä»è€Œç¡®ä¿å®¢æˆ·ç«¯è¿›ç¨‹èƒ½å¤Ÿæ­£ç¡®åœ°ä¸ç›®æ ‡æœåŠ¡è¿›è¡Œäº¤äº’ã€‚ æ€»ç»“æ¥è¯´ï¼š ä¸åŒè¿›ç¨‹é€šè¿‡ ServiceManager è·å–åŒä¸€ä¸ªæœåŠ¡çš„ BpBinderã€‚ è¿™äº› BpBinder å¯¹è±¡ä¸­çš„ handle æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºå®ƒä»¬éƒ½æŒ‡å‘åŒä¸€ä¸ªæœåŠ¡ã€‚ è¿™ä¸ª handle æ˜¯ç”¨äºåœ¨åº•å±‚ Binder é©±åŠ¨ä¸­å”¯ä¸€æ ‡è¯†è¯¥æœåŠ¡çš„ã€‚ å¸Œæœ›è¿™ä¸ªå›ç­”èƒ½å¸®åˆ°ä½ ï¼å¦‚æœä½ æœ‰æ›´å¤šé—®é¢˜ï¼Œè¯·éšæ—¶æé—®ã€‚ é—®é¢˜2ï¼šè¯·é—®binderé€šè®¯è¿‡ç¨‹ä¸­æ˜¯å¦å¯ä»¥ä¼ é€’bpbinderå¯¹è±¡ï¼Ÿ æ˜¯çš„ï¼Œåœ¨ Binder é€šä¿¡è¿‡ç¨‹ä¸­å¯ä»¥ä¼ é€’ BpBinder å¯¹è±¡ã€‚ BpBinder æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯ä¾§çš„ Binder å¼•ç”¨ï¼Œå®ƒåœ¨è·¨è¿›ç¨‹é€šä¿¡ä¸­å¯ä»¥è¢«å½“ä½œæ™®é€šçš„ Binder å¯¹è±¡ä¼ é€’ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š åˆ›å»º BpBinder: å®¢æˆ·ç«¯è¿›ç¨‹é€šè¿‡ ServiceManager è·å–æœåŠ¡çš„ BpBinder å¼•ç”¨ã€‚ ä¼ é€’ BpBinder: åœ¨è¿›è¡Œ Binder é€šä¿¡æ—¶ï¼Œè¿™ä¸ª BpBinder å¯ä»¥ä½œä¸ºå‚æ•°é™„å¸¦åœ¨ Parcel ä¸­ä¼ é€’ç»™å…¶ä»–è¿›ç¨‹ã€‚ ä½¿ç”¨ BpBinder: æ¥æ”¶æ–¹è¿›ç¨‹ä¼šæ”¶åˆ°è¿™ä¸ª BpBinder å¼•ç”¨ï¼Œå¹¶å¯ä»¥é€šè¿‡å®ƒä¸åŸæœåŠ¡è¿›è¡Œé€šä¿¡ã€‚ è¿™ç§æœºåˆ¶ä½¿å¾— Binder èƒ½å¤Ÿçµæ´»åœ°æ”¯æŒå¯¹è±¡å¼•ç”¨çš„ä¼ é€’å’Œè·¨è¿›ç¨‹äº¤äº’ï¼Œæ˜¯ Android IPC çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ã€‚ é—®é¢˜3ï¼šè¯·é—®åŒbinder æœåŠ¡ç«¯è¿›ç¨‹è‡ªå·±è¿›ç¨‹å†…éƒ¨å¦‚æœè¿›è¡Œbinderè°ƒç”¨éœ€è¦ç»è¿‡binderé©±åŠ¨å—ï¼Œéœ€è¦å’Œä¸éœ€è¦è¯·è¯¦ç»†æè¿°ï¼Ÿ è¿™ä¸ªè¦çœ‹æƒ…å†µå’Œè°ƒç”¨æ–¹å¼ï¼š ä¸€ é€šè¿‡aidlçš„æ–¹å¼ï¼ŒAIDL æ¥å£ç”Ÿæˆçš„æ—¶å€™ï¼Œæœ‰åŒºåˆ†æ˜¯å¦æ˜¯æœ¬åœ°è¿›ç¨‹è¿˜æ˜¯è¿œç¨‹è¿›ç¨‹ Stub çš„ç©ºæ„é€ å‡½æ•°ã€‚è€ŒStub æœ¬èº«åˆæ˜¯Binder çš„å­ç±»ã€‚è°ƒç”¨äº†Binder çš„attachInterface æ–¹æ³•ã€‚ public Stub() { this.attachInterface(this, DESCRIPTOR); } public void attachInterface(@Nullable IInterface owner, @Nullable String descriptor) { mOwner = owner; mDescriptor = descriptor; } åˆ†åˆ«ä¿å­˜äº†å½“å‰ç±»çš„å®ä¾‹å¯¹è±¡ï¼ˆThisï¼‰å’Œå½“å‰ç±»æ¥å£æè¿°ç¬¦ï¼ˆDESCRIPTORï¼‰ï¼Œå…¶å®å°±æ˜¯ private static final java.lang.String DESCRIPTOR = â€œcom.example.aidlapplication.IMyAidlInterfaceâ€; å½“å‰ç±»çš„å…¨è·¯å¾„ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨ä½¿ç”¨aidl çš„æ—¶å€™æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¿…é¡»è¦ä¿è¯ç›¸åŒè·¯å¾„ä¸‹çš„åŸå› ï¼Œå› ä¸ºä»–è¢«ä¿å­˜ä¸‹æ¥ä½œä¸ºå‚æ•°ç”¨äºæ¯”å¯¹å½“å‰ç±»æ˜¯å¦æ˜¯æœ¬åœ°ç±»è¿˜æ˜¯è¿œç¨‹ã€‚ æ‰€ä»¥åœ¨ IMyAidlInterface iMyAidlInterface = IMyAidlInterface.Stub.asInterface(service) public static com.example.aidlapplication.IMyAidlInterface asInterface(android.os.IBinder obj) { if ((obj==null)) { return null; } android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR); if (((iin!=null)\u0026\u0026(iin instanceof com.example.aidlapplication.IMyAidlInterface))) { return ((com.example.aidlapplication.IMyAidlInterface)iin); } return new com.example.aidlapplication.IMyAidlInterface.Stub.Proxy(obj); } @Override public android.os.IBinder asBinder() { return this; } å‚è€ƒè¿™ç¯‡ï¼šandroid Binder queryLocalInterface æœ¬åœ°ä¸è¿œç¨‹-CSDNåšå®¢ äºŒ é€šè¿‡bind service è¿™ç§æ–¹å¼å¯èƒ½è¿˜æ˜¯è¦é€šè¿‡binderå»è°ƒç”¨ï¼Œä½†åœ¨binderé©±åŠ¨å†…éƒ¨ï¼Œå¯èƒ½è¿˜æ˜¯æœ‰ä¸€å®šçš„ä¼˜åŒ–æµç¨‹ã€‚ #TODO é—®é¢˜4ï¼šAndroid Appè¿›ç¨‹å¤©ç”Ÿæ”¯æŒbinderé€šè®¯çš„åŸç†æ˜¯ä»€ä¹ˆï¼Œåˆšå¼€å§‹åˆå§‹åŒ–æ—¶å€™è‡ªå¸¦äº†å‡ ä¸ªbinderçº¿ç¨‹ï¼Ÿ zygote å¯åŠ¨çš„æ—¶å€™å°±æ”¯æŒäº†binderé€šè®¯ï¼Œæ‰€æœ‰åé¢çš„appå­µåŒ–ä¹‹åï¼Œä¹Ÿä¼šè‡ªå¸¦binderé€šè®¯ã€‚ zygote åœ¨ initçš„æ—¶å€™ï¼š 1. å¯åŠ¨ ProcessState ProcessState::self() 2. å¯åŠ¨çº¿ç¨‹æ± ï¼šproc-\u003estartThreadPool(); virtual void onZygoteInit() { sp proc = ProcessState::self(); ALOGV(\"App process: starting thread pool.\\n\"); proc-\u003estartThreadPool(); } new ProcessState(kDefaultDriver); sp ProcessState::self() { Mutex::Autolock _l(gProcessMutex); if (gProcess != nullptr) { return gProcess; } gProcess = new ProcessState(kDefaultDriver); return gProcess; } mDriverFD(open_driver(driver)) æ‰“å¼€é©±åŠ¨ mMaxThreads(DEFAULT_MAX_BINDER_THREADS) æœ€å¤§çº¿ç¨‹æ•° mmap(0, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, 0); æ˜ å°„å†…å­˜ BINDER_VM_SIZE é»˜è®¤ 1M- 2PageSize ProcessState::ProcessState(const char *driver) : mDriverName(String8(driver)) , mDriverFD(open_driver(driver)) , mVMStart(MAP_FAILED) , mThreadCountLock(PTHREAD_MUTEX_INITIALIZER) , mThreadCountDecrement(PTHREAD_COND_INITIALIZER) , mExecutingThreadsCount(0) , mMaxThreads(DEFAULT_MAX_BINDER_THREADS) , mStarvationStartTimeMs(0) , mManagesContexts(false) , mBinderContextCheckFunc(NULL) , mBinderContextUserData(NULL) , mThreadPoolStarted(false) , mThreadPoolSeq(1) { if (mDriverFD \u003e= 0) { // mmap the binder, providing a chunk of virtual address space to receive transactions. mVMStart = mmap(0, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, 0); if (mVMStart == MAP_FAILED) { // *sigh* ALOGE(\"Using /dev/binder failed: unable to mmap transaction memory.\\n\"); close(mDriverFD); mDriverFD = -1; mDriverName.clear(); } } LOG_ALWAYS_FATAL_IF(mDriverFD \u003c 0, \"Binder driver could not be opened. Terminating.\"); } void IPCThreadState::joinThreadPool(b","date":"2024-11-06","objectID":"/posts/%E6%B1%87%E6%80%BBbinder%E7%9B%B8%E5%85%B3%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/:0:1","tags":["clippings","è½¬è½½","blog"],"title":"æ±‡æ€»binderç›¸å…³ä¸€äº›å¸¸è§é¢è¯•é¢˜-å®‰å“ç³»ç»Ÿå¸¸è§é¢è¯•é¢˜-CSDNåšå®¢","uri":"/posts/%E6%B1%87%E6%80%BBbinder%E7%9B%B8%E5%85%B3%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/#é—®é¢˜3è¯·é—®åŒbinder-æœåŠ¡ç«¯è¿›ç¨‹è‡ªå·±è¿›ç¨‹å†…éƒ¨å¦‚æœè¿›è¡Œbinderè°ƒç”¨éœ€è¦ç»è¿‡binderé©±åŠ¨å—éœ€è¦å’Œä¸éœ€è¦è¯·è¯¦ç»†æè¿°"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"binderè®¨è®ºçš„ä¸€äº›åœºæ™¯é¢è¯•é¢˜ é—®é¢˜1ï¼šbinderä¸­æœ‰å¤šä¸ªè¿›ç¨‹ä½œä¸ºå®¢æˆ·ç«¯é€šè¿‡servicemanagerè·å–serviceçš„bpbinderï¼Œbpbinderéƒ½ä¼šæœ‰ä¸€ä¸ªhandleï¼Œé‚£ä¹ˆå¤šä¸ªè¿›ç¨‹è·å–åŒä¸€ä¸ªserviceå¯¹åº”çš„handleä¸€æ ·ä¹ˆï¼Ÿ æ˜¯çš„ï¼Œå¤šä¸ªè¿›ç¨‹è·å–åŒä¸€ä¸ªæœåŠ¡å¯¹åº”çš„ BpBinder çš„ handle æ˜¯ä¸€æ ·çš„ã€‚ åœ¨ Android çš„ Binder IPC æœºåˆ¶ä¸­ï¼ŒServiceManager è´Ÿè´£ç®¡ç†ç³»ç»Ÿä¸­çš„å„ç§æœåŠ¡ã€‚å½“ä¸€ä¸ªå®¢æˆ·ç«¯è¿›ç¨‹è¯·æ±‚æŸä¸ªæœåŠ¡æ—¶ï¼Œå®ƒä¼šé€šè¿‡ ServiceManager è·å–åˆ°æœåŠ¡çš„ Binder å¼•ç”¨ï¼ˆå³ BpBinderï¼‰ï¼Œè¿™ä¸ªå¼•ç”¨åœ¨å†…éƒ¨åŒ…å«äº†ä¸€ä¸ª handleï¼Œè¯¥ handle æ˜¯ä¸€ä¸ªæ•´æ•°å€¼ï¼Œå”¯ä¸€æ ‡è¯†äº†è¿™ä¸ªæœåŠ¡åœ¨ Binder é©±åŠ¨ä¸­çš„ä½ç½®ã€‚ ç”±äºä¸åŒè¿›ç¨‹è·å–çš„éƒ½æ˜¯åŒä¸€ä¸ªæœåŠ¡çš„å¼•ç”¨ï¼Œæ‰€ä»¥å®ƒä»¬è·å–åˆ°çš„ BpBinder ä¸­çš„ handle æ˜¯ç›¸åŒçš„ã€‚è¿™ä¸ª handle ç”¨äºåœ¨ Binder é©±åŠ¨å±‚è¿›è¡Œé€šä¿¡æ—¶æ ‡è¯†ç›®æ ‡æœåŠ¡ï¼Œä»è€Œç¡®ä¿å®¢æˆ·ç«¯è¿›ç¨‹èƒ½å¤Ÿæ­£ç¡®åœ°ä¸ç›®æ ‡æœåŠ¡è¿›è¡Œäº¤äº’ã€‚ æ€»ç»“æ¥è¯´ï¼š ä¸åŒè¿›ç¨‹é€šè¿‡ ServiceManager è·å–åŒä¸€ä¸ªæœåŠ¡çš„ BpBinderã€‚ è¿™äº› BpBinder å¯¹è±¡ä¸­çš„ handle æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºå®ƒä»¬éƒ½æŒ‡å‘åŒä¸€ä¸ªæœåŠ¡ã€‚ è¿™ä¸ª handle æ˜¯ç”¨äºåœ¨åº•å±‚ Binder é©±åŠ¨ä¸­å”¯ä¸€æ ‡è¯†è¯¥æœåŠ¡çš„ã€‚ å¸Œæœ›è¿™ä¸ªå›ç­”èƒ½å¸®åˆ°ä½ ï¼å¦‚æœä½ æœ‰æ›´å¤šé—®é¢˜ï¼Œè¯·éšæ—¶æé—®ã€‚ é—®é¢˜2ï¼šè¯·é—®binderé€šè®¯è¿‡ç¨‹ä¸­æ˜¯å¦å¯ä»¥ä¼ é€’bpbinderå¯¹è±¡ï¼Ÿ æ˜¯çš„ï¼Œåœ¨ Binder é€šä¿¡è¿‡ç¨‹ä¸­å¯ä»¥ä¼ é€’ BpBinder å¯¹è±¡ã€‚ BpBinder æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯ä¾§çš„ Binder å¼•ç”¨ï¼Œå®ƒåœ¨è·¨è¿›ç¨‹é€šä¿¡ä¸­å¯ä»¥è¢«å½“ä½œæ™®é€šçš„ Binder å¯¹è±¡ä¼ é€’ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š åˆ›å»º BpBinder: å®¢æˆ·ç«¯è¿›ç¨‹é€šè¿‡ ServiceManager è·å–æœåŠ¡çš„ BpBinder å¼•ç”¨ã€‚ ä¼ é€’ BpBinder: åœ¨è¿›è¡Œ Binder é€šä¿¡æ—¶ï¼Œè¿™ä¸ª BpBinder å¯ä»¥ä½œä¸ºå‚æ•°é™„å¸¦åœ¨ Parcel ä¸­ä¼ é€’ç»™å…¶ä»–è¿›ç¨‹ã€‚ ä½¿ç”¨ BpBinder: æ¥æ”¶æ–¹è¿›ç¨‹ä¼šæ”¶åˆ°è¿™ä¸ª BpBinder å¼•ç”¨ï¼Œå¹¶å¯ä»¥é€šè¿‡å®ƒä¸åŸæœåŠ¡è¿›è¡Œé€šä¿¡ã€‚ è¿™ç§æœºåˆ¶ä½¿å¾— Binder èƒ½å¤Ÿçµæ´»åœ°æ”¯æŒå¯¹è±¡å¼•ç”¨çš„ä¼ é€’å’Œè·¨è¿›ç¨‹äº¤äº’ï¼Œæ˜¯ Android IPC çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ã€‚ é—®é¢˜3ï¼šè¯·é—®åŒbinder æœåŠ¡ç«¯è¿›ç¨‹è‡ªå·±è¿›ç¨‹å†…éƒ¨å¦‚æœè¿›è¡Œbinderè°ƒç”¨éœ€è¦ç»è¿‡binderé©±åŠ¨å—ï¼Œéœ€è¦å’Œä¸éœ€è¦è¯·è¯¦ç»†æè¿°ï¼Ÿ è¿™ä¸ªè¦çœ‹æƒ…å†µå’Œè°ƒç”¨æ–¹å¼ï¼š ä¸€ é€šè¿‡aidlçš„æ–¹å¼ï¼ŒAIDL æ¥å£ç”Ÿæˆçš„æ—¶å€™ï¼Œæœ‰åŒºåˆ†æ˜¯å¦æ˜¯æœ¬åœ°è¿›ç¨‹è¿˜æ˜¯è¿œç¨‹è¿›ç¨‹ Stub çš„ç©ºæ„é€ å‡½æ•°ã€‚è€ŒStub æœ¬èº«åˆæ˜¯Binder çš„å­ç±»ã€‚è°ƒç”¨äº†Binder çš„attachInterface æ–¹æ³•ã€‚ public Stub() { this.attachInterface(this, DESCRIPTOR); } public void attachInterface(@Nullable IInterface owner, @Nullable String descriptor) { mOwner = owner; mDescriptor = descriptor; } åˆ†åˆ«ä¿å­˜äº†å½“å‰ç±»çš„å®ä¾‹å¯¹è±¡ï¼ˆThisï¼‰å’Œå½“å‰ç±»æ¥å£æè¿°ç¬¦ï¼ˆDESCRIPTORï¼‰ï¼Œå…¶å®å°±æ˜¯ private static final java.lang.String DESCRIPTOR = â€œcom.example.aidlapplication.IMyAidlInterfaceâ€; å½“å‰ç±»çš„å…¨è·¯å¾„ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨ä½¿ç”¨aidl çš„æ—¶å€™æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¿…é¡»è¦ä¿è¯ç›¸åŒè·¯å¾„ä¸‹çš„åŸå› ï¼Œå› ä¸ºä»–è¢«ä¿å­˜ä¸‹æ¥ä½œä¸ºå‚æ•°ç”¨äºæ¯”å¯¹å½“å‰ç±»æ˜¯å¦æ˜¯æœ¬åœ°ç±»è¿˜æ˜¯è¿œç¨‹ã€‚ æ‰€ä»¥åœ¨ IMyAidlInterface iMyAidlInterface = IMyAidlInterface.Stub.asInterface(service) public static com.example.aidlapplication.IMyAidlInterface asInterface(android.os.IBinder obj) { if ((obj==null)) { return null; } android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR); if (((iin!=null)\u0026\u0026(iin instanceof com.example.aidlapplication.IMyAidlInterface))) { return ((com.example.aidlapplication.IMyAidlInterface)iin); } return new com.example.aidlapplication.IMyAidlInterface.Stub.Proxy(obj); } @Override public android.os.IBinder asBinder() { return this; } å‚è€ƒè¿™ç¯‡ï¼šandroid Binder queryLocalInterface æœ¬åœ°ä¸è¿œç¨‹-CSDNåšå®¢ äºŒ é€šè¿‡bind service è¿™ç§æ–¹å¼å¯èƒ½è¿˜æ˜¯è¦é€šè¿‡binderå»è°ƒç”¨ï¼Œä½†åœ¨binderé©±åŠ¨å†…éƒ¨ï¼Œå¯èƒ½è¿˜æ˜¯æœ‰ä¸€å®šçš„ä¼˜åŒ–æµç¨‹ã€‚ #TODO é—®é¢˜4ï¼šAndroid Appè¿›ç¨‹å¤©ç”Ÿæ”¯æŒbinderé€šè®¯çš„åŸç†æ˜¯ä»€ä¹ˆï¼Œåˆšå¼€å§‹åˆå§‹åŒ–æ—¶å€™è‡ªå¸¦äº†å‡ ä¸ªbinderçº¿ç¨‹ï¼Ÿ zygote å¯åŠ¨çš„æ—¶å€™å°±æ”¯æŒäº†binderé€šè®¯ï¼Œæ‰€æœ‰åé¢çš„appå­µåŒ–ä¹‹åï¼Œä¹Ÿä¼šè‡ªå¸¦binderé€šè®¯ã€‚ zygote åœ¨ initçš„æ—¶å€™ï¼š 1. å¯åŠ¨ ProcessState ProcessState::self() 2. å¯åŠ¨çº¿ç¨‹æ± ï¼šproc-\u003estartThreadPool(); virtual void onZygoteInit() { sp proc = ProcessState::self(); ALOGV(\"App process: starting thread pool.\\n\"); proc-\u003estartThreadPool(); } new ProcessState(kDefaultDriver); sp ProcessState::self() { Mutex::Autolock _l(gProcessMutex); if (gProcess != nullptr) { return gProcess; } gProcess = new ProcessState(kDefaultDriver); return gProcess; } mDriverFD(open_driver(driver)) æ‰“å¼€é©±åŠ¨ mMaxThreads(DEFAULT_MAX_BINDER_THREADS) æœ€å¤§çº¿ç¨‹æ•° mmap(0, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, 0); æ˜ å°„å†…å­˜ BINDER_VM_SIZE é»˜è®¤ 1M- 2PageSize ProcessState::ProcessState(const char *driver) : mDriverName(String8(driver)) , mDriverFD(open_driver(driver)) , mVMStart(MAP_FAILED) , mThreadCountLock(PTHREAD_MUTEX_INITIALIZER) , mThreadCountDecrement(PTHREAD_COND_INITIALIZER) , mExecutingThreadsCount(0) , mMaxThreads(DEFAULT_MAX_BINDER_THREADS) , mStarvationStartTimeMs(0) , mManagesContexts(false) , mBinderContextCheckFunc(NULL) , mBinderContextUserData(NULL) , mThreadPoolStarted(false) , mThreadPoolSeq(1) { if (mDriverFD \u003e= 0) { // mmap the binder, providing a chunk of virtual address space to receive transactions. mVMStart = mmap(0, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, 0); if (mVMStart == MAP_FAILED) { // *sigh* ALOGE(\"Using /dev/binder failed: unable to mmap transaction memory.\\n\"); close(mDriverFD); mDriverFD = -1; mDriverName.clear(); } } LOG_ALWAYS_FATAL_IF(mDriverFD \u003c 0, \"Binder driver could not be opened. Terminating.\"); } void IPCThreadState::joinThreadPool(b","date":"2024-11-06","objectID":"/posts/%E6%B1%87%E6%80%BBbinder%E7%9B%B8%E5%85%B3%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/:0:1","tags":["clippings","è½¬è½½","blog"],"title":"æ±‡æ€»binderç›¸å…³ä¸€äº›å¸¸è§é¢è¯•é¢˜-å®‰å“ç³»ç»Ÿå¸¸è§é¢è¯•é¢˜-CSDNåšå®¢","uri":"/posts/%E6%B1%87%E6%80%BBbinder%E7%9B%B8%E5%85%B3%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/#ä¸€-é€šè¿‡aidlçš„æ–¹å¼aidl-æ¥å£ç”Ÿæˆçš„æ—¶å€™æœ‰åŒºåˆ†æ˜¯å¦æ˜¯æœ¬åœ°è¿›ç¨‹è¿˜æ˜¯è¿œç¨‹è¿›ç¨‹"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"binderè®¨è®ºçš„ä¸€äº›åœºæ™¯é¢è¯•é¢˜ é—®é¢˜1ï¼šbinderä¸­æœ‰å¤šä¸ªè¿›ç¨‹ä½œä¸ºå®¢æˆ·ç«¯é€šè¿‡servicemanagerè·å–serviceçš„bpbinderï¼Œbpbinderéƒ½ä¼šæœ‰ä¸€ä¸ªhandleï¼Œé‚£ä¹ˆå¤šä¸ªè¿›ç¨‹è·å–åŒä¸€ä¸ªserviceå¯¹åº”çš„handleä¸€æ ·ä¹ˆï¼Ÿ æ˜¯çš„ï¼Œå¤šä¸ªè¿›ç¨‹è·å–åŒä¸€ä¸ªæœåŠ¡å¯¹åº”çš„ BpBinder çš„ handle æ˜¯ä¸€æ ·çš„ã€‚ åœ¨ Android çš„ Binder IPC æœºåˆ¶ä¸­ï¼ŒServiceManager è´Ÿè´£ç®¡ç†ç³»ç»Ÿä¸­çš„å„ç§æœåŠ¡ã€‚å½“ä¸€ä¸ªå®¢æˆ·ç«¯è¿›ç¨‹è¯·æ±‚æŸä¸ªæœåŠ¡æ—¶ï¼Œå®ƒä¼šé€šè¿‡ ServiceManager è·å–åˆ°æœåŠ¡çš„ Binder å¼•ç”¨ï¼ˆå³ BpBinderï¼‰ï¼Œè¿™ä¸ªå¼•ç”¨åœ¨å†…éƒ¨åŒ…å«äº†ä¸€ä¸ª handleï¼Œè¯¥ handle æ˜¯ä¸€ä¸ªæ•´æ•°å€¼ï¼Œå”¯ä¸€æ ‡è¯†äº†è¿™ä¸ªæœåŠ¡åœ¨ Binder é©±åŠ¨ä¸­çš„ä½ç½®ã€‚ ç”±äºä¸åŒè¿›ç¨‹è·å–çš„éƒ½æ˜¯åŒä¸€ä¸ªæœåŠ¡çš„å¼•ç”¨ï¼Œæ‰€ä»¥å®ƒä»¬è·å–åˆ°çš„ BpBinder ä¸­çš„ handle æ˜¯ç›¸åŒçš„ã€‚è¿™ä¸ª handle ç”¨äºåœ¨ Binder é©±åŠ¨å±‚è¿›è¡Œé€šä¿¡æ—¶æ ‡è¯†ç›®æ ‡æœåŠ¡ï¼Œä»è€Œç¡®ä¿å®¢æˆ·ç«¯è¿›ç¨‹èƒ½å¤Ÿæ­£ç¡®åœ°ä¸ç›®æ ‡æœåŠ¡è¿›è¡Œäº¤äº’ã€‚ æ€»ç»“æ¥è¯´ï¼š ä¸åŒè¿›ç¨‹é€šè¿‡ ServiceManager è·å–åŒä¸€ä¸ªæœåŠ¡çš„ BpBinderã€‚ è¿™äº› BpBinder å¯¹è±¡ä¸­çš„ handle æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºå®ƒä»¬éƒ½æŒ‡å‘åŒä¸€ä¸ªæœåŠ¡ã€‚ è¿™ä¸ª handle æ˜¯ç”¨äºåœ¨åº•å±‚ Binder é©±åŠ¨ä¸­å”¯ä¸€æ ‡è¯†è¯¥æœåŠ¡çš„ã€‚ å¸Œæœ›è¿™ä¸ªå›ç­”èƒ½å¸®åˆ°ä½ ï¼å¦‚æœä½ æœ‰æ›´å¤šé—®é¢˜ï¼Œè¯·éšæ—¶æé—®ã€‚ é—®é¢˜2ï¼šè¯·é—®binderé€šè®¯è¿‡ç¨‹ä¸­æ˜¯å¦å¯ä»¥ä¼ é€’bpbinderå¯¹è±¡ï¼Ÿ æ˜¯çš„ï¼Œåœ¨ Binder é€šä¿¡è¿‡ç¨‹ä¸­å¯ä»¥ä¼ é€’ BpBinder å¯¹è±¡ã€‚ BpBinder æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯ä¾§çš„ Binder å¼•ç”¨ï¼Œå®ƒåœ¨è·¨è¿›ç¨‹é€šä¿¡ä¸­å¯ä»¥è¢«å½“ä½œæ™®é€šçš„ Binder å¯¹è±¡ä¼ é€’ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š åˆ›å»º BpBinder: å®¢æˆ·ç«¯è¿›ç¨‹é€šè¿‡ ServiceManager è·å–æœåŠ¡çš„ BpBinder å¼•ç”¨ã€‚ ä¼ é€’ BpBinder: åœ¨è¿›è¡Œ Binder é€šä¿¡æ—¶ï¼Œè¿™ä¸ª BpBinder å¯ä»¥ä½œä¸ºå‚æ•°é™„å¸¦åœ¨ Parcel ä¸­ä¼ é€’ç»™å…¶ä»–è¿›ç¨‹ã€‚ ä½¿ç”¨ BpBinder: æ¥æ”¶æ–¹è¿›ç¨‹ä¼šæ”¶åˆ°è¿™ä¸ª BpBinder å¼•ç”¨ï¼Œå¹¶å¯ä»¥é€šè¿‡å®ƒä¸åŸæœåŠ¡è¿›è¡Œé€šä¿¡ã€‚ è¿™ç§æœºåˆ¶ä½¿å¾— Binder èƒ½å¤Ÿçµæ´»åœ°æ”¯æŒå¯¹è±¡å¼•ç”¨çš„ä¼ é€’å’Œè·¨è¿›ç¨‹äº¤äº’ï¼Œæ˜¯ Android IPC çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ã€‚ é—®é¢˜3ï¼šè¯·é—®åŒbinder æœåŠ¡ç«¯è¿›ç¨‹è‡ªå·±è¿›ç¨‹å†…éƒ¨å¦‚æœè¿›è¡Œbinderè°ƒç”¨éœ€è¦ç»è¿‡binderé©±åŠ¨å—ï¼Œéœ€è¦å’Œä¸éœ€è¦è¯·è¯¦ç»†æè¿°ï¼Ÿ è¿™ä¸ªè¦çœ‹æƒ…å†µå’Œè°ƒç”¨æ–¹å¼ï¼š ä¸€ é€šè¿‡aidlçš„æ–¹å¼ï¼ŒAIDL æ¥å£ç”Ÿæˆçš„æ—¶å€™ï¼Œæœ‰åŒºåˆ†æ˜¯å¦æ˜¯æœ¬åœ°è¿›ç¨‹è¿˜æ˜¯è¿œç¨‹è¿›ç¨‹ Stub çš„ç©ºæ„é€ å‡½æ•°ã€‚è€ŒStub æœ¬èº«åˆæ˜¯Binder çš„å­ç±»ã€‚è°ƒç”¨äº†Binder çš„attachInterface æ–¹æ³•ã€‚ public Stub() { this.attachInterface(this, DESCRIPTOR); } public void attachInterface(@Nullable IInterface owner, @Nullable String descriptor) { mOwner = owner; mDescriptor = descriptor; } åˆ†åˆ«ä¿å­˜äº†å½“å‰ç±»çš„å®ä¾‹å¯¹è±¡ï¼ˆThisï¼‰å’Œå½“å‰ç±»æ¥å£æè¿°ç¬¦ï¼ˆDESCRIPTORï¼‰ï¼Œå…¶å®å°±æ˜¯ private static final java.lang.String DESCRIPTOR = â€œcom.example.aidlapplication.IMyAidlInterfaceâ€; å½“å‰ç±»çš„å…¨è·¯å¾„ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨ä½¿ç”¨aidl çš„æ—¶å€™æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¿…é¡»è¦ä¿è¯ç›¸åŒè·¯å¾„ä¸‹çš„åŸå› ï¼Œå› ä¸ºä»–è¢«ä¿å­˜ä¸‹æ¥ä½œä¸ºå‚æ•°ç”¨äºæ¯”å¯¹å½“å‰ç±»æ˜¯å¦æ˜¯æœ¬åœ°ç±»è¿˜æ˜¯è¿œç¨‹ã€‚ æ‰€ä»¥åœ¨ IMyAidlInterface iMyAidlInterface = IMyAidlInterface.Stub.asInterface(service) public static com.example.aidlapplication.IMyAidlInterface asInterface(android.os.IBinder obj) { if ((obj==null)) { return null; } android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR); if (((iin!=null)\u0026\u0026(iin instanceof com.example.aidlapplication.IMyAidlInterface))) { return ((com.example.aidlapplication.IMyAidlInterface)iin); } return new com.example.aidlapplication.IMyAidlInterface.Stub.Proxy(obj); } @Override public android.os.IBinder asBinder() { return this; } å‚è€ƒè¿™ç¯‡ï¼šandroid Binder queryLocalInterface æœ¬åœ°ä¸è¿œç¨‹-CSDNåšå®¢ äºŒ é€šè¿‡bind service è¿™ç§æ–¹å¼å¯èƒ½è¿˜æ˜¯è¦é€šè¿‡binderå»è°ƒç”¨ï¼Œä½†åœ¨binderé©±åŠ¨å†…éƒ¨ï¼Œå¯èƒ½è¿˜æ˜¯æœ‰ä¸€å®šçš„ä¼˜åŒ–æµç¨‹ã€‚ #TODO é—®é¢˜4ï¼šAndroid Appè¿›ç¨‹å¤©ç”Ÿæ”¯æŒbinderé€šè®¯çš„åŸç†æ˜¯ä»€ä¹ˆï¼Œåˆšå¼€å§‹åˆå§‹åŒ–æ—¶å€™è‡ªå¸¦äº†å‡ ä¸ªbinderçº¿ç¨‹ï¼Ÿ zygote å¯åŠ¨çš„æ—¶å€™å°±æ”¯æŒäº†binderé€šè®¯ï¼Œæ‰€æœ‰åé¢çš„appå­µåŒ–ä¹‹åï¼Œä¹Ÿä¼šè‡ªå¸¦binderé€šè®¯ã€‚ zygote åœ¨ initçš„æ—¶å€™ï¼š 1. å¯åŠ¨ ProcessState ProcessState::self() 2. å¯åŠ¨çº¿ç¨‹æ± ï¼šproc-\u003estartThreadPool(); virtual void onZygoteInit() { sp proc = ProcessState::self(); ALOGV(\"App process: starting thread pool.\\n\"); proc-\u003estartThreadPool(); } new ProcessState(kDefaultDriver); sp ProcessState::self() { Mutex::Autolock _l(gProcessMutex); if (gProcess != nullptr) { return gProcess; } gProcess = new ProcessState(kDefaultDriver); return gProcess; } mDriverFD(open_driver(driver)) æ‰“å¼€é©±åŠ¨ mMaxThreads(DEFAULT_MAX_BINDER_THREADS) æœ€å¤§çº¿ç¨‹æ•° mmap(0, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, 0); æ˜ å°„å†…å­˜ BINDER_VM_SIZE é»˜è®¤ 1M- 2PageSize ProcessState::ProcessState(const char *driver) : mDriverName(String8(driver)) , mDriverFD(open_driver(driver)) , mVMStart(MAP_FAILED) , mThreadCountLock(PTHREAD_MUTEX_INITIALIZER) , mThreadCountDecrement(PTHREAD_COND_INITIALIZER) , mExecutingThreadsCount(0) , mMaxThreads(DEFAULT_MAX_BINDER_THREADS) , mStarvationStartTimeMs(0) , mManagesContexts(false) , mBinderContextCheckFunc(NULL) , mBinderContextUserData(NULL) , mThreadPoolStarted(false) , mThreadPoolSeq(1) { if (mDriverFD \u003e= 0) { // mmap the binder, providing a chunk of virtual address space to receive transactions. mVMStart = mmap(0, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, 0); if (mVMStart == MAP_FAILED) { // *sigh* ALOGE(\"Using /dev/binder failed: unable to mmap transaction memory.\\n\"); close(mDriverFD); mDriverFD = -1; mDriverName.clear(); } } LOG_ALWAYS_FATAL_IF(mDriverFD \u003c 0, \"Binder driver could not be opened. Terminating.\"); } void IPCThreadState::joinThreadPool(b","date":"2024-11-06","objectID":"/posts/%E6%B1%87%E6%80%BBbinder%E7%9B%B8%E5%85%B3%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/:0:1","tags":["clippings","è½¬è½½","blog"],"title":"æ±‡æ€»binderç›¸å…³ä¸€äº›å¸¸è§é¢è¯•é¢˜-å®‰å“ç³»ç»Ÿå¸¸è§é¢è¯•é¢˜-CSDNåšå®¢","uri":"/posts/%E6%B1%87%E6%80%BBbinder%E7%9B%B8%E5%85%B3%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/#äºŒ-é€šè¿‡bind-service"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"binderè®¨è®ºçš„ä¸€äº›åœºæ™¯é¢è¯•é¢˜ é—®é¢˜1ï¼šbinderä¸­æœ‰å¤šä¸ªè¿›ç¨‹ä½œä¸ºå®¢æˆ·ç«¯é€šè¿‡servicemanagerè·å–serviceçš„bpbinderï¼Œbpbinderéƒ½ä¼šæœ‰ä¸€ä¸ªhandleï¼Œé‚£ä¹ˆå¤šä¸ªè¿›ç¨‹è·å–åŒä¸€ä¸ªserviceå¯¹åº”çš„handleä¸€æ ·ä¹ˆï¼Ÿ æ˜¯çš„ï¼Œå¤šä¸ªè¿›ç¨‹è·å–åŒä¸€ä¸ªæœåŠ¡å¯¹åº”çš„ BpBinder çš„ handle æ˜¯ä¸€æ ·çš„ã€‚ åœ¨ Android çš„ Binder IPC æœºåˆ¶ä¸­ï¼ŒServiceManager è´Ÿè´£ç®¡ç†ç³»ç»Ÿä¸­çš„å„ç§æœåŠ¡ã€‚å½“ä¸€ä¸ªå®¢æˆ·ç«¯è¿›ç¨‹è¯·æ±‚æŸä¸ªæœåŠ¡æ—¶ï¼Œå®ƒä¼šé€šè¿‡ ServiceManager è·å–åˆ°æœåŠ¡çš„ Binder å¼•ç”¨ï¼ˆå³ BpBinderï¼‰ï¼Œè¿™ä¸ªå¼•ç”¨åœ¨å†…éƒ¨åŒ…å«äº†ä¸€ä¸ª handleï¼Œè¯¥ handle æ˜¯ä¸€ä¸ªæ•´æ•°å€¼ï¼Œå”¯ä¸€æ ‡è¯†äº†è¿™ä¸ªæœåŠ¡åœ¨ Binder é©±åŠ¨ä¸­çš„ä½ç½®ã€‚ ç”±äºä¸åŒè¿›ç¨‹è·å–çš„éƒ½æ˜¯åŒä¸€ä¸ªæœåŠ¡çš„å¼•ç”¨ï¼Œæ‰€ä»¥å®ƒä»¬è·å–åˆ°çš„ BpBinder ä¸­çš„ handle æ˜¯ç›¸åŒçš„ã€‚è¿™ä¸ª handle ç”¨äºåœ¨ Binder é©±åŠ¨å±‚è¿›è¡Œé€šä¿¡æ—¶æ ‡è¯†ç›®æ ‡æœåŠ¡ï¼Œä»è€Œç¡®ä¿å®¢æˆ·ç«¯è¿›ç¨‹èƒ½å¤Ÿæ­£ç¡®åœ°ä¸ç›®æ ‡æœåŠ¡è¿›è¡Œäº¤äº’ã€‚ æ€»ç»“æ¥è¯´ï¼š ä¸åŒè¿›ç¨‹é€šè¿‡ ServiceManager è·å–åŒä¸€ä¸ªæœåŠ¡çš„ BpBinderã€‚ è¿™äº› BpBinder å¯¹è±¡ä¸­çš„ handle æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºå®ƒä»¬éƒ½æŒ‡å‘åŒä¸€ä¸ªæœåŠ¡ã€‚ è¿™ä¸ª handle æ˜¯ç”¨äºåœ¨åº•å±‚ Binder é©±åŠ¨ä¸­å”¯ä¸€æ ‡è¯†è¯¥æœåŠ¡çš„ã€‚ å¸Œæœ›è¿™ä¸ªå›ç­”èƒ½å¸®åˆ°ä½ ï¼å¦‚æœä½ æœ‰æ›´å¤šé—®é¢˜ï¼Œè¯·éšæ—¶æé—®ã€‚ é—®é¢˜2ï¼šè¯·é—®binderé€šè®¯è¿‡ç¨‹ä¸­æ˜¯å¦å¯ä»¥ä¼ é€’bpbinderå¯¹è±¡ï¼Ÿ æ˜¯çš„ï¼Œåœ¨ Binder é€šä¿¡è¿‡ç¨‹ä¸­å¯ä»¥ä¼ é€’ BpBinder å¯¹è±¡ã€‚ BpBinder æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯ä¾§çš„ Binder å¼•ç”¨ï¼Œå®ƒåœ¨è·¨è¿›ç¨‹é€šä¿¡ä¸­å¯ä»¥è¢«å½“ä½œæ™®é€šçš„ Binder å¯¹è±¡ä¼ é€’ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š åˆ›å»º BpBinder: å®¢æˆ·ç«¯è¿›ç¨‹é€šè¿‡ ServiceManager è·å–æœåŠ¡çš„ BpBinder å¼•ç”¨ã€‚ ä¼ é€’ BpBinder: åœ¨è¿›è¡Œ Binder é€šä¿¡æ—¶ï¼Œè¿™ä¸ª BpBinder å¯ä»¥ä½œä¸ºå‚æ•°é™„å¸¦åœ¨ Parcel ä¸­ä¼ é€’ç»™å…¶ä»–è¿›ç¨‹ã€‚ ä½¿ç”¨ BpBinder: æ¥æ”¶æ–¹è¿›ç¨‹ä¼šæ”¶åˆ°è¿™ä¸ª BpBinder å¼•ç”¨ï¼Œå¹¶å¯ä»¥é€šè¿‡å®ƒä¸åŸæœåŠ¡è¿›è¡Œé€šä¿¡ã€‚ è¿™ç§æœºåˆ¶ä½¿å¾— Binder èƒ½å¤Ÿçµæ´»åœ°æ”¯æŒå¯¹è±¡å¼•ç”¨çš„ä¼ é€’å’Œè·¨è¿›ç¨‹äº¤äº’ï¼Œæ˜¯ Android IPC çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ã€‚ é—®é¢˜3ï¼šè¯·é—®åŒbinder æœåŠ¡ç«¯è¿›ç¨‹è‡ªå·±è¿›ç¨‹å†…éƒ¨å¦‚æœè¿›è¡Œbinderè°ƒç”¨éœ€è¦ç»è¿‡binderé©±åŠ¨å—ï¼Œéœ€è¦å’Œä¸éœ€è¦è¯·è¯¦ç»†æè¿°ï¼Ÿ è¿™ä¸ªè¦çœ‹æƒ…å†µå’Œè°ƒç”¨æ–¹å¼ï¼š ä¸€ é€šè¿‡aidlçš„æ–¹å¼ï¼ŒAIDL æ¥å£ç”Ÿæˆçš„æ—¶å€™ï¼Œæœ‰åŒºåˆ†æ˜¯å¦æ˜¯æœ¬åœ°è¿›ç¨‹è¿˜æ˜¯è¿œç¨‹è¿›ç¨‹ Stub çš„ç©ºæ„é€ å‡½æ•°ã€‚è€ŒStub æœ¬èº«åˆæ˜¯Binder çš„å­ç±»ã€‚è°ƒç”¨äº†Binder çš„attachInterface æ–¹æ³•ã€‚ public Stub() { this.attachInterface(this, DESCRIPTOR); } public void attachInterface(@Nullable IInterface owner, @Nullable String descriptor) { mOwner = owner; mDescriptor = descriptor; } åˆ†åˆ«ä¿å­˜äº†å½“å‰ç±»çš„å®ä¾‹å¯¹è±¡ï¼ˆThisï¼‰å’Œå½“å‰ç±»æ¥å£æè¿°ç¬¦ï¼ˆDESCRIPTORï¼‰ï¼Œå…¶å®å°±æ˜¯ private static final java.lang.String DESCRIPTOR = â€œcom.example.aidlapplication.IMyAidlInterfaceâ€; å½“å‰ç±»çš„å…¨è·¯å¾„ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨ä½¿ç”¨aidl çš„æ—¶å€™æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¿…é¡»è¦ä¿è¯ç›¸åŒè·¯å¾„ä¸‹çš„åŸå› ï¼Œå› ä¸ºä»–è¢«ä¿å­˜ä¸‹æ¥ä½œä¸ºå‚æ•°ç”¨äºæ¯”å¯¹å½“å‰ç±»æ˜¯å¦æ˜¯æœ¬åœ°ç±»è¿˜æ˜¯è¿œç¨‹ã€‚ æ‰€ä»¥åœ¨ IMyAidlInterface iMyAidlInterface = IMyAidlInterface.Stub.asInterface(service) public static com.example.aidlapplication.IMyAidlInterface asInterface(android.os.IBinder obj) { if ((obj==null)) { return null; } android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR); if (((iin!=null)\u0026\u0026(iin instanceof com.example.aidlapplication.IMyAidlInterface))) { return ((com.example.aidlapplication.IMyAidlInterface)iin); } return new com.example.aidlapplication.IMyAidlInterface.Stub.Proxy(obj); } @Override public android.os.IBinder asBinder() { return this; } å‚è€ƒè¿™ç¯‡ï¼šandroid Binder queryLocalInterface æœ¬åœ°ä¸è¿œç¨‹-CSDNåšå®¢ äºŒ é€šè¿‡bind service è¿™ç§æ–¹å¼å¯èƒ½è¿˜æ˜¯è¦é€šè¿‡binderå»è°ƒç”¨ï¼Œä½†åœ¨binderé©±åŠ¨å†…éƒ¨ï¼Œå¯èƒ½è¿˜æ˜¯æœ‰ä¸€å®šçš„ä¼˜åŒ–æµç¨‹ã€‚ #TODO é—®é¢˜4ï¼šAndroid Appè¿›ç¨‹å¤©ç”Ÿæ”¯æŒbinderé€šè®¯çš„åŸç†æ˜¯ä»€ä¹ˆï¼Œåˆšå¼€å§‹åˆå§‹åŒ–æ—¶å€™è‡ªå¸¦äº†å‡ ä¸ªbinderçº¿ç¨‹ï¼Ÿ zygote å¯åŠ¨çš„æ—¶å€™å°±æ”¯æŒäº†binderé€šè®¯ï¼Œæ‰€æœ‰åé¢çš„appå­µåŒ–ä¹‹åï¼Œä¹Ÿä¼šè‡ªå¸¦binderé€šè®¯ã€‚ zygote åœ¨ initçš„æ—¶å€™ï¼š 1. å¯åŠ¨ ProcessState ProcessState::self() 2. å¯åŠ¨çº¿ç¨‹æ± ï¼šproc-\u003estartThreadPool(); virtual void onZygoteInit() { sp proc = ProcessState::self(); ALOGV(\"App process: starting thread pool.\\n\"); proc-\u003estartThreadPool(); } new ProcessState(kDefaultDriver); sp ProcessState::self() { Mutex::Autolock _l(gProcessMutex); if (gProcess != nullptr) { return gProcess; } gProcess = new ProcessState(kDefaultDriver); return gProcess; } mDriverFD(open_driver(driver)) æ‰“å¼€é©±åŠ¨ mMaxThreads(DEFAULT_MAX_BINDER_THREADS) æœ€å¤§çº¿ç¨‹æ•° mmap(0, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, 0); æ˜ å°„å†…å­˜ BINDER_VM_SIZE é»˜è®¤ 1M- 2PageSize ProcessState::ProcessState(const char *driver) : mDriverName(String8(driver)) , mDriverFD(open_driver(driver)) , mVMStart(MAP_FAILED) , mThreadCountLock(PTHREAD_MUTEX_INITIALIZER) , mThreadCountDecrement(PTHREAD_COND_INITIALIZER) , mExecutingThreadsCount(0) , mMaxThreads(DEFAULT_MAX_BINDER_THREADS) , mStarvationStartTimeMs(0) , mManagesContexts(false) , mBinderContextCheckFunc(NULL) , mBinderContextUserData(NULL) , mThreadPoolStarted(false) , mThreadPoolSeq(1) { if (mDriverFD \u003e= 0) { // mmap the binder, providing a chunk of virtual address space to receive transactions. mVMStart = mmap(0, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, 0); if (mVMStart == MAP_FAILED) { // *sigh* ALOGE(\"Using /dev/binder failed: unable to mmap transaction memory.\\n\"); close(mDriverFD); mDriverFD = -1; mDriverName.clear(); } } LOG_ALWAYS_FATAL_IF(mDriverFD \u003c 0, \"Binder driver could not be opened. Terminating.\"); } void IPCThreadState::joinThreadPool(b","date":"2024-11-06","objectID":"/posts/%E6%B1%87%E6%80%BBbinder%E7%9B%B8%E5%85%B3%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/:0:1","tags":["clippings","è½¬è½½","blog"],"title":"æ±‡æ€»binderç›¸å…³ä¸€äº›å¸¸è§é¢è¯•é¢˜-å®‰å“ç³»ç»Ÿå¸¸è§é¢è¯•é¢˜-CSDNåšå®¢","uri":"/posts/%E6%B1%87%E6%80%BBbinder%E7%9B%B8%E5%85%B3%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/#é—®é¢˜4android-appè¿›ç¨‹å¤©ç”Ÿæ”¯æŒbinderé€šè®¯çš„åŸç†æ˜¯ä»€ä¹ˆåˆšå¼€å§‹åˆå§‹åŒ–æ—¶å€™è‡ªå¸¦äº†å‡ ä¸ªbinderçº¿ç¨‹"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"binderè®¨è®ºçš„ä¸€äº›åœºæ™¯é¢è¯•é¢˜ é—®é¢˜1ï¼šbinderä¸­æœ‰å¤šä¸ªè¿›ç¨‹ä½œä¸ºå®¢æˆ·ç«¯é€šè¿‡servicemanagerè·å–serviceçš„bpbinderï¼Œbpbinderéƒ½ä¼šæœ‰ä¸€ä¸ªhandleï¼Œé‚£ä¹ˆå¤šä¸ªè¿›ç¨‹è·å–åŒä¸€ä¸ªserviceå¯¹åº”çš„handleä¸€æ ·ä¹ˆï¼Ÿ æ˜¯çš„ï¼Œå¤šä¸ªè¿›ç¨‹è·å–åŒä¸€ä¸ªæœåŠ¡å¯¹åº”çš„ BpBinder çš„ handle æ˜¯ä¸€æ ·çš„ã€‚ åœ¨ Android çš„ Binder IPC æœºåˆ¶ä¸­ï¼ŒServiceManager è´Ÿè´£ç®¡ç†ç³»ç»Ÿä¸­çš„å„ç§æœåŠ¡ã€‚å½“ä¸€ä¸ªå®¢æˆ·ç«¯è¿›ç¨‹è¯·æ±‚æŸä¸ªæœåŠ¡æ—¶ï¼Œå®ƒä¼šé€šè¿‡ ServiceManager è·å–åˆ°æœåŠ¡çš„ Binder å¼•ç”¨ï¼ˆå³ BpBinderï¼‰ï¼Œè¿™ä¸ªå¼•ç”¨åœ¨å†…éƒ¨åŒ…å«äº†ä¸€ä¸ª handleï¼Œè¯¥ handle æ˜¯ä¸€ä¸ªæ•´æ•°å€¼ï¼Œå”¯ä¸€æ ‡è¯†äº†è¿™ä¸ªæœåŠ¡åœ¨ Binder é©±åŠ¨ä¸­çš„ä½ç½®ã€‚ ç”±äºä¸åŒè¿›ç¨‹è·å–çš„éƒ½æ˜¯åŒä¸€ä¸ªæœåŠ¡çš„å¼•ç”¨ï¼Œæ‰€ä»¥å®ƒä»¬è·å–åˆ°çš„ BpBinder ä¸­çš„ handle æ˜¯ç›¸åŒçš„ã€‚è¿™ä¸ª handle ç”¨äºåœ¨ Binder é©±åŠ¨å±‚è¿›è¡Œé€šä¿¡æ—¶æ ‡è¯†ç›®æ ‡æœåŠ¡ï¼Œä»è€Œç¡®ä¿å®¢æˆ·ç«¯è¿›ç¨‹èƒ½å¤Ÿæ­£ç¡®åœ°ä¸ç›®æ ‡æœåŠ¡è¿›è¡Œäº¤äº’ã€‚ æ€»ç»“æ¥è¯´ï¼š ä¸åŒè¿›ç¨‹é€šè¿‡ ServiceManager è·å–åŒä¸€ä¸ªæœåŠ¡çš„ BpBinderã€‚ è¿™äº› BpBinder å¯¹è±¡ä¸­çš„ handle æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºå®ƒä»¬éƒ½æŒ‡å‘åŒä¸€ä¸ªæœåŠ¡ã€‚ è¿™ä¸ª handle æ˜¯ç”¨äºåœ¨åº•å±‚ Binder é©±åŠ¨ä¸­å”¯ä¸€æ ‡è¯†è¯¥æœåŠ¡çš„ã€‚ å¸Œæœ›è¿™ä¸ªå›ç­”èƒ½å¸®åˆ°ä½ ï¼å¦‚æœä½ æœ‰æ›´å¤šé—®é¢˜ï¼Œè¯·éšæ—¶æé—®ã€‚ é—®é¢˜2ï¼šè¯·é—®binderé€šè®¯è¿‡ç¨‹ä¸­æ˜¯å¦å¯ä»¥ä¼ é€’bpbinderå¯¹è±¡ï¼Ÿ æ˜¯çš„ï¼Œåœ¨ Binder é€šä¿¡è¿‡ç¨‹ä¸­å¯ä»¥ä¼ é€’ BpBinder å¯¹è±¡ã€‚ BpBinder æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯ä¾§çš„ Binder å¼•ç”¨ï¼Œå®ƒåœ¨è·¨è¿›ç¨‹é€šä¿¡ä¸­å¯ä»¥è¢«å½“ä½œæ™®é€šçš„ Binder å¯¹è±¡ä¼ é€’ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š åˆ›å»º BpBinder: å®¢æˆ·ç«¯è¿›ç¨‹é€šè¿‡ ServiceManager è·å–æœåŠ¡çš„ BpBinder å¼•ç”¨ã€‚ ä¼ é€’ BpBinder: åœ¨è¿›è¡Œ Binder é€šä¿¡æ—¶ï¼Œè¿™ä¸ª BpBinder å¯ä»¥ä½œä¸ºå‚æ•°é™„å¸¦åœ¨ Parcel ä¸­ä¼ é€’ç»™å…¶ä»–è¿›ç¨‹ã€‚ ä½¿ç”¨ BpBinder: æ¥æ”¶æ–¹è¿›ç¨‹ä¼šæ”¶åˆ°è¿™ä¸ª BpBinder å¼•ç”¨ï¼Œå¹¶å¯ä»¥é€šè¿‡å®ƒä¸åŸæœåŠ¡è¿›è¡Œé€šä¿¡ã€‚ è¿™ç§æœºåˆ¶ä½¿å¾— Binder èƒ½å¤Ÿçµæ´»åœ°æ”¯æŒå¯¹è±¡å¼•ç”¨çš„ä¼ é€’å’Œè·¨è¿›ç¨‹äº¤äº’ï¼Œæ˜¯ Android IPC çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ã€‚ é—®é¢˜3ï¼šè¯·é—®åŒbinder æœåŠ¡ç«¯è¿›ç¨‹è‡ªå·±è¿›ç¨‹å†…éƒ¨å¦‚æœè¿›è¡Œbinderè°ƒç”¨éœ€è¦ç»è¿‡binderé©±åŠ¨å—ï¼Œéœ€è¦å’Œä¸éœ€è¦è¯·è¯¦ç»†æè¿°ï¼Ÿ è¿™ä¸ªè¦çœ‹æƒ…å†µå’Œè°ƒç”¨æ–¹å¼ï¼š ä¸€ é€šè¿‡aidlçš„æ–¹å¼ï¼ŒAIDL æ¥å£ç”Ÿæˆçš„æ—¶å€™ï¼Œæœ‰åŒºåˆ†æ˜¯å¦æ˜¯æœ¬åœ°è¿›ç¨‹è¿˜æ˜¯è¿œç¨‹è¿›ç¨‹ Stub çš„ç©ºæ„é€ å‡½æ•°ã€‚è€ŒStub æœ¬èº«åˆæ˜¯Binder çš„å­ç±»ã€‚è°ƒç”¨äº†Binder çš„attachInterface æ–¹æ³•ã€‚ public Stub() { this.attachInterface(this, DESCRIPTOR); } public void attachInterface(@Nullable IInterface owner, @Nullable String descriptor) { mOwner = owner; mDescriptor = descriptor; } åˆ†åˆ«ä¿å­˜äº†å½“å‰ç±»çš„å®ä¾‹å¯¹è±¡ï¼ˆThisï¼‰å’Œå½“å‰ç±»æ¥å£æè¿°ç¬¦ï¼ˆDESCRIPTORï¼‰ï¼Œå…¶å®å°±æ˜¯ private static final java.lang.String DESCRIPTOR = â€œcom.example.aidlapplication.IMyAidlInterfaceâ€; å½“å‰ç±»çš„å…¨è·¯å¾„ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨ä½¿ç”¨aidl çš„æ—¶å€™æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¿…é¡»è¦ä¿è¯ç›¸åŒè·¯å¾„ä¸‹çš„åŸå› ï¼Œå› ä¸ºä»–è¢«ä¿å­˜ä¸‹æ¥ä½œä¸ºå‚æ•°ç”¨äºæ¯”å¯¹å½“å‰ç±»æ˜¯å¦æ˜¯æœ¬åœ°ç±»è¿˜æ˜¯è¿œç¨‹ã€‚ æ‰€ä»¥åœ¨ IMyAidlInterface iMyAidlInterface = IMyAidlInterface.Stub.asInterface(service) public static com.example.aidlapplication.IMyAidlInterface asInterface(android.os.IBinder obj) { if ((obj==null)) { return null; } android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR); if (((iin!=null)\u0026\u0026(iin instanceof com.example.aidlapplication.IMyAidlInterface))) { return ((com.example.aidlapplication.IMyAidlInterface)iin); } return new com.example.aidlapplication.IMyAidlInterface.Stub.Proxy(obj); } @Override public android.os.IBinder asBinder() { return this; } å‚è€ƒè¿™ç¯‡ï¼šandroid Binder queryLocalInterface æœ¬åœ°ä¸è¿œç¨‹-CSDNåšå®¢ äºŒ é€šè¿‡bind service è¿™ç§æ–¹å¼å¯èƒ½è¿˜æ˜¯è¦é€šè¿‡binderå»è°ƒç”¨ï¼Œä½†åœ¨binderé©±åŠ¨å†…éƒ¨ï¼Œå¯èƒ½è¿˜æ˜¯æœ‰ä¸€å®šçš„ä¼˜åŒ–æµç¨‹ã€‚ #TODO é—®é¢˜4ï¼šAndroid Appè¿›ç¨‹å¤©ç”Ÿæ”¯æŒbinderé€šè®¯çš„åŸç†æ˜¯ä»€ä¹ˆï¼Œåˆšå¼€å§‹åˆå§‹åŒ–æ—¶å€™è‡ªå¸¦äº†å‡ ä¸ªbinderçº¿ç¨‹ï¼Ÿ zygote å¯åŠ¨çš„æ—¶å€™å°±æ”¯æŒäº†binderé€šè®¯ï¼Œæ‰€æœ‰åé¢çš„appå­µåŒ–ä¹‹åï¼Œä¹Ÿä¼šè‡ªå¸¦binderé€šè®¯ã€‚ zygote åœ¨ initçš„æ—¶å€™ï¼š 1. å¯åŠ¨ ProcessState ProcessState::self() 2. å¯åŠ¨çº¿ç¨‹æ± ï¼šproc-\u003estartThreadPool(); virtual void onZygoteInit() { sp proc = ProcessState::self(); ALOGV(\"App process: starting thread pool.\\n\"); proc-\u003estartThreadPool(); } new ProcessState(kDefaultDriver); sp ProcessState::self() { Mutex::Autolock _l(gProcessMutex); if (gProcess != nullptr) { return gProcess; } gProcess = new ProcessState(kDefaultDriver); return gProcess; } mDriverFD(open_driver(driver)) æ‰“å¼€é©±åŠ¨ mMaxThreads(DEFAULT_MAX_BINDER_THREADS) æœ€å¤§çº¿ç¨‹æ•° mmap(0, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, 0); æ˜ å°„å†…å­˜ BINDER_VM_SIZE é»˜è®¤ 1M- 2PageSize ProcessState::ProcessState(const char *driver) : mDriverName(String8(driver)) , mDriverFD(open_driver(driver)) , mVMStart(MAP_FAILED) , mThreadCountLock(PTHREAD_MUTEX_INITIALIZER) , mThreadCountDecrement(PTHREAD_COND_INITIALIZER) , mExecutingThreadsCount(0) , mMaxThreads(DEFAULT_MAX_BINDER_THREADS) , mStarvationStartTimeMs(0) , mManagesContexts(false) , mBinderContextCheckFunc(NULL) , mBinderContextUserData(NULL) , mThreadPoolStarted(false) , mThreadPoolSeq(1) { if (mDriverFD \u003e= 0) { // mmap the binder, providing a chunk of virtual address space to receive transactions. mVMStart = mmap(0, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, 0); if (mVMStart == MAP_FAILED) { // *sigh* ALOGE(\"Using /dev/binder failed: unable to mmap transaction memory.\\n\"); close(mDriverFD); mDriverFD = -1; mDriverName.clear(); } } LOG_ALWAYS_FATAL_IF(mDriverFD \u003c 0, \"Binder driver could not be opened. Terminating.\"); } void IPCThreadState::joinThreadPool(b","date":"2024-11-06","objectID":"/posts/%E6%B1%87%E6%80%BBbinder%E7%9B%B8%E5%85%B3%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/:0:1","tags":["clippings","è½¬è½½","blog"],"title":"æ±‡æ€»binderç›¸å…³ä¸€äº›å¸¸è§é¢è¯•é¢˜-å®‰å“ç³»ç»Ÿå¸¸è§é¢è¯•é¢˜-CSDNåšå®¢","uri":"/posts/%E6%B1%87%E6%80%BBbinder%E7%9B%B8%E5%85%B3%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/#1-å¯åŠ¨-processstate--processstateself"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"binderè®¨è®ºçš„ä¸€äº›åœºæ™¯é¢è¯•é¢˜ é—®é¢˜1ï¼šbinderä¸­æœ‰å¤šä¸ªè¿›ç¨‹ä½œä¸ºå®¢æˆ·ç«¯é€šè¿‡servicemanagerè·å–serviceçš„bpbinderï¼Œbpbinderéƒ½ä¼šæœ‰ä¸€ä¸ªhandleï¼Œé‚£ä¹ˆå¤šä¸ªè¿›ç¨‹è·å–åŒä¸€ä¸ªserviceå¯¹åº”çš„handleä¸€æ ·ä¹ˆï¼Ÿ æ˜¯çš„ï¼Œå¤šä¸ªè¿›ç¨‹è·å–åŒä¸€ä¸ªæœåŠ¡å¯¹åº”çš„ BpBinder çš„ handle æ˜¯ä¸€æ ·çš„ã€‚ åœ¨ Android çš„ Binder IPC æœºåˆ¶ä¸­ï¼ŒServiceManager è´Ÿè´£ç®¡ç†ç³»ç»Ÿä¸­çš„å„ç§æœåŠ¡ã€‚å½“ä¸€ä¸ªå®¢æˆ·ç«¯è¿›ç¨‹è¯·æ±‚æŸä¸ªæœåŠ¡æ—¶ï¼Œå®ƒä¼šé€šè¿‡ ServiceManager è·å–åˆ°æœåŠ¡çš„ Binder å¼•ç”¨ï¼ˆå³ BpBinderï¼‰ï¼Œè¿™ä¸ªå¼•ç”¨åœ¨å†…éƒ¨åŒ…å«äº†ä¸€ä¸ª handleï¼Œè¯¥ handle æ˜¯ä¸€ä¸ªæ•´æ•°å€¼ï¼Œå”¯ä¸€æ ‡è¯†äº†è¿™ä¸ªæœåŠ¡åœ¨ Binder é©±åŠ¨ä¸­çš„ä½ç½®ã€‚ ç”±äºä¸åŒè¿›ç¨‹è·å–çš„éƒ½æ˜¯åŒä¸€ä¸ªæœåŠ¡çš„å¼•ç”¨ï¼Œæ‰€ä»¥å®ƒä»¬è·å–åˆ°çš„ BpBinder ä¸­çš„ handle æ˜¯ç›¸åŒçš„ã€‚è¿™ä¸ª handle ç”¨äºåœ¨ Binder é©±åŠ¨å±‚è¿›è¡Œé€šä¿¡æ—¶æ ‡è¯†ç›®æ ‡æœåŠ¡ï¼Œä»è€Œç¡®ä¿å®¢æˆ·ç«¯è¿›ç¨‹èƒ½å¤Ÿæ­£ç¡®åœ°ä¸ç›®æ ‡æœåŠ¡è¿›è¡Œäº¤äº’ã€‚ æ€»ç»“æ¥è¯´ï¼š ä¸åŒè¿›ç¨‹é€šè¿‡ ServiceManager è·å–åŒä¸€ä¸ªæœåŠ¡çš„ BpBinderã€‚ è¿™äº› BpBinder å¯¹è±¡ä¸­çš„ handle æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºå®ƒä»¬éƒ½æŒ‡å‘åŒä¸€ä¸ªæœåŠ¡ã€‚ è¿™ä¸ª handle æ˜¯ç”¨äºåœ¨åº•å±‚ Binder é©±åŠ¨ä¸­å”¯ä¸€æ ‡è¯†è¯¥æœåŠ¡çš„ã€‚ å¸Œæœ›è¿™ä¸ªå›ç­”èƒ½å¸®åˆ°ä½ ï¼å¦‚æœä½ æœ‰æ›´å¤šé—®é¢˜ï¼Œè¯·éšæ—¶æé—®ã€‚ é—®é¢˜2ï¼šè¯·é—®binderé€šè®¯è¿‡ç¨‹ä¸­æ˜¯å¦å¯ä»¥ä¼ é€’bpbinderå¯¹è±¡ï¼Ÿ æ˜¯çš„ï¼Œåœ¨ Binder é€šä¿¡è¿‡ç¨‹ä¸­å¯ä»¥ä¼ é€’ BpBinder å¯¹è±¡ã€‚ BpBinder æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯ä¾§çš„ Binder å¼•ç”¨ï¼Œå®ƒåœ¨è·¨è¿›ç¨‹é€šä¿¡ä¸­å¯ä»¥è¢«å½“ä½œæ™®é€šçš„ Binder å¯¹è±¡ä¼ é€’ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š åˆ›å»º BpBinder: å®¢æˆ·ç«¯è¿›ç¨‹é€šè¿‡ ServiceManager è·å–æœåŠ¡çš„ BpBinder å¼•ç”¨ã€‚ ä¼ é€’ BpBinder: åœ¨è¿›è¡Œ Binder é€šä¿¡æ—¶ï¼Œè¿™ä¸ª BpBinder å¯ä»¥ä½œä¸ºå‚æ•°é™„å¸¦åœ¨ Parcel ä¸­ä¼ é€’ç»™å…¶ä»–è¿›ç¨‹ã€‚ ä½¿ç”¨ BpBinder: æ¥æ”¶æ–¹è¿›ç¨‹ä¼šæ”¶åˆ°è¿™ä¸ª BpBinder å¼•ç”¨ï¼Œå¹¶å¯ä»¥é€šè¿‡å®ƒä¸åŸæœåŠ¡è¿›è¡Œé€šä¿¡ã€‚ è¿™ç§æœºåˆ¶ä½¿å¾— Binder èƒ½å¤Ÿçµæ´»åœ°æ”¯æŒå¯¹è±¡å¼•ç”¨çš„ä¼ é€’å’Œè·¨è¿›ç¨‹äº¤äº’ï¼Œæ˜¯ Android IPC çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ã€‚ é—®é¢˜3ï¼šè¯·é—®åŒbinder æœåŠ¡ç«¯è¿›ç¨‹è‡ªå·±è¿›ç¨‹å†…éƒ¨å¦‚æœè¿›è¡Œbinderè°ƒç”¨éœ€è¦ç»è¿‡binderé©±åŠ¨å—ï¼Œéœ€è¦å’Œä¸éœ€è¦è¯·è¯¦ç»†æè¿°ï¼Ÿ è¿™ä¸ªè¦çœ‹æƒ…å†µå’Œè°ƒç”¨æ–¹å¼ï¼š ä¸€ é€šè¿‡aidlçš„æ–¹å¼ï¼ŒAIDL æ¥å£ç”Ÿæˆçš„æ—¶å€™ï¼Œæœ‰åŒºåˆ†æ˜¯å¦æ˜¯æœ¬åœ°è¿›ç¨‹è¿˜æ˜¯è¿œç¨‹è¿›ç¨‹ Stub çš„ç©ºæ„é€ å‡½æ•°ã€‚è€ŒStub æœ¬èº«åˆæ˜¯Binder çš„å­ç±»ã€‚è°ƒç”¨äº†Binder çš„attachInterface æ–¹æ³•ã€‚ public Stub() { this.attachInterface(this, DESCRIPTOR); } public void attachInterface(@Nullable IInterface owner, @Nullable String descriptor) { mOwner = owner; mDescriptor = descriptor; } åˆ†åˆ«ä¿å­˜äº†å½“å‰ç±»çš„å®ä¾‹å¯¹è±¡ï¼ˆThisï¼‰å’Œå½“å‰ç±»æ¥å£æè¿°ç¬¦ï¼ˆDESCRIPTORï¼‰ï¼Œå…¶å®å°±æ˜¯ private static final java.lang.String DESCRIPTOR = â€œcom.example.aidlapplication.IMyAidlInterfaceâ€; å½“å‰ç±»çš„å…¨è·¯å¾„ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨ä½¿ç”¨aidl çš„æ—¶å€™æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¿…é¡»è¦ä¿è¯ç›¸åŒè·¯å¾„ä¸‹çš„åŸå› ï¼Œå› ä¸ºä»–è¢«ä¿å­˜ä¸‹æ¥ä½œä¸ºå‚æ•°ç”¨äºæ¯”å¯¹å½“å‰ç±»æ˜¯å¦æ˜¯æœ¬åœ°ç±»è¿˜æ˜¯è¿œç¨‹ã€‚ æ‰€ä»¥åœ¨ IMyAidlInterface iMyAidlInterface = IMyAidlInterface.Stub.asInterface(service) public static com.example.aidlapplication.IMyAidlInterface asInterface(android.os.IBinder obj) { if ((obj==null)) { return null; } android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR); if (((iin!=null)\u0026\u0026(iin instanceof com.example.aidlapplication.IMyAidlInterface))) { return ((com.example.aidlapplication.IMyAidlInterface)iin); } return new com.example.aidlapplication.IMyAidlInterface.Stub.Proxy(obj); } @Override public android.os.IBinder asBinder() { return this; } å‚è€ƒè¿™ç¯‡ï¼šandroid Binder queryLocalInterface æœ¬åœ°ä¸è¿œç¨‹-CSDNåšå®¢ äºŒ é€šè¿‡bind service è¿™ç§æ–¹å¼å¯èƒ½è¿˜æ˜¯è¦é€šè¿‡binderå»è°ƒç”¨ï¼Œä½†åœ¨binderé©±åŠ¨å†…éƒ¨ï¼Œå¯èƒ½è¿˜æ˜¯æœ‰ä¸€å®šçš„ä¼˜åŒ–æµç¨‹ã€‚ #TODO é—®é¢˜4ï¼šAndroid Appè¿›ç¨‹å¤©ç”Ÿæ”¯æŒbinderé€šè®¯çš„åŸç†æ˜¯ä»€ä¹ˆï¼Œåˆšå¼€å§‹åˆå§‹åŒ–æ—¶å€™è‡ªå¸¦äº†å‡ ä¸ªbinderçº¿ç¨‹ï¼Ÿ zygote å¯åŠ¨çš„æ—¶å€™å°±æ”¯æŒäº†binderé€šè®¯ï¼Œæ‰€æœ‰åé¢çš„appå­µåŒ–ä¹‹åï¼Œä¹Ÿä¼šè‡ªå¸¦binderé€šè®¯ã€‚ zygote åœ¨ initçš„æ—¶å€™ï¼š 1. å¯åŠ¨ ProcessState ProcessState::self() 2. å¯åŠ¨çº¿ç¨‹æ± ï¼šproc-\u003estartThreadPool(); virtual void onZygoteInit() { sp proc = ProcessState::self(); ALOGV(\"App process: starting thread pool.\\n\"); proc-\u003estartThreadPool(); } new ProcessState(kDefaultDriver); sp ProcessState::self() { Mutex::Autolock _l(gProcessMutex); if (gProcess != nullptr) { return gProcess; } gProcess = new ProcessState(kDefaultDriver); return gProcess; } mDriverFD(open_driver(driver)) æ‰“å¼€é©±åŠ¨ mMaxThreads(DEFAULT_MAX_BINDER_THREADS) æœ€å¤§çº¿ç¨‹æ•° mmap(0, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, 0); æ˜ å°„å†…å­˜ BINDER_VM_SIZE é»˜è®¤ 1M- 2PageSize ProcessState::ProcessState(const char *driver) : mDriverName(String8(driver)) , mDriverFD(open_driver(driver)) , mVMStart(MAP_FAILED) , mThreadCountLock(PTHREAD_MUTEX_INITIALIZER) , mThreadCountDecrement(PTHREAD_COND_INITIALIZER) , mExecutingThreadsCount(0) , mMaxThreads(DEFAULT_MAX_BINDER_THREADS) , mStarvationStartTimeMs(0) , mManagesContexts(false) , mBinderContextCheckFunc(NULL) , mBinderContextUserData(NULL) , mThreadPoolStarted(false) , mThreadPoolSeq(1) { if (mDriverFD \u003e= 0) { // mmap the binder, providing a chunk of virtual address space to receive transactions. mVMStart = mmap(0, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, 0); if (mVMStart == MAP_FAILED) { // *sigh* ALOGE(\"Using /dev/binder failed: unable to mmap transaction memory.\\n\"); close(mDriverFD); mDriverFD = -1; mDriverName.clear(); } } LOG_ALWAYS_FATAL_IF(mDriverFD \u003c 0, \"Binder driver could not be opened. Terminating.\"); } void IPCThreadState::joinThreadPool(b","date":"2024-11-06","objectID":"/posts/%E6%B1%87%E6%80%BBbinder%E7%9B%B8%E5%85%B3%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/:0:1","tags":["clippings","è½¬è½½","blog"],"title":"æ±‡æ€»binderç›¸å…³ä¸€äº›å¸¸è§é¢è¯•é¢˜-å®‰å“ç³»ç»Ÿå¸¸è§é¢è¯•é¢˜-CSDNåšå®¢","uri":"/posts/%E6%B1%87%E6%80%BBbinder%E7%9B%B8%E5%85%B3%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/#2-å¯åŠ¨çº¿ç¨‹æ± proc-startthreadpool"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"binderè®¨è®ºçš„ä¸€äº›åœºæ™¯é¢è¯•é¢˜ é—®é¢˜1ï¼šbinderä¸­æœ‰å¤šä¸ªè¿›ç¨‹ä½œä¸ºå®¢æˆ·ç«¯é€šè¿‡servicemanagerè·å–serviceçš„bpbinderï¼Œbpbinderéƒ½ä¼šæœ‰ä¸€ä¸ªhandleï¼Œé‚£ä¹ˆå¤šä¸ªè¿›ç¨‹è·å–åŒä¸€ä¸ªserviceå¯¹åº”çš„handleä¸€æ ·ä¹ˆï¼Ÿ æ˜¯çš„ï¼Œå¤šä¸ªè¿›ç¨‹è·å–åŒä¸€ä¸ªæœåŠ¡å¯¹åº”çš„ BpBinder çš„ handle æ˜¯ä¸€æ ·çš„ã€‚ åœ¨ Android çš„ Binder IPC æœºåˆ¶ä¸­ï¼ŒServiceManager è´Ÿè´£ç®¡ç†ç³»ç»Ÿä¸­çš„å„ç§æœåŠ¡ã€‚å½“ä¸€ä¸ªå®¢æˆ·ç«¯è¿›ç¨‹è¯·æ±‚æŸä¸ªæœåŠ¡æ—¶ï¼Œå®ƒä¼šé€šè¿‡ ServiceManager è·å–åˆ°æœåŠ¡çš„ Binder å¼•ç”¨ï¼ˆå³ BpBinderï¼‰ï¼Œè¿™ä¸ªå¼•ç”¨åœ¨å†…éƒ¨åŒ…å«äº†ä¸€ä¸ª handleï¼Œè¯¥ handle æ˜¯ä¸€ä¸ªæ•´æ•°å€¼ï¼Œå”¯ä¸€æ ‡è¯†äº†è¿™ä¸ªæœåŠ¡åœ¨ Binder é©±åŠ¨ä¸­çš„ä½ç½®ã€‚ ç”±äºä¸åŒè¿›ç¨‹è·å–çš„éƒ½æ˜¯åŒä¸€ä¸ªæœåŠ¡çš„å¼•ç”¨ï¼Œæ‰€ä»¥å®ƒä»¬è·å–åˆ°çš„ BpBinder ä¸­çš„ handle æ˜¯ç›¸åŒçš„ã€‚è¿™ä¸ª handle ç”¨äºåœ¨ Binder é©±åŠ¨å±‚è¿›è¡Œé€šä¿¡æ—¶æ ‡è¯†ç›®æ ‡æœåŠ¡ï¼Œä»è€Œç¡®ä¿å®¢æˆ·ç«¯è¿›ç¨‹èƒ½å¤Ÿæ­£ç¡®åœ°ä¸ç›®æ ‡æœåŠ¡è¿›è¡Œäº¤äº’ã€‚ æ€»ç»“æ¥è¯´ï¼š ä¸åŒè¿›ç¨‹é€šè¿‡ ServiceManager è·å–åŒä¸€ä¸ªæœåŠ¡çš„ BpBinderã€‚ è¿™äº› BpBinder å¯¹è±¡ä¸­çš„ handle æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºå®ƒä»¬éƒ½æŒ‡å‘åŒä¸€ä¸ªæœåŠ¡ã€‚ è¿™ä¸ª handle æ˜¯ç”¨äºåœ¨åº•å±‚ Binder é©±åŠ¨ä¸­å”¯ä¸€æ ‡è¯†è¯¥æœåŠ¡çš„ã€‚ å¸Œæœ›è¿™ä¸ªå›ç­”èƒ½å¸®åˆ°ä½ ï¼å¦‚æœä½ æœ‰æ›´å¤šé—®é¢˜ï¼Œè¯·éšæ—¶æé—®ã€‚ é—®é¢˜2ï¼šè¯·é—®binderé€šè®¯è¿‡ç¨‹ä¸­æ˜¯å¦å¯ä»¥ä¼ é€’bpbinderå¯¹è±¡ï¼Ÿ æ˜¯çš„ï¼Œåœ¨ Binder é€šä¿¡è¿‡ç¨‹ä¸­å¯ä»¥ä¼ é€’ BpBinder å¯¹è±¡ã€‚ BpBinder æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯ä¾§çš„ Binder å¼•ç”¨ï¼Œå®ƒåœ¨è·¨è¿›ç¨‹é€šä¿¡ä¸­å¯ä»¥è¢«å½“ä½œæ™®é€šçš„ Binder å¯¹è±¡ä¼ é€’ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š åˆ›å»º BpBinder: å®¢æˆ·ç«¯è¿›ç¨‹é€šè¿‡ ServiceManager è·å–æœåŠ¡çš„ BpBinder å¼•ç”¨ã€‚ ä¼ é€’ BpBinder: åœ¨è¿›è¡Œ Binder é€šä¿¡æ—¶ï¼Œè¿™ä¸ª BpBinder å¯ä»¥ä½œä¸ºå‚æ•°é™„å¸¦åœ¨ Parcel ä¸­ä¼ é€’ç»™å…¶ä»–è¿›ç¨‹ã€‚ ä½¿ç”¨ BpBinder: æ¥æ”¶æ–¹è¿›ç¨‹ä¼šæ”¶åˆ°è¿™ä¸ª BpBinder å¼•ç”¨ï¼Œå¹¶å¯ä»¥é€šè¿‡å®ƒä¸åŸæœåŠ¡è¿›è¡Œé€šä¿¡ã€‚ è¿™ç§æœºåˆ¶ä½¿å¾— Binder èƒ½å¤Ÿçµæ´»åœ°æ”¯æŒå¯¹è±¡å¼•ç”¨çš„ä¼ é€’å’Œè·¨è¿›ç¨‹äº¤äº’ï¼Œæ˜¯ Android IPC çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ã€‚ é—®é¢˜3ï¼šè¯·é—®åŒbinder æœåŠ¡ç«¯è¿›ç¨‹è‡ªå·±è¿›ç¨‹å†…éƒ¨å¦‚æœè¿›è¡Œbinderè°ƒç”¨éœ€è¦ç»è¿‡binderé©±åŠ¨å—ï¼Œéœ€è¦å’Œä¸éœ€è¦è¯·è¯¦ç»†æè¿°ï¼Ÿ è¿™ä¸ªè¦çœ‹æƒ…å†µå’Œè°ƒç”¨æ–¹å¼ï¼š ä¸€ é€šè¿‡aidlçš„æ–¹å¼ï¼ŒAIDL æ¥å£ç”Ÿæˆçš„æ—¶å€™ï¼Œæœ‰åŒºåˆ†æ˜¯å¦æ˜¯æœ¬åœ°è¿›ç¨‹è¿˜æ˜¯è¿œç¨‹è¿›ç¨‹ Stub çš„ç©ºæ„é€ å‡½æ•°ã€‚è€ŒStub æœ¬èº«åˆæ˜¯Binder çš„å­ç±»ã€‚è°ƒç”¨äº†Binder çš„attachInterface æ–¹æ³•ã€‚ public Stub() { this.attachInterface(this, DESCRIPTOR); } public void attachInterface(@Nullable IInterface owner, @Nullable String descriptor) { mOwner = owner; mDescriptor = descriptor; } åˆ†åˆ«ä¿å­˜äº†å½“å‰ç±»çš„å®ä¾‹å¯¹è±¡ï¼ˆThisï¼‰å’Œå½“å‰ç±»æ¥å£æè¿°ç¬¦ï¼ˆDESCRIPTORï¼‰ï¼Œå…¶å®å°±æ˜¯ private static final java.lang.String DESCRIPTOR = â€œcom.example.aidlapplication.IMyAidlInterfaceâ€; å½“å‰ç±»çš„å…¨è·¯å¾„ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨ä½¿ç”¨aidl çš„æ—¶å€™æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¿…é¡»è¦ä¿è¯ç›¸åŒè·¯å¾„ä¸‹çš„åŸå› ï¼Œå› ä¸ºä»–è¢«ä¿å­˜ä¸‹æ¥ä½œä¸ºå‚æ•°ç”¨äºæ¯”å¯¹å½“å‰ç±»æ˜¯å¦æ˜¯æœ¬åœ°ç±»è¿˜æ˜¯è¿œç¨‹ã€‚ æ‰€ä»¥åœ¨ IMyAidlInterface iMyAidlInterface = IMyAidlInterface.Stub.asInterface(service) public static com.example.aidlapplication.IMyAidlInterface asInterface(android.os.IBinder obj) { if ((obj==null)) { return null; } android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR); if (((iin!=null)\u0026\u0026(iin instanceof com.example.aidlapplication.IMyAidlInterface))) { return ((com.example.aidlapplication.IMyAidlInterface)iin); } return new com.example.aidlapplication.IMyAidlInterface.Stub.Proxy(obj); } @Override public android.os.IBinder asBinder() { return this; } å‚è€ƒè¿™ç¯‡ï¼šandroid Binder queryLocalInterface æœ¬åœ°ä¸è¿œç¨‹-CSDNåšå®¢ äºŒ é€šè¿‡bind service è¿™ç§æ–¹å¼å¯èƒ½è¿˜æ˜¯è¦é€šè¿‡binderå»è°ƒç”¨ï¼Œä½†åœ¨binderé©±åŠ¨å†…éƒ¨ï¼Œå¯èƒ½è¿˜æ˜¯æœ‰ä¸€å®šçš„ä¼˜åŒ–æµç¨‹ã€‚ #TODO é—®é¢˜4ï¼šAndroid Appè¿›ç¨‹å¤©ç”Ÿæ”¯æŒbinderé€šè®¯çš„åŸç†æ˜¯ä»€ä¹ˆï¼Œåˆšå¼€å§‹åˆå§‹åŒ–æ—¶å€™è‡ªå¸¦äº†å‡ ä¸ªbinderçº¿ç¨‹ï¼Ÿ zygote å¯åŠ¨çš„æ—¶å€™å°±æ”¯æŒäº†binderé€šè®¯ï¼Œæ‰€æœ‰åé¢çš„appå­µåŒ–ä¹‹åï¼Œä¹Ÿä¼šè‡ªå¸¦binderé€šè®¯ã€‚ zygote åœ¨ initçš„æ—¶å€™ï¼š 1. å¯åŠ¨ ProcessState ProcessState::self() 2. å¯åŠ¨çº¿ç¨‹æ± ï¼šproc-\u003estartThreadPool(); virtual void onZygoteInit() { sp proc = ProcessState::self(); ALOGV(\"App process: starting thread pool.\\n\"); proc-\u003estartThreadPool(); } new ProcessState(kDefaultDriver); sp ProcessState::self() { Mutex::Autolock _l(gProcessMutex); if (gProcess != nullptr) { return gProcess; } gProcess = new ProcessState(kDefaultDriver); return gProcess; } mDriverFD(open_driver(driver)) æ‰“å¼€é©±åŠ¨ mMaxThreads(DEFAULT_MAX_BINDER_THREADS) æœ€å¤§çº¿ç¨‹æ•° mmap(0, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, 0); æ˜ å°„å†…å­˜ BINDER_VM_SIZE é»˜è®¤ 1M- 2PageSize ProcessState::ProcessState(const char *driver) : mDriverName(String8(driver)) , mDriverFD(open_driver(driver)) , mVMStart(MAP_FAILED) , mThreadCountLock(PTHREAD_MUTEX_INITIALIZER) , mThreadCountDecrement(PTHREAD_COND_INITIALIZER) , mExecutingThreadsCount(0) , mMaxThreads(DEFAULT_MAX_BINDER_THREADS) , mStarvationStartTimeMs(0) , mManagesContexts(false) , mBinderContextCheckFunc(NULL) , mBinderContextUserData(NULL) , mThreadPoolStarted(false) , mThreadPoolSeq(1) { if (mDriverFD \u003e= 0) { // mmap the binder, providing a chunk of virtual address space to receive transactions. mVMStart = mmap(0, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, 0); if (mVMStart == MAP_FAILED) { // *sigh* ALOGE(\"Using /dev/binder failed: unable to mmap transaction memory.\\n\"); close(mDriverFD); mDriverFD = -1; mDriverName.clear(); } } LOG_ALWAYS_FATAL_IF(mDriverFD \u003c 0, \"Binder driver could not be opened. Terminating.\"); } void IPCThreadState::joinThreadPool(b","date":"2024-11-06","objectID":"/posts/%E6%B1%87%E6%80%BBbinder%E7%9B%B8%E5%85%B3%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/:0:1","tags":["clippings","è½¬è½½","blog"],"title":"æ±‡æ€»binderç›¸å…³ä¸€äº›å¸¸è§é¢è¯•é¢˜-å®‰å“ç³»ç»Ÿå¸¸è§é¢è¯•é¢˜-CSDNåšå®¢","uri":"/posts/%E6%B1%87%E6%80%BBbinder%E7%9B%B8%E5%85%B3%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/#é—®é¢˜5è¯·æè¿°ä¸€ä¸‹binderé€šè®¯èµ·æ¥åéœ€è¦æ–°å¼€binderçº¿ç¨‹çš„åˆ›å»ºæ˜¯æ€ä¹ˆä¸€ä¸ªè¿‡ç¨‹"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"binderè®¨è®ºçš„ä¸€äº›åœºæ™¯é¢è¯•é¢˜ é—®é¢˜1ï¼šbinderä¸­æœ‰å¤šä¸ªè¿›ç¨‹ä½œä¸ºå®¢æˆ·ç«¯é€šè¿‡servicemanagerè·å–serviceçš„bpbinderï¼Œbpbinderéƒ½ä¼šæœ‰ä¸€ä¸ªhandleï¼Œé‚£ä¹ˆå¤šä¸ªè¿›ç¨‹è·å–åŒä¸€ä¸ªserviceå¯¹åº”çš„handleä¸€æ ·ä¹ˆï¼Ÿ æ˜¯çš„ï¼Œå¤šä¸ªè¿›ç¨‹è·å–åŒä¸€ä¸ªæœåŠ¡å¯¹åº”çš„ BpBinder çš„ handle æ˜¯ä¸€æ ·çš„ã€‚ åœ¨ Android çš„ Binder IPC æœºåˆ¶ä¸­ï¼ŒServiceManager è´Ÿè´£ç®¡ç†ç³»ç»Ÿä¸­çš„å„ç§æœåŠ¡ã€‚å½“ä¸€ä¸ªå®¢æˆ·ç«¯è¿›ç¨‹è¯·æ±‚æŸä¸ªæœåŠ¡æ—¶ï¼Œå®ƒä¼šé€šè¿‡ ServiceManager è·å–åˆ°æœåŠ¡çš„ Binder å¼•ç”¨ï¼ˆå³ BpBinderï¼‰ï¼Œè¿™ä¸ªå¼•ç”¨åœ¨å†…éƒ¨åŒ…å«äº†ä¸€ä¸ª handleï¼Œè¯¥ handle æ˜¯ä¸€ä¸ªæ•´æ•°å€¼ï¼Œå”¯ä¸€æ ‡è¯†äº†è¿™ä¸ªæœåŠ¡åœ¨ Binder é©±åŠ¨ä¸­çš„ä½ç½®ã€‚ ç”±äºä¸åŒè¿›ç¨‹è·å–çš„éƒ½æ˜¯åŒä¸€ä¸ªæœåŠ¡çš„å¼•ç”¨ï¼Œæ‰€ä»¥å®ƒä»¬è·å–åˆ°çš„ BpBinder ä¸­çš„ handle æ˜¯ç›¸åŒçš„ã€‚è¿™ä¸ª handle ç”¨äºåœ¨ Binder é©±åŠ¨å±‚è¿›è¡Œé€šä¿¡æ—¶æ ‡è¯†ç›®æ ‡æœåŠ¡ï¼Œä»è€Œç¡®ä¿å®¢æˆ·ç«¯è¿›ç¨‹èƒ½å¤Ÿæ­£ç¡®åœ°ä¸ç›®æ ‡æœåŠ¡è¿›è¡Œäº¤äº’ã€‚ æ€»ç»“æ¥è¯´ï¼š ä¸åŒè¿›ç¨‹é€šè¿‡ ServiceManager è·å–åŒä¸€ä¸ªæœåŠ¡çš„ BpBinderã€‚ è¿™äº› BpBinder å¯¹è±¡ä¸­çš„ handle æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºå®ƒä»¬éƒ½æŒ‡å‘åŒä¸€ä¸ªæœåŠ¡ã€‚ è¿™ä¸ª handle æ˜¯ç”¨äºåœ¨åº•å±‚ Binder é©±åŠ¨ä¸­å”¯ä¸€æ ‡è¯†è¯¥æœåŠ¡çš„ã€‚ å¸Œæœ›è¿™ä¸ªå›ç­”èƒ½å¸®åˆ°ä½ ï¼å¦‚æœä½ æœ‰æ›´å¤šé—®é¢˜ï¼Œè¯·éšæ—¶æé—®ã€‚ é—®é¢˜2ï¼šè¯·é—®binderé€šè®¯è¿‡ç¨‹ä¸­æ˜¯å¦å¯ä»¥ä¼ é€’bpbinderå¯¹è±¡ï¼Ÿ æ˜¯çš„ï¼Œåœ¨ Binder é€šä¿¡è¿‡ç¨‹ä¸­å¯ä»¥ä¼ é€’ BpBinder å¯¹è±¡ã€‚ BpBinder æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯ä¾§çš„ Binder å¼•ç”¨ï¼Œå®ƒåœ¨è·¨è¿›ç¨‹é€šä¿¡ä¸­å¯ä»¥è¢«å½“ä½œæ™®é€šçš„ Binder å¯¹è±¡ä¼ é€’ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š åˆ›å»º BpBinder: å®¢æˆ·ç«¯è¿›ç¨‹é€šè¿‡ ServiceManager è·å–æœåŠ¡çš„ BpBinder å¼•ç”¨ã€‚ ä¼ é€’ BpBinder: åœ¨è¿›è¡Œ Binder é€šä¿¡æ—¶ï¼Œè¿™ä¸ª BpBinder å¯ä»¥ä½œä¸ºå‚æ•°é™„å¸¦åœ¨ Parcel ä¸­ä¼ é€’ç»™å…¶ä»–è¿›ç¨‹ã€‚ ä½¿ç”¨ BpBinder: æ¥æ”¶æ–¹è¿›ç¨‹ä¼šæ”¶åˆ°è¿™ä¸ª BpBinder å¼•ç”¨ï¼Œå¹¶å¯ä»¥é€šè¿‡å®ƒä¸åŸæœåŠ¡è¿›è¡Œé€šä¿¡ã€‚ è¿™ç§æœºåˆ¶ä½¿å¾— Binder èƒ½å¤Ÿçµæ´»åœ°æ”¯æŒå¯¹è±¡å¼•ç”¨çš„ä¼ é€’å’Œè·¨è¿›ç¨‹äº¤äº’ï¼Œæ˜¯ Android IPC çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ã€‚ é—®é¢˜3ï¼šè¯·é—®åŒbinder æœåŠ¡ç«¯è¿›ç¨‹è‡ªå·±è¿›ç¨‹å†…éƒ¨å¦‚æœè¿›è¡Œbinderè°ƒç”¨éœ€è¦ç»è¿‡binderé©±åŠ¨å—ï¼Œéœ€è¦å’Œä¸éœ€è¦è¯·è¯¦ç»†æè¿°ï¼Ÿ è¿™ä¸ªè¦çœ‹æƒ…å†µå’Œè°ƒç”¨æ–¹å¼ï¼š ä¸€ é€šè¿‡aidlçš„æ–¹å¼ï¼ŒAIDL æ¥å£ç”Ÿæˆçš„æ—¶å€™ï¼Œæœ‰åŒºåˆ†æ˜¯å¦æ˜¯æœ¬åœ°è¿›ç¨‹è¿˜æ˜¯è¿œç¨‹è¿›ç¨‹ Stub çš„ç©ºæ„é€ å‡½æ•°ã€‚è€ŒStub æœ¬èº«åˆæ˜¯Binder çš„å­ç±»ã€‚è°ƒç”¨äº†Binder çš„attachInterface æ–¹æ³•ã€‚ public Stub() { this.attachInterface(this, DESCRIPTOR); } public void attachInterface(@Nullable IInterface owner, @Nullable String descriptor) { mOwner = owner; mDescriptor = descriptor; } åˆ†åˆ«ä¿å­˜äº†å½“å‰ç±»çš„å®ä¾‹å¯¹è±¡ï¼ˆThisï¼‰å’Œå½“å‰ç±»æ¥å£æè¿°ç¬¦ï¼ˆDESCRIPTORï¼‰ï¼Œå…¶å®å°±æ˜¯ private static final java.lang.String DESCRIPTOR = â€œcom.example.aidlapplication.IMyAidlInterfaceâ€; å½“å‰ç±»çš„å…¨è·¯å¾„ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨ä½¿ç”¨aidl çš„æ—¶å€™æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¿…é¡»è¦ä¿è¯ç›¸åŒè·¯å¾„ä¸‹çš„åŸå› ï¼Œå› ä¸ºä»–è¢«ä¿å­˜ä¸‹æ¥ä½œä¸ºå‚æ•°ç”¨äºæ¯”å¯¹å½“å‰ç±»æ˜¯å¦æ˜¯æœ¬åœ°ç±»è¿˜æ˜¯è¿œç¨‹ã€‚ æ‰€ä»¥åœ¨ IMyAidlInterface iMyAidlInterface = IMyAidlInterface.Stub.asInterface(service) public static com.example.aidlapplication.IMyAidlInterface asInterface(android.os.IBinder obj) { if ((obj==null)) { return null; } android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR); if (((iin!=null)\u0026\u0026(iin instanceof com.example.aidlapplication.IMyAidlInterface))) { return ((com.example.aidlapplication.IMyAidlInterface)iin); } return new com.example.aidlapplication.IMyAidlInterface.Stub.Proxy(obj); } @Override public android.os.IBinder asBinder() { return this; } å‚è€ƒè¿™ç¯‡ï¼šandroid Binder queryLocalInterface æœ¬åœ°ä¸è¿œç¨‹-CSDNåšå®¢ äºŒ é€šè¿‡bind service è¿™ç§æ–¹å¼å¯èƒ½è¿˜æ˜¯è¦é€šè¿‡binderå»è°ƒç”¨ï¼Œä½†åœ¨binderé©±åŠ¨å†…éƒ¨ï¼Œå¯èƒ½è¿˜æ˜¯æœ‰ä¸€å®šçš„ä¼˜åŒ–æµç¨‹ã€‚ #TODO é—®é¢˜4ï¼šAndroid Appè¿›ç¨‹å¤©ç”Ÿæ”¯æŒbinderé€šè®¯çš„åŸç†æ˜¯ä»€ä¹ˆï¼Œåˆšå¼€å§‹åˆå§‹åŒ–æ—¶å€™è‡ªå¸¦äº†å‡ ä¸ªbinderçº¿ç¨‹ï¼Ÿ zygote å¯åŠ¨çš„æ—¶å€™å°±æ”¯æŒäº†binderé€šè®¯ï¼Œæ‰€æœ‰åé¢çš„appå­µåŒ–ä¹‹åï¼Œä¹Ÿä¼šè‡ªå¸¦binderé€šè®¯ã€‚ zygote åœ¨ initçš„æ—¶å€™ï¼š 1. å¯åŠ¨ ProcessState ProcessState::self() 2. å¯åŠ¨çº¿ç¨‹æ± ï¼šproc-\u003estartThreadPool(); virtual void onZygoteInit() { sp proc = ProcessState::self(); ALOGV(\"App process: starting thread pool.\\n\"); proc-\u003estartThreadPool(); } new ProcessState(kDefaultDriver); sp ProcessState::self() { Mutex::Autolock _l(gProcessMutex); if (gProcess != nullptr) { return gProcess; } gProcess = new ProcessState(kDefaultDriver); return gProcess; } mDriverFD(open_driver(driver)) æ‰“å¼€é©±åŠ¨ mMaxThreads(DEFAULT_MAX_BINDER_THREADS) æœ€å¤§çº¿ç¨‹æ•° mmap(0, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, 0); æ˜ å°„å†…å­˜ BINDER_VM_SIZE é»˜è®¤ 1M- 2PageSize ProcessState::ProcessState(const char *driver) : mDriverName(String8(driver)) , mDriverFD(open_driver(driver)) , mVMStart(MAP_FAILED) , mThreadCountLock(PTHREAD_MUTEX_INITIALIZER) , mThreadCountDecrement(PTHREAD_COND_INITIALIZER) , mExecutingThreadsCount(0) , mMaxThreads(DEFAULT_MAX_BINDER_THREADS) , mStarvationStartTimeMs(0) , mManagesContexts(false) , mBinderContextCheckFunc(NULL) , mBinderContextUserData(NULL) , mThreadPoolStarted(false) , mThreadPoolSeq(1) { if (mDriverFD \u003e= 0) { // mmap the binder, providing a chunk of virtual address space to receive transactions. mVMStart = mmap(0, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, 0); if (mVMStart == MAP_FAILED) { // *sigh* ALOGE(\"Using /dev/binder failed: unable to mmap transaction memory.\\n\"); close(mDriverFD); mDriverFD = -1; mDriverName.clear(); } } LOG_ALWAYS_FATAL_IF(mDriverFD \u003c 0, \"Binder driver could not be opened. Terminating.\"); } void IPCThreadState::joinThreadPool(b","date":"2024-11-06","objectID":"/posts/%E6%B1%87%E6%80%BBbinder%E7%9B%B8%E5%85%B3%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/:0:1","tags":["clippings","è½¬è½½","blog"],"title":"æ±‡æ€»binderç›¸å…³ä¸€äº›å¸¸è§é¢è¯•é¢˜-å®‰å“ç³»ç»Ÿå¸¸è§é¢è¯•é¢˜-CSDNåšå®¢","uri":"/posts/%E6%B1%87%E6%80%BBbinder%E7%9B%B8%E5%85%B3%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/#é—®é¢˜6è¯·é—®binderçš„å¦‚ä½•ä½¿ç”¨å¼‚æ­¥è¯·æ±‚ä¼˜åŠ¿æ˜¯ä»€ä¹ˆä½†é¢‘ç¹ä½¿ç”¨ç›¸å…³é£é™©"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"binderè®¨è®ºçš„ä¸€äº›åœºæ™¯é¢è¯•é¢˜ é—®é¢˜1ï¼šbinderä¸­æœ‰å¤šä¸ªè¿›ç¨‹ä½œä¸ºå®¢æˆ·ç«¯é€šè¿‡servicemanagerè·å–serviceçš„bpbinderï¼Œbpbinderéƒ½ä¼šæœ‰ä¸€ä¸ªhandleï¼Œé‚£ä¹ˆå¤šä¸ªè¿›ç¨‹è·å–åŒä¸€ä¸ªserviceå¯¹åº”çš„handleä¸€æ ·ä¹ˆï¼Ÿ æ˜¯çš„ï¼Œå¤šä¸ªè¿›ç¨‹è·å–åŒä¸€ä¸ªæœåŠ¡å¯¹åº”çš„ BpBinder çš„ handle æ˜¯ä¸€æ ·çš„ã€‚ åœ¨ Android çš„ Binder IPC æœºåˆ¶ä¸­ï¼ŒServiceManager è´Ÿè´£ç®¡ç†ç³»ç»Ÿä¸­çš„å„ç§æœåŠ¡ã€‚å½“ä¸€ä¸ªå®¢æˆ·ç«¯è¿›ç¨‹è¯·æ±‚æŸä¸ªæœåŠ¡æ—¶ï¼Œå®ƒä¼šé€šè¿‡ ServiceManager è·å–åˆ°æœåŠ¡çš„ Binder å¼•ç”¨ï¼ˆå³ BpBinderï¼‰ï¼Œè¿™ä¸ªå¼•ç”¨åœ¨å†…éƒ¨åŒ…å«äº†ä¸€ä¸ª handleï¼Œè¯¥ handle æ˜¯ä¸€ä¸ªæ•´æ•°å€¼ï¼Œå”¯ä¸€æ ‡è¯†äº†è¿™ä¸ªæœåŠ¡åœ¨ Binder é©±åŠ¨ä¸­çš„ä½ç½®ã€‚ ç”±äºä¸åŒè¿›ç¨‹è·å–çš„éƒ½æ˜¯åŒä¸€ä¸ªæœåŠ¡çš„å¼•ç”¨ï¼Œæ‰€ä»¥å®ƒä»¬è·å–åˆ°çš„ BpBinder ä¸­çš„ handle æ˜¯ç›¸åŒçš„ã€‚è¿™ä¸ª handle ç”¨äºåœ¨ Binder é©±åŠ¨å±‚è¿›è¡Œé€šä¿¡æ—¶æ ‡è¯†ç›®æ ‡æœåŠ¡ï¼Œä»è€Œç¡®ä¿å®¢æˆ·ç«¯è¿›ç¨‹èƒ½å¤Ÿæ­£ç¡®åœ°ä¸ç›®æ ‡æœåŠ¡è¿›è¡Œäº¤äº’ã€‚ æ€»ç»“æ¥è¯´ï¼š ä¸åŒè¿›ç¨‹é€šè¿‡ ServiceManager è·å–åŒä¸€ä¸ªæœåŠ¡çš„ BpBinderã€‚ è¿™äº› BpBinder å¯¹è±¡ä¸­çš„ handle æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸ºå®ƒä»¬éƒ½æŒ‡å‘åŒä¸€ä¸ªæœåŠ¡ã€‚ è¿™ä¸ª handle æ˜¯ç”¨äºåœ¨åº•å±‚ Binder é©±åŠ¨ä¸­å”¯ä¸€æ ‡è¯†è¯¥æœåŠ¡çš„ã€‚ å¸Œæœ›è¿™ä¸ªå›ç­”èƒ½å¸®åˆ°ä½ ï¼å¦‚æœä½ æœ‰æ›´å¤šé—®é¢˜ï¼Œè¯·éšæ—¶æé—®ã€‚ é—®é¢˜2ï¼šè¯·é—®binderé€šè®¯è¿‡ç¨‹ä¸­æ˜¯å¦å¯ä»¥ä¼ é€’bpbinderå¯¹è±¡ï¼Ÿ æ˜¯çš„ï¼Œåœ¨ Binder é€šä¿¡è¿‡ç¨‹ä¸­å¯ä»¥ä¼ é€’ BpBinder å¯¹è±¡ã€‚ BpBinder æ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯ä¾§çš„ Binder å¼•ç”¨ï¼Œå®ƒåœ¨è·¨è¿›ç¨‹é€šä¿¡ä¸­å¯ä»¥è¢«å½“ä½œæ™®é€šçš„ Binder å¯¹è±¡ä¼ é€’ã€‚å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ï¼š åˆ›å»º BpBinder: å®¢æˆ·ç«¯è¿›ç¨‹é€šè¿‡ ServiceManager è·å–æœåŠ¡çš„ BpBinder å¼•ç”¨ã€‚ ä¼ é€’ BpBinder: åœ¨è¿›è¡Œ Binder é€šä¿¡æ—¶ï¼Œè¿™ä¸ª BpBinder å¯ä»¥ä½œä¸ºå‚æ•°é™„å¸¦åœ¨ Parcel ä¸­ä¼ é€’ç»™å…¶ä»–è¿›ç¨‹ã€‚ ä½¿ç”¨ BpBinder: æ¥æ”¶æ–¹è¿›ç¨‹ä¼šæ”¶åˆ°è¿™ä¸ª BpBinder å¼•ç”¨ï¼Œå¹¶å¯ä»¥é€šè¿‡å®ƒä¸åŸæœåŠ¡è¿›è¡Œé€šä¿¡ã€‚ è¿™ç§æœºåˆ¶ä½¿å¾— Binder èƒ½å¤Ÿçµæ´»åœ°æ”¯æŒå¯¹è±¡å¼•ç”¨çš„ä¼ é€’å’Œè·¨è¿›ç¨‹äº¤äº’ï¼Œæ˜¯ Android IPC çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ã€‚ é—®é¢˜3ï¼šè¯·é—®åŒbinder æœåŠ¡ç«¯è¿›ç¨‹è‡ªå·±è¿›ç¨‹å†…éƒ¨å¦‚æœè¿›è¡Œbinderè°ƒç”¨éœ€è¦ç»è¿‡binderé©±åŠ¨å—ï¼Œéœ€è¦å’Œä¸éœ€è¦è¯·è¯¦ç»†æè¿°ï¼Ÿ è¿™ä¸ªè¦çœ‹æƒ…å†µå’Œè°ƒç”¨æ–¹å¼ï¼š ä¸€ é€šè¿‡aidlçš„æ–¹å¼ï¼ŒAIDL æ¥å£ç”Ÿæˆçš„æ—¶å€™ï¼Œæœ‰åŒºåˆ†æ˜¯å¦æ˜¯æœ¬åœ°è¿›ç¨‹è¿˜æ˜¯è¿œç¨‹è¿›ç¨‹ Stub çš„ç©ºæ„é€ å‡½æ•°ã€‚è€ŒStub æœ¬èº«åˆæ˜¯Binder çš„å­ç±»ã€‚è°ƒç”¨äº†Binder çš„attachInterface æ–¹æ³•ã€‚ public Stub() { this.attachInterface(this, DESCRIPTOR); } public void attachInterface(@Nullable IInterface owner, @Nullable String descriptor) { mOwner = owner; mDescriptor = descriptor; } åˆ†åˆ«ä¿å­˜äº†å½“å‰ç±»çš„å®ä¾‹å¯¹è±¡ï¼ˆThisï¼‰å’Œå½“å‰ç±»æ¥å£æè¿°ç¬¦ï¼ˆDESCRIPTORï¼‰ï¼Œå…¶å®å°±æ˜¯ private static final java.lang.String DESCRIPTOR = â€œcom.example.aidlapplication.IMyAidlInterfaceâ€; å½“å‰ç±»çš„å…¨è·¯å¾„ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨ä½¿ç”¨aidl çš„æ—¶å€™æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¿…é¡»è¦ä¿è¯ç›¸åŒè·¯å¾„ä¸‹çš„åŸå› ï¼Œå› ä¸ºä»–è¢«ä¿å­˜ä¸‹æ¥ä½œä¸ºå‚æ•°ç”¨äºæ¯”å¯¹å½“å‰ç±»æ˜¯å¦æ˜¯æœ¬åœ°ç±»è¿˜æ˜¯è¿œç¨‹ã€‚ æ‰€ä»¥åœ¨ IMyAidlInterface iMyAidlInterface = IMyAidlInterface.Stub.asInterface(service) public static com.example.aidlapplication.IMyAidlInterface asInterface(android.os.IBinder obj) { if ((obj==null)) { return null; } android.os.IInterface iin = obj.queryLocalInterface(DESCRIPTOR); if (((iin!=null)\u0026\u0026(iin instanceof com.example.aidlapplication.IMyAidlInterface))) { return ((com.example.aidlapplication.IMyAidlInterface)iin); } return new com.example.aidlapplication.IMyAidlInterface.Stub.Proxy(obj); } @Override public android.os.IBinder asBinder() { return this; } å‚è€ƒè¿™ç¯‡ï¼šandroid Binder queryLocalInterface æœ¬åœ°ä¸è¿œç¨‹-CSDNåšå®¢ äºŒ é€šè¿‡bind service è¿™ç§æ–¹å¼å¯èƒ½è¿˜æ˜¯è¦é€šè¿‡binderå»è°ƒç”¨ï¼Œä½†åœ¨binderé©±åŠ¨å†…éƒ¨ï¼Œå¯èƒ½è¿˜æ˜¯æœ‰ä¸€å®šçš„ä¼˜åŒ–æµç¨‹ã€‚ #TODO é—®é¢˜4ï¼šAndroid Appè¿›ç¨‹å¤©ç”Ÿæ”¯æŒbinderé€šè®¯çš„åŸç†æ˜¯ä»€ä¹ˆï¼Œåˆšå¼€å§‹åˆå§‹åŒ–æ—¶å€™è‡ªå¸¦äº†å‡ ä¸ªbinderçº¿ç¨‹ï¼Ÿ zygote å¯åŠ¨çš„æ—¶å€™å°±æ”¯æŒäº†binderé€šè®¯ï¼Œæ‰€æœ‰åé¢çš„appå­µåŒ–ä¹‹åï¼Œä¹Ÿä¼šè‡ªå¸¦binderé€šè®¯ã€‚ zygote åœ¨ initçš„æ—¶å€™ï¼š 1. å¯åŠ¨ ProcessState ProcessState::self() 2. å¯åŠ¨çº¿ç¨‹æ± ï¼šproc-\u003estartThreadPool(); virtual void onZygoteInit() { sp proc = ProcessState::self(); ALOGV(\"App process: starting thread pool.\\n\"); proc-\u003estartThreadPool(); } new ProcessState(kDefaultDriver); sp ProcessState::self() { Mutex::Autolock _l(gProcessMutex); if (gProcess != nullptr) { return gProcess; } gProcess = new ProcessState(kDefaultDriver); return gProcess; } mDriverFD(open_driver(driver)) æ‰“å¼€é©±åŠ¨ mMaxThreads(DEFAULT_MAX_BINDER_THREADS) æœ€å¤§çº¿ç¨‹æ•° mmap(0, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, 0); æ˜ å°„å†…å­˜ BINDER_VM_SIZE é»˜è®¤ 1M- 2PageSize ProcessState::ProcessState(const char *driver) : mDriverName(String8(driver)) , mDriverFD(open_driver(driver)) , mVMStart(MAP_FAILED) , mThreadCountLock(PTHREAD_MUTEX_INITIALIZER) , mThreadCountDecrement(PTHREAD_COND_INITIALIZER) , mExecutingThreadsCount(0) , mMaxThreads(DEFAULT_MAX_BINDER_THREADS) , mStarvationStartTimeMs(0) , mManagesContexts(false) , mBinderContextCheckFunc(NULL) , mBinderContextUserData(NULL) , mThreadPoolStarted(false) , mThreadPoolSeq(1) { if (mDriverFD \u003e= 0) { // mmap the binder, providing a chunk of virtual address space to receive transactions. mVMStart = mmap(0, BINDER_VM_SIZE, PROT_READ, MAP_PRIVATE | MAP_NORESERVE, mDriverFD, 0); if (mVMStart == MAP_FAILED) { // *sigh* ALOGE(\"Using /dev/binder failed: unable to mmap transaction memory.\\n\"); close(mDriverFD); mDriverFD = -1; mDriverName.clear(); } } LOG_ALWAYS_FATAL_IF(mDriverFD \u003c 0, \"Binder driver could not be opened. Terminating.\"); } void IPCThreadState::joinThreadPool(b","date":"2024-11-06","objectID":"/posts/%E6%B1%87%E6%80%BBbinder%E7%9B%B8%E5%85%B3%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/:0:1","tags":["clippings","è½¬è½½","blog"],"title":"æ±‡æ€»binderç›¸å…³ä¸€äº›å¸¸è§é¢è¯•é¢˜-å®‰å“ç³»ç»Ÿå¸¸è§é¢è¯•é¢˜-CSDNåšå®¢","uri":"/posts/%E6%B1%87%E6%80%BBbinder%E7%9B%B8%E5%85%B3%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/#é—®é¢˜7è·¨è¿›ç¨‹é€šè®¯ä¸€èˆ¬éƒ½éœ€è¦é€šè¿‡servicemanagerè¿›è¡Œgetserviceè·å–bpbinderä½†æ™®é€šappç»å¸¸ä½¿ç”¨ç³»ç»Ÿç»„ä»¶serviceçš„bindserviceè¿›è¡Œè·¨è¿›ç¨‹é€šè®¯ä¹Ÿå¯ä»¥è·å–bpbinderè¿™ä¸ªæ˜¯å•¥åŸç†"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"ä»AndroidÂ 12å¼€å§‹ï¼ŒAndroidçš„ç»˜åˆ¶ç³»ç»Ÿæœ‰ç»“æ„æ€§å˜åŒ–ï¼ŒÂ åœ¨ç»˜åˆ¶çš„ç”Ÿäº§æ¶ˆè´¹è€…æ¨¡å¼ä¸­ï¼Œæ–°å¢BLASTBufferQueueï¼Œå®¢æˆ·ç«¯è¿›ç¨‹è‡ªè¡Œè¿›è¡Œqueueçš„ç”Ÿäº§å’Œæ¶ˆè´¹ï¼Œéšåé€šè¿‡Transationæäº¤åˆ°SurfaceFlingerï¼Œå¦‚æ­¤å¯ä»¥ä½¿å¾—å„è¿›ç¨‹å°†ç¼“å­˜æäº¤åˆ°SufrfaceFlingerååˆå¹¶åˆ°åŒä¸€äº‹åŠ¡ååŒæ­¥æäº¤ï¼Œåœ¨åŒä¸€å¸§ç”Ÿæ•ˆã€‚å®é™…ä¸Šï¼Œä»Android12åˆ°Android14æ•´ä¸ªç»˜åˆ¶ç³»ç»Ÿåœ¨å„ä¸ªç¯èŠ‚ä¹Ÿéƒ½æœ‰äº†æˆ–å¤§æˆ–å°çš„è°ƒæ•´ï¼Œæ¯”å¦‚Android13å‘å¸ƒäº†1.3ç‰ˆæœ¬çš„Vulkan,Â Android14æ–°å¢äº†TextureViewï¼Œç­‰ç­‰ã€‚æœ¬æ–‡åŸºäºAndroid14ã€‚1 ","date":"2024-11-06","objectID":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-%E6%A6%82%E8%A7%88_blastbufferqueue-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Android 14 - ç»˜åˆ¶ä½“ç³» - æ¦‚è§ˆ_blastbufferqueue-CSDNåšå®¢","uri":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-%E6%A6%82%E8%A7%88_blastbufferqueue-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"AndroidÂ ç»˜åˆ¶ç³»ç»Ÿæ•´ä½“æ¶æ„ï¼š ä»ä¸Šåˆ°ä¸‹å¯ä»¥ç†è§£ä¸ºâ€œç”Ÿäº§è€…ï¼ˆProducerï¼‰â€åˆ°â€œæ¶ˆè´¹è€…ï¼ˆConsumerï¼‰â€çš„å¤„ç†è¿‡ç¨‹ã€‚ é¦–å…ˆï¼Œä»WindowManagerServiceçš„è§’åº¦ï¼Œæ¯ä¸ªçª—å£ç§°ä¸ºWindowï¼Œä¸€ä¸ªWindowä¸€èˆ¬æ˜¯ä¸€ä¸ªAPPçš„é¡µé¢ï¼Œæˆ–è€…Status Barï¼Œæˆ–è€…Navigation Barï¼Œæˆ–è€…WallPaperï¼Œè¿™äº›éƒ½æ˜¯ä¸€ä¸ªä¸ªWindowã€‚WindowManagerServiceï¼ˆWMSï¼‰ä½œä¸ºæœåŠ¡ç«¯ï¼Œå¯¹æ‰€æœ‰å®¢æˆ·ç«¯çª—å£çš„æ·»åŠ ã€å±‚çº§ã€å¸ƒå±€ç­‰è¿›è¡Œç»Ÿä¸€ç®¡ç†ã€‚åœ¨WMSç«¯ï¼Œæ¯ä¸ªWindowå¯¹åº”ä¸€ä¸ªSurfaceã€‚Surfaceå¯ä»¥ç†è§£ä¸ºå›¾åƒæ•°æ®ç¼“å­˜çš„æŒæœ‰è€…ï¼Œä»¥åŠCanvasçš„æŒæœ‰è€…ã€‚Canvasæ˜¯ç”»å¸ƒï¼Œæä¾›äº†ç»˜åˆ¶å„ç§å›¾å½¢çš„èƒ½åŠ›ä¾›å¼€å‘è€…ä½¿ç”¨ã€‚ä¸€ä¸ªå®¢æˆ·ç«¯çª—å£åœ¨å»ºç«‹ä¹‹åˆï¼Œä¼šå…ˆå‘WMSå»ç”³è¯·ä¸€ä¸ªSurfaceï¼ŒWMSåœ¨åˆ›å»ºäº†Surfaceä¹‹åï¼Œé€šè¿‡binderè¿”å›ç»™å®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯æ‹¿åˆ°Surfaceåï¼Œä¼šå»åˆ›å»ºä¸€ä¸ªBLASTBufferQueueæ¥ç®¡ç†å›¾åƒå†…å­˜çš„ç”³è¯·ã€‚æ¯æ¬¡è¦ä½¿ç”¨Surfaceçš„Canvasè¿›è¡Œç»˜åˆ¶å‰ï¼Œéœ€è¦å…ˆå‘BLASTBufferQueueç”³è¯·ä¸€å—å†…å­˜ï¼ˆdequeueï¼‰ï¼Œæˆ‘ä»¬è¿™é‡Œç§°ä¸ºBufferï¼Œç„¶åå†å°†ç”Ÿæˆçš„å›¾åƒæ•°æ®å†™å…¥Bufferã€‚è¿™ä¸ªå‘BLASTBufferQueueç”³è¯·Bufferå¹¶å†™å…¥å›¾åƒæ•°æ®çš„è¿‡ç¨‹ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯â€œç”Ÿäº§â€é˜¶æ®µã€‚éšåï¼Œenqueueè¿™ä¸ªbufferï¼Œå°†å…¶æäº¤ç»™SurfaceFlingerå»åˆæˆã€‚è¿™ä¸ªé˜¶æ®µï¼Œå¯ä»¥ç†è§£ä¸ºå›¾åƒBufferçš„â€œæ¶ˆè´¹â€é˜¶æ®µã€‚ SurfaceFlingerï¼ˆSFï¼‰æ˜¯è´Ÿè´£ä¸Hardwareå±‚æ²Ÿé€šï¼Œç»´æŠ¤ç€è®¾å¤‡æŒ‚è½½ã€VSyncä¿¡å·æ”¶å‘ã€Layeråˆæˆç­‰å·¥ä½œã€‚WMSçš„æ¯ä¸ªSurfaceåœ¨SurfaceFlingerä¸­éƒ½å¯¹åº”ç”Ÿæˆä¸€ä¸ªLayerå¯¹è±¡ã€‚å®¢æˆ·ç«¯å°†æŸä¸ªSurfaceä¸Šçš„Bufferæäº¤ç»™SurfaceFlingerï¼Œå®é™…ä¸Šå°±æ˜¯æ›´æ–°äº†å¯¹åº”Layerçš„Bufferæ•°æ®ã€‚SurfaceFlingerè°ƒç”¨HWComposerå°†è¿™äº›Layerè¿›è¡Œåˆæˆå¹¶æ˜¾ç¤ºåœ¨å±å¹•ã€‚ Androidåœ¨HALå±‚æä¾›ç§°ä¸ºä¸€ä¸ªHardware Composerçš„ç»„ä»¶ï¼Œç”¨äºéš”ç¦»ä¸å…·ä½“ç¡¬ä»¶çš„äº¤äº’ã€‚Hardware Composerç®€ç§°HWComposeræˆ–HWC2ï¼ˆä¹‹æ‰€ä»¥æ˜¯2ï¼Œæ˜¯æ—©æœŸå·²æœ‰ä¸€ä¸ªHWCç‰ˆæœ¬ï¼Œåªæ”¯æŒè½¯ä»¶åˆæˆï¼‰ã€‚SurfaceFlingeræŠŠLayeræ•°æ®äº¤ç»™HWComposerï¼Œå„å‚å•†æ¥è´Ÿè´£HWComposeråˆæˆæ¥å£çš„å…·ä½“å®ç°ã€‚åœ¨åˆæˆå®Œæ¯•åï¼Œå°†æ•°æ®æäº¤åˆ°å±å¹•è®¾å¤‡çš„ç¼“å­˜ï¼ˆä¸€èˆ¬ç§°ä¸ºFrameÂ Bufferï¼‰ï¼Œå±å¹•å°±æ˜¾ç¤ºå‡ºç”»é¢æ¥äº†ã€‚ ä¸Šé¢çš„è¿‡ç¨‹ï¼Œå¯ä»¥æ‹†è§£ä¸ºå‡ éƒ¨åˆ†ï¼š Surfaceçš„åˆ›å»ºä¸ç®¡ç†ã€‚ å®¢æˆ·ç«¯ï¼ˆEndPointï¼‰ç»˜åˆ¶ï¼ˆDrawï¼‰å’Œæ¸²æŸ“ï¼ˆRenderï¼‰å›¾åƒã€‚ ç¬¬ä¸‰éƒ¨åˆ†ï¼Œæ˜¯ç¡¬ä»¶Compositionï¼ˆåˆæˆï¼‰å·¥ä½œ Vsyncï¼šç”±ç¡¬ä»¶äº§ç”Ÿçš„ä¿¡å·ï¼Œç”¨äºåŒæ­¥framebufferçš„ç”Ÿäº§å’Œæ¶ˆè´¹ã€‚SurfaceFlingerå¯¹Vsyncè¿›è¡Œäº†ä½¿ç”¨å’Œç®¡ç†ï¼Œå¹¶å‘ä¸Šåˆ†å‘ç»™APPã€‚Vsyncæ˜¯ä¸æ–­ç»˜åˆ¶çš„é©±åŠ¨åŠ›ï¼Œä¹Ÿæ˜¯å›¾åƒç¼“å­˜æœ‰åºæŠ•é€åˆ°å±å¹•çš„é‡è¦æœºåˆ¶ã€‚ ç°åœ¨ï¼Œåˆ†åˆ«è®¨è®ºä¸‹å››éƒ¨åˆ†ï¼š Surfaceçš„åˆ›å»ºä¸ç®¡ç† åœ¨Surfaceçš„åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œæœ‰å‡ ä¸ªè§’è‰²è´¯ç©¿å…¶ä¸­ï¼š PhoneWindowï¼šä¸€ä¸ªActivityå¯¹åº”ä¸€ä¸ªPhoneWindowï¼Œä»£è¡¨ä¸€ä¸ªåº”ç”¨çª—å£ã€‚åœ¨AMSåˆ›å»ºActivityä¹‹åˆï¼ŒPhoneWindowåœ¨æœåŠ¡ç«¯çš„å¯¹åº”çš„windowå¯¹è±¡ï¼ˆActivityRecordï¼‰å·²ç»æ·»åŠ åˆ°WMSã€‚ ViewRootImplï¼šå…¶ä¸»è¦ä½œç”¨æ˜¯ä¸æœåŠ¡ç«¯é€šä¿¡ï¼Œæ‰¿æ¥å¤–éƒ¨è§¦å‘çš„ç»˜åˆ¶è°ƒç”¨ï¼Œä»è€Œä»ä¸Šå¾€ä¸‹å¯¹æ•´ä¸ªViewæ ‘è¿›è¡Œç»˜åˆ¶ã€‚å¯ä»¥æŠŠViewRootImpç†è§£ä¸ºViewçš„è°ƒåº¦è€…ã€‚ViewRootImpåœ¨é€»è¾‘ä¸Šæ˜¯View Hierarchyçš„æœ€é¡¶å±‚ï¼Œä½†å…¶å¹¶ä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„Viewã€‚ä»–æŒæœ‰ä¸€ä¸ªå­—Viewâ€“DecorViewï¼ŒDecorViewæ‰æ˜¯çœŸæ­£çš„Viewï¼Œæ˜¯Viewæ ‘çš„æœ€ä¸Šå±‚ï¼ŒåŒ…å«ç€Activityçš„ç”»é¢å†…å®¹ã€‚åœ¨Activityçš„resumeé˜¶æ®µï¼ŒViewRootImplçš„relayoutæ–¹æ³•ä¼šå°†DecorViewæ·»åŠ åˆ°WMSä¸­ï¼Œè¿™æ ·Activityçš„å†…å®¹å°±æ˜¾ç¤ºäº†å‡ºæ¥ã€‚é€»è¾‘ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥æŠŠDecorViewä¹Ÿç†è§£ä¸ºä¸€ä¸ªWindowã€‚Activityå¯¹åº”ä¸€ä¸ªPhoneWindowï¼Œå†é€šè¿‡ViewRootImplå°†DecorViewåœ¨WMSç«¯æ·»åŠ ä¸ºPhoneWindowçš„å­Windowã€‚ WMSçš„Sessionï¼šå®¢æˆ·ç«¯ä¸€ä¸ªè¿›ç¨‹å¯¹åº”WMSé‡Œçš„ä¸€ä¸ªSessionï¼Œå®¢æˆ·ç«¯æŒæœ‰Sessionçš„binderå®¢æˆ·ç«¯ï¼Œåœ¨çª—å£æ·»åŠ ç­‰äº‹åŠ¡ä¸Šï¼Œå®¢æˆ·ç«¯éƒ½æ˜¯é€šè¿‡è¿™ä¸ªSessionæ¥ä¸WMSé€šä¿¡çš„ã€‚ WindowContainerï¼šWMSç«¯ç®¡ç†ç³»ç»Ÿæ•´ä½“çš„Windowä½“ç³»ï¼ŒåŒ…æ‹¬å…¶ä½ç½®ã€å±‚çº§å…³ç³»ã€‚å®ƒæ˜¯é€šè¿‡WindowContainerè¿™ä¸ªç±»æ¥è¡¨è¾¾ä¸€ä¸ªWindowçš„ã€‚DisplayContentä»£è¡¨ä¸€ä¸ªå±å¹•çº§åˆ«çš„Windowï¼ŒDisplayAreaä»£è¡¨ä¸€å—å±å¹•ä¸Šçš„ä¸€å—åŒºåŸŸï¼Œæ¯”å¦‚å¹³æ¿ç­‰å¤§å±å¹•è®¾å¤‡ä¸Šï¼Œå¯èƒ½ä¸€å—å±å¹•ä¸ŠåŒæ—¶æ˜¾ç¤ºå¤šä¸ªåº”ç”¨åŒºåŸŸï¼Œæ­¤æ—¶å°±ç”¨DisplayAreaè¡¨è¾¾ã€‚WindowTokenç®€å•ç†è§£ä¸ºå¯¹åº”ä¸€ä¸ªå®¢æˆ·ç«¯Windowï¼Œæ¯”å¦‚ä¸€ä¸ªåº”ç”¨çš„Activityï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒActivityçš„WindowTokenæ˜¯ä½œä¸ºActivityRecordå­˜åœ¨çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ActivityRecordæ˜¯WindowTokençš„å­ç±»ã€‚è€ŒActivityçš„å…·ä½“å†…å®¹çš„æ‰¿è½½è€…ï¼ŒDecorViewï¼Œå¯¹åº”WindowStateã€‚ä¸Šé¢æ‰€æœ‰çš„DisplayContentã€DisplayAreaã€WindowTokenã€WindowStateç­‰ï¼Œéƒ½æ˜¯WindowContainerçš„å­ç±»ï¼Œè¿™äº›Windowåœ¨WMSå†…æ˜¯ä»¥windowæ ‘çš„å½¢å¼ç»„ç»‡èµ·æ¥çš„ã€‚äº‹å®ä¸Šï¼Œåœ¨DisplayContentä¸‹é¢ï¼Œè¿˜æœ‰ä¸€ä¸ªå±‚çº§ï¼Œç§°ä¸ºFeatureï¼Œå…·ä½“çš„å±‚çº§ç»“æ„è§Android12 - WMSä¹‹WindowContaineræ ‘ï¼ˆDisplayAreaï¼‰_android windowcontainer-CSDNåšå®¢ã€‚å½“å®¢æˆ·ç«¯é€šè¿‡Sessionæ¥å£è°ƒç”¨æ·»åŠ DecorViewæ—¶ï¼ŒWMSç«¯ä¼šç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„WindowStateå¯¹è±¡ï¼Œå¹¶å°†å…¶ä½œä¸ºActivityå¯¹åº”çš„ActivityRecordï¼ˆä¹Ÿå°±æ˜¯WindowTokenï¼‰çš„å­windowã€‚ SurfaceControlï¼šåœ¨WMSç«¯ï¼Œæ¯ä¸ªWindowContainerå¯¹åº”ä¸€ä¸ªSurfaceControlã€‚SurfaceControlæ˜¯WMSç«¯ç®¡ç†Surfaceçš„å…·ä½“å¯¹è±¡ï¼Œåœ¨WMSç«¯ï¼Œå¯ä»¥ç†è§£ä¸€ä¸ªSurfaceControlå°±ä»£è¡¨ä¸€ä¸ªSurfaceã€‚SurfaceControlåœ¨SurfaceFlingeç«¯å¯¹åº”ä¸€ä¸ªLayerï¼ŒæŒæœ‰ä¸€ä¸ªlayerçš„å¥æŸ„handleã€‚æ‰€æœ‰çš„ç»˜åˆ¶åŠ¨ä½œï¼Œæœ€åéƒ½ä¼šæäº¤åˆ°SurfaceFingerä½œä¸ºLayerå»åˆæˆã€‚SurfaceControlçš„ä½œç”¨ï¼Œæˆ–è€…Surfaceçš„ä½œç”¨ï¼Œä¸»è¦æ˜¯å°†å®¢æˆ·ç«¯çš„çª—å£ä¸SurfaceFlingerçš„Layerå…³è”èµ·æ¥ã€‚åœ¨å®¢æˆ·ç«¯Addä¸€ä¸ªDecorViewæ—¶ï¼Œ åœ¨WMSç«¯å¯¹åº”åˆ›å»ºçš„WindowStateä¼šåŒæ—¶åˆ›å»ºä¸€ä¸ªSurfaceControlã€Layerï¼Œéšåå°†SurfaceControlè¿”å›ç»™å®¢æˆ·ç«¯ã€‚å®¢æˆ·ç«¯æ‹¿åˆ°SurfaceControlä¹‹åè½¬æ¢æˆSurfaceã€‚åç»­çš„ç»˜åˆ¶å°±åœ¨è¿™ä¸ªSurfaceä¸Šè¿›è¡Œã€‚ SurfaceComposerClientï¼šæ˜¯ä¸€ä¸ªBinderï¼Œä¸»è¦ä½œç”¨æ˜¯SurfaceControlè°ƒç”¨SurfaceFlingerè¿‡ç¨‹ä¸­ï¼Œä½œä¸ºä¸€ä¸ªé€šé“çš„è§’è‰²ã€‚ç”±äºSurfaceControlåœ¨WMSã€å®¢æˆ·ç«¯éƒ½æŒæœ‰ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯ã€WMSéƒ½å¯ä»¥é€šè¿‡è¿™ä¸ªé€šé“è°ƒç”¨SFã€‚æ¯”å¦‚Layerçš„åˆ›å»ºã€GraphihcÂ Bufferçš„æäº¤ç­‰ã€‚ ","date":"2024-11-06","objectID":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-%E6%A6%82%E8%A7%88_blastbufferqueue-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"Android 14 - ç»˜åˆ¶ä½“ç³» - æ¦‚è§ˆ_blastbufferqueue-CSDNåšå®¢","uri":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-%E6%A6%82%E8%A7%88_blastbufferqueue-csdn%E5%8D%9A%E5%AE%A2/#androidç»˜åˆ¶ç³»ç»Ÿæ•´ä½“æ¶æ„"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"1. å®¢æˆ·ç«¯ç»˜åˆ¶å’Œæ¸²æŸ“ å®¢æˆ·ç«¯é€šè¿‡Surfaceä¸­æä¾›çš„Canvasè¿›è¡Œç»˜åˆ¶ï¼ŒCanvasæ˜¯åŸºäºSkiaçš„SKCanvasã€‚Skiaï¼ˆhttps://skia.org/ï¼‰æ˜¯ç”±Googleç®¡ç†çš„å¼€æº2Dï¼ˆä¹Ÿå¯ä»¥æ”¯æŒ3Dï¼‰å›¾åƒåº“ï¼Œç›®å‰Androidã€Google Chromeã€ChromeOSã€MozillaÂ FireFoxã€FireFoxOSä¸Šéƒ½ä½¿ç”¨Skiaä½œä¸ºç»˜åˆ¶å¼•æ“ã€‚Skiaå¯ä»¥é›†æˆOPENÂ GLå’ŒVulkanè¿›è¡Œ3Dç»˜åˆ¶ã€‚Android Qä»¥åï¼ŒSkiaä½œç”¨è¢«åŠ å¼ºï¼Œå³ä½¿ç¡¬ä»¶åŠ é€Ÿåœºæ™¯ä¸­ï¼Œç»˜åˆ¶ä¹Ÿä¼šå…ˆå°è£…æˆSkiaçš„GrOpListå†æäº¤ç»™GPUã€‚åœ¨Android 14ä¸­ï¼Œ SkiaåŒ…çš„ç›®å½•ä¸ºexternal/skiaã€‚ æ¸²æŸ“çš„è¿‡ç¨‹æ˜¯å°†ç”»å¥½çš„å›¾åƒï¼Œè¿›è¡Œæ …æ ¼åŒ–ï¼ˆRasterizerï¼‰ï¼Œå˜æˆä¸€ä¸ªä¸ªåƒç´ ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸è€—æ—¶çš„è¿‡ç¨‹ã€‚Android 3ä»¥å‰ï¼Œåªæ”¯æŒè½¯ä»¶æ¸²æŸ“ï¼Œå³Software Renderã€‚è¿‡ç¨‹å¦‚ä¸‹ï¼š APPåœ¨Viewçš„onDrawé˜¶æ®µä½¿ç”¨Canvasç»˜åˆ¶åï¼Œé€šè¿‡Skiaè¿›è¡Œè½¯ä»¶çš„æ …æ ¼åŒ–ï¼Œå³é€šè¿‡CPUè®¡ç®—ï¼Œå°†ç»˜åˆ¶å†…å®¹è½¬åŒ–æˆä¸€ä¸ªä¸ªåƒç´ ä¿¡æ¯ï¼ŒéšåæŠ•é€ç»™å±å¹•è¿›è¡Œæ˜¾ç¤ºã€‚ç”±äºè½¯ä»¶æ¸²æŸ“æ•ˆç‡ä½ï¼Œå½“ä¸‹è½¯ä»¶æ¸²æŸ“åªæ˜¯ä½œä¸ºå…¼å®¹æ–¹æ¡ˆå¾—ä»¥ä¿ç•™ï¼Œé»˜è®¤ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿã€‚ ç¡¬ä»¶åŠ é€Ÿçš„æµç¨‹ç®€å•è¡¨è¿°å¦‚ä¸‹ï¼š Androidå°†ç¡¬ä»¶åŠ é€Ÿç›¸å…³èƒ½åŠ›å°è£…åœ¨hwuiç»„ä»¶ä¸­ï¼Œhwuiåœ°å€ï¼šplatform/frameworks/base/libs/hwui åœ¨ç¡¬ä»¶åŠ é€Ÿæ¨¡å¼ä¸‹ï¼ŒAPPåœ¨onDrawä¸­é€šè¿‡Canvasç»˜åˆ¶çš„å†…å®¹å°†æœ€ç»ˆè¢«å°è£…æˆDisplayListçš„ä¸€ä¸ªä¸ªGrOpç»˜åˆ¶å‘½ä»¤ï¼Œç„¶åé€šè¿‡OpenGLæˆ–è€…Vulkanäº¤ç”±GPUè¿›è¡Œæ¸²æŸ“ï¼Œéšåå°†ç»“æœæŠ•é€ç»™å±å¹•æ˜¾ç¤ºã€‚è€Œå…·ä½“æ˜¯ä½¿ç”¨OpenGLè¿˜æ˜¯Vulkanæ˜¯å¯é€‰æ‹©çš„ã€‚æ—©æœŸAndroidåªä½¿ç”¨OpenGLï¼Œç”±äºVulkanæ”¯æŒå¤šçº¿ç¨‹æ¸²æŸ“ç­‰æ€§èƒ½æ–¹é¢çš„ä¼˜åŠ¿ï¼ŒAndroidé€æ¸å€¾å‘ä½¿ç”¨Vulkanè¿›è¡Œæ¸²æŸ“ã€‚å¦å¤–ï¼Œåœ¨å“ªäº›ç»´åº¦ä¸Šè¿›è¡Œç¡¬ä»¶åŠ é€Ÿä¹Ÿæ˜¯å¯é€‰çš„ï¼š å³åœ¨æ•´ä½“ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿçš„æƒ…å†µä¸‹ï¼Œå¦‚æœæŸä¸ªViewçš„ç»˜åˆ¶æš‚æ—¶ä¸æ”¯æŒç¡¬ä»¶åŠ é€Ÿï¼Œæˆ–è€…åœ¨æŸäº›ä½ç§»åŠ¨ç”»ä¸Šä¸ºäº†å‡å°‘æ¸²æŸ“æˆæœ¬ï¼Œå¯ä»¥åŠ¨è¿‡è®¾ç½®Viewçš„layerTypeÂ =Â LAYER_TYPE_SOFTWAREæ¥å•çº¯åœ¨æŸä¸ªç‰¹å®šViewä¸Šä½¿ç”¨SoftwareÂ Renderã€‚ ç¡¬ä»¶åŠ é€Ÿé™¤äº†åˆ©ç”¨GPUæ¥åŠ é€Ÿæ¸²æŸ“æ•ˆç‡å¤–ï¼Œ æœ¬èº«åœ¨è®¡ç®—æ¸²æŸ“èŒƒå›´æ—¶ç›¸è¾ƒè½¯ä»¶æ¸²æŸ“ä¹Ÿæ›´åŠ é«˜æ•ˆï¼Œå³è½¯ä»¶æ¸²æŸ“æ¯æ¬¡æ›´æ–°ä¸€ä¸ªViewå±€éƒ¨ï¼Œå°†ä½¿å¾—æ•´ä¸ªView hierarchyéƒ½é‡æ–°æ¸²æŸ“ã€‚è€Œç¡¬ä»¶åŠ é€Ÿå¦‚åªæ ‡æ³¨æœ‰å˜åŒ–çš„éƒ¨åˆ†ï¼Œæ‰€è°“damageÂ areaï¼Œå°†ç»˜åˆ¶æŒ‡ä»¤ä¿å­˜åœ¨DisplayListä¸­ï¼Œå¦‚æ­¤å¤§å¤§æé«˜æ¸²æŸ“é€Ÿåº¦ã€‚ OpenGLÂ E****S VSÂ Vulkan ä»¥ä¸‹ä¸ºOpenGL ESå’ŒVulkanåœ¨Androidä¸Šå‘å¸ƒçš„ç‰ˆæœ¬å†å²ã€‚ Vulkanä½œä¸ºä¸€ä¸ªé¢å‘æ›´ä½çº§åˆ«è§„èŒƒã€è·¨å¹³å°çš„APIï¼Œå¯ä»¥æä¾›æ›´ç»†ç²’åº¦çš„å†…å­˜ç®¡ç†å’Œèµ„æºç®¡ç† ä»¥ä¸‹ä¸ºVulkanä¸OpenGL ESçš„ä½¿ç”¨ç‡ï¼ˆfromÂ GDCÂ 2023Â https://www.youtube.com/watch?v=C7OjI7CpjLw\u0026t=1188sï¼‰ï¼š å¯¹äºæœªæ¥è®¡åˆ’ï¼ŒOpenGL ESå°†ä¸ä¼šå†æœ‰åŠŸèƒ½æ›´æ–°ï¼Œæ–°çš„åŠŸèƒ½å°†åªä¼šåœ¨Vulkanä¸Šæ”¯æŒã€‚å› æ­¤ï¼ŒVulkanæ˜¯æœªæ¥Androidä¸»æ¨çš„æ¸²æŸ“å¼•æ“ã€‚ æ— è®ºæ˜¯OpenGLè¿˜æ˜¯Vulkanï¼Œéƒ½éœ€è¦GPUçš„æ”¯æŒã€‚ä¾‹å¦‚å¸¸è§çš„è½¦è½½é«˜ç«¯èŠ¯ç‰‡é«˜é€š8155ï¼Œæ˜ç¡®æ ‡æ˜äº†æ”¯æŒ:Â OpenGLÂ ESÂ 3.xã€Vulkanhttps://www.qualcomm.com/content/dam/qcomm-martech/dm-assets/documents/qul7413_sa8155_productbrief_r4.pdf ","date":"2024-11-06","objectID":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-%E6%A6%82%E8%A7%88_blastbufferqueue-csdn%E5%8D%9A%E5%AE%A2/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"Android 14 - ç»˜åˆ¶ä½“ç³» - æ¦‚è§ˆ_blastbufferqueue-CSDNåšå®¢","uri":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-%E6%A6%82%E8%A7%88_blastbufferqueue-csdn%E5%8D%9A%E5%AE%A2/#1-å®¢æˆ·ç«¯ç»˜åˆ¶å’Œæ¸²æŸ“"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"1. å®¢æˆ·ç«¯ç»˜åˆ¶å’Œæ¸²æŸ“ å®¢æˆ·ç«¯é€šè¿‡Surfaceä¸­æä¾›çš„Canvasè¿›è¡Œç»˜åˆ¶ï¼ŒCanvasæ˜¯åŸºäºSkiaçš„SKCanvasã€‚Skiaï¼ˆhttps://skia.org/ï¼‰æ˜¯ç”±Googleç®¡ç†çš„å¼€æº2Dï¼ˆä¹Ÿå¯ä»¥æ”¯æŒ3Dï¼‰å›¾åƒåº“ï¼Œç›®å‰Androidã€Google Chromeã€ChromeOSã€MozillaÂ FireFoxã€FireFoxOSä¸Šéƒ½ä½¿ç”¨Skiaä½œä¸ºç»˜åˆ¶å¼•æ“ã€‚Skiaå¯ä»¥é›†æˆOPENÂ GLå’ŒVulkanè¿›è¡Œ3Dç»˜åˆ¶ã€‚Android Qä»¥åï¼ŒSkiaä½œç”¨è¢«åŠ å¼ºï¼Œå³ä½¿ç¡¬ä»¶åŠ é€Ÿåœºæ™¯ä¸­ï¼Œç»˜åˆ¶ä¹Ÿä¼šå…ˆå°è£…æˆSkiaçš„GrOpListå†æäº¤ç»™GPUã€‚åœ¨Android 14ä¸­ï¼Œ SkiaåŒ…çš„ç›®å½•ä¸ºexternal/skiaã€‚ æ¸²æŸ“çš„è¿‡ç¨‹æ˜¯å°†ç”»å¥½çš„å›¾åƒï¼Œè¿›è¡Œæ …æ ¼åŒ–ï¼ˆRasterizerï¼‰ï¼Œå˜æˆä¸€ä¸ªä¸ªåƒç´ ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸è€—æ—¶çš„è¿‡ç¨‹ã€‚Android 3ä»¥å‰ï¼Œåªæ”¯æŒè½¯ä»¶æ¸²æŸ“ï¼Œå³Software Renderã€‚è¿‡ç¨‹å¦‚ä¸‹ï¼š APPåœ¨Viewçš„onDrawé˜¶æ®µä½¿ç”¨Canvasç»˜åˆ¶åï¼Œé€šè¿‡Skiaè¿›è¡Œè½¯ä»¶çš„æ …æ ¼åŒ–ï¼Œå³é€šè¿‡CPUè®¡ç®—ï¼Œå°†ç»˜åˆ¶å†…å®¹è½¬åŒ–æˆä¸€ä¸ªä¸ªåƒç´ ä¿¡æ¯ï¼ŒéšåæŠ•é€ç»™å±å¹•è¿›è¡Œæ˜¾ç¤ºã€‚ç”±äºè½¯ä»¶æ¸²æŸ“æ•ˆç‡ä½ï¼Œå½“ä¸‹è½¯ä»¶æ¸²æŸ“åªæ˜¯ä½œä¸ºå…¼å®¹æ–¹æ¡ˆå¾—ä»¥ä¿ç•™ï¼Œé»˜è®¤ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿã€‚ ç¡¬ä»¶åŠ é€Ÿçš„æµç¨‹ç®€å•è¡¨è¿°å¦‚ä¸‹ï¼š Androidå°†ç¡¬ä»¶åŠ é€Ÿç›¸å…³èƒ½åŠ›å°è£…åœ¨hwuiç»„ä»¶ä¸­ï¼Œhwuiåœ°å€ï¼šplatform/frameworks/base/libs/hwui åœ¨ç¡¬ä»¶åŠ é€Ÿæ¨¡å¼ä¸‹ï¼ŒAPPåœ¨onDrawä¸­é€šè¿‡Canvasç»˜åˆ¶çš„å†…å®¹å°†æœ€ç»ˆè¢«å°è£…æˆDisplayListçš„ä¸€ä¸ªä¸ªGrOpç»˜åˆ¶å‘½ä»¤ï¼Œç„¶åé€šè¿‡OpenGLæˆ–è€…Vulkanäº¤ç”±GPUè¿›è¡Œæ¸²æŸ“ï¼Œéšåå°†ç»“æœæŠ•é€ç»™å±å¹•æ˜¾ç¤ºã€‚è€Œå…·ä½“æ˜¯ä½¿ç”¨OpenGLè¿˜æ˜¯Vulkanæ˜¯å¯é€‰æ‹©çš„ã€‚æ—©æœŸAndroidåªä½¿ç”¨OpenGLï¼Œç”±äºVulkanæ”¯æŒå¤šçº¿ç¨‹æ¸²æŸ“ç­‰æ€§èƒ½æ–¹é¢çš„ä¼˜åŠ¿ï¼ŒAndroidé€æ¸å€¾å‘ä½¿ç”¨Vulkanè¿›è¡Œæ¸²æŸ“ã€‚å¦å¤–ï¼Œåœ¨å“ªäº›ç»´åº¦ä¸Šè¿›è¡Œç¡¬ä»¶åŠ é€Ÿä¹Ÿæ˜¯å¯é€‰çš„ï¼š å³åœ¨æ•´ä½“ä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿçš„æƒ…å†µä¸‹ï¼Œå¦‚æœæŸä¸ªViewçš„ç»˜åˆ¶æš‚æ—¶ä¸æ”¯æŒç¡¬ä»¶åŠ é€Ÿï¼Œæˆ–è€…åœ¨æŸäº›ä½ç§»åŠ¨ç”»ä¸Šä¸ºäº†å‡å°‘æ¸²æŸ“æˆæœ¬ï¼Œå¯ä»¥åŠ¨è¿‡è®¾ç½®Viewçš„layerTypeÂ =Â LAYER_TYPE_SOFTWAREæ¥å•çº¯åœ¨æŸä¸ªç‰¹å®šViewä¸Šä½¿ç”¨SoftwareÂ Renderã€‚ ç¡¬ä»¶åŠ é€Ÿé™¤äº†åˆ©ç”¨GPUæ¥åŠ é€Ÿæ¸²æŸ“æ•ˆç‡å¤–ï¼Œ æœ¬èº«åœ¨è®¡ç®—æ¸²æŸ“èŒƒå›´æ—¶ç›¸è¾ƒè½¯ä»¶æ¸²æŸ“ä¹Ÿæ›´åŠ é«˜æ•ˆï¼Œå³è½¯ä»¶æ¸²æŸ“æ¯æ¬¡æ›´æ–°ä¸€ä¸ªViewå±€éƒ¨ï¼Œå°†ä½¿å¾—æ•´ä¸ªView hierarchyéƒ½é‡æ–°æ¸²æŸ“ã€‚è€Œç¡¬ä»¶åŠ é€Ÿå¦‚åªæ ‡æ³¨æœ‰å˜åŒ–çš„éƒ¨åˆ†ï¼Œæ‰€è°“damageÂ areaï¼Œå°†ç»˜åˆ¶æŒ‡ä»¤ä¿å­˜åœ¨DisplayListä¸­ï¼Œå¦‚æ­¤å¤§å¤§æé«˜æ¸²æŸ“é€Ÿåº¦ã€‚ OpenGLÂ E****S VSÂ Vulkan ä»¥ä¸‹ä¸ºOpenGL ESå’ŒVulkanåœ¨Androidä¸Šå‘å¸ƒçš„ç‰ˆæœ¬å†å²ã€‚ Vulkanä½œä¸ºä¸€ä¸ªé¢å‘æ›´ä½çº§åˆ«è§„èŒƒã€è·¨å¹³å°çš„APIï¼Œå¯ä»¥æä¾›æ›´ç»†ç²’åº¦çš„å†…å­˜ç®¡ç†å’Œèµ„æºç®¡ç† ä»¥ä¸‹ä¸ºVulkanä¸OpenGL ESçš„ä½¿ç”¨ç‡ï¼ˆfromÂ GDCÂ 2023Â https://www.youtube.com/watch?v=C7OjI7CpjLw\u0026t=1188sï¼‰ï¼š å¯¹äºæœªæ¥è®¡åˆ’ï¼ŒOpenGL ESå°†ä¸ä¼šå†æœ‰åŠŸèƒ½æ›´æ–°ï¼Œæ–°çš„åŠŸèƒ½å°†åªä¼šåœ¨Vulkanä¸Šæ”¯æŒã€‚å› æ­¤ï¼ŒVulkanæ˜¯æœªæ¥Androidä¸»æ¨çš„æ¸²æŸ“å¼•æ“ã€‚ æ— è®ºæ˜¯OpenGLè¿˜æ˜¯Vulkanï¼Œéƒ½éœ€è¦GPUçš„æ”¯æŒã€‚ä¾‹å¦‚å¸¸è§çš„è½¦è½½é«˜ç«¯èŠ¯ç‰‡é«˜é€š8155ï¼Œæ˜ç¡®æ ‡æ˜äº†æ”¯æŒ:Â OpenGLÂ ESÂ 3.xã€Vulkanhttps://www.qualcomm.com/content/dam/qcomm-martech/dm-assets/documents/qul7413_sa8155_productbrief_r4.pdf ","date":"2024-11-06","objectID":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-%E6%A6%82%E8%A7%88_blastbufferqueue-csdn%E5%8D%9A%E5%AE%A2/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"Android 14 - ç»˜åˆ¶ä½“ç³» - æ¦‚è§ˆ_blastbufferqueue-CSDNåšå®¢","uri":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-%E6%A6%82%E8%A7%88_blastbufferqueue-csdn%E5%8D%9A%E5%AE%A2/#opengles-vsvulkan"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"2. HW Composer**ï¼ˆHWC2ï¼‰**å›¾åƒåˆæˆ å‰é¢æåˆ°è¿‡ï¼Œæ¯ä¸ªwindowå¯¹åº”ä¸€ä¸ªSFä¸­çš„Layerï¼Œåˆæˆï¼ˆCompositionï¼‰å·¥ä½œå°±æ˜¯å°†è¿™äº›Layerè¿›ç¨‹åˆå¹¶æˆä¸€ä¸ªå®Œæ•´çš„å±å¹•å†…å®¹ï¼Œæäº¤ç»™ç¡¬ä»¶å±å¹•æ˜¾ç¤ºå‡ºæ¥ã€‚å¤§æ¦‚è¿‡ç¨‹å¦‚ä¸‹ï¼š è¿™ä¸ªé¡µé¢æœ‰ä¸‰ä¸ªLayerï¼šStatusBarã€NavigationBarå’Œä¸­é—´çš„APPå†…å®¹é¡µé¢ï¼Œå…¶ä¸­å¯èƒ½ä¼šæœ‰é‡å çš„éƒ¨åˆ†ï¼Œç§°ä¸ºOverlayã€‚Compositionçš„å·¥ä½œå°±æ˜¯å°†è¿™ä¸‰ä¸ªLayeråˆå¹¶æˆä¸€ä¸ªç”»é¢ï¼Œè®¡ç®—é‡å éƒ¨åˆ†çš„é¢œè‰²ï¼Œæäº¤ç»™å±å¹•æ˜¾ç¤ºå‡ºæ¥ã€‚ åˆæˆçš„å·¥ä½œå‘ç”Ÿåœ¨æ¸²æŸ“åçš„å†…å®¹æäº¤ç»™SurfaceFlingerä¹‹åã€‚å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š åˆæˆæœ‰ç¡¬ä»¶åˆæˆçš„éƒ¨åˆ†å’Œè½¯ä»¶åˆæˆçš„éƒ¨åˆ†ã€‚ç¡¬ä»¶åˆæˆé™¤äº†æ›´é«˜æ•ˆçš„åŒæ—¶ï¼Œå¯ä»¥å°†åˆæˆå·¥ä½œä»GPUè§£æ”¾å‡ºæ¥ï¼Œæé«˜GPUæ•ˆç‡ï¼ŒèŠ‚çœèƒ½è€—ã€‚åµŒå…¥å¼è®¾å¤‡çš„SOCä¸­ï¼Œç¡¬ä»¶çš„åˆæˆä¸€èˆ¬ç”±ç‹¬ç«‹çš„DPUï¼ˆDisplayÂ Processingï¼‰å®Œæˆã€‚ æ¯”å¦‚é«˜é€šSA8155è¿™æ¬¾SOCçš„å¸ƒå±€å¦‚ä¸‹ï¼š å…¶ä¸­GPUçš„éƒ¨åˆ†è´Ÿè´£æ¸²æŸ“ï¼Œâ€œDispayÂ Processingâ€çš„éƒ¨åˆ†ç”¨æ¥å¤„ç†åˆæˆå·¥ä½œã€‚ ç”±äºç¡¬ä»¶å¯¹åˆæˆLayeræ•°é‡æ˜¯æœ‰é™åˆ¶çš„ï¼Œä¾‹å¦‚é«˜é€šQCS2290æ”¯æŒ4ä¸ªLayerã€AMDæœ‰çš„èŠ¯ç‰‡æ”¯æŒ7ä¸ªç­‰ï¼‰ä»¥åŠLayerçš„PixelFormatï¼ˆæ¯”å¦‚æ”¯æŒPIXEL_FORMAT_RGBA_8888ï¼Œä¸æ”¯æŒYUVï¼‰æ˜¯æœ‰é™åˆ¶çš„ï¼Œå› æ­¤åœ¨ç¡¬ä»¶åˆæˆä¹‹å‰ï¼Œå¦‚æœåˆæˆLayerè¿‡å¤šæˆ–è€…Formatä¸æ»¡è¶³è¦æ±‚ï¼Œä¼šéœ€è¦ä½¿ç”¨GPUå…ˆè¿›è¡Œä¸€è½®è½¯ä»¶åˆæˆï¼Œåˆå¹¶æˆ–è½¬æ¢ä¸€äº›Layerçš„æ ¼å¼ã€‚ è½¯ä»¶åˆæˆè¿‡ç¨‹ã€‚ï¼ˆGoogleÂ I/OÂ â€˜18ï¼‰ ","date":"2024-11-06","objectID":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-%E6%A6%82%E8%A7%88_blastbufferqueue-csdn%E5%8D%9A%E5%AE%A2/:3:0","tags":["clippings","è½¬è½½","blog"],"title":"Android 14 - ç»˜åˆ¶ä½“ç³» - æ¦‚è§ˆ_blastbufferqueue-CSDNåšå®¢","uri":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-%E6%A6%82%E8%A7%88_blastbufferqueue-csdn%E5%8D%9A%E5%AE%A2/#2-hw-composerhwc2å›¾åƒåˆæˆ"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"4. V****SYNC VSyncç®€ä»‹ï¼š é¦–å…ˆå…³æ³¨ä¸¤ä¸ªé‡è¦æ¦‚å¿µï¼š refreshÂ rate - 60Hz ï¼šä»£è¡¨æ¯ç§’é’Ÿå±å¹•å¯ä»¥æ›´æ–°å¤šå°‘æ¬¡ï¼Œè¿™ä¸€å€¼æ—©æœŸæ˜¯å›ºå®šçš„ï¼Œä¾èµ–äºç¡¬ä»¶ã€‚ç°ä»£æ——èˆ°è®¾å¤‡çš„å±å¹•éƒ½æ”¯æŒå¤šä¸ªåˆ·æ–°ç‡ï¼Œä»60Hz~165Hzä¸ç­‰ï¼Œè€Œä¸”æ˜¯å¯ä»¥ç”±Appå±‚å®šåˆ¶åˆ·æ–°ç‡ã€‚ frameÂ rateï¼šæ¯ç§’é’ŸGPUå¯ä»¥ç»˜åˆ¶å¤šå°‘å¸§ï¼Œå€¼è¶Šå¤§è¶Šå¥½ VSyncæ˜¯ä¸€ä¸ªé€šç”¨æ¦‚å¿µï¼Œåœ¨Linuxã€PCã€ç§»åŠ¨è®¾å¤‡ä¸Šéƒ½æœ‰æ‰€å®ç°ã€‚ æƒ³è±¡ä¸€ä¸‹ç»˜åˆ¶è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼šGPUç»˜åˆ¶æ•°æ®ï¼Œå°†ç»˜åˆ¶ç»“æœæŠ•æ·ç»™å±å¹•æ˜¾ç¤ºå‡ºæ¥ã€‚ é—®é¢˜æ˜¯ï¼Œrefresh rateå’ŒFrame Rateå¹¶ä¸ä¿è¯æ˜¯ä¸€è‡´çš„é¢‘ç‡ï¼Œä¹Ÿå°±æ˜¯æ˜¯è¯´GPUæ¸²æŸ“çš„æ—¶é—´å¹¶ä¸èƒ½ä¿è¯å°±æ­£å¥½æ˜¯16msï¼ˆ60Hzï¼‰å†…å®Œæˆçš„ã€‚å¦‚æœåªæœ‰ä¸€å—å†…å­˜ï¼ˆFrameÂ Bufferï¼‰ç”¨æ¥äº¤æ¢æ•°æ®ï¼Œå‡å¦‚RefreshÂ Rateå¤§äºFrame Rateï¼Œç”±äºGPUæ˜¯ä»ä¸Šåˆ°ä¸‹å†™è¿™å—å†…å­˜çš„ï¼Œåœ¨å½“å±å¹•æ¥å–æ•°æ®çš„æ—¶å€™ï¼ŒGPUåˆšåˆšåœ¨æ—§å¸§åŸºç¡€ä¸Šå†™äº†ä¸€åŠçš„æ–°å¸§ï¼Œæ­¤æ—¶å°±ä¼šå‡ºç°å›¾ç‰‡æ’•è£‚é—®é¢˜ï¼Œå¦‚ï¼š è§£å†³æ–¹æ³•æ˜¯åŒç¼“å­˜æ–¹æ¡ˆï¼š æä¾›BackÂ Bufferå’ŒFrameÂ Bufferä¸¤ä¸ªç¼“å­˜ï¼Œå±å¹•å§‹ç»ˆä»FrameÂ Bufferå–æ•°æ®æ˜¾ç¤ºï¼ŒGPUå¾€Back Bufferé‡Œå†™ï¼Œå½“GPUå®Œå…¨å°†æ•°æ®å†™å¥½åï¼Œå†å°†Back Bufferæ•´ä¸ªæ‹·è´åˆ°Frame Bufferã€‚è¿™æ ·å°±èƒ½ä¿è¯å±å¹•æ¯æ¬¡éƒ½å–åˆ°å®Œæ•´çš„å¸§ã€‚ æ­¤æ—¶ä»æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœGPUçš„FrameÂ Rateå¤§äºå±å¹•çš„Refresh Rateï¼Œé‚£ä¹ˆå±å¹•å†å–åˆ°ä¸‹ä¸€å¸§å‰ï¼Œå¯èƒ½GPUéƒ½å†™å®Œå¥½å‡ å¸§äº†ï¼Œå°±ä¼šå‡ºç°ä¸¢å¸§ç°è±¡ã€‚æ­¤æ—¶å°±éœ€è¦VSyncï¼š å±å¹•æ ¹æ®è‡ªå·±çš„åˆ·æ–°é¢‘ç‡ï¼Œå»ç»™ä¸Šå±‚å‘é€ä¸€ä¸ªVSyncä¿¡å·ï¼ŒGPUåœ¨æ‹¿åˆ°è¿™ä¸ªVSyncä¿¡å·åï¼Œæ‰å»ç»˜åˆ¶ã€‚è¿™æ ·å°±èƒ½åŒæ­¥å±å¹•ä¸ä¸Šå±‚ç»˜åˆ¶çš„èŠ‚å¥äº†ã€‚ å¦‚æœå±å¹•çš„Refresh Rateå¤§äºGPUçš„Frame Rateæ€ä¹ˆåŠï¼Ÿ å±å¹•å°†ä¼šä»ç„¶æ˜¾ç¤ºæ—§å¸§ã€‚æ¯”å¦‚ä¸­é—´æ–¹æ¡†çš„ä¸¤æ¬¡åˆ·æ–°ï¼Œå±å¹•ä»ç„¶æ˜¾ç¤ºå‰ä¸€æ¬¡çš„å¸§å†…å®¹ã€‚ Androidçš„V****SYNC å®é™…ä¸ŠAndroidçš„VSyncè¦å¤æ‚å¾—å¤šï¼Œä¸»è¦ç”±SurfaceFlingerè´Ÿè´£å®ç°ã€‚é€šè¿‡ä¹‹å‰çš„ä»‹ç»æˆ‘ä»¬çŸ¥é“ä¸€å¸§çš„ç»˜åˆ¶è¿‡ç¨‹æœ‰APPç»˜åˆ¶æ¸²æŸ“ã€SurfaceFlingeråˆæˆã€Displayç¡¬ä»¶è¯»å–å¸§ç¼“å­˜æ˜¾ç¤ºå›¾ç‰‡ä¸‰ä¸ªé˜¶æ®µï¼Œå¦‚æœæ¯ä¸€ä¸ªé˜¶æ®µéƒ½ä¾èµ–VSyncä¿¡å·æ¥æ‰§è¡Œï¼Œé‚£å¯èƒ½ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼š ä¹Ÿå°±æ˜¯è¯´ï¼ŒVSync1çš„æ—¶å€™APPæ­£åœ¨ç»˜åˆ¶æ¸²æŸ“ï¼ŒSFè¿˜æ²¡æœ‰å¯ä»¥åˆæˆçš„ä¸œè¥¿ï¼Œæ‰€ä»¥ä»€ä¹ˆéƒ½ä¸åšï¼›ç­‰åˆ°VSync2çš„æ—¶å€™ï¼ŒRender1çš„å·¥ä½œå·²ç»å®Œæˆï¼Œå¯ä»¥åšåˆæˆäº†ï¼›VSync3çš„æ—¶å€™ï¼Œåˆæˆåšå®Œäº†ï¼Œæ‰å¯ä»¥æ˜¾ç¤ºåˆ°å±å¹•ä¸Šã€‚ä»ç»˜åˆ¶æ¸²æŸ“åˆ°æ˜¾ç¤ºç»å†äº†3ä¸ªVSyncã€‚é¢å¯¹è¿™ç§æƒ…å†µï¼ŒAndroidå¯¹VSyncçš„è®¾è®¡å¦‚ä¸‹ï¼š å³æœ‰ä¸‰ç§ä¿¡å· HW_VSYNC_[ID]ï¼šç”±åº•å±‚ç¡¬ä»¶æŒ‰RefreshÂ Rateçš„é¢‘ç‡å‘å‡ºï¼Œä¸€èˆ¬ä¸º60Hzã€90Hzã€120Hç­‰ç­‰ï¼Œéšåä¼šé€šè¿‡HWCé€šçŸ¥ç»™SurfaceFlingerã€‚ VSYNC-appï¼šSurfaceFlingeré€šçŸ¥ç»™ä¸Šå±‚åº”ç”¨çš„VSYNCï¼Œç”¨äºæ§åˆ¶å’Œé©±åŠ¨åº”ç”¨çš„ç»˜åˆ¶æ¸²æŸ“ã€‚ VSYNC-sf:é€šçŸ¥ç»™SurfaceFlingerè‡ªèº«çš„ï¼Œç”¨äºåˆæˆLayerçš„ä¿¡å·ã€‚ VSYNC-appå’ŒVSYNC-sfç›¸å¯¹äºHW_VSYNC_[ID]ï¼Œå¹¶ä¸æ˜¯åŒæ­¥å‘é€çš„ï¼Œè€Œæ˜¯æœ‰ä¸€å®šçš„å»¶è¿Ÿï¼Œç§°ä¸ºç›¸ä½å·®ã€‚ä»HW_VSYNC_[ID]åˆ°VSYNC-appå‘å‡ºçš„æ—¶é—´å·®ç§°ä¸ºapp phaseï¼ŒHW_VSYNC_[ID]åˆ°VSYNC-sfå‘å‡ºçš„æ—¶é—´å·®ç§°ä¸ºsf phaseã€‚è¿™ç§è®¾è®¡çš„å¥½å¤„æ˜¯ï¼Œå¦‚æœåœ¨åŒä¸€ä¸ªVSyncå‘¨æœŸå†…ï¼Œç»sfÂ phaseååœ¨æ‰§è¡Œåˆæˆæ—¶æ°å¥½å‰ä¸€æ­¥çš„Renderå®Œæˆäº†ï¼Œå°±å¯åœ¨ä¸€ä¸ªå‘¨æœŸå®Œæˆä¸¤æ­¥ï¼Œè€Œä¸ç”¨éå¾—ç­‰ä¸‹ä¸€ä¸ªVSyncã€‚ å¦å¤–ï¼ŒAndroidå¹¶éç›´æ¥æŠŠç¡¬ä»¶çš„HW_VSYNC_[ID]ä¿¡å·ç›´æ¥åˆ†å‘ç»™åº”ç”¨å’ŒSurfaceFlingerï¼Œè€Œæ˜¯é€šè¿‡å…ˆæ”¶é›†HW_VSYNC_[ID]æ ·æœ¬ï¼Œå†æ ¹æ®å±å¹•Refresh Rateã€é¢„å…ˆé…ç½®çš„ç›¸ä½å·®ç­‰ä¿¡æ¯ï¼Œç»è¿‡è®¡ç®—åæ¨¡æ‹Ÿå‡ºæ¥çš„VSYNC-appå’ŒVSYNC-sfã€‚ ç”±äºåªéœ€è¦ä¸€å®šçš„ç¡¬ä»¶VSyncæ ·æœ¬åä¾¿å¯ä»¥æ¨¡æ‹Ÿå‡ºé¢„æœŸçš„VSYNC-appå’ŒVSYNC-sfï¼Œå› æ­¤å¹¶ä¸éœ€è¦ä¸€ç›´æ¥æ”¶HW_VSYNC_[ID]ä¿¡å·ï¼Œåœ¨æ”¶åˆ°è¶³å¤Ÿçš„æ ·æœ¬æ•°åï¼ˆåœ¨AndroidÂ 14ä¸­ä¸º6ä¸ªï¼‰å°±å¯ä»¥å…³é—­ç¡¬ä»¶VSyncçš„æ¥æ”¶ã€‚åœ¨æ¯æ¬¡å°†åˆæˆæ•°æ®æäº¤ç»™å±å¹•åï¼Œä¼šè¿”å›ä¸€ä¸ªç¡¬ä»¶VSyncæ—¶é—´æˆ³ï¼ˆPresentFenceï¼‰ï¼Œæ­¤æ—¶SFä¼šå¯¹æ¯”å½“å‰æ¨¡æ‹ŸVSyncä¸ç¡¬ä»¶VSyncæ˜¯å¦è¯¯å·®è¿‡å¤§ï¼Œå¦‚æœè¿‡å¤§ï¼Œä¼šé‡æ–°æ‰“å¼€ç¡¬ä»¶VSyncæ”¶é›†æ ·æœ¬é‡æ–°è®¡ç®—ã€‚å¦å¤–ï¼Œæ¯æ¬¡ç»ˆç«¯åº”ç”¨ä¸»åŠ¨è¯·æ±‚VSyncæ—¶ï¼Œä¹Ÿä¼šåˆ¤æ–­å‰åä¸¤æ¬¡æ¨¡æ‹Ÿçš„VSyncæ—¶é—´å·®æ˜¯å¦è¶…è¿‡750msï¼Œå¦‚æœæ˜¯åˆ™é‡æ–°è¯·æ±‚æ‰“å¼€ç¡¬ä»¶VSyncã€‚åœ¨systraceä¸Šç¡¬ä»¶VSyncæ‰“å¼€çš„TAGæ˜¯HW_VSYNC_ON_[ID]ã€‚ å‚è€ƒèµ„æ–™ï¼šhttps://source.android.com/docs/core/graphics/implement-vsync å¯å˜åˆ·æ–°ç‡ ç°ä»£æ——èˆ°æœºå±å¹•çš„åˆ·æ–°ç‡æ˜¯å¯å˜çš„ï¼Œæ¯”å¦‚PixelÂ 5ï¼š å¯ä»¥çœ‹åˆ°ï¼Œè¯¥å±å¹•æ˜¯æ”¯æŒ60Hzã€90Hzä¸¤ç§åˆ·æ–°ç‡çš„ã€‚ è€Œä¸”åº”ç”¨å±‚ä¹Ÿå¯ä»¥åœ¨åº”ç”¨çº§åˆ«ã€çª—å£çº§åˆ«æŒ‡å®šå…·ä½“çš„åˆ·æ–°ç‡ã€‚åœ¨ç»è¿‡åº”ç”¨å±‚æŒ‡å®šåï¼Œæœ€ç»ˆçš„åˆ·æ–°ç‡å¹¶ä¸ä¸€å®šæ˜¯æŒ‡å®šçš„å€¼ï¼Œè€Œæ˜¯ç»è¿‡SurfaceFlingerç»¼åˆè®¡ç®—åå¾—å‡ºã€‚å…·ä½“è§https://developer.android.com/media/optimize/performance/frame-rate ","date":"2024-11-06","objectID":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-%E6%A6%82%E8%A7%88_blastbufferqueue-csdn%E5%8D%9A%E5%AE%A2/:4:0","tags":["clippings","è½¬è½½","blog"],"title":"Android 14 - ç»˜åˆ¶ä½“ç³» - æ¦‚è§ˆ_blastbufferqueue-CSDNåšå®¢","uri":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-%E6%A6%82%E8%A7%88_blastbufferqueue-csdn%E5%8D%9A%E5%AE%A2/#4-vsync"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"4. V****SYNC VSyncç®€ä»‹ï¼š é¦–å…ˆå…³æ³¨ä¸¤ä¸ªé‡è¦æ¦‚å¿µï¼š refreshÂ rate - 60Hz ï¼šä»£è¡¨æ¯ç§’é’Ÿå±å¹•å¯ä»¥æ›´æ–°å¤šå°‘æ¬¡ï¼Œè¿™ä¸€å€¼æ—©æœŸæ˜¯å›ºå®šçš„ï¼Œä¾èµ–äºç¡¬ä»¶ã€‚ç°ä»£æ——èˆ°è®¾å¤‡çš„å±å¹•éƒ½æ”¯æŒå¤šä¸ªåˆ·æ–°ç‡ï¼Œä»60Hz~165Hzä¸ç­‰ï¼Œè€Œä¸”æ˜¯å¯ä»¥ç”±Appå±‚å®šåˆ¶åˆ·æ–°ç‡ã€‚ frameÂ rateï¼šæ¯ç§’é’ŸGPUå¯ä»¥ç»˜åˆ¶å¤šå°‘å¸§ï¼Œå€¼è¶Šå¤§è¶Šå¥½ VSyncæ˜¯ä¸€ä¸ªé€šç”¨æ¦‚å¿µï¼Œåœ¨Linuxã€PCã€ç§»åŠ¨è®¾å¤‡ä¸Šéƒ½æœ‰æ‰€å®ç°ã€‚ æƒ³è±¡ä¸€ä¸‹ç»˜åˆ¶è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼šGPUç»˜åˆ¶æ•°æ®ï¼Œå°†ç»˜åˆ¶ç»“æœæŠ•æ·ç»™å±å¹•æ˜¾ç¤ºå‡ºæ¥ã€‚ é—®é¢˜æ˜¯ï¼Œrefresh rateå’ŒFrame Rateå¹¶ä¸ä¿è¯æ˜¯ä¸€è‡´çš„é¢‘ç‡ï¼Œä¹Ÿå°±æ˜¯æ˜¯è¯´GPUæ¸²æŸ“çš„æ—¶é—´å¹¶ä¸èƒ½ä¿è¯å°±æ­£å¥½æ˜¯16msï¼ˆ60Hzï¼‰å†…å®Œæˆçš„ã€‚å¦‚æœåªæœ‰ä¸€å—å†…å­˜ï¼ˆFrameÂ Bufferï¼‰ç”¨æ¥äº¤æ¢æ•°æ®ï¼Œå‡å¦‚RefreshÂ Rateå¤§äºFrame Rateï¼Œç”±äºGPUæ˜¯ä»ä¸Šåˆ°ä¸‹å†™è¿™å—å†…å­˜çš„ï¼Œåœ¨å½“å±å¹•æ¥å–æ•°æ®çš„æ—¶å€™ï¼ŒGPUåˆšåˆšåœ¨æ—§å¸§åŸºç¡€ä¸Šå†™äº†ä¸€åŠçš„æ–°å¸§ï¼Œæ­¤æ—¶å°±ä¼šå‡ºç°å›¾ç‰‡æ’•è£‚é—®é¢˜ï¼Œå¦‚ï¼š è§£å†³æ–¹æ³•æ˜¯åŒç¼“å­˜æ–¹æ¡ˆï¼š æä¾›BackÂ Bufferå’ŒFrameÂ Bufferä¸¤ä¸ªç¼“å­˜ï¼Œå±å¹•å§‹ç»ˆä»FrameÂ Bufferå–æ•°æ®æ˜¾ç¤ºï¼ŒGPUå¾€Back Bufferé‡Œå†™ï¼Œå½“GPUå®Œå…¨å°†æ•°æ®å†™å¥½åï¼Œå†å°†Back Bufferæ•´ä¸ªæ‹·è´åˆ°Frame Bufferã€‚è¿™æ ·å°±èƒ½ä¿è¯å±å¹•æ¯æ¬¡éƒ½å–åˆ°å®Œæ•´çš„å¸§ã€‚ æ­¤æ—¶ä»æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœGPUçš„FrameÂ Rateå¤§äºå±å¹•çš„Refresh Rateï¼Œé‚£ä¹ˆå±å¹•å†å–åˆ°ä¸‹ä¸€å¸§å‰ï¼Œå¯èƒ½GPUéƒ½å†™å®Œå¥½å‡ å¸§äº†ï¼Œå°±ä¼šå‡ºç°ä¸¢å¸§ç°è±¡ã€‚æ­¤æ—¶å°±éœ€è¦VSyncï¼š å±å¹•æ ¹æ®è‡ªå·±çš„åˆ·æ–°é¢‘ç‡ï¼Œå»ç»™ä¸Šå±‚å‘é€ä¸€ä¸ªVSyncä¿¡å·ï¼ŒGPUåœ¨æ‹¿åˆ°è¿™ä¸ªVSyncä¿¡å·åï¼Œæ‰å»ç»˜åˆ¶ã€‚è¿™æ ·å°±èƒ½åŒæ­¥å±å¹•ä¸ä¸Šå±‚ç»˜åˆ¶çš„èŠ‚å¥äº†ã€‚ å¦‚æœå±å¹•çš„Refresh Rateå¤§äºGPUçš„Frame Rateæ€ä¹ˆåŠï¼Ÿ å±å¹•å°†ä¼šä»ç„¶æ˜¾ç¤ºæ—§å¸§ã€‚æ¯”å¦‚ä¸­é—´æ–¹æ¡†çš„ä¸¤æ¬¡åˆ·æ–°ï¼Œå±å¹•ä»ç„¶æ˜¾ç¤ºå‰ä¸€æ¬¡çš„å¸§å†…å®¹ã€‚ Androidçš„V****SYNC å®é™…ä¸ŠAndroidçš„VSyncè¦å¤æ‚å¾—å¤šï¼Œä¸»è¦ç”±SurfaceFlingerè´Ÿè´£å®ç°ã€‚é€šè¿‡ä¹‹å‰çš„ä»‹ç»æˆ‘ä»¬çŸ¥é“ä¸€å¸§çš„ç»˜åˆ¶è¿‡ç¨‹æœ‰APPç»˜åˆ¶æ¸²æŸ“ã€SurfaceFlingeråˆæˆã€Displayç¡¬ä»¶è¯»å–å¸§ç¼“å­˜æ˜¾ç¤ºå›¾ç‰‡ä¸‰ä¸ªé˜¶æ®µï¼Œå¦‚æœæ¯ä¸€ä¸ªé˜¶æ®µéƒ½ä¾èµ–VSyncä¿¡å·æ¥æ‰§è¡Œï¼Œé‚£å¯èƒ½ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼š ä¹Ÿå°±æ˜¯è¯´ï¼ŒVSync1çš„æ—¶å€™APPæ­£åœ¨ç»˜åˆ¶æ¸²æŸ“ï¼ŒSFè¿˜æ²¡æœ‰å¯ä»¥åˆæˆçš„ä¸œè¥¿ï¼Œæ‰€ä»¥ä»€ä¹ˆéƒ½ä¸åšï¼›ç­‰åˆ°VSync2çš„æ—¶å€™ï¼ŒRender1çš„å·¥ä½œå·²ç»å®Œæˆï¼Œå¯ä»¥åšåˆæˆäº†ï¼›VSync3çš„æ—¶å€™ï¼Œåˆæˆåšå®Œäº†ï¼Œæ‰å¯ä»¥æ˜¾ç¤ºåˆ°å±å¹•ä¸Šã€‚ä»ç»˜åˆ¶æ¸²æŸ“åˆ°æ˜¾ç¤ºç»å†äº†3ä¸ªVSyncã€‚é¢å¯¹è¿™ç§æƒ…å†µï¼ŒAndroidå¯¹VSyncçš„è®¾è®¡å¦‚ä¸‹ï¼š å³æœ‰ä¸‰ç§ä¿¡å· HW_VSYNC_[ID]ï¼šç”±åº•å±‚ç¡¬ä»¶æŒ‰RefreshÂ Rateçš„é¢‘ç‡å‘å‡ºï¼Œä¸€èˆ¬ä¸º60Hzã€90Hzã€120Hç­‰ç­‰ï¼Œéšåä¼šé€šè¿‡HWCé€šçŸ¥ç»™SurfaceFlingerã€‚ VSYNC-appï¼šSurfaceFlingeré€šçŸ¥ç»™ä¸Šå±‚åº”ç”¨çš„VSYNCï¼Œç”¨äºæ§åˆ¶å’Œé©±åŠ¨åº”ç”¨çš„ç»˜åˆ¶æ¸²æŸ“ã€‚ VSYNC-sf:é€šçŸ¥ç»™SurfaceFlingerè‡ªèº«çš„ï¼Œç”¨äºåˆæˆLayerçš„ä¿¡å·ã€‚ VSYNC-appå’ŒVSYNC-sfç›¸å¯¹äºHW_VSYNC_[ID]ï¼Œå¹¶ä¸æ˜¯åŒæ­¥å‘é€çš„ï¼Œè€Œæ˜¯æœ‰ä¸€å®šçš„å»¶è¿Ÿï¼Œç§°ä¸ºç›¸ä½å·®ã€‚ä»HW_VSYNC_[ID]åˆ°VSYNC-appå‘å‡ºçš„æ—¶é—´å·®ç§°ä¸ºapp phaseï¼ŒHW_VSYNC_[ID]åˆ°VSYNC-sfå‘å‡ºçš„æ—¶é—´å·®ç§°ä¸ºsf phaseã€‚è¿™ç§è®¾è®¡çš„å¥½å¤„æ˜¯ï¼Œå¦‚æœåœ¨åŒä¸€ä¸ªVSyncå‘¨æœŸå†…ï¼Œç»sfÂ phaseååœ¨æ‰§è¡Œåˆæˆæ—¶æ°å¥½å‰ä¸€æ­¥çš„Renderå®Œæˆäº†ï¼Œå°±å¯åœ¨ä¸€ä¸ªå‘¨æœŸå®Œæˆä¸¤æ­¥ï¼Œè€Œä¸ç”¨éå¾—ç­‰ä¸‹ä¸€ä¸ªVSyncã€‚ å¦å¤–ï¼ŒAndroidå¹¶éç›´æ¥æŠŠç¡¬ä»¶çš„HW_VSYNC_[ID]ä¿¡å·ç›´æ¥åˆ†å‘ç»™åº”ç”¨å’ŒSurfaceFlingerï¼Œè€Œæ˜¯é€šè¿‡å…ˆæ”¶é›†HW_VSYNC_[ID]æ ·æœ¬ï¼Œå†æ ¹æ®å±å¹•Refresh Rateã€é¢„å…ˆé…ç½®çš„ç›¸ä½å·®ç­‰ä¿¡æ¯ï¼Œç»è¿‡è®¡ç®—åæ¨¡æ‹Ÿå‡ºæ¥çš„VSYNC-appå’ŒVSYNC-sfã€‚ ç”±äºåªéœ€è¦ä¸€å®šçš„ç¡¬ä»¶VSyncæ ·æœ¬åä¾¿å¯ä»¥æ¨¡æ‹Ÿå‡ºé¢„æœŸçš„VSYNC-appå’ŒVSYNC-sfï¼Œå› æ­¤å¹¶ä¸éœ€è¦ä¸€ç›´æ¥æ”¶HW_VSYNC_[ID]ä¿¡å·ï¼Œåœ¨æ”¶åˆ°è¶³å¤Ÿçš„æ ·æœ¬æ•°åï¼ˆåœ¨AndroidÂ 14ä¸­ä¸º6ä¸ªï¼‰å°±å¯ä»¥å…³é—­ç¡¬ä»¶VSyncçš„æ¥æ”¶ã€‚åœ¨æ¯æ¬¡å°†åˆæˆæ•°æ®æäº¤ç»™å±å¹•åï¼Œä¼šè¿”å›ä¸€ä¸ªç¡¬ä»¶VSyncæ—¶é—´æˆ³ï¼ˆPresentFenceï¼‰ï¼Œæ­¤æ—¶SFä¼šå¯¹æ¯”å½“å‰æ¨¡æ‹ŸVSyncä¸ç¡¬ä»¶VSyncæ˜¯å¦è¯¯å·®è¿‡å¤§ï¼Œå¦‚æœè¿‡å¤§ï¼Œä¼šé‡æ–°æ‰“å¼€ç¡¬ä»¶VSyncæ”¶é›†æ ·æœ¬é‡æ–°è®¡ç®—ã€‚å¦å¤–ï¼Œæ¯æ¬¡ç»ˆç«¯åº”ç”¨ä¸»åŠ¨è¯·æ±‚VSyncæ—¶ï¼Œä¹Ÿä¼šåˆ¤æ–­å‰åä¸¤æ¬¡æ¨¡æ‹Ÿçš„VSyncæ—¶é—´å·®æ˜¯å¦è¶…è¿‡750msï¼Œå¦‚æœæ˜¯åˆ™é‡æ–°è¯·æ±‚æ‰“å¼€ç¡¬ä»¶VSyncã€‚åœ¨systraceä¸Šç¡¬ä»¶VSyncæ‰“å¼€çš„TAGæ˜¯HW_VSYNC_ON_[ID]ã€‚ å‚è€ƒèµ„æ–™ï¼šhttps://source.android.com/docs/core/graphics/implement-vsync å¯å˜åˆ·æ–°ç‡ ç°ä»£æ——èˆ°æœºå±å¹•çš„åˆ·æ–°ç‡æ˜¯å¯å˜çš„ï¼Œæ¯”å¦‚PixelÂ 5ï¼š å¯ä»¥çœ‹åˆ°ï¼Œè¯¥å±å¹•æ˜¯æ”¯æŒ60Hzã€90Hzä¸¤ç§åˆ·æ–°ç‡çš„ã€‚ è€Œä¸”åº”ç”¨å±‚ä¹Ÿå¯ä»¥åœ¨åº”ç”¨çº§åˆ«ã€çª—å£çº§åˆ«æŒ‡å®šå…·ä½“çš„åˆ·æ–°ç‡ã€‚åœ¨ç»è¿‡åº”ç”¨å±‚æŒ‡å®šåï¼Œæœ€ç»ˆçš„åˆ·æ–°ç‡å¹¶ä¸ä¸€å®šæ˜¯æŒ‡å®šçš„å€¼ï¼Œè€Œæ˜¯ç»è¿‡SurfaceFlingerç»¼åˆè®¡ç®—åå¾—å‡ºã€‚å…·ä½“è§https://developer.android.com/media/optimize/performance/frame-rate ","date":"2024-11-06","objectID":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-%E6%A6%82%E8%A7%88_blastbufferqueue-csdn%E5%8D%9A%E5%AE%A2/:4:0","tags":["clippings","è½¬è½½","blog"],"title":"Android 14 - ç»˜åˆ¶ä½“ç³» - æ¦‚è§ˆ_blastbufferqueue-CSDNåšå®¢","uri":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-%E6%A6%82%E8%A7%88_blastbufferqueue-csdn%E5%8D%9A%E5%AE%A2/#vsyncç®€ä»‹"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"4. V****SYNC VSyncç®€ä»‹ï¼š é¦–å…ˆå…³æ³¨ä¸¤ä¸ªé‡è¦æ¦‚å¿µï¼š refreshÂ rate - 60Hz ï¼šä»£è¡¨æ¯ç§’é’Ÿå±å¹•å¯ä»¥æ›´æ–°å¤šå°‘æ¬¡ï¼Œè¿™ä¸€å€¼æ—©æœŸæ˜¯å›ºå®šçš„ï¼Œä¾èµ–äºç¡¬ä»¶ã€‚ç°ä»£æ——èˆ°è®¾å¤‡çš„å±å¹•éƒ½æ”¯æŒå¤šä¸ªåˆ·æ–°ç‡ï¼Œä»60Hz~165Hzä¸ç­‰ï¼Œè€Œä¸”æ˜¯å¯ä»¥ç”±Appå±‚å®šåˆ¶åˆ·æ–°ç‡ã€‚ frameÂ rateï¼šæ¯ç§’é’ŸGPUå¯ä»¥ç»˜åˆ¶å¤šå°‘å¸§ï¼Œå€¼è¶Šå¤§è¶Šå¥½ VSyncæ˜¯ä¸€ä¸ªé€šç”¨æ¦‚å¿µï¼Œåœ¨Linuxã€PCã€ç§»åŠ¨è®¾å¤‡ä¸Šéƒ½æœ‰æ‰€å®ç°ã€‚ æƒ³è±¡ä¸€ä¸‹ç»˜åˆ¶è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼šGPUç»˜åˆ¶æ•°æ®ï¼Œå°†ç»˜åˆ¶ç»“æœæŠ•æ·ç»™å±å¹•æ˜¾ç¤ºå‡ºæ¥ã€‚ é—®é¢˜æ˜¯ï¼Œrefresh rateå’ŒFrame Rateå¹¶ä¸ä¿è¯æ˜¯ä¸€è‡´çš„é¢‘ç‡ï¼Œä¹Ÿå°±æ˜¯æ˜¯è¯´GPUæ¸²æŸ“çš„æ—¶é—´å¹¶ä¸èƒ½ä¿è¯å°±æ­£å¥½æ˜¯16msï¼ˆ60Hzï¼‰å†…å®Œæˆçš„ã€‚å¦‚æœåªæœ‰ä¸€å—å†…å­˜ï¼ˆFrameÂ Bufferï¼‰ç”¨æ¥äº¤æ¢æ•°æ®ï¼Œå‡å¦‚RefreshÂ Rateå¤§äºFrame Rateï¼Œç”±äºGPUæ˜¯ä»ä¸Šåˆ°ä¸‹å†™è¿™å—å†…å­˜çš„ï¼Œåœ¨å½“å±å¹•æ¥å–æ•°æ®çš„æ—¶å€™ï¼ŒGPUåˆšåˆšåœ¨æ—§å¸§åŸºç¡€ä¸Šå†™äº†ä¸€åŠçš„æ–°å¸§ï¼Œæ­¤æ—¶å°±ä¼šå‡ºç°å›¾ç‰‡æ’•è£‚é—®é¢˜ï¼Œå¦‚ï¼š è§£å†³æ–¹æ³•æ˜¯åŒç¼“å­˜æ–¹æ¡ˆï¼š æä¾›BackÂ Bufferå’ŒFrameÂ Bufferä¸¤ä¸ªç¼“å­˜ï¼Œå±å¹•å§‹ç»ˆä»FrameÂ Bufferå–æ•°æ®æ˜¾ç¤ºï¼ŒGPUå¾€Back Bufferé‡Œå†™ï¼Œå½“GPUå®Œå…¨å°†æ•°æ®å†™å¥½åï¼Œå†å°†Back Bufferæ•´ä¸ªæ‹·è´åˆ°Frame Bufferã€‚è¿™æ ·å°±èƒ½ä¿è¯å±å¹•æ¯æ¬¡éƒ½å–åˆ°å®Œæ•´çš„å¸§ã€‚ æ­¤æ—¶ä»æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœGPUçš„FrameÂ Rateå¤§äºå±å¹•çš„Refresh Rateï¼Œé‚£ä¹ˆå±å¹•å†å–åˆ°ä¸‹ä¸€å¸§å‰ï¼Œå¯èƒ½GPUéƒ½å†™å®Œå¥½å‡ å¸§äº†ï¼Œå°±ä¼šå‡ºç°ä¸¢å¸§ç°è±¡ã€‚æ­¤æ—¶å°±éœ€è¦VSyncï¼š å±å¹•æ ¹æ®è‡ªå·±çš„åˆ·æ–°é¢‘ç‡ï¼Œå»ç»™ä¸Šå±‚å‘é€ä¸€ä¸ªVSyncä¿¡å·ï¼ŒGPUåœ¨æ‹¿åˆ°è¿™ä¸ªVSyncä¿¡å·åï¼Œæ‰å»ç»˜åˆ¶ã€‚è¿™æ ·å°±èƒ½åŒæ­¥å±å¹•ä¸ä¸Šå±‚ç»˜åˆ¶çš„èŠ‚å¥äº†ã€‚ å¦‚æœå±å¹•çš„Refresh Rateå¤§äºGPUçš„Frame Rateæ€ä¹ˆåŠï¼Ÿ å±å¹•å°†ä¼šä»ç„¶æ˜¾ç¤ºæ—§å¸§ã€‚æ¯”å¦‚ä¸­é—´æ–¹æ¡†çš„ä¸¤æ¬¡åˆ·æ–°ï¼Œå±å¹•ä»ç„¶æ˜¾ç¤ºå‰ä¸€æ¬¡çš„å¸§å†…å®¹ã€‚ Androidçš„V****SYNC å®é™…ä¸ŠAndroidçš„VSyncè¦å¤æ‚å¾—å¤šï¼Œä¸»è¦ç”±SurfaceFlingerè´Ÿè´£å®ç°ã€‚é€šè¿‡ä¹‹å‰çš„ä»‹ç»æˆ‘ä»¬çŸ¥é“ä¸€å¸§çš„ç»˜åˆ¶è¿‡ç¨‹æœ‰APPç»˜åˆ¶æ¸²æŸ“ã€SurfaceFlingeråˆæˆã€Displayç¡¬ä»¶è¯»å–å¸§ç¼“å­˜æ˜¾ç¤ºå›¾ç‰‡ä¸‰ä¸ªé˜¶æ®µï¼Œå¦‚æœæ¯ä¸€ä¸ªé˜¶æ®µéƒ½ä¾èµ–VSyncä¿¡å·æ¥æ‰§è¡Œï¼Œé‚£å¯èƒ½ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼š ä¹Ÿå°±æ˜¯è¯´ï¼ŒVSync1çš„æ—¶å€™APPæ­£åœ¨ç»˜åˆ¶æ¸²æŸ“ï¼ŒSFè¿˜æ²¡æœ‰å¯ä»¥åˆæˆçš„ä¸œè¥¿ï¼Œæ‰€ä»¥ä»€ä¹ˆéƒ½ä¸åšï¼›ç­‰åˆ°VSync2çš„æ—¶å€™ï¼ŒRender1çš„å·¥ä½œå·²ç»å®Œæˆï¼Œå¯ä»¥åšåˆæˆäº†ï¼›VSync3çš„æ—¶å€™ï¼Œåˆæˆåšå®Œäº†ï¼Œæ‰å¯ä»¥æ˜¾ç¤ºåˆ°å±å¹•ä¸Šã€‚ä»ç»˜åˆ¶æ¸²æŸ“åˆ°æ˜¾ç¤ºç»å†äº†3ä¸ªVSyncã€‚é¢å¯¹è¿™ç§æƒ…å†µï¼ŒAndroidå¯¹VSyncçš„è®¾è®¡å¦‚ä¸‹ï¼š å³æœ‰ä¸‰ç§ä¿¡å· HW_VSYNC_[ID]ï¼šç”±åº•å±‚ç¡¬ä»¶æŒ‰RefreshÂ Rateçš„é¢‘ç‡å‘å‡ºï¼Œä¸€èˆ¬ä¸º60Hzã€90Hzã€120Hç­‰ç­‰ï¼Œéšåä¼šé€šè¿‡HWCé€šçŸ¥ç»™SurfaceFlingerã€‚ VSYNC-appï¼šSurfaceFlingeré€šçŸ¥ç»™ä¸Šå±‚åº”ç”¨çš„VSYNCï¼Œç”¨äºæ§åˆ¶å’Œé©±åŠ¨åº”ç”¨çš„ç»˜åˆ¶æ¸²æŸ“ã€‚ VSYNC-sf:é€šçŸ¥ç»™SurfaceFlingerè‡ªèº«çš„ï¼Œç”¨äºåˆæˆLayerçš„ä¿¡å·ã€‚ VSYNC-appå’ŒVSYNC-sfç›¸å¯¹äºHW_VSYNC_[ID]ï¼Œå¹¶ä¸æ˜¯åŒæ­¥å‘é€çš„ï¼Œè€Œæ˜¯æœ‰ä¸€å®šçš„å»¶è¿Ÿï¼Œç§°ä¸ºç›¸ä½å·®ã€‚ä»HW_VSYNC_[ID]åˆ°VSYNC-appå‘å‡ºçš„æ—¶é—´å·®ç§°ä¸ºapp phaseï¼ŒHW_VSYNC_[ID]åˆ°VSYNC-sfå‘å‡ºçš„æ—¶é—´å·®ç§°ä¸ºsf phaseã€‚è¿™ç§è®¾è®¡çš„å¥½å¤„æ˜¯ï¼Œå¦‚æœåœ¨åŒä¸€ä¸ªVSyncå‘¨æœŸå†…ï¼Œç»sfÂ phaseååœ¨æ‰§è¡Œåˆæˆæ—¶æ°å¥½å‰ä¸€æ­¥çš„Renderå®Œæˆäº†ï¼Œå°±å¯åœ¨ä¸€ä¸ªå‘¨æœŸå®Œæˆä¸¤æ­¥ï¼Œè€Œä¸ç”¨éå¾—ç­‰ä¸‹ä¸€ä¸ªVSyncã€‚ å¦å¤–ï¼ŒAndroidå¹¶éç›´æ¥æŠŠç¡¬ä»¶çš„HW_VSYNC_[ID]ä¿¡å·ç›´æ¥åˆ†å‘ç»™åº”ç”¨å’ŒSurfaceFlingerï¼Œè€Œæ˜¯é€šè¿‡å…ˆæ”¶é›†HW_VSYNC_[ID]æ ·æœ¬ï¼Œå†æ ¹æ®å±å¹•Refresh Rateã€é¢„å…ˆé…ç½®çš„ç›¸ä½å·®ç­‰ä¿¡æ¯ï¼Œç»è¿‡è®¡ç®—åæ¨¡æ‹Ÿå‡ºæ¥çš„VSYNC-appå’ŒVSYNC-sfã€‚ ç”±äºåªéœ€è¦ä¸€å®šçš„ç¡¬ä»¶VSyncæ ·æœ¬åä¾¿å¯ä»¥æ¨¡æ‹Ÿå‡ºé¢„æœŸçš„VSYNC-appå’ŒVSYNC-sfï¼Œå› æ­¤å¹¶ä¸éœ€è¦ä¸€ç›´æ¥æ”¶HW_VSYNC_[ID]ä¿¡å·ï¼Œåœ¨æ”¶åˆ°è¶³å¤Ÿçš„æ ·æœ¬æ•°åï¼ˆåœ¨AndroidÂ 14ä¸­ä¸º6ä¸ªï¼‰å°±å¯ä»¥å…³é—­ç¡¬ä»¶VSyncçš„æ¥æ”¶ã€‚åœ¨æ¯æ¬¡å°†åˆæˆæ•°æ®æäº¤ç»™å±å¹•åï¼Œä¼šè¿”å›ä¸€ä¸ªç¡¬ä»¶VSyncæ—¶é—´æˆ³ï¼ˆPresentFenceï¼‰ï¼Œæ­¤æ—¶SFä¼šå¯¹æ¯”å½“å‰æ¨¡æ‹ŸVSyncä¸ç¡¬ä»¶VSyncæ˜¯å¦è¯¯å·®è¿‡å¤§ï¼Œå¦‚æœè¿‡å¤§ï¼Œä¼šé‡æ–°æ‰“å¼€ç¡¬ä»¶VSyncæ”¶é›†æ ·æœ¬é‡æ–°è®¡ç®—ã€‚å¦å¤–ï¼Œæ¯æ¬¡ç»ˆç«¯åº”ç”¨ä¸»åŠ¨è¯·æ±‚VSyncæ—¶ï¼Œä¹Ÿä¼šåˆ¤æ–­å‰åä¸¤æ¬¡æ¨¡æ‹Ÿçš„VSyncæ—¶é—´å·®æ˜¯å¦è¶…è¿‡750msï¼Œå¦‚æœæ˜¯åˆ™é‡æ–°è¯·æ±‚æ‰“å¼€ç¡¬ä»¶VSyncã€‚åœ¨systraceä¸Šç¡¬ä»¶VSyncæ‰“å¼€çš„TAGæ˜¯HW_VSYNC_ON_[ID]ã€‚ å‚è€ƒèµ„æ–™ï¼šhttps://source.android.com/docs/core/graphics/implement-vsync å¯å˜åˆ·æ–°ç‡ ç°ä»£æ——èˆ°æœºå±å¹•çš„åˆ·æ–°ç‡æ˜¯å¯å˜çš„ï¼Œæ¯”å¦‚PixelÂ 5ï¼š å¯ä»¥çœ‹åˆ°ï¼Œè¯¥å±å¹•æ˜¯æ”¯æŒ60Hzã€90Hzä¸¤ç§åˆ·æ–°ç‡çš„ã€‚ è€Œä¸”åº”ç”¨å±‚ä¹Ÿå¯ä»¥åœ¨åº”ç”¨çº§åˆ«ã€çª—å£çº§åˆ«æŒ‡å®šå…·ä½“çš„åˆ·æ–°ç‡ã€‚åœ¨ç»è¿‡åº”ç”¨å±‚æŒ‡å®šåï¼Œæœ€ç»ˆçš„åˆ·æ–°ç‡å¹¶ä¸ä¸€å®šæ˜¯æŒ‡å®šçš„å€¼ï¼Œè€Œæ˜¯ç»è¿‡SurfaceFlingerç»¼åˆè®¡ç®—åå¾—å‡ºã€‚å…·ä½“è§https://developer.android.com/media/optimize/performance/frame-rate ","date":"2024-11-06","objectID":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-%E6%A6%82%E8%A7%88_blastbufferqueue-csdn%E5%8D%9A%E5%AE%A2/:4:0","tags":["clippings","è½¬è½½","blog"],"title":"Android 14 - ç»˜åˆ¶ä½“ç³» - æ¦‚è§ˆ_blastbufferqueue-CSDNåšå®¢","uri":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-%E6%A6%82%E8%A7%88_blastbufferqueue-csdn%E5%8D%9A%E5%AE%A2/#androidçš„vsync"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"4. V****SYNC VSyncç®€ä»‹ï¼š é¦–å…ˆå…³æ³¨ä¸¤ä¸ªé‡è¦æ¦‚å¿µï¼š refreshÂ rate - 60Hz ï¼šä»£è¡¨æ¯ç§’é’Ÿå±å¹•å¯ä»¥æ›´æ–°å¤šå°‘æ¬¡ï¼Œè¿™ä¸€å€¼æ—©æœŸæ˜¯å›ºå®šçš„ï¼Œä¾èµ–äºç¡¬ä»¶ã€‚ç°ä»£æ——èˆ°è®¾å¤‡çš„å±å¹•éƒ½æ”¯æŒå¤šä¸ªåˆ·æ–°ç‡ï¼Œä»60Hz~165Hzä¸ç­‰ï¼Œè€Œä¸”æ˜¯å¯ä»¥ç”±Appå±‚å®šåˆ¶åˆ·æ–°ç‡ã€‚ frameÂ rateï¼šæ¯ç§’é’ŸGPUå¯ä»¥ç»˜åˆ¶å¤šå°‘å¸§ï¼Œå€¼è¶Šå¤§è¶Šå¥½ VSyncæ˜¯ä¸€ä¸ªé€šç”¨æ¦‚å¿µï¼Œåœ¨Linuxã€PCã€ç§»åŠ¨è®¾å¤‡ä¸Šéƒ½æœ‰æ‰€å®ç°ã€‚ æƒ³è±¡ä¸€ä¸‹ç»˜åˆ¶è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼šGPUç»˜åˆ¶æ•°æ®ï¼Œå°†ç»˜åˆ¶ç»“æœæŠ•æ·ç»™å±å¹•æ˜¾ç¤ºå‡ºæ¥ã€‚ é—®é¢˜æ˜¯ï¼Œrefresh rateå’ŒFrame Rateå¹¶ä¸ä¿è¯æ˜¯ä¸€è‡´çš„é¢‘ç‡ï¼Œä¹Ÿå°±æ˜¯æ˜¯è¯´GPUæ¸²æŸ“çš„æ—¶é—´å¹¶ä¸èƒ½ä¿è¯å°±æ­£å¥½æ˜¯16msï¼ˆ60Hzï¼‰å†…å®Œæˆçš„ã€‚å¦‚æœåªæœ‰ä¸€å—å†…å­˜ï¼ˆFrameÂ Bufferï¼‰ç”¨æ¥äº¤æ¢æ•°æ®ï¼Œå‡å¦‚RefreshÂ Rateå¤§äºFrame Rateï¼Œç”±äºGPUæ˜¯ä»ä¸Šåˆ°ä¸‹å†™è¿™å—å†…å­˜çš„ï¼Œåœ¨å½“å±å¹•æ¥å–æ•°æ®çš„æ—¶å€™ï¼ŒGPUåˆšåˆšåœ¨æ—§å¸§åŸºç¡€ä¸Šå†™äº†ä¸€åŠçš„æ–°å¸§ï¼Œæ­¤æ—¶å°±ä¼šå‡ºç°å›¾ç‰‡æ’•è£‚é—®é¢˜ï¼Œå¦‚ï¼š è§£å†³æ–¹æ³•æ˜¯åŒç¼“å­˜æ–¹æ¡ˆï¼š æä¾›BackÂ Bufferå’ŒFrameÂ Bufferä¸¤ä¸ªç¼“å­˜ï¼Œå±å¹•å§‹ç»ˆä»FrameÂ Bufferå–æ•°æ®æ˜¾ç¤ºï¼ŒGPUå¾€Back Bufferé‡Œå†™ï¼Œå½“GPUå®Œå…¨å°†æ•°æ®å†™å¥½åï¼Œå†å°†Back Bufferæ•´ä¸ªæ‹·è´åˆ°Frame Bufferã€‚è¿™æ ·å°±èƒ½ä¿è¯å±å¹•æ¯æ¬¡éƒ½å–åˆ°å®Œæ•´çš„å¸§ã€‚ æ­¤æ—¶ä»æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœGPUçš„FrameÂ Rateå¤§äºå±å¹•çš„Refresh Rateï¼Œé‚£ä¹ˆå±å¹•å†å–åˆ°ä¸‹ä¸€å¸§å‰ï¼Œå¯èƒ½GPUéƒ½å†™å®Œå¥½å‡ å¸§äº†ï¼Œå°±ä¼šå‡ºç°ä¸¢å¸§ç°è±¡ã€‚æ­¤æ—¶å°±éœ€è¦VSyncï¼š å±å¹•æ ¹æ®è‡ªå·±çš„åˆ·æ–°é¢‘ç‡ï¼Œå»ç»™ä¸Šå±‚å‘é€ä¸€ä¸ªVSyncä¿¡å·ï¼ŒGPUåœ¨æ‹¿åˆ°è¿™ä¸ªVSyncä¿¡å·åï¼Œæ‰å»ç»˜åˆ¶ã€‚è¿™æ ·å°±èƒ½åŒæ­¥å±å¹•ä¸ä¸Šå±‚ç»˜åˆ¶çš„èŠ‚å¥äº†ã€‚ å¦‚æœå±å¹•çš„Refresh Rateå¤§äºGPUçš„Frame Rateæ€ä¹ˆåŠï¼Ÿ å±å¹•å°†ä¼šä»ç„¶æ˜¾ç¤ºæ—§å¸§ã€‚æ¯”å¦‚ä¸­é—´æ–¹æ¡†çš„ä¸¤æ¬¡åˆ·æ–°ï¼Œå±å¹•ä»ç„¶æ˜¾ç¤ºå‰ä¸€æ¬¡çš„å¸§å†…å®¹ã€‚ Androidçš„V****SYNC å®é™…ä¸ŠAndroidçš„VSyncè¦å¤æ‚å¾—å¤šï¼Œä¸»è¦ç”±SurfaceFlingerè´Ÿè´£å®ç°ã€‚é€šè¿‡ä¹‹å‰çš„ä»‹ç»æˆ‘ä»¬çŸ¥é“ä¸€å¸§çš„ç»˜åˆ¶è¿‡ç¨‹æœ‰APPç»˜åˆ¶æ¸²æŸ“ã€SurfaceFlingeråˆæˆã€Displayç¡¬ä»¶è¯»å–å¸§ç¼“å­˜æ˜¾ç¤ºå›¾ç‰‡ä¸‰ä¸ªé˜¶æ®µï¼Œå¦‚æœæ¯ä¸€ä¸ªé˜¶æ®µéƒ½ä¾èµ–VSyncä¿¡å·æ¥æ‰§è¡Œï¼Œé‚£å¯èƒ½ä¼šå‡ºç°è¿™ç§æƒ…å†µï¼š ä¹Ÿå°±æ˜¯è¯´ï¼ŒVSync1çš„æ—¶å€™APPæ­£åœ¨ç»˜åˆ¶æ¸²æŸ“ï¼ŒSFè¿˜æ²¡æœ‰å¯ä»¥åˆæˆçš„ä¸œè¥¿ï¼Œæ‰€ä»¥ä»€ä¹ˆéƒ½ä¸åšï¼›ç­‰åˆ°VSync2çš„æ—¶å€™ï¼ŒRender1çš„å·¥ä½œå·²ç»å®Œæˆï¼Œå¯ä»¥åšåˆæˆäº†ï¼›VSync3çš„æ—¶å€™ï¼Œåˆæˆåšå®Œäº†ï¼Œæ‰å¯ä»¥æ˜¾ç¤ºåˆ°å±å¹•ä¸Šã€‚ä»ç»˜åˆ¶æ¸²æŸ“åˆ°æ˜¾ç¤ºç»å†äº†3ä¸ªVSyncã€‚é¢å¯¹è¿™ç§æƒ…å†µï¼ŒAndroidå¯¹VSyncçš„è®¾è®¡å¦‚ä¸‹ï¼š å³æœ‰ä¸‰ç§ä¿¡å· HW_VSYNC_[ID]ï¼šç”±åº•å±‚ç¡¬ä»¶æŒ‰RefreshÂ Rateçš„é¢‘ç‡å‘å‡ºï¼Œä¸€èˆ¬ä¸º60Hzã€90Hzã€120Hç­‰ç­‰ï¼Œéšåä¼šé€šè¿‡HWCé€šçŸ¥ç»™SurfaceFlingerã€‚ VSYNC-appï¼šSurfaceFlingeré€šçŸ¥ç»™ä¸Šå±‚åº”ç”¨çš„VSYNCï¼Œç”¨äºæ§åˆ¶å’Œé©±åŠ¨åº”ç”¨çš„ç»˜åˆ¶æ¸²æŸ“ã€‚ VSYNC-sf:é€šçŸ¥ç»™SurfaceFlingerè‡ªèº«çš„ï¼Œç”¨äºåˆæˆLayerçš„ä¿¡å·ã€‚ VSYNC-appå’ŒVSYNC-sfç›¸å¯¹äºHW_VSYNC_[ID]ï¼Œå¹¶ä¸æ˜¯åŒæ­¥å‘é€çš„ï¼Œè€Œæ˜¯æœ‰ä¸€å®šçš„å»¶è¿Ÿï¼Œç§°ä¸ºç›¸ä½å·®ã€‚ä»HW_VSYNC_[ID]åˆ°VSYNC-appå‘å‡ºçš„æ—¶é—´å·®ç§°ä¸ºapp phaseï¼ŒHW_VSYNC_[ID]åˆ°VSYNC-sfå‘å‡ºçš„æ—¶é—´å·®ç§°ä¸ºsf phaseã€‚è¿™ç§è®¾è®¡çš„å¥½å¤„æ˜¯ï¼Œå¦‚æœåœ¨åŒä¸€ä¸ªVSyncå‘¨æœŸå†…ï¼Œç»sfÂ phaseååœ¨æ‰§è¡Œåˆæˆæ—¶æ°å¥½å‰ä¸€æ­¥çš„Renderå®Œæˆäº†ï¼Œå°±å¯åœ¨ä¸€ä¸ªå‘¨æœŸå®Œæˆä¸¤æ­¥ï¼Œè€Œä¸ç”¨éå¾—ç­‰ä¸‹ä¸€ä¸ªVSyncã€‚ å¦å¤–ï¼ŒAndroidå¹¶éç›´æ¥æŠŠç¡¬ä»¶çš„HW_VSYNC_[ID]ä¿¡å·ç›´æ¥åˆ†å‘ç»™åº”ç”¨å’ŒSurfaceFlingerï¼Œè€Œæ˜¯é€šè¿‡å…ˆæ”¶é›†HW_VSYNC_[ID]æ ·æœ¬ï¼Œå†æ ¹æ®å±å¹•Refresh Rateã€é¢„å…ˆé…ç½®çš„ç›¸ä½å·®ç­‰ä¿¡æ¯ï¼Œç»è¿‡è®¡ç®—åæ¨¡æ‹Ÿå‡ºæ¥çš„VSYNC-appå’ŒVSYNC-sfã€‚ ç”±äºåªéœ€è¦ä¸€å®šçš„ç¡¬ä»¶VSyncæ ·æœ¬åä¾¿å¯ä»¥æ¨¡æ‹Ÿå‡ºé¢„æœŸçš„VSYNC-appå’ŒVSYNC-sfï¼Œå› æ­¤å¹¶ä¸éœ€è¦ä¸€ç›´æ¥æ”¶HW_VSYNC_[ID]ä¿¡å·ï¼Œåœ¨æ”¶åˆ°è¶³å¤Ÿçš„æ ·æœ¬æ•°åï¼ˆåœ¨AndroidÂ 14ä¸­ä¸º6ä¸ªï¼‰å°±å¯ä»¥å…³é—­ç¡¬ä»¶VSyncçš„æ¥æ”¶ã€‚åœ¨æ¯æ¬¡å°†åˆæˆæ•°æ®æäº¤ç»™å±å¹•åï¼Œä¼šè¿”å›ä¸€ä¸ªç¡¬ä»¶VSyncæ—¶é—´æˆ³ï¼ˆPresentFenceï¼‰ï¼Œæ­¤æ—¶SFä¼šå¯¹æ¯”å½“å‰æ¨¡æ‹ŸVSyncä¸ç¡¬ä»¶VSyncæ˜¯å¦è¯¯å·®è¿‡å¤§ï¼Œå¦‚æœè¿‡å¤§ï¼Œä¼šé‡æ–°æ‰“å¼€ç¡¬ä»¶VSyncæ”¶é›†æ ·æœ¬é‡æ–°è®¡ç®—ã€‚å¦å¤–ï¼Œæ¯æ¬¡ç»ˆç«¯åº”ç”¨ä¸»åŠ¨è¯·æ±‚VSyncæ—¶ï¼Œä¹Ÿä¼šåˆ¤æ–­å‰åä¸¤æ¬¡æ¨¡æ‹Ÿçš„VSyncæ—¶é—´å·®æ˜¯å¦è¶…è¿‡750msï¼Œå¦‚æœæ˜¯åˆ™é‡æ–°è¯·æ±‚æ‰“å¼€ç¡¬ä»¶VSyncã€‚åœ¨systraceä¸Šç¡¬ä»¶VSyncæ‰“å¼€çš„TAGæ˜¯HW_VSYNC_ON_[ID]ã€‚ å‚è€ƒèµ„æ–™ï¼šhttps://source.android.com/docs/core/graphics/implement-vsync å¯å˜åˆ·æ–°ç‡ ç°ä»£æ——èˆ°æœºå±å¹•çš„åˆ·æ–°ç‡æ˜¯å¯å˜çš„ï¼Œæ¯”å¦‚PixelÂ 5ï¼š å¯ä»¥çœ‹åˆ°ï¼Œè¯¥å±å¹•æ˜¯æ”¯æŒ60Hzã€90Hzä¸¤ç§åˆ·æ–°ç‡çš„ã€‚ è€Œä¸”åº”ç”¨å±‚ä¹Ÿå¯ä»¥åœ¨åº”ç”¨çº§åˆ«ã€çª—å£çº§åˆ«æŒ‡å®šå…·ä½“çš„åˆ·æ–°ç‡ã€‚åœ¨ç»è¿‡åº”ç”¨å±‚æŒ‡å®šåï¼Œæœ€ç»ˆçš„åˆ·æ–°ç‡å¹¶ä¸ä¸€å®šæ˜¯æŒ‡å®šçš„å€¼ï¼Œè€Œæ˜¯ç»è¿‡SurfaceFlingerç»¼åˆè®¡ç®—åå¾—å‡ºã€‚å…·ä½“è§https://developer.android.com/media/optimize/performance/frame-rate ","date":"2024-11-06","objectID":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-%E6%A6%82%E8%A7%88_blastbufferqueue-csdn%E5%8D%9A%E5%AE%A2/:4:0","tags":["clippings","è½¬è½½","blog"],"title":"Android 14 - ç»˜åˆ¶ä½“ç³» - æ¦‚è§ˆ_blastbufferqueue-CSDNåšå®¢","uri":"/posts/android-14-%E7%BB%98%E5%88%B6%E4%BD%93%E7%B3%BB-%E6%A6%82%E8%A7%88_blastbufferqueue-csdn%E5%8D%9A%E5%AE%A2/#å¯å˜åˆ·æ–°ç‡"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"ä¸€ã€SurfaceFlingerä»‹ç» SurfaceFlingeræ˜¯Androidç³»ç»Ÿä¸­çš„ä¸€ä¸ªé‡è¦ç»„ä»¶ï¼Œå®ƒä¸»è¦è´Ÿè´£çª—å£ç®¡ç†ä¸ç•Œé¢æ˜¾ç¤ºã€‚å…·ä½“æ¥è¯´ï¼ŒSurfaceFlingerä½œä¸ºç³»ç»Ÿçš„æ˜¾ç¤ºå¼•æ“ï¼Œè´Ÿè´£æ¥æ”¶å„åº”ç”¨ç¨‹åºå‘æ¥çš„å›¾åƒæ•°æ®ï¼Œå¹¶ç»„åˆæˆä¸€å¼ å®Œæ•´çš„ç”»é¢ï¼Œå¹¶è¾“å‡ºåˆ°æ˜¾ç¤ºå±ä¸Šã€‚SurfaceFlingeré€šè¿‡é‡ç»˜æ•´ä¸ªå±å¹•æˆ–éƒ¨åˆ†å±å¹•æ¥æ›´æ–°UIç•Œé¢ã€‚å®ƒè¿˜æä¾›äº†å¤šç§ç¡¬ä»¶åŠ é€ŸæŠ€æœ¯ï¼Œå¦‚OpenGL ESã€Vulkanç­‰ï¼Œä½¿åº”ç”¨ç¨‹åºèƒ½å¤Ÿæ›´å¿«åœ°æ¸²æŸ“UIç•Œé¢ã€‚ SurfaceFlingerè¿˜æ”¯æŒçª—å£å åŠ ã€é€æ˜åº¦ã€æ··åˆæ¨¡å¼ç­‰ç‰¹æ€§ï¼Œä»¥æ”¯æŒå¤æ‚çš„å¤šå±‚UIç•Œé¢ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜èƒ½ç®¡ç†æ‰€æœ‰Surfaceå¯¹è±¡ï¼ˆå¦‚è§†é¢‘ã€å›¾ç‰‡ç­‰ï¼‰ï¼Œå¹¶ä¸ºæ¯ä¸ªSurfaceå¯¹è±¡åˆ†é…ä¸€ä¸ªBufferQueueï¼ˆç¼“å†²åŒºé˜Ÿåˆ—ï¼‰ï¼Œç¡®ä¿æ¯ä¸ªSurfaceéƒ½èƒ½æŒ‰æ—¶å®Œæˆæ˜¾ç¤ºã€‚ SurfaceFlingerå¯åŠ¨æµç¨‹ï¼š SurfaceFlingeré€æ˜¾çš„æµç¨‹ï¼š ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#ä¸€surfaceflingerä»‹ç»"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"äºŒã€Surfaceçš„æ¸²æŸ“ Androidç³»ç»Ÿçš„UIä»ç»˜åˆ¶åˆ°æ˜¾ç¤ºåœ¨å±å¹•ä¸Šå¯åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š 1ã€Android Appè¿›ç¨‹ï¼šå°†UIç»˜åˆ¶åˆ°ä¸€ä¸ªå›¾å½¢ç¼“å†²åŒºGraphicBufferä¸­ï¼Œç„¶åé€šçŸ¥SurfaceFlingerè¿›è¡Œåˆæˆã€‚ 2ã€SurfaceFlingerè¿›ç¨‹ï¼šå°†GraphicBufferæ•°æ®åˆæˆå¹¶äº¤ç»™å±å¹•ç¼“å†²åŒºå»æ˜¾ç¤ºï¼Œè¿™ä¸€æ­¥æœ¬èº«å°±æ˜¯é€šè¿‡è½¯ä»¶ï¼ˆSkiaï¼‰å’Œç¡¬ä»¶ï¼ˆOpen GLå’Œ HardWare Composerï¼‰å»å®Œæˆçš„ã€‚ è½¯ä»¶æ¸²æŸ“ä»‹ç» å½“Appæ›´æ–°éƒ¨åˆ†UIæ—¶ï¼ŒCPUä¼šéå†ViewTreeè®¡ç®—å¤„éœ€è¦é‡ç»˜çš„èµƒåŒºï¼Œæ¥ç€åœ¨Viewå±‚æ¬¡ç»“æ„ä¸­ç»˜åˆ¶æ‰€æœ‰è·Ÿè„åŒºç›¸äº¤çš„åŒºåŸŸï¼Œå› æ­¤è½¯ä»¶ç»˜åˆ¶ä¼šç»˜åˆ¶åˆ°ä¸éœ€è¦é‡ç»˜çš„è§†å›¾ã€‚ è½¯ä»¶ç»˜åˆ¶çš„ç»˜åˆ¶è¿‡ç¨‹æ˜¯åœ¨ä¸»çº¿ç¨‹è¿›è¡Œçš„ï¼Œå¯èƒ½ä¼šé€ æˆå¡é¡¿ç­‰æƒ…å†µã€‚ è½¯ä»¶ç»˜åˆ¶æŠŠè¦ç»˜åˆ¶çš„å†…å®¹å†™è¿›ä¸€ä¸ªBitmapä½å›¾ï¼Œåœ¨ä¹‹åçš„æ¸²æŸ“è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ªBitmapçš„åƒç´ å†…å®¹ä¼šå¡«å……åˆ°Surfaceçš„ç¼“å†²åŒºé‡Œã€‚ è½¯ä»¶ç»˜åˆ¶ä½¿ç”¨Skiaåº“ï¼ŒSkiaæ˜¯Googleå¼€å‘çš„ä¸€ä¸ªè·¨å¹³å°çš„2Då›¾å½¢åº“ï¼Œå®ƒæä¾›äº†ä¸€ç»„å¼ºå¤§çš„APIï¼Œå¯ä»¥å®ç°é«˜è´¨é‡çš„2Då›¾å½¢æ¸²æŸ“ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè½¯ä»¶æ¸²æŸ“çš„æ€§èƒ½ç›¸å¯¹è¾ƒä½ï¼Œè€Œä¸”å¯èƒ½ä¼šå› ä¸ºå¤§é‡çš„å›¾åƒè®¡ç®—è€Œå ç”¨å¤§é‡CPUèµ„æºï¼Œå¯¼è‡´åº”ç”¨ç¨‹åºçš„è¿è¡Œé€Ÿåº¦å˜æ…¢ã€‚ å¦‚ä¸‹ä¸ºè½¯ä»¶æ¸²æŸ“æµç¨‹ï¼š 1ã€æ„å»ºè§†å›¾æ ‘ï¼šAndroidåº”ç”¨ç¨‹åºä¸­çš„UIç”±è§†å›¾æ ‘æ¥ç»„ç»‡çš„ï¼Œé¦–å…ˆéœ€è¦æ„å»ºè§†å›¾æ ‘ã€‚ 2ã€è®¡ç®—å¸ƒå±€ï¼šåœ¨è·å¾—è§†å›¾æ ‘ä¹‹åï¼Œç³»ç»Ÿéœ€è¦è®¡ç®—æ¯ä¸ªè§†å›¾çš„å¤§å°å’Œä½ç½®ï¼Œå¹¶å°†å®ƒä»¬æ”¾ç½®åœ¨æ­£ç¡®çš„ä½ç½®ä¸Šï¼Œä»¥å®Œæˆå¸ƒå±€ã€‚ 3ã€ç»˜åˆ¶è§†å›¾ï¼šæ¥ä¸‹æ¥ï¼Œç³»ç»Ÿå°†å¼€å§‹ä½¿ç”¨è½¯ä»¶æ¸²æŸ“å¼•æ“(Skia)ï¼Œå¯¹æ¯ä¸€ä¸ªè§†å›¾è¿›è¡Œä¸»æ„ç»˜åˆ¶ï¼Œå³ä½¿ç”¨CPUæ‰§è¡Œå›¾åƒè®¡ç®—å¹¶å°†å›¾åƒæ¸²æŸ“åˆ°GraphicBufferä¸Šã€‚ 4ã€åˆæˆå›¾åƒï¼šå½“æ‰€æœ‰çš„è§†å›¾éƒ½ç»˜åˆ¶å®Œæˆåï¼ŒSurfaceFlingerä¼šå°†å®ƒä»¬åˆæˆåœ¨ä¸€èµ·ï¼Œç”Ÿæˆæœ€ç»ˆå±å¹•å›¾åƒï¼Œå¹¶å°†å…¶æ”¾åˆ°ä¸»æ˜¾ç¤ºç¼“å†²åŒºä¸­ã€‚ ç¡¬ä»¶æ¸²æŸ“ä»‹ç» å½“Appæ›´æ–°éƒ¨åˆ†UIæ—¶ï¼ŒCPUä¼šè®¡ç®—å‡ºè„åŒºï¼Œä½†æ˜¯ä¸ä¼šç«‹å³æ‰§è¡Œç»˜åˆ¶å‘½ä»¤ï¼Œè€Œæ˜¯å°†darwXXXå‡½æ•°ä½œä¸ºç»˜åˆ¶æŒ‡ä»¤(DrawOp)è®°å½•åœ¨ä¸€ä¸ªåˆ—è¡¨(DisplayListä¸­)ï¼Œç„¶åäº¤ç»™å•ç‹¬çš„Renderçº¿ç¨‹ä½¿ç”¨GPUè¿›è¡Œç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“ã€‚ åªéœ€è¦é’ˆå¯¹éœ€è¦æ›´æ–°çš„Viewå¯¹è±¡çš„è„åŒºè¿›è¡Œè®°å½•æˆ–æ›´æ–°ï¼Œæ— éœ€æ›´æ–°çš„Viewå¯¹è±¡åˆ™èƒ½é‡ç”¨å…ˆå‰DisplayListä¸­è®°å½•çš„æŒ‡ä»¤ã€‚ ç¡¬ä»¶åŠ é€Ÿæ˜¯åœ¨å•ç‹¬çš„Renderçº¿ç¨‹ä¸­ç»˜åˆ¶çš„ï¼Œåˆ†æ‹…äº†ä¸»çº¿ç¨‹çš„å‹åŠ›ï¼Œæé«˜äº†å“åº”é€Ÿåº¦ã€‚ ç¡¬ä»¶ç»˜åˆ¶ä½¿ç”¨OpenGLåœ¨GPUä¸Šå®Œæˆï¼ŒOpenGLæ˜¯è·¨å¹³å°çš„å›¾å½¢APIï¼Œä¸º2D/3Då›¾å½¢å¤„ç†ç¡¬ä»¶åˆ¶å®šäº†æ ‡å¿—çš„è½¯ä»¶æ¥å£ã€‚ å¦‚ä¸‹ä¸ºç¡¬ä»¶æ¸²æŸ“çš„æµç¨‹ï¼š 1ã€æ„å»ºè§†å›¾æ ‘ï¼šä¸è½¯ä»¶æ¸²æŸ“ä¸€æ ·ï¼Œç¡¬ä»¶æ¸²æŸ“ä¹Ÿéœ€è¦æ„å»ºåº”ç”¨ç¨‹åºçš„è§†å›¾æ ‘ã€‚ 2ã€è®¡ç®—å¸ƒå±€ï¼šä¸è½¯ä»¶æ¸²æŸ“ä¸€æ ·ï¼Œç¡¬ä»¶æ¸²æŸ“ä¹Ÿéœ€è¦å¯¹æ¯ä¸ªè§†å›¾è®¡ç®—å¸ƒå±€ã€‚ 3ã€åˆ›å»ºOpenGLçš„æ¸²æŸ“ä¸Šä¸‹æ–‡å’Œçº¹ç†ï¼šAndroidä½¿ç”¨OpenGL ESä½œä¸ºç¡¬ä»¶åŠ é€Ÿçš„æ¸²æŸ“å¼•æ“ã€‚å› æ­¤ï¼Œå½“ç¡¬ä»¶åŠ é€Ÿè¢«å¼€å¯æ—¶ï¼Œç³»ç»Ÿä¼šåˆ›å»ºOpenGLçš„æ¸²æŸ“ä¸Šä¸‹æ–‡ï¼ŒåŒæ—¶ä¸ºæ¯ä¸ªè§†å›¾åˆ†é…ä¸€ä¸ªæ¸²æŸ“çº¹ç†ã€‚ 4ã€ä¸Šä¼ çº¹ç†æ•°æ®ï¼šåœ¨è®¡ç®—å¥½è§†å›¾çš„å¸ƒå±€ä¹‹åï¼Œç³»ç»Ÿå°†è§†å›¾çš„å›¾åƒæ•°æ®ä¸Šä¼ åˆ°æ¸²æŸ“çº¹ç†ä¸­ã€‚è¿™é€šå¸¸ç”±GPUå®Œæˆã€‚ 5ã€ç»˜åˆ¶çº¹ç†ï¼šæœ€åï¼Œç³»ç»Ÿå°†è§†å›¾çš„æ¸²æŸ“çº¹ç†ç»‘å®šåˆ°OpenGLçš„æ¸²æŸ“ä¸Šä¸‹æ–‡ä¸­ï¼Œå¹¶æ‰§è¡ŒGPUè®¡ç®—ï¼Œå³ä½¿ç”¨GPUç»˜åˆ¶å›¾åƒã€‚ 6ã€åˆæˆå›¾åƒï¼šå½“æ‰€æœ‰çš„è§†å›¾éƒ½ç»˜åˆ¶å®Œæˆåï¼ŒSurfaceFlingerä¼šå°†å®ƒä»¬åˆæˆåœ¨ä¸€èµ·ï¼Œç”Ÿæˆæœ€ç»ˆå±å¹•å›¾åƒï¼Œå¹¶å°†å…¶æ”¾åˆ°ä¸»æ˜¾ç¤ºç¼“å†²åŒºä¸­ã€‚ Androidåœ¨ä»€ä¹ˆæ—¶å€™ä½¿ç”¨è½¯ä»¶æ¸²æŸ“ã€ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ç¡¬ä»¶æ¸²æŸ“ï¼Ÿ åœ¨Androidç³»ç»Ÿä¸­ï¼Œè½¯ä»¶æ¸²æŸ“å’Œç¡¬ä»¶æ¸²æŸ“æ˜¯æ ¹æ®åº”ç”¨ç¨‹åºçš„éœ€æ±‚å’Œè®¾å¤‡çš„æ€§èƒ½å†³å®šçš„çš„ã€‚é€šå¸¸æƒ…å†µï¼Œç³»ç»Ÿä¼šä¼˜å…ˆä½¿ç”¨ç¡¬ä»¶æ¸²æŸ“æ¥æé«˜å›¾å½¢çš„é€Ÿåº¦å’Œæ•ˆç‡ã€‚å¦‚æœç³»ç»Ÿæ£€æµ‹åˆ°è®¾å¤‡çš„GPUä¸æ”¯æŒæŸç§ç‰¹å®šçš„å›¾åƒç‰¹æ•ˆæˆ–åŠŸèƒ½ï¼Œæˆ–åœ¨ç¡¬ä»¶æ¸²æŸ“çš„è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼Œé‚£ä¹ˆç³»ç»Ÿå°†é€€å›åˆ°è½¯ä»¶æ¸²æŸ“ã€‚ä¸‹åˆ—æƒ…å†µå¯èƒ½è§¦å‘ç³»ç»Ÿä½¿ç”¨è½¯ä»¶æ¸²æŸ“ï¼š 1ã€è®¾å¤‡çš„GPUä¸æ”¯æŒå½“å‰åº”ç”¨ç¨‹åºçš„æŸäº›ç‰¹æ€§æˆ–å›¾åƒæ ¼å¼ã€‚ 2ã€å½“å‰åº”ç”¨ç¨‹åºéœ€è¦åœ¨å±å¹•ä¸Šå åŠ å¤šä¸ªå›¾åƒå±‚ï¼Œè€ŒGPUèƒ½åŠ›ä¸è¶³ä»¥å¤„ç†æ‰€æœ‰çš„å±‚çº§å åŠ ã€‚ 3ã€åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿå¯èƒ½ä¼šå¯¼è‡´åº”ç”¨ç¨‹åºå‡ºç°æ€§èƒ½é—®é¢˜ï¼Œæ­¤æ—¶ç³»ç»Ÿå¯èƒ½ä¼šåˆ‡æ¢åˆ°ä½¿ç”¨è½¯ä»¶æ¸²æŸ“ã€‚ SurfaceFlingerçš„åŒç¼“å†²ä¸VSYNCæœºåˆ¶ ç¼“å†²æœºåˆ¶ä»‹ç» æ˜¾ç¤ºç¼“å†²æœºåˆ¶æ˜¯æŒ‡å®šåœ¨è®¡ç®—æœºç³»ç»Ÿä¸­ï¼Œå°†æ˜¾ç¤ºæ•°æ®ç¼“å­˜åˆ°åˆ°å†…å­˜ä¸­ä»¥æé«˜å¤„ç†é€Ÿåº¦çš„ä¸€ç§è®¡ç®—ï¼Œåœ¨å›¾å½¢å’Œå›¾åƒå¤„ç†ä¸­ï¼Œæ˜¾ç¤ºç¼“å†²æœºåˆ¶å¯ä»¥æå‡å›¾åƒã€å›¾å½¢çš„æ¸²æŸ“æ•ˆç‡å’Œè´¨é‡ã€‚ åœ¨æ—©æœŸçš„Androidç‰ˆæœ¬ä¸­ï¼ŒSurfaceFlingerä½¿ç”¨çš„æ˜¯ä¸‰é‡ç¼“å†²åŒºæœºåˆ¶ï¼Œå³å‰å°ã€åå°å’Œæ˜¾ç¤ºä¸‰ä¸ªç¼“å†²åŒºã€‚ä»Android8.0å¼€å§‹ï¼ŒSurfaceFlingerè¯¥ä¸ºé‡‡ç”¨åŒç¼“å†²åŒºæœºåˆ¶ï¼Œåªæœ‰å‰å°å’Œåå°ä¸¤ä¸ªç¼“å†²åŒºã€‚é‡‡ç”¨ä¸‰é‡ç¼“å†²åŒºæœºåˆ¶çš„ä¼˜ç‚¹åœ¨äºå¯ä»¥å‡å°‘å±å¹•æ’•è£‚ç°è±¡çš„äº§ç”Ÿï¼Œæé«˜æ˜¾ç¤ºç”»é¢çš„è¿è´¯æ€§ã€‚ä½†åŒæ—¶å¢åŠ äº†å†…å­˜å ç”¨ï¼Œå› æ­¤åœ¨Android8.0åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ï¼Œä¸ºäº†æé«˜æ€§èƒ½å’Œå‡å°‘å†…å­˜å ç”¨ï¼ŒSurfaceFlingeræ”¹ä¸ºé‡‡ç”¨åŒç¼“å†²åŒºæœºåˆ¶ã€‚ åŒç¼“å†²åŒºæœºåˆ¶ä¸‹ï¼Œå‰å°ç¼“å†²åŒºç”¨äºæ˜¾ç¤ºå½“å‰å¸§çš„å†…å®¹ï¼Œåå°ç¼“å†²åŒºç”¨äºç»˜åˆ¶ä¸‹ä¸€å¸§çš„å†…å®¹ã€‚å½“ç»˜åˆ¶ä¸‹ä¸€å¸§å®Œæˆåï¼ŒSurfaceFlingerä¼šå°†åå°ç¼“å†²åŒºçš„å†…å®¹äº¤æ¢åˆ°å‰å°ç¼“å†²åŒºï¼Œä»è€Œå®ç°å¸§ä¸å¸§ä¹‹é—´çš„åˆ‡æ¢ã€‚è¿™ç§æœºåˆ¶å¯ä»¥å‡å°‘ä¸€æ¬¡ç¼“å†²åŒºçš„åˆ›å»ºåŠé”€æ¯æ“ä½œï¼Œä»¥æé«˜æ€§èƒ½å’Œè§£çº¦å†…å­˜ã€‚ ä¸‰é‡ç¼“å­˜æœºåˆ¶æ˜¯Androidä¸­çš„ä¸€ç§ä¼˜åŒ–æŠ€æœ¯ï¼Œç”¨äºæé«˜ç»˜åˆ¶æ€§èƒ½ã€‚å®ƒåŒ…æ‹¬å‰ç¼“å†²åŒºï¼ˆFront Bufferï¼‰ã€åç¼“å†²åŒºï¼ˆBack Bufferï¼‰å’Œæ˜¾ç¤ºç¼“å†²åŒºï¼ˆDisplay Bufferï¼‰ã€‚å‰ç¼“å†²åŒºç”¨äºæ˜¾ç¤ºå½“å‰å¸§ï¼Œåç¼“å†²åŒºç”¨äºç»˜åˆ¶ä¸‹ä¸€å¸§ï¼Œè€Œæ˜¾ç¤ºç¼“å†²åŒºåˆ™ç”¨äºå°†å‰ç¼“å†²åŒºçš„å†…å®¹æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚å½“VSYNCä¿¡å·åˆ°è¾¾æ—¶ï¼Œå‰ç¼“å†²åŒºå’Œåç¼“å†²åŒºä¼šè¿›è¡Œäº¤æ¢ï¼Œä»è€Œå®ç°æµç•…çš„æ˜¾ç¤ºæ•ˆæœã€‚ VSYNCæœºåˆ¶ä»‹ç» åœ¨å›¾å½¢å’Œå›¾åƒæ˜¾ç¤ºä¸­ï¼ŒVSYNCæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œå®ƒæ˜¯æŒ‡å‚ç›´åŒæ­¥ä¿¡å·ï¼Œç”¨äºæ§åˆ¶æ˜¾ç¤ºå™¨åˆ·æ–°ç‡å’Œæ˜¾ç¤ºæ—¶åºã€‚åœ¨Androidç³»ç»Ÿä¸­ï¼ŒVSYNCæœºåˆ¶è¢«å¹¿æ³›åº”ç”¨äºæ§åˆ¶å±å¹•æ˜¾ç¤ºå’ŒåŠ¨ç”»æ¸²æŸ“ï¼Œä»¥æé«˜æ˜¾ç¤ºæ•ˆæœå’Œæ€§èƒ½ã€‚ åœ¨Androidä¸­ï¼Œæ¯å°è®¾å¤‡éƒ½æœ‰ä¸€ä¸ªç¡¬ä»¶VSYNCä¿¡å·å‘ç”Ÿå™¨ï¼Œç”¨äºç”Ÿæˆæ’å®šçš„åˆ·æ–°ç‡ä¿¡å·ã€‚é€šå¸¸æƒ…å†µä¸‹è¿™ä¸ªä¿¡å·çš„åˆ·æ–°ç‡ä¸º60Hzæˆ–90Hzï¼ŒAndroidæ˜¾ç¤ºæ¡†æ¶å¯ä»¥æ ¹æ®è¿™ä¸ªä¿¡å·æ¥è°ƒæ•´è‡ªå·±çš„æ˜¾ç¤ºå’Œæ¸²æŸ“é€Ÿåº¦ã€‚åœ¨SurfaceFlingerçš„ç”Ÿæˆè€…æ¶ˆè´¹è€…æ¨¡å‹ä¸­ï¼Œå½“ç¡¬ä»¶VSYNCä¿¡å·å‘ç”Ÿæ—¶ï¼ŒSurfaceFlingerä¼šå¼€å§‹è¯»å–ç¼“å†²åŒºä¸­çš„æ•°æ®ï¼Œå¹¶å°†å…¶æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚å› æ­¤ï¼Œå¦‚æœAndroidæ˜¾ç¤ºæ¡†æ¶åœ¨VSYNCå‰å®Œæˆäº†æ•°æ®å¤„ç†å’Œç»˜åˆ¶ï¼Œåˆ™å¯ä»¥å®ç°é›¶å»¶è¿Ÿçš„å›¾åƒæˆ–åŠ¨ç”»æ¸²æŸ“ã€‚ VSYNCæœºåˆ¶çš„ä¸»è¦ä¼˜ç‚¹æ˜¯å¯ä»¥é¿å…åœ¨å›¾åƒæ¸²æŸ“è¿‡ç¨‹ä¸­å‡ºç°å±å¹•æ’•è£‚å’Œå¡é¡¿ç°è±¡ï¼ŒåŒæ—¶ï¼Œä½¿ç”¨ç¡¬ä»¶ä¿¡å·ï¼Œå¯ä»¥ä½¿å›¾å½¢å’Œå›¾åƒå¤„ç†ä¸æ˜¾ç¤ºä¿æŒåŒæ­¥ï¼Œæé«˜æ˜¾ç¤ºæ•ˆæœå’Œæ¸²æŸ“æ€§èƒ½ã€‚ ç”±äºå›¾åƒç»˜åˆ¶å’Œå±å¹•è¯»å– ä½¿ç”¨çš„æ˜¯åŒä¸ªbufferï¼Œæ‰€ä»¥å±å¹•åˆ·æ–°æ—¶å¯èƒ½è¯»å–åˆ°çš„æ˜¯ä¸å®Œæ•´çš„ä¸€å¸§ç”»é¢ã€‚åŒç¼“å­˜ï¼Œè®©ç»˜åˆ¶å’Œæ˜¾ç¤ºå™¨æ‹¥æœ‰å„è‡ªçš„bufferï¼šGPU å§‹ç»ˆå°†å®Œæˆçš„ä¸€å¸§å›¾åƒæ•°æ®å†™å…¥åˆ° Back Bufferï¼Œè€Œæ˜¾ç¤ºå™¨ä½¿ç”¨ Frame Bufferï¼Œå½“å±å¹•åˆ·æ–°æ—¶ï¼ŒFrame Buffer å¹¶ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå½“Back bufferå‡†å¤‡å°±ç»ªåï¼Œå®ƒä»¬æ‰è¿›è¡Œäº¤æ¢ã€‚ ä»€ä¹ˆæ—¶å€™è¿›è¡Œä¸¤ä¸ªbufferçš„äº¤æ¢å‘¢ï¼Ÿ å½“æ‰«æå®Œä¸€å¸§ç”»é¢åï¼Œè®¾å¤‡éœ€è¦é‡æ–°å›åˆ°ç¬¬ä¸€è¡Œä»¥è¿›å…¥ä¸‹ä¸€æ¬¡çš„å¾ªç¯ï¼Œæ­¤æ—¶æœ‰ä¸€æ®µæ—¶é—´ç©ºéš™ï¼Œç§°ä¸ºVerticalBlanking Interval(VBI)ã€‚é‚£ï¼Œè¿™ä¸ªæ—¶é—´ç‚¹å°±æ˜¯æˆ‘ä»¬è¿›è¡Œç¼“å†²åŒºäº¤æ¢çš„æœ€ä½³æ—¶é—´ã€‚å› ä¸ºæ­¤æ—¶å±å¹•æ²¡æœ‰åœ¨åˆ·æ–°ï¼Œä¹Ÿå°±é¿å…äº†äº¤æ¢è¿‡ç¨‹ä¸­å‡ºç° screen tearingçš„çŠ¶å†µã€‚ VSYNC ä¿¡å·æ˜¯ç”±å±å¹•ï¼ˆæ˜¾ç¤ºè®¾å¤‡ï¼‰äº§ç”Ÿçš„ï¼Œåˆ©ç”¨VBIæ—¶æœŸå‡ºç°çš„vertical sync pulseï¼ˆå‚ç›´åŒæ­¥è„‰å†²ï¼‰æ¥ä¿è¯åŒç¼“å†²åœ¨æœ€ä½³æ—¶é—´ç‚¹æ‰è¿›è¡Œäº¤æ¢ã€‚å¹¶ä¸”ä»¥ 60fps çš„å›ºå®šé¢‘ç‡å‘é€ç»™ Android ç³»ç»Ÿï¼ŒAndroid ç³»ç»Ÿä¸­çš„ SurfaceFlinger æ¥æ”¶å‘é€çš„ VSYNC ä¿¡å·ã€‚VSYNC ä¿¡å·è¡¨æ˜å¯å¯¹å±å¹•è¿›è¡Œåˆ·æ–°è€Œä¸ä¼šäº§ç”Ÿæ’•è£‚ã€‚å¦å¤–ï¼Œäº¤æ¢æ˜¯æŒ‡å„è‡ªçš„å†…å­˜åœ°å€ï¼Œå¯ä»¥è®¤ä¸ºè¯¥æ“ä½œæ˜¯ç¬é—´å®Œæˆã€‚ Android 4.4ä¸Šåˆå¼•å…¥äº†Vsyncè™šæ‹ŸåŒ–ï¼Œé€šè¿‡DispSyncThreadæŠŠVsyncè™šæ‹ŸåŒ–æˆVsync-appå’ŒVsync-sfï¼ŒVsync-appå’ŒVsync-sfç›´æ¥æœ‰å›ºå®šçš„æ—¶æœºåç§»ï¼Œå„è‡ªåˆ†åˆ«æŒæ§ç€Appå’ŒSurfaceFlingerçš„å·¥ä½œèŠ‚å¥ï¼Œä»–ä»¬ä¸€å‰ä¸€åä¿æŒç€ç»˜åˆ¶ä»»åŠ¡çš„æµæ°´èŠ‚å¥ã€‚ CPU/GPUæ ¹æ®VSYNCä¿¡å·åŒæ­¥å¤„ç†æ•°æ®ï¼Œå¯ä»¥è®©CPU/GPUæœ‰å®Œæ•´çš„16msæ—¶é—´æ¥å¤„ç†æ•°æ®ï¼Œå‡å°‘äº†jankï¼ˆä¸¢å¸§ï¼‰ã€‚ ä¸€å¥è¯æ€»ç»“ï¼ŒVSyncåŒæ­¥ä½¿å¾—CPU/GPUå……åˆ†åˆ©ç”¨äº†16.6msæ—¶é—´ï¼Œå‡å°‘jankã€‚ åº”ç”¨åœ¨æ¯ä¸ªVsyncä¿¡å·åˆ°æ¥åéƒ½ä¼šé€šè¿‡dequeueBuffer/queueBufferæ¥ç”³è¯·bufferå’Œæäº¤ç»˜å›¾æ•°æ®ï¼ŒSurfaceflingeréƒ½ä¼šåœ¨ä¸‹ä¸€ä¸ªvsyncä¿¡å·åˆ°æ¥æ—¶å–èµ°bufferå»åšåˆæˆå’Œæ˜¾ç¤ºï¼Œ å¹¶åœ¨ä¸‹ä¸€ä¸‹ä¸ªvsyncæ—¶å°†bufferè¿˜å›æ¥ï¼Œå†æ¬¡å¾ªç¯ã€‚ ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#äºŒsurfaceçš„æ¸²æŸ“"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"äºŒã€Surfaceçš„æ¸²æŸ“ Androidç³»ç»Ÿçš„UIä»ç»˜åˆ¶åˆ°æ˜¾ç¤ºåœ¨å±å¹•ä¸Šå¯åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š 1ã€Android Appè¿›ç¨‹ï¼šå°†UIç»˜åˆ¶åˆ°ä¸€ä¸ªå›¾å½¢ç¼“å†²åŒºGraphicBufferä¸­ï¼Œç„¶åé€šçŸ¥SurfaceFlingerè¿›è¡Œåˆæˆã€‚ 2ã€SurfaceFlingerè¿›ç¨‹ï¼šå°†GraphicBufferæ•°æ®åˆæˆå¹¶äº¤ç»™å±å¹•ç¼“å†²åŒºå»æ˜¾ç¤ºï¼Œè¿™ä¸€æ­¥æœ¬èº«å°±æ˜¯é€šè¿‡è½¯ä»¶ï¼ˆSkiaï¼‰å’Œç¡¬ä»¶ï¼ˆOpen GLå’Œ HardWare Composerï¼‰å»å®Œæˆçš„ã€‚ è½¯ä»¶æ¸²æŸ“ä»‹ç» å½“Appæ›´æ–°éƒ¨åˆ†UIæ—¶ï¼ŒCPUä¼šéå†ViewTreeè®¡ç®—å¤„éœ€è¦é‡ç»˜çš„èµƒåŒºï¼Œæ¥ç€åœ¨Viewå±‚æ¬¡ç»“æ„ä¸­ç»˜åˆ¶æ‰€æœ‰è·Ÿè„åŒºç›¸äº¤çš„åŒºåŸŸï¼Œå› æ­¤è½¯ä»¶ç»˜åˆ¶ä¼šç»˜åˆ¶åˆ°ä¸éœ€è¦é‡ç»˜çš„è§†å›¾ã€‚ è½¯ä»¶ç»˜åˆ¶çš„ç»˜åˆ¶è¿‡ç¨‹æ˜¯åœ¨ä¸»çº¿ç¨‹è¿›è¡Œçš„ï¼Œå¯èƒ½ä¼šé€ æˆå¡é¡¿ç­‰æƒ…å†µã€‚ è½¯ä»¶ç»˜åˆ¶æŠŠè¦ç»˜åˆ¶çš„å†…å®¹å†™è¿›ä¸€ä¸ªBitmapä½å›¾ï¼Œåœ¨ä¹‹åçš„æ¸²æŸ“è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ªBitmapçš„åƒç´ å†…å®¹ä¼šå¡«å……åˆ°Surfaceçš„ç¼“å†²åŒºé‡Œã€‚ è½¯ä»¶ç»˜åˆ¶ä½¿ç”¨Skiaåº“ï¼ŒSkiaæ˜¯Googleå¼€å‘çš„ä¸€ä¸ªè·¨å¹³å°çš„2Då›¾å½¢åº“ï¼Œå®ƒæä¾›äº†ä¸€ç»„å¼ºå¤§çš„APIï¼Œå¯ä»¥å®ç°é«˜è´¨é‡çš„2Då›¾å½¢æ¸²æŸ“ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè½¯ä»¶æ¸²æŸ“çš„æ€§èƒ½ç›¸å¯¹è¾ƒä½ï¼Œè€Œä¸”å¯èƒ½ä¼šå› ä¸ºå¤§é‡çš„å›¾åƒè®¡ç®—è€Œå ç”¨å¤§é‡CPUèµ„æºï¼Œå¯¼è‡´åº”ç”¨ç¨‹åºçš„è¿è¡Œé€Ÿåº¦å˜æ…¢ã€‚ å¦‚ä¸‹ä¸ºè½¯ä»¶æ¸²æŸ“æµç¨‹ï¼š 1ã€æ„å»ºè§†å›¾æ ‘ï¼šAndroidåº”ç”¨ç¨‹åºä¸­çš„UIç”±è§†å›¾æ ‘æ¥ç»„ç»‡çš„ï¼Œé¦–å…ˆéœ€è¦æ„å»ºè§†å›¾æ ‘ã€‚ 2ã€è®¡ç®—å¸ƒå±€ï¼šåœ¨è·å¾—è§†å›¾æ ‘ä¹‹åï¼Œç³»ç»Ÿéœ€è¦è®¡ç®—æ¯ä¸ªè§†å›¾çš„å¤§å°å’Œä½ç½®ï¼Œå¹¶å°†å®ƒä»¬æ”¾ç½®åœ¨æ­£ç¡®çš„ä½ç½®ä¸Šï¼Œä»¥å®Œæˆå¸ƒå±€ã€‚ 3ã€ç»˜åˆ¶è§†å›¾ï¼šæ¥ä¸‹æ¥ï¼Œç³»ç»Ÿå°†å¼€å§‹ä½¿ç”¨è½¯ä»¶æ¸²æŸ“å¼•æ“(Skia)ï¼Œå¯¹æ¯ä¸€ä¸ªè§†å›¾è¿›è¡Œä¸»æ„ç»˜åˆ¶ï¼Œå³ä½¿ç”¨CPUæ‰§è¡Œå›¾åƒè®¡ç®—å¹¶å°†å›¾åƒæ¸²æŸ“åˆ°GraphicBufferä¸Šã€‚ 4ã€åˆæˆå›¾åƒï¼šå½“æ‰€æœ‰çš„è§†å›¾éƒ½ç»˜åˆ¶å®Œæˆåï¼ŒSurfaceFlingerä¼šå°†å®ƒä»¬åˆæˆåœ¨ä¸€èµ·ï¼Œç”Ÿæˆæœ€ç»ˆå±å¹•å›¾åƒï¼Œå¹¶å°†å…¶æ”¾åˆ°ä¸»æ˜¾ç¤ºç¼“å†²åŒºä¸­ã€‚ ç¡¬ä»¶æ¸²æŸ“ä»‹ç» å½“Appæ›´æ–°éƒ¨åˆ†UIæ—¶ï¼ŒCPUä¼šè®¡ç®—å‡ºè„åŒºï¼Œä½†æ˜¯ä¸ä¼šç«‹å³æ‰§è¡Œç»˜åˆ¶å‘½ä»¤ï¼Œè€Œæ˜¯å°†darwXXXå‡½æ•°ä½œä¸ºç»˜åˆ¶æŒ‡ä»¤(DrawOp)è®°å½•åœ¨ä¸€ä¸ªåˆ—è¡¨(DisplayListä¸­)ï¼Œç„¶åäº¤ç»™å•ç‹¬çš„Renderçº¿ç¨‹ä½¿ç”¨GPUè¿›è¡Œç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“ã€‚ åªéœ€è¦é’ˆå¯¹éœ€è¦æ›´æ–°çš„Viewå¯¹è±¡çš„è„åŒºè¿›è¡Œè®°å½•æˆ–æ›´æ–°ï¼Œæ— éœ€æ›´æ–°çš„Viewå¯¹è±¡åˆ™èƒ½é‡ç”¨å…ˆå‰DisplayListä¸­è®°å½•çš„æŒ‡ä»¤ã€‚ ç¡¬ä»¶åŠ é€Ÿæ˜¯åœ¨å•ç‹¬çš„Renderçº¿ç¨‹ä¸­ç»˜åˆ¶çš„ï¼Œåˆ†æ‹…äº†ä¸»çº¿ç¨‹çš„å‹åŠ›ï¼Œæé«˜äº†å“åº”é€Ÿåº¦ã€‚ ç¡¬ä»¶ç»˜åˆ¶ä½¿ç”¨OpenGLåœ¨GPUä¸Šå®Œæˆï¼ŒOpenGLæ˜¯è·¨å¹³å°çš„å›¾å½¢APIï¼Œä¸º2D/3Då›¾å½¢å¤„ç†ç¡¬ä»¶åˆ¶å®šäº†æ ‡å¿—çš„è½¯ä»¶æ¥å£ã€‚ å¦‚ä¸‹ä¸ºç¡¬ä»¶æ¸²æŸ“çš„æµç¨‹ï¼š 1ã€æ„å»ºè§†å›¾æ ‘ï¼šä¸è½¯ä»¶æ¸²æŸ“ä¸€æ ·ï¼Œç¡¬ä»¶æ¸²æŸ“ä¹Ÿéœ€è¦æ„å»ºåº”ç”¨ç¨‹åºçš„è§†å›¾æ ‘ã€‚ 2ã€è®¡ç®—å¸ƒå±€ï¼šä¸è½¯ä»¶æ¸²æŸ“ä¸€æ ·ï¼Œç¡¬ä»¶æ¸²æŸ“ä¹Ÿéœ€è¦å¯¹æ¯ä¸ªè§†å›¾è®¡ç®—å¸ƒå±€ã€‚ 3ã€åˆ›å»ºOpenGLçš„æ¸²æŸ“ä¸Šä¸‹æ–‡å’Œçº¹ç†ï¼šAndroidä½¿ç”¨OpenGL ESä½œä¸ºç¡¬ä»¶åŠ é€Ÿçš„æ¸²æŸ“å¼•æ“ã€‚å› æ­¤ï¼Œå½“ç¡¬ä»¶åŠ é€Ÿè¢«å¼€å¯æ—¶ï¼Œç³»ç»Ÿä¼šåˆ›å»ºOpenGLçš„æ¸²æŸ“ä¸Šä¸‹æ–‡ï¼ŒåŒæ—¶ä¸ºæ¯ä¸ªè§†å›¾åˆ†é…ä¸€ä¸ªæ¸²æŸ“çº¹ç†ã€‚ 4ã€ä¸Šä¼ çº¹ç†æ•°æ®ï¼šåœ¨è®¡ç®—å¥½è§†å›¾çš„å¸ƒå±€ä¹‹åï¼Œç³»ç»Ÿå°†è§†å›¾çš„å›¾åƒæ•°æ®ä¸Šä¼ åˆ°æ¸²æŸ“çº¹ç†ä¸­ã€‚è¿™é€šå¸¸ç”±GPUå®Œæˆã€‚ 5ã€ç»˜åˆ¶çº¹ç†ï¼šæœ€åï¼Œç³»ç»Ÿå°†è§†å›¾çš„æ¸²æŸ“çº¹ç†ç»‘å®šåˆ°OpenGLçš„æ¸²æŸ“ä¸Šä¸‹æ–‡ä¸­ï¼Œå¹¶æ‰§è¡ŒGPUè®¡ç®—ï¼Œå³ä½¿ç”¨GPUç»˜åˆ¶å›¾åƒã€‚ 6ã€åˆæˆå›¾åƒï¼šå½“æ‰€æœ‰çš„è§†å›¾éƒ½ç»˜åˆ¶å®Œæˆåï¼ŒSurfaceFlingerä¼šå°†å®ƒä»¬åˆæˆåœ¨ä¸€èµ·ï¼Œç”Ÿæˆæœ€ç»ˆå±å¹•å›¾åƒï¼Œå¹¶å°†å…¶æ”¾åˆ°ä¸»æ˜¾ç¤ºç¼“å†²åŒºä¸­ã€‚ Androidåœ¨ä»€ä¹ˆæ—¶å€™ä½¿ç”¨è½¯ä»¶æ¸²æŸ“ã€ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ç¡¬ä»¶æ¸²æŸ“ï¼Ÿ åœ¨Androidç³»ç»Ÿä¸­ï¼Œè½¯ä»¶æ¸²æŸ“å’Œç¡¬ä»¶æ¸²æŸ“æ˜¯æ ¹æ®åº”ç”¨ç¨‹åºçš„éœ€æ±‚å’Œè®¾å¤‡çš„æ€§èƒ½å†³å®šçš„çš„ã€‚é€šå¸¸æƒ…å†µï¼Œç³»ç»Ÿä¼šä¼˜å…ˆä½¿ç”¨ç¡¬ä»¶æ¸²æŸ“æ¥æé«˜å›¾å½¢çš„é€Ÿåº¦å’Œæ•ˆç‡ã€‚å¦‚æœç³»ç»Ÿæ£€æµ‹åˆ°è®¾å¤‡çš„GPUä¸æ”¯æŒæŸç§ç‰¹å®šçš„å›¾åƒç‰¹æ•ˆæˆ–åŠŸèƒ½ï¼Œæˆ–åœ¨ç¡¬ä»¶æ¸²æŸ“çš„è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼Œé‚£ä¹ˆç³»ç»Ÿå°†é€€å›åˆ°è½¯ä»¶æ¸²æŸ“ã€‚ä¸‹åˆ—æƒ…å†µå¯èƒ½è§¦å‘ç³»ç»Ÿä½¿ç”¨è½¯ä»¶æ¸²æŸ“ï¼š 1ã€è®¾å¤‡çš„GPUä¸æ”¯æŒå½“å‰åº”ç”¨ç¨‹åºçš„æŸäº›ç‰¹æ€§æˆ–å›¾åƒæ ¼å¼ã€‚ 2ã€å½“å‰åº”ç”¨ç¨‹åºéœ€è¦åœ¨å±å¹•ä¸Šå åŠ å¤šä¸ªå›¾åƒå±‚ï¼Œè€ŒGPUèƒ½åŠ›ä¸è¶³ä»¥å¤„ç†æ‰€æœ‰çš„å±‚çº§å åŠ ã€‚ 3ã€åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿå¯èƒ½ä¼šå¯¼è‡´åº”ç”¨ç¨‹åºå‡ºç°æ€§èƒ½é—®é¢˜ï¼Œæ­¤æ—¶ç³»ç»Ÿå¯èƒ½ä¼šåˆ‡æ¢åˆ°ä½¿ç”¨è½¯ä»¶æ¸²æŸ“ã€‚ SurfaceFlingerçš„åŒç¼“å†²ä¸VSYNCæœºåˆ¶ ç¼“å†²æœºåˆ¶ä»‹ç» æ˜¾ç¤ºç¼“å†²æœºåˆ¶æ˜¯æŒ‡å®šåœ¨è®¡ç®—æœºç³»ç»Ÿä¸­ï¼Œå°†æ˜¾ç¤ºæ•°æ®ç¼“å­˜åˆ°åˆ°å†…å­˜ä¸­ä»¥æé«˜å¤„ç†é€Ÿåº¦çš„ä¸€ç§è®¡ç®—ï¼Œåœ¨å›¾å½¢å’Œå›¾åƒå¤„ç†ä¸­ï¼Œæ˜¾ç¤ºç¼“å†²æœºåˆ¶å¯ä»¥æå‡å›¾åƒã€å›¾å½¢çš„æ¸²æŸ“æ•ˆç‡å’Œè´¨é‡ã€‚ åœ¨æ—©æœŸçš„Androidç‰ˆæœ¬ä¸­ï¼ŒSurfaceFlingerä½¿ç”¨çš„æ˜¯ä¸‰é‡ç¼“å†²åŒºæœºåˆ¶ï¼Œå³å‰å°ã€åå°å’Œæ˜¾ç¤ºä¸‰ä¸ªç¼“å†²åŒºã€‚ä»Android8.0å¼€å§‹ï¼ŒSurfaceFlingerè¯¥ä¸ºé‡‡ç”¨åŒç¼“å†²åŒºæœºåˆ¶ï¼Œåªæœ‰å‰å°å’Œåå°ä¸¤ä¸ªç¼“å†²åŒºã€‚é‡‡ç”¨ä¸‰é‡ç¼“å†²åŒºæœºåˆ¶çš„ä¼˜ç‚¹åœ¨äºå¯ä»¥å‡å°‘å±å¹•æ’•è£‚ç°è±¡çš„äº§ç”Ÿï¼Œæé«˜æ˜¾ç¤ºç”»é¢çš„è¿è´¯æ€§ã€‚ä½†åŒæ—¶å¢åŠ äº†å†…å­˜å ç”¨ï¼Œå› æ­¤åœ¨Android8.0åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ï¼Œä¸ºäº†æé«˜æ€§èƒ½å’Œå‡å°‘å†…å­˜å ç”¨ï¼ŒSurfaceFlingeræ”¹ä¸ºé‡‡ç”¨åŒç¼“å†²åŒºæœºåˆ¶ã€‚ åŒç¼“å†²åŒºæœºåˆ¶ä¸‹ï¼Œå‰å°ç¼“å†²åŒºç”¨äºæ˜¾ç¤ºå½“å‰å¸§çš„å†…å®¹ï¼Œåå°ç¼“å†²åŒºç”¨äºç»˜åˆ¶ä¸‹ä¸€å¸§çš„å†…å®¹ã€‚å½“ç»˜åˆ¶ä¸‹ä¸€å¸§å®Œæˆåï¼ŒSurfaceFlingerä¼šå°†åå°ç¼“å†²åŒºçš„å†…å®¹äº¤æ¢åˆ°å‰å°ç¼“å†²åŒºï¼Œä»è€Œå®ç°å¸§ä¸å¸§ä¹‹é—´çš„åˆ‡æ¢ã€‚è¿™ç§æœºåˆ¶å¯ä»¥å‡å°‘ä¸€æ¬¡ç¼“å†²åŒºçš„åˆ›å»ºåŠé”€æ¯æ“ä½œï¼Œä»¥æé«˜æ€§èƒ½å’Œè§£çº¦å†…å­˜ã€‚ ä¸‰é‡ç¼“å­˜æœºåˆ¶æ˜¯Androidä¸­çš„ä¸€ç§ä¼˜åŒ–æŠ€æœ¯ï¼Œç”¨äºæé«˜ç»˜åˆ¶æ€§èƒ½ã€‚å®ƒåŒ…æ‹¬å‰ç¼“å†²åŒºï¼ˆFront Bufferï¼‰ã€åç¼“å†²åŒºï¼ˆBack Bufferï¼‰å’Œæ˜¾ç¤ºç¼“å†²åŒºï¼ˆDisplay Bufferï¼‰ã€‚å‰ç¼“å†²åŒºç”¨äºæ˜¾ç¤ºå½“å‰å¸§ï¼Œåç¼“å†²åŒºç”¨äºç»˜åˆ¶ä¸‹ä¸€å¸§ï¼Œè€Œæ˜¾ç¤ºç¼“å†²åŒºåˆ™ç”¨äºå°†å‰ç¼“å†²åŒºçš„å†…å®¹æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚å½“VSYNCä¿¡å·åˆ°è¾¾æ—¶ï¼Œå‰ç¼“å†²åŒºå’Œåç¼“å†²åŒºä¼šè¿›è¡Œäº¤æ¢ï¼Œä»è€Œå®ç°æµç•…çš„æ˜¾ç¤ºæ•ˆæœã€‚ VSYNCæœºåˆ¶ä»‹ç» åœ¨å›¾å½¢å’Œå›¾åƒæ˜¾ç¤ºä¸­ï¼ŒVSYNCæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œå®ƒæ˜¯æŒ‡å‚ç›´åŒæ­¥ä¿¡å·ï¼Œç”¨äºæ§åˆ¶æ˜¾ç¤ºå™¨åˆ·æ–°ç‡å’Œæ˜¾ç¤ºæ—¶åºã€‚åœ¨Androidç³»ç»Ÿä¸­ï¼ŒVSYNCæœºåˆ¶è¢«å¹¿æ³›åº”ç”¨äºæ§åˆ¶å±å¹•æ˜¾ç¤ºå’ŒåŠ¨ç”»æ¸²æŸ“ï¼Œä»¥æé«˜æ˜¾ç¤ºæ•ˆæœå’Œæ€§èƒ½ã€‚ åœ¨Androidä¸­ï¼Œæ¯å°è®¾å¤‡éƒ½æœ‰ä¸€ä¸ªç¡¬ä»¶VSYNCä¿¡å·å‘ç”Ÿå™¨ï¼Œç”¨äºç”Ÿæˆæ’å®šçš„åˆ·æ–°ç‡ä¿¡å·ã€‚é€šå¸¸æƒ…å†µä¸‹è¿™ä¸ªä¿¡å·çš„åˆ·æ–°ç‡ä¸º60Hzæˆ–90Hzï¼ŒAndroidæ˜¾ç¤ºæ¡†æ¶å¯ä»¥æ ¹æ®è¿™ä¸ªä¿¡å·æ¥è°ƒæ•´è‡ªå·±çš„æ˜¾ç¤ºå’Œæ¸²æŸ“é€Ÿåº¦ã€‚åœ¨SurfaceFlingerçš„ç”Ÿæˆè€…æ¶ˆè´¹è€…æ¨¡å‹ä¸­ï¼Œå½“ç¡¬ä»¶VSYNCä¿¡å·å‘ç”Ÿæ—¶ï¼ŒSurfaceFlingerä¼šå¼€å§‹è¯»å–ç¼“å†²åŒºä¸­çš„æ•°æ®ï¼Œå¹¶å°†å…¶æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚å› æ­¤ï¼Œå¦‚æœAndroidæ˜¾ç¤ºæ¡†æ¶åœ¨VSYNCå‰å®Œæˆäº†æ•°æ®å¤„ç†å’Œç»˜åˆ¶ï¼Œåˆ™å¯ä»¥å®ç°é›¶å»¶è¿Ÿçš„å›¾åƒæˆ–åŠ¨ç”»æ¸²æŸ“ã€‚ VSYNCæœºåˆ¶çš„ä¸»è¦ä¼˜ç‚¹æ˜¯å¯ä»¥é¿å…åœ¨å›¾åƒæ¸²æŸ“è¿‡ç¨‹ä¸­å‡ºç°å±å¹•æ’•è£‚å’Œå¡é¡¿ç°è±¡ï¼ŒåŒæ—¶ï¼Œä½¿ç”¨ç¡¬ä»¶ä¿¡å·ï¼Œå¯ä»¥ä½¿å›¾å½¢å’Œå›¾åƒå¤„ç†ä¸æ˜¾ç¤ºä¿æŒåŒæ­¥ï¼Œæé«˜æ˜¾ç¤ºæ•ˆæœå’Œæ¸²æŸ“æ€§èƒ½ã€‚ ç”±äºå›¾åƒç»˜åˆ¶å’Œå±å¹•è¯»å– ä½¿ç”¨çš„æ˜¯åŒä¸ªbufferï¼Œæ‰€ä»¥å±å¹•åˆ·æ–°æ—¶å¯èƒ½è¯»å–åˆ°çš„æ˜¯ä¸å®Œæ•´çš„ä¸€å¸§ç”»é¢ã€‚åŒç¼“å­˜ï¼Œè®©ç»˜åˆ¶å’Œæ˜¾ç¤ºå™¨æ‹¥æœ‰å„è‡ªçš„bufferï¼šGPU å§‹ç»ˆå°†å®Œæˆçš„ä¸€å¸§å›¾åƒæ•°æ®å†™å…¥åˆ° Back Bufferï¼Œè€Œæ˜¾ç¤ºå™¨ä½¿ç”¨ Frame Bufferï¼Œå½“å±å¹•åˆ·æ–°æ—¶ï¼ŒFrame Buffer å¹¶ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå½“Back bufferå‡†å¤‡å°±ç»ªåï¼Œå®ƒä»¬æ‰è¿›è¡Œäº¤æ¢ã€‚ ä»€ä¹ˆæ—¶å€™è¿›è¡Œä¸¤ä¸ªbufferçš„äº¤æ¢å‘¢ï¼Ÿ å½“æ‰«æå®Œä¸€å¸§ç”»é¢åï¼Œè®¾å¤‡éœ€è¦é‡æ–°å›åˆ°ç¬¬ä¸€è¡Œä»¥è¿›å…¥ä¸‹ä¸€æ¬¡çš„å¾ªç¯ï¼Œæ­¤æ—¶æœ‰ä¸€æ®µæ—¶é—´ç©ºéš™ï¼Œç§°ä¸ºVerticalBlanking Interval(VBI)ã€‚é‚£ï¼Œè¿™ä¸ªæ—¶é—´ç‚¹å°±æ˜¯æˆ‘ä»¬è¿›è¡Œç¼“å†²åŒºäº¤æ¢çš„æœ€ä½³æ—¶é—´ã€‚å› ä¸ºæ­¤æ—¶å±å¹•æ²¡æœ‰åœ¨åˆ·æ–°ï¼Œä¹Ÿå°±é¿å…äº†äº¤æ¢è¿‡ç¨‹ä¸­å‡ºç° screen tearingçš„çŠ¶å†µã€‚ VSYNC ä¿¡å·æ˜¯ç”±å±å¹•ï¼ˆæ˜¾ç¤ºè®¾å¤‡ï¼‰äº§ç”Ÿçš„ï¼Œåˆ©ç”¨VBIæ—¶æœŸå‡ºç°çš„vertical sync pulseï¼ˆå‚ç›´åŒæ­¥è„‰å†²ï¼‰æ¥ä¿è¯åŒç¼“å†²åœ¨æœ€ä½³æ—¶é—´ç‚¹æ‰è¿›è¡Œäº¤æ¢ã€‚å¹¶ä¸”ä»¥ 60fps çš„å›ºå®šé¢‘ç‡å‘é€ç»™ Android ç³»ç»Ÿï¼ŒAndroid ç³»ç»Ÿä¸­çš„ SurfaceFlinger æ¥æ”¶å‘é€çš„ VSYNC ä¿¡å·ã€‚VSYNC ä¿¡å·è¡¨æ˜å¯å¯¹å±å¹•è¿›è¡Œåˆ·æ–°è€Œä¸ä¼šäº§ç”Ÿæ’•è£‚ã€‚å¦å¤–ï¼Œäº¤æ¢æ˜¯æŒ‡å„è‡ªçš„å†…å­˜åœ°å€ï¼Œå¯ä»¥è®¤ä¸ºè¯¥æ“ä½œæ˜¯ç¬é—´å®Œæˆã€‚ Android 4.4ä¸Šåˆå¼•å…¥äº†Vsyncè™šæ‹ŸåŒ–ï¼Œé€šè¿‡DispSyncThreadæŠŠVsyncè™šæ‹ŸåŒ–æˆVsync-appå’ŒVsync-sfï¼ŒVsync-appå’ŒVsync-sfç›´æ¥æœ‰å›ºå®šçš„æ—¶æœºåç§»ï¼Œå„è‡ªåˆ†åˆ«æŒæ§ç€Appå’ŒSurfaceFlingerçš„å·¥ä½œèŠ‚å¥ï¼Œä»–ä»¬ä¸€å‰ä¸€åä¿æŒç€ç»˜åˆ¶ä»»åŠ¡çš„æµæ°´èŠ‚å¥ã€‚ CPU/GPUæ ¹æ®VSYNCä¿¡å·åŒæ­¥å¤„ç†æ•°æ®ï¼Œå¯ä»¥è®©CPU/GPUæœ‰å®Œæ•´çš„16msæ—¶é—´æ¥å¤„ç†æ•°æ®ï¼Œå‡å°‘äº†jankï¼ˆä¸¢å¸§ï¼‰ã€‚ ä¸€å¥è¯æ€»ç»“ï¼ŒVSyncåŒæ­¥ä½¿å¾—CPU/GPUå……åˆ†åˆ©ç”¨äº†16.6msæ—¶é—´ï¼Œå‡å°‘jankã€‚ åº”ç”¨åœ¨æ¯ä¸ªVsyncä¿¡å·åˆ°æ¥åéƒ½ä¼šé€šè¿‡dequeueBuffer/queueBufferæ¥ç”³è¯·bufferå’Œæäº¤ç»˜å›¾æ•°æ®ï¼ŒSurfaceflingeréƒ½ä¼šåœ¨ä¸‹ä¸€ä¸ªvsyncä¿¡å·åˆ°æ¥æ—¶å–èµ°bufferå»åšåˆæˆå’Œæ˜¾ç¤ºï¼Œ å¹¶åœ¨ä¸‹ä¸€ä¸‹ä¸ªvsyncæ—¶å°†bufferè¿˜å›æ¥ï¼Œå†æ¬¡å¾ªç¯ã€‚ ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#è½¯ä»¶æ¸²æŸ“ä»‹ç»"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"äºŒã€Surfaceçš„æ¸²æŸ“ Androidç³»ç»Ÿçš„UIä»ç»˜åˆ¶åˆ°æ˜¾ç¤ºåœ¨å±å¹•ä¸Šå¯åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š 1ã€Android Appè¿›ç¨‹ï¼šå°†UIç»˜åˆ¶åˆ°ä¸€ä¸ªå›¾å½¢ç¼“å†²åŒºGraphicBufferä¸­ï¼Œç„¶åé€šçŸ¥SurfaceFlingerè¿›è¡Œåˆæˆã€‚ 2ã€SurfaceFlingerè¿›ç¨‹ï¼šå°†GraphicBufferæ•°æ®åˆæˆå¹¶äº¤ç»™å±å¹•ç¼“å†²åŒºå»æ˜¾ç¤ºï¼Œè¿™ä¸€æ­¥æœ¬èº«å°±æ˜¯é€šè¿‡è½¯ä»¶ï¼ˆSkiaï¼‰å’Œç¡¬ä»¶ï¼ˆOpen GLå’Œ HardWare Composerï¼‰å»å®Œæˆçš„ã€‚ è½¯ä»¶æ¸²æŸ“ä»‹ç» å½“Appæ›´æ–°éƒ¨åˆ†UIæ—¶ï¼ŒCPUä¼šéå†ViewTreeè®¡ç®—å¤„éœ€è¦é‡ç»˜çš„èµƒåŒºï¼Œæ¥ç€åœ¨Viewå±‚æ¬¡ç»“æ„ä¸­ç»˜åˆ¶æ‰€æœ‰è·Ÿè„åŒºç›¸äº¤çš„åŒºåŸŸï¼Œå› æ­¤è½¯ä»¶ç»˜åˆ¶ä¼šç»˜åˆ¶åˆ°ä¸éœ€è¦é‡ç»˜çš„è§†å›¾ã€‚ è½¯ä»¶ç»˜åˆ¶çš„ç»˜åˆ¶è¿‡ç¨‹æ˜¯åœ¨ä¸»çº¿ç¨‹è¿›è¡Œçš„ï¼Œå¯èƒ½ä¼šé€ æˆå¡é¡¿ç­‰æƒ…å†µã€‚ è½¯ä»¶ç»˜åˆ¶æŠŠè¦ç»˜åˆ¶çš„å†…å®¹å†™è¿›ä¸€ä¸ªBitmapä½å›¾ï¼Œåœ¨ä¹‹åçš„æ¸²æŸ“è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ªBitmapçš„åƒç´ å†…å®¹ä¼šå¡«å……åˆ°Surfaceçš„ç¼“å†²åŒºé‡Œã€‚ è½¯ä»¶ç»˜åˆ¶ä½¿ç”¨Skiaåº“ï¼ŒSkiaæ˜¯Googleå¼€å‘çš„ä¸€ä¸ªè·¨å¹³å°çš„2Då›¾å½¢åº“ï¼Œå®ƒæä¾›äº†ä¸€ç»„å¼ºå¤§çš„APIï¼Œå¯ä»¥å®ç°é«˜è´¨é‡çš„2Då›¾å½¢æ¸²æŸ“ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè½¯ä»¶æ¸²æŸ“çš„æ€§èƒ½ç›¸å¯¹è¾ƒä½ï¼Œè€Œä¸”å¯èƒ½ä¼šå› ä¸ºå¤§é‡çš„å›¾åƒè®¡ç®—è€Œå ç”¨å¤§é‡CPUèµ„æºï¼Œå¯¼è‡´åº”ç”¨ç¨‹åºçš„è¿è¡Œé€Ÿåº¦å˜æ…¢ã€‚ å¦‚ä¸‹ä¸ºè½¯ä»¶æ¸²æŸ“æµç¨‹ï¼š 1ã€æ„å»ºè§†å›¾æ ‘ï¼šAndroidåº”ç”¨ç¨‹åºä¸­çš„UIç”±è§†å›¾æ ‘æ¥ç»„ç»‡çš„ï¼Œé¦–å…ˆéœ€è¦æ„å»ºè§†å›¾æ ‘ã€‚ 2ã€è®¡ç®—å¸ƒå±€ï¼šåœ¨è·å¾—è§†å›¾æ ‘ä¹‹åï¼Œç³»ç»Ÿéœ€è¦è®¡ç®—æ¯ä¸ªè§†å›¾çš„å¤§å°å’Œä½ç½®ï¼Œå¹¶å°†å®ƒä»¬æ”¾ç½®åœ¨æ­£ç¡®çš„ä½ç½®ä¸Šï¼Œä»¥å®Œæˆå¸ƒå±€ã€‚ 3ã€ç»˜åˆ¶è§†å›¾ï¼šæ¥ä¸‹æ¥ï¼Œç³»ç»Ÿå°†å¼€å§‹ä½¿ç”¨è½¯ä»¶æ¸²æŸ“å¼•æ“(Skia)ï¼Œå¯¹æ¯ä¸€ä¸ªè§†å›¾è¿›è¡Œä¸»æ„ç»˜åˆ¶ï¼Œå³ä½¿ç”¨CPUæ‰§è¡Œå›¾åƒè®¡ç®—å¹¶å°†å›¾åƒæ¸²æŸ“åˆ°GraphicBufferä¸Šã€‚ 4ã€åˆæˆå›¾åƒï¼šå½“æ‰€æœ‰çš„è§†å›¾éƒ½ç»˜åˆ¶å®Œæˆåï¼ŒSurfaceFlingerä¼šå°†å®ƒä»¬åˆæˆåœ¨ä¸€èµ·ï¼Œç”Ÿæˆæœ€ç»ˆå±å¹•å›¾åƒï¼Œå¹¶å°†å…¶æ”¾åˆ°ä¸»æ˜¾ç¤ºç¼“å†²åŒºä¸­ã€‚ ç¡¬ä»¶æ¸²æŸ“ä»‹ç» å½“Appæ›´æ–°éƒ¨åˆ†UIæ—¶ï¼ŒCPUä¼šè®¡ç®—å‡ºè„åŒºï¼Œä½†æ˜¯ä¸ä¼šç«‹å³æ‰§è¡Œç»˜åˆ¶å‘½ä»¤ï¼Œè€Œæ˜¯å°†darwXXXå‡½æ•°ä½œä¸ºç»˜åˆ¶æŒ‡ä»¤(DrawOp)è®°å½•åœ¨ä¸€ä¸ªåˆ—è¡¨(DisplayListä¸­)ï¼Œç„¶åäº¤ç»™å•ç‹¬çš„Renderçº¿ç¨‹ä½¿ç”¨GPUè¿›è¡Œç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“ã€‚ åªéœ€è¦é’ˆå¯¹éœ€è¦æ›´æ–°çš„Viewå¯¹è±¡çš„è„åŒºè¿›è¡Œè®°å½•æˆ–æ›´æ–°ï¼Œæ— éœ€æ›´æ–°çš„Viewå¯¹è±¡åˆ™èƒ½é‡ç”¨å…ˆå‰DisplayListä¸­è®°å½•çš„æŒ‡ä»¤ã€‚ ç¡¬ä»¶åŠ é€Ÿæ˜¯åœ¨å•ç‹¬çš„Renderçº¿ç¨‹ä¸­ç»˜åˆ¶çš„ï¼Œåˆ†æ‹…äº†ä¸»çº¿ç¨‹çš„å‹åŠ›ï¼Œæé«˜äº†å“åº”é€Ÿåº¦ã€‚ ç¡¬ä»¶ç»˜åˆ¶ä½¿ç”¨OpenGLåœ¨GPUä¸Šå®Œæˆï¼ŒOpenGLæ˜¯è·¨å¹³å°çš„å›¾å½¢APIï¼Œä¸º2D/3Då›¾å½¢å¤„ç†ç¡¬ä»¶åˆ¶å®šäº†æ ‡å¿—çš„è½¯ä»¶æ¥å£ã€‚ å¦‚ä¸‹ä¸ºç¡¬ä»¶æ¸²æŸ“çš„æµç¨‹ï¼š 1ã€æ„å»ºè§†å›¾æ ‘ï¼šä¸è½¯ä»¶æ¸²æŸ“ä¸€æ ·ï¼Œç¡¬ä»¶æ¸²æŸ“ä¹Ÿéœ€è¦æ„å»ºåº”ç”¨ç¨‹åºçš„è§†å›¾æ ‘ã€‚ 2ã€è®¡ç®—å¸ƒå±€ï¼šä¸è½¯ä»¶æ¸²æŸ“ä¸€æ ·ï¼Œç¡¬ä»¶æ¸²æŸ“ä¹Ÿéœ€è¦å¯¹æ¯ä¸ªè§†å›¾è®¡ç®—å¸ƒå±€ã€‚ 3ã€åˆ›å»ºOpenGLçš„æ¸²æŸ“ä¸Šä¸‹æ–‡å’Œçº¹ç†ï¼šAndroidä½¿ç”¨OpenGL ESä½œä¸ºç¡¬ä»¶åŠ é€Ÿçš„æ¸²æŸ“å¼•æ“ã€‚å› æ­¤ï¼Œå½“ç¡¬ä»¶åŠ é€Ÿè¢«å¼€å¯æ—¶ï¼Œç³»ç»Ÿä¼šåˆ›å»ºOpenGLçš„æ¸²æŸ“ä¸Šä¸‹æ–‡ï¼ŒåŒæ—¶ä¸ºæ¯ä¸ªè§†å›¾åˆ†é…ä¸€ä¸ªæ¸²æŸ“çº¹ç†ã€‚ 4ã€ä¸Šä¼ çº¹ç†æ•°æ®ï¼šåœ¨è®¡ç®—å¥½è§†å›¾çš„å¸ƒå±€ä¹‹åï¼Œç³»ç»Ÿå°†è§†å›¾çš„å›¾åƒæ•°æ®ä¸Šä¼ åˆ°æ¸²æŸ“çº¹ç†ä¸­ã€‚è¿™é€šå¸¸ç”±GPUå®Œæˆã€‚ 5ã€ç»˜åˆ¶çº¹ç†ï¼šæœ€åï¼Œç³»ç»Ÿå°†è§†å›¾çš„æ¸²æŸ“çº¹ç†ç»‘å®šåˆ°OpenGLçš„æ¸²æŸ“ä¸Šä¸‹æ–‡ä¸­ï¼Œå¹¶æ‰§è¡ŒGPUè®¡ç®—ï¼Œå³ä½¿ç”¨GPUç»˜åˆ¶å›¾åƒã€‚ 6ã€åˆæˆå›¾åƒï¼šå½“æ‰€æœ‰çš„è§†å›¾éƒ½ç»˜åˆ¶å®Œæˆåï¼ŒSurfaceFlingerä¼šå°†å®ƒä»¬åˆæˆåœ¨ä¸€èµ·ï¼Œç”Ÿæˆæœ€ç»ˆå±å¹•å›¾åƒï¼Œå¹¶å°†å…¶æ”¾åˆ°ä¸»æ˜¾ç¤ºç¼“å†²åŒºä¸­ã€‚ Androidåœ¨ä»€ä¹ˆæ—¶å€™ä½¿ç”¨è½¯ä»¶æ¸²æŸ“ã€ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ç¡¬ä»¶æ¸²æŸ“ï¼Ÿ åœ¨Androidç³»ç»Ÿä¸­ï¼Œè½¯ä»¶æ¸²æŸ“å’Œç¡¬ä»¶æ¸²æŸ“æ˜¯æ ¹æ®åº”ç”¨ç¨‹åºçš„éœ€æ±‚å’Œè®¾å¤‡çš„æ€§èƒ½å†³å®šçš„çš„ã€‚é€šå¸¸æƒ…å†µï¼Œç³»ç»Ÿä¼šä¼˜å…ˆä½¿ç”¨ç¡¬ä»¶æ¸²æŸ“æ¥æé«˜å›¾å½¢çš„é€Ÿåº¦å’Œæ•ˆç‡ã€‚å¦‚æœç³»ç»Ÿæ£€æµ‹åˆ°è®¾å¤‡çš„GPUä¸æ”¯æŒæŸç§ç‰¹å®šçš„å›¾åƒç‰¹æ•ˆæˆ–åŠŸèƒ½ï¼Œæˆ–åœ¨ç¡¬ä»¶æ¸²æŸ“çš„è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼Œé‚£ä¹ˆç³»ç»Ÿå°†é€€å›åˆ°è½¯ä»¶æ¸²æŸ“ã€‚ä¸‹åˆ—æƒ…å†µå¯èƒ½è§¦å‘ç³»ç»Ÿä½¿ç”¨è½¯ä»¶æ¸²æŸ“ï¼š 1ã€è®¾å¤‡çš„GPUä¸æ”¯æŒå½“å‰åº”ç”¨ç¨‹åºçš„æŸäº›ç‰¹æ€§æˆ–å›¾åƒæ ¼å¼ã€‚ 2ã€å½“å‰åº”ç”¨ç¨‹åºéœ€è¦åœ¨å±å¹•ä¸Šå åŠ å¤šä¸ªå›¾åƒå±‚ï¼Œè€ŒGPUèƒ½åŠ›ä¸è¶³ä»¥å¤„ç†æ‰€æœ‰çš„å±‚çº§å åŠ ã€‚ 3ã€åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿå¯èƒ½ä¼šå¯¼è‡´åº”ç”¨ç¨‹åºå‡ºç°æ€§èƒ½é—®é¢˜ï¼Œæ­¤æ—¶ç³»ç»Ÿå¯èƒ½ä¼šåˆ‡æ¢åˆ°ä½¿ç”¨è½¯ä»¶æ¸²æŸ“ã€‚ SurfaceFlingerçš„åŒç¼“å†²ä¸VSYNCæœºåˆ¶ ç¼“å†²æœºåˆ¶ä»‹ç» æ˜¾ç¤ºç¼“å†²æœºåˆ¶æ˜¯æŒ‡å®šåœ¨è®¡ç®—æœºç³»ç»Ÿä¸­ï¼Œå°†æ˜¾ç¤ºæ•°æ®ç¼“å­˜åˆ°åˆ°å†…å­˜ä¸­ä»¥æé«˜å¤„ç†é€Ÿåº¦çš„ä¸€ç§è®¡ç®—ï¼Œåœ¨å›¾å½¢å’Œå›¾åƒå¤„ç†ä¸­ï¼Œæ˜¾ç¤ºç¼“å†²æœºåˆ¶å¯ä»¥æå‡å›¾åƒã€å›¾å½¢çš„æ¸²æŸ“æ•ˆç‡å’Œè´¨é‡ã€‚ åœ¨æ—©æœŸçš„Androidç‰ˆæœ¬ä¸­ï¼ŒSurfaceFlingerä½¿ç”¨çš„æ˜¯ä¸‰é‡ç¼“å†²åŒºæœºåˆ¶ï¼Œå³å‰å°ã€åå°å’Œæ˜¾ç¤ºä¸‰ä¸ªç¼“å†²åŒºã€‚ä»Android8.0å¼€å§‹ï¼ŒSurfaceFlingerè¯¥ä¸ºé‡‡ç”¨åŒç¼“å†²åŒºæœºåˆ¶ï¼Œåªæœ‰å‰å°å’Œåå°ä¸¤ä¸ªç¼“å†²åŒºã€‚é‡‡ç”¨ä¸‰é‡ç¼“å†²åŒºæœºåˆ¶çš„ä¼˜ç‚¹åœ¨äºå¯ä»¥å‡å°‘å±å¹•æ’•è£‚ç°è±¡çš„äº§ç”Ÿï¼Œæé«˜æ˜¾ç¤ºç”»é¢çš„è¿è´¯æ€§ã€‚ä½†åŒæ—¶å¢åŠ äº†å†…å­˜å ç”¨ï¼Œå› æ­¤åœ¨Android8.0åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ï¼Œä¸ºäº†æé«˜æ€§èƒ½å’Œå‡å°‘å†…å­˜å ç”¨ï¼ŒSurfaceFlingeræ”¹ä¸ºé‡‡ç”¨åŒç¼“å†²åŒºæœºåˆ¶ã€‚ åŒç¼“å†²åŒºæœºåˆ¶ä¸‹ï¼Œå‰å°ç¼“å†²åŒºç”¨äºæ˜¾ç¤ºå½“å‰å¸§çš„å†…å®¹ï¼Œåå°ç¼“å†²åŒºç”¨äºç»˜åˆ¶ä¸‹ä¸€å¸§çš„å†…å®¹ã€‚å½“ç»˜åˆ¶ä¸‹ä¸€å¸§å®Œæˆåï¼ŒSurfaceFlingerä¼šå°†åå°ç¼“å†²åŒºçš„å†…å®¹äº¤æ¢åˆ°å‰å°ç¼“å†²åŒºï¼Œä»è€Œå®ç°å¸§ä¸å¸§ä¹‹é—´çš„åˆ‡æ¢ã€‚è¿™ç§æœºåˆ¶å¯ä»¥å‡å°‘ä¸€æ¬¡ç¼“å†²åŒºçš„åˆ›å»ºåŠé”€æ¯æ“ä½œï¼Œä»¥æé«˜æ€§èƒ½å’Œè§£çº¦å†…å­˜ã€‚ ä¸‰é‡ç¼“å­˜æœºåˆ¶æ˜¯Androidä¸­çš„ä¸€ç§ä¼˜åŒ–æŠ€æœ¯ï¼Œç”¨äºæé«˜ç»˜åˆ¶æ€§èƒ½ã€‚å®ƒåŒ…æ‹¬å‰ç¼“å†²åŒºï¼ˆFront Bufferï¼‰ã€åç¼“å†²åŒºï¼ˆBack Bufferï¼‰å’Œæ˜¾ç¤ºç¼“å†²åŒºï¼ˆDisplay Bufferï¼‰ã€‚å‰ç¼“å†²åŒºç”¨äºæ˜¾ç¤ºå½“å‰å¸§ï¼Œåç¼“å†²åŒºç”¨äºç»˜åˆ¶ä¸‹ä¸€å¸§ï¼Œè€Œæ˜¾ç¤ºç¼“å†²åŒºåˆ™ç”¨äºå°†å‰ç¼“å†²åŒºçš„å†…å®¹æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚å½“VSYNCä¿¡å·åˆ°è¾¾æ—¶ï¼Œå‰ç¼“å†²åŒºå’Œåç¼“å†²åŒºä¼šè¿›è¡Œäº¤æ¢ï¼Œä»è€Œå®ç°æµç•…çš„æ˜¾ç¤ºæ•ˆæœã€‚ VSYNCæœºåˆ¶ä»‹ç» åœ¨å›¾å½¢å’Œå›¾åƒæ˜¾ç¤ºä¸­ï¼ŒVSYNCæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œå®ƒæ˜¯æŒ‡å‚ç›´åŒæ­¥ä¿¡å·ï¼Œç”¨äºæ§åˆ¶æ˜¾ç¤ºå™¨åˆ·æ–°ç‡å’Œæ˜¾ç¤ºæ—¶åºã€‚åœ¨Androidç³»ç»Ÿä¸­ï¼ŒVSYNCæœºåˆ¶è¢«å¹¿æ³›åº”ç”¨äºæ§åˆ¶å±å¹•æ˜¾ç¤ºå’ŒåŠ¨ç”»æ¸²æŸ“ï¼Œä»¥æé«˜æ˜¾ç¤ºæ•ˆæœå’Œæ€§èƒ½ã€‚ åœ¨Androidä¸­ï¼Œæ¯å°è®¾å¤‡éƒ½æœ‰ä¸€ä¸ªç¡¬ä»¶VSYNCä¿¡å·å‘ç”Ÿå™¨ï¼Œç”¨äºç”Ÿæˆæ’å®šçš„åˆ·æ–°ç‡ä¿¡å·ã€‚é€šå¸¸æƒ…å†µä¸‹è¿™ä¸ªä¿¡å·çš„åˆ·æ–°ç‡ä¸º60Hzæˆ–90Hzï¼ŒAndroidæ˜¾ç¤ºæ¡†æ¶å¯ä»¥æ ¹æ®è¿™ä¸ªä¿¡å·æ¥è°ƒæ•´è‡ªå·±çš„æ˜¾ç¤ºå’Œæ¸²æŸ“é€Ÿåº¦ã€‚åœ¨SurfaceFlingerçš„ç”Ÿæˆè€…æ¶ˆè´¹è€…æ¨¡å‹ä¸­ï¼Œå½“ç¡¬ä»¶VSYNCä¿¡å·å‘ç”Ÿæ—¶ï¼ŒSurfaceFlingerä¼šå¼€å§‹è¯»å–ç¼“å†²åŒºä¸­çš„æ•°æ®ï¼Œå¹¶å°†å…¶æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚å› æ­¤ï¼Œå¦‚æœAndroidæ˜¾ç¤ºæ¡†æ¶åœ¨VSYNCå‰å®Œæˆäº†æ•°æ®å¤„ç†å’Œç»˜åˆ¶ï¼Œåˆ™å¯ä»¥å®ç°é›¶å»¶è¿Ÿçš„å›¾åƒæˆ–åŠ¨ç”»æ¸²æŸ“ã€‚ VSYNCæœºåˆ¶çš„ä¸»è¦ä¼˜ç‚¹æ˜¯å¯ä»¥é¿å…åœ¨å›¾åƒæ¸²æŸ“è¿‡ç¨‹ä¸­å‡ºç°å±å¹•æ’•è£‚å’Œå¡é¡¿ç°è±¡ï¼ŒåŒæ—¶ï¼Œä½¿ç”¨ç¡¬ä»¶ä¿¡å·ï¼Œå¯ä»¥ä½¿å›¾å½¢å’Œå›¾åƒå¤„ç†ä¸æ˜¾ç¤ºä¿æŒåŒæ­¥ï¼Œæé«˜æ˜¾ç¤ºæ•ˆæœå’Œæ¸²æŸ“æ€§èƒ½ã€‚ ç”±äºå›¾åƒç»˜åˆ¶å’Œå±å¹•è¯»å– ä½¿ç”¨çš„æ˜¯åŒä¸ªbufferï¼Œæ‰€ä»¥å±å¹•åˆ·æ–°æ—¶å¯èƒ½è¯»å–åˆ°çš„æ˜¯ä¸å®Œæ•´çš„ä¸€å¸§ç”»é¢ã€‚åŒç¼“å­˜ï¼Œè®©ç»˜åˆ¶å’Œæ˜¾ç¤ºå™¨æ‹¥æœ‰å„è‡ªçš„bufferï¼šGPU å§‹ç»ˆå°†å®Œæˆçš„ä¸€å¸§å›¾åƒæ•°æ®å†™å…¥åˆ° Back Bufferï¼Œè€Œæ˜¾ç¤ºå™¨ä½¿ç”¨ Frame Bufferï¼Œå½“å±å¹•åˆ·æ–°æ—¶ï¼ŒFrame Buffer å¹¶ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå½“Back bufferå‡†å¤‡å°±ç»ªåï¼Œå®ƒä»¬æ‰è¿›è¡Œäº¤æ¢ã€‚ ä»€ä¹ˆæ—¶å€™è¿›è¡Œä¸¤ä¸ªbufferçš„äº¤æ¢å‘¢ï¼Ÿ å½“æ‰«æå®Œä¸€å¸§ç”»é¢åï¼Œè®¾å¤‡éœ€è¦é‡æ–°å›åˆ°ç¬¬ä¸€è¡Œä»¥è¿›å…¥ä¸‹ä¸€æ¬¡çš„å¾ªç¯ï¼Œæ­¤æ—¶æœ‰ä¸€æ®µæ—¶é—´ç©ºéš™ï¼Œç§°ä¸ºVerticalBlanking Interval(VBI)ã€‚é‚£ï¼Œè¿™ä¸ªæ—¶é—´ç‚¹å°±æ˜¯æˆ‘ä»¬è¿›è¡Œç¼“å†²åŒºäº¤æ¢çš„æœ€ä½³æ—¶é—´ã€‚å› ä¸ºæ­¤æ—¶å±å¹•æ²¡æœ‰åœ¨åˆ·æ–°ï¼Œä¹Ÿå°±é¿å…äº†äº¤æ¢è¿‡ç¨‹ä¸­å‡ºç° screen tearingçš„çŠ¶å†µã€‚ VSYNC ä¿¡å·æ˜¯ç”±å±å¹•ï¼ˆæ˜¾ç¤ºè®¾å¤‡ï¼‰äº§ç”Ÿçš„ï¼Œåˆ©ç”¨VBIæ—¶æœŸå‡ºç°çš„vertical sync pulseï¼ˆå‚ç›´åŒæ­¥è„‰å†²ï¼‰æ¥ä¿è¯åŒç¼“å†²åœ¨æœ€ä½³æ—¶é—´ç‚¹æ‰è¿›è¡Œäº¤æ¢ã€‚å¹¶ä¸”ä»¥ 60fps çš„å›ºå®šé¢‘ç‡å‘é€ç»™ Android ç³»ç»Ÿï¼ŒAndroid ç³»ç»Ÿä¸­çš„ SurfaceFlinger æ¥æ”¶å‘é€çš„ VSYNC ä¿¡å·ã€‚VSYNC ä¿¡å·è¡¨æ˜å¯å¯¹å±å¹•è¿›è¡Œåˆ·æ–°è€Œä¸ä¼šäº§ç”Ÿæ’•è£‚ã€‚å¦å¤–ï¼Œäº¤æ¢æ˜¯æŒ‡å„è‡ªçš„å†…å­˜åœ°å€ï¼Œå¯ä»¥è®¤ä¸ºè¯¥æ“ä½œæ˜¯ç¬é—´å®Œæˆã€‚ Android 4.4ä¸Šåˆå¼•å…¥äº†Vsyncè™šæ‹ŸåŒ–ï¼Œé€šè¿‡DispSyncThreadæŠŠVsyncè™šæ‹ŸåŒ–æˆVsync-appå’ŒVsync-sfï¼ŒVsync-appå’ŒVsync-sfç›´æ¥æœ‰å›ºå®šçš„æ—¶æœºåç§»ï¼Œå„è‡ªåˆ†åˆ«æŒæ§ç€Appå’ŒSurfaceFlingerçš„å·¥ä½œèŠ‚å¥ï¼Œä»–ä»¬ä¸€å‰ä¸€åä¿æŒç€ç»˜åˆ¶ä»»åŠ¡çš„æµæ°´èŠ‚å¥ã€‚ CPU/GPUæ ¹æ®VSYNCä¿¡å·åŒæ­¥å¤„ç†æ•°æ®ï¼Œå¯ä»¥è®©CPU/GPUæœ‰å®Œæ•´çš„16msæ—¶é—´æ¥å¤„ç†æ•°æ®ï¼Œå‡å°‘äº†jankï¼ˆä¸¢å¸§ï¼‰ã€‚ ä¸€å¥è¯æ€»ç»“ï¼ŒVSyncåŒæ­¥ä½¿å¾—CPU/GPUå……åˆ†åˆ©ç”¨äº†16.6msæ—¶é—´ï¼Œå‡å°‘jankã€‚ åº”ç”¨åœ¨æ¯ä¸ªVsyncä¿¡å·åˆ°æ¥åéƒ½ä¼šé€šè¿‡dequeueBuffer/queueBufferæ¥ç”³è¯·bufferå’Œæäº¤ç»˜å›¾æ•°æ®ï¼ŒSurfaceflingeréƒ½ä¼šåœ¨ä¸‹ä¸€ä¸ªvsyncä¿¡å·åˆ°æ¥æ—¶å–èµ°bufferå»åšåˆæˆå’Œæ˜¾ç¤ºï¼Œ å¹¶åœ¨ä¸‹ä¸€ä¸‹ä¸ªvsyncæ—¶å°†bufferè¿˜å›æ¥ï¼Œå†æ¬¡å¾ªç¯ã€‚ ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#ç¡¬ä»¶æ¸²æŸ“ä»‹ç»"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"äºŒã€Surfaceçš„æ¸²æŸ“ Androidç³»ç»Ÿçš„UIä»ç»˜åˆ¶åˆ°æ˜¾ç¤ºåœ¨å±å¹•ä¸Šå¯åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š 1ã€Android Appè¿›ç¨‹ï¼šå°†UIç»˜åˆ¶åˆ°ä¸€ä¸ªå›¾å½¢ç¼“å†²åŒºGraphicBufferä¸­ï¼Œç„¶åé€šçŸ¥SurfaceFlingerè¿›è¡Œåˆæˆã€‚ 2ã€SurfaceFlingerè¿›ç¨‹ï¼šå°†GraphicBufferæ•°æ®åˆæˆå¹¶äº¤ç»™å±å¹•ç¼“å†²åŒºå»æ˜¾ç¤ºï¼Œè¿™ä¸€æ­¥æœ¬èº«å°±æ˜¯é€šè¿‡è½¯ä»¶ï¼ˆSkiaï¼‰å’Œç¡¬ä»¶ï¼ˆOpen GLå’Œ HardWare Composerï¼‰å»å®Œæˆçš„ã€‚ è½¯ä»¶æ¸²æŸ“ä»‹ç» å½“Appæ›´æ–°éƒ¨åˆ†UIæ—¶ï¼ŒCPUä¼šéå†ViewTreeè®¡ç®—å¤„éœ€è¦é‡ç»˜çš„èµƒåŒºï¼Œæ¥ç€åœ¨Viewå±‚æ¬¡ç»“æ„ä¸­ç»˜åˆ¶æ‰€æœ‰è·Ÿè„åŒºç›¸äº¤çš„åŒºåŸŸï¼Œå› æ­¤è½¯ä»¶ç»˜åˆ¶ä¼šç»˜åˆ¶åˆ°ä¸éœ€è¦é‡ç»˜çš„è§†å›¾ã€‚ è½¯ä»¶ç»˜åˆ¶çš„ç»˜åˆ¶è¿‡ç¨‹æ˜¯åœ¨ä¸»çº¿ç¨‹è¿›è¡Œçš„ï¼Œå¯èƒ½ä¼šé€ æˆå¡é¡¿ç­‰æƒ…å†µã€‚ è½¯ä»¶ç»˜åˆ¶æŠŠè¦ç»˜åˆ¶çš„å†…å®¹å†™è¿›ä¸€ä¸ªBitmapä½å›¾ï¼Œåœ¨ä¹‹åçš„æ¸²æŸ“è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ªBitmapçš„åƒç´ å†…å®¹ä¼šå¡«å……åˆ°Surfaceçš„ç¼“å†²åŒºé‡Œã€‚ è½¯ä»¶ç»˜åˆ¶ä½¿ç”¨Skiaåº“ï¼ŒSkiaæ˜¯Googleå¼€å‘çš„ä¸€ä¸ªè·¨å¹³å°çš„2Då›¾å½¢åº“ï¼Œå®ƒæä¾›äº†ä¸€ç»„å¼ºå¤§çš„APIï¼Œå¯ä»¥å®ç°é«˜è´¨é‡çš„2Då›¾å½¢æ¸²æŸ“ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè½¯ä»¶æ¸²æŸ“çš„æ€§èƒ½ç›¸å¯¹è¾ƒä½ï¼Œè€Œä¸”å¯èƒ½ä¼šå› ä¸ºå¤§é‡çš„å›¾åƒè®¡ç®—è€Œå ç”¨å¤§é‡CPUèµ„æºï¼Œå¯¼è‡´åº”ç”¨ç¨‹åºçš„è¿è¡Œé€Ÿåº¦å˜æ…¢ã€‚ å¦‚ä¸‹ä¸ºè½¯ä»¶æ¸²æŸ“æµç¨‹ï¼š 1ã€æ„å»ºè§†å›¾æ ‘ï¼šAndroidåº”ç”¨ç¨‹åºä¸­çš„UIç”±è§†å›¾æ ‘æ¥ç»„ç»‡çš„ï¼Œé¦–å…ˆéœ€è¦æ„å»ºè§†å›¾æ ‘ã€‚ 2ã€è®¡ç®—å¸ƒå±€ï¼šåœ¨è·å¾—è§†å›¾æ ‘ä¹‹åï¼Œç³»ç»Ÿéœ€è¦è®¡ç®—æ¯ä¸ªè§†å›¾çš„å¤§å°å’Œä½ç½®ï¼Œå¹¶å°†å®ƒä»¬æ”¾ç½®åœ¨æ­£ç¡®çš„ä½ç½®ä¸Šï¼Œä»¥å®Œæˆå¸ƒå±€ã€‚ 3ã€ç»˜åˆ¶è§†å›¾ï¼šæ¥ä¸‹æ¥ï¼Œç³»ç»Ÿå°†å¼€å§‹ä½¿ç”¨è½¯ä»¶æ¸²æŸ“å¼•æ“(Skia)ï¼Œå¯¹æ¯ä¸€ä¸ªè§†å›¾è¿›è¡Œä¸»æ„ç»˜åˆ¶ï¼Œå³ä½¿ç”¨CPUæ‰§è¡Œå›¾åƒè®¡ç®—å¹¶å°†å›¾åƒæ¸²æŸ“åˆ°GraphicBufferä¸Šã€‚ 4ã€åˆæˆå›¾åƒï¼šå½“æ‰€æœ‰çš„è§†å›¾éƒ½ç»˜åˆ¶å®Œæˆåï¼ŒSurfaceFlingerä¼šå°†å®ƒä»¬åˆæˆåœ¨ä¸€èµ·ï¼Œç”Ÿæˆæœ€ç»ˆå±å¹•å›¾åƒï¼Œå¹¶å°†å…¶æ”¾åˆ°ä¸»æ˜¾ç¤ºç¼“å†²åŒºä¸­ã€‚ ç¡¬ä»¶æ¸²æŸ“ä»‹ç» å½“Appæ›´æ–°éƒ¨åˆ†UIæ—¶ï¼ŒCPUä¼šè®¡ç®—å‡ºè„åŒºï¼Œä½†æ˜¯ä¸ä¼šç«‹å³æ‰§è¡Œç»˜åˆ¶å‘½ä»¤ï¼Œè€Œæ˜¯å°†darwXXXå‡½æ•°ä½œä¸ºç»˜åˆ¶æŒ‡ä»¤(DrawOp)è®°å½•åœ¨ä¸€ä¸ªåˆ—è¡¨(DisplayListä¸­)ï¼Œç„¶åäº¤ç»™å•ç‹¬çš„Renderçº¿ç¨‹ä½¿ç”¨GPUè¿›è¡Œç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“ã€‚ åªéœ€è¦é’ˆå¯¹éœ€è¦æ›´æ–°çš„Viewå¯¹è±¡çš„è„åŒºè¿›è¡Œè®°å½•æˆ–æ›´æ–°ï¼Œæ— éœ€æ›´æ–°çš„Viewå¯¹è±¡åˆ™èƒ½é‡ç”¨å…ˆå‰DisplayListä¸­è®°å½•çš„æŒ‡ä»¤ã€‚ ç¡¬ä»¶åŠ é€Ÿæ˜¯åœ¨å•ç‹¬çš„Renderçº¿ç¨‹ä¸­ç»˜åˆ¶çš„ï¼Œåˆ†æ‹…äº†ä¸»çº¿ç¨‹çš„å‹åŠ›ï¼Œæé«˜äº†å“åº”é€Ÿåº¦ã€‚ ç¡¬ä»¶ç»˜åˆ¶ä½¿ç”¨OpenGLåœ¨GPUä¸Šå®Œæˆï¼ŒOpenGLæ˜¯è·¨å¹³å°çš„å›¾å½¢APIï¼Œä¸º2D/3Då›¾å½¢å¤„ç†ç¡¬ä»¶åˆ¶å®šäº†æ ‡å¿—çš„è½¯ä»¶æ¥å£ã€‚ å¦‚ä¸‹ä¸ºç¡¬ä»¶æ¸²æŸ“çš„æµç¨‹ï¼š 1ã€æ„å»ºè§†å›¾æ ‘ï¼šä¸è½¯ä»¶æ¸²æŸ“ä¸€æ ·ï¼Œç¡¬ä»¶æ¸²æŸ“ä¹Ÿéœ€è¦æ„å»ºåº”ç”¨ç¨‹åºçš„è§†å›¾æ ‘ã€‚ 2ã€è®¡ç®—å¸ƒå±€ï¼šä¸è½¯ä»¶æ¸²æŸ“ä¸€æ ·ï¼Œç¡¬ä»¶æ¸²æŸ“ä¹Ÿéœ€è¦å¯¹æ¯ä¸ªè§†å›¾è®¡ç®—å¸ƒå±€ã€‚ 3ã€åˆ›å»ºOpenGLçš„æ¸²æŸ“ä¸Šä¸‹æ–‡å’Œçº¹ç†ï¼šAndroidä½¿ç”¨OpenGL ESä½œä¸ºç¡¬ä»¶åŠ é€Ÿçš„æ¸²æŸ“å¼•æ“ã€‚å› æ­¤ï¼Œå½“ç¡¬ä»¶åŠ é€Ÿè¢«å¼€å¯æ—¶ï¼Œç³»ç»Ÿä¼šåˆ›å»ºOpenGLçš„æ¸²æŸ“ä¸Šä¸‹æ–‡ï¼ŒåŒæ—¶ä¸ºæ¯ä¸ªè§†å›¾åˆ†é…ä¸€ä¸ªæ¸²æŸ“çº¹ç†ã€‚ 4ã€ä¸Šä¼ çº¹ç†æ•°æ®ï¼šåœ¨è®¡ç®—å¥½è§†å›¾çš„å¸ƒå±€ä¹‹åï¼Œç³»ç»Ÿå°†è§†å›¾çš„å›¾åƒæ•°æ®ä¸Šä¼ åˆ°æ¸²æŸ“çº¹ç†ä¸­ã€‚è¿™é€šå¸¸ç”±GPUå®Œæˆã€‚ 5ã€ç»˜åˆ¶çº¹ç†ï¼šæœ€åï¼Œç³»ç»Ÿå°†è§†å›¾çš„æ¸²æŸ“çº¹ç†ç»‘å®šåˆ°OpenGLçš„æ¸²æŸ“ä¸Šä¸‹æ–‡ä¸­ï¼Œå¹¶æ‰§è¡ŒGPUè®¡ç®—ï¼Œå³ä½¿ç”¨GPUç»˜åˆ¶å›¾åƒã€‚ 6ã€åˆæˆå›¾åƒï¼šå½“æ‰€æœ‰çš„è§†å›¾éƒ½ç»˜åˆ¶å®Œæˆåï¼ŒSurfaceFlingerä¼šå°†å®ƒä»¬åˆæˆåœ¨ä¸€èµ·ï¼Œç”Ÿæˆæœ€ç»ˆå±å¹•å›¾åƒï¼Œå¹¶å°†å…¶æ”¾åˆ°ä¸»æ˜¾ç¤ºç¼“å†²åŒºä¸­ã€‚ Androidåœ¨ä»€ä¹ˆæ—¶å€™ä½¿ç”¨è½¯ä»¶æ¸²æŸ“ã€ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ç¡¬ä»¶æ¸²æŸ“ï¼Ÿ åœ¨Androidç³»ç»Ÿä¸­ï¼Œè½¯ä»¶æ¸²æŸ“å’Œç¡¬ä»¶æ¸²æŸ“æ˜¯æ ¹æ®åº”ç”¨ç¨‹åºçš„éœ€æ±‚å’Œè®¾å¤‡çš„æ€§èƒ½å†³å®šçš„çš„ã€‚é€šå¸¸æƒ…å†µï¼Œç³»ç»Ÿä¼šä¼˜å…ˆä½¿ç”¨ç¡¬ä»¶æ¸²æŸ“æ¥æé«˜å›¾å½¢çš„é€Ÿåº¦å’Œæ•ˆç‡ã€‚å¦‚æœç³»ç»Ÿæ£€æµ‹åˆ°è®¾å¤‡çš„GPUä¸æ”¯æŒæŸç§ç‰¹å®šçš„å›¾åƒç‰¹æ•ˆæˆ–åŠŸèƒ½ï¼Œæˆ–åœ¨ç¡¬ä»¶æ¸²æŸ“çš„è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼Œé‚£ä¹ˆç³»ç»Ÿå°†é€€å›åˆ°è½¯ä»¶æ¸²æŸ“ã€‚ä¸‹åˆ—æƒ…å†µå¯èƒ½è§¦å‘ç³»ç»Ÿä½¿ç”¨è½¯ä»¶æ¸²æŸ“ï¼š 1ã€è®¾å¤‡çš„GPUä¸æ”¯æŒå½“å‰åº”ç”¨ç¨‹åºçš„æŸäº›ç‰¹æ€§æˆ–å›¾åƒæ ¼å¼ã€‚ 2ã€å½“å‰åº”ç”¨ç¨‹åºéœ€è¦åœ¨å±å¹•ä¸Šå åŠ å¤šä¸ªå›¾åƒå±‚ï¼Œè€ŒGPUèƒ½åŠ›ä¸è¶³ä»¥å¤„ç†æ‰€æœ‰çš„å±‚çº§å åŠ ã€‚ 3ã€åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿå¯èƒ½ä¼šå¯¼è‡´åº”ç”¨ç¨‹åºå‡ºç°æ€§èƒ½é—®é¢˜ï¼Œæ­¤æ—¶ç³»ç»Ÿå¯èƒ½ä¼šåˆ‡æ¢åˆ°ä½¿ç”¨è½¯ä»¶æ¸²æŸ“ã€‚ SurfaceFlingerçš„åŒç¼“å†²ä¸VSYNCæœºåˆ¶ ç¼“å†²æœºåˆ¶ä»‹ç» æ˜¾ç¤ºç¼“å†²æœºåˆ¶æ˜¯æŒ‡å®šåœ¨è®¡ç®—æœºç³»ç»Ÿä¸­ï¼Œå°†æ˜¾ç¤ºæ•°æ®ç¼“å­˜åˆ°åˆ°å†…å­˜ä¸­ä»¥æé«˜å¤„ç†é€Ÿåº¦çš„ä¸€ç§è®¡ç®—ï¼Œåœ¨å›¾å½¢å’Œå›¾åƒå¤„ç†ä¸­ï¼Œæ˜¾ç¤ºç¼“å†²æœºåˆ¶å¯ä»¥æå‡å›¾åƒã€å›¾å½¢çš„æ¸²æŸ“æ•ˆç‡å’Œè´¨é‡ã€‚ åœ¨æ—©æœŸçš„Androidç‰ˆæœ¬ä¸­ï¼ŒSurfaceFlingerä½¿ç”¨çš„æ˜¯ä¸‰é‡ç¼“å†²åŒºæœºåˆ¶ï¼Œå³å‰å°ã€åå°å’Œæ˜¾ç¤ºä¸‰ä¸ªç¼“å†²åŒºã€‚ä»Android8.0å¼€å§‹ï¼ŒSurfaceFlingerè¯¥ä¸ºé‡‡ç”¨åŒç¼“å†²åŒºæœºåˆ¶ï¼Œåªæœ‰å‰å°å’Œåå°ä¸¤ä¸ªç¼“å†²åŒºã€‚é‡‡ç”¨ä¸‰é‡ç¼“å†²åŒºæœºåˆ¶çš„ä¼˜ç‚¹åœ¨äºå¯ä»¥å‡å°‘å±å¹•æ’•è£‚ç°è±¡çš„äº§ç”Ÿï¼Œæé«˜æ˜¾ç¤ºç”»é¢çš„è¿è´¯æ€§ã€‚ä½†åŒæ—¶å¢åŠ äº†å†…å­˜å ç”¨ï¼Œå› æ­¤åœ¨Android8.0åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ï¼Œä¸ºäº†æé«˜æ€§èƒ½å’Œå‡å°‘å†…å­˜å ç”¨ï¼ŒSurfaceFlingeræ”¹ä¸ºé‡‡ç”¨åŒç¼“å†²åŒºæœºåˆ¶ã€‚ åŒç¼“å†²åŒºæœºåˆ¶ä¸‹ï¼Œå‰å°ç¼“å†²åŒºç”¨äºæ˜¾ç¤ºå½“å‰å¸§çš„å†…å®¹ï¼Œåå°ç¼“å†²åŒºç”¨äºç»˜åˆ¶ä¸‹ä¸€å¸§çš„å†…å®¹ã€‚å½“ç»˜åˆ¶ä¸‹ä¸€å¸§å®Œæˆåï¼ŒSurfaceFlingerä¼šå°†åå°ç¼“å†²åŒºçš„å†…å®¹äº¤æ¢åˆ°å‰å°ç¼“å†²åŒºï¼Œä»è€Œå®ç°å¸§ä¸å¸§ä¹‹é—´çš„åˆ‡æ¢ã€‚è¿™ç§æœºåˆ¶å¯ä»¥å‡å°‘ä¸€æ¬¡ç¼“å†²åŒºçš„åˆ›å»ºåŠé”€æ¯æ“ä½œï¼Œä»¥æé«˜æ€§èƒ½å’Œè§£çº¦å†…å­˜ã€‚ ä¸‰é‡ç¼“å­˜æœºåˆ¶æ˜¯Androidä¸­çš„ä¸€ç§ä¼˜åŒ–æŠ€æœ¯ï¼Œç”¨äºæé«˜ç»˜åˆ¶æ€§èƒ½ã€‚å®ƒåŒ…æ‹¬å‰ç¼“å†²åŒºï¼ˆFront Bufferï¼‰ã€åç¼“å†²åŒºï¼ˆBack Bufferï¼‰å’Œæ˜¾ç¤ºç¼“å†²åŒºï¼ˆDisplay Bufferï¼‰ã€‚å‰ç¼“å†²åŒºç”¨äºæ˜¾ç¤ºå½“å‰å¸§ï¼Œåç¼“å†²åŒºç”¨äºç»˜åˆ¶ä¸‹ä¸€å¸§ï¼Œè€Œæ˜¾ç¤ºç¼“å†²åŒºåˆ™ç”¨äºå°†å‰ç¼“å†²åŒºçš„å†…å®¹æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚å½“VSYNCä¿¡å·åˆ°è¾¾æ—¶ï¼Œå‰ç¼“å†²åŒºå’Œåç¼“å†²åŒºä¼šè¿›è¡Œäº¤æ¢ï¼Œä»è€Œå®ç°æµç•…çš„æ˜¾ç¤ºæ•ˆæœã€‚ VSYNCæœºåˆ¶ä»‹ç» åœ¨å›¾å½¢å’Œå›¾åƒæ˜¾ç¤ºä¸­ï¼ŒVSYNCæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œå®ƒæ˜¯æŒ‡å‚ç›´åŒæ­¥ä¿¡å·ï¼Œç”¨äºæ§åˆ¶æ˜¾ç¤ºå™¨åˆ·æ–°ç‡å’Œæ˜¾ç¤ºæ—¶åºã€‚åœ¨Androidç³»ç»Ÿä¸­ï¼ŒVSYNCæœºåˆ¶è¢«å¹¿æ³›åº”ç”¨äºæ§åˆ¶å±å¹•æ˜¾ç¤ºå’ŒåŠ¨ç”»æ¸²æŸ“ï¼Œä»¥æé«˜æ˜¾ç¤ºæ•ˆæœå’Œæ€§èƒ½ã€‚ åœ¨Androidä¸­ï¼Œæ¯å°è®¾å¤‡éƒ½æœ‰ä¸€ä¸ªç¡¬ä»¶VSYNCä¿¡å·å‘ç”Ÿå™¨ï¼Œç”¨äºç”Ÿæˆæ’å®šçš„åˆ·æ–°ç‡ä¿¡å·ã€‚é€šå¸¸æƒ…å†µä¸‹è¿™ä¸ªä¿¡å·çš„åˆ·æ–°ç‡ä¸º60Hzæˆ–90Hzï¼ŒAndroidæ˜¾ç¤ºæ¡†æ¶å¯ä»¥æ ¹æ®è¿™ä¸ªä¿¡å·æ¥è°ƒæ•´è‡ªå·±çš„æ˜¾ç¤ºå’Œæ¸²æŸ“é€Ÿåº¦ã€‚åœ¨SurfaceFlingerçš„ç”Ÿæˆè€…æ¶ˆè´¹è€…æ¨¡å‹ä¸­ï¼Œå½“ç¡¬ä»¶VSYNCä¿¡å·å‘ç”Ÿæ—¶ï¼ŒSurfaceFlingerä¼šå¼€å§‹è¯»å–ç¼“å†²åŒºä¸­çš„æ•°æ®ï¼Œå¹¶å°†å…¶æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚å› æ­¤ï¼Œå¦‚æœAndroidæ˜¾ç¤ºæ¡†æ¶åœ¨VSYNCå‰å®Œæˆäº†æ•°æ®å¤„ç†å’Œç»˜åˆ¶ï¼Œåˆ™å¯ä»¥å®ç°é›¶å»¶è¿Ÿçš„å›¾åƒæˆ–åŠ¨ç”»æ¸²æŸ“ã€‚ VSYNCæœºåˆ¶çš„ä¸»è¦ä¼˜ç‚¹æ˜¯å¯ä»¥é¿å…åœ¨å›¾åƒæ¸²æŸ“è¿‡ç¨‹ä¸­å‡ºç°å±å¹•æ’•è£‚å’Œå¡é¡¿ç°è±¡ï¼ŒåŒæ—¶ï¼Œä½¿ç”¨ç¡¬ä»¶ä¿¡å·ï¼Œå¯ä»¥ä½¿å›¾å½¢å’Œå›¾åƒå¤„ç†ä¸æ˜¾ç¤ºä¿æŒåŒæ­¥ï¼Œæé«˜æ˜¾ç¤ºæ•ˆæœå’Œæ¸²æŸ“æ€§èƒ½ã€‚ ç”±äºå›¾åƒç»˜åˆ¶å’Œå±å¹•è¯»å– ä½¿ç”¨çš„æ˜¯åŒä¸ªbufferï¼Œæ‰€ä»¥å±å¹•åˆ·æ–°æ—¶å¯èƒ½è¯»å–åˆ°çš„æ˜¯ä¸å®Œæ•´çš„ä¸€å¸§ç”»é¢ã€‚åŒç¼“å­˜ï¼Œè®©ç»˜åˆ¶å’Œæ˜¾ç¤ºå™¨æ‹¥æœ‰å„è‡ªçš„bufferï¼šGPU å§‹ç»ˆå°†å®Œæˆçš„ä¸€å¸§å›¾åƒæ•°æ®å†™å…¥åˆ° Back Bufferï¼Œè€Œæ˜¾ç¤ºå™¨ä½¿ç”¨ Frame Bufferï¼Œå½“å±å¹•åˆ·æ–°æ—¶ï¼ŒFrame Buffer å¹¶ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå½“Back bufferå‡†å¤‡å°±ç»ªåï¼Œå®ƒä»¬æ‰è¿›è¡Œäº¤æ¢ã€‚ ä»€ä¹ˆæ—¶å€™è¿›è¡Œä¸¤ä¸ªbufferçš„äº¤æ¢å‘¢ï¼Ÿ å½“æ‰«æå®Œä¸€å¸§ç”»é¢åï¼Œè®¾å¤‡éœ€è¦é‡æ–°å›åˆ°ç¬¬ä¸€è¡Œä»¥è¿›å…¥ä¸‹ä¸€æ¬¡çš„å¾ªç¯ï¼Œæ­¤æ—¶æœ‰ä¸€æ®µæ—¶é—´ç©ºéš™ï¼Œç§°ä¸ºVerticalBlanking Interval(VBI)ã€‚é‚£ï¼Œè¿™ä¸ªæ—¶é—´ç‚¹å°±æ˜¯æˆ‘ä»¬è¿›è¡Œç¼“å†²åŒºäº¤æ¢çš„æœ€ä½³æ—¶é—´ã€‚å› ä¸ºæ­¤æ—¶å±å¹•æ²¡æœ‰åœ¨åˆ·æ–°ï¼Œä¹Ÿå°±é¿å…äº†äº¤æ¢è¿‡ç¨‹ä¸­å‡ºç° screen tearingçš„çŠ¶å†µã€‚ VSYNC ä¿¡å·æ˜¯ç”±å±å¹•ï¼ˆæ˜¾ç¤ºè®¾å¤‡ï¼‰äº§ç”Ÿçš„ï¼Œåˆ©ç”¨VBIæ—¶æœŸå‡ºç°çš„vertical sync pulseï¼ˆå‚ç›´åŒæ­¥è„‰å†²ï¼‰æ¥ä¿è¯åŒç¼“å†²åœ¨æœ€ä½³æ—¶é—´ç‚¹æ‰è¿›è¡Œäº¤æ¢ã€‚å¹¶ä¸”ä»¥ 60fps çš„å›ºå®šé¢‘ç‡å‘é€ç»™ Android ç³»ç»Ÿï¼ŒAndroid ç³»ç»Ÿä¸­çš„ SurfaceFlinger æ¥æ”¶å‘é€çš„ VSYNC ä¿¡å·ã€‚VSYNC ä¿¡å·è¡¨æ˜å¯å¯¹å±å¹•è¿›è¡Œåˆ·æ–°è€Œä¸ä¼šäº§ç”Ÿæ’•è£‚ã€‚å¦å¤–ï¼Œäº¤æ¢æ˜¯æŒ‡å„è‡ªçš„å†…å­˜åœ°å€ï¼Œå¯ä»¥è®¤ä¸ºè¯¥æ“ä½œæ˜¯ç¬é—´å®Œæˆã€‚ Android 4.4ä¸Šåˆå¼•å…¥äº†Vsyncè™šæ‹ŸåŒ–ï¼Œé€šè¿‡DispSyncThreadæŠŠVsyncè™šæ‹ŸåŒ–æˆVsync-appå’ŒVsync-sfï¼ŒVsync-appå’ŒVsync-sfç›´æ¥æœ‰å›ºå®šçš„æ—¶æœºåç§»ï¼Œå„è‡ªåˆ†åˆ«æŒæ§ç€Appå’ŒSurfaceFlingerçš„å·¥ä½œèŠ‚å¥ï¼Œä»–ä»¬ä¸€å‰ä¸€åä¿æŒç€ç»˜åˆ¶ä»»åŠ¡çš„æµæ°´èŠ‚å¥ã€‚ CPU/GPUæ ¹æ®VSYNCä¿¡å·åŒæ­¥å¤„ç†æ•°æ®ï¼Œå¯ä»¥è®©CPU/GPUæœ‰å®Œæ•´çš„16msæ—¶é—´æ¥å¤„ç†æ•°æ®ï¼Œå‡å°‘äº†jankï¼ˆä¸¢å¸§ï¼‰ã€‚ ä¸€å¥è¯æ€»ç»“ï¼ŒVSyncåŒæ­¥ä½¿å¾—CPU/GPUå……åˆ†åˆ©ç”¨äº†16.6msæ—¶é—´ï¼Œå‡å°‘jankã€‚ åº”ç”¨åœ¨æ¯ä¸ªVsyncä¿¡å·åˆ°æ¥åéƒ½ä¼šé€šè¿‡dequeueBuffer/queueBufferæ¥ç”³è¯·bufferå’Œæäº¤ç»˜å›¾æ•°æ®ï¼ŒSurfaceflingeréƒ½ä¼šåœ¨ä¸‹ä¸€ä¸ªvsyncä¿¡å·åˆ°æ¥æ—¶å–èµ°bufferå»åšåˆæˆå’Œæ˜¾ç¤ºï¼Œ å¹¶åœ¨ä¸‹ä¸€ä¸‹ä¸ªvsyncæ—¶å°†bufferè¿˜å›æ¥ï¼Œå†æ¬¡å¾ªç¯ã€‚ ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#androidåœ¨ä»€ä¹ˆæ—¶å€™ä½¿ç”¨è½¯ä»¶æ¸²æŸ“ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ç¡¬ä»¶æ¸²æŸ“"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"äºŒã€Surfaceçš„æ¸²æŸ“ Androidç³»ç»Ÿçš„UIä»ç»˜åˆ¶åˆ°æ˜¾ç¤ºåœ¨å±å¹•ä¸Šå¯åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š 1ã€Android Appè¿›ç¨‹ï¼šå°†UIç»˜åˆ¶åˆ°ä¸€ä¸ªå›¾å½¢ç¼“å†²åŒºGraphicBufferä¸­ï¼Œç„¶åé€šçŸ¥SurfaceFlingerè¿›è¡Œåˆæˆã€‚ 2ã€SurfaceFlingerè¿›ç¨‹ï¼šå°†GraphicBufferæ•°æ®åˆæˆå¹¶äº¤ç»™å±å¹•ç¼“å†²åŒºå»æ˜¾ç¤ºï¼Œè¿™ä¸€æ­¥æœ¬èº«å°±æ˜¯é€šè¿‡è½¯ä»¶ï¼ˆSkiaï¼‰å’Œç¡¬ä»¶ï¼ˆOpen GLå’Œ HardWare Composerï¼‰å»å®Œæˆçš„ã€‚ è½¯ä»¶æ¸²æŸ“ä»‹ç» å½“Appæ›´æ–°éƒ¨åˆ†UIæ—¶ï¼ŒCPUä¼šéå†ViewTreeè®¡ç®—å¤„éœ€è¦é‡ç»˜çš„èµƒåŒºï¼Œæ¥ç€åœ¨Viewå±‚æ¬¡ç»“æ„ä¸­ç»˜åˆ¶æ‰€æœ‰è·Ÿè„åŒºç›¸äº¤çš„åŒºåŸŸï¼Œå› æ­¤è½¯ä»¶ç»˜åˆ¶ä¼šç»˜åˆ¶åˆ°ä¸éœ€è¦é‡ç»˜çš„è§†å›¾ã€‚ è½¯ä»¶ç»˜åˆ¶çš„ç»˜åˆ¶è¿‡ç¨‹æ˜¯åœ¨ä¸»çº¿ç¨‹è¿›è¡Œçš„ï¼Œå¯èƒ½ä¼šé€ æˆå¡é¡¿ç­‰æƒ…å†µã€‚ è½¯ä»¶ç»˜åˆ¶æŠŠè¦ç»˜åˆ¶çš„å†…å®¹å†™è¿›ä¸€ä¸ªBitmapä½å›¾ï¼Œåœ¨ä¹‹åçš„æ¸²æŸ“è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ªBitmapçš„åƒç´ å†…å®¹ä¼šå¡«å……åˆ°Surfaceçš„ç¼“å†²åŒºé‡Œã€‚ è½¯ä»¶ç»˜åˆ¶ä½¿ç”¨Skiaåº“ï¼ŒSkiaæ˜¯Googleå¼€å‘çš„ä¸€ä¸ªè·¨å¹³å°çš„2Då›¾å½¢åº“ï¼Œå®ƒæä¾›äº†ä¸€ç»„å¼ºå¤§çš„APIï¼Œå¯ä»¥å®ç°é«˜è´¨é‡çš„2Då›¾å½¢æ¸²æŸ“ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè½¯ä»¶æ¸²æŸ“çš„æ€§èƒ½ç›¸å¯¹è¾ƒä½ï¼Œè€Œä¸”å¯èƒ½ä¼šå› ä¸ºå¤§é‡çš„å›¾åƒè®¡ç®—è€Œå ç”¨å¤§é‡CPUèµ„æºï¼Œå¯¼è‡´åº”ç”¨ç¨‹åºçš„è¿è¡Œé€Ÿåº¦å˜æ…¢ã€‚ å¦‚ä¸‹ä¸ºè½¯ä»¶æ¸²æŸ“æµç¨‹ï¼š 1ã€æ„å»ºè§†å›¾æ ‘ï¼šAndroidåº”ç”¨ç¨‹åºä¸­çš„UIç”±è§†å›¾æ ‘æ¥ç»„ç»‡çš„ï¼Œé¦–å…ˆéœ€è¦æ„å»ºè§†å›¾æ ‘ã€‚ 2ã€è®¡ç®—å¸ƒå±€ï¼šåœ¨è·å¾—è§†å›¾æ ‘ä¹‹åï¼Œç³»ç»Ÿéœ€è¦è®¡ç®—æ¯ä¸ªè§†å›¾çš„å¤§å°å’Œä½ç½®ï¼Œå¹¶å°†å®ƒä»¬æ”¾ç½®åœ¨æ­£ç¡®çš„ä½ç½®ä¸Šï¼Œä»¥å®Œæˆå¸ƒå±€ã€‚ 3ã€ç»˜åˆ¶è§†å›¾ï¼šæ¥ä¸‹æ¥ï¼Œç³»ç»Ÿå°†å¼€å§‹ä½¿ç”¨è½¯ä»¶æ¸²æŸ“å¼•æ“(Skia)ï¼Œå¯¹æ¯ä¸€ä¸ªè§†å›¾è¿›è¡Œä¸»æ„ç»˜åˆ¶ï¼Œå³ä½¿ç”¨CPUæ‰§è¡Œå›¾åƒè®¡ç®—å¹¶å°†å›¾åƒæ¸²æŸ“åˆ°GraphicBufferä¸Šã€‚ 4ã€åˆæˆå›¾åƒï¼šå½“æ‰€æœ‰çš„è§†å›¾éƒ½ç»˜åˆ¶å®Œæˆåï¼ŒSurfaceFlingerä¼šå°†å®ƒä»¬åˆæˆåœ¨ä¸€èµ·ï¼Œç”Ÿæˆæœ€ç»ˆå±å¹•å›¾åƒï¼Œå¹¶å°†å…¶æ”¾åˆ°ä¸»æ˜¾ç¤ºç¼“å†²åŒºä¸­ã€‚ ç¡¬ä»¶æ¸²æŸ“ä»‹ç» å½“Appæ›´æ–°éƒ¨åˆ†UIæ—¶ï¼ŒCPUä¼šè®¡ç®—å‡ºè„åŒºï¼Œä½†æ˜¯ä¸ä¼šç«‹å³æ‰§è¡Œç»˜åˆ¶å‘½ä»¤ï¼Œè€Œæ˜¯å°†darwXXXå‡½æ•°ä½œä¸ºç»˜åˆ¶æŒ‡ä»¤(DrawOp)è®°å½•åœ¨ä¸€ä¸ªåˆ—è¡¨(DisplayListä¸­)ï¼Œç„¶åäº¤ç»™å•ç‹¬çš„Renderçº¿ç¨‹ä½¿ç”¨GPUè¿›è¡Œç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“ã€‚ åªéœ€è¦é’ˆå¯¹éœ€è¦æ›´æ–°çš„Viewå¯¹è±¡çš„è„åŒºè¿›è¡Œè®°å½•æˆ–æ›´æ–°ï¼Œæ— éœ€æ›´æ–°çš„Viewå¯¹è±¡åˆ™èƒ½é‡ç”¨å…ˆå‰DisplayListä¸­è®°å½•çš„æŒ‡ä»¤ã€‚ ç¡¬ä»¶åŠ é€Ÿæ˜¯åœ¨å•ç‹¬çš„Renderçº¿ç¨‹ä¸­ç»˜åˆ¶çš„ï¼Œåˆ†æ‹…äº†ä¸»çº¿ç¨‹çš„å‹åŠ›ï¼Œæé«˜äº†å“åº”é€Ÿåº¦ã€‚ ç¡¬ä»¶ç»˜åˆ¶ä½¿ç”¨OpenGLåœ¨GPUä¸Šå®Œæˆï¼ŒOpenGLæ˜¯è·¨å¹³å°çš„å›¾å½¢APIï¼Œä¸º2D/3Då›¾å½¢å¤„ç†ç¡¬ä»¶åˆ¶å®šäº†æ ‡å¿—çš„è½¯ä»¶æ¥å£ã€‚ å¦‚ä¸‹ä¸ºç¡¬ä»¶æ¸²æŸ“çš„æµç¨‹ï¼š 1ã€æ„å»ºè§†å›¾æ ‘ï¼šä¸è½¯ä»¶æ¸²æŸ“ä¸€æ ·ï¼Œç¡¬ä»¶æ¸²æŸ“ä¹Ÿéœ€è¦æ„å»ºåº”ç”¨ç¨‹åºçš„è§†å›¾æ ‘ã€‚ 2ã€è®¡ç®—å¸ƒå±€ï¼šä¸è½¯ä»¶æ¸²æŸ“ä¸€æ ·ï¼Œç¡¬ä»¶æ¸²æŸ“ä¹Ÿéœ€è¦å¯¹æ¯ä¸ªè§†å›¾è®¡ç®—å¸ƒå±€ã€‚ 3ã€åˆ›å»ºOpenGLçš„æ¸²æŸ“ä¸Šä¸‹æ–‡å’Œçº¹ç†ï¼šAndroidä½¿ç”¨OpenGL ESä½œä¸ºç¡¬ä»¶åŠ é€Ÿçš„æ¸²æŸ“å¼•æ“ã€‚å› æ­¤ï¼Œå½“ç¡¬ä»¶åŠ é€Ÿè¢«å¼€å¯æ—¶ï¼Œç³»ç»Ÿä¼šåˆ›å»ºOpenGLçš„æ¸²æŸ“ä¸Šä¸‹æ–‡ï¼ŒåŒæ—¶ä¸ºæ¯ä¸ªè§†å›¾åˆ†é…ä¸€ä¸ªæ¸²æŸ“çº¹ç†ã€‚ 4ã€ä¸Šä¼ çº¹ç†æ•°æ®ï¼šåœ¨è®¡ç®—å¥½è§†å›¾çš„å¸ƒå±€ä¹‹åï¼Œç³»ç»Ÿå°†è§†å›¾çš„å›¾åƒæ•°æ®ä¸Šä¼ åˆ°æ¸²æŸ“çº¹ç†ä¸­ã€‚è¿™é€šå¸¸ç”±GPUå®Œæˆã€‚ 5ã€ç»˜åˆ¶çº¹ç†ï¼šæœ€åï¼Œç³»ç»Ÿå°†è§†å›¾çš„æ¸²æŸ“çº¹ç†ç»‘å®šåˆ°OpenGLçš„æ¸²æŸ“ä¸Šä¸‹æ–‡ä¸­ï¼Œå¹¶æ‰§è¡ŒGPUè®¡ç®—ï¼Œå³ä½¿ç”¨GPUç»˜åˆ¶å›¾åƒã€‚ 6ã€åˆæˆå›¾åƒï¼šå½“æ‰€æœ‰çš„è§†å›¾éƒ½ç»˜åˆ¶å®Œæˆåï¼ŒSurfaceFlingerä¼šå°†å®ƒä»¬åˆæˆåœ¨ä¸€èµ·ï¼Œç”Ÿæˆæœ€ç»ˆå±å¹•å›¾åƒï¼Œå¹¶å°†å…¶æ”¾åˆ°ä¸»æ˜¾ç¤ºç¼“å†²åŒºä¸­ã€‚ Androidåœ¨ä»€ä¹ˆæ—¶å€™ä½¿ç”¨è½¯ä»¶æ¸²æŸ“ã€ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ç¡¬ä»¶æ¸²æŸ“ï¼Ÿ åœ¨Androidç³»ç»Ÿä¸­ï¼Œè½¯ä»¶æ¸²æŸ“å’Œç¡¬ä»¶æ¸²æŸ“æ˜¯æ ¹æ®åº”ç”¨ç¨‹åºçš„éœ€æ±‚å’Œè®¾å¤‡çš„æ€§èƒ½å†³å®šçš„çš„ã€‚é€šå¸¸æƒ…å†µï¼Œç³»ç»Ÿä¼šä¼˜å…ˆä½¿ç”¨ç¡¬ä»¶æ¸²æŸ“æ¥æé«˜å›¾å½¢çš„é€Ÿåº¦å’Œæ•ˆç‡ã€‚å¦‚æœç³»ç»Ÿæ£€æµ‹åˆ°è®¾å¤‡çš„GPUä¸æ”¯æŒæŸç§ç‰¹å®šçš„å›¾åƒç‰¹æ•ˆæˆ–åŠŸèƒ½ï¼Œæˆ–åœ¨ç¡¬ä»¶æ¸²æŸ“çš„è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼Œé‚£ä¹ˆç³»ç»Ÿå°†é€€å›åˆ°è½¯ä»¶æ¸²æŸ“ã€‚ä¸‹åˆ—æƒ…å†µå¯èƒ½è§¦å‘ç³»ç»Ÿä½¿ç”¨è½¯ä»¶æ¸²æŸ“ï¼š 1ã€è®¾å¤‡çš„GPUä¸æ”¯æŒå½“å‰åº”ç”¨ç¨‹åºçš„æŸäº›ç‰¹æ€§æˆ–å›¾åƒæ ¼å¼ã€‚ 2ã€å½“å‰åº”ç”¨ç¨‹åºéœ€è¦åœ¨å±å¹•ä¸Šå åŠ å¤šä¸ªå›¾åƒå±‚ï¼Œè€ŒGPUèƒ½åŠ›ä¸è¶³ä»¥å¤„ç†æ‰€æœ‰çš„å±‚çº§å åŠ ã€‚ 3ã€åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿå¯èƒ½ä¼šå¯¼è‡´åº”ç”¨ç¨‹åºå‡ºç°æ€§èƒ½é—®é¢˜ï¼Œæ­¤æ—¶ç³»ç»Ÿå¯èƒ½ä¼šåˆ‡æ¢åˆ°ä½¿ç”¨è½¯ä»¶æ¸²æŸ“ã€‚ SurfaceFlingerçš„åŒç¼“å†²ä¸VSYNCæœºåˆ¶ ç¼“å†²æœºåˆ¶ä»‹ç» æ˜¾ç¤ºç¼“å†²æœºåˆ¶æ˜¯æŒ‡å®šåœ¨è®¡ç®—æœºç³»ç»Ÿä¸­ï¼Œå°†æ˜¾ç¤ºæ•°æ®ç¼“å­˜åˆ°åˆ°å†…å­˜ä¸­ä»¥æé«˜å¤„ç†é€Ÿåº¦çš„ä¸€ç§è®¡ç®—ï¼Œåœ¨å›¾å½¢å’Œå›¾åƒå¤„ç†ä¸­ï¼Œæ˜¾ç¤ºç¼“å†²æœºåˆ¶å¯ä»¥æå‡å›¾åƒã€å›¾å½¢çš„æ¸²æŸ“æ•ˆç‡å’Œè´¨é‡ã€‚ åœ¨æ—©æœŸçš„Androidç‰ˆæœ¬ä¸­ï¼ŒSurfaceFlingerä½¿ç”¨çš„æ˜¯ä¸‰é‡ç¼“å†²åŒºæœºåˆ¶ï¼Œå³å‰å°ã€åå°å’Œæ˜¾ç¤ºä¸‰ä¸ªç¼“å†²åŒºã€‚ä»Android8.0å¼€å§‹ï¼ŒSurfaceFlingerè¯¥ä¸ºé‡‡ç”¨åŒç¼“å†²åŒºæœºåˆ¶ï¼Œåªæœ‰å‰å°å’Œåå°ä¸¤ä¸ªç¼“å†²åŒºã€‚é‡‡ç”¨ä¸‰é‡ç¼“å†²åŒºæœºåˆ¶çš„ä¼˜ç‚¹åœ¨äºå¯ä»¥å‡å°‘å±å¹•æ’•è£‚ç°è±¡çš„äº§ç”Ÿï¼Œæé«˜æ˜¾ç¤ºç”»é¢çš„è¿è´¯æ€§ã€‚ä½†åŒæ—¶å¢åŠ äº†å†…å­˜å ç”¨ï¼Œå› æ­¤åœ¨Android8.0åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ï¼Œä¸ºäº†æé«˜æ€§èƒ½å’Œå‡å°‘å†…å­˜å ç”¨ï¼ŒSurfaceFlingeræ”¹ä¸ºé‡‡ç”¨åŒç¼“å†²åŒºæœºåˆ¶ã€‚ åŒç¼“å†²åŒºæœºåˆ¶ä¸‹ï¼Œå‰å°ç¼“å†²åŒºç”¨äºæ˜¾ç¤ºå½“å‰å¸§çš„å†…å®¹ï¼Œåå°ç¼“å†²åŒºç”¨äºç»˜åˆ¶ä¸‹ä¸€å¸§çš„å†…å®¹ã€‚å½“ç»˜åˆ¶ä¸‹ä¸€å¸§å®Œæˆåï¼ŒSurfaceFlingerä¼šå°†åå°ç¼“å†²åŒºçš„å†…å®¹äº¤æ¢åˆ°å‰å°ç¼“å†²åŒºï¼Œä»è€Œå®ç°å¸§ä¸å¸§ä¹‹é—´çš„åˆ‡æ¢ã€‚è¿™ç§æœºåˆ¶å¯ä»¥å‡å°‘ä¸€æ¬¡ç¼“å†²åŒºçš„åˆ›å»ºåŠé”€æ¯æ“ä½œï¼Œä»¥æé«˜æ€§èƒ½å’Œè§£çº¦å†…å­˜ã€‚ ä¸‰é‡ç¼“å­˜æœºåˆ¶æ˜¯Androidä¸­çš„ä¸€ç§ä¼˜åŒ–æŠ€æœ¯ï¼Œç”¨äºæé«˜ç»˜åˆ¶æ€§èƒ½ã€‚å®ƒåŒ…æ‹¬å‰ç¼“å†²åŒºï¼ˆFront Bufferï¼‰ã€åç¼“å†²åŒºï¼ˆBack Bufferï¼‰å’Œæ˜¾ç¤ºç¼“å†²åŒºï¼ˆDisplay Bufferï¼‰ã€‚å‰ç¼“å†²åŒºç”¨äºæ˜¾ç¤ºå½“å‰å¸§ï¼Œåç¼“å†²åŒºç”¨äºç»˜åˆ¶ä¸‹ä¸€å¸§ï¼Œè€Œæ˜¾ç¤ºç¼“å†²åŒºåˆ™ç”¨äºå°†å‰ç¼“å†²åŒºçš„å†…å®¹æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚å½“VSYNCä¿¡å·åˆ°è¾¾æ—¶ï¼Œå‰ç¼“å†²åŒºå’Œåç¼“å†²åŒºä¼šè¿›è¡Œäº¤æ¢ï¼Œä»è€Œå®ç°æµç•…çš„æ˜¾ç¤ºæ•ˆæœã€‚ VSYNCæœºåˆ¶ä»‹ç» åœ¨å›¾å½¢å’Œå›¾åƒæ˜¾ç¤ºä¸­ï¼ŒVSYNCæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œå®ƒæ˜¯æŒ‡å‚ç›´åŒæ­¥ä¿¡å·ï¼Œç”¨äºæ§åˆ¶æ˜¾ç¤ºå™¨åˆ·æ–°ç‡å’Œæ˜¾ç¤ºæ—¶åºã€‚åœ¨Androidç³»ç»Ÿä¸­ï¼ŒVSYNCæœºåˆ¶è¢«å¹¿æ³›åº”ç”¨äºæ§åˆ¶å±å¹•æ˜¾ç¤ºå’ŒåŠ¨ç”»æ¸²æŸ“ï¼Œä»¥æé«˜æ˜¾ç¤ºæ•ˆæœå’Œæ€§èƒ½ã€‚ åœ¨Androidä¸­ï¼Œæ¯å°è®¾å¤‡éƒ½æœ‰ä¸€ä¸ªç¡¬ä»¶VSYNCä¿¡å·å‘ç”Ÿå™¨ï¼Œç”¨äºç”Ÿæˆæ’å®šçš„åˆ·æ–°ç‡ä¿¡å·ã€‚é€šå¸¸æƒ…å†µä¸‹è¿™ä¸ªä¿¡å·çš„åˆ·æ–°ç‡ä¸º60Hzæˆ–90Hzï¼ŒAndroidæ˜¾ç¤ºæ¡†æ¶å¯ä»¥æ ¹æ®è¿™ä¸ªä¿¡å·æ¥è°ƒæ•´è‡ªå·±çš„æ˜¾ç¤ºå’Œæ¸²æŸ“é€Ÿåº¦ã€‚åœ¨SurfaceFlingerçš„ç”Ÿæˆè€…æ¶ˆè´¹è€…æ¨¡å‹ä¸­ï¼Œå½“ç¡¬ä»¶VSYNCä¿¡å·å‘ç”Ÿæ—¶ï¼ŒSurfaceFlingerä¼šå¼€å§‹è¯»å–ç¼“å†²åŒºä¸­çš„æ•°æ®ï¼Œå¹¶å°†å…¶æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚å› æ­¤ï¼Œå¦‚æœAndroidæ˜¾ç¤ºæ¡†æ¶åœ¨VSYNCå‰å®Œæˆäº†æ•°æ®å¤„ç†å’Œç»˜åˆ¶ï¼Œåˆ™å¯ä»¥å®ç°é›¶å»¶è¿Ÿçš„å›¾åƒæˆ–åŠ¨ç”»æ¸²æŸ“ã€‚ VSYNCæœºåˆ¶çš„ä¸»è¦ä¼˜ç‚¹æ˜¯å¯ä»¥é¿å…åœ¨å›¾åƒæ¸²æŸ“è¿‡ç¨‹ä¸­å‡ºç°å±å¹•æ’•è£‚å’Œå¡é¡¿ç°è±¡ï¼ŒåŒæ—¶ï¼Œä½¿ç”¨ç¡¬ä»¶ä¿¡å·ï¼Œå¯ä»¥ä½¿å›¾å½¢å’Œå›¾åƒå¤„ç†ä¸æ˜¾ç¤ºä¿æŒåŒæ­¥ï¼Œæé«˜æ˜¾ç¤ºæ•ˆæœå’Œæ¸²æŸ“æ€§èƒ½ã€‚ ç”±äºå›¾åƒç»˜åˆ¶å’Œå±å¹•è¯»å– ä½¿ç”¨çš„æ˜¯åŒä¸ªbufferï¼Œæ‰€ä»¥å±å¹•åˆ·æ–°æ—¶å¯èƒ½è¯»å–åˆ°çš„æ˜¯ä¸å®Œæ•´çš„ä¸€å¸§ç”»é¢ã€‚åŒç¼“å­˜ï¼Œè®©ç»˜åˆ¶å’Œæ˜¾ç¤ºå™¨æ‹¥æœ‰å„è‡ªçš„bufferï¼šGPU å§‹ç»ˆå°†å®Œæˆçš„ä¸€å¸§å›¾åƒæ•°æ®å†™å…¥åˆ° Back Bufferï¼Œè€Œæ˜¾ç¤ºå™¨ä½¿ç”¨ Frame Bufferï¼Œå½“å±å¹•åˆ·æ–°æ—¶ï¼ŒFrame Buffer å¹¶ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå½“Back bufferå‡†å¤‡å°±ç»ªåï¼Œå®ƒä»¬æ‰è¿›è¡Œäº¤æ¢ã€‚ ä»€ä¹ˆæ—¶å€™è¿›è¡Œä¸¤ä¸ªbufferçš„äº¤æ¢å‘¢ï¼Ÿ å½“æ‰«æå®Œä¸€å¸§ç”»é¢åï¼Œè®¾å¤‡éœ€è¦é‡æ–°å›åˆ°ç¬¬ä¸€è¡Œä»¥è¿›å…¥ä¸‹ä¸€æ¬¡çš„å¾ªç¯ï¼Œæ­¤æ—¶æœ‰ä¸€æ®µæ—¶é—´ç©ºéš™ï¼Œç§°ä¸ºVerticalBlanking Interval(VBI)ã€‚é‚£ï¼Œè¿™ä¸ªæ—¶é—´ç‚¹å°±æ˜¯æˆ‘ä»¬è¿›è¡Œç¼“å†²åŒºäº¤æ¢çš„æœ€ä½³æ—¶é—´ã€‚å› ä¸ºæ­¤æ—¶å±å¹•æ²¡æœ‰åœ¨åˆ·æ–°ï¼Œä¹Ÿå°±é¿å…äº†äº¤æ¢è¿‡ç¨‹ä¸­å‡ºç° screen tearingçš„çŠ¶å†µã€‚ VSYNC ä¿¡å·æ˜¯ç”±å±å¹•ï¼ˆæ˜¾ç¤ºè®¾å¤‡ï¼‰äº§ç”Ÿçš„ï¼Œåˆ©ç”¨VBIæ—¶æœŸå‡ºç°çš„vertical sync pulseï¼ˆå‚ç›´åŒæ­¥è„‰å†²ï¼‰æ¥ä¿è¯åŒç¼“å†²åœ¨æœ€ä½³æ—¶é—´ç‚¹æ‰è¿›è¡Œäº¤æ¢ã€‚å¹¶ä¸”ä»¥ 60fps çš„å›ºå®šé¢‘ç‡å‘é€ç»™ Android ç³»ç»Ÿï¼ŒAndroid ç³»ç»Ÿä¸­çš„ SurfaceFlinger æ¥æ”¶å‘é€çš„ VSYNC ä¿¡å·ã€‚VSYNC ä¿¡å·è¡¨æ˜å¯å¯¹å±å¹•è¿›è¡Œåˆ·æ–°è€Œä¸ä¼šäº§ç”Ÿæ’•è£‚ã€‚å¦å¤–ï¼Œäº¤æ¢æ˜¯æŒ‡å„è‡ªçš„å†…å­˜åœ°å€ï¼Œå¯ä»¥è®¤ä¸ºè¯¥æ“ä½œæ˜¯ç¬é—´å®Œæˆã€‚ Android 4.4ä¸Šåˆå¼•å…¥äº†Vsyncè™šæ‹ŸåŒ–ï¼Œé€šè¿‡DispSyncThreadæŠŠVsyncè™šæ‹ŸåŒ–æˆVsync-appå’ŒVsync-sfï¼ŒVsync-appå’ŒVsync-sfç›´æ¥æœ‰å›ºå®šçš„æ—¶æœºåç§»ï¼Œå„è‡ªåˆ†åˆ«æŒæ§ç€Appå’ŒSurfaceFlingerçš„å·¥ä½œèŠ‚å¥ï¼Œä»–ä»¬ä¸€å‰ä¸€åä¿æŒç€ç»˜åˆ¶ä»»åŠ¡çš„æµæ°´èŠ‚å¥ã€‚ CPU/GPUæ ¹æ®VSYNCä¿¡å·åŒæ­¥å¤„ç†æ•°æ®ï¼Œå¯ä»¥è®©CPU/GPUæœ‰å®Œæ•´çš„16msæ—¶é—´æ¥å¤„ç†æ•°æ®ï¼Œå‡å°‘äº†jankï¼ˆä¸¢å¸§ï¼‰ã€‚ ä¸€å¥è¯æ€»ç»“ï¼ŒVSyncåŒæ­¥ä½¿å¾—CPU/GPUå……åˆ†åˆ©ç”¨äº†16.6msæ—¶é—´ï¼Œå‡å°‘jankã€‚ åº”ç”¨åœ¨æ¯ä¸ªVsyncä¿¡å·åˆ°æ¥åéƒ½ä¼šé€šè¿‡dequeueBuffer/queueBufferæ¥ç”³è¯·bufferå’Œæäº¤ç»˜å›¾æ•°æ®ï¼ŒSurfaceflingeréƒ½ä¼šåœ¨ä¸‹ä¸€ä¸ªvsyncä¿¡å·åˆ°æ¥æ—¶å–èµ°bufferå»åšåˆæˆå’Œæ˜¾ç¤ºï¼Œ å¹¶åœ¨ä¸‹ä¸€ä¸‹ä¸ªvsyncæ—¶å°†bufferè¿˜å›æ¥ï¼Œå†æ¬¡å¾ªç¯ã€‚ ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#surfaceflingerçš„åŒç¼“å†²ä¸vsyncæœºåˆ¶"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"äºŒã€Surfaceçš„æ¸²æŸ“ Androidç³»ç»Ÿçš„UIä»ç»˜åˆ¶åˆ°æ˜¾ç¤ºåœ¨å±å¹•ä¸Šå¯åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š 1ã€Android Appè¿›ç¨‹ï¼šå°†UIç»˜åˆ¶åˆ°ä¸€ä¸ªå›¾å½¢ç¼“å†²åŒºGraphicBufferä¸­ï¼Œç„¶åé€šçŸ¥SurfaceFlingerè¿›è¡Œåˆæˆã€‚ 2ã€SurfaceFlingerè¿›ç¨‹ï¼šå°†GraphicBufferæ•°æ®åˆæˆå¹¶äº¤ç»™å±å¹•ç¼“å†²åŒºå»æ˜¾ç¤ºï¼Œè¿™ä¸€æ­¥æœ¬èº«å°±æ˜¯é€šè¿‡è½¯ä»¶ï¼ˆSkiaï¼‰å’Œç¡¬ä»¶ï¼ˆOpen GLå’Œ HardWare Composerï¼‰å»å®Œæˆçš„ã€‚ è½¯ä»¶æ¸²æŸ“ä»‹ç» å½“Appæ›´æ–°éƒ¨åˆ†UIæ—¶ï¼ŒCPUä¼šéå†ViewTreeè®¡ç®—å¤„éœ€è¦é‡ç»˜çš„èµƒåŒºï¼Œæ¥ç€åœ¨Viewå±‚æ¬¡ç»“æ„ä¸­ç»˜åˆ¶æ‰€æœ‰è·Ÿè„åŒºç›¸äº¤çš„åŒºåŸŸï¼Œå› æ­¤è½¯ä»¶ç»˜åˆ¶ä¼šç»˜åˆ¶åˆ°ä¸éœ€è¦é‡ç»˜çš„è§†å›¾ã€‚ è½¯ä»¶ç»˜åˆ¶çš„ç»˜åˆ¶è¿‡ç¨‹æ˜¯åœ¨ä¸»çº¿ç¨‹è¿›è¡Œçš„ï¼Œå¯èƒ½ä¼šé€ æˆå¡é¡¿ç­‰æƒ…å†µã€‚ è½¯ä»¶ç»˜åˆ¶æŠŠè¦ç»˜åˆ¶çš„å†…å®¹å†™è¿›ä¸€ä¸ªBitmapä½å›¾ï¼Œåœ¨ä¹‹åçš„æ¸²æŸ“è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ªBitmapçš„åƒç´ å†…å®¹ä¼šå¡«å……åˆ°Surfaceçš„ç¼“å†²åŒºé‡Œã€‚ è½¯ä»¶ç»˜åˆ¶ä½¿ç”¨Skiaåº“ï¼ŒSkiaæ˜¯Googleå¼€å‘çš„ä¸€ä¸ªè·¨å¹³å°çš„2Då›¾å½¢åº“ï¼Œå®ƒæä¾›äº†ä¸€ç»„å¼ºå¤§çš„APIï¼Œå¯ä»¥å®ç°é«˜è´¨é‡çš„2Då›¾å½¢æ¸²æŸ“ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè½¯ä»¶æ¸²æŸ“çš„æ€§èƒ½ç›¸å¯¹è¾ƒä½ï¼Œè€Œä¸”å¯èƒ½ä¼šå› ä¸ºå¤§é‡çš„å›¾åƒè®¡ç®—è€Œå ç”¨å¤§é‡CPUèµ„æºï¼Œå¯¼è‡´åº”ç”¨ç¨‹åºçš„è¿è¡Œé€Ÿåº¦å˜æ…¢ã€‚ å¦‚ä¸‹ä¸ºè½¯ä»¶æ¸²æŸ“æµç¨‹ï¼š 1ã€æ„å»ºè§†å›¾æ ‘ï¼šAndroidåº”ç”¨ç¨‹åºä¸­çš„UIç”±è§†å›¾æ ‘æ¥ç»„ç»‡çš„ï¼Œé¦–å…ˆéœ€è¦æ„å»ºè§†å›¾æ ‘ã€‚ 2ã€è®¡ç®—å¸ƒå±€ï¼šåœ¨è·å¾—è§†å›¾æ ‘ä¹‹åï¼Œç³»ç»Ÿéœ€è¦è®¡ç®—æ¯ä¸ªè§†å›¾çš„å¤§å°å’Œä½ç½®ï¼Œå¹¶å°†å®ƒä»¬æ”¾ç½®åœ¨æ­£ç¡®çš„ä½ç½®ä¸Šï¼Œä»¥å®Œæˆå¸ƒå±€ã€‚ 3ã€ç»˜åˆ¶è§†å›¾ï¼šæ¥ä¸‹æ¥ï¼Œç³»ç»Ÿå°†å¼€å§‹ä½¿ç”¨è½¯ä»¶æ¸²æŸ“å¼•æ“(Skia)ï¼Œå¯¹æ¯ä¸€ä¸ªè§†å›¾è¿›è¡Œä¸»æ„ç»˜åˆ¶ï¼Œå³ä½¿ç”¨CPUæ‰§è¡Œå›¾åƒè®¡ç®—å¹¶å°†å›¾åƒæ¸²æŸ“åˆ°GraphicBufferä¸Šã€‚ 4ã€åˆæˆå›¾åƒï¼šå½“æ‰€æœ‰çš„è§†å›¾éƒ½ç»˜åˆ¶å®Œæˆåï¼ŒSurfaceFlingerä¼šå°†å®ƒä»¬åˆæˆåœ¨ä¸€èµ·ï¼Œç”Ÿæˆæœ€ç»ˆå±å¹•å›¾åƒï¼Œå¹¶å°†å…¶æ”¾åˆ°ä¸»æ˜¾ç¤ºç¼“å†²åŒºä¸­ã€‚ ç¡¬ä»¶æ¸²æŸ“ä»‹ç» å½“Appæ›´æ–°éƒ¨åˆ†UIæ—¶ï¼ŒCPUä¼šè®¡ç®—å‡ºè„åŒºï¼Œä½†æ˜¯ä¸ä¼šç«‹å³æ‰§è¡Œç»˜åˆ¶å‘½ä»¤ï¼Œè€Œæ˜¯å°†darwXXXå‡½æ•°ä½œä¸ºç»˜åˆ¶æŒ‡ä»¤(DrawOp)è®°å½•åœ¨ä¸€ä¸ªåˆ—è¡¨(DisplayListä¸­)ï¼Œç„¶åäº¤ç»™å•ç‹¬çš„Renderçº¿ç¨‹ä½¿ç”¨GPUè¿›è¡Œç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“ã€‚ åªéœ€è¦é’ˆå¯¹éœ€è¦æ›´æ–°çš„Viewå¯¹è±¡çš„è„åŒºè¿›è¡Œè®°å½•æˆ–æ›´æ–°ï¼Œæ— éœ€æ›´æ–°çš„Viewå¯¹è±¡åˆ™èƒ½é‡ç”¨å…ˆå‰DisplayListä¸­è®°å½•çš„æŒ‡ä»¤ã€‚ ç¡¬ä»¶åŠ é€Ÿæ˜¯åœ¨å•ç‹¬çš„Renderçº¿ç¨‹ä¸­ç»˜åˆ¶çš„ï¼Œåˆ†æ‹…äº†ä¸»çº¿ç¨‹çš„å‹åŠ›ï¼Œæé«˜äº†å“åº”é€Ÿåº¦ã€‚ ç¡¬ä»¶ç»˜åˆ¶ä½¿ç”¨OpenGLåœ¨GPUä¸Šå®Œæˆï¼ŒOpenGLæ˜¯è·¨å¹³å°çš„å›¾å½¢APIï¼Œä¸º2D/3Då›¾å½¢å¤„ç†ç¡¬ä»¶åˆ¶å®šäº†æ ‡å¿—çš„è½¯ä»¶æ¥å£ã€‚ å¦‚ä¸‹ä¸ºç¡¬ä»¶æ¸²æŸ“çš„æµç¨‹ï¼š 1ã€æ„å»ºè§†å›¾æ ‘ï¼šä¸è½¯ä»¶æ¸²æŸ“ä¸€æ ·ï¼Œç¡¬ä»¶æ¸²æŸ“ä¹Ÿéœ€è¦æ„å»ºåº”ç”¨ç¨‹åºçš„è§†å›¾æ ‘ã€‚ 2ã€è®¡ç®—å¸ƒå±€ï¼šä¸è½¯ä»¶æ¸²æŸ“ä¸€æ ·ï¼Œç¡¬ä»¶æ¸²æŸ“ä¹Ÿéœ€è¦å¯¹æ¯ä¸ªè§†å›¾è®¡ç®—å¸ƒå±€ã€‚ 3ã€åˆ›å»ºOpenGLçš„æ¸²æŸ“ä¸Šä¸‹æ–‡å’Œçº¹ç†ï¼šAndroidä½¿ç”¨OpenGL ESä½œä¸ºç¡¬ä»¶åŠ é€Ÿçš„æ¸²æŸ“å¼•æ“ã€‚å› æ­¤ï¼Œå½“ç¡¬ä»¶åŠ é€Ÿè¢«å¼€å¯æ—¶ï¼Œç³»ç»Ÿä¼šåˆ›å»ºOpenGLçš„æ¸²æŸ“ä¸Šä¸‹æ–‡ï¼ŒåŒæ—¶ä¸ºæ¯ä¸ªè§†å›¾åˆ†é…ä¸€ä¸ªæ¸²æŸ“çº¹ç†ã€‚ 4ã€ä¸Šä¼ çº¹ç†æ•°æ®ï¼šåœ¨è®¡ç®—å¥½è§†å›¾çš„å¸ƒå±€ä¹‹åï¼Œç³»ç»Ÿå°†è§†å›¾çš„å›¾åƒæ•°æ®ä¸Šä¼ åˆ°æ¸²æŸ“çº¹ç†ä¸­ã€‚è¿™é€šå¸¸ç”±GPUå®Œæˆã€‚ 5ã€ç»˜åˆ¶çº¹ç†ï¼šæœ€åï¼Œç³»ç»Ÿå°†è§†å›¾çš„æ¸²æŸ“çº¹ç†ç»‘å®šåˆ°OpenGLçš„æ¸²æŸ“ä¸Šä¸‹æ–‡ä¸­ï¼Œå¹¶æ‰§è¡ŒGPUè®¡ç®—ï¼Œå³ä½¿ç”¨GPUç»˜åˆ¶å›¾åƒã€‚ 6ã€åˆæˆå›¾åƒï¼šå½“æ‰€æœ‰çš„è§†å›¾éƒ½ç»˜åˆ¶å®Œæˆåï¼ŒSurfaceFlingerä¼šå°†å®ƒä»¬åˆæˆåœ¨ä¸€èµ·ï¼Œç”Ÿæˆæœ€ç»ˆå±å¹•å›¾åƒï¼Œå¹¶å°†å…¶æ”¾åˆ°ä¸»æ˜¾ç¤ºç¼“å†²åŒºä¸­ã€‚ Androidåœ¨ä»€ä¹ˆæ—¶å€™ä½¿ç”¨è½¯ä»¶æ¸²æŸ“ã€ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ç¡¬ä»¶æ¸²æŸ“ï¼Ÿ åœ¨Androidç³»ç»Ÿä¸­ï¼Œè½¯ä»¶æ¸²æŸ“å’Œç¡¬ä»¶æ¸²æŸ“æ˜¯æ ¹æ®åº”ç”¨ç¨‹åºçš„éœ€æ±‚å’Œè®¾å¤‡çš„æ€§èƒ½å†³å®šçš„çš„ã€‚é€šå¸¸æƒ…å†µï¼Œç³»ç»Ÿä¼šä¼˜å…ˆä½¿ç”¨ç¡¬ä»¶æ¸²æŸ“æ¥æé«˜å›¾å½¢çš„é€Ÿåº¦å’Œæ•ˆç‡ã€‚å¦‚æœç³»ç»Ÿæ£€æµ‹åˆ°è®¾å¤‡çš„GPUä¸æ”¯æŒæŸç§ç‰¹å®šçš„å›¾åƒç‰¹æ•ˆæˆ–åŠŸèƒ½ï¼Œæˆ–åœ¨ç¡¬ä»¶æ¸²æŸ“çš„è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼Œé‚£ä¹ˆç³»ç»Ÿå°†é€€å›åˆ°è½¯ä»¶æ¸²æŸ“ã€‚ä¸‹åˆ—æƒ…å†µå¯èƒ½è§¦å‘ç³»ç»Ÿä½¿ç”¨è½¯ä»¶æ¸²æŸ“ï¼š 1ã€è®¾å¤‡çš„GPUä¸æ”¯æŒå½“å‰åº”ç”¨ç¨‹åºçš„æŸäº›ç‰¹æ€§æˆ–å›¾åƒæ ¼å¼ã€‚ 2ã€å½“å‰åº”ç”¨ç¨‹åºéœ€è¦åœ¨å±å¹•ä¸Šå åŠ å¤šä¸ªå›¾åƒå±‚ï¼Œè€ŒGPUèƒ½åŠ›ä¸è¶³ä»¥å¤„ç†æ‰€æœ‰çš„å±‚çº§å åŠ ã€‚ 3ã€åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿå¯èƒ½ä¼šå¯¼è‡´åº”ç”¨ç¨‹åºå‡ºç°æ€§èƒ½é—®é¢˜ï¼Œæ­¤æ—¶ç³»ç»Ÿå¯èƒ½ä¼šåˆ‡æ¢åˆ°ä½¿ç”¨è½¯ä»¶æ¸²æŸ“ã€‚ SurfaceFlingerçš„åŒç¼“å†²ä¸VSYNCæœºåˆ¶ ç¼“å†²æœºåˆ¶ä»‹ç» æ˜¾ç¤ºç¼“å†²æœºåˆ¶æ˜¯æŒ‡å®šåœ¨è®¡ç®—æœºç³»ç»Ÿä¸­ï¼Œå°†æ˜¾ç¤ºæ•°æ®ç¼“å­˜åˆ°åˆ°å†…å­˜ä¸­ä»¥æé«˜å¤„ç†é€Ÿåº¦çš„ä¸€ç§è®¡ç®—ï¼Œåœ¨å›¾å½¢å’Œå›¾åƒå¤„ç†ä¸­ï¼Œæ˜¾ç¤ºç¼“å†²æœºåˆ¶å¯ä»¥æå‡å›¾åƒã€å›¾å½¢çš„æ¸²æŸ“æ•ˆç‡å’Œè´¨é‡ã€‚ åœ¨æ—©æœŸçš„Androidç‰ˆæœ¬ä¸­ï¼ŒSurfaceFlingerä½¿ç”¨çš„æ˜¯ä¸‰é‡ç¼“å†²åŒºæœºåˆ¶ï¼Œå³å‰å°ã€åå°å’Œæ˜¾ç¤ºä¸‰ä¸ªç¼“å†²åŒºã€‚ä»Android8.0å¼€å§‹ï¼ŒSurfaceFlingerè¯¥ä¸ºé‡‡ç”¨åŒç¼“å†²åŒºæœºåˆ¶ï¼Œåªæœ‰å‰å°å’Œåå°ä¸¤ä¸ªç¼“å†²åŒºã€‚é‡‡ç”¨ä¸‰é‡ç¼“å†²åŒºæœºåˆ¶çš„ä¼˜ç‚¹åœ¨äºå¯ä»¥å‡å°‘å±å¹•æ’•è£‚ç°è±¡çš„äº§ç”Ÿï¼Œæé«˜æ˜¾ç¤ºç”»é¢çš„è¿è´¯æ€§ã€‚ä½†åŒæ—¶å¢åŠ äº†å†…å­˜å ç”¨ï¼Œå› æ­¤åœ¨Android8.0åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ï¼Œä¸ºäº†æé«˜æ€§èƒ½å’Œå‡å°‘å†…å­˜å ç”¨ï¼ŒSurfaceFlingeræ”¹ä¸ºé‡‡ç”¨åŒç¼“å†²åŒºæœºåˆ¶ã€‚ åŒç¼“å†²åŒºæœºåˆ¶ä¸‹ï¼Œå‰å°ç¼“å†²åŒºç”¨äºæ˜¾ç¤ºå½“å‰å¸§çš„å†…å®¹ï¼Œåå°ç¼“å†²åŒºç”¨äºç»˜åˆ¶ä¸‹ä¸€å¸§çš„å†…å®¹ã€‚å½“ç»˜åˆ¶ä¸‹ä¸€å¸§å®Œæˆåï¼ŒSurfaceFlingerä¼šå°†åå°ç¼“å†²åŒºçš„å†…å®¹äº¤æ¢åˆ°å‰å°ç¼“å†²åŒºï¼Œä»è€Œå®ç°å¸§ä¸å¸§ä¹‹é—´çš„åˆ‡æ¢ã€‚è¿™ç§æœºåˆ¶å¯ä»¥å‡å°‘ä¸€æ¬¡ç¼“å†²åŒºçš„åˆ›å»ºåŠé”€æ¯æ“ä½œï¼Œä»¥æé«˜æ€§èƒ½å’Œè§£çº¦å†…å­˜ã€‚ ä¸‰é‡ç¼“å­˜æœºåˆ¶æ˜¯Androidä¸­çš„ä¸€ç§ä¼˜åŒ–æŠ€æœ¯ï¼Œç”¨äºæé«˜ç»˜åˆ¶æ€§èƒ½ã€‚å®ƒåŒ…æ‹¬å‰ç¼“å†²åŒºï¼ˆFront Bufferï¼‰ã€åç¼“å†²åŒºï¼ˆBack Bufferï¼‰å’Œæ˜¾ç¤ºç¼“å†²åŒºï¼ˆDisplay Bufferï¼‰ã€‚å‰ç¼“å†²åŒºç”¨äºæ˜¾ç¤ºå½“å‰å¸§ï¼Œåç¼“å†²åŒºç”¨äºç»˜åˆ¶ä¸‹ä¸€å¸§ï¼Œè€Œæ˜¾ç¤ºç¼“å†²åŒºåˆ™ç”¨äºå°†å‰ç¼“å†²åŒºçš„å†…å®¹æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚å½“VSYNCä¿¡å·åˆ°è¾¾æ—¶ï¼Œå‰ç¼“å†²åŒºå’Œåç¼“å†²åŒºä¼šè¿›è¡Œäº¤æ¢ï¼Œä»è€Œå®ç°æµç•…çš„æ˜¾ç¤ºæ•ˆæœã€‚ VSYNCæœºåˆ¶ä»‹ç» åœ¨å›¾å½¢å’Œå›¾åƒæ˜¾ç¤ºä¸­ï¼ŒVSYNCæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œå®ƒæ˜¯æŒ‡å‚ç›´åŒæ­¥ä¿¡å·ï¼Œç”¨äºæ§åˆ¶æ˜¾ç¤ºå™¨åˆ·æ–°ç‡å’Œæ˜¾ç¤ºæ—¶åºã€‚åœ¨Androidç³»ç»Ÿä¸­ï¼ŒVSYNCæœºåˆ¶è¢«å¹¿æ³›åº”ç”¨äºæ§åˆ¶å±å¹•æ˜¾ç¤ºå’ŒåŠ¨ç”»æ¸²æŸ“ï¼Œä»¥æé«˜æ˜¾ç¤ºæ•ˆæœå’Œæ€§èƒ½ã€‚ åœ¨Androidä¸­ï¼Œæ¯å°è®¾å¤‡éƒ½æœ‰ä¸€ä¸ªç¡¬ä»¶VSYNCä¿¡å·å‘ç”Ÿå™¨ï¼Œç”¨äºç”Ÿæˆæ’å®šçš„åˆ·æ–°ç‡ä¿¡å·ã€‚é€šå¸¸æƒ…å†µä¸‹è¿™ä¸ªä¿¡å·çš„åˆ·æ–°ç‡ä¸º60Hzæˆ–90Hzï¼ŒAndroidæ˜¾ç¤ºæ¡†æ¶å¯ä»¥æ ¹æ®è¿™ä¸ªä¿¡å·æ¥è°ƒæ•´è‡ªå·±çš„æ˜¾ç¤ºå’Œæ¸²æŸ“é€Ÿåº¦ã€‚åœ¨SurfaceFlingerçš„ç”Ÿæˆè€…æ¶ˆè´¹è€…æ¨¡å‹ä¸­ï¼Œå½“ç¡¬ä»¶VSYNCä¿¡å·å‘ç”Ÿæ—¶ï¼ŒSurfaceFlingerä¼šå¼€å§‹è¯»å–ç¼“å†²åŒºä¸­çš„æ•°æ®ï¼Œå¹¶å°†å…¶æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚å› æ­¤ï¼Œå¦‚æœAndroidæ˜¾ç¤ºæ¡†æ¶åœ¨VSYNCå‰å®Œæˆäº†æ•°æ®å¤„ç†å’Œç»˜åˆ¶ï¼Œåˆ™å¯ä»¥å®ç°é›¶å»¶è¿Ÿçš„å›¾åƒæˆ–åŠ¨ç”»æ¸²æŸ“ã€‚ VSYNCæœºåˆ¶çš„ä¸»è¦ä¼˜ç‚¹æ˜¯å¯ä»¥é¿å…åœ¨å›¾åƒæ¸²æŸ“è¿‡ç¨‹ä¸­å‡ºç°å±å¹•æ’•è£‚å’Œå¡é¡¿ç°è±¡ï¼ŒåŒæ—¶ï¼Œä½¿ç”¨ç¡¬ä»¶ä¿¡å·ï¼Œå¯ä»¥ä½¿å›¾å½¢å’Œå›¾åƒå¤„ç†ä¸æ˜¾ç¤ºä¿æŒåŒæ­¥ï¼Œæé«˜æ˜¾ç¤ºæ•ˆæœå’Œæ¸²æŸ“æ€§èƒ½ã€‚ ç”±äºå›¾åƒç»˜åˆ¶å’Œå±å¹•è¯»å– ä½¿ç”¨çš„æ˜¯åŒä¸ªbufferï¼Œæ‰€ä»¥å±å¹•åˆ·æ–°æ—¶å¯èƒ½è¯»å–åˆ°çš„æ˜¯ä¸å®Œæ•´çš„ä¸€å¸§ç”»é¢ã€‚åŒç¼“å­˜ï¼Œè®©ç»˜åˆ¶å’Œæ˜¾ç¤ºå™¨æ‹¥æœ‰å„è‡ªçš„bufferï¼šGPU å§‹ç»ˆå°†å®Œæˆçš„ä¸€å¸§å›¾åƒæ•°æ®å†™å…¥åˆ° Back Bufferï¼Œè€Œæ˜¾ç¤ºå™¨ä½¿ç”¨ Frame Bufferï¼Œå½“å±å¹•åˆ·æ–°æ—¶ï¼ŒFrame Buffer å¹¶ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå½“Back bufferå‡†å¤‡å°±ç»ªåï¼Œå®ƒä»¬æ‰è¿›è¡Œäº¤æ¢ã€‚ ä»€ä¹ˆæ—¶å€™è¿›è¡Œä¸¤ä¸ªbufferçš„äº¤æ¢å‘¢ï¼Ÿ å½“æ‰«æå®Œä¸€å¸§ç”»é¢åï¼Œè®¾å¤‡éœ€è¦é‡æ–°å›åˆ°ç¬¬ä¸€è¡Œä»¥è¿›å…¥ä¸‹ä¸€æ¬¡çš„å¾ªç¯ï¼Œæ­¤æ—¶æœ‰ä¸€æ®µæ—¶é—´ç©ºéš™ï¼Œç§°ä¸ºVerticalBlanking Interval(VBI)ã€‚é‚£ï¼Œè¿™ä¸ªæ—¶é—´ç‚¹å°±æ˜¯æˆ‘ä»¬è¿›è¡Œç¼“å†²åŒºäº¤æ¢çš„æœ€ä½³æ—¶é—´ã€‚å› ä¸ºæ­¤æ—¶å±å¹•æ²¡æœ‰åœ¨åˆ·æ–°ï¼Œä¹Ÿå°±é¿å…äº†äº¤æ¢è¿‡ç¨‹ä¸­å‡ºç° screen tearingçš„çŠ¶å†µã€‚ VSYNC ä¿¡å·æ˜¯ç”±å±å¹•ï¼ˆæ˜¾ç¤ºè®¾å¤‡ï¼‰äº§ç”Ÿçš„ï¼Œåˆ©ç”¨VBIæ—¶æœŸå‡ºç°çš„vertical sync pulseï¼ˆå‚ç›´åŒæ­¥è„‰å†²ï¼‰æ¥ä¿è¯åŒç¼“å†²åœ¨æœ€ä½³æ—¶é—´ç‚¹æ‰è¿›è¡Œäº¤æ¢ã€‚å¹¶ä¸”ä»¥ 60fps çš„å›ºå®šé¢‘ç‡å‘é€ç»™ Android ç³»ç»Ÿï¼ŒAndroid ç³»ç»Ÿä¸­çš„ SurfaceFlinger æ¥æ”¶å‘é€çš„ VSYNC ä¿¡å·ã€‚VSYNC ä¿¡å·è¡¨æ˜å¯å¯¹å±å¹•è¿›è¡Œåˆ·æ–°è€Œä¸ä¼šäº§ç”Ÿæ’•è£‚ã€‚å¦å¤–ï¼Œäº¤æ¢æ˜¯æŒ‡å„è‡ªçš„å†…å­˜åœ°å€ï¼Œå¯ä»¥è®¤ä¸ºè¯¥æ“ä½œæ˜¯ç¬é—´å®Œæˆã€‚ Android 4.4ä¸Šåˆå¼•å…¥äº†Vsyncè™šæ‹ŸåŒ–ï¼Œé€šè¿‡DispSyncThreadæŠŠVsyncè™šæ‹ŸåŒ–æˆVsync-appå’ŒVsync-sfï¼ŒVsync-appå’ŒVsync-sfç›´æ¥æœ‰å›ºå®šçš„æ—¶æœºåç§»ï¼Œå„è‡ªåˆ†åˆ«æŒæ§ç€Appå’ŒSurfaceFlingerçš„å·¥ä½œèŠ‚å¥ï¼Œä»–ä»¬ä¸€å‰ä¸€åä¿æŒç€ç»˜åˆ¶ä»»åŠ¡çš„æµæ°´èŠ‚å¥ã€‚ CPU/GPUæ ¹æ®VSYNCä¿¡å·åŒæ­¥å¤„ç†æ•°æ®ï¼Œå¯ä»¥è®©CPU/GPUæœ‰å®Œæ•´çš„16msæ—¶é—´æ¥å¤„ç†æ•°æ®ï¼Œå‡å°‘äº†jankï¼ˆä¸¢å¸§ï¼‰ã€‚ ä¸€å¥è¯æ€»ç»“ï¼ŒVSyncåŒæ­¥ä½¿å¾—CPU/GPUå……åˆ†åˆ©ç”¨äº†16.6msæ—¶é—´ï¼Œå‡å°‘jankã€‚ åº”ç”¨åœ¨æ¯ä¸ªVsyncä¿¡å·åˆ°æ¥åéƒ½ä¼šé€šè¿‡dequeueBuffer/queueBufferæ¥ç”³è¯·bufferå’Œæäº¤ç»˜å›¾æ•°æ®ï¼ŒSurfaceflingeréƒ½ä¼šåœ¨ä¸‹ä¸€ä¸ªvsyncä¿¡å·åˆ°æ¥æ—¶å–èµ°bufferå»åšåˆæˆå’Œæ˜¾ç¤ºï¼Œ å¹¶åœ¨ä¸‹ä¸€ä¸‹ä¸ªvsyncæ—¶å°†bufferè¿˜å›æ¥ï¼Œå†æ¬¡å¾ªç¯ã€‚ ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#ç¼“å†²æœºåˆ¶ä»‹ç»"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"äºŒã€Surfaceçš„æ¸²æŸ“ Androidç³»ç»Ÿçš„UIä»ç»˜åˆ¶åˆ°æ˜¾ç¤ºåœ¨å±å¹•ä¸Šå¯åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š 1ã€Android Appè¿›ç¨‹ï¼šå°†UIç»˜åˆ¶åˆ°ä¸€ä¸ªå›¾å½¢ç¼“å†²åŒºGraphicBufferä¸­ï¼Œç„¶åé€šçŸ¥SurfaceFlingerè¿›è¡Œåˆæˆã€‚ 2ã€SurfaceFlingerè¿›ç¨‹ï¼šå°†GraphicBufferæ•°æ®åˆæˆå¹¶äº¤ç»™å±å¹•ç¼“å†²åŒºå»æ˜¾ç¤ºï¼Œè¿™ä¸€æ­¥æœ¬èº«å°±æ˜¯é€šè¿‡è½¯ä»¶ï¼ˆSkiaï¼‰å’Œç¡¬ä»¶ï¼ˆOpen GLå’Œ HardWare Composerï¼‰å»å®Œæˆçš„ã€‚ è½¯ä»¶æ¸²æŸ“ä»‹ç» å½“Appæ›´æ–°éƒ¨åˆ†UIæ—¶ï¼ŒCPUä¼šéå†ViewTreeè®¡ç®—å¤„éœ€è¦é‡ç»˜çš„èµƒåŒºï¼Œæ¥ç€åœ¨Viewå±‚æ¬¡ç»“æ„ä¸­ç»˜åˆ¶æ‰€æœ‰è·Ÿè„åŒºç›¸äº¤çš„åŒºåŸŸï¼Œå› æ­¤è½¯ä»¶ç»˜åˆ¶ä¼šç»˜åˆ¶åˆ°ä¸éœ€è¦é‡ç»˜çš„è§†å›¾ã€‚ è½¯ä»¶ç»˜åˆ¶çš„ç»˜åˆ¶è¿‡ç¨‹æ˜¯åœ¨ä¸»çº¿ç¨‹è¿›è¡Œçš„ï¼Œå¯èƒ½ä¼šé€ æˆå¡é¡¿ç­‰æƒ…å†µã€‚ è½¯ä»¶ç»˜åˆ¶æŠŠè¦ç»˜åˆ¶çš„å†…å®¹å†™è¿›ä¸€ä¸ªBitmapä½å›¾ï¼Œåœ¨ä¹‹åçš„æ¸²æŸ“è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸ªBitmapçš„åƒç´ å†…å®¹ä¼šå¡«å……åˆ°Surfaceçš„ç¼“å†²åŒºé‡Œã€‚ è½¯ä»¶ç»˜åˆ¶ä½¿ç”¨Skiaåº“ï¼ŒSkiaæ˜¯Googleå¼€å‘çš„ä¸€ä¸ªè·¨å¹³å°çš„2Då›¾å½¢åº“ï¼Œå®ƒæä¾›äº†ä¸€ç»„å¼ºå¤§çš„APIï¼Œå¯ä»¥å®ç°é«˜è´¨é‡çš„2Då›¾å½¢æ¸²æŸ“ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè½¯ä»¶æ¸²æŸ“çš„æ€§èƒ½ç›¸å¯¹è¾ƒä½ï¼Œè€Œä¸”å¯èƒ½ä¼šå› ä¸ºå¤§é‡çš„å›¾åƒè®¡ç®—è€Œå ç”¨å¤§é‡CPUèµ„æºï¼Œå¯¼è‡´åº”ç”¨ç¨‹åºçš„è¿è¡Œé€Ÿåº¦å˜æ…¢ã€‚ å¦‚ä¸‹ä¸ºè½¯ä»¶æ¸²æŸ“æµç¨‹ï¼š 1ã€æ„å»ºè§†å›¾æ ‘ï¼šAndroidåº”ç”¨ç¨‹åºä¸­çš„UIç”±è§†å›¾æ ‘æ¥ç»„ç»‡çš„ï¼Œé¦–å…ˆéœ€è¦æ„å»ºè§†å›¾æ ‘ã€‚ 2ã€è®¡ç®—å¸ƒå±€ï¼šåœ¨è·å¾—è§†å›¾æ ‘ä¹‹åï¼Œç³»ç»Ÿéœ€è¦è®¡ç®—æ¯ä¸ªè§†å›¾çš„å¤§å°å’Œä½ç½®ï¼Œå¹¶å°†å®ƒä»¬æ”¾ç½®åœ¨æ­£ç¡®çš„ä½ç½®ä¸Šï¼Œä»¥å®Œæˆå¸ƒå±€ã€‚ 3ã€ç»˜åˆ¶è§†å›¾ï¼šæ¥ä¸‹æ¥ï¼Œç³»ç»Ÿå°†å¼€å§‹ä½¿ç”¨è½¯ä»¶æ¸²æŸ“å¼•æ“(Skia)ï¼Œå¯¹æ¯ä¸€ä¸ªè§†å›¾è¿›è¡Œä¸»æ„ç»˜åˆ¶ï¼Œå³ä½¿ç”¨CPUæ‰§è¡Œå›¾åƒè®¡ç®—å¹¶å°†å›¾åƒæ¸²æŸ“åˆ°GraphicBufferä¸Šã€‚ 4ã€åˆæˆå›¾åƒï¼šå½“æ‰€æœ‰çš„è§†å›¾éƒ½ç»˜åˆ¶å®Œæˆåï¼ŒSurfaceFlingerä¼šå°†å®ƒä»¬åˆæˆåœ¨ä¸€èµ·ï¼Œç”Ÿæˆæœ€ç»ˆå±å¹•å›¾åƒï¼Œå¹¶å°†å…¶æ”¾åˆ°ä¸»æ˜¾ç¤ºç¼“å†²åŒºä¸­ã€‚ ç¡¬ä»¶æ¸²æŸ“ä»‹ç» å½“Appæ›´æ–°éƒ¨åˆ†UIæ—¶ï¼ŒCPUä¼šè®¡ç®—å‡ºè„åŒºï¼Œä½†æ˜¯ä¸ä¼šç«‹å³æ‰§è¡Œç»˜åˆ¶å‘½ä»¤ï¼Œè€Œæ˜¯å°†darwXXXå‡½æ•°ä½œä¸ºç»˜åˆ¶æŒ‡ä»¤(DrawOp)è®°å½•åœ¨ä¸€ä¸ªåˆ—è¡¨(DisplayListä¸­)ï¼Œç„¶åäº¤ç»™å•ç‹¬çš„Renderçº¿ç¨‹ä½¿ç”¨GPUè¿›è¡Œç¡¬ä»¶åŠ é€Ÿæ¸²æŸ“ã€‚ åªéœ€è¦é’ˆå¯¹éœ€è¦æ›´æ–°çš„Viewå¯¹è±¡çš„è„åŒºè¿›è¡Œè®°å½•æˆ–æ›´æ–°ï¼Œæ— éœ€æ›´æ–°çš„Viewå¯¹è±¡åˆ™èƒ½é‡ç”¨å…ˆå‰DisplayListä¸­è®°å½•çš„æŒ‡ä»¤ã€‚ ç¡¬ä»¶åŠ é€Ÿæ˜¯åœ¨å•ç‹¬çš„Renderçº¿ç¨‹ä¸­ç»˜åˆ¶çš„ï¼Œåˆ†æ‹…äº†ä¸»çº¿ç¨‹çš„å‹åŠ›ï¼Œæé«˜äº†å“åº”é€Ÿåº¦ã€‚ ç¡¬ä»¶ç»˜åˆ¶ä½¿ç”¨OpenGLåœ¨GPUä¸Šå®Œæˆï¼ŒOpenGLæ˜¯è·¨å¹³å°çš„å›¾å½¢APIï¼Œä¸º2D/3Då›¾å½¢å¤„ç†ç¡¬ä»¶åˆ¶å®šäº†æ ‡å¿—çš„è½¯ä»¶æ¥å£ã€‚ å¦‚ä¸‹ä¸ºç¡¬ä»¶æ¸²æŸ“çš„æµç¨‹ï¼š 1ã€æ„å»ºè§†å›¾æ ‘ï¼šä¸è½¯ä»¶æ¸²æŸ“ä¸€æ ·ï¼Œç¡¬ä»¶æ¸²æŸ“ä¹Ÿéœ€è¦æ„å»ºåº”ç”¨ç¨‹åºçš„è§†å›¾æ ‘ã€‚ 2ã€è®¡ç®—å¸ƒå±€ï¼šä¸è½¯ä»¶æ¸²æŸ“ä¸€æ ·ï¼Œç¡¬ä»¶æ¸²æŸ“ä¹Ÿéœ€è¦å¯¹æ¯ä¸ªè§†å›¾è®¡ç®—å¸ƒå±€ã€‚ 3ã€åˆ›å»ºOpenGLçš„æ¸²æŸ“ä¸Šä¸‹æ–‡å’Œçº¹ç†ï¼šAndroidä½¿ç”¨OpenGL ESä½œä¸ºç¡¬ä»¶åŠ é€Ÿçš„æ¸²æŸ“å¼•æ“ã€‚å› æ­¤ï¼Œå½“ç¡¬ä»¶åŠ é€Ÿè¢«å¼€å¯æ—¶ï¼Œç³»ç»Ÿä¼šåˆ›å»ºOpenGLçš„æ¸²æŸ“ä¸Šä¸‹æ–‡ï¼ŒåŒæ—¶ä¸ºæ¯ä¸ªè§†å›¾åˆ†é…ä¸€ä¸ªæ¸²æŸ“çº¹ç†ã€‚ 4ã€ä¸Šä¼ çº¹ç†æ•°æ®ï¼šåœ¨è®¡ç®—å¥½è§†å›¾çš„å¸ƒå±€ä¹‹åï¼Œç³»ç»Ÿå°†è§†å›¾çš„å›¾åƒæ•°æ®ä¸Šä¼ åˆ°æ¸²æŸ“çº¹ç†ä¸­ã€‚è¿™é€šå¸¸ç”±GPUå®Œæˆã€‚ 5ã€ç»˜åˆ¶çº¹ç†ï¼šæœ€åï¼Œç³»ç»Ÿå°†è§†å›¾çš„æ¸²æŸ“çº¹ç†ç»‘å®šåˆ°OpenGLçš„æ¸²æŸ“ä¸Šä¸‹æ–‡ä¸­ï¼Œå¹¶æ‰§è¡ŒGPUè®¡ç®—ï¼Œå³ä½¿ç”¨GPUç»˜åˆ¶å›¾åƒã€‚ 6ã€åˆæˆå›¾åƒï¼šå½“æ‰€æœ‰çš„è§†å›¾éƒ½ç»˜åˆ¶å®Œæˆåï¼ŒSurfaceFlingerä¼šå°†å®ƒä»¬åˆæˆåœ¨ä¸€èµ·ï¼Œç”Ÿæˆæœ€ç»ˆå±å¹•å›¾åƒï¼Œå¹¶å°†å…¶æ”¾åˆ°ä¸»æ˜¾ç¤ºç¼“å†²åŒºä¸­ã€‚ Androidåœ¨ä»€ä¹ˆæ—¶å€™ä½¿ç”¨è½¯ä»¶æ¸²æŸ“ã€ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ç¡¬ä»¶æ¸²æŸ“ï¼Ÿ åœ¨Androidç³»ç»Ÿä¸­ï¼Œè½¯ä»¶æ¸²æŸ“å’Œç¡¬ä»¶æ¸²æŸ“æ˜¯æ ¹æ®åº”ç”¨ç¨‹åºçš„éœ€æ±‚å’Œè®¾å¤‡çš„æ€§èƒ½å†³å®šçš„çš„ã€‚é€šå¸¸æƒ…å†µï¼Œç³»ç»Ÿä¼šä¼˜å…ˆä½¿ç”¨ç¡¬ä»¶æ¸²æŸ“æ¥æé«˜å›¾å½¢çš„é€Ÿåº¦å’Œæ•ˆç‡ã€‚å¦‚æœç³»ç»Ÿæ£€æµ‹åˆ°è®¾å¤‡çš„GPUä¸æ”¯æŒæŸç§ç‰¹å®šçš„å›¾åƒç‰¹æ•ˆæˆ–åŠŸèƒ½ï¼Œæˆ–åœ¨ç¡¬ä»¶æ¸²æŸ“çš„è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼Œé‚£ä¹ˆç³»ç»Ÿå°†é€€å›åˆ°è½¯ä»¶æ¸²æŸ“ã€‚ä¸‹åˆ—æƒ…å†µå¯èƒ½è§¦å‘ç³»ç»Ÿä½¿ç”¨è½¯ä»¶æ¸²æŸ“ï¼š 1ã€è®¾å¤‡çš„GPUä¸æ”¯æŒå½“å‰åº”ç”¨ç¨‹åºçš„æŸäº›ç‰¹æ€§æˆ–å›¾åƒæ ¼å¼ã€‚ 2ã€å½“å‰åº”ç”¨ç¨‹åºéœ€è¦åœ¨å±å¹•ä¸Šå åŠ å¤šä¸ªå›¾åƒå±‚ï¼Œè€ŒGPUèƒ½åŠ›ä¸è¶³ä»¥å¤„ç†æ‰€æœ‰çš„å±‚çº§å åŠ ã€‚ 3ã€åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½¿ç”¨ç¡¬ä»¶åŠ é€Ÿå¯èƒ½ä¼šå¯¼è‡´åº”ç”¨ç¨‹åºå‡ºç°æ€§èƒ½é—®é¢˜ï¼Œæ­¤æ—¶ç³»ç»Ÿå¯èƒ½ä¼šåˆ‡æ¢åˆ°ä½¿ç”¨è½¯ä»¶æ¸²æŸ“ã€‚ SurfaceFlingerçš„åŒç¼“å†²ä¸VSYNCæœºåˆ¶ ç¼“å†²æœºåˆ¶ä»‹ç» æ˜¾ç¤ºç¼“å†²æœºåˆ¶æ˜¯æŒ‡å®šåœ¨è®¡ç®—æœºç³»ç»Ÿä¸­ï¼Œå°†æ˜¾ç¤ºæ•°æ®ç¼“å­˜åˆ°åˆ°å†…å­˜ä¸­ä»¥æé«˜å¤„ç†é€Ÿåº¦çš„ä¸€ç§è®¡ç®—ï¼Œåœ¨å›¾å½¢å’Œå›¾åƒå¤„ç†ä¸­ï¼Œæ˜¾ç¤ºç¼“å†²æœºåˆ¶å¯ä»¥æå‡å›¾åƒã€å›¾å½¢çš„æ¸²æŸ“æ•ˆç‡å’Œè´¨é‡ã€‚ åœ¨æ—©æœŸçš„Androidç‰ˆæœ¬ä¸­ï¼ŒSurfaceFlingerä½¿ç”¨çš„æ˜¯ä¸‰é‡ç¼“å†²åŒºæœºåˆ¶ï¼Œå³å‰å°ã€åå°å’Œæ˜¾ç¤ºä¸‰ä¸ªç¼“å†²åŒºã€‚ä»Android8.0å¼€å§‹ï¼ŒSurfaceFlingerè¯¥ä¸ºé‡‡ç”¨åŒç¼“å†²åŒºæœºåˆ¶ï¼Œåªæœ‰å‰å°å’Œåå°ä¸¤ä¸ªç¼“å†²åŒºã€‚é‡‡ç”¨ä¸‰é‡ç¼“å†²åŒºæœºåˆ¶çš„ä¼˜ç‚¹åœ¨äºå¯ä»¥å‡å°‘å±å¹•æ’•è£‚ç°è±¡çš„äº§ç”Ÿï¼Œæé«˜æ˜¾ç¤ºç”»é¢çš„è¿è´¯æ€§ã€‚ä½†åŒæ—¶å¢åŠ äº†å†…å­˜å ç”¨ï¼Œå› æ­¤åœ¨Android8.0åŠä»¥ä¸Šç‰ˆæœ¬ä¸­ï¼Œä¸ºäº†æé«˜æ€§èƒ½å’Œå‡å°‘å†…å­˜å ç”¨ï¼ŒSurfaceFlingeræ”¹ä¸ºé‡‡ç”¨åŒç¼“å†²åŒºæœºåˆ¶ã€‚ åŒç¼“å†²åŒºæœºåˆ¶ä¸‹ï¼Œå‰å°ç¼“å†²åŒºç”¨äºæ˜¾ç¤ºå½“å‰å¸§çš„å†…å®¹ï¼Œåå°ç¼“å†²åŒºç”¨äºç»˜åˆ¶ä¸‹ä¸€å¸§çš„å†…å®¹ã€‚å½“ç»˜åˆ¶ä¸‹ä¸€å¸§å®Œæˆåï¼ŒSurfaceFlingerä¼šå°†åå°ç¼“å†²åŒºçš„å†…å®¹äº¤æ¢åˆ°å‰å°ç¼“å†²åŒºï¼Œä»è€Œå®ç°å¸§ä¸å¸§ä¹‹é—´çš„åˆ‡æ¢ã€‚è¿™ç§æœºåˆ¶å¯ä»¥å‡å°‘ä¸€æ¬¡ç¼“å†²åŒºçš„åˆ›å»ºåŠé”€æ¯æ“ä½œï¼Œä»¥æé«˜æ€§èƒ½å’Œè§£çº¦å†…å­˜ã€‚ ä¸‰é‡ç¼“å­˜æœºåˆ¶æ˜¯Androidä¸­çš„ä¸€ç§ä¼˜åŒ–æŠ€æœ¯ï¼Œç”¨äºæé«˜ç»˜åˆ¶æ€§èƒ½ã€‚å®ƒåŒ…æ‹¬å‰ç¼“å†²åŒºï¼ˆFront Bufferï¼‰ã€åç¼“å†²åŒºï¼ˆBack Bufferï¼‰å’Œæ˜¾ç¤ºç¼“å†²åŒºï¼ˆDisplay Bufferï¼‰ã€‚å‰ç¼“å†²åŒºç”¨äºæ˜¾ç¤ºå½“å‰å¸§ï¼Œåç¼“å†²åŒºç”¨äºç»˜åˆ¶ä¸‹ä¸€å¸§ï¼Œè€Œæ˜¾ç¤ºç¼“å†²åŒºåˆ™ç”¨äºå°†å‰ç¼“å†²åŒºçš„å†…å®¹æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚å½“VSYNCä¿¡å·åˆ°è¾¾æ—¶ï¼Œå‰ç¼“å†²åŒºå’Œåç¼“å†²åŒºä¼šè¿›è¡Œäº¤æ¢ï¼Œä»è€Œå®ç°æµç•…çš„æ˜¾ç¤ºæ•ˆæœã€‚ VSYNCæœºåˆ¶ä»‹ç» åœ¨å›¾å½¢å’Œå›¾åƒæ˜¾ç¤ºä¸­ï¼ŒVSYNCæ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œå®ƒæ˜¯æŒ‡å‚ç›´åŒæ­¥ä¿¡å·ï¼Œç”¨äºæ§åˆ¶æ˜¾ç¤ºå™¨åˆ·æ–°ç‡å’Œæ˜¾ç¤ºæ—¶åºã€‚åœ¨Androidç³»ç»Ÿä¸­ï¼ŒVSYNCæœºåˆ¶è¢«å¹¿æ³›åº”ç”¨äºæ§åˆ¶å±å¹•æ˜¾ç¤ºå’ŒåŠ¨ç”»æ¸²æŸ“ï¼Œä»¥æé«˜æ˜¾ç¤ºæ•ˆæœå’Œæ€§èƒ½ã€‚ åœ¨Androidä¸­ï¼Œæ¯å°è®¾å¤‡éƒ½æœ‰ä¸€ä¸ªç¡¬ä»¶VSYNCä¿¡å·å‘ç”Ÿå™¨ï¼Œç”¨äºç”Ÿæˆæ’å®šçš„åˆ·æ–°ç‡ä¿¡å·ã€‚é€šå¸¸æƒ…å†µä¸‹è¿™ä¸ªä¿¡å·çš„åˆ·æ–°ç‡ä¸º60Hzæˆ–90Hzï¼ŒAndroidæ˜¾ç¤ºæ¡†æ¶å¯ä»¥æ ¹æ®è¿™ä¸ªä¿¡å·æ¥è°ƒæ•´è‡ªå·±çš„æ˜¾ç¤ºå’Œæ¸²æŸ“é€Ÿåº¦ã€‚åœ¨SurfaceFlingerçš„ç”Ÿæˆè€…æ¶ˆè´¹è€…æ¨¡å‹ä¸­ï¼Œå½“ç¡¬ä»¶VSYNCä¿¡å·å‘ç”Ÿæ—¶ï¼ŒSurfaceFlingerä¼šå¼€å§‹è¯»å–ç¼“å†²åŒºä¸­çš„æ•°æ®ï¼Œå¹¶å°†å…¶æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚å› æ­¤ï¼Œå¦‚æœAndroidæ˜¾ç¤ºæ¡†æ¶åœ¨VSYNCå‰å®Œæˆäº†æ•°æ®å¤„ç†å’Œç»˜åˆ¶ï¼Œåˆ™å¯ä»¥å®ç°é›¶å»¶è¿Ÿçš„å›¾åƒæˆ–åŠ¨ç”»æ¸²æŸ“ã€‚ VSYNCæœºåˆ¶çš„ä¸»è¦ä¼˜ç‚¹æ˜¯å¯ä»¥é¿å…åœ¨å›¾åƒæ¸²æŸ“è¿‡ç¨‹ä¸­å‡ºç°å±å¹•æ’•è£‚å’Œå¡é¡¿ç°è±¡ï¼ŒåŒæ—¶ï¼Œä½¿ç”¨ç¡¬ä»¶ä¿¡å·ï¼Œå¯ä»¥ä½¿å›¾å½¢å’Œå›¾åƒå¤„ç†ä¸æ˜¾ç¤ºä¿æŒåŒæ­¥ï¼Œæé«˜æ˜¾ç¤ºæ•ˆæœå’Œæ¸²æŸ“æ€§èƒ½ã€‚ ç”±äºå›¾åƒç»˜åˆ¶å’Œå±å¹•è¯»å– ä½¿ç”¨çš„æ˜¯åŒä¸ªbufferï¼Œæ‰€ä»¥å±å¹•åˆ·æ–°æ—¶å¯èƒ½è¯»å–åˆ°çš„æ˜¯ä¸å®Œæ•´çš„ä¸€å¸§ç”»é¢ã€‚åŒç¼“å­˜ï¼Œè®©ç»˜åˆ¶å’Œæ˜¾ç¤ºå™¨æ‹¥æœ‰å„è‡ªçš„bufferï¼šGPU å§‹ç»ˆå°†å®Œæˆçš„ä¸€å¸§å›¾åƒæ•°æ®å†™å…¥åˆ° Back Bufferï¼Œè€Œæ˜¾ç¤ºå™¨ä½¿ç”¨ Frame Bufferï¼Œå½“å±å¹•åˆ·æ–°æ—¶ï¼ŒFrame Buffer å¹¶ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå½“Back bufferå‡†å¤‡å°±ç»ªåï¼Œå®ƒä»¬æ‰è¿›è¡Œäº¤æ¢ã€‚ ä»€ä¹ˆæ—¶å€™è¿›è¡Œä¸¤ä¸ªbufferçš„äº¤æ¢å‘¢ï¼Ÿ å½“æ‰«æå®Œä¸€å¸§ç”»é¢åï¼Œè®¾å¤‡éœ€è¦é‡æ–°å›åˆ°ç¬¬ä¸€è¡Œä»¥è¿›å…¥ä¸‹ä¸€æ¬¡çš„å¾ªç¯ï¼Œæ­¤æ—¶æœ‰ä¸€æ®µæ—¶é—´ç©ºéš™ï¼Œç§°ä¸ºVerticalBlanking Interval(VBI)ã€‚é‚£ï¼Œè¿™ä¸ªæ—¶é—´ç‚¹å°±æ˜¯æˆ‘ä»¬è¿›è¡Œç¼“å†²åŒºäº¤æ¢çš„æœ€ä½³æ—¶é—´ã€‚å› ä¸ºæ­¤æ—¶å±å¹•æ²¡æœ‰åœ¨åˆ·æ–°ï¼Œä¹Ÿå°±é¿å…äº†äº¤æ¢è¿‡ç¨‹ä¸­å‡ºç° screen tearingçš„çŠ¶å†µã€‚ VSYNC ä¿¡å·æ˜¯ç”±å±å¹•ï¼ˆæ˜¾ç¤ºè®¾å¤‡ï¼‰äº§ç”Ÿçš„ï¼Œåˆ©ç”¨VBIæ—¶æœŸå‡ºç°çš„vertical sync pulseï¼ˆå‚ç›´åŒæ­¥è„‰å†²ï¼‰æ¥ä¿è¯åŒç¼“å†²åœ¨æœ€ä½³æ—¶é—´ç‚¹æ‰è¿›è¡Œäº¤æ¢ã€‚å¹¶ä¸”ä»¥ 60fps çš„å›ºå®šé¢‘ç‡å‘é€ç»™ Android ç³»ç»Ÿï¼ŒAndroid ç³»ç»Ÿä¸­çš„ SurfaceFlinger æ¥æ”¶å‘é€çš„ VSYNC ä¿¡å·ã€‚VSYNC ä¿¡å·è¡¨æ˜å¯å¯¹å±å¹•è¿›è¡Œåˆ·æ–°è€Œä¸ä¼šäº§ç”Ÿæ’•è£‚ã€‚å¦å¤–ï¼Œäº¤æ¢æ˜¯æŒ‡å„è‡ªçš„å†…å­˜åœ°å€ï¼Œå¯ä»¥è®¤ä¸ºè¯¥æ“ä½œæ˜¯ç¬é—´å®Œæˆã€‚ Android 4.4ä¸Šåˆå¼•å…¥äº†Vsyncè™šæ‹ŸåŒ–ï¼Œé€šè¿‡DispSyncThreadæŠŠVsyncè™šæ‹ŸåŒ–æˆVsync-appå’ŒVsync-sfï¼ŒVsync-appå’ŒVsync-sfç›´æ¥æœ‰å›ºå®šçš„æ—¶æœºåç§»ï¼Œå„è‡ªåˆ†åˆ«æŒæ§ç€Appå’ŒSurfaceFlingerçš„å·¥ä½œèŠ‚å¥ï¼Œä»–ä»¬ä¸€å‰ä¸€åä¿æŒç€ç»˜åˆ¶ä»»åŠ¡çš„æµæ°´èŠ‚å¥ã€‚ CPU/GPUæ ¹æ®VSYNCä¿¡å·åŒæ­¥å¤„ç†æ•°æ®ï¼Œå¯ä»¥è®©CPU/GPUæœ‰å®Œæ•´çš„16msæ—¶é—´æ¥å¤„ç†æ•°æ®ï¼Œå‡å°‘äº†jankï¼ˆä¸¢å¸§ï¼‰ã€‚ ä¸€å¥è¯æ€»ç»“ï¼ŒVSyncåŒæ­¥ä½¿å¾—CPU/GPUå……åˆ†åˆ©ç”¨äº†16.6msæ—¶é—´ï¼Œå‡å°‘jankã€‚ åº”ç”¨åœ¨æ¯ä¸ªVsyncä¿¡å·åˆ°æ¥åéƒ½ä¼šé€šè¿‡dequeueBuffer/queueBufferæ¥ç”³è¯·bufferå’Œæäº¤ç»˜å›¾æ•°æ®ï¼ŒSurfaceflingeréƒ½ä¼šåœ¨ä¸‹ä¸€ä¸ªvsyncä¿¡å·åˆ°æ¥æ—¶å–èµ°bufferå»åšåˆæˆå’Œæ˜¾ç¤ºï¼Œ å¹¶åœ¨ä¸‹ä¸€ä¸‹ä¸ªvsyncæ—¶å°†bufferè¿˜å›æ¥ï¼Œå†æ¬¡å¾ªç¯ã€‚ ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#vsyncæœºåˆ¶ä»‹ç»"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"ä¸‰ã€SurfaceFlingerç›¸å…³ç±»å’Œæ¥å£ å¦‚ä¸‹ä¸ºSurfaceFlingerç›¸å…³ç±»å’Œæ¥å£ï¼š æ¨ªå‘è§’åº¦è€ƒæŸ¥Surfaceç›¸å…³ç±»çš„å…³ç³»ï¼š ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:3:0","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#ä¸‰surfaceflingerç›¸å…³ç±»å’Œæ¥å£"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"Region Android UI Regionæ˜¯ä¸€ä¸ªç”¨äºå®šä¹‰å’Œæ“ä½œçŸ©å½¢åŒºåŸŸçš„ç±»ã€‚å®ƒå¯ä»¥ç”¨äºåœ¨å±å¹•ä¸Šç»˜åˆ¶å’Œå¤„ç†å›¾å½¢ã€æ–‡å­—å’Œè§¦æ‘¸äº‹ä»¶ç­‰ã€‚Regionç±»æä¾›äº†ä¸€ç³»åˆ—æ–¹æ³•æ¥åˆ›å»ºã€åˆå¹¶ã€è£å‰ªå’Œåˆ¤æ–­åŒºåŸŸä¹‹é—´çš„å…³ç³»ã€‚ Regionä»£ç ä½äºï¼š frameworks/native/include/ui/Region.h frameworks/native/libs/ui/Region.cpp Regionçš„å®šä¹‰ï¼š class Region : public LightFlattenable\u003cRegion\u003e} ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:3:1","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#region"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"ISurfaceComposer ISurfaceComposeræ˜¯Androidç³»ç»Ÿä¸­çš„ä¸€ä¸ªæ¥å£ï¼Œå®ƒæ˜¯SurfaceFlingeræœåŠ¡çš„å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯é€šä¿¡çš„ä¸»è¦æ¥å£ï¼Œå…·ä½“æ–¹æ³•å¦‚ä¸‹ï¼š createDisplayï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Displayã€‚ destroyDisplayï¼šé”€æ¯æŒ‡å®šDisplayã€‚ setLayerï¼šè®¾ç½®Surfaceçš„å±‚çº§å…³ç³»ã€‚ setAlphaï¼šè®¾ç½®Surfaceçš„é€æ˜åº¦ã€‚ setPositionï¼šè®¾ç½®Surfaceçš„ä½ç½®ã€‚ setSizeï¼šè®¾ç½®Surfaceçš„å¤§å°ã€‚ setCropï¼šè®¾ç½®Surfaceçš„è£å‰ªåŒºåŸŸã€‚ setTransformï¼šè®¾ç½®Surfaceçš„å˜æ¢çŸ©é˜µï¼Œç”¨äºå®ç°ç¼©æ”¾ã€é€‰æ‹©æ•ˆæœã€‚ ISurfaceComposerä»£ç ä½äºï¼š frameworks/native/include/gui/ISurfaceComposer.h frameworks/native/libs/gui/ISurfaceComposer.cpp ISurfaceComposerçš„å®šä¹‰ï¼š class ISurfaceComposer: public IInterface {} ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:3:2","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#isurfacecomposer"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"ISurfaceComposerClient ISurfaceComposeræ˜¯Androidç³»ç»Ÿä¸­çš„ä¸€ä¸ªæ¥å£ï¼Œå®ƒæ˜¯SurfaceFlingeræœåŠ¡çš„å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯é€šä¿¡çš„ä¸»è¦æ¥å£ï¼Œå¸¸è§æ–¹æ³•å¦‚ä¸‹ï¼š createSurfaceï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Surfaceã€‚ clearLayerFrameStatsï¼šæ¸…é™¤Layerçš„å¸§é—´ç»Ÿè®¡ä¿¡æ¯ã€‚ getLayerFrameStatsï¼šè·å–æŒ‡å®šLayerçš„å¸§é—´é€šä¿¡ä¿¡æ¯ã€‚ ISurfaceComposerClientä»£ç ä½äºï¼š frameworks/native/include/gui/ISurfaceComposerClient.h frameworks/native/libs/gui/ISurfaceComposerClient.cpp ISurfaceComposerClientçš„å®šä¹‰ï¼š class ISurfaceComposerClient : public IInterface {} ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:3:3","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#isurfacecomposerclient"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"SurfaceComposerClient SurfaceComposerClientæ˜¯Androidç³»ç»Ÿä¸­ç”¨äºåˆ›å»ºå’Œç®¡ç†å›¾å½¢è¡¨é¢çš„ä¸€ä¸ªå…³é”®ç±»ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªç”¨äºæ§ä»¶çš„å›¾å½¢ç•Œé¢APIï¼Œä½¿å¼€å‘äººå‘˜å¯ä»¥åˆ›å»ºå’Œæ“ä½œå›¾å½¢è¡¨é¢ï¼Œå¹¶å°†å…¶æ¸²æŸ“åˆ°å±å¹•ä¸Šæ˜¾ç¤ºï¼ŒSurfaceComposerClientçš„ä¸»è¦ä½œç”¨åŒ…æ‹¬ï¼š åˆ›å»ºå’Œç®¡ç†Surfaceå¯¹è±¡ï¼šSurfaceComposerClientç±»æä¾›äº†åˆ›å»ºå’Œç®¡ç†Surfaceå¯¹è±¡çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬åˆ›å»ºæ–°çš„è¡¨é¢ï¼Œè®¾ç½®è¡¨é¢çš„å¤§å°å’Œä½ç½®ï¼Œè°ƒæ•´è¡¨é¢çš„ç¼©æ”¾æ¯”ä¾‹å’Œé€æ˜åº¦ç­‰æ“ä½œï¼Œå¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨SurfaceComposerClientåˆ›å»ºå’Œç®¡ç†Surfaceå¯¹è±¡ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°åº”ç”¨ç¨‹åºçš„UIç•Œé¢ä¸­ã€‚ åˆ›å»ºå’Œç®¡ç†å›¾å±‚ï¼šå¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨SurfaceComposerClientç±»åˆ›å»ºå’Œç®¡ç†å›¾å½¢å›¾å±‚ï¼Œä»¥å®ç°åœ¨å±å¹•ä¸Šæ˜¾ç¤ºå¤æ‚çš„å›¾å½¢æ•ˆæœã€‚SurfaceComposerClientä¸ºå¼€å‘äººå‘˜æä¾›äº†ä¸€ç»„APIå‡½æ•°æ¥åˆ›å»ºå’Œç®¡ç†å›¾å±‚ï¼ŒåŒ…æ‹¬è®¾ç½®å›¾å±‚å¤§å°å’Œä½ç½®ã€è®¾ç½®å›¾å±‚ç¼©æ”¾å’Œé€æ˜åº¦ã€è®¾ç½®æ··åˆæ¨¡å¼å’ŒåŠ¨ç”»ç­‰ã€‚ ä¸SurfaceFlingeræœåŠ¡çš„äº¤äº’ï¼šSurfaceComposerClienté€šè¿‡IPCæœºåˆ¶ä¸ç³»ç»Ÿçº§SurfaceFlingeræœåŠ¡é€šä¿¡ï¼Œä»è€Œå®ç°äº†åº”ç”¨ç¨‹åºå’ŒSurfaceFlingerä¹‹é—´çš„äº¤äº’ã€‚å¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨SurfaceComposerClientæä¾›çš„å‡½æ•°ä¸SurfaceFlingerè¿›è¡Œé€šä¿¡ï¼Œå¦‚è¯·æ±‚åˆ·æ–°å±å¹•ã€é”€æ¯è¡¨é¢ã€é‡Šæ”¾èµ„æºç­‰ã€‚ SurfaceComposerClientä»£ç ä½äºï¼š frameworks/native/libs/gui/SurfaceComposerClient.cpp frameworks/native/include/gui/SurfaceComposerClient.h SurfaceComposerClientçš„å®šä¹‰ï¼š struct SurfaceControlStats {} class SurfaceComposerClient : public RefBase {} class ScreenshotClient {} class JankDataListener : public VirtualLightRefBase {} class TransactionCompletedListener : public BnTransactionCompletedListener {} ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:3:4","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#surfacecomposerclient"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"DisplayEventReceiver DisplayEventReceiverï¼ˆæ˜¾ç¤ºäº‹ä»¶æ¥æ”¶å™¨ï¼‰ï¼Œç”¨äºæ¥æ”¶æ¥è‡ªåº•å±‚ç¡¬ä»¶çš„æ˜¾ç¤ºäº‹ä»¶ã€‚å®ƒæ˜¯ä¸€ä¸ªç³»ç»Ÿçº§åˆ«çš„ç»„ä»¶ï¼Œç”¨äºç›‘å¬å’Œå¤„ç†ä¸æ˜¾ç¤ºç›¸å…³çš„äº‹ä»¶ï¼Œä¾‹å¦‚å±å¹•åˆ·æ–°ã€è§¦æ‘¸äº‹ä»¶ç­‰ã€‚å¼€å‘è€…å¯ä»¥é€šè¿‡ç»§æ‰¿DisplayEventReceiverç±»ï¼Œå¹¶å®ç°onHotplugå’ŒonVsyncæ–¹æ³•æ¥å¤„ç†ç›¸åº”çš„äº‹ä»¶ã€‚ DisplayEventReceiverä»£ç ä½äºï¼š frameworks/native/libs/gui/include/gui/DisplayEventReceiver.h frameworks/native/libs/gui/DisplayEventReceiver.cpp DisplayEventReceiverçš„å®šä¹‰ï¼š class DisplayEventReceiver {} ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:3:5","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#displayeventreceiver"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"SurfaceFlingerFactory SurfaceFlingerçš„æ„é€ å·¥å‚ã€‚ SurfaceFlingerä»£ç ä½äºï¼š frameworks/native/service/surfaceflinger/SurfaeFlinger.h frameworks/native/service/surfaceflinger/SurfaeFlinger.cpp SurfaceFlingerçš„å®šä¹‰ï¼š class Factory {} ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:3:6","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#surfaceflingerfactory"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"SurfaceFlinger SurfaceFlingerç±»æ˜¯Androidç³»ç»Ÿä¸­çš„ä¸€ä¸ªé‡è¦ç»„ä»¶ï¼Œå®ƒè´Ÿè´£ç®¡ç†å’Œæ¸²æŸ“æ‰€æœ‰çš„å›¾å½¢ç•Œé¢ã€‚ SurfaceFlingerä»£ç ä½äºï¼š frameworks/native/service/surfaceflinger/SurfaeFlinger.h frameworks/native/service/surfaceflinger/SurfaeFlinger.cpp SurfaceFlingerçš„å®šä¹‰ï¼š class SurfaceFlinger : public BnSurfaceComposer, public PriorityDumper, public ClientCache::ErasedRecipient, private IBinder::DeathRecipient, private HWC2::ComposerCallback {} SurfaceFlingeræ–¹æ³•ï¼š void init() ANDROID_APIï¼šåˆå§‹åŒ– void run() ANDROID_APIï¼šè¿è¡Œ void initScheduler(const sp\u003cDisplayDevice\u003e\u0026 display) REQUIRES(mStateLock)ï¼šåˆå§‹åŒ–è°ƒåº¦å™¨ã€‚ void processDisplayChangesLocked() REQUIRES(mStateLock)ï¼šå¤„ç†æ˜¾ç¤ºå˜åŒ–ã€‚ void processDisplayRemoved(const wp\u003cIBinder\u003e\u0026 displayToken) REQUIRES(mStateLock)ï¼šå¤„ç†æ˜¾ç¤ºåˆ é™¤ã€‚ void processDisplayChanged(const wp\u003cIBinder\u003e\u0026 displayToken, const DisplayDeviceState\u0026 currentState, const DisplayDeviceState\u0026 drawingState) REQUIRES(mStateLock)ï¼šå¤„ç†æ˜¾ç¤ºå˜åŒ– bool latchBuffers()ï¼šè´Ÿè´£å°†åº”ç”¨ç¨‹åºçš„å›¾å½¢ç¼“å†²åŒºï¼ˆbufferï¼‰ä¸æ˜¾ç¤ºå™¨è¿›è¡Œå…³è”ï¼Œå®ç°å›¾åƒçš„æ˜¾ç¤ºã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒçš„ä¸»è¦åŠŸèƒ½æ˜¯å°†åº”ç”¨ç¨‹åºçš„å›¾å½¢ç¼“å†²åŒºå¤åˆ¶åˆ°æ˜¾ç¤ºå™¨çš„å¸§ç¼“å†²åŒºï¼ˆframebufferï¼‰ä¸­ã€‚ void onLayerFirstRef(Layer*)ï¼šåœ¨åˆ›å»ºä¸€ä¸ªæ–°çš„å›¾å±‚æ—¶è¢«è°ƒç”¨ã€‚ void onLayerDestroyed(Layer*)ï¼šåœ¨å›¾å±‚æ¶ˆè€—æ—¶è¢«è°ƒç”¨ã€‚ void onLayerUpdate()ï¼šåœ¨å›¾å±‚æ›´æ–°æ—¶è¢«è°ƒç”¨ã€‚ //HWC2::ComposerCallback: void onComposerHalVsync(hal::HWDisplayId, int64_t timestamp, std::optionalhal::VsyncPeriodNanos)ï¼š void onComposerHalHotplug(hal::HWDisplayId, hal::Connection)ï¼š void onComposerHalRefresh(hal::HWDisplayId)ï¼š void onComposerHalVsyncPeriodTimingChanged(hal::HWDisplayId, const hal::VsyncPeriodChangeTimeline\u0026)ï¼š void onComposerHalSeamlessPossible(hal::HWDisplayId) ï¼š void onComposerHalVsyncIdle(hal::HWDisplayId)ï¼š //ICompositor overrides: bool commit(nsecs_t frameTime, int64_t vsyncId, nsecs_t expectedVsyncTime) overrideï¼šæäº¤å›¾å±‚å’Œæ˜¾ç¤ºçš„äº‹åŠ¡ã€‚ void composite(nsecs_t frameTime, int64_t vsyncId) overrideï¼šç”¨äºå°†å¤šä¸ªçª—å£çš„å›¾åƒè¿›è¡Œåˆæˆï¼Œä¸»è¦è´Ÿè´£å¯¹ç›¸å…³è¦è¿›è¡Œä¸Šå¸§çš„layerè¿›è¡Œï¼Œè¯†åˆ«æ’åºå¥½ï¼Œç„¶ååˆæˆã€‚ ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:3:7","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"Client åœ¨Surfaceä¸­ï¼ŒClientç±»æ˜¯å®¢æˆ·ç«¯è¿›ç¨‹ä¸æœåŠ¡ç«¯è¿›ç¨‹ä¹‹é—´çš„ä¸€ä¸ªæ¡¥æ¢ï¼Œç”¨äºå®Œæˆå®¢æˆ·ç«¯è¿›ç¨‹ä¸æœåŠ¡ç«¯è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡äº¤äº’ï¼ŒClientå®ç°äº†ISurfaceComposerClientæ¥å£ï¼ŒClientå¸¸è§æ–¹æ³•å¦‚ä¸‹ï¼š attachLayerï¼šå°†ä¸€ä¸ªLayerä¸Surfaceè¿›è¡Œå…³è”ã€‚ detachLayerï¼šå°†ä¸€ä¸ªLayerä¸Surfaceåˆ†ç¦»ã€‚ getLayerUserï¼šè·å–æŒ‡å®šLayerçš„ç”¨æˆ·ã€‚ createSurfaceï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Surfaceã€‚ clearLayerFrameStatsï¼šæ¸…é™¤Layerçš„å¸§é—´ç»Ÿè®¡ä¿¡æ¯ã€‚ getLayerFrameStatsï¼šè·å–æŒ‡å®šLayerçš„å¸§é—´é€šä¿¡ä¿¡æ¯ã€‚ Clientä»£ç ä½äºï¼š frameworks/native/services/surfaceflinger/Client.h frameworks/native/services/surfaceflinger/Client.cpp Clientçš„å®šä¹‰ï¼š class Client : public BnSurfaceComposerClient {} ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:3:8","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#client"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"Layer Layeræ˜¯SurfaceFlingerè¿›è¡Œåˆæˆçš„åŸºæœ¬æ“ä½œå•å…ƒã€‚Layeråœ¨åº”ç”¨è¯·æ±‚åˆ›å»ºSurfaceçš„æ—¶å€™åœ¨SurfaceFlingerå†…éƒ¨åˆ›å»ºï¼Œå› æ­¤ä¸€ä¸ªSurfaceå¯¹åº”ä¸€ä¸ªLayerã€‚Layerå…¶å®æ˜¯ä¸€ä¸ªFrameBuffer,æ¯ä¸ªFrameBufferä¸­æœ‰ä¸¤ä¸ªGraphicBufferè®°ä½œFrontBufferå’ŒBackBufferã€‚SurfaceFlingerèƒ½å¤Ÿåˆ›å»ºå››ç§ç±»å‹çš„Layerï¼ŒBufferQueueLayerï¼ŒBufferStateLayerï¼ŒColorLayerï¼ŒContainerLayerï¼Œæœ€å¸¸ç”¨çš„å°±æ˜¯BufferQueueLayerã€‚ Layerä»£ç ä½äºï¼š frameworks/native/services/surfaceflinger/Layer.h frameworks/native/services/surfaceflinger/Layer.cpp Layerçš„å®šä¹‰ï¼š class Layer : public virtual compositionengine::LayerFE {} ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:3:9","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#layer"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"BufferLayer BufferLayerç±»æ˜¯SurfaceFlingerä¸­ç”¨äºç®¡ç†å’Œå¤„ç†å›¾å½¢ç¼“å†²åŒºçš„ç±»ã€‚ BufferLayerä»£ç ä½äºï¼š frameworks/native/services/surfaceflinger/BufferLayer.h frameworks/native/services/surfaceflinger/BufferLayer.cpp BufferLayerçš„å®šä¹‰ï¼š class BufferLayer : public Layer {} ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:3:10","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#bufferlayer"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"BufferQueueLayer BufferQueueLayeræ˜¯ä¸€ç§åŸºäºç¼“å†²é˜Ÿåˆ—çš„å›¾å±‚ï¼Œå®ƒä½¿ç”¨ä¸€ä¸ªç¼“å†²é˜Ÿåˆ—æ¥å­˜å‚¨å¤šä¸ªå›¾åƒæ•°æ®ã€‚å½“åº”ç”¨ç¨‹åºæ›´æ–°å›¾åƒæ—¶ï¼ŒBufferQueueLayerä¼šå°†æ–°çš„å›¾åƒæ•°æ®æ·»åŠ åˆ°ç¼“å†²é˜Ÿåˆ—çš„æœ«å°¾ï¼Œå¹¶åœ¨æ¯ä¸€å¸§æ˜¾ç¤ºæ—¶ä½¿ç”¨é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªç¼“å†²åŒºã€‚BufferQueueLayeré€‚ç”¨äºéœ€è¦å¤„ç†å¤šä¸ªå›¾åƒæ•°æ®çš„åœºæ™¯ï¼Œä¾‹å¦‚å¤šä¸ªåº”ç”¨ç¨‹åºåŒæ—¶æ˜¾ç¤ºå›¾åƒæˆ–éœ€è¦å®ç°åŒç¼“å†²æœºåˆ¶çš„åº”ç”¨ç¨‹åºã€‚ BufferQueueLayerä»£ç ä½äºï¼š frameworks/native/services/surfaceflinger/BufferQueueLayer.h frameworks/native/services/surfaceflinger/BufferQueueLayer.cpp BufferQueueLayerçš„å®šä¹‰ï¼š class BufferQueueLayer : public BufferLayer, public BufferLayerConsumer::ContentsChangedListener {} ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:3:11","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#bufferqueuelayer"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"BufferStateLayer BufferStateLayeræ˜¯ä¸€ç§åŸºäºç¼“å†²çŠ¶æ€çš„å›¾å±‚ï¼Œå®ƒä½¿ç”¨ä¸€ä¸ªç¼“å†²åŒºæ¥å­˜å‚¨å›¾åƒæ•°æ®ã€‚å½“åº”ç”¨ç¨‹åºæ›´æ–°å›¾åƒæ—¶ï¼ŒBufferStateLayerä¼šå°†æ–°çš„å›¾åƒæ•°æ®å†™å…¥ç¼“å†²åŒºï¼Œå¹¶åœ¨ä¸‹ä¸€å¸§æ˜¾ç¤ºæ—¶ä½¿ç”¨è¯¥ç¼“å†²åŒºçš„å†…å®¹ã€‚BufferStateLayeré€‚ç”¨äºé¢‘ç¹æ›´æ–°å›¾åƒçš„åœºæ™¯ï¼Œä¾‹å¦‚è§†é¢‘æ’­æ”¾å™¨æˆ–åŠ¨ç”»åº”ç”¨ç¨‹åºã€‚ BufferStateLayerä»£ç ä½äºï¼š frameworks/native/services/surfaceflinger/BufferStateLayer.h frameworks/native/services/surfaceflinger/BufferStateLayer.cpp BufferStateLayerçš„å®šä¹‰ï¼š class BufferStateLayer : public BufferLayer {} ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:3:12","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#bufferstatelayer"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"LayerHistory Androidçš„LayerHistoryæ˜¯ä¸€ä¸ªç”¨äºè·Ÿè¸ªå’Œç®¡ç†åº”ç”¨ç¨‹åºçª—å£å±‚çº§çš„ç±»ã€‚å®ƒä¸»è¦ç”¨äºè®°å½•å’Œç®¡ç†åº”ç”¨ç¨‹åºä¸­å„ä¸ªçª—å£çš„æ˜¾ç¤ºé¡ºåºå’ŒçŠ¶æ€ã€‚ LayerHistoryç»´æŠ¤äº†ä¸€ä¸ªçª—å£å±‚çº§çš„åˆ—è¡¨ï¼Œæ¯ä¸ªçª—å£éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦å’Œä¸€ä¸ªçŠ¶æ€ã€‚å½“åº”ç”¨ç¨‹åºä¸­çš„çª—å£å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒLayerHistoryä¼šç›¸åº”åœ°æ›´æ–°çª—å£çš„çŠ¶æ€ï¼Œå¹¶è®°å½•ä¸‹çª—å£çš„æ˜¾ç¤ºé¡ºåºã€‚ LayerHistoryæä¾›äº†ä¸€äº›æ–¹æ³•æ¥ç®¡ç†çª—å£å±‚çº§ï¼ŒåŒ…æ‹¬æ·»åŠ çª—å£ã€ç§»é™¤çª—å£ã€æ›´æ–°çª—å£çŠ¶æ€ç­‰ã€‚é€šè¿‡è¿™äº›æ–¹æ³•ï¼Œå¼€å‘è€…å¯ä»¥æ–¹ä¾¿åœ°æ§åˆ¶åº”ç”¨ç¨‹åºä¸­å„ä¸ªçª—å£çš„æ˜¾ç¤ºå’Œéšè—ã€‚ æ­¤å¤–ï¼ŒLayerHistoryè¿˜æä¾›äº†ä¸€äº›å›è°ƒæ–¹æ³•ï¼Œç”¨äºé€šçŸ¥å¼€å‘è€…çª—å£å±‚çº§çš„å˜åŒ–ã€‚å¼€å‘è€…å¯ä»¥é€šè¿‡è¿™äº›å›è°ƒæ–¹æ³•æ¥å¤„ç†çª—å£çš„æ˜¾ç¤ºå’Œéšè—äº‹ä»¶ï¼Œä»¥åŠå…¶ä»–ä¸çª—å£ç›¸å…³çš„æ“ä½œã€‚ LayerHistoryä»£ç ä½äºï¼š frameworks/native/services/surfaceflinger/Scheduler/LayerHistory.h frameworks/native/services/surfaceflinger/Scheduler/LayerHistory.cpp LayerHistoryçš„å®šä¹‰ class LayerHistory {} ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:3:13","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#layerhistory"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"SurfaceInterceptor Androidçš„SurfaceInterceptoræ˜¯ä¸€ä¸ªç”¨äºæ‹¦æˆªå’Œå¤„ç†Surfaceç›¸å…³äº‹ä»¶çš„ç±»ã€‚å®ƒæ˜¯Androidç³»ç»Ÿä¸­çš„ä¸€ä¸ªé‡è¦ç»„ä»¶ï¼Œç”¨äºåœ¨Surfaceçš„åˆ›å»ºã€é”€æ¯ã€ç»˜åˆ¶ç­‰è¿‡ç¨‹ä¸­è¿›è¡Œæ‹¦æˆªå’Œå¤„ç†ã€‚ SurfaceInterceptorå¯ä»¥ç”¨äºå®ç°ä¸€äº›ç‰¹å®šçš„åŠŸèƒ½ï¼Œæ¯”å¦‚åœ¨Surfaceåˆ›å»ºä¹‹å‰è¿›è¡Œä¸€äº›é¢å¤–çš„å¤„ç†ï¼Œæˆ–è€…åœ¨Surfaceé”€æ¯ä¹‹åè¿›è¡Œä¸€äº›æ¸…ç†å·¥ä½œã€‚å®ƒå¯ä»¥æ‹¦æˆªSurfaceçš„å„ç§äº‹ä»¶ï¼ŒåŒ…æ‹¬Surfaceçš„åˆ›å»ºã€å¤§å°å˜åŒ–ã€ç»˜åˆ¶ç­‰äº‹ä»¶ï¼Œå¹¶ä¸”å¯ä»¥å¯¹è¿™äº›äº‹ä»¶è¿›è¡Œå¤„ç†å’Œä¿®æ”¹ã€‚ é€šè¿‡ä½¿ç”¨SurfaceInterceptorï¼Œå¼€å‘è€…å¯ä»¥åœ¨Surfaceçš„ç”Ÿå‘½å‘¨æœŸä¸­è¿›è¡Œä¸€äº›è‡ªå®šä¹‰çš„æ“ä½œï¼Œä¾‹å¦‚åœ¨Surfaceåˆ›å»ºä¹‹å‰æ·»åŠ ä¸€äº›ç‰¹æ•ˆï¼Œæˆ–è€…åœ¨Surfaceé”€æ¯ä¹‹åè¿›è¡Œä¸€äº›èµ„æºé‡Šæ”¾ã€‚è¿™æ ·å¯ä»¥å¢å¼ºåº”ç”¨ç¨‹åºçš„åŠŸèƒ½å’Œç”¨æˆ·ä½“éªŒã€‚ SurfaceInterceptorä»£ç ä½äºï¼š frameworks/native/services/surfaceflinger/SurfaceInterceptor.h frameworks/native/services/surfaceflinger/SurfaceInterceptor.cpp SurfaceInterceptorçš„å®šä¹‰ï¼š class SurfaceInterceptor final : public android::SurfaceInterceptor {} ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:3:14","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#surfaceinterceptor"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"MonitoredProducer MonitoredProducerç±»æ˜¯ç”Ÿäº§è€…çš„å°è£…ç±»ï¼Œåœ¨BufferQueueLayer::onFirstRef()ä¸­åˆ›å»ºã€‚ MonitoredProducerä»£ç ä½äºï¼š frameworks/native/services/surfaceflinger/MonitoredProducer.h frameworks/native/services/surfaceflinger/MonitoredProducer.cpp MonitoredProducerçš„å®šä¹‰ï¼š class MonitoredProducer : public BnGraphicBufferProducer {} ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:3:15","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#monitoredproducer"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"Scheduler SurfaceFlingerçš„è°ƒåº¦å™¨ Schedulerä»£ç ä½äºï¼š frameworks/native/services/surfaceflinger/Scheduler/Scheduler.h frameworks/native/services/surfaceflinger/Scheduler/Scheduler.cpp Schedulerçš„å®šä¹‰ï¼š struct ISchedulerCallback {}class Scheduler : impl::MessageQueue {} ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:3:16","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#scheduler"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"FrameTimeline Androidçš„FrameTimelineç±»æ˜¯ä¸€ä¸ªç”¨äºè·Ÿè¸ªåº”ç”¨ç¨‹åºå¸§ç‡çš„å·¥å…·ç±»ã€‚å®ƒæä¾›äº†ä¸€ç§ç®€å•çš„æ–¹å¼æ¥æµ‹é‡å’Œç›‘è§†åº”ç”¨ç¨‹åºåœ¨å±å¹•ä¸Šæ¯ä¸€å¸§çš„æ¸²æŸ“æ—¶é—´ã€‚é€šè¿‡ä½¿ç”¨FrameTimelineç±»ï¼Œå¼€å‘äººå‘˜å¯ä»¥æ›´å¥½åœ°äº†è§£åº”ç”¨ç¨‹åºçš„æ€§èƒ½è¡¨ç°ï¼Œå¹¶è¿›è¡Œä¼˜åŒ–ã€‚ FrameTimelineä»£ç ä½äºï¼š frameworks/native/services/surfaceflinger/FrameTimeline/FrameTimeline.h frameworks/native/services/surfaceflinger/FrameTimeline/FrameTimeline.cpp FrameTimelineçš„å®šä¹‰ï¼š class TokenManager {} class TraceCookieCounter {} class SurfaceFrame {} class FrameTimeline {} class TokenManager : public android::frametimeline::TokenManager { class FrameTimeline : public android::frametimeline::FrameTimeline {} ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:3:17","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#frametimeline"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"EventThread SurfaceFlingeræ˜¯Androidç³»ç»Ÿä¸­è´Ÿè´£æ˜¾ç¤ºç®¡ç†çš„ä¸€ä¸ªé‡è¦ç»„ä»¶ï¼Œè€ŒEventThreadæ˜¯SurfaceFlingerä¸­çš„ä¸€ä¸ªæ–¹æ³•ã€‚EventThreadæ–¹æ³•ä¸»è¦ç”¨äºå¤„ç†è¾“å…¥äº‹ä»¶ã€‚ åœ¨SurfaceFlingerä¸­ï¼ŒEventThreadæ–¹æ³•æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œå®ƒä¸æ–­åœ°ä»è¾“å…¥é˜Ÿåˆ—ä¸­è·å–è¾“å…¥äº‹ä»¶ï¼Œå¹¶å°†è¿™äº›äº‹ä»¶åˆ†å‘ç»™åˆé€‚çš„çª—å£æˆ–è€…Surfaceè¿›è¡Œå¤„ç†ã€‚å…·ä½“æ¥è¯´ï¼ŒEventThreadæ–¹æ³•ä¼šæ‰§è¡Œä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š ä»è¾“å…¥é˜Ÿåˆ—ä¸­è·å–è¾“å…¥äº‹ä»¶ï¼šEventThreadä¼šä»è¾“å…¥é˜Ÿåˆ—ä¸­è·å–æœ€æ–°çš„è¾“å…¥äº‹ä»¶ï¼ŒåŒ…æ‹¬è§¦æ‘¸äº‹ä»¶ã€æŒ‰é”®äº‹ä»¶ç­‰ã€‚ åˆ†å‘äº‹ä»¶ç»™çª—å£æˆ–Surfaceï¼šæ ¹æ®äº‹ä»¶çš„ç±»å‹å’Œç›®æ ‡ï¼ŒEventThreadä¼šå°†äº‹ä»¶åˆ†å‘ç»™å¯¹åº”çš„çª—å£æˆ–Surfaceè¿›è¡Œå¤„ç†ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæ˜¯è§¦æ‘¸äº‹ä»¶ï¼ŒEventThreadä¼šå°†äº‹ä»¶å‘é€ç»™å½“å‰ä½äºè§¦æ‘¸ä½ç½®ä¸‹çš„çª—å£æˆ–Surfaceã€‚ å¤„ç†äº‹ä»¶ï¼šæ¥æ”¶åˆ°äº‹ä»¶çš„çª—å£æˆ–Surfaceä¼šæ ¹æ®äº‹ä»¶çš„ç±»å‹è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚ä¾‹å¦‚ï¼Œå¯¹äºè§¦æ‘¸äº‹ä»¶ï¼Œçª—å£æˆ–Surfaceå¯ä»¥æ ¹æ®è§¦æ‘¸ä½ç½®è¿›è¡Œç•Œé¢çš„æ»šåŠ¨ã€ç¼©æ”¾ç­‰æ“ä½œã€‚ å¾ªç¯å¤„ç†ï¼šEventThreadä¼šä¸æ–­åœ°å¾ªç¯æ‰§è¡Œä¸Šè¿°æ­¥éª¤ï¼Œä»¥ç¡®ä¿è¾“å…¥äº‹ä»¶èƒ½å¤ŸåŠæ—¶åœ°è¢«å¤„ç†ã€‚ æ€»ç»“æ¥è¯´ï¼ŒSurfaceFlingerçš„EventThreadæ–¹æ³•æ˜¯è´Ÿè´£å¤„ç†è¾“å…¥äº‹ä»¶çš„ä¸€ä¸ªå¾ªç¯ï¼Œå®ƒå°†è¾“å…¥äº‹ä»¶åˆ†å‘ç»™å¯¹åº”çš„çª—å£æˆ–Surfaceè¿›è¡Œå¤„ç†ï¼Œä»¥å®ç°ç”¨æˆ·ä¸Androidç³»ç»Ÿçš„äº¤äº’ã€‚ EventThreadä»£ç ä½äºï¼š frameworks/native/services/surfaceflinger/Scheduler/EventThread.h frameworks/native/services/surfaceflinger/Scheduler/EventThread.cpp EventThreadçš„å®šä¹‰ï¼š class VSyncSource {} class EventThreadConnection : public gui::BnDisplayEventConnection {} class EventThread {} class EventThread : public android::EventThread, private VSyncSource::Callback {} EventThreadæ–¹æ³•ï¼š void EventThread::onVSyncEvent(nsecs_t timestamp, VSyncSource::VSyncData vsyncData)ï¼š ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:3:18","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#eventthread"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"DisplayEventDispatcher DisplayEventDispatcherï¼ˆæ˜¾ç¤ºäº‹ä»¶åˆ†å‘å™¨ï¼‰ï¼Œç”¨äºåˆ†å‘æ˜¾ç¤ºäº‹ä»¶çš„ç±»ã€‚å®ƒè´Ÿè´£å°†åº•å±‚ç¡¬ä»¶äº§ç”Ÿçš„æ˜¾ç¤ºäº‹ä»¶å‘é€ç»™ç›¸åº”çš„æ¥æ”¶å™¨ï¼ˆå¦‚DisplayEventReceiverï¼‰ã€‚DisplayEventDispatcherä¼šæ ¹æ®äº‹ä»¶çš„ç±»å‹å’Œç›®æ ‡æ¥æ”¶å™¨çš„è¦æ±‚ï¼Œå°†äº‹ä»¶åˆ†å‘åˆ°æ­£ç¡®çš„æ¥æ”¶å™¨ä¸­ã€‚ DisplayEventDispatcherä»£ç ä½äºï¼š frameworks/native/libs/gui/include/gui/DisplayEventDispatcher.h frameworks/native/libs/gui/DisplayEventDispatcher.cpp DisplayEventDispatcherçš„å®šä¹‰ï¼š class DisplayEventDispatcher : public LooperCallback {} ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:3:19","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#displayeventdispatcher"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"DispSyncSource DispSyncSourceæ˜¯ä¸€ä¸ªAndroidç³»ç»Ÿä¸­çš„ç±»ï¼Œç”¨äºåŒæ­¥æ˜¾ç¤ºåˆ·æ–°ã€‚å®ƒæ˜¯Androidç³»ç»Ÿä¸­ç”¨äºå¤„ç†æ˜¾ç¤ºåˆ·æ–°çš„ä¸€ä¸ªé‡è¦ç»„ä»¶ã€‚ DispSyncSourceçš„ä¸»è¦ä½œç”¨æ˜¯å°†åº”ç”¨ç¨‹åºçš„æ¸²æŸ“å¸§ä¸æ˜¾ç¤ºè®¾å¤‡çš„åˆ·æ–°è¿›è¡ŒåŒæ­¥ï¼Œä»¥ç¡®ä¿å›¾åƒåœ¨å±å¹•ä¸Šæ­£ç¡®æ˜¾ç¤ºã€‚å®ƒé€šè¿‡æä¾›ä¸€ä¸ªæ—¶é—´åŸºå‡†æ¥åè°ƒåº”ç”¨ç¨‹åºçš„æ¸²æŸ“å’Œæ˜¾ç¤ºè®¾å¤‡çš„åˆ·æ–°æ“ä½œã€‚ DispSyncSourceä½¿ç”¨äº†å‚ç›´åŒæ­¥ï¼ˆVSyncï¼‰ä¿¡å·æ¥è¿›è¡ŒåŒæ­¥ã€‚VSyncä¿¡å·æ˜¯æ˜¾ç¤ºè®¾å¤‡åœ¨æ¯æ¬¡åˆ·æ–°æ—¶å‘é€çš„ä¸€ä¸ªä¿¡å·ï¼Œç”¨äºå‘ŠçŸ¥ç³»ç»Ÿå¼€å§‹ä¸‹ä¸€å¸§çš„æ˜¾ç¤ºæ“ä½œã€‚DispSyncSourceä¼šç›‘å¬VSyncä¿¡å·ï¼Œå¹¶åœ¨æ¥æ”¶åˆ°ä¿¡å·æ—¶é€šçŸ¥åº”ç”¨ç¨‹åºè¿›è¡Œæ¸²æŸ“ã€‚ é™¤äº†åŒæ­¥æ˜¾ç¤ºåˆ·æ–°å¤–ï¼ŒDispSyncSourceè¿˜å¯ä»¥æä¾›ä¸€äº›å…¶ä»–åŠŸèƒ½ï¼Œä¾‹å¦‚è®¡ç®—å¸§ç‡ã€å»¶è¿Ÿç­‰ä¿¡æ¯ï¼Œä»¥åŠæ§åˆ¶åº”ç”¨ç¨‹åºçš„æ¸²æŸ“é€Ÿç‡ã€‚ æ€»ä¹‹ï¼ŒDispSyncSourceæ˜¯Androidç³»ç»Ÿä¸­ç”¨äºåŒæ­¥åº”ç”¨ç¨‹åºæ¸²æŸ“å’Œæ˜¾ç¤ºè®¾å¤‡åˆ·æ–°çš„é‡è¦ç»„ä»¶ï¼Œå®ƒèƒ½å¤Ÿç¡®ä¿å›¾åƒåœ¨å±å¹•ä¸Šæ­£ç¡®æ˜¾ç¤ºï¼Œå¹¶æä¾›ä¸€äº›å…¶ä»–åŠŸèƒ½æ¥ä¼˜åŒ–æ˜¾ç¤ºæ•ˆæœã€‚ DispSyncSourceä»£ç ä½äºï¼š frameworks/native/services/surfaceflinger/Scheduler/DispSyncSource.h frameworks/native/services/surfaceflinger/Scheduler/DispSyncSource.cpp DispSyncSourceçš„å®šä¹‰ï¼š class CallbackRepeater {} class DispSyncSource final : public VSyncSource {} ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:3:20","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#dispsyncsource"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"VsyncModulator VsyncModulatoræ˜¯ä¸€ä¸ªç”¨äºè°ƒæ•´å‚ç›´åŒæ­¥ä¿¡å·ï¼ˆVsyncï¼‰çš„æ¨¡å—ã€‚å‚ç›´åŒæ­¥æ˜¯æŒ‡åœ¨å›¾å½¢æ¸²æŸ“è¿‡ç¨‹ä¸­ï¼Œæ˜¾ç¤ºå™¨æŒ‰ç…§å›ºå®šçš„åˆ·æ–°ç‡æ¥æ›´æ–°å±å¹•ä¸Šçš„å›¾åƒã€‚VsyncModulatorçš„ä½œç”¨æ˜¯æ ¹æ®ç‰¹å®šçš„éœ€æ±‚ï¼Œå¯¹Vsyncä¿¡å·è¿›è¡Œè°ƒæ•´ï¼Œä»¥å®ç°æ›´å¥½çš„å›¾åƒæ˜¾ç¤ºæ•ˆæœæˆ–è€…ä¼˜åŒ–æ€§èƒ½ã€‚ VsyncModulatorå¯ä»¥ç”¨äºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š é˜²æ­¢æ’•è£‚ï¼šå½“å›¾åƒçš„æ¸²æŸ“é€Ÿåº¦ä¸æ˜¾ç¤ºå™¨çš„åˆ·æ–°é€Ÿç‡ä¸åŒ¹é…æ—¶ï¼Œä¼šå‡ºç°å›¾åƒæ’•è£‚ç°è±¡ã€‚VsyncModulatorå¯ä»¥é€šè¿‡è°ƒæ•´Vsyncä¿¡å·ï¼Œä½¿å¾—å›¾åƒåœ¨æ˜¾ç¤ºå™¨åˆ·æ–°çš„æ—¶å€™è¿›è¡Œæ›´æ–°ï¼Œä»è€Œé¿å…æ’•è£‚ç°è±¡çš„å‘ç”Ÿã€‚ ä¼˜åŒ–æ€§èƒ½ï¼šåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå›¾å½¢æ¸²æŸ“é€Ÿåº¦å¯èƒ½è¶…è¿‡äº†æ˜¾ç¤ºå™¨çš„åˆ·æ–°é€Ÿç‡ï¼Œå¯¼è‡´æ€§èƒ½æµªè´¹ã€‚VsyncModulatorå¯ä»¥é€šè¿‡è°ƒæ•´Vsyncä¿¡å·ï¼Œé™åˆ¶å›¾å½¢æ¸²æŸ“é€Ÿåº¦ï¼Œä»¥æé«˜æ€§èƒ½ã€‚ å‡å°‘å»¶è¿Ÿï¼šVsyncModulatorå¯ä»¥é€šè¿‡è°ƒæ•´Vsyncä¿¡å·çš„æ—¶æœºï¼Œå‡å°‘å›¾åƒæ˜¾ç¤ºçš„å»¶è¿Ÿï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚ æ€»ä¹‹ï¼ŒVsyncModulatoræ˜¯ä¸€ä¸ªç”¨äºè°ƒæ•´å‚ç›´åŒæ­¥ä¿¡å·çš„æ¨¡å—ï¼Œå¯ä»¥ç”¨äºä¼˜åŒ–å›¾åƒæ˜¾ç¤ºæ•ˆæœã€æé«˜æ€§èƒ½å’Œå‡å°‘å»¶è¿Ÿã€‚ VsyncModulatorä»£ç ä½äºï¼š frameworks/native/services/surfaceflinger/Scheduler/VsyncModulator.h frameworks/native/services/surfaceflinger/Scheduler/VsyncModulator.cpp VsyncModulatorçš„å®šä¹‰ï¼š class VsyncModulator : public IBinder::DeathRecipient {} ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:3:21","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#vsyncmodulator"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"VSyncCallbackRegistration VSyncCallbackRegistrationæ˜¯ä¸€ä¸ªç”¨äºæ³¨å†ŒVSyncå›è°ƒå‡½æ•°çš„ç±»ã€‚åœ¨Androidç³»ç»Ÿä¸­ï¼ŒVSyncæ˜¯æŒ‡æ˜¾ç¤ºè®¾å¤‡ä»¥å›ºå®šçš„é¢‘ç‡åˆ·æ–°å±å¹•çš„è¿‡ç¨‹ã€‚é€šè¿‡æ³¨å†ŒVSyncå›è°ƒå‡½æ•°ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥åœ¨æ¯æ¬¡VSyncäº‹ä»¶å‘ç”Ÿæ—¶å¾—åˆ°é€šçŸ¥ï¼Œå¹¶æ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚VSyncCallbackRegistrationæä¾›äº†ä¸€ç§æœºåˆ¶ï¼Œå…è®¸åº”ç”¨ç¨‹åºæ³¨å†Œè‡ªå·±çš„VSyncå›è°ƒå‡½æ•°ï¼Œå¹¶åœ¨æ¯æ¬¡VSyncäº‹ä»¶å‘ç”Ÿæ—¶è¢«è°ƒç”¨ã€‚ VSyncCallbackRegistrationä»£ç ä½äºï¼š frameworks/native/services/surfaceflinger/Scheduler/VSyncCallbackRegistration.h frameworks/native/services/surfaceflinger/Scheduler/VSyncCallbackRegistration.cpp VSyncCallbackRegistrationçš„å®šä¹‰ï¼š class VSyncDispatch {} class VSyncCallbackRegistration {} ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:3:22","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#vsynccallbackregistration"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"VSyncDispatchTimerQueue VSyncDispatchTimerQueueæ˜¯ä¸€ä¸ªç”¨äºè°ƒåº¦VSyncå›è°ƒå‡½æ•°çš„é˜Ÿåˆ—ã€‚å½“åº”ç”¨ç¨‹åºæ³¨å†Œäº†VSyncå›è°ƒå‡½æ•°åï¼Œè¿™äº›å›è°ƒå‡½æ•°ä¼šè¢«æ·»åŠ åˆ°VSyncDispatchTimerQueueä¸­è¿›è¡Œè°ƒåº¦ã€‚VSyncDispatchTimerQueueä¼šæ ¹æ®VSyncäº‹ä»¶çš„å‘ç”Ÿæ—¶é—´ï¼ŒæŒ‰ç…§ä¸€å®šçš„é¡ºåºæ‰§è¡Œå·²æ³¨å†Œçš„å›è°ƒå‡½æ•°ã€‚é€šè¿‡ä½¿ç”¨VSyncDispatchTimerQueueï¼Œå¯ä»¥ç¡®ä¿VSyncå›è°ƒå‡½æ•°åœ¨æ­£ç¡®çš„æ—¶é—´ç‚¹è¢«æ‰§è¡Œï¼Œä»è€Œå®ç°ä¸å±å¹•åˆ·æ–°åŒæ­¥çš„æ•ˆæœã€‚ VSyncDispatchTimerQueue ä»£ç ä½äºï¼š frameworks/native/services/surfaceflinger/Scheduler/VSyncDispatchTimerQueue.h frameworks/native/services/surfaceflinger/Scheduler/VSyncDispatchTimerQueue.cpp VSyncDispatchTimerQueue çš„å®šä¹‰ï¼š class VSyncDispatchTimerQueueEntry {} class VSyncDispatchTimerQueue : public VSyncDispatch {} ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:3:23","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#vsyncdispatchtimerqueue"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"MessageQueue surfaceflingerçš„æ¶ˆæ¯é˜Ÿåˆ— MessageQueueä»£ç ä½äºï¼š frameworks/native/services/surfaceflinger/Scheduler/MessageQueue.h frameworks/native/services/surfaceflinger/Scheduler/MessageQueue.cpp MessageQueueçš„å®šä¹‰ï¼š struct ICompositor {} class Task : public MessageHandler {} class MessageQueue {} class MessageQueue : public android::MessageQueue {} ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:3:24","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#messagequeue"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"FrameTracer FrameTraceræ˜¯SurfaceFlingerçš„ä¸€ä¸ªå·¥å…·ï¼Œç”¨äºåˆ†æå’Œè°ƒè¯•ç•Œé¢æ¸²æŸ“çš„æ€§èƒ½é—®é¢˜ã€‚FrameTracerå¯ä»¥å¸®åŠ©å¼€å‘è€…è¿½è¸ªæ¯ä¸€å¸§çš„æ¸²æŸ“è¿‡ç¨‹ï¼ŒåŒ…æ‹¬æ¯ä¸ªSurfaceçš„ç»˜åˆ¶æ—¶é—´ã€åˆæˆæ—¶é—´ã€åˆ·æ–°æ—¶é—´ç­‰ä¿¡æ¯ã€‚é€šè¿‡è¿™äº›ä¿¡æ¯ï¼Œå¼€å‘è€…å¯ä»¥äº†è§£åˆ°æ¯ä¸€å¸§çš„æ¸²æŸ“è€—æ—¶æƒ…å†µï¼Œä»è€Œæ‰¾å‡ºæ€§èƒ½ç“¶é¢ˆå¹¶è¿›è¡Œä¼˜åŒ–ã€‚ FrameTracerä»£ç ä½äºï¼š frameworks/native/services/surfaceflinger/FrameTracer/FrameTracer.cpp frameworks/native/services/surfaceflinger/FrameTracer/FrameTracer.h FrameTracerçš„å®šä¹‰ï¼š class FrameTracer {} ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:3:25","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#frametracer"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"å››ã€SurfaceFlingerç›¸å…³æµç¨‹åˆ†æ ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:4:0","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#å››surfaceflingerç›¸å…³æµç¨‹åˆ†æ"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"SurfaceFlingerå¯åŠ¨æµç¨‹åˆ†æ Android13 SurfaceFlingerå¯åŠ¨æµç¨‹åˆ†æ-CSDNåšå®¢|Android13 SurfaceFlingerå¯åŠ¨æµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:4:1","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#surfaceflingerå¯åŠ¨æµç¨‹åˆ†æ"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"SurfaceFlinger commit(æäº¤)æµç¨‹åˆ†æ Android13 SurfaceFlinger commit(æäº¤)æµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:4:2","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-commitæäº¤æµç¨‹åˆ†æ"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:4:3","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-compositeåˆæˆæµç¨‹åˆ†æ"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"SurfaceFlinger onLayerUpdateæµç¨‹åˆ†æ Android13 SurfaceFlinger onLayerUpdateæµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:4:4","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-onlayerupdateæµç¨‹åˆ†æ"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"SurfaceFlinger onComposerHalVsyncæµç¨‹åˆ†æ Android13 SurfaceFlinger onComposerHalVsyncæµç¨‹åˆ†æ-CSDNåšå®¢|Android13 SurfaceFlinger onComposerHalVsyncæµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:4:5","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-oncomposerhalvsyncæµç¨‹åˆ†æ"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"SurfaceFlinger onComposerHalHotplugæµç¨‹åˆ†æ Android13 SurfaceFlinger onComposerHalHotplugæµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:4:6","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-oncomposerhalhotplugæµç¨‹åˆ†æ"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"SurfaceFlinger onComposerHalRefreshæµç¨‹åˆ†æ Android13 SurfaceFlinger onComposerHalRefreshæµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:4:7","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-oncomposerhalrefreshæµç¨‹åˆ†æ"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º","æ€»ç»“æ–‡ç« "],"content":"EventThread threadMain Android13 EventThread threadMainæµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/:4:8","tags":["clippings","è½¬è½½","blog"],"title":"Android SurfaceFlinger-CSDNåšå®¢","uri":"/posts/android-surfaceflinger-csdn%E5%8D%9A%E5%AE%A2/#eventthread-threadmain"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"GraphicBufferç”¨äºç®¡ç†å›¾å½¢ç¼“å­˜æ•°æ®çš„ç±»ï¼ŒGraphicBufferçš„æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š //frameworks/native/libs/ui/GraphicBuffer.cpp class GraphicBuffer : public ANativeObjectBase\u003cANativeWindowBuffer, GraphicBuffer, RefBase\u003e, public Flattenable\u003cGraphicBuffer\u003e{ GraphicBuffer::GraphicBuffer(uint32_t inWidth, uint32_t inHeight, PixelFormat inFormat, uint32_t inLayerCount, uint64_t inUsage, std::string requestorName) : GraphicBuffer() { mInitCheck = initWithSize(inWidth, inHeight, inFormat, inLayerCount, inUsage, std::move(requestorName)); } } GraphicBuffer çš„æ„é€ å‡½æ•°éå¸¸ç®€å•, å®ƒåªæ˜¯è°ƒç”¨äº†ä¸€ä¸ªåˆå§‹åŒ–å‡½æ•° initWithSizeï¼š //frameworks/native/libs/ui/GraphicBuffer.cpp class GraphicBuffer : public ANativeObjectBase\u003cANativeWindowBuffer, GraphicBuffer, RefBase\u003e, public Flattenable\u003cGraphicBuffer\u003e{ status_t GraphicBuffer::initWithSize(uint32_t inWidth, uint32_t inHeight, PixelFormat inFormat, uint32_t inLayerCount, uint64_t inUsage, std::string requestorName){ // è·å–ä¸€ä¸ª GraphicBufferAllocator å¯¹è±¡, è¿™ä¸ªå¯¹è±¡æ˜¯ä¸€ä¸ªå•ä¾‹ // GraphicBufferAllocator ä¸»è¦è´Ÿè´£ GraphicBuffer çš„å†…å­˜åˆ†é… GraphicBufferAllocator\u0026 allocator = GraphicBufferAllocator::get(); uint32_t outStride = 0; // åˆ†é…ä¸€å—åˆ¶å®šå®½é«˜çš„ GraphicBuffer status_t err = allocator.allocate(inWidth, inHeight, inFormat, inLayerCount, inUsage, \u0026handle, \u0026outStride, mId, std::move(requestorName)); if (err == NO_ERROR) { // é€šè¿‡ GraphicBufferMapper å°†è¿™å— GraphicBuffer çš„å‚æ•°è®°å½•ä¸‹æ¥ // GraphicBufferMapper è´Ÿè´£çš„æ˜¯ GraphicBuffer çš„å†…å­˜æ˜ å°„ mBufferMapper.getTransportSize(handle, \u0026mTransportNumFds, \u0026mTransportNumInts); // åˆå§‹åŒ–å‚æ•° width = static_cast\u003cint\u003e(inWidth); height = static_cast\u003cint\u003e(inHeight); format = inFormat; layerCount = inLayerCount; usage = inUsage; usage_deprecated = int(usage); stride = static_cast\u003cint\u003e(outStride); } return err; } } è°ƒç”¨allocator(GraphicBufferAllocator)çš„allocateæ–¹æ³•ï¼Œåˆ†é…ä¸€å—åˆ¶å®šå®½é«˜çš„ GraphicBufferï¼š //frameworks/native/libs/ui/GraphicBufferAllocator.cpp class GraphicBufferAllocator : public Singleton\u003cGraphicBufferAllocator\u003e { status_t GraphicBufferAllocator::allocate(uint32_t width, uint32_t height, PixelFormat format, uint32_t layerCount, uint64_t usage, buffer_handle_t* handle, uint32_t* stride, uint64_t /*graphicBufferId*/, std::string requestorName) { return allocateHelper(width, height, format, layerCount, usage, handle, stride, requestorName, true); } } ","date":"2024-11-06","objectID":"/posts/android13-graphicbuffer-%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 GraphicBuffer åˆ›å»ºæµç¨‹-CSDNåšå®¢","uri":"/posts/android13-graphicbuffer-%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"GraphicBufferAllocator allocateHelper è°ƒç”¨GraphicBufferAllocatorçš„allocateHelperæ–¹æ³•ï¼š //frameworks/native/libs/ui/GraphicBufferAllocator.cpp class GraphicBufferAllocator : public Singleton\u003cGraphicBufferAllocator\u003e { std::unique_ptr\u003cconst GrallocAllocator\u003e mAllocator; status_t GraphicBufferAllocator::allocateHelper(uint32_t width, uint32_t height, PixelFormat format, uint32_t layerCount, uint64_t usage, buffer_handle_t* handle, uint32_t* stride, std::string requestorName, bool importBuffer) { ATRACE_CALL(); // make sure to not allocate a N x 0 or 0 x N buffer, since this is // allowed from an API stand-point allocate a 1x1 buffer instead. // å¦‚æœå®½æˆ–è€…é«˜ä¸º0, åˆ™å°†å®½é«˜è®¾ç½®ä¸º1 if (!width || !height) width = height = 1; const uint32_t bpp = bytesPerPixel(format); if (std::numeric_limits\u003csize_t\u003e::max() / width / height \u003c static_cast\u003csize_t\u003e(bpp)) { ALOGE(\"Failed to allocate (%u x %u) layerCount %u format %d \" \"usage %\" PRIx64 \": Requesting too large a buffer size\", width, height, layerCount, format, usage); return BAD_VALUE; } // Ensure that layerCount is valid. // å¦‚æœå›¾å±‚çš„æ•°é‡å°‘äº1, åˆ™å°†å›¾å±‚çš„æ•°é‡è®¾ç½®ä¸º1 if (layerCount \u003c 1) { layerCount = 1; } // TODO(b/72323293, b/72703005): Remove these invalid bits from callers usage \u0026= ~static_cast\u003cuint64_t\u003e((1 \u003c\u003c 10) | (1 \u003c\u003c 13)); // åˆ†é…å†…å­˜ï¼Œä½¿ç”¨çš„æ˜¯ GrallocAllocator æŒ‡é’ˆï¼Œæ ¹æ®ä¸åŒçš„ç‰ˆæœ¬æœ‰å“¦ä¸åŒçš„å®ç°ï¼Œè¿™é‡Œæˆ‘ä»¬å‡è®¾å®ƒçš„å®ç°æ˜¯ Gralloc3Allocator status_t error = mAllocator-\u003eallocate(requestorName, width, height, format, layerCount, usage, 1, stride, handle, importBuffer); if (error != NO_ERROR) { ALOGE(\"Failed to allocate (%u x %u) layerCount %u format %d \" \"usage %\" PRIx64 \": %d\", width, height, layerCount, format, usage, error); return error; } if (!importBuffer) { return NO_ERROR; } size_t bufSize; // if stride has no meaning or is too large, // approximate size with the input width instead if ((*stride) != 0 \u0026\u0026 std::numeric_limits\u003csize_t\u003e::max() / height / (*stride) \u003c static_cast\u003csize_t\u003e(bpp)) { bufSize = static_cast\u003csize_t\u003e(width) * height * bpp; } else { bufSize = static_cast\u003csize_t\u003e((*stride)) * height * bpp; } // åˆå§‹åŒ–å‚æ•° Mutex::Autolock _l(sLock); KeyedVector\u003cbuffer_handle_t, alloc_rec_t\u003e\u0026 list(sAllocList); alloc_rec_t rec; rec.width = width; rec.height = height; rec.stride = *stride; rec.format = format; rec.layerCount = layerCount; rec.usage = usage; rec.size = bufSize; rec.requestorName = std::move(requestorName); list.add(*handle, rec); return NO_ERROR; } } ","date":"2024-11-06","objectID":"/posts/android13-graphicbuffer-%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 GraphicBuffer åˆ›å»ºæµç¨‹-CSDNåšå®¢","uri":"/posts/android13-graphicbuffer-%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B-csdn%E5%8D%9A%E5%AE%A2/#graphicbufferallocator-allocatehelper"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"Gralloc3Allocator allocate GrallocAllocatoræœ‰å¤šä¸ªå®ç°ç‰ˆæœ¬ï¼ŒGralloc3Allocatoræ˜¯å…¶ä¸­ä¸€ä¸ªç‰ˆæœ¬ï¼Œè°ƒç”¨Gralloc3Allocatorçš„allocateæ–¹æ³•ï¼š //framewrks/native/libs/ui/Gralloc3.cpp sp\u003chardware::graphics::allocator::V3_0::IAllocator\u003e mAllocator; class Gralloc3Allocator : public GrallocAllocator { status_t Gralloc3Allocator::allocate(std::string /*requestorName*/, uint32_t width, uint32_t height, android::PixelFormat format, uint32_t layerCount, uint64_t usage, uint32_t bufferCount, uint32_t* outStride, buffer_handle_t* outBufferHandles, bool importBuffers) const { IMapper::BufferDescriptorInfo descriptorInfo; sBufferDescriptorInfo(width, height, format, layerCount, usage, \u0026descriptorInfo); BufferDescriptor descriptor; status_t error = mMapper.createDescriptor(static_cast\u003cvoid*\u003e(\u0026descriptorInfo), static_cast\u003cvoid*\u003e(\u0026descriptor)); if (error != NO_ERROR) { return error; } auto ret = mAllocator-\u003eallocate(descriptor, bufferCount, [\u0026](const auto\u0026 tmpError, const auto\u0026 tmpStride, const auto\u0026 tmpBuffers) { error = static_cast\u003cstatus_t\u003e(tmpError); if (tmpError != Error::NONE) { return; } if (importBuffers) { for (uint32_t i = 0; i \u003c bufferCount; i++) { error = mMapper.importBuffer(tmpBuffers[i], \u0026outBufferHandles[i]); if (error != NO_ERROR) { for (uint32_t j = 0; j \u003c i; j++) { mMapper.freeBuffer(outBufferHandles[j]); outBufferHandles[j] = nullptr; } return; } } } else { for (uint32_t i = 0; i \u003c bufferCount; i++) { outBufferHandles[i] = native_handle_clone( tmpBuffers[i].getNativeHandle()); if (!outBufferHandles[i]) { for (uint32_t j = 0; j \u003c i; j++) { auto buffer = const_cast\u003cnative_handle_t*\u003e( outBufferHandles[j]); native_handle_close(buffer); native_handle_delete(buffer); outBufferHandles[j] = nullptr; } } } } *outStride = tmpStride; }); // make sure the kernel driver sees BC_FREE_BUFFER and closes the fds now hardware::IPCThreadState::self()-\u003eflushCommands(); return (ret.isOk()) ? error : static_cast\u003cstatus_t\u003e(kTransactionError); } } ","date":"2024-11-06","objectID":"/posts/android13-graphicbuffer-%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 GraphicBuffer åˆ›å»ºæµç¨‹-CSDNåšå®¢","uri":"/posts/android13-graphicbuffer-%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B-csdn%E5%8D%9A%E5%AE%A2/#gralloc3allocator-allocate"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"Surfaceçš„connectæ–¹æ³•ç”¨äºå»ºç«‹ä¸BufferQueueCoreAndroid13 BufferQueueLayer onFirstRefæµç¨‹åˆ†æ-CSDNåšå®¢#new BufferQueueCoreè¿æ¥ï¼Œä»£ç å¦‚ä¸‹ï¼š //frameworks/base/core/java/android/view/Surface.java class Surface : public ANativeObjectBase\u003cANativeWindow, Surface, RefBase\u003e { int Surface::connect(int api) { static sp\u003cIProducerListener\u003e listener = new StubProducerListener(); return connect(api, listener); } } è°ƒç”¨é‡è½½æ–¹æ³•ï¼š //frameworks/base/core/java/android/view/Surface.java class Surface : public ANativeObjectBase\u003cANativeWindow, Surface, RefBase\u003e { int Surface::connect(int api, const sp\u003cIProducerListener\u003e\u0026 listener) { return connect(api, listener, false); } } è°ƒç”¨é‡è½½æ–¹æ³•ï¼š //frameworks/base/core/java/android/view/Surface.java sp\u003cIGraphicBufferProducer\u003e mGraphicBufferProducer; class Surface : public ANativeObjectBase\u003cANativeWindow, Surface, RefBase\u003e { int Surface::connect( int api, const sp\u003cIProducerListener\u003e\u0026 listener, bool reportBufferRemoval) { ATRACE_CALL(); ALOGV(\"Surface::connect\"); Mutex::Autolock lock(mMutex); IGraphicBufferProducer::QueueBufferOutput output; mReportRemovedBuffers = reportBufferRemoval; int err = mGraphicBufferProducer-\u003econnect(listener, api, mProducerControlledByApp, \u0026output); if (err == NO_ERROR) { mDefaultWidth = output.width; mDefaultHeight = output.height; mNextFrameNumber = output.nextFrameNumber; mMaxBufferCount = output.maxBufferCount; // Ignore transform hint if sticky transform is set or transform to display inverse flag is // set. Transform hint should be ignored if the client is expected to always submit buffers // in the same orientation. if (mStickyTransform == 0 \u0026\u0026 !transformToDisplayInverse()) { mTransformHint = output.transformHint; } mConsumerRunningBehind = (output.numPendingBuffers \u003e= 2); } if (!err \u0026\u0026 api == NATIVE_WINDOW_API_CPU) { mConnectedToCpu = true; // Clear the dirty region in case we're switching from a non-CPU API mDirtyRegion.clear(); } else if (!err) { // Initialize the dirty region for tracking surface damage mDirtyRegion = Region::INVALID_REGION; } return err; } } è°ƒç”¨mGraphicBufferProducer(IGraphicBufferProducer)çš„connectæ–¹æ³•ï¼ŒIGraphicBufferProduceræ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”±BpGraphicBufferProducer å®ç°ï¼š //frameworks/native/libs/gui/IGraphicBufferProducer.cpp class BpGraphicBufferProducer : public BpInterface\u003cIGraphicBufferProducer\u003e { virtual status_t connect(const sp\u003cIProducerListener\u003e\u0026 listener, int api, bool producerControlledByApp, QueueBufferOutput* output) { Parcel data, reply; data.writeInterfaceToken(IGraphicBufferProducer::getInterfaceDescriptor()); if (listener != nullptr) { data.writeInt32(1); data.writeStrongBinder(IInterface::asBinder(listener)); } else { data.writeInt32(0); } data.writeInt32(api); data.writeInt32(producerControlledByApp); status_t result = remote()-\u003etransact(CONNECT, data, \u0026reply); if (result != NO_ERROR) { return result; } reply.read(*output); result = reply.readInt32(); return result; } } å‘é€CONNECTæ¶ˆæ¯ï¼Œå‘é€çš„æ¶ˆæ¯åœ¨onTransactä¸­å¤„ç†ï¼š //frameworks/native/libs/gui/IGraphicBufferProducer.cpp status_t BnGraphicBufferProducer::onTransact( uint32_t code, const Parcel\u0026 data, Parcel* reply, uint32_t flags) { switch(code) { case CONNECT: { CHECK_INTERFACE(IGraphicBufferProducer, data, reply); sp\u003cIProducerListener\u003e listener; if (data.readInt32() == 1) { listener = IProducerListener::asInterface(data.readStrongBinder()); } int api = data.readInt32(); bool producerControlledByApp = data.readInt32(); QueueBufferOutput output; status_t res = connect(listener, api, producerControlledByApp, \u0026output); reply-\u003ewrite(output); reply-\u003ewriteInt32(res); return NO_ERROR; } } } ","date":"2024-11-06","objectID":"/posts/android13-surface-connect%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 Surface connectæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surface-connect%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"BufferQueueProducer connect è°ƒç”¨BnGraphicBufferProducerçš„connectæ–¹æ³•ï¼ŒBufferQueueProducerç»§æ‰¿äºBnGraphicBufferProducerï¼Œè°ƒç”¨BufferQueueProducerçš„connectæ–¹æ³•ï¼š //frameworks/native/libs/gui/BufferQueueProducer.cpp class BufferQueueProducer : public BnGraphicBufferProducer, private IBinder::DeathRecipient { sp\u003cBufferQueueCore\u003e mCore; status_t BufferQueueProducer::connect(const sp\u003cIProducerListener\u003e\u0026 listener, int api, bool producerControlledByApp, QueueBufferOutput *output) { ATRACE_CALL(); std::lock_guard\u003cstd::mutex\u003e lock(mCore-\u003emMutex); mConsumerName = mCore-\u003emConsumerName; BQ_LOGV(\"connect: api=%d producerControlledByApp=%s\", api, producerControlledByApp ? \"true\" : \"false\"); if (mCore-\u003emIsAbandoned) { BQ_LOGE(\"connect: BufferQueue has been abandoned\"); return NO_INIT; } if (mCore-\u003emConsumerListener == nullptr) { BQ_LOGE(\"connect: BufferQueue has no consumer\"); return NO_INIT; } if (output == nullptr) { BQ_LOGE(\"connect: output was NULL\"); return BAD_VALUE; } //å¦‚æœå·²ç»è¿æ¥è¿‡ï¼Œå°±ä¸å…è®¸å†é“¾æ¥ã€‚ä¹Ÿå°±æ˜¯BufferQueueCoreåªå…è®¸ç”±ä¸€ä¸ªconnected producer if (mCore-\u003emConnectedApi != BufferQueueCore::NO_CONNECTED_API) { BQ_LOGE(\"connect: already connected (cur=%d req=%d)\", mCore-\u003emConnectedApi, api); return BAD_VALUE; } int delta = mCore-\u003egetMaxBufferCountLocked(mCore-\u003emAsyncMode, mDequeueTimeout \u003c 0 ? mCore-\u003emConsumerControlledByApp \u0026\u0026 producerControlledByApp : false, mCore-\u003emMaxBufferCount) - mCore-\u003egetMaxBufferCountLocked(); if (!mCore-\u003eadjustAvailableSlotsLocked(delta)) { BQ_LOGE(\"connect: BufferQueue failed to adjust the number of available \" \"slots. Delta = %d\", delta); return BAD_VALUE; } int status = NO_ERROR; switch (api) { case NATIVE_WINDOW_API_EGL: case NATIVE_WINDOW_API_CPU: case NATIVE_WINDOW_API_MEDIA: case NATIVE_WINDOW_API_CAMERA: mCore-\u003emConnectedApi = api; output-\u003ewidth = mCore-\u003emDefaultWidth; output-\u003eheight = mCore-\u003emDefaultHeight; output-\u003etransformHint = mCore-\u003emTransformHintInUse = mCore-\u003emTransformHint; output-\u003enumPendingBuffers = static_cast\u003cuint32_t\u003e(mCore-\u003emQueue.size()); output-\u003enextFrameNumber = mCore-\u003emFrameCounter + 1; output-\u003ebufferReplaced = false; output-\u003emaxBufferCount = mCore-\u003emMaxBufferCount; if (listener != nullptr) { // Set up a death notification so that we can disconnect // automatically if the remote producer dies #ifndef NO_BINDER if (IInterface::asBinder(listener)-\u003eremoteBinder() != nullptr) { status = IInterface::asBinder(listener)-\u003elinkToDeath( static_cast\u003cIBinder::DeathRecipient*\u003e(this)); if (status != NO_ERROR) { BQ_LOGE(\"connect: linkToDeath failed: %s (%d)\", strerror(-status), status); } mCore-\u003emLinkedToDeath = listener; } #endif mCore-\u003emConnectedProducerListener = listener; mCore-\u003emBufferReleasedCbEnabled = listener-\u003eneedsReleaseNotify(); } break; default: BQ_LOGE(\"connect: unknown API %d\", api); status = BAD_VALUE; break; } mCore-\u003emConnectedPid = BufferQueueThreadState::getCallingPid(); mCore-\u003emBufferHasBeenQueued = false; mCore-\u003emDequeueBufferCannotBlock = false; mCore-\u003emQueueBufferCanDrop = false; mCore-\u003emLegacyBufferDrop = true; if (mCore-\u003emConsumerControlledByApp \u0026\u0026 producerControlledByApp) { mCore-\u003emDequeueBufferCannotBlock = mDequeueTimeout \u003c 0; mCore-\u003emQueueBufferCanDrop = mDequeueTimeout \u003c= 0; } mCore-\u003emAllowAllocation = true; VALIDATE_CONSISTENCY(); return status; } } ","date":"2024-11-06","objectID":"/posts/android13-surface-connect%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 Surface connectæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surface-connect%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#bufferqueueproducer-connect"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"SurfaceControlæ˜¯Androidç³»ç»Ÿä¸­çš„ä¸€ä¸ªç±»ï¼Œç”¨äºç®¡ç†å’Œæ§åˆ¶Surfaceçš„åˆ›å»ºã€æ˜¾ç¤ºå’Œé”€æ¯ï¼ŒSurfaceControlçš„åˆ›å»ºè¿‡ç¨‹å¦‚ä¸‹ï¼š ä¸‹é¢åˆ†æWindowManagerServiceåˆ›å»ºSurfaceControlçš„æ­¥éª¤ï¼š é¦–å…ˆåº”ç”¨è¿›ç¨‹ä¼šnewä¸€ä¸ªjavaå±‚SurfaceControlï¼Œä»€ä¹ˆéƒ½æ²¡åšï¼Œç„¶åä¼ é€’åˆ°WMSè¿›ç¨‹ï¼Œå› ä¸ºSurfaceControlåœ¨AIDLä¸­æ˜¯outç±»å‹ï¼Œæ‰€ä»¥åœ¨WMSè¿›ç¨‹èµ‹å€¼ã€‚ WMSåœ¨åˆ›å»ºjavaå±‚SurfaceControlçš„åŒæ—¶é€šè¿‡nativeCreateæ–¹æ³•åˆ°nativeå±‚åšä¸€ç³»åˆ—åˆå§‹åŒ–ã€‚ åœ¨SurfaceComposerClientçš„createSurfaceCheckedå‡½æ•°ä¸­é€šè¿‡ISurfaceComposerClientçš„Bpç«¯mClientå‘SurfaceFlingerè¿›ç¨‹è¯·æ±‚åˆ›å»ºSurfaceï¼Œå³è°ƒç”¨createSurfaceå‡½æ•°ï¼Œè€Œåœ¨SurfaceFlingerè¿›ç¨‹Surfaceå¯¹åº”çš„æ˜¯Layerã€‚ åœ¨ç¬¬ä¸€æ¬¡åˆ›å»ºLayerçš„å­ç±»BufferQueueLayerçš„è¿‡ç¨‹ä¸­ï¼Œå³åœ¨BufferQueueLayerçš„onFirstRefå‡½æ•°ä¸­ä¼šåˆ›å»ºç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹æ¶æ„ã€‚Android13 BufferQueueLayer onFirstRefæµç¨‹åˆ†æ-CSDNåšå®¢ SurfaceFlingerè¿›ç¨‹çš„ä»»åŠ¡å®Œæˆä¹‹åä¼šç›´æ¥newä¸€ä¸ªSurfaceControlï¼Œå¹¶å°†SurfaceFlingerè¿›ç¨‹åˆ›å»ºçš„Layerå¼•ç”¨å’Œç”Ÿäº§è€…ä¿å­˜åˆ°SurfaceControlä¸­ï¼Œæœ€åå°†nativeå±‚SurfaceControlæŒ‡é’ˆä¿å­˜åˆ°javaå±‚SurfaceControlã€‚ nativeå±‚SurfaceControlåˆ›å»ºå¥½äº†ä¹‹åå°±å¯ä»¥é€šè¿‡æ­¤å¯¹è±¡åˆ›å»ºnativeå±‚çš„Surfaceå¯¹è±¡ï¼Œæœ€åå°†nativeå±‚SurfaceæŒ‡é’ˆä¿å­˜åˆ°javaå±‚Surfaceï¼Œæœ€ç»ˆjavaå±‚å’Œnativeå±‚çš„Surfaceå’ŒSurfaceControléƒ½åˆ›å»ºå®Œæ¯•ã€‚ ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä»£ç åˆ†æï¼Œé¦–å…ˆåœ¨WindowManagerServiceçš„relayoutWindowæ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨createSurfaceControlæ–¹æ³•ï¼š æˆ‘ä»¬ç»§ç»­ä»SurfaceControlæ„é€ å™¨(SurfaceControl.Builder)çš„buildæ–¹æ³•å¼€å§‹åˆ†æSurfaceControlçš„åˆ›å»ºè¿‡ç¨‹ï¼š //frameworks/base/core/java/android/view/SurfaceControl.java public final class SurfaceControl implements Parcelable { public static class Builder { public SurfaceControl build() { if (mWidth \u003c 0 || mHeight \u003c 0) { throw new IllegalStateException( \"width and height must be positive or unset\"); } if ((mWidth \u003e 0 || mHeight \u003e 0) \u0026\u0026 (isEffectLayer() || isContainerLayer())) { throw new IllegalStateException( \"Only buffer layers can set a valid buffer size.\"); } if ((mFlags \u0026 FX_SURFACE_MASK) == FX_SURFACE_NORMAL) { setBLASTLayer(); } return new SurfaceControl( mSession, mName, mWidth, mHeight, mFormat, mFlags, mParent, mMetadata, mLocalOwnerView, mCallsite); } } } ç›´æ¥é€šè¿‡newçš„æ–¹å¼åˆ›å»ºSurfaceControlï¼Œæ¥ç€çœ‹SurfaceControlçš„æ„é€ æ–¹æ³•ï¼š // frameworks/base/core/java/android/view/SurfaceControl.java private SurfaceControl(SurfaceSession session, String name, int w, int h, int format, int flags, SurfaceControl parent, SparseIntArray metadata) throws OutOfResourcesException, IllegalArgumentException { ...... mName = name; mWidth = w; mHeight = h; Parcel metaParcel = Parcel.obtain(); try { if (metadata != null \u0026\u0026 metadata.size() \u003e 0) { metaParcel.writeInt(metadata.size()); for (int i = 0; i \u003c metadata.size(); ++i) { metaParcel.writeInt(metadata.keyAt(i)); metaParcel.writeByteArray( ByteBuffer.allocate(4).order(ByteOrder.nativeOrder()) .putInt(metadata.valueAt(i)).array()); } metaParcel.setDataPosition(0); } mNativeObject = nativeCreate(session, name, w, h, format, flags, parent != null ? parent.mNativeObject : 0, metaParcel); } finally { metaParcel.recycle(); } if (mNativeObject == 0) { throw new OutOfResourcesException( \"Couldn't allocate SurfaceControl native object\"); } mCloseGuard.open(\"release\"); } è¿™é‡Œé¢æ ¸å¿ƒå°±æ˜¯è°ƒç”¨nativeCreateæ–¹æ³•ï¼Œå¹¶å°†windowçš„å„ç§æ•°æ®ä¸€å¹¶ä¼ é€’åˆ°nativeå±‚å¤„ç†ï¼Œå¯¹åº”çš„nativeç±»æ˜¯android_view_SurfaceControlã€‚ // frameworks/base/core/jni/android_view_SurfaceControl.cpp static jlong nativeCreate(JNIEnv* env, jclass clazz, jobject sessionObj, jstring nameStr, jint w, jint h, jint format, jint flags, jlong parentObject, jobject metadataParcel) { ScopedUtfChars name(env, nameStr); //åº”ç”¨å±‚è®¿é—®SurfaceFlingerçš„clientç«¯ sp\u003cSurfaceComposerClient\u003e client; //è¿™é‡Œçš„sessionObjæ˜¯javaå±‚ä¼ é€’ä¸‹æ¥çš„SurfaceSessionå¯¹è±¡ï¼Œå¦‚æœä¸ä¸ºç©ºå°±ä»æ­¤å¯¹è±¡ä¸­è·å–SurfaceComposerClientï¼Œå¦åˆ™é‡æ–°åˆ›å»ºä¸€ä¸ª //addview --\u003e viewrootImpl åˆ›å»º SurfaceSession --\u003e natvieCreate //--\u003e SurfaceComposerClient åˆ›å»º if (sessionObj != NULL) { client = android_view_SurfaceSession_getClient(env, sessionObj); } else { client = SurfaceComposerClient::getDefault(); } //parentObjectæ˜¯javaå±‚ä¼ é€’ä¸‹æ¥çš„SurfaceControlï¼Œå°†å…¶å¼ºè½¬ä¸ºnativeå±‚SurfaceControlï¼ŒparentObjectæœ‰å¯èƒ½ä¸ºç©ºçš„ SurfaceControl *parent = reinterpret_cast\u003cSurfaceControl*\u003e(parentObject); sp\u003cSurfaceControl\u003e surface; LayerMetadata metadata; Parcel* parcel = parcelForJavaObject(env, metadataParcel); if (parcel \u0026\u0026 !parcel-\u003eobjectsCount()) { status_t err = metadata.readFromParcel(parcel); if (err != NO_ERROR) { jniThrowException(env, \"java/lang/IllegalArgumentException\", \"Metadata parcel has wrong format\"); } } //æ­¤å‡½æ•°æ˜¯å…·ä½“åˆå§‹åŒ–SurfaceControlçš„å‡½æ•° status_t err = client","date":"2024-11-06","objectID":"/posts/android13-surfacecontrol%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceControlåˆ›å»ºæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfacecontrol%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"ISurfaceComposerClient createSurface è°ƒç”¨mClient(ISurfaceComposerClient)çš„createSurfaceæ–¹æ³•åˆ›å»ºSurfaceï¼š //frameworks/native/libs/gui/ISurfaceComposerClient.cpp class BpSurfaceComposerClient : public SafeBpInterface\u003cISurfaceComposerClient\u003e { status_t createSurface(const String8\u0026 name, uint32_t width, uint32_t height, PixelFormat format, uint32_t flags, const sp\u003cIBinder\u003e\u0026 parent, LayerMetadata metadata, sp\u003cIBinder\u003e* handle, sp\u003cIGraphicBufferProducer\u003e* gbp, int32_t* outLayerId, uint32_t* outTransformHint) override { return callRemote\u003cdecltype(\u0026ISurfaceComposerClient::createSurface)\u003e(Tag::CREATE_SURFACE, name, width, height, format, flags, parent, std::move(metadata), handle, gbp, outLayerId, outTransformHint); } } è°ƒç”¨callRemoteæ–¹æ³•ï¼Œä¹‹åBnSurfaceComposerClientçš„onTransactæ–¹æ³•ä¼šè¿è¡Œï¼š //frameworks/native/libs/gui/ISurfaceComposerClient.cpp status_t BnSurfaceComposerClient::onTransact(uint32_t code, const Parcel\u0026 data, Parcel* reply, uint32_t flags) { if (code \u003c IBinder::FIRST_CALL_TRANSACTION || code \u003e static_cast\u003cuint32_t\u003e(Tag::LAST)) { return BBinder::onTransact(code, data, reply, flags); } auto tag = static_cast\u003cTag\u003e(code); switch (tag) { case Tag::CREATE_SURFACE: return callLocal(data, reply, \u0026ISurfaceComposerClient::createSurface); case Tag::CREATE_WITH_SURFACE_PARENT: return callLocal(data, reply, \u0026ISurfaceComposerClient::createWithSurfaceParent); case Tag::CLEAR_LAYER_FRAME_STATS: return callLocal(data, reply, \u0026ISurfaceComposerClient::clearLayerFrameStats); case Tag::GET_LAYER_FRAME_STATS: return callLocal(data, reply, \u0026ISurfaceComposerClient::getLayerFrameStats); case Tag::MIRROR_SURFACE: return callLocal(data, reply, \u0026ISurfaceComposerClient::mirrorSurface); } } ","date":"2024-11-06","objectID":"/posts/android13-surfacecontrol%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceControlåˆ›å»ºæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfacecontrol%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#isurfacecomposerclient-createsurface"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"Client createSurface è°ƒç”¨Clientçš„createSurfaceå‡½æ•°ï¼š Android13 Surfaceåˆ›å»ºæµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android13-surfacecontrol%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceControlåˆ›å»ºæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfacecontrol%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#client-createsurface"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"new SurfaceControl é€šè¿‡newçš„æ–¹å¼åˆ›å»ºSurfaceControlï¼ŒSurfaceControlçš„æ„é€ å‡½æ•°ï¼š // frameworks/native/libs/gui/SurfaceControl.cpp SurfaceControl::SurfaceControl( const sp\u003cSurfaceComposerClient\u003e\u0026 client, const sp\u003cIBinder\u003e\u0026 handle, const sp\u003cIGraphicBufferProducer\u003e\u0026 gbp, bool owned) : mClient(client), mHandle(handle), mGraphicBufferProducer(gbp), mOwned(owned), mExtension(mHandle, \u0026mGraphicBufferProducer, mOwned) { } ","date":"2024-11-06","objectID":"/posts/android13-surfacecontrol%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceControlåˆ›å»ºæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfacecontrol%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#new-surfacecontrol"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"åœ¨Android13ç‰ˆæœ¬ä¸­ï¼ŒSurfaceFlingeræ˜¯ç”±Android.bpå»å¯åŠ¨init.rcæ–‡ä»¶ï¼Œç„¶åå†è§£ææ–‡ä»¶å»åŠ è½½SurfaceFlingerã€‚ //frameworks/native/services/surfaceflinger/SurfaceFlinger.rc service surfaceflinger /system/bin/surfaceflinger class core animation user system group graphics drmrpc readproc capabilities SYS_NICE onrestart restart --only-if-running zygote task_profiles HighPerformance socket pdx/system/vr/display/client stream 0666 system graphics u:object_r:pdx_display_client_endpoint_socket:s0 socket pdx/system/vr/display/manager stream 0666 system graphics u:object_r:pdx_display_manager_endpoint_socket:s0 socket pdx/system/vr/display/vsync stream 0666 system graphics u:object_r:pdx_display_vsync_endpoint_socket:s0 on property:vendor.debug.sf.restart=1 restart surfaceflinger on property:init.svc.zygote=restarting \u0026\u0026 property:debug.sf.toomanylayers=1 restart surfaceflinger setprop debug.sf.toomanylayers \"0\" ç„¶åä»¥æ­¤æ¥è°ƒç”¨main_SurfaceFlinger.cppæ–‡ä»¶çš„mainå‡½æ•°ï¼š //frameworks/native/services/surfacefilinger/main_SurfaceFlinger.cpp int main(int, char**) { signal(SIGPIPE, SIG_IGN); hardware::configureRpcThreadpool(1 /* maxThreads */, false /* callerWillJoin */); startGraphicsAllocatorService(); // When SF is launched in its own process, limit the number of // binder threads to 4. ProcessState::self()-\u003esetThreadPoolMaxThreadCount(4); // Set uclamp.min setting on all threads, maybe an overkill but we want // to cover important threads like RenderEngine. if (SurfaceFlinger::setSchedAttr(true) != NO_ERROR) { ALOGW(\"Couldn't set uclamp.min: %s\\n\", strerror(errno)); } // The binder threadpool we start will inherit sched policy and priority // of (this) creating thread. We want the binder thread pool to have // SCHED_FIFO policy and priority 1 (lowest RT priority) // Once the pool is created we reset this thread's priority back to // original. int newPriority = 0; int origPolicy = sched_getscheduler(0); struct sched_param origSchedParam; int errorInPriorityModification = sched_getparam(0, \u0026origSchedParam); if (errorInPriorityModification == 0) { int policy = SCHED_FIFO; newPriority = sched_get_priority_min(policy); struct sched_param param; param.sched_priority = newPriority; errorInPriorityModification = sched_setscheduler(0, policy, \u0026param); } // start the thread pool //æ„å»ºProcessStateå…¨å±€å¯¹è±¡gProcessï¼Œæ‰“å¼€binderé©±åŠ¨ï¼Œå»ºç«‹é“¾æ¥ //åœ¨é©±åŠ¨å†…éƒ¨åˆ›å»ºè¯¥è¿›ç¨‹çš„binder_proc,binder_threadç»“æ„ï¼Œä¿å­˜è¯¥è¿›ç¨‹çš„è¿›ç¨‹ä¿¡æ¯å’Œçº¿ç¨‹ä¿¡æ¯ï¼Œå¹¶åŠ å…¥é©±åŠ¨çš„çº¢é»‘æ ‘é˜Ÿåˆ—ä¸­ã€‚ //è·å–é©±åŠ¨çš„ç‰ˆæœ¬ä¿¡æ¯ï¼ŒæŠŠè¯¥è¿›ç¨‹æœ€å¤šå¯åŒæ—¶å¯åŠ¨çš„çº¿ç¨‹å‘Šè¯‰é©±åŠ¨ï¼Œå¹¶ä¿å­˜åˆ°æ”¹è¿›ç¨‹çš„binder_procç»“æ„ä¸­ //æŠŠè®¾å¤‡æ–‡ä»¶/dev/binderæ˜ å°„åˆ°å†…å­˜ä¸­ sp\u003cProcessState\u003e ps(ProcessState::self()); ps-\u003estartThreadPool(); // Reset current thread's policy and priority if (errorInPriorityModification == 0) { errorInPriorityModification = sched_setscheduler(0, origPolicy, \u0026origSchedParam); } else { ALOGE(\"Failed to set SurfaceFlinger binder threadpool priority to SCHED_FIFO\"); } // instantiate surfaceflinger // å®ä¾‹åŒ–surfaceflinger sp\u003cSurfaceFlinger\u003e flinger = surfaceflinger::createSurfaceFlinger(); // Set the minimum policy of surfaceflinger node to be SCHED_FIFO. // So any thread with policy/priority lower than {SCHED_FIFO, 1}, will run // at least with SCHED_FIFO policy and priority 1. if (errorInPriorityModification == 0) { flinger-\u003esetMinSchedulerPolicy(SCHED_FIFO, newPriority); } //è®¾ç½®ä¼˜å…ˆçº§ setpriority(PRIO_PROCESS, 0, PRIORITY_URGENT_DISPLAY); //æŠŠSFçš„è‡ªèº«è°ƒç”¨é™åˆ¶åœ¨4çº¿ç¨‹ set_sched_policy(0, SP_FOREGROUND); // Put most SurfaceFlinger threads in the system-background cpuset // Keeps us from unnecessarily using big cores // Do this after the binder thread pool init if (cpusets_enabled()) set_cpuset_policy(0, SP_SYSTEM); // initialize before clients can connect // åœ¨å®¢æˆ·ç«¯è¿æ¥ä¹‹å‰è¿›è¡Œåˆå§‹åŒ– flinger-\u003einit(); // publish surface flinger // å°†surfaceflingeræ”¾å…¥servicemanager sp\u003cIServiceManager\u003e sm(defaultServiceManager()); sm-\u003eaddService(String16(SurfaceFlinger::getServiceName()), flinger, false, IServiceManager::DUMP_FLAG_PRIORITY_CRITICAL | IServiceManager::DUMP_FLAG_PROTO); // publish gui::ISurfaceComposer, the new AIDL interface sp\u003cSurfaceComposerAIDL\u003e composerAIDL = new SurfaceComposerAIDL(flinger); sm-\u003eaddService(","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlingerå¯åŠ¨æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"surfaceflinger createSurfaceFlinger é€šè¿‡è°ƒç”¨surfaceflingerçš„createSurfaceFlingeræ–¹æ³•å®ä¾‹åŒ–surfaceflingerï¼š //frameworks/native/services/surfaceflinger/SurfaceflingerFactory.cpp sp\u003cSurfaceFlinger\u003e createSurfaceFlinger() { static DefaultFactory factory; return new SurfaceFlinger(factory); } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlingerå¯åŠ¨æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-createsurfaceflinger"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"new surfaceflinger é€šè¿‡newçš„æ–¹å¼åˆ›å»ºsurfaceflingerå¯¹è±¡ï¼Œsurfaceflingerçš„æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp SurfaceFlinger::SurfaceFlinger(Factory\u0026 factory) : SurfaceFlinger(factory, SkipInitialization) { ALOGI(\"SurfaceFlinger is starting\"); hasSyncFramework = running_without_sync_framework(true); dispSyncPresentTimeOffset = present_time_offset_from_vsync_ns(0); useHwcForRgbToYuv = force_hwc_copy_for_virtual_displays(false); maxFrameBufferAcquiredBuffers = max_frame_buffer_acquired_buffers(2); maxGraphicsWidth = std::max(max_graphics_width(0), 0); maxGraphicsHeight = std::max(max_graphics_height(0), 0); hasWideColorDisplay = has_wide_color_display(false); mDefaultCompositionDataspace = static_cast\u003cui::Dataspace\u003e(default_composition_dataspace(Dataspace::V0_SRGB)); mWideColorGamutCompositionDataspace = static_cast\u003cui::Dataspace\u003e(wcg_composition_dataspace( hasWideColorDisplay ? Dataspace::DISPLAY_P3 : Dataspace::V0_SRGB)); defaultCompositionDataspace = mDefaultCompositionDataspace; wideColorGamutCompositionDataspace = mWideColorGamutCompositionDataspace; defaultCompositionPixelFormat = static_cast\u003cui::PixelFormat\u003e( default_composition_pixel_format(ui::PixelFormat::RGBA_8888)); wideColorGamutCompositionPixelFormat = static_cast\u003cui::PixelFormat\u003e(wcg_composition_pixel_format(ui::PixelFormat::RGBA_8888)); mColorSpaceAgnosticDataspace = static_cast\u003cui::Dataspace\u003e(color_space_agnostic_dataspace(Dataspace::UNKNOWN)); mLayerCachingEnabled = [] { const bool enable = android::sysprop::SurfaceFlingerProperties::enable_layer_caching().value_or(false); return base::GetBoolProperty(std::string(\"debug.sf.enable_layer_caching\"), enable); }(); useContextPriority = use_context_priority(true); mInternalDisplayPrimaries = sysprop::getDisplayNativePrimaries(); // debugging stuff... char value[PROPERTY_VALUE_MAX]; property_get(\"ro.bq.gpu_to_cpu_unsupported\", value, \"0\"); mGpuToCpuSupported = !atoi(value); property_get(\"ro.build.type\", value, \"user\"); mIsUserBuild = strcmp(value, \"user\") == 0; mDebugFlashDelay = base::GetUintProperty(\"debug.sf.showupdates\"s, 0u); // DDMS debugging deprecated (b/120782499) property_get(\"debug.sf.ddms\", value, \"0\"); int debugDdms = atoi(value); ALOGI_IF(debugDdms, \"DDMS debugging not supported\"); property_get(\"debug.sf.enable_gl_backpressure\", value, \"0\"); mPropagateBackpressureClientComposition = atoi(value); ALOGI_IF(mPropagateBackpressureClientComposition, \"Enabling backpressure propagation for Client Composition\"); property_get(\"ro.surface_flinger.supports_background_blur\", value, \"0\"); bool supportsBlurs = atoi(value); mSupportsBlur = supportsBlurs; ALOGI_IF(!mSupportsBlur, \"Disabling blur effects, they are not supported.\"); property_get(\"ro.sf.blurs_are_expensive\", value, \"0\"); mBlursAreExpensive = atoi(value); const size_t defaultListSize = ISurfaceComposer::MAX_LAYERS; auto listSize = property_get_int32(\"debug.sf.max_igbp_list_size\", int32_t(defaultListSize)); mMaxGraphicBufferProducerListSize = (listSize \u003e 0) ? size_t(listSize) : defaultListSize; mGraphicBufferProducerListSizeLogThreshold = std::max(static_cast\u003cint\u003e(0.95 * static_cast\u003cdouble\u003e(mMaxGraphicBufferProducerListSize)), 1); property_get(\"debug.sf.luma_sampling\", value, \"1\"); mLumaSampling = atoi(value); property_get(\"debug.sf.disable_client_composition_cache\", value, \"0\"); mDisableClientCompositionCache = atoi(value); property_get(\"debug.sf.predict_hwc_composition_strategy\", value, \"1\"); mPredictCompositionStrategy = atoi(value); property_get(\"debug.sf.treat_170m_as_sRGB\", value, \"0\"); mTreat170mAsSrgb = atoi(value); // We should be reading 'persist.sys.sf.color_saturation' here // but since /data may be encrypted, we need to wait until after vold // comes online to attempt to read the property. The property is // instead read after the boot animation if (base::GetBoolProperty(\"debug.sf.treble_testing_override\"s, false)) { // Without the override SurfaceFlinger cannot connect to HIDL // services that are not listed in the manifes","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlingerå¯åŠ¨æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#new-surfaceflinger"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"surfaceflinger init è°ƒç”¨flingerçš„init()æ–¹æ³•ï¼Œåœ¨å®¢æˆ·ç«¯è¿æ¥ä¹‹å‰è¿›è¡Œåˆå§‹åŒ–ï¼š åœ¨SurfaceFlinggeråˆå§‹åŒ–æ—¶ï¼Œä¼šå‘HWComposeræ³¨å†Œå›è°ƒï¼ŒHWComposerä¼šé€šè¿‡HWBinderå‘ç¡¬ä»¶æµ‹æ³¨å†Œå›è°ƒã€‚ SurfaceFlingeræ­å»ºå¥½å¤„ç†Vsyncçš„åŸºç¡€è®¾æ–½ï¼Œåˆå§‹åŒ–Schedulerï¼ŒDispVsyncSoureä»¥åŠæœ€é‡è¦çš„EventThreadã€‚ EventThreadçš„threadMainæ–¹æ³•æ— é™å¾ªç¯å¤„ç†pendingEvents,å¯¹Vsyncç±»å‹çš„Eventåˆ†å‘åˆ°æ¶ˆè´¹è€…ï¼Œé€šè¿‡å¾€æ¶ˆè´¹è€…çš„FDå†™æ•°æ®ï¼Œé€šçŸ¥APPæœ‰Vsyncä¿¡å·åˆ°æ¥ã€‚pendingEventsä¸­çš„æ¶ˆæ¯å¤„ç†å®Œäº†ï¼Œåˆ†å‘çº¿ç¨‹ç­‰å¾…mConditionçš„é€šçŸ¥ã€‚ å½“HWComposeræ”¶åˆ°ç¡¬ä»¶é€šè¿‡HWBinderå›è°ƒonVSyncEventæ—¶ï¼Œä¼šé€šè¿‡SurfaceFlingerçš„onVSyncEventæœ€ç»ˆè°ƒç”¨åˆ°EventThreadçš„onVSyncEventï¼Œäºæ˜¯è°ƒç”¨makeVSyncç”ŸæˆVsyncçš„Event, æ·»åŠ åˆ°pendingEvents,ç„¶åå†è°ƒç”¨mCondition.notify_all()å”¤èµ·ç­‰å¾…ä¸­çš„åˆ†å‘çº¿ç¨‹ã€‚ //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::init() { ALOGI( \"SurfaceFlinger's main thread ready to run. \" \"Initializing graphics H/W...\"); Mutex::Autolock _l(mStateLock); // Get a RenderEngine for the given display / config (can't fail) // TODO(b/77156734): We need to stop casting and use HAL types when possible. // Sending maxFrameBufferAcquiredBuffers as the cache size is tightly tuned to single-display. //è·å–ç»™å®šæ˜¾ç¤º/é…ç½®çš„ RenderEngineï¼Œå¹¶ä¸”è®¾ç½®ä¸€äº›å‚æ•° auto builder = renderengine::RenderEngineCreationArgs::Builder() .setPixelFormat(static_cast\u003cint32_t\u003e(defaultCompositionPixelFormat)) .setImageCacheSize(maxFrameBufferAcquiredBuffers) .setUseColorManagerment(useColorManagement) .setEnableProtectedContext(enable_protected_contents(false)) .setPrecacheToneMapperShaderOnly(false) .setSupportsBackgroundBlur(mSupportsBlur) .setContextPriority( useContextPriority ? renderengine::RenderEngine::ContextPriority::REALTIME : renderengine::RenderEngine::ContextPriority::MEDIUM); if (auto type = chooseRenderEngineTypeViaSysProp()) { builder.setRenderEngineType(type.value()); } mCompositionEngine-\u003esetRenderEngine(renderengine::RenderEngine::create(builder.build())); mMaxRenderTargetSize = std::min(getRenderEngine().getMaxTextureSize(), getRenderEngine().getMaxViewportDims()); // Set SF main policy after initializing RenderEngine which has its own policy. if (!SetTaskProfiles(0, {\"SFMainPolicy\"})) { ALOGW(\"Failed to set main task profile\"); } mCompositionEngine-\u003esetTimeStats(mTimeStats); mCompositionEngine-\u003esetHwComposer(getFactory().createHWComposer(mHwcServiceName)); mCompositionEngine-\u003egetHwComposer().setCallback(*this); ClientCache::getInstance().setRenderEngine(\u0026getRenderEngine()); enableLatchUnsignaledConfig = getLatchUnsignaledConfig(); if (base::GetBoolProperty(\"debug.sf.enable_hwc_vds\"s, false)) { enableHalVirtualDisplays(true); } // Process any initial hotplug and resulting display changes. processDisplayHotplugEventsLocked(); const auto display = getDefaultDisplayDeviceLocked(); LOG_ALWAYS_FATAL_IF(!display, \"Missing primary display after registering composer callback.\"); const auto displayId = display-\u003egetPhysicalId(); LOG_ALWAYS_FATAL_IF(!getHwComposer().isConnected(displayId), \"Primary display is disconnected.\"); // initialize our drawing state mDrawingState = mCurrentState; // set initial conditions (e.g. unblank default device) initializeDisplays(); mPowerAdvisor-\u003einit(); char primeShaderCache[PROPERTY_VALUE_MAX]; property_get(\"service.sf.prime_shader_cache\", primeShaderCache, \"1\"); if (atoi(primeShaderCache)) { if (setSchedFifo(false) != NO_ERROR) { ALOGW(\"Can't set SCHED_OTHER for primeCache\"); } mRenderEnginePrimeCacheFuture = getRenderEngine().primeCache(); if (setSchedFifo(true) != NO_ERROR) { ALOGW(\"Can't set SCHED_OTHER for primeCache\"); } } onActiveDisplaySizeChanged(display); // Inform native graphics APIs whether the present timestamp is supported: const bool presentFenceReliable = !getHwComposer().hasCapability(Capability::PRESENT_FENCE_IS_NOT_RELIABLE); mStartPropertySetThread = getFactory().createStartPropertySetThread(presentFenceReliable); if (mStartPropertySetThread-\u003eStart() != NO_ERROR) { ALOGE(\"Run StartPropertySetThread failed!\"); } ALOGV(\"Done initializing\"); } è°ƒç”¨processDisplayHotplugEventsLockedæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::processDisplayHotplugEventsLocked() { for (const auto\u0026 event : mPendingHotplugEvents) { ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlingerå¯åŠ¨æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-init"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"surfaceflinger processDisplayRemoved è°ƒç”¨processDisplayRemovedæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::processDisplayRemoved(const wp\u003cIBinder\u003e\u0026 displayToken) { auto display = getDisplayDeviceLocked(displayToken); if (display) { display-\u003edisconnect(); if (display-\u003eisVirtual()) { releaseVirtualDisplay(display-\u003egetVirtualId()); } else { dispatchDisplayHotplugEvent(display-\u003egetPhysicalId(), false); } } mDisplays.erase(displayToken); if (display \u0026\u0026 display-\u003eisVirtual()) { static_cast\u003cvoid\u003e(mScheduler-\u003eschedule([display = std::move(display)] { // Destroy the display without holding the mStateLock. // This is a temporary solution until we can manage transaction queues without // holding the mStateLock. // With blast, the IGBP that is passed to the VirtualDisplaySurface is owned by the // client. When the IGBP is disconnected, its buffer cache in SF will be cleared // via SurfaceComposerClient::doUncacheBufferTransaction. This call from the client // ends up running on the main thread causing a deadlock since setTransactionstate // will try to acquire the mStateLock. Instead we extend the lifetime of // DisplayDevice and destroy it in the main thread without holding the mStateLock. // The display will be disconnected and removed from the mDisplays list so it will // not be accessible. })); } } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:2:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlingerå¯åŠ¨æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-processdisplayremoved"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"surfaceflinger processDisplayChanged è°ƒç”¨processDisplayChangedæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::processDisplayChanged(const wp\u003cIBinder\u003e\u0026 displayToken, const DisplayDeviceState\u0026 currentState, const DisplayDeviceState\u0026 drawingState) { const sp\u003cIBinder\u003e currentBinder = IInterface::asBinder(currentState.surface); const sp\u003cIBinder\u003e drawingBinder = IInterface::asBinder(drawingState.surface); // Recreate the DisplayDevice if the surface or sequence ID changed. if (currentBinder != drawingBinder || currentState.sequenceId != drawingState.sequenceId) { getRenderEngine().cleanFramebufferCache(); if (const auto display = getDisplayDeviceLocked(displayToken)) { display-\u003edisconnect(); if (display-\u003eisVirtual()) { releaseVirtualDisplay(display-\u003egetVirtualId()); } } mDisplays.erase(displayToken); if (const auto\u0026 physical = currentState.physical) { getHwComposer().allocatePhysicalDisplay(physical-\u003ehwcDisplayId, physical-\u003eid); } processDisplayAdded(displayToken, currentState); if (currentState.physical) { const auto display = getDisplayDeviceLocked(displayToken); setPowerModeInternal(display, hal::PowerMode::ON); // TODO(b/175678251) Call a listener instead. if (currentState.physical-\u003ehwcDisplayId == getHwComposer().getPrimaryHwcDisplayId()) { updateInternalDisplayVsyncLocked(display); } } return; } if (const auto display = getDisplayDeviceLocked(displayToken)) { if (currentState.layerStack != drawingState.layerStack) { display-\u003esetLayerStack(currentState.layerStack); } if (currentState.flags != drawingState.flags) { display-\u003esetFlags(currentState.flags); } if ((currentState.orientation != drawingState.orientation) || (currentState.layerStackSpaceRect != drawingState.layerStackSpaceRect) || (currentState.orientedDisplaySpaceRect != drawingState.orientedDisplaySpaceRect)) { display-\u003esetProjection(currentState.orientation, currentState.layerStackSpaceRect, currentState.orientedDisplaySpaceRect); if (isDisplayActiveLocked(display)) { mActiveDisplayTransformHint = display-\u003egetTransformHint(); } } if (currentState.width != drawingState.width || currentState.height != drawingState.height) { display-\u003esetDisplaySize(currentState.width, currentState.height); if (isDisplayActiveLocked(display)) { onActiveDisplaySizeChanged(display); } } } } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:2:2","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlingerå¯åŠ¨æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-processdisplaychanged"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Surfaceflinger processDisplayAdded è°ƒç”¨processDisplayAddedæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::processDisplayAdded(const wp\u003cIBinder\u003e\u0026 displayToken, const DisplayDeviceState\u0026 state) { ui::Size resolution(0, 0); ui::PixelFormat pixelFormat = static_cast\u003cui::PixelFormat\u003e(PIXEL_FORMAT_UNKNOWN); if (state.physical) { resolution = state.physical-\u003eactiveMode-\u003egetResolution(); pixelFormat = static_cast\u003cui::PixelFormat\u003e(PIXEL_FORMAT_RGBA_8888); } else if (state.surface != nullptr) { int status = state.surface-\u003equery(NATIVE_WINDOW_WIDTH, \u0026resolution.width); ALOGE_IF(status != NO_ERROR, \"Unable to query width (%d)\", status); status = state.surface-\u003equery(NATIVE_WINDOW_HEIGHT, \u0026resolution.height); ALOGE_IF(status != NO_ERROR, \"Unable to query height (%d)\", status); int format; status = state.surface-\u003equery(NATIVE_WINDOW_FORMAT, \u0026format); ALOGE_IF(status != NO_ERROR, \"Unable to query format (%d)\", status); pixelFormat = static_cast\u003cui::PixelFormat\u003e(format); } else { // Virtual displays without a surface are dormant: // they have external state (layer stack, projection, // etc.) but no internal state (i.e. a DisplayDevice). return; } compositionengine::DisplayCreationArgsBuilder builder; if (const auto\u0026 physical = state.physical) { builder.setId(physical-\u003eid); } else { builder.setId(acquireVirtualDisplay(resolution, pixelFormat)); } builder.setPixels(resolution); builder.setIsSecure(state.isSecure); builder.setPowerAdvisor(mPowerAdvisor.get()); builder.setName(state.displayName); auto compositionDisplay = getCompositionEngine().createDisplay(builder.build()); compositionDisplay-\u003esetLayerCachingEnabled(mLayerCachingEnabled); sp\u003ccompositionengine::DisplaySurface\u003e displaySurface; sp\u003cIGraphicBufferProducer\u003e producer; sp\u003cIGraphicBufferProducer\u003e bqProducer; sp\u003cIGraphicBufferConsumer\u003e bqConsumer; getFactory().createBufferQueue(\u0026bqProducer, \u0026bqConsumer, /*consumerIsSurfaceFlinger =*/false); if (state.isVirtual()) { const auto displayId = VirtualDisplayId::tryCast(compositionDisplay-\u003egetId()); LOG_FATAL_IF(!displayId); auto surface = sp\u003cVirtualDisplaySurface\u003e::make(getHwComposer(), *displayId, state.surface, bqProducer, bqConsumer, state.displayName); displaySurface = surface; producer = std::move(surface); } else { ALOGE_IF(state.surface != nullptr, \"adding a supported display, but rendering \" \"surface is provided (%p), ignoring it\", state.surface.get()); const auto displayId = PhysicalDisplayId::tryCast(compositionDisplay-\u003egetId()); LOG_FATAL_IF(!displayId); displaySurface = sp\u003cFramebufferSurface\u003e::make(getHwComposer(), *displayId, bqConsumer, state.physical-\u003eactiveMode-\u003egetResolution(), ui::Size(maxGraphicsWidth, maxGraphicsHeight)); producer = bqProducer; } LOG_FATAL_IF(!displaySurface); auto display = setupNewDisplayDeviceInternal(displayToken, std::move(compositionDisplay), state, displaySurface, producer); if (display-\u003eisPrimary()) { initScheduler(display); } if (!state.isVirtual()) { dispatchDisplayHotplugEvent(display-\u003egetPhysicalId(), true); } mDisplays.try_emplace(displayToken, std::move(display)); } SurfaceFlinger initScheduler è°ƒç”¨initScheduleræ–¹æ³•ï¼Œåˆå§‹åŒ–Schedulerï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp std::unique_ptr\u003cscheduler::Scheduler\u003e mScheduler; void SurfaceFlinger::initScheduler(const sp\u003cDisplayDevice\u003e\u0026 display) { if (mScheduler) { // If the scheduler is already initialized, this means that we received // a hotplug(connected) on the primary display. In that case we should // update the scheduler with the most recent display information. ALOGW(\"Scheduler already initialized, updating instead\"); mScheduler-\u003esetRefreshRateConfigs(display-\u003eholdRefreshRateConfigs()); return; } const auto currRefreshRate = display-\u003egetActiveMode()-\u003egetFps(); mRefreshRateStats = std::make_unique\u003cscheduler::RefreshRateStats\u003e(*mTimeStats, currRefreshRate, hal::PowerMode::OFF); mVsyncConfiguration = getFactory().createVsyncConfiguration(currRefreshRate); mVsyncModulator = sp\u003cVsyncModulator\u003e","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:2:3","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlingerå¯åŠ¨æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-processdisplayadded"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Surfaceflinger processDisplayAdded è°ƒç”¨processDisplayAddedæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::processDisplayAdded(const wp\u0026 displayToken, const DisplayDeviceState\u0026 state) { ui::Size resolution(0, 0); ui::PixelFormat pixelFormat = static_cast(PIXEL_FORMAT_UNKNOWN); if (state.physical) { resolution = state.physical-\u003eactiveMode-\u003egetResolution(); pixelFormat = static_cast(PIXEL_FORMAT_RGBA_8888); } else if (state.surface != nullptr) { int status = state.surface-\u003equery(NATIVE_WINDOW_WIDTH, \u0026resolution.width); ALOGE_IF(status != NO_ERROR, \"Unable to query width (%d)\", status); status = state.surface-\u003equery(NATIVE_WINDOW_HEIGHT, \u0026resolution.height); ALOGE_IF(status != NO_ERROR, \"Unable to query height (%d)\", status); int format; status = state.surface-\u003equery(NATIVE_WINDOW_FORMAT, \u0026format); ALOGE_IF(status != NO_ERROR, \"Unable to query format (%d)\", status); pixelFormat = static_cast(format); } else { // Virtual displays without a surface are dormant: // they have external state (layer stack, projection, // etc.) but no internal state (i.e. a DisplayDevice). return; } compositionengine::DisplayCreationArgsBuilder builder; if (const auto\u0026 physical = state.physical) { builder.setId(physical-\u003eid); } else { builder.setId(acquireVirtualDisplay(resolution, pixelFormat)); } builder.setPixels(resolution); builder.setIsSecure(state.isSecure); builder.setPowerAdvisor(mPowerAdvisor.get()); builder.setName(state.displayName); auto compositionDisplay = getCompositionEngine().createDisplay(builder.build()); compositionDisplay-\u003esetLayerCachingEnabled(mLayerCachingEnabled); sp displaySurface; sp producer; sp bqProducer; sp bqConsumer; getFactory().createBufferQueue(\u0026bqProducer, \u0026bqConsumer, /*consumerIsSurfaceFlinger =*/false); if (state.isVirtual()) { const auto displayId = VirtualDisplayId::tryCast(compositionDisplay-\u003egetId()); LOG_FATAL_IF(!displayId); auto surface = sp::make(getHwComposer(), *displayId, state.surface, bqProducer, bqConsumer, state.displayName); displaySurface = surface; producer = std::move(surface); } else { ALOGE_IF(state.surface != nullptr, \"adding a supported display, but rendering \" \"surface is provided (%p), ignoring it\", state.surface.get()); const auto displayId = PhysicalDisplayId::tryCast(compositionDisplay-\u003egetId()); LOG_FATAL_IF(!displayId); displaySurface = sp::make(getHwComposer(), *displayId, bqConsumer, state.physical-\u003eactiveMode-\u003egetResolution(), ui::Size(maxGraphicsWidth, maxGraphicsHeight)); producer = bqProducer; } LOG_FATAL_IF(!displaySurface); auto display = setupNewDisplayDeviceInternal(displayToken, std::move(compositionDisplay), state, displaySurface, producer); if (display-\u003eisPrimary()) { initScheduler(display); } if (!state.isVirtual()) { dispatchDisplayHotplugEvent(display-\u003egetPhysicalId(), true); } mDisplays.try_emplace(displayToken, std::move(display)); } SurfaceFlinger initScheduler è°ƒç”¨initScheduleræ–¹æ³•ï¼Œåˆå§‹åŒ–Schedulerï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp std::unique_ptr mScheduler; void SurfaceFlinger::initScheduler(const sp\u0026 display) { if (mScheduler) { // If the scheduler is already initialized, this means that we received // a hotplug(connected) on the primary display. In that case we should // update the scheduler with the most recent display information. ALOGW(\"Scheduler already initialized, updating instead\"); mScheduler-\u003esetRefreshRateConfigs(display-\u003eholdRefreshRateConfigs()); return; } const auto currRefreshRate = display-\u003egetActiveMode()-\u003egetFps(); mRefreshRateStats = std::make_unique(*mTimeStats, currRefreshRate, hal::PowerMode::OFF); mVsyncConfiguration = getFactory().createVsyncConfiguration(currRefreshRate); mVsyncModulator = sp","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:2:3","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlingerå¯åŠ¨æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-initscheduler"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Surfaceflinger processDisplayAdded è°ƒç”¨processDisplayAddedæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::processDisplayAdded(const wp\u0026 displayToken, const DisplayDeviceState\u0026 state) { ui::Size resolution(0, 0); ui::PixelFormat pixelFormat = static_cast(PIXEL_FORMAT_UNKNOWN); if (state.physical) { resolution = state.physical-\u003eactiveMode-\u003egetResolution(); pixelFormat = static_cast(PIXEL_FORMAT_RGBA_8888); } else if (state.surface != nullptr) { int status = state.surface-\u003equery(NATIVE_WINDOW_WIDTH, \u0026resolution.width); ALOGE_IF(status != NO_ERROR, \"Unable to query width (%d)\", status); status = state.surface-\u003equery(NATIVE_WINDOW_HEIGHT, \u0026resolution.height); ALOGE_IF(status != NO_ERROR, \"Unable to query height (%d)\", status); int format; status = state.surface-\u003equery(NATIVE_WINDOW_FORMAT, \u0026format); ALOGE_IF(status != NO_ERROR, \"Unable to query format (%d)\", status); pixelFormat = static_cast(format); } else { // Virtual displays without a surface are dormant: // they have external state (layer stack, projection, // etc.) but no internal state (i.e. a DisplayDevice). return; } compositionengine::DisplayCreationArgsBuilder builder; if (const auto\u0026 physical = state.physical) { builder.setId(physical-\u003eid); } else { builder.setId(acquireVirtualDisplay(resolution, pixelFormat)); } builder.setPixels(resolution); builder.setIsSecure(state.isSecure); builder.setPowerAdvisor(mPowerAdvisor.get()); builder.setName(state.displayName); auto compositionDisplay = getCompositionEngine().createDisplay(builder.build()); compositionDisplay-\u003esetLayerCachingEnabled(mLayerCachingEnabled); sp displaySurface; sp producer; sp bqProducer; sp bqConsumer; getFactory().createBufferQueue(\u0026bqProducer, \u0026bqConsumer, /*consumerIsSurfaceFlinger =*/false); if (state.isVirtual()) { const auto displayId = VirtualDisplayId::tryCast(compositionDisplay-\u003egetId()); LOG_FATAL_IF(!displayId); auto surface = sp::make(getHwComposer(), *displayId, state.surface, bqProducer, bqConsumer, state.displayName); displaySurface = surface; producer = std::move(surface); } else { ALOGE_IF(state.surface != nullptr, \"adding a supported display, but rendering \" \"surface is provided (%p), ignoring it\", state.surface.get()); const auto displayId = PhysicalDisplayId::tryCast(compositionDisplay-\u003egetId()); LOG_FATAL_IF(!displayId); displaySurface = sp::make(getHwComposer(), *displayId, bqConsumer, state.physical-\u003eactiveMode-\u003egetResolution(), ui::Size(maxGraphicsWidth, maxGraphicsHeight)); producer = bqProducer; } LOG_FATAL_IF(!displaySurface); auto display = setupNewDisplayDeviceInternal(displayToken, std::move(compositionDisplay), state, displaySurface, producer); if (display-\u003eisPrimary()) { initScheduler(display); } if (!state.isVirtual()) { dispatchDisplayHotplugEvent(display-\u003egetPhysicalId(), true); } mDisplays.try_emplace(displayToken, std::move(display)); } SurfaceFlinger initScheduler è°ƒç”¨initScheduleræ–¹æ³•ï¼Œåˆå§‹åŒ–Schedulerï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp std::unique_ptr mScheduler; void SurfaceFlinger::initScheduler(const sp\u0026 display) { if (mScheduler) { // If the scheduler is already initialized, this means that we received // a hotplug(connected) on the primary display. In that case we should // update the scheduler with the most recent display information. ALOGW(\"Scheduler already initialized, updating instead\"); mScheduler-\u003esetRefreshRateConfigs(display-\u003eholdRefreshRateConfigs()); return; } const auto currRefreshRate = display-\u003egetActiveMode()-\u003egetFps(); mRefreshRateStats = std::make_unique(*mTimeStats, currRefreshRate, hal::PowerMode::OFF); mVsyncConfiguration = getFactory().createVsyncConfiguration(currRefreshRate); mVsyncModulator = sp","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:2:3","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlingerå¯åŠ¨æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#new-scheduler"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Surfaceflinger processDisplayAdded è°ƒç”¨processDisplayAddedæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::processDisplayAdded(const wp\u0026 displayToken, const DisplayDeviceState\u0026 state) { ui::Size resolution(0, 0); ui::PixelFormat pixelFormat = static_cast(PIXEL_FORMAT_UNKNOWN); if (state.physical) { resolution = state.physical-\u003eactiveMode-\u003egetResolution(); pixelFormat = static_cast(PIXEL_FORMAT_RGBA_8888); } else if (state.surface != nullptr) { int status = state.surface-\u003equery(NATIVE_WINDOW_WIDTH, \u0026resolution.width); ALOGE_IF(status != NO_ERROR, \"Unable to query width (%d)\", status); status = state.surface-\u003equery(NATIVE_WINDOW_HEIGHT, \u0026resolution.height); ALOGE_IF(status != NO_ERROR, \"Unable to query height (%d)\", status); int format; status = state.surface-\u003equery(NATIVE_WINDOW_FORMAT, \u0026format); ALOGE_IF(status != NO_ERROR, \"Unable to query format (%d)\", status); pixelFormat = static_cast(format); } else { // Virtual displays without a surface are dormant: // they have external state (layer stack, projection, // etc.) but no internal state (i.e. a DisplayDevice). return; } compositionengine::DisplayCreationArgsBuilder builder; if (const auto\u0026 physical = state.physical) { builder.setId(physical-\u003eid); } else { builder.setId(acquireVirtualDisplay(resolution, pixelFormat)); } builder.setPixels(resolution); builder.setIsSecure(state.isSecure); builder.setPowerAdvisor(mPowerAdvisor.get()); builder.setName(state.displayName); auto compositionDisplay = getCompositionEngine().createDisplay(builder.build()); compositionDisplay-\u003esetLayerCachingEnabled(mLayerCachingEnabled); sp displaySurface; sp producer; sp bqProducer; sp bqConsumer; getFactory().createBufferQueue(\u0026bqProducer, \u0026bqConsumer, /*consumerIsSurfaceFlinger =*/false); if (state.isVirtual()) { const auto displayId = VirtualDisplayId::tryCast(compositionDisplay-\u003egetId()); LOG_FATAL_IF(!displayId); auto surface = sp::make(getHwComposer(), *displayId, state.surface, bqProducer, bqConsumer, state.displayName); displaySurface = surface; producer = std::move(surface); } else { ALOGE_IF(state.surface != nullptr, \"adding a supported display, but rendering \" \"surface is provided (%p), ignoring it\", state.surface.get()); const auto displayId = PhysicalDisplayId::tryCast(compositionDisplay-\u003egetId()); LOG_FATAL_IF(!displayId); displaySurface = sp::make(getHwComposer(), *displayId, bqConsumer, state.physical-\u003eactiveMode-\u003egetResolution(), ui::Size(maxGraphicsWidth, maxGraphicsHeight)); producer = bqProducer; } LOG_FATAL_IF(!displaySurface); auto display = setupNewDisplayDeviceInternal(displayToken, std::move(compositionDisplay), state, displaySurface, producer); if (display-\u003eisPrimary()) { initScheduler(display); } if (!state.isVirtual()) { dispatchDisplayHotplugEvent(display-\u003egetPhysicalId(), true); } mDisplays.try_emplace(displayToken, std::move(display)); } SurfaceFlinger initScheduler è°ƒç”¨initScheduleræ–¹æ³•ï¼Œåˆå§‹åŒ–Schedulerï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp std::unique_ptr mScheduler; void SurfaceFlinger::initScheduler(const sp\u0026 display) { if (mScheduler) { // If the scheduler is already initialized, this means that we received // a hotplug(connected) on the primary display. In that case we should // update the scheduler with the most recent display information. ALOGW(\"Scheduler already initialized, updating instead\"); mScheduler-\u003esetRefreshRateConfigs(display-\u003eholdRefreshRateConfigs()); return; } const auto currRefreshRate = display-\u003egetActiveMode()-\u003egetFps(); mRefreshRateStats = std::make_unique(*mTimeStats, currRefreshRate, hal::PowerMode::OFF); mVsyncConfiguration = getFactory().createVsyncConfiguration(currRefreshRate); mVsyncModulator = sp","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:2:3","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlingerå¯åŠ¨æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#scheduler-createconnection"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Surfaceflinger processDisplayAdded è°ƒç”¨processDisplayAddedæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::processDisplayAdded(const wp\u0026 displayToken, const DisplayDeviceState\u0026 state) { ui::Size resolution(0, 0); ui::PixelFormat pixelFormat = static_cast(PIXEL_FORMAT_UNKNOWN); if (state.physical) { resolution = state.physical-\u003eactiveMode-\u003egetResolution(); pixelFormat = static_cast(PIXEL_FORMAT_RGBA_8888); } else if (state.surface != nullptr) { int status = state.surface-\u003equery(NATIVE_WINDOW_WIDTH, \u0026resolution.width); ALOGE_IF(status != NO_ERROR, \"Unable to query width (%d)\", status); status = state.surface-\u003equery(NATIVE_WINDOW_HEIGHT, \u0026resolution.height); ALOGE_IF(status != NO_ERROR, \"Unable to query height (%d)\", status); int format; status = state.surface-\u003equery(NATIVE_WINDOW_FORMAT, \u0026format); ALOGE_IF(status != NO_ERROR, \"Unable to query format (%d)\", status); pixelFormat = static_cast(format); } else { // Virtual displays without a surface are dormant: // they have external state (layer stack, projection, // etc.) but no internal state (i.e. a DisplayDevice). return; } compositionengine::DisplayCreationArgsBuilder builder; if (const auto\u0026 physical = state.physical) { builder.setId(physical-\u003eid); } else { builder.setId(acquireVirtualDisplay(resolution, pixelFormat)); } builder.setPixels(resolution); builder.setIsSecure(state.isSecure); builder.setPowerAdvisor(mPowerAdvisor.get()); builder.setName(state.displayName); auto compositionDisplay = getCompositionEngine().createDisplay(builder.build()); compositionDisplay-\u003esetLayerCachingEnabled(mLayerCachingEnabled); sp displaySurface; sp producer; sp bqProducer; sp bqConsumer; getFactory().createBufferQueue(\u0026bqProducer, \u0026bqConsumer, /*consumerIsSurfaceFlinger =*/false); if (state.isVirtual()) { const auto displayId = VirtualDisplayId::tryCast(compositionDisplay-\u003egetId()); LOG_FATAL_IF(!displayId); auto surface = sp::make(getHwComposer(), *displayId, state.surface, bqProducer, bqConsumer, state.displayName); displaySurface = surface; producer = std::move(surface); } else { ALOGE_IF(state.surface != nullptr, \"adding a supported display, but rendering \" \"surface is provided (%p), ignoring it\", state.surface.get()); const auto displayId = PhysicalDisplayId::tryCast(compositionDisplay-\u003egetId()); LOG_FATAL_IF(!displayId); displaySurface = sp::make(getHwComposer(), *displayId, bqConsumer, state.physical-\u003eactiveMode-\u003egetResolution(), ui::Size(maxGraphicsWidth, maxGraphicsHeight)); producer = bqProducer; } LOG_FATAL_IF(!displaySurface); auto display = setupNewDisplayDeviceInternal(displayToken, std::move(compositionDisplay), state, displaySurface, producer); if (display-\u003eisPrimary()) { initScheduler(display); } if (!state.isVirtual()) { dispatchDisplayHotplugEvent(display-\u003egetPhysicalId(), true); } mDisplays.try_emplace(displayToken, std::move(display)); } SurfaceFlinger initScheduler è°ƒç”¨initScheduleræ–¹æ³•ï¼Œåˆå§‹åŒ–Schedulerï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp std::unique_ptr mScheduler; void SurfaceFlinger::initScheduler(const sp\u0026 display) { if (mScheduler) { // If the scheduler is already initialized, this means that we received // a hotplug(connected) on the primary display. In that case we should // update the scheduler with the most recent display information. ALOGW(\"Scheduler already initialized, updating instead\"); mScheduler-\u003esetRefreshRateConfigs(display-\u003eholdRefreshRateConfigs()); return; } const auto currRefreshRate = display-\u003egetActiveMode()-\u003egetFps(); mRefreshRateStats = std::make_unique(*mTimeStats, currRefreshRate, hal::PowerMode::OFF); mVsyncConfiguration = getFactory().createVsyncConfiguration(currRefreshRate); mVsyncModulator = sp","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:2:3","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlingerå¯åŠ¨æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#scheduler-initvsync"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"surfaceflinger run è°ƒç”¨flingerçš„run()æ–¹æ³•ï¼Œè¿è¡Œsurfaceflingerè¿™ä¸ªçº¿ç¨‹ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp std::unique_ptr\u003cscheduler::Scheduler\u003e mScheduler; void SurfaceFlinger::run() { mScheduler-\u003erun(); } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlingerå¯åŠ¨æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-run"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Scheduler run è°ƒç”¨Schedulerçš„runæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void Scheduler::run() { while (true) { waitMessage(); //ç­‰å¾…æ¶ˆæ¯ } } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlingerå¯åŠ¨æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#scheduler-run"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"SurfaceSessionæ˜¯Androidç³»ç»Ÿä¸­ä¸å›¾å½¢è¡¨é¢ç›¸å…³çš„ä¸€ä¸ªå…³é”®ç±»ï¼Œå®ƒæä¾›äº†ä¸SurfaceFlingeræœåŠ¡é€šä¿¡ä»¥åˆ›å»ºå’Œç®¡ç†å›¾å½¢è¡¨é¢è¿æ¥çš„APIï¼ŒSurfaceSessionåœ¨WindowManagerServiceçš„addWindowæ—¶åˆ›å»ºï¼Œæ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š //frameworks/base/core/java/android/view/SurfaceSession.java public final class SurfaceSession { public SurfaceSession() { mNativeClient = nativeCreate(); } } è°ƒç”¨nativeCreateæ–¹æ³•ï¼ŒnativeCreateæ˜¯ä¸ªNativeæ–¹æ³•ï¼Œé€šè¿‡æŸ¥è¡¨è°ƒç”¨android_view_SurfaceSession.cppçš„nativeCreateæ–¹æ³•ï¼š //frameworks/base/core/jni/android_view_SurfaceSession.cpp static jlong nativeCreate(JNIEnv* env, jclass clazz) { SurfaceComposerClient* client = new SurfaceComposerClient(); //åˆ›å»ºSurfaceComposerClientå¯¹è±¡ client-\u003eincStrong((void*)nativeCreate); return reinterpret_cast\u003cjlong\u003e(client); } é€šè¿‡newçš„æ–¹å¼åˆ›å»ºSurfaceComposerClientå¯¹è±¡ï¼ŒSurfaceComposerClientçš„æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š //frameworks/native/libs/gui/SurfaceComposerClient.cpp class SurfaceComposerClient : public RefBase SurfaceComposerClient::SurfaceComposerClient() : mStatus(NO_INIT) {} } ","date":"2024-11-06","objectID":"/posts/android13-surfacesession%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceSessionåˆ›å»ºæµç¨‹åˆ†æ_android surfacesession-CSDNåšå®¢","uri":"/posts/android13-surfacesession%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"Surfaceæ˜¯Androidä¸­ç”¨äºè¡¨ç¤ºä¸€ä¸ªå›¾åƒç¼“å†²åŒºçš„ç±»ï¼ŒSurfaceæ˜¯åœ¨SurfaceControlåˆ›å»ºæ—¶åˆ›å»ºçš„ï¼Œä»£ç å¦‚ä¸‹ï¼š //frameworks/native/services/surfaceflinger/Client.cpp class Client : public BnSurfaceComposerClient status_t Client::createSurface(const String8\u0026 name, uint32_t w, uint32_t h, PixelFormat format, uint32_t flags, const sp\u003cIBinder\u003e\u0026 parentHandle, LayerMetadata metadata, sp\u003cIBinder\u003e* handle, sp\u003cIGraphicBufferProducer\u003e* gbp) { // We rely on createLayer to check permissions. return mFlinger-\u003ecreateLayer(name, this, w, h, format, flags, std::move(metadata), handle, gbp, parentHandle); } } ","date":"2024-11-06","objectID":"/posts/android13-surface%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","blog","Framework","è½¬è½½"],"title":"Android13 Surfaceåˆ›å»ºæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surface%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"SurfaceFlinger createLayer mFlingeræ˜¯SurfaceFlingerï¼Œæ‰€ä»¥Clientçš„å…·ä½“å®ç°è¿˜æ˜¯ä¾é çš„SurfaceFlingerï¼Œå¹¶ä¸”æ³¨æ„ï¼Œåœ¨åº”ç”¨å±‚çš„Surfaceåœ¨SurfaceFlingerè¿›ç¨‹åå«Layerï¼Œå®ƒå’Œåº”ç”¨å±‚çš„Surfaceæ˜¯ä¸€ ä¸€å¯¹åº”çš„å…³ç³»ï¼Œæˆ‘ä»¬æ¥çœ‹createLayerå‡½æ•°ï¼š //frameworks/native/service/SurfaceFlinger/SurfaeFlinger.cpp class SurfaceFlinger : public BnSurfaceComposer, public PriorityDumper, private IBinder::DeathRecipient, private HWC2::ComposerCallback, private ICompositor, private scheduler::ISchedulerCallback { status_t SurfaceFlinger::createLayer(const String8\u0026 name, const sp\u003cClient\u003e\u0026 client, uint32_t w, uint32_t h, PixelFormat format, uint32_t flags, LayerMetadata metadata, sp\u003cIBinder\u003e* handle, sp\u003cIGraphicBufferProducer\u003e* gbp, const sp\u003cIBinder\u003e\u0026 parentHandle, const sp\u003cLayer\u003e\u0026 parentLayer) { //å®½é«˜åˆæ³•æ£€æŸ¥ if (int32_t(w|h) \u003c 0) { ALOGE(\"createLayer() failed, w or h is negative (w=%d, h=%d)\", int(w), int(h)); return BAD_VALUE; } status_t result = NO_ERROR; //layer sp\u003cLayer\u003e layer; ...... //æ ¹æ®ä¸åŒflagåˆ›å»ºä¸åŒlayer switch (flags \u0026 ISurfaceComposerClient::eFXSurfaceMask) { case ISurfaceComposerClient::eFXSurfaceBufferQueue: result = createBufferQueueLayer(client, uniqueName, w, h, flags, std::move(metadata), format, handle, gbp, \u0026layer); break; case ISurfaceComposerClient::eFXSurfaceBufferState: result = createBufferStateLayer(client, uniqueName, w, h, flags, std::move(metadata), handle, \u0026layer); break; case ISurfaceComposerClient::eFXSurfaceColor: // check if buffer size is set for color layer. if (w \u003e 0 || h \u003e 0) { ALOGE(\"createLayer() failed, w or h cannot be set for color layer (w=%d, h=%d)\", int(w), int(h)); return BAD_VALUE; } result = createColorLayer(client, uniqueName, w, h, flags, std::move(metadata), handle, \u0026layer); break; case ISurfaceComposerClient::eFXSurfaceContainer: // check if buffer size is set for container layer. if (w \u003e 0 || h \u003e 0) { ALOGE(\"createLayer() failed, w or h cannot be set for container layer (w=%d, h=%d)\", int(w), int(h)); return BAD_VALUE; } result = createContainerLayer(client, uniqueName, w, h, flags, std::move(metadata), handle, \u0026layer); break; default: result = BAD_VALUE; break; } ....... return result; } } ","date":"2024-11-06","objectID":"/posts/android13-surface%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","blog","Framework","è½¬è½½"],"title":"Android13 Surfaceåˆ›å»ºæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surface%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-createlayer"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"SurfaceFlinger createBufferQueueLayer ä¸Šé¢å‡½æ•°çš„æ ¸å¿ƒä»£ç å°±æ˜¯æ ¹æ®åº”ç”¨è¯·æ±‚ä¸åŒçš„flagåˆ›å»ºä¸åŒçš„æ˜¾ç¤ºLayerï¼Œä»ä¸Šé¢ä»£ç çœ‹åˆ›å»ºçš„Layeræœ‰å››ç§ç±»å‹ï¼Œæˆ‘ä»¬çœ‹çœ‹ç³»ç»Ÿä¸­å¤§å¤šæ•°ç•Œé¢çš„Layer ï¼Œflage ä¸ºeFXSurfaceBufferQueueyerï¼Œæˆ‘ä»¬å°±å¤§è‡´çœ‹çœ‹createBufferQueueLayerå‡½æ•°ã€‚ //frameworks/native/service/surfaceflinger/SurfaeFlinger.cpp status_t SurfaceFlinger::createBufferQueueLayer(const sp\u003cClient\u003e\u0026 client, const String8\u0026 name, uint32_t w, uint32_t h, uint32_t flags, LayerMetadata metadata, PixelFormat\u0026 format, sp\u003cIBinder\u003e* handle, sp\u003cIGraphicBufferProducer\u003e* gbp, sp\u003cLayer\u003e* outLayer) { // initialize the surfaces switch (format) { case PIXEL_FORMAT_TRANSPARENT: case PIXEL_FORMAT_TRANSLUCENT: format = PIXEL_FORMAT_RGBA_8888; break; case PIXEL_FORMAT_OPAQUE: format = PIXEL_FORMAT_RGBX_8888; break; } sp\u003cBufferQueueLayer\u003e layer = getFactory().createBufferQueueLayer( LayerCreationArgs(this, client, name, w, h, flags, std::move(metadata))); status_t err = layer-\u003esetDefaultBufferProperties(w, h, format); if (err == NO_ERROR) { *handle = layer-\u003egetHandle(); *gbp = layer-\u003egetProducer(); *outLayer = layer; } return err; } å¯ä»¥çœ‹åˆ°ä¸Šé¢å‡½æ•°çš„æ ¸å¿ƒæ˜¯è°ƒç”¨getFactory().createBufferQueueLayerï¼Œæœ€ç»ˆåˆ›å»ºçš„æ˜¯Layerçš„å­ç±»BufferQueueLayerï¼š //frameworks/native/service/surfaceflinger/SurfaeFlinger.cpp sp\u003cBufferQueueLayer\u003e createBufferQueueLayer(const LayerCreationArgs\u0026 args) override { return new BufferQueueLayer(args); } SurfaceFlingerFactoryçš„createBufferQueueLayerå‡½æ•°åªæ˜¯newäº†ä¸€ä¸ªBufferQueueLayerï¼Œç»§ç»­çœ‹BufferQueueLayer[æ„é€ å‡½æ•°]ï¼š //frameworks/native/services/surfaceflinger/BufferQueueLayer.cpp BufferQueueLayer::BufferQueueLayer(const LayerCreationArgs\u0026 args) : BufferLayer(args) {} [[Android13 BufferQueueLayer onFirstRefæµç¨‹åˆ†æ-CSDNåšå®¢]] å®ƒçš„æ„é€ å‡½æ•°ä¸­å…¶å®æ²¡åšä»€ä¹ˆäº‹æƒ…ï¼Œä½†æ˜¯åˆ«å¿˜äº†è¿™ä¸ªç±»ç»ˆæçˆ¶ç±»æ˜¯RefBaseï¼ŒBufferQueueLayerè¢«newå‡ºæ¥çš„æ—¶å€™ä¼šèµ°è¿›å®ƒçš„onFirstRef()æ–¹æ³•é‡Œé¢ï¼š ","date":"2024-11-06","objectID":"/posts/android13-surface%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","blog","Framework","è½¬è½½"],"title":"Android13 Surfaceåˆ›å»ºæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surface%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-createbufferqueuelayer"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"SurfaceFlinger createBufferQueueLayer ä¸Šé¢å‡½æ•°çš„æ ¸å¿ƒä»£ç å°±æ˜¯æ ¹æ®åº”ç”¨è¯·æ±‚ä¸åŒçš„flagåˆ›å»ºä¸åŒçš„æ˜¾ç¤ºLayerï¼Œä»ä¸Šé¢ä»£ç çœ‹åˆ›å»ºçš„Layeræœ‰å››ç§ç±»å‹ï¼Œæˆ‘ä»¬çœ‹çœ‹ç³»ç»Ÿä¸­å¤§å¤šæ•°ç•Œé¢çš„Layer ï¼Œflage ä¸ºeFXSurfaceBufferQueueyerï¼Œæˆ‘ä»¬å°±å¤§è‡´çœ‹çœ‹createBufferQueueLayerå‡½æ•°ã€‚ //frameworks/native/service/surfaceflinger/SurfaeFlinger.cpp status_t SurfaceFlinger::createBufferQueueLayer(const sp\u0026 client, const String8\u0026 name, uint32_t w, uint32_t h, uint32_t flags, LayerMetadata metadata, PixelFormat\u0026 format, sp* handle, sp* gbp, sp* outLayer) { // initialize the surfaces switch (format) { case PIXEL_FORMAT_TRANSPARENT: case PIXEL_FORMAT_TRANSLUCENT: format = PIXEL_FORMAT_RGBA_8888; break; case PIXEL_FORMAT_OPAQUE: format = PIXEL_FORMAT_RGBX_8888; break; } sp layer = getFactory().createBufferQueueLayer( LayerCreationArgs(this, client, name, w, h, flags, std::move(metadata))); status_t err = layer-\u003esetDefaultBufferProperties(w, h, format); if (err == NO_ERROR) { *handle = layer-\u003egetHandle(); *gbp = layer-\u003egetProducer(); *outLayer = layer; } return err; } å¯ä»¥çœ‹åˆ°ä¸Šé¢å‡½æ•°çš„æ ¸å¿ƒæ˜¯è°ƒç”¨getFactory().createBufferQueueLayerï¼Œæœ€ç»ˆåˆ›å»ºçš„æ˜¯Layerçš„å­ç±»BufferQueueLayerï¼š //frameworks/native/service/surfaceflinger/SurfaeFlinger.cpp sp createBufferQueueLayer(const LayerCreationArgs\u0026 args) override { return new BufferQueueLayer(args); } SurfaceFlingerFactoryçš„createBufferQueueLayerå‡½æ•°åªæ˜¯newäº†ä¸€ä¸ªBufferQueueLayerï¼Œç»§ç»­çœ‹BufferQueueLayer[æ„é€ å‡½æ•°]ï¼š //frameworks/native/services/surfaceflinger/BufferQueueLayer.cpp BufferQueueLayer::BufferQueueLayer(const LayerCreationArgs\u0026 args) : BufferLayer(args) {} [[Android13 BufferQueueLayer onFirstRefæµç¨‹åˆ†æ-CSDNåšå®¢]] å®ƒçš„æ„é€ å‡½æ•°ä¸­å…¶å®æ²¡åšä»€ä¹ˆäº‹æƒ…ï¼Œä½†æ˜¯åˆ«å¿˜äº†è¿™ä¸ªç±»ç»ˆæçˆ¶ç±»æ˜¯RefBaseï¼ŒBufferQueueLayerè¢«newå‡ºæ¥çš„æ—¶å€™ä¼šèµ°è¿›å®ƒçš„onFirstRef()æ–¹æ³•é‡Œé¢ï¼š ","date":"2024-11-06","objectID":"/posts/android13-surface%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","blog","Framework","è½¬è½½"],"title":"Android13 Surfaceåˆ›å»ºæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surface%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#android13-bufferqueuelayer-onfirstrefæµç¨‹åˆ†æ-csdnåšå®¢"},{"categories":null,"collections":"Native","content":"â€œJNIå¼€å‘ä¸­è¯·é—®å¦‚æœæƒ³è¦ä¸€ä¸ªçº¯nativeçº¿ç¨‹ä¸­æ‰§è¡Œçš„nativeæ–¹æ³•éœ€è¦è°ƒç”¨åˆ°Javaå±‚åº”è¯¥è¦æ€ä¹ˆåšï¼Ÿâ€ å¤§å®¶æ³¨æ„è¿™ä¸ªé—®é¢˜å“ˆï¼Œæ˜¯çº¯nativeçº¿ç¨‹å’Œæ–¹æ³•ï¼Œå³æ²¡æœ‰æˆ‘ä»¬æ­£å¸¸jniè°ƒç”¨çš„envç¯å¢ƒçš„ï¼Œæ­£å¸¸çš„å¦‚æœjniæ–¹æ³•æ˜¯ç”±javaå±‚è°ƒç”¨åˆ°jniä¸€èˆ¬éƒ½æ˜¯è‡ªå¸¦äº†JNIEnvå˜é‡å¦‚ä¸‹ï¼š æ‹¿getMemInfoä¸¾ä¾‹å­ï¼Œå¦‚ï¼š javaå±‚ï¼š public static native void getMemInfo(long[] outSizes); è½¬å˜æˆäº†nativeå±‚é¢ä»£ç å°±æ˜¯å¦‚ä¸‹ï¼š static void android_os_Debug_getMemInfo(JNIEnv *env, jobject clazz, jlongArray out) å¤§å®¶çœ‹è¿™é‡Œæ˜¯ä¸æ˜¯è‡ªå¸¦äº†ä¸€ä¸ªå˜é‡JNIEnv *envï¼Œæœ‰äº†è¿™é‡Œenvåå†æƒ³è°ƒç”¨Javaå±‚é¢çš„æ–¹æ³•å°±å¾ˆç®€å•ï¼Œå…·ä½“çœ‹å‚è€ƒå¦‚ä¸‹ï¼š æ¯”å¦‚ç»å¸¸Javaè°ƒç”¨jniæ—¶å€™ã€‚ tatic void android_os_Debug_getMemInfo(JNIEnv *env, jobject clazz, jlongArray out) { char buffer[1024]; size_t numFound = 0; if (out == NULL) { jniThrowNullPointerException(env, \"out == null\");//æŠ›å‡ºç©ºæŒ‡é’ˆåˆ°java return; } //çœç•¥ã€‚ã€‚ã€‚ã€‚ } jniThrowNullPointerExceptionæ–¹æ³•å°±éœ€è¦ä¼ é€’envï¼ŒjniThrowNullPointerExceptionæœ€åè°ƒç”¨åˆ°äº†jniThrowExceptionï¼šå¦‚ä¸‹ // libnativehelper/JNIHelp.cpp extern \"C\" int jniThrowException(C_JNIEnv* env, const char* className, const char* msg) { JNIEnv* e = reinterpret_cast\u003cJNIEnv*\u003e(env); if ((*env)-\u003eExceptionCheck(e)) { /* TODO: consider creating the new exception with this as \"cause\" */ scoped_local_ref\u003cjthrowable\u003e exception(env, (*env)-\u003eExceptionOccurred(e)); (*env)-\u003eExceptionClear(e); if (exception.get() != NULL) { std::string text; getExceptionSummary(env, exception.get(), text); ALOGW(\"Discarding pending exception (%s) to throw %s\", text.c_str(), className); } } scoped_local_ref\u003cjclass\u003e exceptionClass(env, findClass(env, className)); if (exceptionClass.get() == NULL) { ALOGE(\"Unable to find exception class %s\", className); /* ClassNotFoundException now pending */ return -1; } if ((*env)-\u003eThrowNew(e, exceptionClass.get(), msg) != JNI_OK) { ALOGE(\"Failed throwing '%s' '%s'\", className, msg); /* an exception, most likely OOM, will now be pending */ return -1; } return 0; } è¿™é‡Œå°±éœ€è¦ä½¿ç”¨envæ¥è·å–å¯¹åº”çš„javaç±»ï¼ŒåŠå¯¹åº”å±æ€§ï¼Œæ–¹æ³•ç­‰ å›åˆ°é¢è¯•é¢˜ç›®ï¼Œäººå®¶è¦æ±‚æ²¡æœ‰çº¯nativeçº¿ç¨‹é‡Œé¢nativeæ–¹æ³•ï¼Œå³è¯´æ˜è¿™ç§æƒ…å†µä¸‹è‚¯å®šä¸è‡ªå¸¦JNIEnvçš„ï¼Œæ•…è¿™é‡Œè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ ä¸è‡ªå¸¦JNIEnvï¼Œä½†æ˜¯è°ƒç”¨javaåˆéœ€è¦JNIEnvï¼Œæ•…å¾—æƒ³æ–¹æ³•æ„é€ å‡ºJNIEnvå…·ä½“å¦‚ä¸‹ï¼š ä¸‹é¢ä»¥ä¸€ä¸ªAndroidæºç ä¸­å®æˆ˜ä¾‹å­æ¥è¯´æ˜ï¼š æºç ä½å­å‚è€ƒï¼š frameworks/base/core/jni/android/graphics/SurfaceTexture.cpp 1ã€è·å–JavaVM,é€šè¿‡AndroidRuntime::getJavaVM()è·å–JavaVM 2ã€é€šè¿‡JavaVMç»‘å®šåˆ°å½“å‰çº¿çº¿ç¨‹è·å–JNIEnvï¼Œé€šè¿‡vm-\u003eAttachCurrentThreadæ–¹æ³•ä¸­å‚æ•°èµ‹å€¼JNIEnv JNIEnv* JNISurfaceTextureContext::getJNIEnv(bool* needsDetach) { *needsDetach = false; JNIEnv* env = AndroidRuntime::getJNIEnv(); if (env == NULL) { JavaVMAttachArgs args = { JNI_VERSION_1_4, \"JNISurfaceTextureContext\", NULL }; JavaVM* vm = AndroidRuntime::getJavaVM();//è·å–JavaVM int result = vm-\u003eAttachCurrentThread(\u0026env, (void*) \u0026args);//èµ‹å€¼env if (result != JNI_OK) { ALOGE(\"thread attach failed: %#x\", result); return NULL; } *needsDetach = true; } return env; } 3ã€ä½¿ç”¨envï¼š void JNISurfaceTextureContext::onFrameAvailable(const BufferItem\u0026 /* item */) { bool needsDetach = false; JNIEnv* env = getJNIEnv(\u0026needsDetach); if (env != NULL) { env-\u003eCallStaticVoidMethod(mClazz, fields.postEvent, mWeakThiz);//ä½¿ç”¨envè°ƒç”¨javaæ–¹æ³• } else { ALOGW(\"onFrameAvailable event will not posted\"); } if (needsDetach) { detachJNI(); } } 4ã€ä¸éœ€è¦ä½¿ç”¨äº†è®°å¾—ä¸å½“å‰çº¿ç¨‹è§£ç»‘å®šï¼Œè°ƒç”¨JavaVMçš„DetachCurrentThreadæ–¹æ³• void JNISurfaceTextureContext::detachJNI() { JavaVM* vm = AndroidRuntime::getJavaVM(); int result = vm-\u003eDetachCurrentThread();//è§£ç»‘å®š if (result != JNI_OK) { ALOGE(\"thread detach failed: %#x\", result); } } ","date":"2024-11-06","objectID":"/posts/android%E6%BA%90%E7%A0%81%E4%B8%AD%E5%AD%A6%E4%B9%A0jni%E9%82%A3%E4%BA%9B%E4%BA%8B--%E5%85%B3%E9%94%AE%E6%8A%80%E5%B7%A7-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Androidæºç ä¸­å­¦ä¹ JNIé‚£äº›äº‹--å…³é”®æŠ€å·§-CSDNåšå®¢","uri":"/posts/android%E6%BA%90%E7%A0%81%E4%B8%AD%E5%AD%A6%E4%B9%A0jni%E9%82%A3%E4%BA%9B%E4%BA%8B--%E5%85%B3%E9%94%AE%E6%8A%80%E5%B7%A7-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"BLASTBufferQueueåˆ›å»ºéƒ¨åˆ† BLASTBufferQueue::BLASTBufferQueue(const std::string\u0026 name, bool updateDestinationFrame) : mSurfaceControl(nullptr), mSize(1, 1), mRequestedSize(mSize), mFormat(PIXEL_FORMAT_RGBA_8888), mTransactionReadyCallback(nullptr), mSyncTransaction(nullptr), mUpdateDestinationFrame(updateDestinationFrame) { //åˆ›å»ºBufferQueueéƒ¨åˆ†ï¼Œå¹¶ä¸”ä¼šç»™mProducerï¼ŒmConsumerè¿›è¡Œèµ‹å€¼ createBufferQueue(\u0026mProducer, \u0026mConsumer); //åˆ›å»ºBLASTBufferItemConsumeréƒ¨åˆ† mBufferItemConsumer = new BLASTBufferItemConsumer(mConsumer, GraphicBuffer::USAGE_HW_COMPOSER | GraphicBuffer::USAGE_HW_TEXTURE, 1, false, this); static int32_t id = 0; mName = name + \"#\" + std::to_string(id); auto consumerName = mName + \"(BLAST Consumer)\" + std::to_string(id); mQueuedBufferTrace = \"QueuedBuffer - \" + mName + \"BLAST#\" + std::to_string(id); id++; mBufferItemConsumer-\u003esetName(String8(consumerName.c_str())); mBufferItemConsumer-\u003esetFrameAvailableListener(this); mBufferItemConsumer-\u003esetBufferFreedListener(this); ComposerService::getComposerService()-\u003egetMaxAcquiredBufferCount(\u0026mMaxAcquiredBuffers); mBufferItemConsumer-\u003esetMaxAcquiredBufferCount(mMaxAcquiredBuffers); mCurrentMaxAcquiredBufferCount = mMaxAcquiredBuffers; mNumAcquired = 0; mNumFrameAvailable = 0; } ","date":"2024-11-06","objectID":"/posts/blastbufferqueue%E6%BA%90%E7%A0%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"BLASTBufferQueueæºç æ·±å…¥ç†è§£-CSDNåšå®¢","uri":"/posts/blastbufferqueue%E6%BA%90%E7%A0%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-csdn%E5%8D%9A%E5%AE%A2/#blastbufferqueueåˆ›å»ºéƒ¨åˆ†"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"BufferQueueéƒ¨åˆ† ä¸‹é¢æ¥çœ‹çœ‹æ ¸å¿ƒçš„æ–¹æ³•createBufferQueue void BLASTBufferQueue::createBufferQueue(sp\u003cIGraphicBufferProducer\u003e* outProducer, sp\u003cIGraphicBufferConsumer\u003e* outConsumer) { //åˆ›å»ºæ ¸å¿ƒçš„BufferQueueCore sp\u003cBufferQueueCore\u003e core(new BufferQueueCore()); //åŸºäºBufferQueueCoreåˆ›å»ºBBQBufferQueueProducer sp\u003cIGraphicBufferProducer\u003e producer(new BBQBufferQueueProducer(core)); //åŸºäºBufferQueueCoreåˆ›å»ºBufferQueueConsumer sp\u003cBufferQueueConsumer\u003e consumer(new BufferQueueConsumer(core)); consumer-\u003esetAllowExtraAcquire(true); *outProducer = producer; *outConsumer = consumer; } ä¸‹é¢é‡ç‚¹çœ‹çœ‹BufferQueueCore BufferQueueCore::BufferQueueCore() : mMutex(),//è‹¥å¹²ä¸ªæˆå‘˜å˜é‡åˆå§‹åŒ– mIsAbandoned(false), mConsumerControlledByApp(false), mConsumerName(getUniqueName()), mConsumerListener(), mConsumerUsageBits(0), mConsumerIsProtected(false), mConnectedApi(NO_CONNECTED_API), mLinkedToDeath(), mConnectedProducerListener(), mBufferReleasedCbEnabled(false), mSlots(), mQueue(), mFreeSlots(), mFreeBuffers(), mUnusedSlots(), mActiveBuffers(), mDequeueCondition(), mDequeueBufferCannotBlock(false), mQueueBufferCanDrop(false), mLegacyBufferDrop(true), mDefaultBufferFormat(PIXEL_FORMAT_RGBA_8888), mDefaultWidth(1), mDefaultHeight(1), mDefaultBufferDataSpace(HAL_DATASPACE_UNKNOWN), mMaxBufferCount(BufferQueueDefs::NUM_BUFFER_SLOTS), mMaxAcquiredBufferCount(1), mMaxDequeuedBufferCount(1), mBufferHasBeenQueued(false), mFrameCounter(0), mTransformHint(0), mIsAllocating(false), mIsAllocatingCondition(), mAllowAllocation(true), mBufferAge(0), mGenerationNumber(0), mAsyncMode(false), mSharedBufferMode(false), mAutoRefresh(false), mSharedBufferSlot(INVALID_BUFFER_SLOT), mSharedBufferCache(Rect::INVALID_RECT, 0, NATIVE_WINDOW_SCALING_MODE_FREEZE, HAL_DATASPACE_UNKNOWN), mLastQueuedSlot(INVALID_BUFFER_SLOT), mUniqueId(getUniqueId()), mAutoPrerotation(false), mTransformHintInUse(0) { int numStartingBuffers = getMaxBufferCountLocked(); for (int s = 0; s \u003c numStartingBuffers; s++) { mFreeSlots.insert(s);//åˆå§‹åŒ–æ—¶å€™é’ˆå¯¹mFreeSlotså¡«å…¥äº†MaxBufferCountä¸ª } for (int s = numStartingBuffers; s \u003c BufferQueueDefs::NUM_BUFFER_SLOTS; s++) { mUnusedSlots.push_front(s);//é™¤äº†mFreeSlotséƒ¨åˆ†ï¼Œå…¶ä»–éƒ½æ˜¯å¡«å…¥mUnusedSlots } } ä¸Šé¢çš„æ„é€ ä¸­æœ‰ä»¥ä¸‹å‡ ä¸ªæˆå‘˜å˜é‡éå¸¸å…³é”®éœ€è¦é‡ç‚¹ä»‹ç» // mSlots is an array of buffer slots that must be mirrored on the producer // side. This allows buffer ownership to be transferred between the producer // and consumer without sending a GraphicBuffer over Binder. The entire // array is initialized to NULL at construction time, and buffers are // allocated for a slot when requestBuffer is called with that slot's index. BufferQueueDefs::SlotsType mSlots; // mQueue is a FIFO of queued buffers used in synchronous mode. Fifo mQueue; // mFreeSlots contains all of the slots which are FREE and do not currently // have a buffer attached. std::set\u003cint\u003e mFreeSlots; // mFreeBuffers contains all of the slots which are FREE and currently have // a buffer attached. std::list\u003cint\u003e mFreeBuffers; // mUnusedSlots contains all slots that are currently unused. They should be // free and not have a buffer attached. std::list\u003cint\u003e mUnusedSlots; // mActiveBuffers contains all slots which have a non-FREE buffer attached. std::set\u003cint\u003e mActiveBuffers; mQueue â€”\u003e å­˜æ”¾BufferItemçš„FIFOé˜Ÿåˆ— mSlots â€”\u003e BufferSlotç»“æ„ä½“æ•°ç»„ï¼Œæ•°ç»„é•¿åº¦å›ºå®šä¸º64 mFreeSlots â€”\u003e BufferSlotçŠ¶æ€ä¸ºFREEï¼Œä¸”æ²¡æœ‰GraphicBufferä¸ä¹‹ç›¸ç»‘å®šçš„sloté›†åˆ mFreeBuffers â€”\u003e BufferSlotçŠ¶æ€ä¸ºFREEï¼Œä¸”æœ‰GraphicBufferä¸ä¹‹ç›¸ç»‘å®šçš„sloté›†åˆ mActiveBuffers â€”\u003e BufferSlotçŠ¶æ€ä¸ä¸ºFREEï¼ˆå³DEQUEUEDã€QUEUEDã€ACQUIREDã€SHAREDï¼‰çš„sloté›†åˆã€‚æ—¢ç„¶çŠ¶æ€ä¸æ˜¯FREEï¼Œé‚£ä¹ˆè¯¥BufferSlotå¿…ç„¶æœ‰ä¸€ä¸ªGraphicBufferä¸ä¹‹ç›¸ç»‘å®š mUnusedSlots â€”\u003e æœªå‚ä¸ä½¿ç”¨çš„sloté›†åˆï¼Œç”± mMaxBufferCount å†³å®š æ³¨æ„mFreeSlotsï¼ŒmFreeBuffersï¼ŒmActiveBuffersï¼ŒmUnusedSlotséƒ½å…¶å®æ˜¯ä¸€ä¸ªinté›†åˆï¼Œå†…å®¹å°±æ˜¯mSlotsæ•°ç»„çš„ä¸€ä¸ªä¸ªindex è¯¦ç»†å‰–æä¸€ä¸‹mSlotsè¿™ä¸ªå˜é‡ï¼š namespace BufferQueueDefs { typedef BufferSlot SlotsType[NUM_BUFFER_SLOTS]; } // namespace BufferQueueDefs struct BufferSlot { BufferSlot() : mGraphicBuffer(nullptr), mEglDisplay(EGL_NO_DISPLAY), mBufferState(), mRequestBufferCalled(false), mFrameNumber(0), mEglFence(EGL_NO_SYNC_KHR), mFence(Fence::NO_FENCE), mAcquireCalled(false), mNeedsReallocation(false) { } } å¯ä»¥çœ‹åˆ°mSlot","date":"2024-11-06","objectID":"/posts/blastbufferqueue%E6%BA%90%E7%A0%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"BLASTBufferQueueæºç æ·±å…¥ç†è§£-CSDNåšå®¢","uri":"/posts/blastbufferqueue%E6%BA%90%E7%A0%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-csdn%E5%8D%9A%E5%AE%A2/#bufferqueueéƒ¨åˆ†"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"BufferQueueéƒ¨åˆ† ä¸‹é¢æ¥çœ‹çœ‹æ ¸å¿ƒçš„æ–¹æ³•createBufferQueue void BLASTBufferQueue::createBufferQueue(sp* outProducer, sp* outConsumer) { //åˆ›å»ºæ ¸å¿ƒçš„BufferQueueCore sp core(new BufferQueueCore()); //åŸºäºBufferQueueCoreåˆ›å»ºBBQBufferQueueProducer sp producer(new BBQBufferQueueProducer(core)); //åŸºäºBufferQueueCoreåˆ›å»ºBufferQueueConsumer sp consumer(new BufferQueueConsumer(core)); consumer-\u003esetAllowExtraAcquire(true); *outProducer = producer; *outConsumer = consumer; } ä¸‹é¢é‡ç‚¹çœ‹çœ‹BufferQueueCore BufferQueueCore::BufferQueueCore() : mMutex(),//è‹¥å¹²ä¸ªæˆå‘˜å˜é‡åˆå§‹åŒ– mIsAbandoned(false), mConsumerControlledByApp(false), mConsumerName(getUniqueName()), mConsumerListener(), mConsumerUsageBits(0), mConsumerIsProtected(false), mConnectedApi(NO_CONNECTED_API), mLinkedToDeath(), mConnectedProducerListener(), mBufferReleasedCbEnabled(false), mSlots(), mQueue(), mFreeSlots(), mFreeBuffers(), mUnusedSlots(), mActiveBuffers(), mDequeueCondition(), mDequeueBufferCannotBlock(false), mQueueBufferCanDrop(false), mLegacyBufferDrop(true), mDefaultBufferFormat(PIXEL_FORMAT_RGBA_8888), mDefaultWidth(1), mDefaultHeight(1), mDefaultBufferDataSpace(HAL_DATASPACE_UNKNOWN), mMaxBufferCount(BufferQueueDefs::NUM_BUFFER_SLOTS), mMaxAcquiredBufferCount(1), mMaxDequeuedBufferCount(1), mBufferHasBeenQueued(false), mFrameCounter(0), mTransformHint(0), mIsAllocating(false), mIsAllocatingCondition(), mAllowAllocation(true), mBufferAge(0), mGenerationNumber(0), mAsyncMode(false), mSharedBufferMode(false), mAutoRefresh(false), mSharedBufferSlot(INVALID_BUFFER_SLOT), mSharedBufferCache(Rect::INVALID_RECT, 0, NATIVE_WINDOW_SCALING_MODE_FREEZE, HAL_DATASPACE_UNKNOWN), mLastQueuedSlot(INVALID_BUFFER_SLOT), mUniqueId(getUniqueId()), mAutoPrerotation(false), mTransformHintInUse(0) { int numStartingBuffers = getMaxBufferCountLocked(); for (int s = 0; s \u003c numStartingBuffers; s++) { mFreeSlots.insert(s);//åˆå§‹åŒ–æ—¶å€™é’ˆå¯¹mFreeSlotså¡«å…¥äº†MaxBufferCountä¸ª } for (int s = numStartingBuffers; s \u003c BufferQueueDefs::NUM_BUFFER_SLOTS; s++) { mUnusedSlots.push_front(s);//é™¤äº†mFreeSlotséƒ¨åˆ†ï¼Œå…¶ä»–éƒ½æ˜¯å¡«å…¥mUnusedSlots } } ä¸Šé¢çš„æ„é€ ä¸­æœ‰ä»¥ä¸‹å‡ ä¸ªæˆå‘˜å˜é‡éå¸¸å…³é”®éœ€è¦é‡ç‚¹ä»‹ç» // mSlots is an array of buffer slots that must be mirrored on the producer // side. This allows buffer ownership to be transferred between the producer // and consumer without sending a GraphicBuffer over Binder. The entire // array is initialized to NULL at construction time, and buffers are // allocated for a slot when requestBuffer is called with that slot's index. BufferQueueDefs::SlotsType mSlots; // mQueue is a FIFO of queued buffers used in synchronous mode. Fifo mQueue; // mFreeSlots contains all of the slots which are FREE and do not currently // have a buffer attached. std::set mFreeSlots; // mFreeBuffers contains all of the slots which are FREE and currently have // a buffer attached. std::list mFreeBuffers; // mUnusedSlots contains all slots that are currently unused. They should be // free and not have a buffer attached. std::list mUnusedSlots; // mActiveBuffers contains all slots which have a non-FREE buffer attached. std::set mActiveBuffers; mQueue â€”\u003e å­˜æ”¾BufferItemçš„FIFOé˜Ÿåˆ— mSlots â€”\u003e BufferSlotç»“æ„ä½“æ•°ç»„ï¼Œæ•°ç»„é•¿åº¦å›ºå®šä¸º64 mFreeSlots â€”\u003e BufferSlotçŠ¶æ€ä¸ºFREEï¼Œä¸”æ²¡æœ‰GraphicBufferä¸ä¹‹ç›¸ç»‘å®šçš„sloté›†åˆ mFreeBuffers â€”\u003e BufferSlotçŠ¶æ€ä¸ºFREEï¼Œä¸”æœ‰GraphicBufferä¸ä¹‹ç›¸ç»‘å®šçš„sloté›†åˆ mActiveBuffers â€”\u003e BufferSlotçŠ¶æ€ä¸ä¸ºFREEï¼ˆå³DEQUEUEDã€QUEUEDã€ACQUIREDã€SHAREDï¼‰çš„sloté›†åˆã€‚æ—¢ç„¶çŠ¶æ€ä¸æ˜¯FREEï¼Œé‚£ä¹ˆè¯¥BufferSlotå¿…ç„¶æœ‰ä¸€ä¸ªGraphicBufferä¸ä¹‹ç›¸ç»‘å®š mUnusedSlots â€”\u003e æœªå‚ä¸ä½¿ç”¨çš„sloté›†åˆï¼Œç”± mMaxBufferCount å†³å®š æ³¨æ„mFreeSlotsï¼ŒmFreeBuffersï¼ŒmActiveBuffersï¼ŒmUnusedSlotséƒ½å…¶å®æ˜¯ä¸€ä¸ªinté›†åˆï¼Œå†…å®¹å°±æ˜¯mSlotsæ•°ç»„çš„ä¸€ä¸ªä¸ªindex è¯¦ç»†å‰–æä¸€ä¸‹mSlotsè¿™ä¸ªå˜é‡ï¼š namespace BufferQueueDefs { typedef BufferSlot SlotsType[NUM_BUFFER_SLOTS]; } // namespace BufferQueueDefs struct BufferSlot { BufferSlot() : mGraphicBuffer(nullptr), mEglDisplay(EGL_NO_DISPLAY), mBufferState(), mRequestBufferCalled(false), mFrameNumber(0), mEglFence(EGL_NO_SYNC_KHR), mFence(Fence::NO_FENCE), mAcquireCalled(false), mNeedsReallocation(false) { } } å¯ä»¥çœ‹åˆ°mSlot","date":"2024-11-06","objectID":"/posts/blastbufferqueue%E6%BA%90%E7%A0%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"BLASTBufferQueueæºç æ·±å…¥ç†è§£-CSDNåšå®¢","uri":"/posts/blastbufferqueue%E6%BA%90%E7%A0%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-csdn%E5%8D%9A%E5%AE%A2/#dequeuebuffer-ç”Ÿäº§è€…æ–¹æ³•"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"BufferQueueéƒ¨åˆ† ä¸‹é¢æ¥çœ‹çœ‹æ ¸å¿ƒçš„æ–¹æ³•createBufferQueue void BLASTBufferQueue::createBufferQueue(sp* outProducer, sp* outConsumer) { //åˆ›å»ºæ ¸å¿ƒçš„BufferQueueCore sp core(new BufferQueueCore()); //åŸºäºBufferQueueCoreåˆ›å»ºBBQBufferQueueProducer sp producer(new BBQBufferQueueProducer(core)); //åŸºäºBufferQueueCoreåˆ›å»ºBufferQueueConsumer sp consumer(new BufferQueueConsumer(core)); consumer-\u003esetAllowExtraAcquire(true); *outProducer = producer; *outConsumer = consumer; } ä¸‹é¢é‡ç‚¹çœ‹çœ‹BufferQueueCore BufferQueueCore::BufferQueueCore() : mMutex(),//è‹¥å¹²ä¸ªæˆå‘˜å˜é‡åˆå§‹åŒ– mIsAbandoned(false), mConsumerControlledByApp(false), mConsumerName(getUniqueName()), mConsumerListener(), mConsumerUsageBits(0), mConsumerIsProtected(false), mConnectedApi(NO_CONNECTED_API), mLinkedToDeath(), mConnectedProducerListener(), mBufferReleasedCbEnabled(false), mSlots(), mQueue(), mFreeSlots(), mFreeBuffers(), mUnusedSlots(), mActiveBuffers(), mDequeueCondition(), mDequeueBufferCannotBlock(false), mQueueBufferCanDrop(false), mLegacyBufferDrop(true), mDefaultBufferFormat(PIXEL_FORMAT_RGBA_8888), mDefaultWidth(1), mDefaultHeight(1), mDefaultBufferDataSpace(HAL_DATASPACE_UNKNOWN), mMaxBufferCount(BufferQueueDefs::NUM_BUFFER_SLOTS), mMaxAcquiredBufferCount(1), mMaxDequeuedBufferCount(1), mBufferHasBeenQueued(false), mFrameCounter(0), mTransformHint(0), mIsAllocating(false), mIsAllocatingCondition(), mAllowAllocation(true), mBufferAge(0), mGenerationNumber(0), mAsyncMode(false), mSharedBufferMode(false), mAutoRefresh(false), mSharedBufferSlot(INVALID_BUFFER_SLOT), mSharedBufferCache(Rect::INVALID_RECT, 0, NATIVE_WINDOW_SCALING_MODE_FREEZE, HAL_DATASPACE_UNKNOWN), mLastQueuedSlot(INVALID_BUFFER_SLOT), mUniqueId(getUniqueId()), mAutoPrerotation(false), mTransformHintInUse(0) { int numStartingBuffers = getMaxBufferCountLocked(); for (int s = 0; s \u003c numStartingBuffers; s++) { mFreeSlots.insert(s);//åˆå§‹åŒ–æ—¶å€™é’ˆå¯¹mFreeSlotså¡«å…¥äº†MaxBufferCountä¸ª } for (int s = numStartingBuffers; s \u003c BufferQueueDefs::NUM_BUFFER_SLOTS; s++) { mUnusedSlots.push_front(s);//é™¤äº†mFreeSlotséƒ¨åˆ†ï¼Œå…¶ä»–éƒ½æ˜¯å¡«å…¥mUnusedSlots } } ä¸Šé¢çš„æ„é€ ä¸­æœ‰ä»¥ä¸‹å‡ ä¸ªæˆå‘˜å˜é‡éå¸¸å…³é”®éœ€è¦é‡ç‚¹ä»‹ç» // mSlots is an array of buffer slots that must be mirrored on the producer // side. This allows buffer ownership to be transferred between the producer // and consumer without sending a GraphicBuffer over Binder. The entire // array is initialized to NULL at construction time, and buffers are // allocated for a slot when requestBuffer is called with that slot's index. BufferQueueDefs::SlotsType mSlots; // mQueue is a FIFO of queued buffers used in synchronous mode. Fifo mQueue; // mFreeSlots contains all of the slots which are FREE and do not currently // have a buffer attached. std::set mFreeSlots; // mFreeBuffers contains all of the slots which are FREE and currently have // a buffer attached. std::list mFreeBuffers; // mUnusedSlots contains all slots that are currently unused. They should be // free and not have a buffer attached. std::list mUnusedSlots; // mActiveBuffers contains all slots which have a non-FREE buffer attached. std::set mActiveBuffers; mQueue â€”\u003e å­˜æ”¾BufferItemçš„FIFOé˜Ÿåˆ— mSlots â€”\u003e BufferSlotç»“æ„ä½“æ•°ç»„ï¼Œæ•°ç»„é•¿åº¦å›ºå®šä¸º64 mFreeSlots â€”\u003e BufferSlotçŠ¶æ€ä¸ºFREEï¼Œä¸”æ²¡æœ‰GraphicBufferä¸ä¹‹ç›¸ç»‘å®šçš„sloté›†åˆ mFreeBuffers â€”\u003e BufferSlotçŠ¶æ€ä¸ºFREEï¼Œä¸”æœ‰GraphicBufferä¸ä¹‹ç›¸ç»‘å®šçš„sloté›†åˆ mActiveBuffers â€”\u003e BufferSlotçŠ¶æ€ä¸ä¸ºFREEï¼ˆå³DEQUEUEDã€QUEUEDã€ACQUIREDã€SHAREDï¼‰çš„sloté›†åˆã€‚æ—¢ç„¶çŠ¶æ€ä¸æ˜¯FREEï¼Œé‚£ä¹ˆè¯¥BufferSlotå¿…ç„¶æœ‰ä¸€ä¸ªGraphicBufferä¸ä¹‹ç›¸ç»‘å®š mUnusedSlots â€”\u003e æœªå‚ä¸ä½¿ç”¨çš„sloté›†åˆï¼Œç”± mMaxBufferCount å†³å®š æ³¨æ„mFreeSlotsï¼ŒmFreeBuffersï¼ŒmActiveBuffersï¼ŒmUnusedSlotséƒ½å…¶å®æ˜¯ä¸€ä¸ªinté›†åˆï¼Œå†…å®¹å°±æ˜¯mSlotsæ•°ç»„çš„ä¸€ä¸ªä¸ªindex è¯¦ç»†å‰–æä¸€ä¸‹mSlotsè¿™ä¸ªå˜é‡ï¼š namespace BufferQueueDefs { typedef BufferSlot SlotsType[NUM_BUFFER_SLOTS]; } // namespace BufferQueueDefs struct BufferSlot { BufferSlot() : mGraphicBuffer(nullptr), mEglDisplay(EGL_NO_DISPLAY), mBufferState(), mRequestBufferCalled(false), mFrameNumber(0), mEglFence(EGL_NO_SYNC_KHR), mFence(Fence::NO_FENCE), mAcquireCalled(false), mNeedsReallocation(false) { } } å¯ä»¥çœ‹åˆ°mSlot","date":"2024-11-06","objectID":"/posts/blastbufferqueue%E6%BA%90%E7%A0%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"BLASTBufferQueueæºç æ·±å…¥ç†è§£-CSDNåšå®¢","uri":"/posts/blastbufferqueue%E6%BA%90%E7%A0%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-csdn%E5%8D%9A%E5%AE%A2/#requestbufferç”Ÿäº§è€…æ–¹æ³•"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"BufferQueueéƒ¨åˆ† ä¸‹é¢æ¥çœ‹çœ‹æ ¸å¿ƒçš„æ–¹æ³•createBufferQueue void BLASTBufferQueue::createBufferQueue(sp* outProducer, sp* outConsumer) { //åˆ›å»ºæ ¸å¿ƒçš„BufferQueueCore sp core(new BufferQueueCore()); //åŸºäºBufferQueueCoreåˆ›å»ºBBQBufferQueueProducer sp producer(new BBQBufferQueueProducer(core)); //åŸºäºBufferQueueCoreåˆ›å»ºBufferQueueConsumer sp consumer(new BufferQueueConsumer(core)); consumer-\u003esetAllowExtraAcquire(true); *outProducer = producer; *outConsumer = consumer; } ä¸‹é¢é‡ç‚¹çœ‹çœ‹BufferQueueCore BufferQueueCore::BufferQueueCore() : mMutex(),//è‹¥å¹²ä¸ªæˆå‘˜å˜é‡åˆå§‹åŒ– mIsAbandoned(false), mConsumerControlledByApp(false), mConsumerName(getUniqueName()), mConsumerListener(), mConsumerUsageBits(0), mConsumerIsProtected(false), mConnectedApi(NO_CONNECTED_API), mLinkedToDeath(), mConnectedProducerListener(), mBufferReleasedCbEnabled(false), mSlots(), mQueue(), mFreeSlots(), mFreeBuffers(), mUnusedSlots(), mActiveBuffers(), mDequeueCondition(), mDequeueBufferCannotBlock(false), mQueueBufferCanDrop(false), mLegacyBufferDrop(true), mDefaultBufferFormat(PIXEL_FORMAT_RGBA_8888), mDefaultWidth(1), mDefaultHeight(1), mDefaultBufferDataSpace(HAL_DATASPACE_UNKNOWN), mMaxBufferCount(BufferQueueDefs::NUM_BUFFER_SLOTS), mMaxAcquiredBufferCount(1), mMaxDequeuedBufferCount(1), mBufferHasBeenQueued(false), mFrameCounter(0), mTransformHint(0), mIsAllocating(false), mIsAllocatingCondition(), mAllowAllocation(true), mBufferAge(0), mGenerationNumber(0), mAsyncMode(false), mSharedBufferMode(false), mAutoRefresh(false), mSharedBufferSlot(INVALID_BUFFER_SLOT), mSharedBufferCache(Rect::INVALID_RECT, 0, NATIVE_WINDOW_SCALING_MODE_FREEZE, HAL_DATASPACE_UNKNOWN), mLastQueuedSlot(INVALID_BUFFER_SLOT), mUniqueId(getUniqueId()), mAutoPrerotation(false), mTransformHintInUse(0) { int numStartingBuffers = getMaxBufferCountLocked(); for (int s = 0; s \u003c numStartingBuffers; s++) { mFreeSlots.insert(s);//åˆå§‹åŒ–æ—¶å€™é’ˆå¯¹mFreeSlotså¡«å…¥äº†MaxBufferCountä¸ª } for (int s = numStartingBuffers; s \u003c BufferQueueDefs::NUM_BUFFER_SLOTS; s++) { mUnusedSlots.push_front(s);//é™¤äº†mFreeSlotséƒ¨åˆ†ï¼Œå…¶ä»–éƒ½æ˜¯å¡«å…¥mUnusedSlots } } ä¸Šé¢çš„æ„é€ ä¸­æœ‰ä»¥ä¸‹å‡ ä¸ªæˆå‘˜å˜é‡éå¸¸å…³é”®éœ€è¦é‡ç‚¹ä»‹ç» // mSlots is an array of buffer slots that must be mirrored on the producer // side. This allows buffer ownership to be transferred between the producer // and consumer without sending a GraphicBuffer over Binder. The entire // array is initialized to NULL at construction time, and buffers are // allocated for a slot when requestBuffer is called with that slot's index. BufferQueueDefs::SlotsType mSlots; // mQueue is a FIFO of queued buffers used in synchronous mode. Fifo mQueue; // mFreeSlots contains all of the slots which are FREE and do not currently // have a buffer attached. std::set mFreeSlots; // mFreeBuffers contains all of the slots which are FREE and currently have // a buffer attached. std::list mFreeBuffers; // mUnusedSlots contains all slots that are currently unused. They should be // free and not have a buffer attached. std::list mUnusedSlots; // mActiveBuffers contains all slots which have a non-FREE buffer attached. std::set mActiveBuffers; mQueue â€”\u003e å­˜æ”¾BufferItemçš„FIFOé˜Ÿåˆ— mSlots â€”\u003e BufferSlotç»“æ„ä½“æ•°ç»„ï¼Œæ•°ç»„é•¿åº¦å›ºå®šä¸º64 mFreeSlots â€”\u003e BufferSlotçŠ¶æ€ä¸ºFREEï¼Œä¸”æ²¡æœ‰GraphicBufferä¸ä¹‹ç›¸ç»‘å®šçš„sloté›†åˆ mFreeBuffers â€”\u003e BufferSlotçŠ¶æ€ä¸ºFREEï¼Œä¸”æœ‰GraphicBufferä¸ä¹‹ç›¸ç»‘å®šçš„sloté›†åˆ mActiveBuffers â€”\u003e BufferSlotçŠ¶æ€ä¸ä¸ºFREEï¼ˆå³DEQUEUEDã€QUEUEDã€ACQUIREDã€SHAREDï¼‰çš„sloté›†åˆã€‚æ—¢ç„¶çŠ¶æ€ä¸æ˜¯FREEï¼Œé‚£ä¹ˆè¯¥BufferSlotå¿…ç„¶æœ‰ä¸€ä¸ªGraphicBufferä¸ä¹‹ç›¸ç»‘å®š mUnusedSlots â€”\u003e æœªå‚ä¸ä½¿ç”¨çš„sloté›†åˆï¼Œç”± mMaxBufferCount å†³å®š æ³¨æ„mFreeSlotsï¼ŒmFreeBuffersï¼ŒmActiveBuffersï¼ŒmUnusedSlotséƒ½å…¶å®æ˜¯ä¸€ä¸ªinté›†åˆï¼Œå†…å®¹å°±æ˜¯mSlotsæ•°ç»„çš„ä¸€ä¸ªä¸ªindex è¯¦ç»†å‰–æä¸€ä¸‹mSlotsè¿™ä¸ªå˜é‡ï¼š namespace BufferQueueDefs { typedef BufferSlot SlotsType[NUM_BUFFER_SLOTS]; } // namespace BufferQueueDefs struct BufferSlot { BufferSlot() : mGraphicBuffer(nullptr), mEglDisplay(EGL_NO_DISPLAY), mBufferState(), mRequestBufferCalled(false), mFrameNumber(0), mEglFence(EGL_NO_SYNC_KHR), mFence(Fence::NO_FENCE), mAcquireCalled(false), mNeedsReallocation(false) { } } å¯ä»¥çœ‹åˆ°mSlot","date":"2024-11-06","objectID":"/posts/blastbufferqueue%E6%BA%90%E7%A0%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"BLASTBufferQueueæºç æ·±å…¥ç†è§£-CSDNåšå®¢","uri":"/posts/blastbufferqueue%E6%BA%90%E7%A0%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-csdn%E5%8D%9A%E5%AE%A2/#queuebufferç”Ÿäº§è€…æ–¹æ³•"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"BufferQueueéƒ¨åˆ† ä¸‹é¢æ¥çœ‹çœ‹æ ¸å¿ƒçš„æ–¹æ³•createBufferQueue void BLASTBufferQueue::createBufferQueue(sp* outProducer, sp* outConsumer) { //åˆ›å»ºæ ¸å¿ƒçš„BufferQueueCore sp core(new BufferQueueCore()); //åŸºäºBufferQueueCoreåˆ›å»ºBBQBufferQueueProducer sp producer(new BBQBufferQueueProducer(core)); //åŸºäºBufferQueueCoreåˆ›å»ºBufferQueueConsumer sp consumer(new BufferQueueConsumer(core)); consumer-\u003esetAllowExtraAcquire(true); *outProducer = producer; *outConsumer = consumer; } ä¸‹é¢é‡ç‚¹çœ‹çœ‹BufferQueueCore BufferQueueCore::BufferQueueCore() : mMutex(),//è‹¥å¹²ä¸ªæˆå‘˜å˜é‡åˆå§‹åŒ– mIsAbandoned(false), mConsumerControlledByApp(false), mConsumerName(getUniqueName()), mConsumerListener(), mConsumerUsageBits(0), mConsumerIsProtected(false), mConnectedApi(NO_CONNECTED_API), mLinkedToDeath(), mConnectedProducerListener(), mBufferReleasedCbEnabled(false), mSlots(), mQueue(), mFreeSlots(), mFreeBuffers(), mUnusedSlots(), mActiveBuffers(), mDequeueCondition(), mDequeueBufferCannotBlock(false), mQueueBufferCanDrop(false), mLegacyBufferDrop(true), mDefaultBufferFormat(PIXEL_FORMAT_RGBA_8888), mDefaultWidth(1), mDefaultHeight(1), mDefaultBufferDataSpace(HAL_DATASPACE_UNKNOWN), mMaxBufferCount(BufferQueueDefs::NUM_BUFFER_SLOTS), mMaxAcquiredBufferCount(1), mMaxDequeuedBufferCount(1), mBufferHasBeenQueued(false), mFrameCounter(0), mTransformHint(0), mIsAllocating(false), mIsAllocatingCondition(), mAllowAllocation(true), mBufferAge(0), mGenerationNumber(0), mAsyncMode(false), mSharedBufferMode(false), mAutoRefresh(false), mSharedBufferSlot(INVALID_BUFFER_SLOT), mSharedBufferCache(Rect::INVALID_RECT, 0, NATIVE_WINDOW_SCALING_MODE_FREEZE, HAL_DATASPACE_UNKNOWN), mLastQueuedSlot(INVALID_BUFFER_SLOT), mUniqueId(getUniqueId()), mAutoPrerotation(false), mTransformHintInUse(0) { int numStartingBuffers = getMaxBufferCountLocked(); for (int s = 0; s \u003c numStartingBuffers; s++) { mFreeSlots.insert(s);//åˆå§‹åŒ–æ—¶å€™é’ˆå¯¹mFreeSlotså¡«å…¥äº†MaxBufferCountä¸ª } for (int s = numStartingBuffers; s \u003c BufferQueueDefs::NUM_BUFFER_SLOTS; s++) { mUnusedSlots.push_front(s);//é™¤äº†mFreeSlotséƒ¨åˆ†ï¼Œå…¶ä»–éƒ½æ˜¯å¡«å…¥mUnusedSlots } } ä¸Šé¢çš„æ„é€ ä¸­æœ‰ä»¥ä¸‹å‡ ä¸ªæˆå‘˜å˜é‡éå¸¸å…³é”®éœ€è¦é‡ç‚¹ä»‹ç» // mSlots is an array of buffer slots that must be mirrored on the producer // side. This allows buffer ownership to be transferred between the producer // and consumer without sending a GraphicBuffer over Binder. The entire // array is initialized to NULL at construction time, and buffers are // allocated for a slot when requestBuffer is called with that slot's index. BufferQueueDefs::SlotsType mSlots; // mQueue is a FIFO of queued buffers used in synchronous mode. Fifo mQueue; // mFreeSlots contains all of the slots which are FREE and do not currently // have a buffer attached. std::set mFreeSlots; // mFreeBuffers contains all of the slots which are FREE and currently have // a buffer attached. std::list mFreeBuffers; // mUnusedSlots contains all slots that are currently unused. They should be // free and not have a buffer attached. std::list mUnusedSlots; // mActiveBuffers contains all slots which have a non-FREE buffer attached. std::set mActiveBuffers; mQueue â€”\u003e å­˜æ”¾BufferItemçš„FIFOé˜Ÿåˆ— mSlots â€”\u003e BufferSlotç»“æ„ä½“æ•°ç»„ï¼Œæ•°ç»„é•¿åº¦å›ºå®šä¸º64 mFreeSlots â€”\u003e BufferSlotçŠ¶æ€ä¸ºFREEï¼Œä¸”æ²¡æœ‰GraphicBufferä¸ä¹‹ç›¸ç»‘å®šçš„sloté›†åˆ mFreeBuffers â€”\u003e BufferSlotçŠ¶æ€ä¸ºFREEï¼Œä¸”æœ‰GraphicBufferä¸ä¹‹ç›¸ç»‘å®šçš„sloté›†åˆ mActiveBuffers â€”\u003e BufferSlotçŠ¶æ€ä¸ä¸ºFREEï¼ˆå³DEQUEUEDã€QUEUEDã€ACQUIREDã€SHAREDï¼‰çš„sloté›†åˆã€‚æ—¢ç„¶çŠ¶æ€ä¸æ˜¯FREEï¼Œé‚£ä¹ˆè¯¥BufferSlotå¿…ç„¶æœ‰ä¸€ä¸ªGraphicBufferä¸ä¹‹ç›¸ç»‘å®š mUnusedSlots â€”\u003e æœªå‚ä¸ä½¿ç”¨çš„sloté›†åˆï¼Œç”± mMaxBufferCount å†³å®š æ³¨æ„mFreeSlotsï¼ŒmFreeBuffersï¼ŒmActiveBuffersï¼ŒmUnusedSlotséƒ½å…¶å®æ˜¯ä¸€ä¸ªinté›†åˆï¼Œå†…å®¹å°±æ˜¯mSlotsæ•°ç»„çš„ä¸€ä¸ªä¸ªindex è¯¦ç»†å‰–æä¸€ä¸‹mSlotsè¿™ä¸ªå˜é‡ï¼š namespace BufferQueueDefs { typedef BufferSlot SlotsType[NUM_BUFFER_SLOTS]; } // namespace BufferQueueDefs struct BufferSlot { BufferSlot() : mGraphicBuffer(nullptr), mEglDisplay(EGL_NO_DISPLAY), mBufferState(), mRequestBufferCalled(false), mFrameNumber(0), mEglFence(EGL_NO_SYNC_KHR), mFence(Fence::NO_FENCE), mAcquireCalled(false), mNeedsReallocation(false) { } } å¯ä»¥çœ‹åˆ°mSlot","date":"2024-11-06","objectID":"/posts/blastbufferqueue%E6%BA%90%E7%A0%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"BLASTBufferQueueæºç æ·±å…¥ç†è§£-CSDNåšå®¢","uri":"/posts/blastbufferqueue%E6%BA%90%E7%A0%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-csdn%E5%8D%9A%E5%AE%A2/#onframeavailable"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"BufferQueueéƒ¨åˆ† ä¸‹é¢æ¥çœ‹çœ‹æ ¸å¿ƒçš„æ–¹æ³•createBufferQueue void BLASTBufferQueue::createBufferQueue(sp* outProducer, sp* outConsumer) { //åˆ›å»ºæ ¸å¿ƒçš„BufferQueueCore sp core(new BufferQueueCore()); //åŸºäºBufferQueueCoreåˆ›å»ºBBQBufferQueueProducer sp producer(new BBQBufferQueueProducer(core)); //åŸºäºBufferQueueCoreåˆ›å»ºBufferQueueConsumer sp consumer(new BufferQueueConsumer(core)); consumer-\u003esetAllowExtraAcquire(true); *outProducer = producer; *outConsumer = consumer; } ä¸‹é¢é‡ç‚¹çœ‹çœ‹BufferQueueCore BufferQueueCore::BufferQueueCore() : mMutex(),//è‹¥å¹²ä¸ªæˆå‘˜å˜é‡åˆå§‹åŒ– mIsAbandoned(false), mConsumerControlledByApp(false), mConsumerName(getUniqueName()), mConsumerListener(), mConsumerUsageBits(0), mConsumerIsProtected(false), mConnectedApi(NO_CONNECTED_API), mLinkedToDeath(), mConnectedProducerListener(), mBufferReleasedCbEnabled(false), mSlots(), mQueue(), mFreeSlots(), mFreeBuffers(), mUnusedSlots(), mActiveBuffers(), mDequeueCondition(), mDequeueBufferCannotBlock(false), mQueueBufferCanDrop(false), mLegacyBufferDrop(true), mDefaultBufferFormat(PIXEL_FORMAT_RGBA_8888), mDefaultWidth(1), mDefaultHeight(1), mDefaultBufferDataSpace(HAL_DATASPACE_UNKNOWN), mMaxBufferCount(BufferQueueDefs::NUM_BUFFER_SLOTS), mMaxAcquiredBufferCount(1), mMaxDequeuedBufferCount(1), mBufferHasBeenQueued(false), mFrameCounter(0), mTransformHint(0), mIsAllocating(false), mIsAllocatingCondition(), mAllowAllocation(true), mBufferAge(0), mGenerationNumber(0), mAsyncMode(false), mSharedBufferMode(false), mAutoRefresh(false), mSharedBufferSlot(INVALID_BUFFER_SLOT), mSharedBufferCache(Rect::INVALID_RECT, 0, NATIVE_WINDOW_SCALING_MODE_FREEZE, HAL_DATASPACE_UNKNOWN), mLastQueuedSlot(INVALID_BUFFER_SLOT), mUniqueId(getUniqueId()), mAutoPrerotation(false), mTransformHintInUse(0) { int numStartingBuffers = getMaxBufferCountLocked(); for (int s = 0; s \u003c numStartingBuffers; s++) { mFreeSlots.insert(s);//åˆå§‹åŒ–æ—¶å€™é’ˆå¯¹mFreeSlotså¡«å…¥äº†MaxBufferCountä¸ª } for (int s = numStartingBuffers; s \u003c BufferQueueDefs::NUM_BUFFER_SLOTS; s++) { mUnusedSlots.push_front(s);//é™¤äº†mFreeSlotséƒ¨åˆ†ï¼Œå…¶ä»–éƒ½æ˜¯å¡«å…¥mUnusedSlots } } ä¸Šé¢çš„æ„é€ ä¸­æœ‰ä»¥ä¸‹å‡ ä¸ªæˆå‘˜å˜é‡éå¸¸å…³é”®éœ€è¦é‡ç‚¹ä»‹ç» // mSlots is an array of buffer slots that must be mirrored on the producer // side. This allows buffer ownership to be transferred between the producer // and consumer without sending a GraphicBuffer over Binder. The entire // array is initialized to NULL at construction time, and buffers are // allocated for a slot when requestBuffer is called with that slot's index. BufferQueueDefs::SlotsType mSlots; // mQueue is a FIFO of queued buffers used in synchronous mode. Fifo mQueue; // mFreeSlots contains all of the slots which are FREE and do not currently // have a buffer attached. std::set mFreeSlots; // mFreeBuffers contains all of the slots which are FREE and currently have // a buffer attached. std::list mFreeBuffers; // mUnusedSlots contains all slots that are currently unused. They should be // free and not have a buffer attached. std::list mUnusedSlots; // mActiveBuffers contains all slots which have a non-FREE buffer attached. std::set mActiveBuffers; mQueue â€”\u003e å­˜æ”¾BufferItemçš„FIFOé˜Ÿåˆ— mSlots â€”\u003e BufferSlotç»“æ„ä½“æ•°ç»„ï¼Œæ•°ç»„é•¿åº¦å›ºå®šä¸º64 mFreeSlots â€”\u003e BufferSlotçŠ¶æ€ä¸ºFREEï¼Œä¸”æ²¡æœ‰GraphicBufferä¸ä¹‹ç›¸ç»‘å®šçš„sloté›†åˆ mFreeBuffers â€”\u003e BufferSlotçŠ¶æ€ä¸ºFREEï¼Œä¸”æœ‰GraphicBufferä¸ä¹‹ç›¸ç»‘å®šçš„sloté›†åˆ mActiveBuffers â€”\u003e BufferSlotçŠ¶æ€ä¸ä¸ºFREEï¼ˆå³DEQUEUEDã€QUEUEDã€ACQUIREDã€SHAREDï¼‰çš„sloté›†åˆã€‚æ—¢ç„¶çŠ¶æ€ä¸æ˜¯FREEï¼Œé‚£ä¹ˆè¯¥BufferSlotå¿…ç„¶æœ‰ä¸€ä¸ªGraphicBufferä¸ä¹‹ç›¸ç»‘å®š mUnusedSlots â€”\u003e æœªå‚ä¸ä½¿ç”¨çš„sloté›†åˆï¼Œç”± mMaxBufferCount å†³å®š æ³¨æ„mFreeSlotsï¼ŒmFreeBuffersï¼ŒmActiveBuffersï¼ŒmUnusedSlotséƒ½å…¶å®æ˜¯ä¸€ä¸ªinté›†åˆï¼Œå†…å®¹å°±æ˜¯mSlotsæ•°ç»„çš„ä¸€ä¸ªä¸ªindex è¯¦ç»†å‰–æä¸€ä¸‹mSlotsè¿™ä¸ªå˜é‡ï¼š namespace BufferQueueDefs { typedef BufferSlot SlotsType[NUM_BUFFER_SLOTS]; } // namespace BufferQueueDefs struct BufferSlot { BufferSlot() : mGraphicBuffer(nullptr), mEglDisplay(EGL_NO_DISPLAY), mBufferState(), mRequestBufferCalled(false), mFrameNumber(0), mEglFence(EGL_NO_SYNC_KHR), mFence(Fence::NO_FENCE), mAcquireCalled(false), mNeedsReallocation(false) { } } å¯ä»¥çœ‹åˆ°mSlot","date":"2024-11-06","objectID":"/posts/blastbufferqueue%E6%BA%90%E7%A0%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"BLASTBufferQueueæºç æ·±å…¥ç†è§£-CSDNåšå®¢","uri":"/posts/blastbufferqueue%E6%BA%90%E7%A0%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-csdn%E5%8D%9A%E5%AE%A2/#acquirenextbufferlocked"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"BufferQueueéƒ¨åˆ† ä¸‹é¢æ¥çœ‹çœ‹æ ¸å¿ƒçš„æ–¹æ³•createBufferQueue void BLASTBufferQueue::createBufferQueue(sp* outProducer, sp* outConsumer) { //åˆ›å»ºæ ¸å¿ƒçš„BufferQueueCore sp core(new BufferQueueCore()); //åŸºäºBufferQueueCoreåˆ›å»ºBBQBufferQueueProducer sp producer(new BBQBufferQueueProducer(core)); //åŸºäºBufferQueueCoreåˆ›å»ºBufferQueueConsumer sp consumer(new BufferQueueConsumer(core)); consumer-\u003esetAllowExtraAcquire(true); *outProducer = producer; *outConsumer = consumer; } ä¸‹é¢é‡ç‚¹çœ‹çœ‹BufferQueueCore BufferQueueCore::BufferQueueCore() : mMutex(),//è‹¥å¹²ä¸ªæˆå‘˜å˜é‡åˆå§‹åŒ– mIsAbandoned(false), mConsumerControlledByApp(false), mConsumerName(getUniqueName()), mConsumerListener(), mConsumerUsageBits(0), mConsumerIsProtected(false), mConnectedApi(NO_CONNECTED_API), mLinkedToDeath(), mConnectedProducerListener(), mBufferReleasedCbEnabled(false), mSlots(), mQueue(), mFreeSlots(), mFreeBuffers(), mUnusedSlots(), mActiveBuffers(), mDequeueCondition(), mDequeueBufferCannotBlock(false), mQueueBufferCanDrop(false), mLegacyBufferDrop(true), mDefaultBufferFormat(PIXEL_FORMAT_RGBA_8888), mDefaultWidth(1), mDefaultHeight(1), mDefaultBufferDataSpace(HAL_DATASPACE_UNKNOWN), mMaxBufferCount(BufferQueueDefs::NUM_BUFFER_SLOTS), mMaxAcquiredBufferCount(1), mMaxDequeuedBufferCount(1), mBufferHasBeenQueued(false), mFrameCounter(0), mTransformHint(0), mIsAllocating(false), mIsAllocatingCondition(), mAllowAllocation(true), mBufferAge(0), mGenerationNumber(0), mAsyncMode(false), mSharedBufferMode(false), mAutoRefresh(false), mSharedBufferSlot(INVALID_BUFFER_SLOT), mSharedBufferCache(Rect::INVALID_RECT, 0, NATIVE_WINDOW_SCALING_MODE_FREEZE, HAL_DATASPACE_UNKNOWN), mLastQueuedSlot(INVALID_BUFFER_SLOT), mUniqueId(getUniqueId()), mAutoPrerotation(false), mTransformHintInUse(0) { int numStartingBuffers = getMaxBufferCountLocked(); for (int s = 0; s \u003c numStartingBuffers; s++) { mFreeSlots.insert(s);//åˆå§‹åŒ–æ—¶å€™é’ˆå¯¹mFreeSlotså¡«å…¥äº†MaxBufferCountä¸ª } for (int s = numStartingBuffers; s \u003c BufferQueueDefs::NUM_BUFFER_SLOTS; s++) { mUnusedSlots.push_front(s);//é™¤äº†mFreeSlotséƒ¨åˆ†ï¼Œå…¶ä»–éƒ½æ˜¯å¡«å…¥mUnusedSlots } } ä¸Šé¢çš„æ„é€ ä¸­æœ‰ä»¥ä¸‹å‡ ä¸ªæˆå‘˜å˜é‡éå¸¸å…³é”®éœ€è¦é‡ç‚¹ä»‹ç» // mSlots is an array of buffer slots that must be mirrored on the producer // side. This allows buffer ownership to be transferred between the producer // and consumer without sending a GraphicBuffer over Binder. The entire // array is initialized to NULL at construction time, and buffers are // allocated for a slot when requestBuffer is called with that slot's index. BufferQueueDefs::SlotsType mSlots; // mQueue is a FIFO of queued buffers used in synchronous mode. Fifo mQueue; // mFreeSlots contains all of the slots which are FREE and do not currently // have a buffer attached. std::set mFreeSlots; // mFreeBuffers contains all of the slots which are FREE and currently have // a buffer attached. std::list mFreeBuffers; // mUnusedSlots contains all slots that are currently unused. They should be // free and not have a buffer attached. std::list mUnusedSlots; // mActiveBuffers contains all slots which have a non-FREE buffer attached. std::set mActiveBuffers; mQueue â€”\u003e å­˜æ”¾BufferItemçš„FIFOé˜Ÿåˆ— mSlots â€”\u003e BufferSlotç»“æ„ä½“æ•°ç»„ï¼Œæ•°ç»„é•¿åº¦å›ºå®šä¸º64 mFreeSlots â€”\u003e BufferSlotçŠ¶æ€ä¸ºFREEï¼Œä¸”æ²¡æœ‰GraphicBufferä¸ä¹‹ç›¸ç»‘å®šçš„sloté›†åˆ mFreeBuffers â€”\u003e BufferSlotçŠ¶æ€ä¸ºFREEï¼Œä¸”æœ‰GraphicBufferä¸ä¹‹ç›¸ç»‘å®šçš„sloté›†åˆ mActiveBuffers â€”\u003e BufferSlotçŠ¶æ€ä¸ä¸ºFREEï¼ˆå³DEQUEUEDã€QUEUEDã€ACQUIREDã€SHAREDï¼‰çš„sloté›†åˆã€‚æ—¢ç„¶çŠ¶æ€ä¸æ˜¯FREEï¼Œé‚£ä¹ˆè¯¥BufferSlotå¿…ç„¶æœ‰ä¸€ä¸ªGraphicBufferä¸ä¹‹ç›¸ç»‘å®š mUnusedSlots â€”\u003e æœªå‚ä¸ä½¿ç”¨çš„sloté›†åˆï¼Œç”± mMaxBufferCount å†³å®š æ³¨æ„mFreeSlotsï¼ŒmFreeBuffersï¼ŒmActiveBuffersï¼ŒmUnusedSlotséƒ½å…¶å®æ˜¯ä¸€ä¸ªinté›†åˆï¼Œå†…å®¹å°±æ˜¯mSlotsæ•°ç»„çš„ä¸€ä¸ªä¸ªindex è¯¦ç»†å‰–æä¸€ä¸‹mSlotsè¿™ä¸ªå˜é‡ï¼š namespace BufferQueueDefs { typedef BufferSlot SlotsType[NUM_BUFFER_SLOTS]; } // namespace BufferQueueDefs struct BufferSlot { BufferSlot() : mGraphicBuffer(nullptr), mEglDisplay(EGL_NO_DISPLAY), mBufferState(), mRequestBufferCalled(false), mFrameNumber(0), mEglFence(EGL_NO_SYNC_KHR), mFence(Fence::NO_FENCE), mAcquireCalled(false), mNeedsReallocation(false) { } } å¯ä»¥çœ‹åˆ°mSlot","date":"2024-11-06","objectID":"/posts/blastbufferqueue%E6%BA%90%E7%A0%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"BLASTBufferQueueæºç æ·±å…¥ç†è§£-CSDNåšå®¢","uri":"/posts/blastbufferqueue%E6%BA%90%E7%A0%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-csdn%E5%8D%9A%E5%AE%A2/#acquirebufferæ¶ˆè´¹è€…æ–¹æ³•"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"BufferQueueéƒ¨åˆ† ä¸‹é¢æ¥çœ‹çœ‹æ ¸å¿ƒçš„æ–¹æ³•createBufferQueue void BLASTBufferQueue::createBufferQueue(sp* outProducer, sp* outConsumer) { //åˆ›å»ºæ ¸å¿ƒçš„BufferQueueCore sp core(new BufferQueueCore()); //åŸºäºBufferQueueCoreåˆ›å»ºBBQBufferQueueProducer sp producer(new BBQBufferQueueProducer(core)); //åŸºäºBufferQueueCoreåˆ›å»ºBufferQueueConsumer sp consumer(new BufferQueueConsumer(core)); consumer-\u003esetAllowExtraAcquire(true); *outProducer = producer; *outConsumer = consumer; } ä¸‹é¢é‡ç‚¹çœ‹çœ‹BufferQueueCore BufferQueueCore::BufferQueueCore() : mMutex(),//è‹¥å¹²ä¸ªæˆå‘˜å˜é‡åˆå§‹åŒ– mIsAbandoned(false), mConsumerControlledByApp(false), mConsumerName(getUniqueName()), mConsumerListener(), mConsumerUsageBits(0), mConsumerIsProtected(false), mConnectedApi(NO_CONNECTED_API), mLinkedToDeath(), mConnectedProducerListener(), mBufferReleasedCbEnabled(false), mSlots(), mQueue(), mFreeSlots(), mFreeBuffers(), mUnusedSlots(), mActiveBuffers(), mDequeueCondition(), mDequeueBufferCannotBlock(false), mQueueBufferCanDrop(false), mLegacyBufferDrop(true), mDefaultBufferFormat(PIXEL_FORMAT_RGBA_8888), mDefaultWidth(1), mDefaultHeight(1), mDefaultBufferDataSpace(HAL_DATASPACE_UNKNOWN), mMaxBufferCount(BufferQueueDefs::NUM_BUFFER_SLOTS), mMaxAcquiredBufferCount(1), mMaxDequeuedBufferCount(1), mBufferHasBeenQueued(false), mFrameCounter(0), mTransformHint(0), mIsAllocating(false), mIsAllocatingCondition(), mAllowAllocation(true), mBufferAge(0), mGenerationNumber(0), mAsyncMode(false), mSharedBufferMode(false), mAutoRefresh(false), mSharedBufferSlot(INVALID_BUFFER_SLOT), mSharedBufferCache(Rect::INVALID_RECT, 0, NATIVE_WINDOW_SCALING_MODE_FREEZE, HAL_DATASPACE_UNKNOWN), mLastQueuedSlot(INVALID_BUFFER_SLOT), mUniqueId(getUniqueId()), mAutoPrerotation(false), mTransformHintInUse(0) { int numStartingBuffers = getMaxBufferCountLocked(); for (int s = 0; s \u003c numStartingBuffers; s++) { mFreeSlots.insert(s);//åˆå§‹åŒ–æ—¶å€™é’ˆå¯¹mFreeSlotså¡«å…¥äº†MaxBufferCountä¸ª } for (int s = numStartingBuffers; s \u003c BufferQueueDefs::NUM_BUFFER_SLOTS; s++) { mUnusedSlots.push_front(s);//é™¤äº†mFreeSlotséƒ¨åˆ†ï¼Œå…¶ä»–éƒ½æ˜¯å¡«å…¥mUnusedSlots } } ä¸Šé¢çš„æ„é€ ä¸­æœ‰ä»¥ä¸‹å‡ ä¸ªæˆå‘˜å˜é‡éå¸¸å…³é”®éœ€è¦é‡ç‚¹ä»‹ç» // mSlots is an array of buffer slots that must be mirrored on the producer // side. This allows buffer ownership to be transferred between the producer // and consumer without sending a GraphicBuffer over Binder. The entire // array is initialized to NULL at construction time, and buffers are // allocated for a slot when requestBuffer is called with that slot's index. BufferQueueDefs::SlotsType mSlots; // mQueue is a FIFO of queued buffers used in synchronous mode. Fifo mQueue; // mFreeSlots contains all of the slots which are FREE and do not currently // have a buffer attached. std::set mFreeSlots; // mFreeBuffers contains all of the slots which are FREE and currently have // a buffer attached. std::list mFreeBuffers; // mUnusedSlots contains all slots that are currently unused. They should be // free and not have a buffer attached. std::list mUnusedSlots; // mActiveBuffers contains all slots which have a non-FREE buffer attached. std::set mActiveBuffers; mQueue â€”\u003e å­˜æ”¾BufferItemçš„FIFOé˜Ÿåˆ— mSlots â€”\u003e BufferSlotç»“æ„ä½“æ•°ç»„ï¼Œæ•°ç»„é•¿åº¦å›ºå®šä¸º64 mFreeSlots â€”\u003e BufferSlotçŠ¶æ€ä¸ºFREEï¼Œä¸”æ²¡æœ‰GraphicBufferä¸ä¹‹ç›¸ç»‘å®šçš„sloté›†åˆ mFreeBuffers â€”\u003e BufferSlotçŠ¶æ€ä¸ºFREEï¼Œä¸”æœ‰GraphicBufferä¸ä¹‹ç›¸ç»‘å®šçš„sloté›†åˆ mActiveBuffers â€”\u003e BufferSlotçŠ¶æ€ä¸ä¸ºFREEï¼ˆå³DEQUEUEDã€QUEUEDã€ACQUIREDã€SHAREDï¼‰çš„sloté›†åˆã€‚æ—¢ç„¶çŠ¶æ€ä¸æ˜¯FREEï¼Œé‚£ä¹ˆè¯¥BufferSlotå¿…ç„¶æœ‰ä¸€ä¸ªGraphicBufferä¸ä¹‹ç›¸ç»‘å®š mUnusedSlots â€”\u003e æœªå‚ä¸ä½¿ç”¨çš„sloté›†åˆï¼Œç”± mMaxBufferCount å†³å®š æ³¨æ„mFreeSlotsï¼ŒmFreeBuffersï¼ŒmActiveBuffersï¼ŒmUnusedSlotséƒ½å…¶å®æ˜¯ä¸€ä¸ªinté›†åˆï¼Œå†…å®¹å°±æ˜¯mSlotsæ•°ç»„çš„ä¸€ä¸ªä¸ªindex è¯¦ç»†å‰–æä¸€ä¸‹mSlotsè¿™ä¸ªå˜é‡ï¼š namespace BufferQueueDefs { typedef BufferSlot SlotsType[NUM_BUFFER_SLOTS]; } // namespace BufferQueueDefs struct BufferSlot { BufferSlot() : mGraphicBuffer(nullptr), mEglDisplay(EGL_NO_DISPLAY), mBufferState(), mRequestBufferCalled(false), mFrameNumber(0), mEglFence(EGL_NO_SYNC_KHR), mFence(Fence::NO_FENCE), mAcquireCalled(false), mNeedsReallocation(false) { } } å¯ä»¥çœ‹åˆ°mSlot","date":"2024-11-06","objectID":"/posts/blastbufferqueue%E6%BA%90%E7%A0%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"BLASTBufferQueueæºç æ·±å…¥ç†è§£-CSDNåšå®¢","uri":"/posts/blastbufferqueue%E6%BA%90%E7%A0%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-csdn%E5%8D%9A%E5%AE%A2/#releasebufferæ¶ˆè´¹è€…æ–¹æ³•"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"sfå¦‚ä½•è§¦å‘çš„releaseå‘¢ï¼Ÿ è§¦å‘æµç¨‹å¦‚ä¸‹ï¼š sfç«¯æ˜¯åœ¨çº¿ç¨‹ä¸­å‘èµ·çš„è§¦å‘è·¨è¿›ç¨‹onTransactionCompletedè°ƒç”¨ è¿™é‡Œsfå­çº¿ç¨‹è·¨è¿›ç¨‹è°ƒç”¨æ˜¯ç”±ä¸»çº¿ç¨‹sendCallbacksæ–¹æ³•è§¦å‘çš„ sendCallbacksæ–¹æ³• void TransactionCallbackInvoker::sendCallbacks(bool onCommitOnly) { ATRACE_CALL(); // For each listener //è·å–å…¨å±€çš„mCompletedTransactionså˜é‡å†è¿›è¡Œéå† auto completedTransactionsItr = mCompletedTransactions.begin(); BackgroundExecutor::Callbacks callbacks; while (completedTransactionsItr != mCompletedTransactions.end()) { //çœç•¥éƒ¨åˆ† // If the listener has completed transactions if (!listenerStats.transactionStats.empty()) { // If the listener is still alive if (listener-\u003eisBinderAlive()) { //å¡å…¥callbacksé›†åˆ callbacks.emplace_back([stats = std::move(listenerStats)]() { ATRACE_NAME(\"ITransactionCompletedListener onTransactionCompleted\"); interface_cast\u003cITransactionCompletedListener\u003e(stats.listener) -\u003eonTransactionCompleted(stats); }); } } completedTransactionsItr++; } BackgroundExecutor::getInstance().sendCallbacks(std::move(callbacks)); } é‡ç‚¹çœ‹çœ‹mCompletedTransactionsè¿™ä¸ªé›†åˆçš„å“ªæ¥çš„ï¼Œé€šè¿‡æŸ¥è¯¢ä¸»è¦æ˜¯findOrCreateTransactionStatsæ–¹æ³•è¿›è¡ŒåŠ å…¥ç›¸å…³çš„å…ƒç´ ï¼Œè¿½è¸ªåå‘ç°å®é™…ä¸Šè¿™é‡Œä¸»è¦æ˜¯çœ‹addCallbackHandlesæ–¹æ³•ä¼šå¡«å…¥å¯¹åº”ï¼Œæœ€ç»ˆå‘ç°æ˜¯åœ¨releasePendingBufferæ–¹æ³•ä¸­å¡å…¥ï¼š void BufferStateLayer::releasePendingBuffer(nsecs_t dequeueReadyTime) { for (const auto\u0026 handle : mDrawingState.callbackHandles) { handle-\u003etransformHint = mTransformHint; handle-\u003edequeueReadyTime = dequeueReadyTime; handle-\u003ecurrentMaxAcquiredBufferCount = mFlinger-\u003egetMaxAcquiredBufferCountForCurrentRefreshRate(mOwnerUid); } //æ³¨æ„è¿™é‡Œæ˜¯æŠŠmPreviousReleaseCallbackIdå˜é‡èµ‹å€¼ç»™ handle-\u003epreviousReleaseCallbackId for (auto\u0026 handle : mDrawingState.callbackHandles) { if (handle-\u003ereleasePreviousBuffer \u0026\u0026 mDrawingState.releaseBufferEndpoint == handle-\u003elistener) { handle-\u003epreviousReleaseCallbackId = mPreviousReleaseCallbackId; break; } } //è°ƒç”¨addCallbackHandles mFlinger-\u003egetTransactionCallbackInvoker().addCallbackHandles( mDrawingState.callbackHandles, jankData); } è¿™é‡Œçš„mPreviousReleaseCallbackIdæ˜¯å“ªé‡Œæ¥çš„å‘¢ï¼Ÿé‚£ä¹ˆå°±éœ€è¦çœ‹updateActiveBuffer updateActiveBuffer updateActiveBufferæ–¹æ³•ä¼šå¯¹mPreviousReleaseCallbackIdè¿™ä¸ªå˜é‡è¿›è¡Œèµ‹å€¼ï¼Œå¤§å®¶æ³¨æ„è¿™é‡Œçš„ä¸ºå•¥å«åšå‰ä¸€å¸§çš„CallbackIdï¼Œå› ä¸ºä¸‹é¢è¿™ä¸ªupdateActiveBufferå°±æ˜¯èµ‹å€¼æ˜¯å…ˆè¿›è¡Œçš„mPreviousReleaseCallbackIdèµ‹å€¼ï¼Œç„¶åæ‰è¿›è¡Œçš„æ–°bufferçš„èµ‹å€¼ï¼Œæ‰€ä»¥è¿™ä¸ªmPreviousReleaseCallbackIdå…¶å®ä¸Šä¸€ä¸ªçš„bufferçš„Idï¼Œä¸æ˜¯å½“å‰è¿™æ¬¡çš„ ç»¼ä¸Šæ—¢å¯ä»¥è§£é‡ŠreleaseBufferæ˜¯åœ¨ä¸‹ä¸€å¸§ä¸Šå¸§åæ‰ç”±sfè°ƒç”¨åˆ°appå±‚é¢è®©å…¶releaseBufferã€‚ ","date":"2024-11-06","objectID":"/posts/blastbufferqueue%E6%BA%90%E7%A0%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-csdn%E5%8D%9A%E5%AE%A2/:1:2","tags":["clippings","è½¬è½½","blog"],"title":"BLASTBufferQueueæºç æ·±å…¥ç†è§£-CSDNåšå®¢","uri":"/posts/blastbufferqueue%E6%BA%90%E7%A0%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-csdn%E5%8D%9A%E5%AE%A2/#sfå¦‚ä½•è§¦å‘çš„releaseå‘¢"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"sfå¦‚ä½•è§¦å‘çš„releaseå‘¢ï¼Ÿ è§¦å‘æµç¨‹å¦‚ä¸‹ï¼š sfç«¯æ˜¯åœ¨çº¿ç¨‹ä¸­å‘èµ·çš„è§¦å‘è·¨è¿›ç¨‹onTransactionCompletedè°ƒç”¨ è¿™é‡Œsfå­çº¿ç¨‹è·¨è¿›ç¨‹è°ƒç”¨æ˜¯ç”±ä¸»çº¿ç¨‹sendCallbacksæ–¹æ³•è§¦å‘çš„ sendCallbacksæ–¹æ³• void TransactionCallbackInvoker::sendCallbacks(bool onCommitOnly) { ATRACE_CALL(); // For each listener //è·å–å…¨å±€çš„mCompletedTransactionså˜é‡å†è¿›è¡Œéå† auto completedTransactionsItr = mCompletedTransactions.begin(); BackgroundExecutor::Callbacks callbacks; while (completedTransactionsItr != mCompletedTransactions.end()) { //çœç•¥éƒ¨åˆ† // If the listener has completed transactions if (!listenerStats.transactionStats.empty()) { // If the listener is still alive if (listener-\u003eisBinderAlive()) { //å¡å…¥callbacksé›†åˆ callbacks.emplace_back([stats = std::move(listenerStats)]() { ATRACE_NAME(\"ITransactionCompletedListener onTransactionCompleted\"); interface_cast(stats.listener) -\u003eonTransactionCompleted(stats); }); } } completedTransactionsItr++; } BackgroundExecutor::getInstance().sendCallbacks(std::move(callbacks)); } é‡ç‚¹çœ‹çœ‹mCompletedTransactionsè¿™ä¸ªé›†åˆçš„å“ªæ¥çš„ï¼Œé€šè¿‡æŸ¥è¯¢ä¸»è¦æ˜¯findOrCreateTransactionStatsæ–¹æ³•è¿›è¡ŒåŠ å…¥ç›¸å…³çš„å…ƒç´ ï¼Œè¿½è¸ªåå‘ç°å®é™…ä¸Šè¿™é‡Œä¸»è¦æ˜¯çœ‹addCallbackHandlesæ–¹æ³•ä¼šå¡«å…¥å¯¹åº”ï¼Œæœ€ç»ˆå‘ç°æ˜¯åœ¨releasePendingBufferæ–¹æ³•ä¸­å¡å…¥ï¼š void BufferStateLayer::releasePendingBuffer(nsecs_t dequeueReadyTime) { for (const auto\u0026 handle : mDrawingState.callbackHandles) { handle-\u003etransformHint = mTransformHint; handle-\u003edequeueReadyTime = dequeueReadyTime; handle-\u003ecurrentMaxAcquiredBufferCount = mFlinger-\u003egetMaxAcquiredBufferCountForCurrentRefreshRate(mOwnerUid); } //æ³¨æ„è¿™é‡Œæ˜¯æŠŠmPreviousReleaseCallbackIdå˜é‡èµ‹å€¼ç»™ handle-\u003epreviousReleaseCallbackId for (auto\u0026 handle : mDrawingState.callbackHandles) { if (handle-\u003ereleasePreviousBuffer \u0026\u0026 mDrawingState.releaseBufferEndpoint == handle-\u003elistener) { handle-\u003epreviousReleaseCallbackId = mPreviousReleaseCallbackId; break; } } //è°ƒç”¨addCallbackHandles mFlinger-\u003egetTransactionCallbackInvoker().addCallbackHandles( mDrawingState.callbackHandles, jankData); } è¿™é‡Œçš„mPreviousReleaseCallbackIdæ˜¯å“ªé‡Œæ¥çš„å‘¢ï¼Ÿé‚£ä¹ˆå°±éœ€è¦çœ‹updateActiveBuffer updateActiveBuffer updateActiveBufferæ–¹æ³•ä¼šå¯¹mPreviousReleaseCallbackIdè¿™ä¸ªå˜é‡è¿›è¡Œèµ‹å€¼ï¼Œå¤§å®¶æ³¨æ„è¿™é‡Œçš„ä¸ºå•¥å«åšå‰ä¸€å¸§çš„CallbackIdï¼Œå› ä¸ºä¸‹é¢è¿™ä¸ªupdateActiveBufferå°±æ˜¯èµ‹å€¼æ˜¯å…ˆè¿›è¡Œçš„mPreviousReleaseCallbackIdèµ‹å€¼ï¼Œç„¶åæ‰è¿›è¡Œçš„æ–°bufferçš„èµ‹å€¼ï¼Œæ‰€ä»¥è¿™ä¸ªmPreviousReleaseCallbackIdå…¶å®ä¸Šä¸€ä¸ªçš„bufferçš„Idï¼Œä¸æ˜¯å½“å‰è¿™æ¬¡çš„ ç»¼ä¸Šæ—¢å¯ä»¥è§£é‡ŠreleaseBufferæ˜¯åœ¨ä¸‹ä¸€å¸§ä¸Šå¸§åæ‰ç”±sfè°ƒç”¨åˆ°appå±‚é¢è®©å…¶releaseBufferã€‚ ","date":"2024-11-06","objectID":"/posts/blastbufferqueue%E6%BA%90%E7%A0%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-csdn%E5%8D%9A%E5%AE%A2/:1:2","tags":["clippings","è½¬è½½","blog"],"title":"BLASTBufferQueueæºç æ·±å…¥ç†è§£-CSDNåšå®¢","uri":"/posts/blastbufferqueue%E6%BA%90%E7%A0%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-csdn%E5%8D%9A%E5%AE%A2/#sendcallbacksæ–¹æ³•"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"sfå¦‚ä½•è§¦å‘çš„releaseå‘¢ï¼Ÿ è§¦å‘æµç¨‹å¦‚ä¸‹ï¼š sfç«¯æ˜¯åœ¨çº¿ç¨‹ä¸­å‘èµ·çš„è§¦å‘è·¨è¿›ç¨‹onTransactionCompletedè°ƒç”¨ è¿™é‡Œsfå­çº¿ç¨‹è·¨è¿›ç¨‹è°ƒç”¨æ˜¯ç”±ä¸»çº¿ç¨‹sendCallbacksæ–¹æ³•è§¦å‘çš„ sendCallbacksæ–¹æ³• void TransactionCallbackInvoker::sendCallbacks(bool onCommitOnly) { ATRACE_CALL(); // For each listener //è·å–å…¨å±€çš„mCompletedTransactionså˜é‡å†è¿›è¡Œéå† auto completedTransactionsItr = mCompletedTransactions.begin(); BackgroundExecutor::Callbacks callbacks; while (completedTransactionsItr != mCompletedTransactions.end()) { //çœç•¥éƒ¨åˆ† // If the listener has completed transactions if (!listenerStats.transactionStats.empty()) { // If the listener is still alive if (listener-\u003eisBinderAlive()) { //å¡å…¥callbacksé›†åˆ callbacks.emplace_back([stats = std::move(listenerStats)]() { ATRACE_NAME(\"ITransactionCompletedListener onTransactionCompleted\"); interface_cast(stats.listener) -\u003eonTransactionCompleted(stats); }); } } completedTransactionsItr++; } BackgroundExecutor::getInstance().sendCallbacks(std::move(callbacks)); } é‡ç‚¹çœ‹çœ‹mCompletedTransactionsè¿™ä¸ªé›†åˆçš„å“ªæ¥çš„ï¼Œé€šè¿‡æŸ¥è¯¢ä¸»è¦æ˜¯findOrCreateTransactionStatsæ–¹æ³•è¿›è¡ŒåŠ å…¥ç›¸å…³çš„å…ƒç´ ï¼Œè¿½è¸ªåå‘ç°å®é™…ä¸Šè¿™é‡Œä¸»è¦æ˜¯çœ‹addCallbackHandlesæ–¹æ³•ä¼šå¡«å…¥å¯¹åº”ï¼Œæœ€ç»ˆå‘ç°æ˜¯åœ¨releasePendingBufferæ–¹æ³•ä¸­å¡å…¥ï¼š void BufferStateLayer::releasePendingBuffer(nsecs_t dequeueReadyTime) { for (const auto\u0026 handle : mDrawingState.callbackHandles) { handle-\u003etransformHint = mTransformHint; handle-\u003edequeueReadyTime = dequeueReadyTime; handle-\u003ecurrentMaxAcquiredBufferCount = mFlinger-\u003egetMaxAcquiredBufferCountForCurrentRefreshRate(mOwnerUid); } //æ³¨æ„è¿™é‡Œæ˜¯æŠŠmPreviousReleaseCallbackIdå˜é‡èµ‹å€¼ç»™ handle-\u003epreviousReleaseCallbackId for (auto\u0026 handle : mDrawingState.callbackHandles) { if (handle-\u003ereleasePreviousBuffer \u0026\u0026 mDrawingState.releaseBufferEndpoint == handle-\u003elistener) { handle-\u003epreviousReleaseCallbackId = mPreviousReleaseCallbackId; break; } } //è°ƒç”¨addCallbackHandles mFlinger-\u003egetTransactionCallbackInvoker().addCallbackHandles( mDrawingState.callbackHandles, jankData); } è¿™é‡Œçš„mPreviousReleaseCallbackIdæ˜¯å“ªé‡Œæ¥çš„å‘¢ï¼Ÿé‚£ä¹ˆå°±éœ€è¦çœ‹updateActiveBuffer updateActiveBuffer updateActiveBufferæ–¹æ³•ä¼šå¯¹mPreviousReleaseCallbackIdè¿™ä¸ªå˜é‡è¿›è¡Œèµ‹å€¼ï¼Œå¤§å®¶æ³¨æ„è¿™é‡Œçš„ä¸ºå•¥å«åšå‰ä¸€å¸§çš„CallbackIdï¼Œå› ä¸ºä¸‹é¢è¿™ä¸ªupdateActiveBufferå°±æ˜¯èµ‹å€¼æ˜¯å…ˆè¿›è¡Œçš„mPreviousReleaseCallbackIdèµ‹å€¼ï¼Œç„¶åæ‰è¿›è¡Œçš„æ–°bufferçš„èµ‹å€¼ï¼Œæ‰€ä»¥è¿™ä¸ªmPreviousReleaseCallbackIdå…¶å®ä¸Šä¸€ä¸ªçš„bufferçš„Idï¼Œä¸æ˜¯å½“å‰è¿™æ¬¡çš„ ç»¼ä¸Šæ—¢å¯ä»¥è§£é‡ŠreleaseBufferæ˜¯åœ¨ä¸‹ä¸€å¸§ä¸Šå¸§åæ‰ç”±sfè°ƒç”¨åˆ°appå±‚é¢è®©å…¶releaseBufferã€‚ ","date":"2024-11-06","objectID":"/posts/blastbufferqueue%E6%BA%90%E7%A0%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-csdn%E5%8D%9A%E5%AE%A2/:1:2","tags":["clippings","è½¬è½½","blog"],"title":"BLASTBufferQueueæºç æ·±å…¥ç†è§£-CSDNåšå®¢","uri":"/posts/blastbufferqueue%E6%BA%90%E7%A0%81%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-csdn%E5%8D%9A%E5%AE%A2/#updateactivebuffer"},{"categories":null,"collections":"PMS","content":"å‰è¨€ ä½œä¸ºæœ¬ç³»åˆ—æ–‡ç« çš„é¦–ç¯‡æ–‡ç« ï¼Œåœ¨å¼€å§‹ä¹‹å‰æˆ‘ä¸€ç›´åœ¨æ€è€ƒï¼Œé¦–ç¯‡æ–‡ç« åº”è¯¥å†™å•¥å†…å®¹ï¼Ÿæ‰èƒ½è®©è¯»è€…å¾ˆå®¹æ˜“æ˜ç™½PackageManagerServiceæ˜¯å•¥å‘¢ï¼Œå¦‚ä½•ä¸ºåé¢æ–‡ç« èµ·åˆ°æ‰¿ä¸Šå¯ä¸‹çš„ä½œç”¨å‘¢ã€‚ åæ¥æˆ‘å†³å®šä»¥ä»‹ç»PackageManagerServiceæœåŠ¡ä¸­çš„å„ç§ç¹å¤šå¤æ‚çš„æ•°æ®ç±»ä¸ºå¼€ç¯‡ï¼Œç†ç”±æ˜¯æ•°æ®ç±»æ˜¯åŸºç¡€ï¼Œæ•…æ•°æ®ç±»å…ˆè¡Œã€‚é‚å¼€å§‹ä¸€é¡¿çŒ›çš„è¾“å‡ºï¼Œå½“å³å°†æ¥è¿‘å°¾å£°çš„æ—¶å€™ï¼Œæˆ‘å‘ç°ä¸å¯¹å•Šï¼Œå‡å¦‚æˆ‘æ˜¯ä¸€ä¸ªå¯¹PackageManagerServiceå®Œå…¨æ²¡æ¥è§¦çš„äººï¼Œåˆšä¸€ä¸Šæ¥å°±çœ‹åˆ°è¿™ä¹ˆå¤šéå¸¸é™Œç”Ÿçš„æ•°æ®ç±»ï¼Œé‚£å®Œå…¨å°±æ˜¯ä¸€ç§æ‡µé€¼çš„æ„Ÿè§‰å•Šã€‚ äºæ˜¯æˆ‘å†³å®šé‡æ–°è§„åˆ’ï¼Œä»¥ä»‹ç»PackageManagerServiceåŠå®ƒåŒ…å«çš„æ¨¡å—ä¸ºé¦–ç¯‡ï¼Œè¿™æ ·å³ä½¿å¯¹PackageManagerServiceé™Œç”Ÿçš„äººï¼Œä¹Ÿèƒ½å…ˆå¯¹å®ƒæœ‰ä¸€ä¸ªåˆæ­¥çš„è®¤è¯†ã€‚åŒæ—¶åé¢çš„æ–‡ç« ä¸­ä¼šé€æ­¥æ·±å…¥çš„ä»‹ç»PackageManagerServiceçš„å†…å®¹ã€‚ æœ¬æ–‡æ‘˜è¦ è¿™é‡Œçš„åŒ…ç®¡ç†æŒ‡çš„æ˜¯PackageManagerServiceè¿™ä¸ªæœåŠ¡ï¼Œæœ¬ç¯‡æ˜¯åŒ…ç®¡ç†ç³»åˆ—æ–‡ç« çš„ç¬¬ä¸€ç¯‡ï¼Œæ—¢ç„¶æ•´ä¸ªç³»åˆ—æ–‡ç« éƒ½åœ¨ä»‹ç»PackageManagerServiceï¼Œé‚£æœ¬ç¯‡å°±å¸¦å¤§å®¶å…ˆè®¤è¯†ä¸€ä¸‹PackageManagerServiceï¼Œé€šè¿‡æœ¬æ–‡æ‚¨å°†äº†è§£PackageManagerServiceæ˜¯å•¥ï¼Œå®ƒè¢«åˆ’åˆ†ä¸ºå“ªäº›ä¸»è¦æ¨¡å—ï¼Œè¿™äº›æ¨¡å—ä¹‹é—´åˆæœ‰å•¥å…³ç³»ã€‚(æ–‡ä¸­ä»£ç åŸºäºAndroid13) 1 æˆ‘æ˜¯ä¸€ä¸ªæœåŠ¡ å¤§å®¶å¥½ï¼Œæˆ‘çš„åå­—å«PackageManagerServiceï¼Œå¦‚æœè§‰å¾—è¿™åå­—å¤ªé•¿å¤§å®¶å¯ä»¥å«æˆ‘çš„å°åPMSï¼Œæˆ‘è¿è¡Œäºsystemserverè¿›ç¨‹ï¼Œsystemserverè¿›ç¨‹ä¸­æœ‰å¾ˆå¤šå¾ˆå¤šçš„æœåŠ¡ï¼Œæ¯”å¦‚å¤§å®¶ç†ŸçŸ¥çš„ActivityManagerServiceã€WindowManagerServiceã€‚è€Œæˆ‘ä¹Ÿæ˜¯ä¸€ä¸ªæœåŠ¡ï¼Œä¸€ä¸ªéå¸¸éå¸¸é‡è¦çš„æœåŠ¡ã€‚ ä¸Šé¢å¤šæ¬¡æåˆ°ä¸€ä¸ªè¯æœåŠ¡ï¼Œé‚£å®ƒåˆ°åº•æ„å‘³ç€å•¥å‘¢ï¼Ÿé‚£æˆ‘å°±æ¥ç»™å¤§å®¶è§£é‡Šä¸‹ï¼Œåœ¨Androidä¸­è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ç”¨çš„æœ€å¤šçš„æ˜¯é¼é¼å¤§åçš„binderï¼Œè€Œbinderæ˜¯client/serveræ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯binderåˆ†ä¸ºclientç«¯å’Œserverç«¯ï¼Œserverç«¯å¯ä»¥æä¾›å„ç§æœåŠ¡ä¾›å¤šä¸ªclientç«¯ä½¿ç”¨ã€‚å› æ­¤æœåŠ¡è¿™ä¸ªè¯å°±æ˜¯æŒ‡binderçš„serverç«¯ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘PMSæä¾›äº†åŒ…ç®¡ç†ç›¸å…³çš„åŠŸèƒ½ï¼Œå…¶ä»–è¿›ç¨‹å¦‚æœè¦æƒ³ä½¿ç”¨çš„è¯å¯ä»¥é€šè¿‡binderé€šä¿¡æ¥â€œå‘¼æˆ‘â€ã€‚ æ—¢ç„¶æåˆ°äº†åŒ…ç®¡ç†ï¼Œå…¶ä¸­åŒ…æŒ‡çš„å°±æ˜¯ä¸€ä¸ªapkï¼Œé‚£åŒ…ç®¡ç†ä¹Ÿå¯ä»¥ç†è§£ä¸ºå¯¹apkçš„ç®¡ç†ï¼Œé‚£PMSå¯¹apkä¸»è¦è¿›è¡Œä»¥ä¸‹å‡ é¡¹ç®¡ç†ï¼š apkçš„å®‰è£…/æ›´æ–°/å¸è½½ï¼šè¿™ä¸‰ä»¶äº‹æƒ…æˆ‘å…¨æƒäº¤ç»™PackageInstallerServiceï¼Œå…³äºapkå®‰è£…å¯ä»¥æŸ¥çœ‹apkå®‰è£…è¿™ç¯‡æ–‡ç« ã€‚ apkä¿¡æ¯æŸ¥è¯¢ï¼Œå•¥æ˜¯apkä¿¡æ¯æŸ¥è¯¢å‘¢ï¼Ÿæ¯”å¦‚æƒ³è¦çŸ¥é“å½“å‰Androidè®¾å¤‡éƒ½å®‰è£…äº†å“ªäº›apkï¼Œå¯ä»¥æ¥æˆ‘è¿™å–ï¼›å†æ¯”å¦‚æƒ³è¦çŸ¥é“æŸä¸ªapkéƒ½åŒ…å«äº†å“ªäº›å››å¤§ç»„ä»¶ï¼Œä¹Ÿå¯ä»¥æ¥æˆ‘è¿™å–ã€‚ apkæƒé™ç®¡ç†ï¼ŒåŸºæœ¬æ¯ä¸ªè¢«å®‰è£…çš„apkéƒ½æ˜¯éœ€è¦ç”³è¯·ä¸€äº›æƒé™çš„ï¼Œé‚£è¿™äº›æƒé™æ˜¯è¢«ç”¨æˆ·æˆæƒäº†å‘¢ï¼Œè¿˜æ˜¯è¢«ç”¨æˆ·æ‹’ç»äº†å‘¢ï¼Œéƒ½å¯ä»¥æ¥æ‰¾æˆ‘ã€‚æˆ‘æŠŠè¿™ä¸ªäº‹æƒ…äº¤ç»™PermissionManagerServiceæ¥ç®¡ç†ã€‚ å¯åˆ«å°çœ‹äº†æˆ‘ï¼Œæˆ‘å¯ä¸æ˜¯åªè´Ÿè´£ä¸Šé¢çš„è¿™äº›äº‹æƒ…ï¼Œåªä¸è¿‡ä¸Šé¢è¿™äº›äº‹æƒ…ç»å¸¸ç”¨åˆ°ï¼Œæ•…åªç½—åˆ—äº†å®ƒä»¬è€Œå·²ã€‚ã€‚æˆ‘å°±æ˜¯ä¸€ä¸ªè¿è¡Œäºsystemserverè¿›ç¨‹å¯¹apkè¿›è¡Œç®¡ç†çš„éå¸¸é‡è¦çš„æœåŠ¡ã€‚ ä»‹ç»å®Œæˆ‘è‡ªå·±ï¼Œæˆ‘è§‰å¾—éå¸¸æœ‰å¿…è¦ä»‹ç»ä¸€ä¸‹æˆ‘ç®¡ç†çš„å¯¹è±¡apkï¼Œä½ ä»¬äººç±»æœ‰å¥è¯æ˜¯è¿™æ ·è¯´çš„ï¼šå¯¹è‡ªå·±çš„ç®¡ç†å¯¹è±¡æ²¡æœ‰æ·±å…¥äº†è§£çš„é¢†å¯¼ä¸æ˜¯ä¸€ä¸ªå¥½é¢†å¯¼ã€‚å¹¶ä¸”å¯¹apkæœ‰ä¸€ä¸ªæ·±å…¥äº†è§£åï¼Œå†æ¥ç†è§£æˆ‘å°±æ›´å®¹æ˜“äº†ã€‚(å¯¹apkç†Ÿæ‚‰çš„è¯è¯¥éƒ¨åˆ†å¯ä»¥è·³è¿‡) 1 æˆ‘ç®¡ç†çš„å¯¹è±¡ æˆ‘ç®¡ç†çš„å¯¹è±¡apkï¼Œæ˜¯ Android Package çš„ç¼©å†™ï¼Œå®ƒå…¶å®æ˜¯ä¸€ä¸ªzipæ ¼å¼çš„å‹ç¼©æ–‡ä»¶ï¼Œåªä¸è¿‡ä¸ºäº†èƒ½è®©å¤§å®¶ä»æ–‡ä»¶åä¸Šä¸€çœ¼è®¤å‡ºæ¥ï¼Œæ•…æ–‡ä»¶åç¼€æ˜¯ .apkã€‚ è´´å¿ƒçš„æˆ‘ä¸ºäº†è®©å¤§å®¶æ›´å®¹æ˜“äº†è§£apkï¼Œæ•…ç”»äº†ä¸€å¹…å›¾ï¼Œä¸‹å›¾å±•ç¤ºäº†apkå†…åŒ…å«çš„ä¸»è¦æ–‡ä»¶å’Œç›®å½•ã€‚ å›¾è§£ libç›®å½• è¯¥ç›®å½•ä¸‹é¢åŒ…å«äº†ä½¿ç”¨åˆ°çš„soåº“ã€‚ resã€assetsç›®å½• è¿™ä¸¤ä¸ªç›®å½•ä¸‹é¢åŒ…å«äº†å„ç§èµ„æºæ¯”å¦‚å›¾ç‰‡ã€layoutæ–‡ä»¶ç­‰ã€‚ META-INF è¯¥ç›®å½•ä¸‹é¢åŒ…å«äº†å’Œç­¾åè¯ä¹¦æœ‰å…³çš„æ–‡ä»¶ã€‚ dex java/kotlinç¼–è¯‘åçš„å­—èŠ‚ç æ–‡ä»¶ã€‚ resources.arsc æ–‡ä»¶å¯ä»¥è§†ä¸ºä¸€ä¸ªèµ„æºè¡¨ï¼Œå®ƒå­˜å‚¨äº†æ‰€æœ‰èµ„æºçš„IDå’Œè¿™äº›èµ„æºåœ¨APKæ–‡ä»¶æˆ–å…¶ä»–ä½ç½®ä¸­çš„å¼•ç”¨ã€‚ AndroidManifest.xmléœ€è¦ç€é‡ä»‹ç»ä¸‹ï¼Œå› ä¸ºå®ƒå¯¹äºæˆ‘PMSæ¥è¯´éå¸¸é‡è¦ã€‚ ","date":"2024-11-06","objectID":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"PackageManagerServiceå’Œå®ƒçš„6ä¸ªâ€œå°ä¼™ä¼´â€","uri":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/#"},{"categories":null,"collections":"PMS","content":"2.1 AndroidManifest.xml å¯ä»¥åœ¨AndroidManifest.xmlæ–‡ä»¶ä¸­ä½¿ç”¨activityã€providerã€serviceã€receiveræ ‡ç­¾æ¥å£°æ˜å››å¤§ç»„ä»¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨uses-permissionæ ‡ç­¾æ¥ç”³è¯·ä½¿ç”¨å“ªäº›æƒé™ï¼Œå½“ç„¶è¿˜æœ‰å…¶ä»–çš„æ ‡ç­¾ã€‚ é‚£AndroidManifest.xmlå’Œä½¿ç”¨æ ‡ç­¾å£°æ˜æˆ–è€…ç”³è¯·çš„è¿™äº›ä¿¡æ¯åˆ°åº•æ˜¯ç»™è°ç”¨çš„å‘¢ï¼Ÿ ç­”æ¡ˆæ˜¯PMSï¼ŒAndroidManifest.xmlå°±åƒé¥­é¦†çš„èœå•ï¼Œä»èœå•ä¸Šå¯ä»¥çœ‹å‡ºè¿™ä¸ªé¥­é¦†åˆ°åº•æœ‰å“ªäº›é¥­ã€èœï¼Œèœå•æ˜¯ç»™é¡¾å®¢ä½¿ç”¨çš„ã€‚è€ŒAndroidManifest.xmlæ˜¯ç»™PMSä½¿ç”¨çš„ï¼ŒPMSåªæœ‰é€šè¿‡AndroidManifest.xmlæ‰èƒ½çŸ¥é“ä¸€ä¸ªapkå†…åˆ°åº•å£°æ˜äº†å“ªäº›å››å¤§ç»„ä»¶ã€ç”³è¯·äº†å“ªäº›æƒé™ã€ä½¿ç”¨äº†å“ªäº›å…±äº«åº“ç­‰ç­‰ï¼Œå› æ­¤å¯¹äºPMSå¯ä»¥é€šè¿‡è§£æAndroidManifest.xmlå†…çš„å„ç§æ ‡ç­¾æ¥è·å–apkå†…å£°æ˜çš„å„ç§ä¿¡æ¯ã€‚ ä¸‹å›¾å±•ç¤ºäº†AndroidManifest.xmlä¸­å¸¸ç”¨çš„æ ‡ç­¾ã€‚ ","date":"2024-11-06","objectID":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"PackageManagerServiceå’Œå®ƒçš„6ä¸ªâ€œå°ä¼™ä¼´â€","uri":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/#21-androidmanifestxml"},{"categories":null,"collections":"PMS","content":"2.2 å°ç»“ æˆ‘æŠŠæˆ‘çš„ç®¡ç†å¯¹è±¡apkä»‹ç»ç»™äº†å¤§å®¶ï¼Œå…¶å®æˆ‘ä¸»è¦ç›®çš„æ˜¯æƒ³æŠŠapkä¸­çš„AndroidManifest.xmlç€é‡ä»‹ç»ç»™å¤§å®¶ï¼Œå› ä¸ºå®ƒå¯¹äºæˆ‘PMSæ¥è¯´éå¸¸é‡è¦ï¼Œæˆ‘åªæœ‰é€šè¿‡å®ƒæ‰èƒ½çŸ¥é“ä¸€ä¸ªapkå†…åˆ°åº•å£°æ˜äº†å“ªäº›å››å¤§ç»„ä»¶ã€ç”³è¯·äº†å“ªäº›æƒé™ã€ä½¿ç”¨äº†å“ªäº›å…±äº«åº“ç­‰ç­‰ã€‚ é‚£æ¥ä¸‹æ¥å¤§å®¶æŠŠâ€œè§†çº¿â€å†æ¬¡èšç„¦åˆ°æˆ‘èº«ä¸Šï¼Œç»§ç»­æŠŠæˆ‘è‡ªå·±ä»‹ç»ç»™å¤§å®¶ã€‚ 3 æˆ‘çš„â€œå°ä¼™ä¼´â€ ä½ ä»¬å¯ä¸è¦æŠŠæˆ‘æƒ³è±¡çš„å¾ˆå‰å®³ï¼Œå¾ˆå¤šå·¥ä½œéƒ½æ˜¯ç”±æˆ‘å’Œæˆ‘çš„â€œå°ä¼™ä¼´ä»¬â€å…±åŒå®Œæˆçš„ï¼Œå•å‡­æˆ‘ä¸€ä¸ªâ€œäººâ€å¯ä¸è¡Œã€‚ä¸ºäº†è®©å¤§å®¶èƒ½æ›´æ¸…æ¥šçš„è®¤è¯†æˆ‘çš„â€œå°ä¼™ä¼´â€ï¼Œæˆ‘ç”¨ä¸€å¼ å›¾æŠŠå®ƒä»¬å±•ç¤ºç»™å¤§å®¶ã€‚ æˆ‘çš„ä¸»è¦â€œå°ä¼™ä¼´â€æœ‰apkç®¡ç†æ¨¡å—ã€æƒé™ç®¡ç†æ¨¡å—ã€å…±äº«åº“æ¨¡å—ã€è®°å½•å­˜å‚¨æ¨¡å—ã€æ‰€æœ‰apkä¿¡æ¯æ¨¡å—ã€å››å¤§ç»„ä»¶æ¨¡å—ã€‚é‚£æˆ‘å°±æŠŠèˆå°äº¤ç»™å®ƒä»¬ï¼Œè®©å®ƒä»¬äº²è‡ªæŠŠè‡ªå·±ä»‹ç»ç»™å¤§å®¶å§ã€‚ ","date":"2024-11-06","objectID":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"PackageManagerServiceå’Œå®ƒçš„6ä¸ªâ€œå°ä¼™ä¼´â€","uri":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/#22-å°ç»“"},{"categories":null,"collections":"PMS","content":"3.1 æƒé™ç®¡ç†æ¨¡å— å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯æƒé™ç®¡ç†æ¨¡å—ï¼Œä¸ºäº†è®©å¤§å®¶æ›´äº†è§£æˆ‘çš„å·¥ä½œï¼Œæˆ‘å…ˆæ¥ä»‹ç»ä¸‹æƒé™ï¼Œæƒé™åˆ†ä¸ºå£°æ˜æƒé™å’Œè¯·æ±‚æƒé™ã€‚ å£°æ˜æƒé™ è¿˜è®°å¾—åœ¨ä¸Šé¢ä»‹ç»apkçš„AndroidManifest.xmlçš„æ—¶å€™ï¼Œå£°æ˜æƒé™éœ€è¦åœ¨AndroidManifest.xmlæ–‡ä»¶ä¸­ä½¿ç”¨permissionæ ‡ç­¾ï¼Œå¦‚ä¸‹ä¾‹å­ï¼š \u003cpermissionÂ android:description=\"stringÂ resource\" android:icon=\"drawableÂ resource\" android:label=\"stringÂ resource\" android:name=\"string\" android:permissionGroup=\"string\" android:protectionLevel=[\"normal\"Â |Â \"dangerous\"Â | \"signature\"Â |Â ...]Â /\u003e æ¯ä¸ªapkéƒ½å¯ä»¥å£°æ˜è‡ªå·±çš„æƒé™ï¼Œé‚£å½“åˆ«çš„apkè®¿é—®è‡ªå·±çš„ä¸€äº›å…³é”®ä¿¡æ¯æ—¶å€™å°±å¯ä»¥è¦æ±‚å®ƒå…·æœ‰æŸä¸ªå£°æ˜çš„æƒé™åæ‰å¯ä»¥è®¿é—®ã€‚ è¯·æ±‚æƒé™ æ¯ä¸ªå®‰è£…åœ¨Androidè®¾å¤‡ä¸Šçš„apkæˆ–å¤šæˆ–å°‘çš„éƒ½ä¼šç”¨åˆ°ä¸€äº›æƒé™ï¼Œè¯·æ±‚æƒé™å°±æ˜¯åœ¨AndroidManifestä¸­é€šè¿‡uses-permissionæ ‡ç­¾æ¥ä½¿ç”¨æƒé™ï¼Œå¦‚ä¸‹ä»£ç ï¼š \u003cuses-permissionÂ android:name=\"android.permission.READ_EXTERNAL_STORAGE\"/\u003e è€Œæˆ‘æƒé™ç®¡ç†æ¨¡å—æ‰€åšçš„äº‹æƒ…å¦‚ä¸‹ï¼š æŠŠæ‰€æœ‰çš„apkå£°æ˜çš„æƒé™æ”¶é›†å¹¶é›†ä¸­ç®¡ç†èµ·æ¥ è€Œæ¯ä¸ªapkè¯·æ±‚çš„æƒé™å’Œæƒé™å¯¹åº”çš„çŠ¶æ€æˆ‘ä¹Ÿä¼šä¿å­˜èµ·æ¥ï¼Œæƒé™å¯¹åº”çš„çŠ¶æ€æ˜¯æŒ‡æ¯”å¦‚æŸä¸ªapkçš„æƒé™æ˜¯å¦è¢«å…è®¸ã€æ˜¯å¦æ‹’ç»ã€æ˜¯å¦åªæ˜¯å…è®¸ä¸€æ¬¡ apkåœ¨è¯·æ±‚æŸä¸ªæƒé™æ—¶ï¼Œå½“ç”¨æˆ·ä¸ç®¡æ˜¯ç‚¹å‡»äº†å…è®¸ã€æ‹’ç»ç­‰ï¼Œéƒ½éœ€è¦ç»è¿‡æˆ‘ ä»¥ä¸Šå°±æ˜¯æˆ‘æ‰€åšçš„äº‹æƒ…ï¼Œè€Œæˆ‘æŠŠè¿™äº›äº‹æƒ…å…¨æƒäº¤ç»™äº†PermissionManagerServiceæœåŠ¡æ¥å¤„ç†ï¼Œå…³äºæˆ‘ä¼šåœ¨åé¢çš„æ–‡ç« å†æ¬¡ä¸å¤§å®¶è§é¢ã€‚ ","date":"2024-11-06","objectID":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/:3:0","tags":["clippings","è½¬è½½","blog"],"title":"PackageManagerServiceå’Œå®ƒçš„6ä¸ªâ€œå°ä¼™ä¼´â€","uri":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/#31-æƒé™ç®¡ç†æ¨¡å—"},{"categories":null,"collections":"PMS","content":"3.2 å…±äº«åº“æ¨¡å— å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å…±äº«åº“æ¨¡å—ï¼ŒåŒæ ·æˆ‘ä¹Ÿå…ˆæ¥ä»‹ç»ä¸‹å…±äº«åº“ï¼Œåƒframework.jarè¿™ä¸ªåº“åŒ…å«äº†å¾ˆå¤šçš„ç±»æ¯”å¦‚Activityã€Contextã€Serviceç­‰ï¼Œè€Œframework.jaråœ¨zygoteè¿›ç¨‹ä¸­å·²ç»è¢«é¢„åŠ è½½äº†ï¼Œå› æ­¤æ¯ä¸ªapkç›´æ¥ä½¿ç”¨å³å¯ã€‚è€Œåƒä¸€äº›åº“æ¯”å¦‚com.google.android.mapsï¼Œå®ƒæ˜¯æ²¡æœ‰è¢«åŒ…å«åœ¨framework.jarä¸­çš„ï¼Œè€Œcom.google.android.mapsä»¥å…±äº«åº“çš„æ–¹å¼æä¾›ç»™ä½¿ç”¨è€…æ¥ä½¿ç”¨ã€‚è€Œå…±äº«åº“ä¹Ÿåˆ†ä¸ºå£°æ˜å…±äº«åº“å’Œä½¿ç”¨å…±äº«åº“ã€‚ å£°æ˜å…±äº«åº“ é¦–å…ˆåªæœ‰ç³»ç»Ÿapkæ‰å¯ä»¥å£°æ˜å…±äº«åº“ï¼Œä¸ºå•¥æœ‰è¿™æ ·çš„è§„å®šï¼Ÿä¸»è¦åŸå› æ˜¯æ—¢ç„¶æ˜¯å…±äº«åº“å°±éœ€è¦ä¿è¯å®ƒçš„ç¨³å®šæ€§ï¼Œå¦‚æœæ˜¯æ™®é€šapkå¯ä»¥å£°æ˜å…±äº«åº“ï¼Œé‚£è®¾å¤‡ä¸Šæ²¡æœ‰è£…è¯¥apkï¼Œé‚£å…±äº«åº“å°±ä¸å­˜åœ¨ã€‚å£°æ˜å…±äº«åº“éå¸¸ç®€å•åœ¨AndroidManifest.xmlæ–‡ä»¶ä¸­ä½¿ç”¨libraryæ ‡ç­¾ï¼Œå¦‚ä¸‹ä¾‹å­ï¼š \u003clibraryÂ android:name=\"android.ext.shared\"Â /\u003e ä½¿ç”¨å…±äº«åº“ ä½¿ç”¨å…±äº«åº“åœ¨AndroidManifest.xmlæ–‡ä»¶ä¸­ä½¿ç”¨uses-library (ä½¿ç”¨javaåº“)æˆ–è€…uses-native-library (ä½¿ç”¨nativeåº“) æ ‡ç­¾ï¼Œå¦‚ä¸‹ä¾‹å­ï¼š \u003cuses-libraryÂ android:name=\"com.google.android.maps\"Â android:required=\"false\"Â /\u003e\u003cuses-libraryÂ android:name=\"com.here.android\"Â android:required=\"false\"Â /\u003e è€Œæˆ‘æ‰€åšçš„äº‹æƒ…å¦‚ä¸‹ï¼š æŠŠæ‰€æœ‰å£°æ˜çš„å…±äº«åº“æ”¶é›†èµ·æ¥ï¼Œè‹¥å…±äº«åº“ä¹‹é—´å­˜åœ¨ä¾èµ–ï¼Œåˆ™æŠŠå®ƒä»¬çš„ä¾èµ–ä¹Ÿåˆå§‹åŒ–ã€‚ è‹¥apkä¸­ä½¿ç”¨äº†å…±äº«åº“ï¼Œåˆ™ä¼šæŠŠå…±äº«åº“çš„ä¿¡æ¯ (å¦‚å…±äº«åº“æ–‡ä»¶è·¯å¾„) äº¤ç»™è¯¥apkã€‚ è€Œæˆ‘åŒæ ·æŠŠè¿™äº›äº‹æƒ…äº¤ç»™äº†SharedLibrariesImplç±»æ¥å¤„ç†ï¼Œåœ¨åé¢çš„æ–‡ç« ä¸­æˆ‘è¿˜ä¼šä¸å¤§å®¶è§é¢ã€‚ ","date":"2024-11-06","objectID":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/:4:0","tags":["clippings","è½¬è½½","blog"],"title":"PackageManagerServiceå’Œå®ƒçš„6ä¸ªâ€œå°ä¼™ä¼´â€","uri":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/#32-å…±äº«åº“æ¨¡å—"},{"categories":null,"collections":"PMS","content":"3.2 å…±äº«åº“æ¨¡å— å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å…±äº«åº“æ¨¡å—ï¼ŒåŒæ ·æˆ‘ä¹Ÿå…ˆæ¥ä»‹ç»ä¸‹å…±äº«åº“ï¼Œåƒframework.jarè¿™ä¸ªåº“åŒ…å«äº†å¾ˆå¤šçš„ç±»æ¯”å¦‚Activityã€Contextã€Serviceç­‰ï¼Œè€Œframework.jaråœ¨zygoteè¿›ç¨‹ä¸­å·²ç»è¢«é¢„åŠ è½½äº†ï¼Œå› æ­¤æ¯ä¸ªapkç›´æ¥ä½¿ç”¨å³å¯ã€‚è€Œåƒä¸€äº›åº“æ¯”å¦‚com.google.android.mapsï¼Œå®ƒæ˜¯æ²¡æœ‰è¢«åŒ…å«åœ¨framework.jarä¸­çš„ï¼Œè€Œcom.google.android.mapsä»¥å…±äº«åº“çš„æ–¹å¼æä¾›ç»™ä½¿ç”¨è€…æ¥ä½¿ç”¨ã€‚è€Œå…±äº«åº“ä¹Ÿåˆ†ä¸ºå£°æ˜å…±äº«åº“å’Œä½¿ç”¨å…±äº«åº“ã€‚ å£°æ˜å…±äº«åº“ é¦–å…ˆåªæœ‰ç³»ç»Ÿapkæ‰å¯ä»¥å£°æ˜å…±äº«åº“ï¼Œä¸ºå•¥æœ‰è¿™æ ·çš„è§„å®šï¼Ÿä¸»è¦åŸå› æ˜¯æ—¢ç„¶æ˜¯å…±äº«åº“å°±éœ€è¦ä¿è¯å®ƒçš„ç¨³å®šæ€§ï¼Œå¦‚æœæ˜¯æ™®é€šapkå¯ä»¥å£°æ˜å…±äº«åº“ï¼Œé‚£è®¾å¤‡ä¸Šæ²¡æœ‰è£…è¯¥apkï¼Œé‚£å…±äº«åº“å°±ä¸å­˜åœ¨ã€‚å£°æ˜å…±äº«åº“éå¸¸ç®€å•åœ¨AndroidManifest.xmlæ–‡ä»¶ä¸­ä½¿ç”¨libraryæ ‡ç­¾ï¼Œå¦‚ä¸‹ä¾‹å­ï¼š ä½¿ç”¨å…±äº«åº“ ä½¿ç”¨å…±äº«åº“åœ¨AndroidManifest.xmlæ–‡ä»¶ä¸­ä½¿ç”¨uses-library (ä½¿ç”¨javaåº“)æˆ–è€…uses-native-library (ä½¿ç”¨nativeåº“) æ ‡ç­¾ï¼Œå¦‚ä¸‹ä¾‹å­ï¼š è€Œæˆ‘æ‰€åšçš„äº‹æƒ…å¦‚ä¸‹ï¼š æŠŠæ‰€æœ‰å£°æ˜çš„å…±äº«åº“æ”¶é›†èµ·æ¥ï¼Œè‹¥å…±äº«åº“ä¹‹é—´å­˜åœ¨ä¾èµ–ï¼Œåˆ™æŠŠå®ƒä»¬çš„ä¾èµ–ä¹Ÿåˆå§‹åŒ–ã€‚ è‹¥apkä¸­ä½¿ç”¨äº†å…±äº«åº“ï¼Œåˆ™ä¼šæŠŠå…±äº«åº“çš„ä¿¡æ¯ (å¦‚å…±äº«åº“æ–‡ä»¶è·¯å¾„) äº¤ç»™è¯¥apkã€‚ è€Œæˆ‘åŒæ ·æŠŠè¿™äº›äº‹æƒ…äº¤ç»™äº†SharedLibrariesImplç±»æ¥å¤„ç†ï¼Œåœ¨åé¢çš„æ–‡ç« ä¸­æˆ‘è¿˜ä¼šä¸å¤§å®¶è§é¢ã€‚ ","date":"2024-11-06","objectID":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/:4:0","tags":["clippings","è½¬è½½","blog"],"title":"PackageManagerServiceå’Œå®ƒçš„6ä¸ªâ€œå°ä¼™ä¼´â€","uri":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/#ä½¿ç”¨å…±äº«åº“"},{"categories":null,"collections":"PMS","content":"3.3 è®°å½•å­˜å‚¨æ¨¡å— å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯è®°å½•å­˜å‚¨æ¨¡å—ï¼Œæˆ‘çš„ä¸»è¦ä½œç”¨æ˜¯è®°å½•ä¿¡æ¯å¹¶ä¸”æŠŠè¿™äº›ä¿¡æ¯å­˜å‚¨åˆ°æ–‡ä»¶ä¸­ã€‚ PMSï¼šâ€œå…„å¼Ÿï¼Œä½ è¿™æ ·ä»‹ç»è‡ªå·±ï¼Œæˆ‘æƒ³å¤§å®¶è‚¯å®šä¸çŸ¥é“ä½ è¯´çš„æ˜¯å•¥ï¼Œæœ€å¥½ä»‹ç»çš„æ—¶å€™å¸¦ä¸€äº›ä¾‹å­ã€‚â€ è®°å½•å­˜å‚¨æ¨¡å—ï¼šâ€œä½ è¯´åˆ°å³æ˜¯ï¼Œé‚£æˆ‘å°±é‡æ–°ä»‹ç»ä¸‹æˆ‘è‡ªå·±ã€‚â€ é¦–å…ˆæˆ‘çš„åå­—ä¸»è¦æ˜¯ç”±è®°å½•å’Œå­˜å‚¨ä¸¤ä¸ªè¯ç»„æˆçš„ã€‚è®°å½•ä¸»è¦æ˜¯è®°å½•apkçš„å®‰è£…ä¿¡æ¯ã€shared userIdã€apkå£°æ˜çš„æƒé™ç­‰ã€‚ PMSï¼šâ€œé‚£æˆ‘æ›¿å¤§å®¶é—®ä¸ªé—®é¢˜ï¼Œåƒä½ è¯´çš„è¿™äº›ä¿¡æ¯ä¸è®°å½•è¡Œä¸è¡Œã€‚â€ è®°å½•å­˜å‚¨æ¨¡å—ï¼šâ€œç­”æ¡ˆæ˜¯ä¸è®°å½•è‚¯å®šä¸è¡Œï¼Œä¸ºå•¥å‘¢ï¼Ÿå¦‚apkçš„å®‰è£…ä¿¡æ¯æŒ‡çš„æ˜¯apkå®‰è£…åæ˜¯éœ€è¦æŠŠå®ƒçš„å…³é”®ä¿¡æ¯ç”¨PackageSettingç±»è®°å½•ä¸‹æ¥çš„ï¼Œå°±åƒä½ ä»¬äººç±»å…¥ä½é…’åº—éœ€è¦æŠŠèº«ä»½è¯ã€æˆ¿å·ç­‰å…³é”®ä¿¡æ¯è®°å½•ä¸‹æ¥ï¼Œè€ŒPackageSettingä¼šæŠŠapkçš„åŒ…åã€apkæ–‡ä»¶è·¯å¾„ã€apkçš„ç‰ˆæœ¬å·åŠç­¾åè¿™äº›ä¿¡æ¯è®°å½•ä¸‹æ¥ã€‚è®°å½•ä¸‹æ¥åé‚£å…¶ä»–ä½¿ç”¨è€…æƒ³è¦çŸ¥é“å“ªä¸ªapkæ˜¯å¦å®‰è£…äº†ï¼Œå°±å¯ä»¥å¿«é€Ÿçš„ä»æˆ‘è¿™æ£€ç´¢åˆ°ã€‚å°±åƒè­¦å¯Ÿå»æŸé…’åº—æŸ¥è¯¢æŸä¸ªäººæ˜¯å¦å…¥ä½äº†é…’åº—ã€‚â€ é‚£å­˜å‚¨å°±æ˜¯æŠŠè®°å½•çš„ä¿¡æ¯å­˜å‚¨åˆ°æ–‡ä»¶ä¸­ï¼Œå­˜å‚¨åˆ°æ–‡ä»¶ååœ¨ä¸‹æ¬¡Androidè®¾å¤‡é‡æ–°å¯åŠ¨çš„æ—¶å€™å°±å¯ä»¥æŠŠå­˜å‚¨çš„è¿™äº›ä¿¡æ¯è¯»å–å‡ºæ¥äº†ã€‚è€Œæˆ‘æŠŠæˆ‘æ‰€åšçš„è¿™äº›äº‹æƒ…äº¤ç»™äº†Settingsç±»ï¼Œåœ¨åé¢çš„æ–‡ç« ä¸­æˆ‘ä¼šæŠŠæˆ‘è‡ªå·±å®Œå®Œå…¨å…¨çš„ä»‹ç»ç»™å¤§å®¶ï¼ŒæœŸå¾…ä¸å¤§å®¶è§é¢ã€‚ ","date":"2024-11-06","objectID":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/:5:0","tags":["clippings","è½¬è½½","blog"],"title":"PackageManagerServiceå’Œå®ƒçš„6ä¸ªâ€œå°ä¼™ä¼´â€","uri":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/#33-è®°å½•å­˜å‚¨æ¨¡å—"},{"categories":null,"collections":"PMS","content":"3.4 æ‰€æœ‰apkä¿¡æ¯æ¨¡å— å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯æ‰€æœ‰apkä¿¡æ¯æ¨¡å—ï¼Œå¬ç€è¿™ä¸ªåå­—æ˜¯ä¸æ˜¯å¾ˆå¥‡æ€ªï¼Œä¸»è¦çš„åŸå› æ˜¯æˆ‘æ²¡æœ‰æƒ³åˆ°ä¸€ä¸ªå¾ˆå¥½çš„åå­—ï¼Œè€Œæˆ‘æ‰€åšçš„äº‹æƒ…æ˜¯ä¼šæŠŠæ‰€æœ‰å·²å®‰è£…apkçš„ä¿¡æ¯æ”¶é›†èµ·æ¥ï¼Œè¿˜è®°å¾—ã€2.æˆ‘ç®¡ç†çš„å¯¹è±¡ã€‘ä»‹ç»apkä¸­çš„AndroidManifestæ–‡ä»¶å—ï¼Ÿè¿™é‡Œçš„apkçš„ä¿¡æ¯æŒ‡çš„å°±æ˜¯è§£æAndroidManifestæ–‡ä»¶åçš„æ•°æ®ã€‚é€šè¿‡è¿™äº›ä¿¡æ¯å¯ä»¥çŸ¥é“apkçš„ç‰ˆæœ¬å·ã€åŒ…åã€applicationå¯¹åº”çš„classã€å£°æ˜äº†å“ªäº›å››å¤§ç»„ä»¶ã€ä½¿ç”¨äº†å“ªäº›æƒé™ç­‰ç­‰ã€‚ æˆ‘çš„ä½¿ç”¨åœºæ™¯æ¯”è¾ƒå¤šï¼Œæ¯”å¦‚ä½¿ç”¨è€…å¯ä»¥ä»æˆ‘è¿™æŸ¥è¯¢åˆ°Applicationçš„ä¿¡æ¯ç­‰ï¼Œè€Œæˆ‘æ˜¯å­˜å‚¨åœ¨PMSçš„mPackageså±æ€§ä¸­ï¼Œå¦‚ä¸‹ä»£ç ï¼š //keyæ˜¯åŒ…åï¼Œè€ŒAndroidPackageå­˜å‚¨äº†è§£æå‡ºçš„AndroidManifestçš„ä¿¡æ¯finalÂ WatchedArrayMap\u003cString,Â AndroidPackage\u003eÂ mPackagesÂ =Â newÂ WatchedArrayMap\u003c\u003e(); ","date":"2024-11-06","objectID":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/:6:0","tags":["clippings","è½¬è½½","blog"],"title":"PackageManagerServiceå’Œå®ƒçš„6ä¸ªâ€œå°ä¼™ä¼´â€","uri":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/#34-æ‰€æœ‰apkä¿¡æ¯æ¨¡å—"},{"categories":null,"collections":"PMS","content":"3.5 å››å¤§ç»„ä»¶æ¨¡å— å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯å››å¤§ç»„ä»¶æ¨¡å—ï¼Œèªæ˜çš„å¤§å®¶çœ‹äº†æˆ‘çš„åå­—è‚¯å®šèƒ½ç«‹é©¬çŸ¥é“æˆ‘æ˜¯åšå•¥çš„ï¼Œæˆ‘å­˜å‚¨äº†æ‰€æœ‰å·²å®‰è£…apkçš„AndroidManifestä¸­å£°æ˜çš„å››å¤§ç»„ä»¶ã€‚ PMSå¯¹å››å¤§ç»„ä»¶æ¨¡å—è¯´åˆ°ï¼šâ€œæˆ‘æœ‰ä¸ªé—®é¢˜ï¼Œæ‰€æœ‰apkä¿¡æ¯æ¨¡å—ä¸æ˜¯å·²ç»æŠŠæ‰€æœ‰çš„ä¿¡æ¯éƒ½åŒ…å«è¿›å»äº†ï¼Œé‚£ä¸ºå•¥è¿˜éœ€è¦ä½ å‘¢ï¼Ÿä½ ä»¬ä¸æ˜¯åŒ…å«äº†é‡å¤çš„ä¿¡æ¯å—ï¼Ÿâ€ â€œæˆ‘å­˜åœ¨çš„ç›®çš„æ˜¯ä¸ºäº†å¿«é€Ÿçš„æ£€ç´¢å››å¤§ç»„ä»¶ï¼Œå‡å¦‚ä»æ‰€æœ‰apkä¿¡æ¯æ¨¡å—æ£€ç´¢æŸä¸ªActivityä¿¡æ¯çš„è¯ï¼Œéœ€è¦é€šè¿‡åŒ…åä»mPackagesä¸­è·å–å¯¹åº”çš„AndroidPackageå¯¹è±¡ï¼Œå†ä»AndroidPackageå¯¹è±¡ä¸­æ£€ç´¢Activityï¼Œè¿™ä¸ªæµç¨‹æ˜¯ä¸æ˜¯æ¯”è¾ƒé•¿ï¼Œè€Œä»å››å¤§ç»„ä»¶æ¨¡å—æ£€ç´¢é€Ÿåº¦éå¸¸å¿«ã€‚è¿™ä¹Ÿå°±æ˜¯æˆ‘å­˜åœ¨çš„ç›®çš„ã€‚â€ æˆ‘å¸¸ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š ActivityTaskManagerServiceå¯åŠ¨æŸä¸ªActivityæ—¶ï¼Œéœ€è¦ä»æˆ‘è¿™è·å–å¯¹åº”çš„Activityä¿¡æ¯ï¼Œè·å–åˆ°åˆ™è¿”å›ï¼›å¦åˆ™å¯åŠ¨Activityå¤±æ•ˆ ActivityManagerServiceå¯åŠ¨æŸä¸ªServiceæ—¶ï¼Œä¹Ÿéœ€è¦ä»æˆ‘è¿™è·å–å¯¹åº”çš„Serviceä¿¡æ¯ã€‚åŒç†å¯åŠ¨æŸä¸ªBroadcastReceiverã€ContentProviderä¹Ÿéœ€è¦ä»æˆ‘å“¦è¿™è·å–å¯¹åº”çš„ä¿¡æ¯ è€Œæˆ‘æ˜¯å­˜å‚¨åœ¨PMSçš„mComponentResolverå±æ€§ä¸­ï¼Œå¦‚ä¸‹ä»£ç ï¼š finalÂ ComponentResolverÂ mComponentResolver; ","date":"2024-11-06","objectID":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/:7:0","tags":["clippings","è½¬è½½","blog"],"title":"PackageManagerServiceå’Œå®ƒçš„6ä¸ªâ€œå°ä¼™ä¼´â€","uri":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/#35-å››å¤§ç»„ä»¶æ¨¡å—"},{"categories":null,"collections":"PMS","content":"3.6 apkç®¡ç†æ¨¡å— å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯apkç®¡ç†æ¨¡å—ï¼Œä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºæˆ‘åœ¨æ‰€æœ‰æ¨¡å—ä¸­çš„åœ°ä½æ˜¯å¤šä¹ˆé‡è¦ï¼Œæˆ‘æŠŠè‡ªå·±æ¯”ä½œæ ¹åŸºæ¨¡å—ï¼Œæ¯«ä¸å¤¸å¼ çš„è¯´æ²¡æœ‰æˆ‘å…¶ä»–æ¨¡å—å°±æ²¡æœ‰å­˜åœ¨çš„æ„ä¹‰ï¼Œæˆ‘åŒ…å«çš„åŠŸèƒ½æœ‰æ‰«ææ‰€æœ‰apkã€apkå®‰è£…/æ›´æ–°/å¸è½½ã€è§£æapkã€‚é‚£å°±æ¥è¯´ä¸‹æˆ‘ä¸ºä½•æœ‰å¦‚æ­¤å¤§çš„åº•æ°”æŠŠè‡ªå·±è¯´çš„å¦‚æ­¤é‡è¦ã€‚ ","date":"2024-11-06","objectID":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/:8:0","tags":["clippings","è½¬è½½","blog"],"title":"PackageManagerServiceå’Œå®ƒçš„6ä¸ªâ€œå°ä¼™ä¼´â€","uri":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/#36-apkç®¡ç†æ¨¡å—"},{"categories":null,"collections":"PMS","content":"3.6.1 apkå®‰è£… å®‰è£…ä¸€ä¸ªapkåï¼Œå¦‚æœapkä¸­å£°æ˜äº†æƒé™æˆ–è€…ä½¿ç”¨äº†æƒé™ï¼Œåˆ™éœ€è¦é€šçŸ¥æƒé™ç®¡ç†æ¨¡å—åšç›¸åº”çš„å¤„ç†ï¼›å¦‚æœapkæ˜¯ç³»ç»Ÿapkï¼Œä½¿ç”¨äº†libraryæ ‡ç­¾å£°æ˜äº†å…±äº«åº“ï¼Œåˆ™éœ€è¦é€šçŸ¥å…±äº«åº“æ¨¡å—æŠŠå£°æ˜çš„å…±äº«åº“æ”¶é›†èµ·æ¥ï¼›è®°å½•å­˜å‚¨æ¨¡å—éœ€è¦æŠŠè¯¥apkçš„å…³é”®ä¿¡æ¯è®°å½•å¹¶ä¸”å­˜å‚¨ä¸‹æ¥ï¼›æ‰€æœ‰apkä¿¡æ¯æ¨¡å—éœ€è¦æŠŠè¯¥apkä¸­AndroidManifestè§£æå‡ºæ¥çš„ä¿¡æ¯å­˜å‚¨ä¸‹æ¥ï¼›å››å¤§ç»„ä»¶æ¨¡å—éœ€è¦æŠŠè¯¥apkä¸­å£°æ˜çš„å››å¤§ç»„ä»¶å­˜å‚¨ä¸‹æ¥ã€‚ ä»¥ä¸Šå°±æ˜¯å®‰è£…ä¸€ä¸ªapkåï¼Œå¯¹å…¶ä»–æ¨¡å—äº§ç”Ÿçš„å½±å“ã€‚ ","date":"2024-11-06","objectID":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/:8:1","tags":["clippings","è½¬è½½","blog"],"title":"PackageManagerServiceå’Œå®ƒçš„6ä¸ªâ€œå°ä¼™ä¼´â€","uri":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/#361-apkå®‰è£…"},{"categories":null,"collections":"PMS","content":"3.6.2 apkçš„åˆ é™¤ åˆ é™¤ä¸€ä¸ªapkåï¼Œå¦‚æœapkä¸­å£°æ˜äº†æƒé™æˆ–è€…ä½¿ç”¨äº†æƒé™ï¼Œåˆ™éœ€è¦é€šçŸ¥æƒé™ç®¡ç†æ¨¡å—æŠŠç›¸åº”çš„æƒé™åˆ é™¤ï¼›å¦‚æœapkæ˜¯ç³»ç»Ÿapkï¼Œä½¿ç”¨äº†libraryæ ‡ç­¾å£°æ˜äº†å…±äº«åº“ï¼Œåˆ™éœ€è¦é€šçŸ¥å…±äº«åº“æ¨¡å—æŠŠå£°æ˜çš„å…±äº«åº“åˆ é™¤ï¼›è®°å½•å­˜å‚¨æ¨¡å—éœ€è¦æŠŠè¯¥apkçš„å…³é”®ä¿¡æ¯åˆ é™¤ï¼›æ‰€æœ‰apkä¿¡æ¯æ¨¡å—éœ€è¦æŠŠè¯¥apkçš„ä¿¡æ¯åˆ é™¤ï¼›å››å¤§ç»„ä»¶æ¨¡å—éœ€è¦æŠŠè¯¥apkä¸­å£°æ˜çš„å››å¤§ç»„ä»¶åˆ é™¤æ‰ã€‚ ä»¥ä¸Šå°±æ˜¯åˆ é™¤ä¸€ä¸ªapkåï¼Œå¯¹å…¶ä»–æ¨¡å—äº§ç”Ÿçš„å½±å“ã€‚ ","date":"2024-11-06","objectID":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/:8:2","tags":["clippings","è½¬è½½","blog"],"title":"PackageManagerServiceå’Œå®ƒçš„6ä¸ªâ€œå°ä¼™ä¼´â€","uri":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/#362-apkçš„åˆ é™¤"},{"categories":null,"collections":"PMS","content":"3.6.3 æ‰«ææ‰€æœ‰apk å½“Androidè®¾å¤‡å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šå¯åŠ¨ä¸€ä¸ªä»»åŠ¡å°±æ˜¯æŠŠæ‰€æœ‰çš„ç³»ç»Ÿapkå’Œéç³»ç»Ÿapkéƒ½æ‰«æä¸€ä¸‹ï¼Œæ‰«æapkå…¶ä¸­æœ€é‡è¦çš„äº‹æƒ…æ˜¯è§£æapkçš„AndroidManifestæ–‡ä»¶ï¼Œæ‰«æapkæ‰€åšçš„äº‹æƒ…ç®€å•æ€»ç»“ä¸‹å°±æ˜¯ï¼šå¦‚æœapkå­˜åœ¨å‡çº§çš„æƒ…å†µåˆ™æŠŠapkå‡çº§ï¼Œå¦‚æœå­˜åœ¨apkåˆ é™¤çš„æƒ…å†µåˆ™æŠŠapkåˆ é™¤ï¼Œè‹¥å­˜åœ¨ä¸€ä¸ªæ–°çš„ç³»ç»Ÿapkåˆ™å®‰è£…apkã€‚å› æ­¤æ‰«ææ‰€æœ‰apkä¹Ÿä¼šå¯¹å…¶ä»–æ¨¡å—äº§ç”Ÿå½±å“ã€‚ ä»¥ä¸Šçš„åŸå› æ˜¯ä¸æ˜¯å®Œå…¨å¯ä»¥è¯´æ˜æˆ‘ä¸ºå•¥æ˜¯æ ¹åŸºæ¨¡å—äº†ï¼Œä¸ç®¡æ˜¯apkçš„å®‰è£…è¿˜æ˜¯apkçš„å¸è½½éƒ½ä¼šå¼•èµ·å…¶ä»–æ¨¡å—çš„â€œéœ‡åŠ¨â€ï¼Œæˆ‘æŠŠå®‰è£…/å¸è½½/æ›´æ–°apkçš„åŠŸèƒ½äº¤ç»™äº†PackageInstallerServiceè¿™ä¸ªæœåŠ¡ï¼Œå¯¹apkå®‰è£…æ„Ÿå…´è¶£å¯ä»¥æŸ¥çœ‹apkå®‰è£…ä¹‹è°œè¿™ç¯‡æ–‡ç« ã€‚ ","date":"2024-11-06","objectID":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/:8:3","tags":["clippings","è½¬è½½","blog"],"title":"PackageManagerServiceå’Œå®ƒçš„6ä¸ªâ€œå°ä¼™ä¼´â€","uri":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/#363-æ‰«ææ‰€æœ‰apk"},{"categories":null,"collections":"PMS","content":"3.7 å°ç»“ æˆ‘çš„â€œå°ä¼™ä¼´â€ä»¬éƒ½æŠŠå®ƒä»¬è‡ªå·±ä»‹ç»å®Œæ¯•äº†ï¼Œé‚£æˆ‘ç®€å•æ€»ç»“ä¸‹ï¼š æƒé™ç®¡ç†æ¨¡å—è´Ÿè´£apkæƒé™ç›¸å…³çš„äº‹æƒ…ï¼Œæ¯”å¦‚è¯·æ±‚æŸä¸ªæƒé™ï¼Œapkæƒé™çŠ¶æ€å­˜å‚¨ï¼Œæ”¶é›†æ‰€æœ‰apkå£°æ˜çš„æƒé™ å…±äº«åº“æ¨¡å—è´Ÿè´£apkä½¿ç”¨åˆ°çš„æ‰€æœ‰å…±äº«åº“ è®°å½•å­˜å‚¨æ¨¡å—ä¼šæŠŠapkç›¸å…³çš„å¾ˆå¤šä¿¡æ¯è®°å½•å¹¶ä¸”å­˜å‚¨åˆ°æ–‡ä»¶ä¸­ï¼Œæ¯”å¦‚apkå®‰è£…åå…³äºapkå®‰è£…çš„ä¿¡æ¯ä¼šå­˜å‚¨ä¸‹æ¥ï¼Œè¿™æ ·å°±å¯ä»¥ä¾›å…¶ä»–ä½¿ç”¨è€…æ£€ç´¢ æ‰€æœ‰apkä¿¡æ¯æ¨¡å—ä¼šæ”¶é›†æ‰€æœ‰å·²å®‰è£…apkçš„AndroidManifestè§£æå‡ºæ¥çš„ä¿¡æ¯ï¼Œä»¥ä¾›å…¶ä»–ä½¿ç”¨è€…æ£€ç´¢ å››å¤§ç»„ä»¶æ¨¡å—ä¸ºäº†åŠ å¿«æ£€ç´¢å››å¤§ç»„ä»¶çš„é€Ÿåº¦ï¼Œä¼šæŠŠæ‰€æœ‰å·²å®‰è£…apkçš„å››å¤§ç»„ä»¶ä¿¡æ¯æ”¶é›†èµ·æ¥ apkç®¡ç†æ¨¡å—ä¸»è¦è´Ÿè´£apkçš„å®‰è£…/å¸è½½/æ›´æ–°ï¼Œå®ƒæ˜¯æ ¹åŸºæ¨¡å—ï¼Œå› ä¸ºå®ƒçš„æŸä¸ªåŠŸèƒ½ä¼šå¯¹å…¶ä»–æ¨¡å—äº§ç”Ÿå½±å“ã€‚ 4 æˆ‘çš„å¯åŠ¨ ä»‹ç»å®Œæˆ‘çš„â€œå°ä¼™ä¼´â€ï¼Œé‚£æ¥ä»‹ç»ä¸‹æˆ‘çš„å¯åŠ¨è¿‡ç¨‹ï¼Œçœ‹ä¸‹æˆ‘çš„â€œå°ä¼™ä¼´â€åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­åšäº†ä»€ä¹ˆï¼Ÿ ","date":"2024-11-06","objectID":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/:9:0","tags":["clippings","è½¬è½½","blog"],"title":"PackageManagerServiceå’Œå®ƒçš„6ä¸ªâ€œå°ä¼™ä¼´â€","uri":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/#37-å°ç»“"},{"categories":null,"collections":"PMS","content":"4.1 å…±äº«åº“æ¨¡å—åˆå§‹åŒ– systemserverè¿›ç¨‹æœ‰å¾ˆå¤šå¾ˆå¤šçš„æœåŠ¡ï¼Œè€Œåœ¨systemserverè¿›ç¨‹å¯åŠ¨è¿‡ç¨‹ä¸­æŠŠè¿™äº›æœåŠ¡åˆ†ä¸ºäº†bootstrap servicesã€core servicesã€other servicesï¼Œè€Œæˆ‘éå¸¸çš„â€œè£å¹¸â€ä½œä¸ºbootstrap servicesæœ€å…ˆè¢«å¯åŠ¨ï¼Œå½“æˆ‘PMSçš„æ„é€ æ–¹æ³•è¢«è°ƒç”¨åï¼Œå…±äº«åº“æ¨¡å—ä¼šå…ˆè¿›è¡Œåˆå§‹åŒ–ï¼Œå…±äº«åº“æ—¢æœ‰javaå…±äº«åº“ä¹Ÿæœ‰nativeå…±äº«åº“ï¼Œä¸‹é¢æ˜¯ç›¸åº”çš„ä»£ç ï¼š //ä¸‹é¢ä»£ç ä½äºPackageManagerServiceæ„é€ æ–¹æ³•ä¸­ //ä»Â SystemConfig.getInstance()Â ä¸­æŠŠæ‰€æœ‰çš„libè¯»å–å‡ºæ¥ ArrayMap\u003cString,Â SystemConfig.SharedLibraryEntry\u003eÂ libConfigÂ =Â systemConfig.getSharedLibraries(); finalÂ intÂ builtInLibCountÂ =Â libConfig.size(); forÂ (intÂ iÂ =Â 0;Â iÂ \u003cÂ builtInLibCount;Â i++)Â { //ä¾æ¬¡æŠŠå­˜å‚¨åœ¨æ–‡ä»¶ä¸­çš„å…±äº«åº“æ·»åŠ åˆ°Â mSharedLibrariesÂ ä¸­ mSharedLibraries.addBuiltInSharedLibraryLPw(libConfig.valueAt(i));Â } longÂ undefinedVersionÂ =Â SharedLibraryInfo.VERSION_UNDEFINED; //ä¸‹é¢ä»£ç å¤„ç†å…±äº«åº“ä¹‹é—´çš„ä¾èµ– forÂ (intÂ iÂ =Â 0;Â iÂ \u003cÂ builtInLibCount;Â i++)Â { StringÂ nameÂ =Â libConfig.keyAt(i); SystemConfig.SharedLibraryEntryÂ entryÂ =Â libConfig.valueAt(i); finalÂ intÂ dependencyCountÂ =Â entry.dependencies.length; forÂ (intÂ jÂ =Â 0;Â jÂ \u003cÂ dependencyCount;Â j++)Â { finalÂ SharedLibraryInfoÂ dependencyÂ = computer.getSharedLibraryInfo(entry.dependencies[j],Â undefinedVersion); ifÂ (dependencyÂ !=Â null)Â { computer.getSharedLibraryInfo(name,Â undefinedVersion).addDependency(dependency); } } } ","date":"2024-11-06","objectID":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/:10:0","tags":["clippings","è½¬è½½","blog"],"title":"PackageManagerServiceå’Œå®ƒçš„6ä¸ªâ€œå°ä¼™ä¼´â€","uri":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/#41-å…±äº«åº“æ¨¡å—åˆå§‹åŒ–"},{"categories":null,"collections":"PMS","content":"4.2 è®°å½•å­˜å‚¨æ¨¡å—åˆå§‹åŒ– è®°å½•å­˜å‚¨æ¨¡å—ä¼šä»å…ˆå‰å­˜å‚¨å¥½çš„æ–‡ä»¶ä¸­æŠŠå„ç§ä¿¡æ¯è¯»å–å‡ºæ¥ï¼Œå¹¶äº¤ç»™å¯¹åº”çš„è®°å½•ç±»ï¼Œæ¯”å¦‚å­˜å‚¨çš„æ‰€æœ‰apkçš„å®‰è£…ä¿¡æ¯ä¼šä» package.xml æ–‡ä»¶ä¸­è¯»å–å‡ºæ¥ï¼Œäº¤ç»™PackageSettingç±»ï¼›åœ¨æ¯”å¦‚å£°æ˜çš„æƒé™ä¿¡æ¯ä¹Ÿä»package.xml æ–‡ä»¶ä¸­è¯»å–å‡ºæ¥ï¼Œäº¤ç»™LegacyPermissionSettingsç±»ã€‚è¯¥æ¨¡å—æå‰åˆå§‹åŒ–ï¼Œä¸»è¦æ˜¯ä¸ºåé¢çš„æ¨¡å—æœåŠ¡çš„ï¼Œå…¶ä»–æ¨¡å—éƒ½éœ€è¦çŸ¥é“å“ªäº›apkå®‰è£…äº†ç­‰ä¿¡æ¯ã€‚ä¸‹é¢æ˜¯ç›¸åº”ä»£ç ï¼š //ä¸‹é¢ä»£ç ä½äºPackageManagerServiceæ„é€ æ–¹æ³•ä¸­ //ä»Â /data/system/packages.xmlåŠå…¶ä»–æ–‡ä»¶ä¸­æŠŠä¿å­˜çš„æ•°æ®è¯»å‡ºæ¥ mFirstBootÂ =Â !mSettings.readLPw(computer,Â mInjector.getUserManagerInternal().getUsers( /*Â excludePartial=Â */Â true, /*Â excludeDying=Â */Â false, /*Â excludePreCreated=Â */Â false)); ","date":"2024-11-06","objectID":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/:11:0","tags":["clippings","è½¬è½½","blog"],"title":"PackageManagerServiceå’Œå®ƒçš„6ä¸ªâ€œå°ä¼™ä¼´â€","uri":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/#42-è®°å½•å­˜å‚¨æ¨¡å—åˆå§‹åŒ–"},{"categories":null,"collections":"PMS","content":"4.3 æƒé™ç®¡ç†æ¨¡å—åˆå§‹åŒ– å› ä¸ºè®°å½•å­˜å‚¨æ¨¡å—ä¼šæŠŠå­˜å‚¨çš„æƒé™ä¿¡æ¯è¯»å–å‡ºæ¥ï¼Œæƒé™ç®¡ç†æ¨¡å—å°±å¯ä»¥ä½¿ç”¨è¿™äº›ä¿¡æ¯æ¥è¿›è¡Œåˆå§‹åŒ–äº†ï¼Œä¸‹é¢æ˜¯ç›¸åº”ä»£ç ï¼š //ä¸‹é¢ä»£ç ä½äºPackageManagerServiceæ„é€ æ–¹æ³•ä¸­ //æŠŠæ‰€æœ‰apkå£°æ˜çš„æƒé™äº¤ç»™mPermissionManager mPermissionManager.readLegacyPermissionsTEMP(mSettings.mPermissions);Â //ä¸‹é¢æ–¹æ³•ä¼šä½¿ç”¨æ¯ä¸ªapkçš„æƒé™çŠ¶æ€åˆå§‹åŒ–è‡ªå·± mPermissionManager.readLegacyPermissionStateTEMP(); è¿™æ ·æƒé™ç®¡ç†æ¨¡å—å°±å¯ä»¥æ¥æ”¶æƒé™ç®¡ç†æ–¹é¢çš„ä»»åŠ¡äº†ã€‚ ","date":"2024-11-06","objectID":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/:12:0","tags":["clippings","è½¬è½½","blog"],"title":"PackageManagerServiceå’Œå®ƒçš„6ä¸ªâ€œå°ä¼™ä¼´â€","uri":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/#43-æƒé™ç®¡ç†æ¨¡å—åˆå§‹åŒ–"},{"categories":null,"collections":"PMS","content":"4.4 æ‰«æapk å‰é¢å‡ ä¸ªæ¨¡å—çš„åˆå§‹åŒ–éƒ½æ˜¯åœ¨ä¸ºè¯¥æ­¥éª¤åšå‡†å¤‡ï¼Œè€Œæ‰«æapkä¸»è¦æ˜¯æŠŠç³»ç»Ÿapkå’Œéç³»ç»Ÿapkéƒ½æ‰«æï¼Œæ‰«æapkå…¶å®å¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ä¸ªç®€å•çš„apkå®‰è£…æˆ–æ›´æ–°è¿‡ç¨‹ã€‚æ‰«æapkå…¶ä¸­æœ€é‡è¦çš„ä¸€æ­¥æ˜¯éœ€è¦æŠŠapkä¸­AndroidManifestæ–‡ä»¶è§£æå‡ºæ¥ï¼Œåœ¨æ‰«æè¿‡ç¨‹æ˜¯éœ€è¦ä½¿ç”¨åˆ°è®°å½•å­˜å‚¨æ¨¡å—æ¥åˆ¤æ–­æŸä¸ªapkæ˜¯å¦å·²ç»å®‰è£…ï¼ŒåŒæ—¶è¿˜ä¼šç”¨åˆ°å…±äº«åº“æ¨¡å—æ¥åˆ¤æ–­æ˜¯å¦æœ‰å¯¹åº”çš„å…±äº«åº“æ›´æ–°ï¼ŒåŒæ—¶ä¹Ÿä¼šç”¨åˆ°æƒé™ç®¡ç†æ¨¡å—æ¥åˆ¤æ–­æ¯”å¦‚æ˜¯å¦æœ‰æ–°å£°æ˜çš„æƒé™åŠ å…¥ã€‚ä¸‹é¢æ˜¯æ‰«æapkçš„å¯¹åº”ä»£ç ï¼š //ä¸‹é¢ä»£ç ä½äºPackageManagerServiceæ„é€ æ–¹æ³•ä¸­ finalÂ int[]Â userIdsÂ =Â mUserManager.getUserIds(); PackageParser2Â packageParserÂ =Â mInjector.getScanningCachingPackageParser(); //æ‰«æç³»ç»Ÿapk mOverlayConfigÂ =Â mInitAppsHelper.initSystemApps(packageParser,Â packageSettings,Â userIds,startTime);Â //æ‰«æéç³»ç»Ÿapk mInitAppsHelper.initNonSystemApps(packageParser,Â userIds,Â startTime);Â packageParser.close(); æ‰«æapkåï¼Œæ‰€æœ‰apkä¿¡æ¯æ¨¡å—å’Œå››å¤§ç»„ä»¶æ¨¡å—æŠŠæ‰€æœ‰å·²å®‰è£…apkçš„ä¿¡æ¯æ”¶é›†èµ·æ¥ï¼Œå½“ç„¶å…¶ä»–çš„æ¨¡å—ä¹Ÿä¼šè¿›è¡Œç›¸åº”çš„æ›´æ–°ã€‚ ","date":"2024-11-06","objectID":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/:13:0","tags":["clippings","è½¬è½½","blog"],"title":"PackageManagerServiceå’Œå®ƒçš„6ä¸ªâ€œå°ä¼™ä¼´â€","uri":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/#44-æ‰«æapk"},{"categories":null,"collections":"PMS","content":"4.5 å°ç»“ ä»¥ä¸Šå°±æ˜¯æˆ‘PMSå¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œæ¨¡å—ä¹‹é—´åˆå§‹åŒ–å’Œäº’ç›¸å½±å“çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œå½“ç„¶ä¸Šé¢åªæ˜¯åˆ—äº†å…³é”®æ¨¡å—ï¼Œæˆ‘çš„å¯åŠ¨è¿‡ç¨‹å¯ä¸æ˜¯åªæœ‰è¿™ä¹ˆç®€å•ï¼Œè¿˜æœ‰å…¶ä»–è¿‡ç¨‹å°±ä¸èµ˜è¿°äº†ã€‚ 5 æ€»ç»“ æœ¬æ–‡ä¸»è¦å¸¦å¤§å®¶è®¤è¯†äº†PackageManagerServiceï¼Œå®ƒæ˜¯ä¸€ä¸ªè¿è¡Œäºsystemserverè¿›ç¨‹çš„ç®¡ç†apkçš„æœåŠ¡ï¼Œè¿˜å¸¦å¤§å®¶è®¤è¯†äº†å®ƒçš„â€œå°ä¼™ä¼´â€æƒé™ç®¡ç†æ¨¡å—ã€å…±äº«åº“æ¨¡å—ã€æ‰€æœ‰apkä¿¡æ¯æ¨¡å—ã€å››å¤§ç»„ä»¶æ¨¡å—ã€è®°å½•å­˜å‚¨æ¨¡å—ã€apkç®¡ç†æ¨¡å—ï¼Œåœ¨åé¢çš„æ–‡ç« è¿™äº›æ¨¡å—è¿˜ä¼šä¸å¤§å®¶è§é¢ã€‚ è¿™æ˜¯åŒ…ç®¡ç†çš„ç¬¬ä¸€ç¯‡ï¼Œæ•¬è¯·æœŸå¾…æˆ‘çš„ç¬¬äºŒç¯‡ï¼Œè°¢è°¢ï¼ æœ€åæ¨èä¸€ä¸‹æˆ‘åšçš„ç½‘ç«™ï¼Œç©Android:Â wanandroid.comÂ ï¼ŒåŒ…å«è¯¦å°½çš„çŸ¥è¯†ä½“ç³»ã€å¥½ç”¨çš„å·¥å…·ï¼Œè¿˜æœ‰æœ¬å…¬ä¼—å·æ–‡ç« åˆé›†ï¼Œæ¬¢è¿ä½“éªŒå’Œæ”¶è—ï¼ ","date":"2024-11-06","objectID":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/:14:0","tags":["clippings","è½¬è½½","blog"],"title":"PackageManagerServiceå’Œå®ƒçš„6ä¸ªâ€œå°ä¼™ä¼´â€","uri":"/posts/packagemanagerservice%E5%92%8C%E5%AE%83%E7%9A%846%E4%B8%AA%E5%B0%8F%E4%BC%99%E4%BC%B4/#45-å°ç»“"},{"categories":null,"collections":["WMS","Framework"],"content":"èƒŒæ™¯ å‰é¢æ–‡ç« å’Œè§†é¢‘è¯¾ç¨‹éƒ½æ˜¯ç›´æ¥ä»SurfaceFlingerå±‚é¢å¼€å§‹è®²è§£Vsyncéƒ¨åˆ†çš„ï¼Œå½“ç„¶vsyncçš„ä¸»è¦æ ¸å¿ƒé€»è¾‘ä¹Ÿç¡®å®åœ¨SurfaceFlingerï¼Œä½†æ˜¯ä¸€èˆ¬vsyncéƒ½æ˜¯ç”±appå±‚é¢å‘èµ·è¯·æ±‚çš„ï¼Œè¿™ä¸€éƒ¨åˆ†ä¹Ÿè¿˜æ˜¯æœ‰å¿…è¦å¸¦å¤§å®¶äº†è§£æ¸…æ¥š ","date":"2024-11-06","objectID":"/posts/vsync%E4%B9%8Bapp%E5%B1%82%E9%9D%A2%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90-vsynceventdata-csdn%E5%8D%9A%E5%AE%A2/:0:1","tags":["clippings","è½¬è½½","WMS","blog"],"title":"Vsyncä¹‹appå±‚é¢æ·±å…¥åˆ†æ  vsynceventdata-CSDNåšå®¢","uri":"/posts/vsync%E4%B9%8Bapp%E5%B1%82%E9%9D%A2%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90-vsynceventdata-csdn%E5%8D%9A%E5%AE%A2/#èƒŒæ™¯"},{"categories":null,"collections":["WMS","Framework"],"content":"javaå±‚é¢çš„åˆ†æå’Œå †æ ˆï¼š åœ¨Activityè¿›è¡ŒResumeæ—¶å€™ï¼Œä¼šaddView,è¿™ä¸ªæ—¶å€™ä¼šå¯¹ViewRootImplè¿›è¡Œå¤Ÿç€ï¼Œæ„å»ºå‡ºä¸€ä¸ªChoreographerï¼Œåœ¨æ„é€ æ—¶å€™ä¼šæ„é€ æ–¹æ³•é‡Œé¢åˆä¼šå¯¹åº”çš„FrameDisplayEventReceiverï¼ŒFrameDisplayEventReceiveræœ¬èº«ç»§æ‰¿DisplayEventReceiver è¿™é‡Œçš„DisplayEventReceiverå°±æ˜¯æ ¸å¿ƒéƒ¨åˆ†ï¼Œå®ƒè´Ÿè´£å’Œsfè¿›è¡ŒåŒå‘é€šè®¯ï¼Œä¸è¿‡è¿™é‡ŒåŒå‘ä¸æ˜¯ä¸€ç§ipcé€šè®¯æ–¹å¼ï¼Œæ¶‰åŠåˆ°ä¸¤ä¸ªæ–¹å¼ appä¸»åŠ¨å‘èµ·è¯·æ±‚ä¸€èˆ¬éƒ½æ˜¯ç›´æ¥ä½¿ç”¨binderè°ƒç”¨ï¼Œæ¯”å¦‚å¸¸è§çš„å¦‚ä¸‹å‡ ä¸ªæ¥å£ï¼š interface IDisplayEventConnection { /* * stealReceiveChannel() returns a BitTube to receive events from. Only the receive file * descriptor of outChannel will be initialized, and this effectively \"steals\" the receive * channel from the remote end (such that the remote end can only use its send channel). */ void stealReceiveChannel(out BitTube outChannel); /* * setVsyncRate() sets the vsync event delivery rate. A value of 1 returns every vsync event. * A value of 2 returns every other event, etc. A value of 0 returns no event unless * requestNextVsync() has been called. */ void setVsyncRate(in int count); /* * requestNextVsync() schedules the next vsync event. It has no effect if the vsync rate is \u003e 0. */ oneway void requestNextVsync(); // Asynchronous /* * getLatestVsyncEventData() gets the latest vsync event data. */ ParcelableVsyncEventData getLatestVsyncEventData(); } SurfaceFlingerè¿›ç¨‹ä¹Ÿéœ€è¦ä¸appè¿›è¡Œé€šè®¯ï¼Œæ¯”å¦‚æŠŠvsyncæ¥ä¸´è¿™ç§é€šçŸ¥è°ƒç”¨ï¼š è¿™é‡Œä¸ºå•¥sfè¦æ˜¯æœ‰socketå‘¢ï¼Ÿè¿™é‡Œä¸»è¦è¿˜æ˜¯ä¸ºäº†æ€§èƒ½è€ƒè™‘ï¼Œsocketç›¸æ¯”å»¶æ—¶é˜»å¡æƒ…å†µæ¯”binderå¥½ï¼Œvsyncé€šçŸ¥è¿™ç§å±äºå®æ—¶æ€§è¾ƒå¼ºçš„æ“ä½œã€‚ ä¸‹é¢æ¥ç€çœ‹çœ‹appå±‚é¢FrameDisplayEventReceiveræ„é€ æ¥ä¸‹æ¥å¹²äº†å•¥ public FrameDisplayEventReceiver(Looper looper, int vsyncSource) { super(looper, vsyncSource, 0);//ç›´æ¥è°ƒç”¨äº†çˆ¶ç±»çš„æ„é€  } /** * Creates a display event receiver. * * @param looper The looper to use when invoking callbacks. * @param vsyncSource The source of the vsync tick. Must be on of the VSYNC_SOURCE_* values. * @param eventRegistration Which events to dispatch. Must be a bitfield consist of the * EVENT_REGISTRATION_*_FLAG values. */ public DisplayEventReceiver(Looper looper, int vsyncSource, int eventRegistration) { mMessageQueue = looper.getQueue(); mReceiverPtr = nativeInit(new WeakReference\u003cDisplayEventReceiver\u003e(this), mMessageQueue, vsyncSource, eventRegistration); } è¿™é‡Œè°ƒç”¨äº†nativeInitï¼Œæ¥ä¸‹æ¥ä»£ç å°±åˆ°äº†nativeå±‚é¢äº† å…·ä½“å †æ ˆå¦‚ä¸‹ï¼š ","date":"2024-11-06","objectID":"/posts/vsync%E4%B9%8Bapp%E5%B1%82%E9%9D%A2%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90-vsynceventdata-csdn%E5%8D%9A%E5%AE%A2/:0:2","tags":["clippings","è½¬è½½","WMS","blog"],"title":"Vsyncä¹‹appå±‚é¢æ·±å…¥åˆ†æ  vsynceventdata-CSDNåšå®¢","uri":"/posts/vsync%E4%B9%8Bapp%E5%B1%82%E9%9D%A2%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90-vsynceventdata-csdn%E5%8D%9A%E5%AE%A2/#javaå±‚é¢çš„åˆ†æå’Œå †æ ˆ"},{"categories":null,"collections":["WMS","Framework"],"content":"nativeå±‚é¢çš„åˆ†æå’Œå †æ ˆï¼š æ¥ä¸Šé¢çš„nativeInit frameworks/base/core/jni/android_view_DisplayEventReceiver.cpp static jlong nativeInit(JNIEnv* env, jclass clazz, jobject receiverWeak, jobject messageQueueObj, jint vsyncSource, jint eventRegistration) { //çœç•¥éƒ¨åˆ† sp\u003cNativeDisplayEventReceiver\u003e receiver = new NativeDisplayEventReceiver(env, receiverWeak, messageQueue, vsyncSource, eventRegistration); status_t status = receiver-\u003einitialize(); //çœç•¥éƒ¨åˆ† return reinterpret_cast\u003cjlong\u003e(receiver.get()); } æ„é€  NativeDisplayEventReceiverç±»ï¼š NativeDisplayEventReceiver::NativeDisplayEventReceiver(JNIEnv* env, jobject receiverWeak, const sp\u003cMessageQueue\u003e\u0026 messageQueue, jint vsyncSource, jint eventRegistration) : DisplayEventDispatcher(messageQueue-\u003egetLooper(), static_cast\u003cISurfaceComposer::VsyncSource\u003e(vsyncSource), static_cast\u003cISurfaceComposer::EventRegistration\u003e(eventRegistration)), mReceiverWeakGlobal(env-\u003eNewGlobalRef(receiverWeak)), mMessageQueue(messageQueue) { } æ³¨æ„è¿™é‡Œçš„NativeDisplayEventReceiverç»§æ‰¿DisplayEventDispatcher DisplayEventDispatcher::DisplayEventDispatcher( const sp\u003cLooper\u003e\u0026 looper, ISurfaceComposer::VsyncSource vsyncSource, ISurfaceComposer::EventRegistrationFlags eventRegistration) : mLooper(looper), mReceiver(vsyncSource, eventRegistration), mWaitingForVsync(false), mLastVsyncCount(0), mLastScheduleVsyncTime(0) { ALOGV(\"dispatcher %p ~ Initializing display event dispatcher.\", this); } æ³¨æ„è¿™é‡Œçš„DisplayEventDispatcheræ„é€ ä¹Ÿä¼šmReceiverä¹Ÿæ„é€ ï¼Œ mReceiveræ˜¯DisplayEventReceiver ç±»å‹ï¼Œæ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š DisplayEventReceiver::DisplayEventReceiver( ISurfaceComposer::VsyncSource vsyncSource, ISurfaceComposer::EventRegistrationFlags eventRegistration) { sp\u003cISurfaceComposer\u003e sf(ComposerService::getComposerService()); if (sf != nullptr) { //ä¼šä¸sfè¿›è¡Œè·¨è¿›ç¨‹é€šè®¯ï¼Œè®©åˆ›å»ºå¯¹åº”connection mEventConnection = sf-\u003ecreateDisplayEventConnection(vsyncSource, eventRegistration); if (mEventConnection != nullptr) { mDataChannel = std::make_unique\u003cgui::BitTube\u003e(); //connectionåˆ›å»ºæˆåŠŸï¼Œè¿™é‡Œå°±ä¼šè°ƒç”¨mEventConnectionçš„stealReceiveChannelè·å–é€šè®¯çš„socketçš„fd const auto status = mEventConnection-\u003estealReceiveChannel(mDataChannel.get()); } } } è¿™é‡Œå¯ä»¥çœ‹å‡ºæ¥å’Œsfé€šè®¯å¼€å§‹ç”¨mEventConnectionå•¦ initializeä¸»è¦å¹²çš„äº‹å¦‚ä¸‹ï¼š status_t DisplayEventDispatcher::initialize() { if (mLooper != nullptr) { int rc = mLooper-\u003eaddFd(mReceiver.getFd(), 0, Looper::EVENT_INPUT, this, NULL); if (rc \u003c 0) { return UNKNOWN_ERROR; } } return OK; } æŠŠå¯¹åº”çš„æœåŠ¡ç«¯sfä¼ é€’socketçš„fdè¿›è¡Œè¾“å…¥äº‹ä»¶ç›‘å¬ï¼Œè¿™æ ·sfæœ‰å¾€socketå†™å…¥æ•°æ®ï¼Œappæ—¢å¯ä»¥æ¥å—åˆ°äº† ","date":"2024-11-06","objectID":"/posts/vsync%E4%B9%8Bapp%E5%B1%82%E9%9D%A2%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90-vsynceventdata-csdn%E5%8D%9A%E5%AE%A2/:0:3","tags":["clippings","è½¬è½½","WMS","blog"],"title":"Vsyncä¹‹appå±‚é¢æ·±å…¥åˆ†æ  vsynceventdata-CSDNåšå®¢","uri":"/posts/vsync%E4%B9%8Bapp%E5%B1%82%E9%9D%A2%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90-vsynceventdata-csdn%E5%8D%9A%E5%AE%A2/#nativeå±‚é¢çš„åˆ†æå’Œå †æ ˆ"},{"categories":null,"collections":["WMS","Framework"],"content":"SurfaceFlingerç«¯çš„ç›¸å…³æ–¹æ³•åˆ†æ createDisplayEventConnectionæ–¹æ³•,è¿™ä¸ªæ–¹æ³•appå‘èµ·è·¨è¿›ç¨‹è°ƒç”¨åä¼šåˆ°æœåŠ¡ç«¯BnSurfaceComposerï¼Œè¿™ä¸ªSurfaceFlingeræ˜¯ç»§æ‰¿è¿™ä¸ªBnSurfaceComposerçš„ class BnSurfaceComposer: public BnInterface\u003cISurfaceComposer\u003e class SurfaceFlinger : public BnSurfaceComposer, public PriorityDumper, private IBinder::DeathRecipient, private HWC2::ComposerCallback, private ICompositor, private scheduler::ISchedulerCallback { æ‰€ä»¥è¿™é‡Œç›´æ¥çœ‹SurfaceFlingerçš„createDisplayEventConnection sp\u003cIDisplayEventConnection\u003e SurfaceFlinger::createDisplayEventConnection( ISurfaceComposer::VsyncSource vsyncSource, ISurfaceComposer::EventRegistrationFlags eventRegistration) { //è¿™é‡Œå‚æ•°æœ‰ä¸€ä¸ªvsyncSourceå°±æ˜¯appè¿˜æ˜¯appSfä¸¤ä¸ªï¼Œä»¥å‰æ²¡æœ‰appSfï¼Œè¿™ä¸ªå‚æ•°æ¥é€‰ç€å“ªä¸ªEventThread const auto\u0026 handle = vsyncSource == eVsyncSourceSurfaceFlinger ? mSfConnectionHandle : mAppConnectionHandle; return mScheduler-\u003ecreateDisplayEventConnection(handle, eventRegistration); } å†çœ‹çœ‹Scheduler::createDisplayEventConnection sp\u003cIDisplayEventConnection\u003e Scheduler::createDisplayEventConnection( ConnectionHandle handle, ISurfaceComposer::EventRegistrationFlags eventRegistration) { return createConnectionInternal(mConnections[handle].thread.get(), eventRegistration); } sp\u003cEventThreadConnection\u003e Scheduler::createConnectionInternal( EventThread* eventThread, ISurfaceComposer::EventRegistrationFlags eventRegistration) { return eventThread-\u003ecreateEventConnection([\u0026] { resync(); }, eventRegistration); } sp\u003cEventThreadConnection\u003e EventThread::createEventConnection( ResyncCallback resyncCallback, ISurfaceComposer::EventRegistrationFlags eventRegistration) const { //åˆ›å»ºå¯¹åº”çš„EventThreadConnectionå¯¹è±¡ return new EventThreadConnection(const_cast\u003cEventThread*\u003e(this), IPCThreadState::self()-\u003egetCallingUid(), std::move(resyncCallback), eventRegistration); } å¯ä»¥çœ‹åˆ°æœ€åå…¶å®æ˜¯æ„é€ äº†ä¸€ä¸ªEventThreadConnectionå¯¹è±¡ class EventThreadConnection : public gui::BnDisplayEventConnection { public: EventThreadConnection(EventThread*, uid_t callingUid, ResyncCallback, ISurfaceComposer::EventRegistrationFlags eventRegistration = {}); virtual status_t postEvent(const DisplayEventReceiver::Event\u0026 event); binder::Status stealReceiveChannel(gui::BitTube* outChannel) override; binder::Status setVsyncRate(int rate) override; binder::Status requestNextVsync() override; // asynchronous binder::Status getLatestVsyncEventData(ParcelableVsyncEventData* outVsyncEventData) override; }; ä¸Šé¢å°±æ˜¯å®ƒå‡ ä¸ªä¸»è¦æ–¹æ³•ï¼Œå°±æ˜¯appå’Œsfé€šè¿‡è¿™ä¸ªEventThreadConnectionè¿›è¡Œé€šè®¯çš„æ¥å£æ–¹æ³• åŒæ—¶æ³¨æ„ä¸€ä¸‹EventThreadConnectionçš„onFirstRefæ–¹æ³• void EventThreadConnection::onFirstRef() { mEventThread-\u003eregisterDisplayEventConnection(this); } è¿™é‡Œè°ƒç”¨äº†EventThreadçš„registerDisplayEventConnectionæ–¹æ³• status_t EventThread::registerDisplayEventConnection(const sp\u003cEventThreadConnection\u003e\u0026 connection) { std::lock_guard\u003cstd::mutex\u003e lock(mMutex); mDisplayEventConnections.push_back(connection); mCondition.notify_all(); return NO_ERROR; } è¿™é‡Œä¸»è¦å°±æ˜¯æŠŠæ¯ä¸ªappçš„connectionéƒ½æ”¾åˆ°äº†mDisplayEventConnectionsè¿™ä¸ªå˜é‡ä¸­ æ¥ä¸‹æ¥çœ‹çœ‹å¯¹åº”çš„stealReceiveChannelçš„æ¥å£æ–¹æ³• binder::Status EventThreadConnection::stealReceiveChannel(gui::BitTube* outChannel) { outChannel-\u003esetReceiveFd(mChannel.moveReceiveFd()); outChannel-\u003esetSendFd(base::unique_fd(dup(mChannel.getSendFd()))); return binder::Status::ok(); } å¯ä»¥çœ‹å‡ºè¿™é‡Œä¸»è¦æ˜¯æŠŠEventThreadConnectionçš„mChannelçš„fdæåˆ°outChannelçš„fdå…·ä½“mChannelå…¶å®æ˜¯ä¸ªBitTubeç±»å‹ BitTube::BitTube(size_t bufsize) : mSendFd(-1), mReceiveFd(-1) { init(bufsize, bufsize);//è°ƒç”¨æ˜¯initæ–¹æ³• } void BitTube::init(size_t rcvbuf, size_t sndbuf) { int sockets[2]; //å…¶å®æœ¬è´¨æ˜¯æœ‰ä¸€å¯¹socketpair if (socketpair(AF_UNIX, SOCK_SEQPACKET, 0, sockets) == 0) { size_t size = DEFAULT_SOCKET_BUFFER_SIZE; setsockopt(sockets[0], SOL_SOCKET, SO_RCVBUF, \u0026rcvbuf, sizeof(rcvbuf)); setsockopt(sockets[1], SOL_SOCKET, SO_SNDBUF, \u0026sndbuf, sizeof(sndbuf)); // sine we don't use the \"return channel\", we keep it small... setsockopt(sockets[0], SOL_SOCKET, SO_SNDBUF, \u0026size, sizeof(size)); setsockopt(sockets[1], SOL_SOCKET, SO_RCVBUF, \u0026size, sizeof(size)); fcntl(sockets[0], F_SETFL, O_NONBLOCK); fcntl(sockets[1], F_SETFL, O_NONBLOCK); mReceiveFd = sockets[0]; mSendFd = sockets[1]; } else { mRe","date":"2024-11-06","objectID":"/posts/vsync%E4%B9%8Bapp%E5%B1%82%E9%9D%A2%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90-vsynceventdata-csdn%E5%8D%9A%E5%AE%A2/:0:4","tags":["clippings","è½¬è½½","WMS","blog"],"title":"Vsyncä¹‹appå±‚é¢æ·±å…¥åˆ†æ  vsynceventdata-CSDNåšå®¢","uri":"/posts/vsync%E4%B9%8Bapp%E5%B1%82%E9%9D%A2%E6%B7%B1%E5%85%A5%E5%88%86%E6%9E%90-vsynceventdata-csdn%E5%8D%9A%E5%AE%A2/#surfaceflingerç«¯çš„ç›¸å…³æ–¹æ³•åˆ†æ"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"BufferQueueConsumerçš„acquireBufferæ–¹æ³•çš„ä¸»è¦ä½œç”¨æ˜¯ä»BufferQueueä¸­è·å–ä¸€ä¸ªå¯ç”¨çš„å›¾åƒç¼“å†²åŒºï¼Œå¹¶è¿”å›ä¸€ä¸ªGraphicBufferå¯¹è±¡ã€‚å®ƒå¯ä»¥ç”¨äºåœ¨åº”ç”¨ç¨‹åºä¸­è¿›è¡Œå›¾åƒå¤„ç†ã€æ¸²æŸ“æˆ–æ˜¾ç¤ºç­‰æ“ä½œã€‚ åœ¨è°ƒç”¨acquireBufferæ–¹æ³•æ—¶ï¼Œå®ƒä¼šé¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„å›¾åƒç¼“å†²åŒºã€‚å¦‚æœæœ‰å¯ç”¨çš„ç¼“å†²åŒºï¼Œåˆ™ä¼šå°†å…¶æ ‡è®°ä¸ºâ€œå·²ä½¿ç”¨â€ï¼Œå¹¶è¿”å›è¯¥ç¼“å†²åŒºçš„GraphicBufferå¯¹è±¡ã€‚å¦‚æœæ²¡æœ‰å¯ç”¨çš„ç¼“å†²åŒºï¼Œåˆ™ä¼šç­‰å¾…ç›´åˆ°æœ‰å¯ç”¨çš„ç¼“å†²åŒºä¸ºæ­¢ã€‚ BufferQueueConsumerçš„acquireBufferæ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š //frameworks/native/libs/gui/BufferQueueConsumer.cpp status_t BufferQueueConsumer::acquireBuffer(BufferItem* outBuffer, nsecs_t expectedPresent, uint64_t maxFrameNumber) { ATRACE_CALL(); int numDroppedBuffers = 0; sp\u003cIProducerListener\u003e listener; { std::unique_lock\u003cstd::mutex\u003e lock(mCore-\u003emMutex); // Check that the consumer doesn't currently have the maximum number of // buffers acquired. We allow the max buffer count to be exceeded by one // buffer so that the consumer can successfully set up the newly acquired // buffer before releasing the old one. int numAcquiredBuffers = 0; for (int s : mCore-\u003emActiveBuffers) { if (mSlots[s].mBufferState.isAcquired()) { ++numAcquiredBuffers; } } const bool acquireNonDroppableBuffer = mCore-\u003emAllowExtraAcquire \u0026\u0026 numAcquiredBuffers == mCore-\u003emMaxAcquiredBufferCount + 1; if (numAcquiredBuffers \u003e= mCore-\u003emMaxAcquiredBufferCount + 1 \u0026\u0026 !acquireNonDroppableBuffer) { BQ_LOGE(\"acquireBuffer: max acquired buffer count reached: %d (max %d)\", numAcquiredBuffers, mCore-\u003emMaxAcquiredBufferCount); return INVALID_OPERATION; } bool sharedBufferAvailable = mCore-\u003emSharedBufferMode \u0026\u0026 mCore-\u003emAutoRefresh \u0026\u0026 mCore-\u003emSharedBufferSlot != BufferQueueCore::INVALID_BUFFER_SLOT; // In asynchronous mode the list is guaranteed to be one buffer deep, // while in synchronous mode we use the oldest buffer. if (mCore-\u003emQueue.empty() \u0026\u0026 !sharedBufferAvailable) { return NO_BUFFER_AVAILABLE; } BufferQueueCore::Fifo::iterator front(mCore-\u003emQueue.begin()); // If expectedPresent is specified, we may not want to return a buffer yet. // If it's specified and there's more than one buffer queued, we may want // to drop a buffer. // Skip this if we're in shared buffer mode and the queue is empty, // since in that case we'll just return the shared buffer. if (expectedPresent != 0 \u0026\u0026 !mCore-\u003emQueue.empty()) { // The 'expectedPresent' argument indicates when the buffer is expected // to be presented on-screen. If the buffer's desired present time is // earlier (less) than expectedPresent -- meaning it will be displayed // on time or possibly late if we show it as soon as possible -- we // acquire and return it. If we don't want to display it until after the // expectedPresent time, we return PRESENT_LATER without acquiring it. // // To be safe, we don't defer acquisition if expectedPresent is more // than one second in the future beyond the desired present time // (i.e., we'd be holding the buffer for a long time). // // NOTE: Code assumes monotonic time values from the system clock // are positive. // Start by checking to see if we can drop frames. We skip this check if // the timestamps are being auto-generated by Surface. If the app isn't // generating timestamps explicitly, it probably doesn't want frames to // be discarded based on them. while (mCore-\u003emQueue.size() \u003e 1 \u0026\u0026 !mCore-\u003emQueue[0].mIsAutoTimestamp) { const BufferItem\u0026 bufferItem(mCore-\u003emQueue[1]); // If dropping entry[0] would leave us with a buffer that the // consumer is not yet ready for, don't drop it. if (maxFrameNumber \u0026\u0026 bufferItem.mFrameNumber \u003e maxFrameNumber) { break; } // If entry[1] is timely, drop entry[0] (and repeat). We apply an // additional criterion here: we only drop the earlier buffer if our // desiredPresent falls within +/- 1 second of the expected present. // Otherwise, bogus desiredPresent times (e.g., 0 or a small // relative timestamp), which normally mean \"ignore the timestamp // and acquire immediately\", would cause us to drop frames. // // We may want to add an additional criterion: don't drop the // earlier buffer if entry[1]'s fence hasn't signaled yet. nsecs_t desiredPresent = bufferItem.mTimestamp; if (desiredPresent \u003c expectedPresent - MAX_REASONABLE_NSEC || desiredPres","date":"2024-11-06","objectID":"/posts/android13-bufferqueueconsumer-acquirebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 BufferQueueConsumer acquireBufferæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueueconsumer-acquirebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"BufferQueueConsumerçš„releaseBufferæ–¹æ³•ç”¨äºé‡Šæ”¾å›¾å½¢ç¼“å†²åŒºã€‚ å½“åº”ç”¨ç¨‹åºä½¿ç”¨å›¾å½¢ç¼“å†²åŒºè¿›è¡Œç»˜åˆ¶æˆ–æ¸²æŸ“æ“ä½œæ—¶ï¼Œéœ€è¦ä»BufferQueueConsumerä¸­è·å–å¯ç”¨çš„ç¼“å†²åŒºã€‚ä½¿ç”¨å®Œæ¯•åï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨releaseBufferæ–¹æ³•å°†ç¼“å†²åŒºé‡Šæ”¾å›ç»™BufferQueueConsumerã€‚ releaseBufferæ–¹æ³•çš„ä½œç”¨æ˜¯å°†æŒ‡å®šçš„ç¼“å†²åŒºæ·»åŠ åˆ°å¯ç”¨ç¼“å†²åŒºé˜Ÿåˆ—ä¸­ï¼Œä»¥ä¾¿å…¶ä»–åº”ç”¨ç¨‹åºæˆ–ç³»ç»Ÿå¯ä»¥ç»§ç»­ä½¿ç”¨è¯¥ç¼“å†²åŒºè¿›è¡Œç»˜åˆ¶æˆ–æ¸²æŸ“æ“ä½œã€‚é‡Šæ”¾ç¼“å†²åŒºåï¼Œåº”ç”¨ç¨‹åºä¸å†æ‹¥æœ‰è¯¥ç¼“å†²åŒºçš„æ‰€æœ‰æƒã€‚ BufferQueueConsumerçš„releaseBufferæ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š //frameworks/native/lib/gui/BufferQueueConsumer.cpp status_t BufferQueueConsumer::releaseBuffer(int slot, uint64_t frameNumber, const sp\u003cFence\u003e\u0026 releaseFence, EGLDisplay eglDisplay, EGLSyncKHR eglFence) { ATRACE_CALL(); ATRACE_BUFFER_INDEX(slot); if (slot \u003c 0 || slot \u003e= BufferQueueDefs::NUM_BUFFER_SLOTS || releaseFence == nullptr) { BQ_LOGE(\"releaseBuffer: slot %d out of range or fence %p NULL\", slot, releaseFence.get()); return BAD_VALUE; } sp\u003cIProducerListener\u003e listener; { // Autolock scope std::lock_guard\u003cstd::mutex\u003e lock(mCore-\u003emMutex); // If the frame number has changed because the buffer has been reallocated, // we can ignore this releaseBuffer for the old buffer. // Ignore this for the shared buffer where the frame number can easily // get out of sync due to the buffer being queued and acquired at the // same time. if (frameNumber != mSlots[slot].mFrameNumber \u0026\u0026 !mSlots[slot].mBufferState.isShared()) { return STALE_BUFFER_SLOT; } if (!mSlots[slot].mBufferState.isAcquired()) { BQ_LOGE(\"releaseBuffer: attempted to release buffer slot %d \" \"but its state was %s\", slot, mSlots[slot].mBufferState.string()); return BAD_VALUE; } mSlots[slot].mEglDisplay = eglDisplay; mSlots[slot].mEglFence = eglFence; mSlots[slot].mFence = releaseFence; mSlots[slot].mBufferState.release(); // After leaving shared buffer mode, the shared buffer will // still be around. Mark it as no longer shared if this // operation causes it to be free. if (!mCore-\u003emSharedBufferMode \u0026\u0026 mSlots[slot].mBufferState.isFree()) { mSlots[slot].mBufferState.mShared = false; } // Don't put the shared buffer on the free list. if (!mSlots[slot].mBufferState.isShared()) { mCore-\u003emActiveBuffers.erase(slot); mCore-\u003emFreeBuffers.push_back(slot); } if (mCore-\u003emBufferReleasedCbEnabled) { listener = mCore-\u003emConnectedProducerListener; } BQ_LOGV(\"releaseBuffer: releasing slot %d\", slot); mCore-\u003emDequeueCondition.notify_all(); VALIDATE_CONSISTENCY(); } // Autolock scope // Call back without lock held if (listener != nullptr) { listener-\u003eonBufferReleased(); } return NO_ERROR; } ","date":"2024-11-06","objectID":"/posts/android13-bufferqueueconsumer-releasebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 BufferQueueConsumer releaseBufferæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueueconsumer-releasebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"BufferQueueLayeræ˜¯Androidç³»ç»Ÿä¸­çš„ä¸€ä¸ªå›¾å±‚ï¼Œç”¨äºç®¡ç†å›¾åƒç¼“å†²åŒºçš„é˜Ÿåˆ—ã€‚å®ƒæ˜¯SurfaceFlingerç³»ç»ŸæœåŠ¡çš„ä¸€éƒ¨åˆ†ï¼Œè´Ÿè´£æ¥æ”¶åº”ç”¨ç¨‹åºæˆ–ç³»ç»Ÿç»„ä»¶æäº¤çš„å›¾åƒç¼“å†²åŒºï¼Œå¹¶å°†å…¶æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚onFirstRefæ˜¯BufferQueueLayerç±»çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå®ƒæ˜¯åœ¨ç¬¬ä¸€æ¬¡å¼•ç”¨BufferQueueLayerå¯¹è±¡æ—¶è¢«è°ƒç”¨çš„ã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œå¯ä»¥è¿›è¡Œä¸€äº›åˆå§‹åŒ–æ“ä½œï¼Œä¾‹å¦‚åˆ›å»ºå’Œé…ç½®å›¾åƒç¼“å†²åŒºé˜Ÿåˆ—ã€‚ åœ¨åˆ›å»ºBufferQueueLayeråŒæ—¶ä¼šåˆ›å»ºä¸€å¥—ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹æ¶æ„ï¼Œæ ¸å¿ƒæ˜¯å¦‚ä¸‹å‡ ä¸ªç±»ï¼š BufferQueueLayerï¼šåˆ›å»ºäº†BufferQueueã€MonitoredProducerã€BufferLayerConsumer BufferQueueï¼šbufferé˜Ÿåˆ—ï¼Œåˆ›å»ºBufferQueueCoreï¼ŒBufferQueueProducer BufferQueueProducerï¼šç”Ÿäº§è€… BufferQueueConsumerï¼šæ¶ˆè´¹è€… MonitoredProducerï¼šç”Ÿäº§è€…çš„å°è£… BufferLayerConsumerï¼šæ¶ˆè´¹è€…çš„å°è£… ç”Ÿäº§è€…æä¾›å›¾å½¢æ•°æ®ï¼Œæ”¾å…¥BufferQueueï¼Œæ¶ˆè´¹è€…æ‹¿åˆ°å›¾å½¢æ•°æ®è¿›è¡Œåˆæˆï¼Œé€šå¸¸è®¤ä¸ºç”Ÿäº§è€…ä¸ºSurfaceï¼Œæ¶ˆè´¹è€…ä¸ºSurfaceFlingerï¼Œä¸‹é¢æˆ‘ä»¬å°±åˆ†æä¸€ä¸‹ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹æ¶æ„çš„æ­å»ºã€‚ BufferQueue æˆ‘ä»¬ä»¥BufferQueueLayerçš„åˆ›å»ºä¸ºå…¥å£åˆ†æï¼š //frameworks/native/services/surfaceflinger/BufferQueueLayer.cpp void BufferQueueLayer::onFirstRef() { BufferLayer::onFirstRef(); sp\u003cIGraphicBufferProducer\u003e producer; sp\u003cIGraphicBufferConsumer\u003e consumer; //æ­¥éª¤1 BufferQueue::createBufferQueue(\u0026producer, \u0026consumer, true); //åˆ›å»ºBufferQueue //æ­¥éª¤2 mProducer = new MonitoredProducer(producer, mFlinger, this); //åˆ›å»ºä¸€ä¸ªç”Ÿäº§è€… { // Grab the SF state lock during this since it's the only safe way to access RenderEngine Mutex::Autolock lock(mFlinger-\u003emStateLock); //æ­¥éª¤3 mConsumer = new BufferLayerConsumer(consumer, mFlinger-\u003egetRenderEngine(), mTextureName, this); //åˆ›å»ºä¸€ä¸ªæ¶ˆè´¹è€… { } //æ­¥éª¤4 mConsumer-\u003esetConsumerUsageBits(getEffectiveUsage(0)); //è®¾ç½®ç¼“å†²åŒºçš„ç±»å‹,ä¼šä¿å­˜åˆ°BufferQueueCoreä¸­çš„mConsumerUsageBitså˜é‡ä¸­ //æ­¥éª¤5 mConsumer-\u003esetContentsChangedListener(this); //è®¾ç½®ç¼“å†²åŒºå†…å®¹æ”¹å˜çš„ç›‘å¬å™¨ mConsumer-\u003esetName(mName); // BufferQueueCore::mMaxDequeuedBufferCount is default to 1 if (!mFlinger-\u003eisLayerTripleBufferingDisabled()) { mProducer-\u003esetMaxDequeuedBufferCount(2); } if (const auto display = mFlinger-\u003egetDefaultDisplayDevice()) { updateTransformHint(display); } if (mFlinger-\u003emLayerExt) { mLayerType = mFlinger-\u003emLayerExt-\u003egetLayerClass(mName.string()); } } ä¸Šé¢è¿™ä¸ªå‡½æ•°å°±æ˜¯åˆ›å»ºSurfaceFlingerç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹çš„æ ¸å¿ƒä»£ç ï¼Œæˆ‘ä»¬åˆ†æ­¥éª¤åˆ†æï¼š ","date":"2024-11-06","objectID":"/posts/android13-bufferqueuelayer-onfirstref%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","blog","è½¬è½½"],"title":"Android13 BufferQueueLayer onFirstRefæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueuelayer-onfirstref%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"BufferQueue createBufferQueue æ­¥éª¤1ï¼šcreateBufferQueueï¼Œä»åå­—çœ‹å°±èƒ½çŸ¥é“æ˜¯åˆ›å»ºBufferQueueï¼Œå¹¶ä¸”å°†ç”Ÿäº§è€…producerå’Œæ¶ˆè´¹è€…consumerçš„åœ°å€ä¼ äº†è¿‡å»ï¼Œæ˜¾ç„¶è¿™ä¸¤ä¸ªå¯¹è±¡ä¹Ÿä¼šåœ¨createBufferQueueä¸­åˆ›å»ºã€‚ //frameworks/native/libs/gui/BufferQueue.cpp void BufferQueue::createBufferQueue(sp\u003cIGraphicBufferProducer\u003e* outProducer, sp\u003cIGraphicBufferConsumer\u003e* outConsumer, bool consumerIsSurfaceFlinger) { sp\u003cBufferQueueCore\u003e core(new BufferQueueCore()); //åˆ›å»ºBufferQueueCore sp\u003cIGraphicBufferProducer\u003e producer(new BufferQueueProducer(core, consumerIsSurfaceFlinger)); //åˆ›å»ºBufferQueueProducer sp\u003cIGraphicBufferConsumer\u003e consumer(new BufferQueueConsumer(core)); //åˆ›å»ºBufferQueueConsumer *outProducer = producer; *outConsumer = consumer; } å¯ä»¥çœ‹åˆ°è¿™ä¸ªå‡½æ•°ä¸­å¹¶æ²¡æœ‰åˆ›å»ºBufferQueueï¼Œè€Œæ˜¯åˆ›å»ºçš„BufferQueueCoreï¼Œå¯è§BufferQueueçš„æ ¸å¿ƒå®ç°å…¶å®æ˜¯ä¾é BufferQueueCoreçš„ï¼Œæ¥ç€åˆåˆ›å»ºäº†ç”Ÿäº§è€…çš„å…·ä½“å®ç°ç±»BufferQueueProducerï¼Œæ¶ˆè´¹è€…çš„å…·ä½“å®ç°ç±»BufferQueueConsumerï¼Œå¹¶ä¸”è¿™ä¸¤ä¸ªç±»éƒ½æŒæœ‰BufferQueueCoreçš„å¼•ç”¨ï¼Œæœ€åoutProducerï¼ŒoutConsumeråˆ†åˆ«æŒ‡å‘åˆ›å»ºçš„ç”Ÿäº§è€…-æ¶ˆè´¹è€…ï¼Œä¸‹é¢åˆ†åˆ«è¿›è¡Œåˆ†æï¼š ","date":"2024-11-06","objectID":"/posts/android13-bufferqueuelayer-onfirstref%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","blog","è½¬è½½"],"title":"Android13 BufferQueueLayer onFirstRefæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueuelayer-onfirstref%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#bufferqueue-createbufferqueue"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"new BufferQueueCore åˆ›å»ºBufferQueueCoreå¯¹è±¡ï¼ŒBufferQueueCoreçš„æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š //frameworks/native/libs/gui/BufferQueueCore.cpp class BufferQueueCore : public virtual RefBase { BufferQueueCore::BufferQueueCore() : mMutex(), mIsAbandoned(false), mConsumerControlledByApp(false), mConsumerName(getUniqueName()), mConsumerListener(), mConsumerUsageBits(0), mConsumerIsProtected(false), mConnectedApi(NO_CONNECTED_API), mLinkedToDeath(), mConnectedProducerListener(), mBufferReleasedCbEnabled(false), mSlots(), mQueue(), mFreeSlots(), mFreeBuffers(), mUnusedSlots(), mActiveBuffers(), mDequeueCondition(), mDequeueBufferCannotBlock(false), mQueueBufferCanDrop(false), mLegacyBufferDrop(true), mDefaultBufferFormat(PIXEL_FORMAT_RGBA_8888), mDefaultWidth(1), mDefaultHeight(1), mDefaultBufferDataSpace(HAL_DATASPACE_UNKNOWN), mMaxBufferCount(BufferQueueDefs::NUM_BUFFER_SLOTS), mMaxAcquiredBufferCount(1), mMaxDequeuedBufferCount(1), mBufferHasBeenQueued(false), mFrameCounter(0), mTransformHint(0), mIsAllocating(false), mIsAllocatingCondition(), mAllowAllocation(true), mBufferAge(0), mGenerationNumber(0), mAsyncMode(false), mSharedBufferMode(false), mAutoRefresh(false), mSharedBufferSlot(INVALID_BUFFER_SLOT), mSharedBufferCache(Rect::INVALID_RECT, 0, NATIVE_WINDOW_SCALING_MODE_FREEZE, HAL_DATASPACE_UNKNOWN), mLastQueuedSlot(INVALID_BUFFER_SLOT), mUniqueId(getUniqueId()), mAutoPrerotation(false), mTransformHintInUse(0) { int numStartingBuffers = getMaxBufferCountLocked(); for (int s = 0; s \u003c numStartingBuffers; s++) { mFreeSlots.insert(s); } for (int s = numStartingBuffers; s \u003c BufferQueueDefs::NUM_BUFFER_SLOTS; s++) { mUnusedSlots.push_front(s); } } } ","date":"2024-11-06","objectID":"/posts/android13-bufferqueuelayer-onfirstref%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","blog","è½¬è½½"],"title":"Android13 BufferQueueLayer onFirstRefæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueuelayer-onfirstref%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#new-bufferqueuecore"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"new BufferQueueProducer åˆ›å»ºBufferQueueProducerå¯¹è±¡ï¼ŒBufferQueueProducerçš„æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š //frameworks/native/libs/gui/BufferQueueProducer.cpp class BufferQueueProducer : public BnGraphicBufferProducer, private IBinder::DeathRecipient { BufferQueueProducer::BufferQueueProducer(const sp\u003cBufferQueueCore\u003e\u0026 core, bool consumerIsSurfaceFlinger) : mCore(core), mSlots(core-\u003emSlots), mConsumerName(), mStickyTransform(0), mConsumerIsSurfaceFlinger(consumerIsSurfaceFlinger), mLastQueueBufferFence(Fence::NO_FENCE), mLastQueuedTransform(0), mCallbackMutex(), mNextCallbackTicket(0), mCurrentCallbackTicket(0), mCallbackCondition(), mDequeueTimeout(-1), mDequeueWaitingForAllocation(false) {} } ","date":"2024-11-06","objectID":"/posts/android13-bufferqueuelayer-onfirstref%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:2","tags":["clippings","blog","è½¬è½½"],"title":"Android13 BufferQueueLayer onFirstRefæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueuelayer-onfirstref%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#new-bufferqueueproducer"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"new BufferQueueConsumer åˆ›å»ºBufferQueueConsumerå¯¹è±¡ï¼ŒBufferQueueConsumerçš„æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š //frameworks/native/libs/gui/BufferQueueConsumer.cpp class BufferQueueConsumer : public BnGraphicBufferConsumer { BufferQueueConsumer::BufferQueueConsumer(const sp\u003cBufferQueueCore\u003e\u0026 core) : mCore(core), mSlots(core-\u003emSlots), mConsumerName() {} } ","date":"2024-11-06","objectID":"/posts/android13-bufferqueuelayer-onfirstref%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:3","tags":["clippings","blog","è½¬è½½"],"title":"Android13 BufferQueueLayer onFirstRefæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueuelayer-onfirstref%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#new-bufferqueueconsumer"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"new MonitoredProducer æ­¥éª¤2ï¼šä¸ºç”Ÿäº§è€…å¯¹è±¡åˆ›å»ºä¸€ä¸ªMonitoredProducerï¼Œè¿™ä¸ªç±»å®Œå…¨å°±æ˜¯ç”Ÿäº§è€…çš„å°è£…ç±»ï¼Œå®ƒé‡Œé¢çš„æ‰€æœ‰å‡½æ•°å‡ ä¹éƒ½æ˜¯é€šè¿‡ä¼ é€’è¿›å»çš„produceræ¥å®Œæˆçš„ï¼ŒMonitoredProducerç±»å®šä¹‰å¦‚ä¸‹ï¼š //frameworks/native/services/surfaceflinger/MonitoredProducer.cpp class MonitoredProducer : public BnGraphicBufferProducer { public: MonitoredProducer(const sp\u003cIGraphicBufferProducer\u003e\u0026 producer, const sp\u003cSurfaceFlinger\u003e\u0026 flinger, const wp\u003cLayer\u003e\u0026 layer); virtual ~MonitoredProducer(); // From IGraphicBufferProducer virtual status_t requestBuffer(int slot, sp\u003cGraphicBuffer\u003e* buf); virtual status_t setMaxDequeuedBufferCount(int maxDequeuedBuffers); virtual status_t setAsyncMode(bool async); virtual status_t dequeueBuffer(int* slot, sp\u003cFence\u003e* fence, uint32_t w, uint32_t h, PixelFormat format, uint64_t usage, uint64_t* outBufferAge, FrameEventHistoryDelta* outTimestamps); virtual status_t detachBuffer(int slot); virtual status_t detachNextBuffer(sp\u003cGraphicBuffer\u003e* outBuffer, sp\u003cFence\u003e* outFence); virtual status_t attachBuffer(int* outSlot, const sp\u003cGraphicBuffer\u003e\u0026 buffer); virtual status_t queueBuffer(int slot, const QueueBufferInput\u0026 input, QueueBufferOutput* output); virtual status_t cancelBuffer(int slot, const sp\u003cFence\u003e\u0026 fence); virtual int query(int what, int* value); virtual status_t connect(const sp\u003cIProducerListener\u003e\u0026 token, int api, bool producerControlledByApp, QueueBufferOutput* output); virtual status_t disconnect(int api, DisconnectMode mode); virtual status_t setSidebandStream(const sp\u003cNativeHandle\u003e\u0026 stream); virtual void allocateBuffers(uint32_t width, uint32_t height, PixelFormat format, uint64_t usage); virtual status_t allowAllocation(bool allow); virtual status_t setGenerationNumber(uint32_t generationNumber); virtual String8 getConsumerName() const override; virtual status_t setDequeueTimeout(nsecs_t timeout) override; virtual status_t setLegacyBufferDrop(bool drop) override; virtual status_t getLastQueuedBuffer(sp\u003cGraphicBuffer\u003e* outBuffer, sp\u003cFence\u003e* outFence, float outTransformMatrix[16]) override; virtual IBinder* onAsBinder(); virtual status_t setSharedBufferMode(bool sharedBufferMode) override; virtual status_t setAutoRefresh(bool autoRefresh) override; virtual void getFrameTimestamps(FrameEventHistoryDelta *outDelta) override; virtual status_t getUniqueId(uint64_t* outId) const override; virtual status_t getConsumerUsage(uint64_t* outUsage) const override; // The Layer which created this producer, and on which queued Buffer's will be displayed. sp\u003cLayer\u003e getLayer() const; private: sp\u003cIGraphicBufferProducer\u003e mProducer; sp\u003cSurfaceFlinger\u003e mFlinger; // The Layer which created this producer, and on which queued Buffer's will be displayed. wp\u003cLayer\u003e mLayer; }; }; // namespace android ","date":"2024-11-06","objectID":"/posts/android13-bufferqueuelayer-onfirstref%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:2:0","tags":["clippings","blog","è½¬è½½"],"title":"Android13 BufferQueueLayer onFirstRefæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueuelayer-onfirstref%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#new-monitoredproducer"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"new BufferLayerConsumer æ­¥éª¤3ï¼šä¸ºç”Ÿäº§è€…å¯¹è±¡åˆ›å»ºä¸€ä¸ªBufferLayerConsumerï¼Œè¿™ä¸ªç±»å®Œå…¨å°±æ˜¯æ¶ˆè´¹è€…çš„å°è£…ç±»ï¼ŒBufferLayerConsumerç±»å®šä¹‰å¦‚ä¸‹ï¼š //frameworks/native/services/surfaceflinger/BufferLayerConsumer.cpp class BufferLayerConsumer : public ConsumerBase { public: static const status_t BUFFER_REJECTED = UNKNOWN_ERROR + 8; class BufferRejecter { friend class BufferLayerConsumer; virtual bool reject(const sp\u003cGraphicBuffer\u003e\u0026 buf, const BufferItem\u0026 item) = 0; protected: virtual ~BufferRejecter() {} }; struct ContentsChangedListener : public FrameAvailableListener { virtual void onSidebandStreamChanged() = 0; }; // BufferLayerConsumer constructs a new BufferLayerConsumer object. The // tex parameter indicates the name of the RenderEngine texture to which // images are to be streamed. BufferLayerConsumer(const sp\u003cIGraphicBufferConsumer\u003e\u0026 bq, renderengine::RenderEngine\u0026 engine, uint32_t tex, Layer* layer); // Sets the contents changed listener. This should be used instead of // ConsumerBase::setFrameAvailableListener(). void setContentsChangedListener(const wp\u003cContentsChangedListener\u003e\u0026 listener); // updateTexImage acquires the most recently queued buffer, and sets the // image contents of the target texture to it. // // This call may only be made while RenderEngine is current. // // This calls doFenceWait to ensure proper synchronization unless native // fence is supported. // // Unlike the GLConsumer version, this version takes a functor that may be // used to reject the newly acquired buffer. It also does not bind the // RenderEngine texture until bindTextureImage is called. status_t updateTexImage(BufferRejecter* rejecter, nsecs_t expectedPresentTime, bool* autoRefresh, bool* queuedBuffer, uint64_t maxFrameNumber); // See BufferLayerConsumer::bindTextureImageLocked(). status_t bindTextureImage(); // setReleaseFence stores a fence that will signal when the current buffer // is no longer being read. This fence will be returned to the producer // when the current buffer is released by updateTexImage(). Multiple // fences can be set for a given buffer; they will be merged into a single // union fence. void setReleaseFence(const sp\u003cFence\u003e\u0026 fence); bool releasePendingBuffer(); sp\u003cFence\u003e getPrevFinalReleaseFence() const; // See GLConsumer::getTransformMatrix. void getTransformMatrix(float mtx[16]); // getTimestamp retrieves the timestamp associated with the texture image // set by the most recent call to updateTexImage. // // The timestamp is in nanoseconds, and is monotonically increasing. Its // other semantics (zero point, etc) are source-dependent and should be // documented by the source. int64_t getTimestamp(); // getDataSpace retrieves the DataSpace associated with the texture image // set by the most recent call to updateTexImage. ui::Dataspace getCurrentDataSpace(); // getCurrentHdrMetadata retrieves the HDR metadata associated with the // texture image set by the most recent call to updateTexImage. const HdrMetadata\u0026 getCurrentHdrMetadata() const; // getFrameNumber retrieves the frame number associated with the texture // image set by the most recent call to updateTexImage. // // The frame number is an incrementing counter set to 0 at the creation of // the BufferQueue associated with this consumer. uint64_t getFrameNumber(); bool getTransformToDisplayInverse() const; // must be called from SF main thread const Region\u0026 getSurfaceDamage() const; // Merge the given damage region into the current damage region value. void mergeSurfaceDamage(const Region\u0026 damage); // getCurrentApi retrieves the API which queues the current buffer. int getCurrentApi() const; // See GLConsumer::setDefaultBufferSize. status_t setDefaultBufferSize(uint32_t width, uint32_t height); // setFilteringEnabled sets whether the transform matrix should be computed // for use with bilinear filtering. void setFilteringEnabled(bool enabled); // getCurrentBuffer returns the buffer associated with the current image. // When outSlot is not nullptr, the current buffer slot index is also // returned. Simiarl","date":"2024-11-06","objectID":"/posts/android13-bufferqueuelayer-onfirstref%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:0","tags":["clippings","blog","è½¬è½½"],"title":"Android13 BufferQueueLayer onFirstRefæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueuelayer-onfirstref%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#new-bufferlayerconsumer"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"BufferLayerConsumer setContentsChangedListener æ­¥éª¤5ï¼šé€šè¿‡setContentsChangedListenerç»™æ¶ˆè´¹è€…è®¾ç½®ä¸€ä¸ªç¼“å†²åŒºå†…å®¹å˜åŒ–çš„ç›‘å¬å™¨ï¼š // frameworks/native/services/surfaceflinger/BufferLayerConsumer.cpp void BufferLayerConsumer::setContentsChangedListener(const wp\u003cContentsChangedListener\u003e\u0026 listener) { setFrameAvailableListener(listener); Mutex::Autolock lock(mMutex); mContentsChangedListener = listener; } ç”Ÿäº§è€…dequeueä¸€å—bufferï¼Œåº”ç”¨ç¨‹åºè¿›è¡Œç»˜åˆ¶ï¼Œç»˜åˆ¶å®Œæˆåqueueæ­¤å—bufferï¼Œæ­¤æ—¶ç”Ÿäº§è€…è°ƒç”¨BufferQueueCoreçš„mConsumerListenerçš„onFrameAvailableå›è°ƒå‡½æ•°ï¼ŒmConsumerListenerå…¶å®æ˜¯BufferQueue::ProxyConsumerListenerï¼ŒBufferQueue::ProxyConsumerListeneråœ¨åˆ›å»ºæ—¶åˆæ¥æ”¶äº†ConsumerBaseï¼Œæ‰€ä»¥è°ƒç”¨åˆ°äº†ConsumerBaseçš„onFrameAvailableä¸­ï¼ŒConsumerBaseè¿™é‡Œé¢åˆæœ‰ä¸€ä¸ªæˆå‘˜å˜é‡mFrameAvailableListenerï¼Œç±»å‹ä¸ºBufferQueueLayerï¼Œæ‰€ä»¥æœ€ç»ˆæ˜¯è°ƒç”¨åˆ°äº†BufferQueueLayerçš„å…·ä½“å®ç°onFrameAvailableä¸­ï¼Œå¯¹è¿™å—å·²ç»ç»˜åˆ¶å¥½çš„bufferè¿›ä¸€æ­¥å¤„ç†ã€‚ ","date":"2024-11-06","objectID":"/posts/android13-bufferqueuelayer-onfirstref%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:4:0","tags":["clippings","blog","è½¬è½½"],"title":"Android13 BufferQueueLayer onFirstRefæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueuelayer-onfirstref%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#bufferlayerconsumer-setcontentschangedlistener"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"BufferQueueLayerçš„onFrameAvailableæ–¹æ³•ç”¨äºé€šçŸ¥å›¾åƒæˆ–è§†é¢‘å¸§å·²ç»å¯ç”¨å¹¶å‡†å¤‡å¥½æ˜¾ç¤ºï¼Œä»£ç å¦‚ä¸‹ï¼š //frameworks/native/services/surfaceflinger/BufferQueueLayer.cpp sp\u003cSurfaceFlinger\u003e mFlinger; sp\u003cBufferLayerConsumer\u003e mConsumer; void BufferQueueLayer::onFrameAvailable(const BufferItem\u0026 item) { const int32_t layerId = getSequence(); const uint64_t bufferId = item.mGraphicBuffer-\u003egetId(); mFlinger-\u003emFrameTracer-\u003etraceTimestamp(layerId, bufferId, item.mFrameNumber, systemTime(), FrameTracer::FrameEvent::QUEUE); mFlinger-\u003emFrameTracer-\u003etraceFence(layerId, bufferId, item.mFrameNumber, std::make_shared\u003cFenceTime\u003e(item.mFence), FrameTracer::FrameEvent::ACQUIRE_FENCE); ATRACE_CALL(); // Add this buffer from our internal queue tracker { // Autolock scope const nsecs_t presentTime = item.mIsAutoTimestamp ? 0 : item.mTimestamp; using LayerUpdateType = scheduler::LayerHistory::LayerUpdateType; mFlinger-\u003emScheduler-\u003erecordLayerHistory(this, presentTime, LayerUpdateType::Buffer); Mutex::Autolock lock(mQueueItemLock); // Reset the frame number tracker when we receive the first buffer after // a frame number reset if (item.mFrameNumber == 1) { mLastFrameNumberReceived = 0; } // Ensure that callbacks are handled in order while (item.mFrameNumber != mLastFrameNumberReceived + 1) { status_t result = mQueueItemCondition.waitRelative(mQueueItemLock, ms2ns(500)); if (result != NO_ERROR) { ALOGE(\"[%s] Timed out waiting on callback\", getDebugName()); break; } } auto surfaceFrame = createSurfaceFrameForBuffer(mFrameTimelineInfo, systemTime(), mName); mQueueItems.push_back({item, surfaceFrame}); mQueuedFrames++; // Wake up any pending callbacks mLastFrameNumberReceived = item.mFrameNumber; mQueueItemCondition.broadcast(); } mFlinger-\u003emInterceptor-\u003esaveBufferUpdate(layerId, item.mGraphicBuffer-\u003egetWidth(), item.mGraphicBuffer-\u003egetHeight(), item.mFrameNumber); mFlinger-\u003eonLayerUpdate(); mConsumer-\u003eonBufferAvailable(item); } ä¸Šé¢æ–¹æ³•ä¸»è¦å¤„ç†å¦‚ä¸‹ï¼š 1ã€è°ƒç”¨mFlinger(SurfaceFlinger)å†…mScheduler(Scheduler)çš„recordLayerHistoryæ–¹æ³•ã€‚ 2ã€è°ƒç”¨Layerçš„createSurfaceFrameForBufferæ–¹æ³•ï¼Œåˆ›å»ºLayerã€‚ 3ã€è°ƒç”¨mFlinger(SurfaceFlinger)å†…mInterceptor(SurfaceInterceptor)çš„saveBufferUpdateæ–¹æ³•ã€‚ 4ã€è°ƒç”¨mFlinger(SurfaceFlinger)çš„onLayerUpdateæ–¹æ³•ã€‚ 5ã€è°ƒç”¨mConsumer(BufferLayerConsumer)çš„onBufferAvailableæ–¹æ³•ã€‚ ä¸‹é¢åˆ†åˆ«è¿›è¡Œåˆ†æï¼š ","date":"2024-11-06","objectID":"/posts/android13-bufferqueuelayer-onframeavailable%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 BufferQueueLayer onFrameAvailableæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueuelayer-onframeavailable%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Scheduler recordLayerHistory è°ƒç”¨mFlinger(SurfaceFlinger)å†…mScheduler(Scheduler)çš„recordLayerHistoryæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Scheduler/Scheduler.cpp LayerHistory mLayerHistory; void Scheduler::recordLayerHistory(Layer* layer, nsecs_t presentTime, LayerHistory::LayerUpdateType updateType) { { std::scoped_lock lock(mRefreshRateConfigsLock); if (!mRefreshRateConfigs-\u003ecanSwitch()) return; } mLayerHistory.record(layer, presentTime, systemTime(), updateType); } ","date":"2024-11-06","objectID":"/posts/android13-bufferqueuelayer-onframeavailable%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 BufferQueueLayer onFrameAvailableæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueuelayer-onframeavailable%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#scheduler-recordlayerhistory"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"LayerHistory record è°ƒç”¨mLayerHistory(LayerHistory)çš„recordæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Scheduler/LayerHistory.cpp void LayerHistory::record(Layer* layer, nsecs_t presentTime, nsecs_t now, LayerUpdateType updateType) { std::lock_guard lock(mLock); auto id = layer-\u003egetSequence(); auto [found, layerPair] = findLayer(id); if (found == LayerStatus::NotFound) { // Offscreen layer ALOGV(\"%s: %s not registered\", __func__, layer-\u003egetName().c_str()); return; } const auto\u0026 info = layerPair-\u003esecond; const auto layerProps = LayerInfo::LayerProps{ .visible = layer-\u003eisVisible(), .bounds = layer-\u003egetBounds(), .transform = layer-\u003egetTransform(), .setFrameRateVote = layer-\u003egetFrameRateForLayerTree(), .frameRateSelectionPriority = layer-\u003egetFrameRateSelectionPriority(), }; info-\u003esetLastPresentTime(presentTime, now, updateType, mModeChangePending, layerProps); // Activate layer if inactive. if (found == LayerStatus::LayerInInactiveMap) { mActiveLayerInfos.insert( {id, std::make_pair(layerPair-\u003efirst, std::move(layerPair-\u003esecond))}); mInactiveLayerInfos.erase(id); } } ","date":"2024-11-06","objectID":"/posts/android13-bufferqueuelayer-onframeavailable%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 BufferQueueLayer onFrameAvailableæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueuelayer-onframeavailable%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#layerhistory-record"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Layer createSurfaceFrameForBuffer è°ƒç”¨Layerçš„createSurfaceFrameForBufferæ–¹æ³•ï¼Œåˆ›å»ºLayerï¼š //frameworks/native/services/surfaceflinger/Layer.cpp sp\u003cSurfaceFlinger\u003e mFlinger; const std::unique_ptr\u003cframetimeline::FrameTimeline\u003e mFrameTimeline; std::shared_ptr\u003cframetimeline::SurfaceFrame\u003e Layer::createSurfaceFrameForBuffer( const FrameTimelineInfo\u0026 info, nsecs_t queueTime, std::string debugName) { auto surfaceFrame = mFlinger-\u003emFrameTimeline-\u003ecreateSurfaceFrameForToken(info, mOwnerPid, mOwnerUid, getSequence(), mName, debugName, /*isBuffer*/ true, getGameMode()); surfaceFrame-\u003esetActualStartTime(info.startTimeNanos); // For buffers, acquire fence time will set during latch. surfaceFrame-\u003esetActualQueueTime(queueTime); const auto fps = mFlinger-\u003emScheduler-\u003egetFrameRateOverride(getOwnerUid()); if (fps) { surfaceFrame-\u003esetRenderRate(*fps); } // TODO(b/178542907): Implement onSurfaceFrameCreated for BQLayer as well. onSurfaceFrameCreated(surfaceFrame); return surfaceFrame; } è°ƒç”¨mFlinger(SurfaceFlinger)ä¸­mFrameTimeline(FrameTimeline)çš„createSurfaceFrameForTokenæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/FrameTimeline/FrameTimeline.cpp std::shared_ptr\u003cSurfaceFrame\u003e FrameTimeline::createSurfaceFrameForToken( const FrameTimelineInfo\u0026 frameTimelineInfo, pid_t ownerPid, uid_t ownerUid, int32_t layerId, std::string layerName, std::string debugName, bool isBuffer, GameMode gameMode) { ATRACE_CALL(); if (frameTimelineInfo.vsyncId == FrameTimelineInfo::INVALID_VSYNC_ID) { return std::make_shared\u003cSurfaceFrame\u003e(frameTimelineInfo, ownerPid, ownerUid, layerId, std::move(layerName), std::move(debugName), PredictionState::None, TimelineItem(), mTimeStats, mJankClassificationThresholds, \u0026mTraceCookieCounter, isBuffer, gameMode); } std::optional\u003cTimelineItem\u003e predictions = mTokenManager.getPredictionsForToken(frameTimelineInfo.vsyncId); if (predictions) { return std::make_shared\u003cSurfaceFrame\u003e(frameTimelineInfo, ownerPid, ownerUid, layerId, std::move(layerName), std::move(debugName), PredictionState::Valid, std::move(*predictions), mTimeStats, mJankClassificationThresholds, \u0026mTraceCookieCounter, isBuffer, gameMode); } return std::make_shared\u003cSurfaceFrame\u003e(frameTimelineInfo, ownerPid, ownerUid, layerId, std::move(layerName), std::move(debugName), PredictionState::Expired, TimelineItem(), mTimeStats, mJankClassificationThresholds, \u0026mTraceCookieCounter, isBuffer, gameMode); } ","date":"2024-11-06","objectID":"/posts/android13-bufferqueuelayer-onframeavailable%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 BufferQueueLayer onFrameAvailableæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueuelayer-onframeavailable%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#layer-createsurfaceframeforbuffer"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"new SurfaceFrame åˆ›å»ºSurfaceFrameå¯¹è±¡ï¼ŒSurfaceFrameçš„æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š //frameworks/native/services/surfaceflinger/FrameTimeline/FrameTimeline.cpp SurfaceFrame::SurfaceFrame(const FrameTimelineInfo\u0026 frameTimelineInfo, pid_t ownerPid, uid_t ownerUid, int32_t layerId, std::string layerName, std::string debugName, PredictionState predictionState, frametimeline::TimelineItem\u0026\u0026 predictions, std::shared_ptr\u003cTimeStats\u003e timeStats, JankClassificationThresholds thresholds, TraceCookieCounter* traceCookieCounter, bool isBuffer, GameMode gameMode) : mToken(frameTimelineInfo.vsyncId), mInputEventId(frameTimelineInfo.inputEventId), mOwnerPid(ownerPid), mOwnerUid(ownerUid), mLayerName(std::move(layerName)), mDebugName(std::move(debugName)), mLayerId(layerId), mPresentState(PresentState::Unknown), mPredictionState(predictionState), mPredictions(predictions), mActuals({0, 0, 0}), mTimeStats(timeStats), mJankClassificationThresholds(thresholds), mTraceCookieCounter(*traceCookieCounter), mIsBuffer(isBuffer), mGameMode(gameMode) {} ","date":"2024-11-06","objectID":"/posts/android13-bufferqueuelayer-onframeavailable%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:2:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 BufferQueueLayer onFrameAvailableæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueuelayer-onframeavailable%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#new-surfaceframe"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"SurfaceInterceptor saveBufferUpdate è°ƒç”¨mFlinger(SurfaceFlinger)å†…mInterceptor(SurfaceInterceptor)çš„saveBufferUpdateæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/SurfaceInterceptor.cpp void SurfaceInterceptor::saveBufferUpdate(int32_t layerId, uint32_t width, uint32_t height, uint64_t frameNumber) { if (!mEnabled) { return; } ATRACE_CALL(); std::lock_guard\u003cstd::mutex\u003e protoGuard(mTraceMutex); addBufferUpdateLocked(createTraceIncrementLocked(), layerId, width, height, frameNumber); } ","date":"2024-11-06","objectID":"/posts/android13-bufferqueuelayer-onframeavailable%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 BufferQueueLayer onFrameAvailableæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueuelayer-onframeavailable%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceinterceptor-savebufferupdate"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"SurfaceInterceptor addBufferUpdateLocked è°ƒç”¨SurfaceInterceptorçš„addBufferUpdateLockedæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/SurfaceInterceptor.cpp void SurfaceInterceptor::addBufferUpdateLocked(Increment* increment, int32_t layerId, uint32_t width, uint32_t height, uint64_t frameNumber) { BufferUpdate* update(increment-\u003emutable_buffer_update()); update-\u003eset_id(layerId); update-\u003eset_w(width); update-\u003eset_h(height); update-\u003eset_frame_number(frameNumber); } ","date":"2024-11-06","objectID":"/posts/android13-bufferqueuelayer-onframeavailable%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 BufferQueueLayer onFrameAvailableæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueuelayer-onframeavailable%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceinterceptor-addbufferupdatelocked"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"SurfaceFlinger onLayerUpdate è°ƒç”¨mFlinger(SurfaceFlinger)çš„onLayerUpdateæ–¹æ³•ï¼Œé€šçŸ¥SurfaceFlingerå›¾å±‚æ›´æ–°ï¼š Android13 SurfaceFlinger onLayerUpdateæµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android13-bufferqueuelayer-onframeavailable%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:4:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 BufferQueueLayer onFrameAvailableæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueuelayer-onframeavailable%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-onlayerupdate"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"BufferLayerConsumer onBufferAvailable è°ƒç”¨mConsumer(BufferLayerConsumer)çš„onBufferAvailableæ–¹æ³•ã€‚ //frameworks/native/services/surfaceflinger/BufferLayerConsumer.cpp void BufferLayerConsumer::onBufferAvailable(const BufferItem\u0026 item) { if (item.mGraphicBuffer != nullptr \u0026\u0026 item.mSlot != BufferQueue::INVALID_BUFFER_SLOT) { std::lock_guard\u003cstd::mutex\u003e lock(mImagesMutex); const std::shared_ptr\u003crenderengine::ExternalTexture\u003e\u0026 oldImage = mImages[item.mSlot]; if (oldImage == nullptr || oldImage-\u003egetBuffer() == nullptr || oldImage-\u003egetBuffer()-\u003egetId() != item.mGraphicBuffer-\u003egetId()) { mImages[item.mSlot] = std::make_shared\u003c renderengine::impl::ExternalTexture\u003e(item.mGraphicBuffer, mRE, renderengine::impl::ExternalTexture:: Usage::READABLE); } } } ","date":"2024-11-06","objectID":"/posts/android13-bufferqueuelayer-onframeavailable%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:5:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 BufferQueueLayer onFrameAvailableæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueuelayer-onframeavailable%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#bufferlayerconsumer-onbufferavailable"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"BufferQueueLayerçš„onLayerDisplayedæ–¹æ³•åœ¨BufferQueueLayerè¢«æ˜¾ç¤ºæ—¶è°ƒç”¨ï¼Œä»£ç å¦‚ä¸‹ï¼š //frameworks/native/services/surfaceflinger/BufferQueueLayer.cpp sp\u003cSurfaceFlinger\u003e mFlinger; const std::unique_ptr\u003cFrameTracer\u003e mFrameTracer; void BufferQueueLayer::onLayerDisplayed(ftl::SharedFuture\u003cFenceResult\u003e futureFenceResult) { const sp\u003cFence\u003e releaseFence = futureFenceResult.get().value_or(Fence::NO_FENCE); mConsumer-\u003esetReleaseFence(releaseFence); // Prevent tracing the same release multiple times. if (mPreviousFrameNumber != mPreviousReleasedFrameNumber) { mFlinger-\u003emFrameTracer-\u003etraceFence(getSequence(), mPreviousBufferId, mPreviousFrameNumber, std::make_shared\u003cFenceTime\u003e(releaseFence), FrameTracer::FrameEvent::RELEASE_FENCE); mPreviousReleasedFrameNumber = mPreviousFrameNumber; } } ","date":"2024-11-06","objectID":"/posts/android13-bufferqueuelayer-onlayerdisplayed%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 BufferQueueLayer onLayerDisplayedæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueuelayer-onlayerdisplayed%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"FrameTracer traceFence è°ƒç”¨FrameTracerçš„traceFenceæ–¹æ³•ï¼Œç”¨äºåˆ†æå’Œè°ƒè¯•ç•Œé¢æ¸²æŸ“çš„æ€§èƒ½é—®é¢˜ï¼š //frameworks/native/services/surfaceflinger/FrameTracer/FrameTracer.cpp void FrameTracer::traceFence(int32_t layerId, uint64_t bufferID, uint64_t frameNumber, const std::shared_ptr\u003cFenceTime\u003e\u0026 fence, FrameEvent::BufferEventType type, nsecs_t startTime) { FrameTracerDataSource::Trace([this, layerId, bufferID, frameNumber, \u0026fence, type, startTime](FrameTracerDataSource::TraceContext ctx) { const nsecs_t signalTime = fence-\u003egetSignalTime(); if (signalTime != Fence::SIGNAL_TIME_INVALID) { std::lock_guard\u003cstd::mutex\u003e lock(mTraceMutex); if (mTraceTracker.find(layerId) == mTraceTracker.end()) { return; } // Handle any pending fences for this buffer. tracePendingFencesLocked(ctx, layerId, bufferID); if (signalTime != Fence::SIGNAL_TIME_PENDING) { traceSpanLocked(ctx, layerId, bufferID, frameNumber, type, startTime, signalTime); } else { mTraceTracker[layerId].pendingFences[bufferID].push_back( {.frameNumber = frameNumber, .type = type, .fence = fence, .startTime = startTime}); } } }); } ","date":"2024-11-06","objectID":"/posts/android13-bufferqueuelayer-onlayerdisplayed%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 BufferQueueLayer onLayerDisplayedæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueuelayer-onlayerdisplayed%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#frametracer-tracefence"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"BufferQueueLayerçš„updateTexImageæ–¹æ³•ç”¨äºå°†å½“å‰å›¾å½¢ç¼“å†²åŒºçš„å†…å®¹æ›´æ–°åˆ°çº¹ç†ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š //frameworks/native/services/surfaceflinger/BufferQueueLayer.cpp status_t BufferQueueLayer::updateTexImage(bool\u0026 recomputeVisibleRegions, nsecs_t latchTime, nsecs_t expectedPresentTime) { // This boolean is used to make sure that SurfaceFlinger's shadow copy // of the buffer queue isn't modified when the buffer queue is returning // BufferItem's that weren't actually queued. This can happen in shared // buffer mode. bool queuedBuffer = false; const int32_t layerId = getSequence(); LayerRejecter r(mDrawingState, getDrawingState(), recomputeVisibleRegions, getProducerStickyTransform() != 0, mName, getTransformToDisplayInverse()); if (isRemovedFromCurrentState()) { expectedPresentTime = 0; } // updateTexImage() below might drop the some buffers at the head of the queue if there is a // buffer behind them which is timely to be presented. However this buffer may not be signaled // yet. The code below makes sure that this wouldn't happen by setting maxFrameNumber to the // last buffer that was signaled. uint64_t lastSignaledFrameNumber = mLastFrameNumberReceived; { Mutex::Autolock lock(mQueueItemLock); for (size_t i = 0; i \u003c mQueueItems.size(); i++) { bool fenceSignaled = mQueueItems[i].item.mFenceTime-\u003egetSignalTime() != Fence::SIGNAL_TIME_PENDING; if (!fenceSignaled) { break; } lastSignaledFrameNumber = mQueueItems[i].item.mFrameNumber; } } const uint64_t maxFrameNumberToAcquire = std::min(mLastFrameNumberReceived.load(), lastSignaledFrameNumber); bool autoRefresh; status_t updateResult = mConsumer-\u003eupdateTexImage(\u0026r, expectedPresentTime, \u0026autoRefresh, \u0026queuedBuffer, maxFrameNumberToAcquire); mDrawingState.autoRefresh = autoRefresh; if (updateResult == BufferQueue::PRESENT_LATER) { // Producer doesn't want buffer to be displayed yet. Signal a // layer update so we check again at the next opportunity. // Producer ä¸å¸Œæœ›æ˜¾ç¤ºç¼“å†²åŒºã€‚ å‘å‡ºå›¾å±‚æ›´æ–°çš„ä¿¡å·ï¼Œä»¥ä¾¿æˆ‘ä»¬åœ¨ä¸‹æ¬¡æœ‰æœºä¼šæ—¶å†æ¬¡æ£€æŸ¥ã€‚ mFlinger-\u003eonLayerUpdate(); // (692) SurfaceFlinger onLayerUpdateæµç¨‹åˆ†æ return BAD_VALUE; } else if (updateResult == BufferLayerConsumer::BUFFER_REJECTED) { // If the buffer has been rejected, remove it from the shadow queue // and return early if (queuedBuffer) { Mutex::Autolock lock(mQueueItemLock); if (mQueuedFrames \u003e 0) { mConsumer-\u003emergeSurfaceDamage(mQueueItems[0].item.mSurfaceDamage); mFlinger-\u003emTimeStats-\u003eremoveTimeRecord(layerId, mQueueItems[0].item.mFrameNumber); if (mQueueItems[0].surfaceFrame) { addSurfaceFrameDroppedForBuffer(mQueueItems[0].surfaceFrame); } mQueueItems.erase(mQueueItems.begin()); mQueuedFrames--; } } return BAD_VALUE; } else if (updateResult != NO_ERROR || mUpdateTexImageFailed) { // This can occur if something goes wrong when trying to create the // EGLImage for this buffer. If this happens, the buffer has already // been released, so we need to clean up the queue and bug out // early. if (queuedBuffer) { Mutex::Autolock lock(mQueueItemLock); for (auto\u0026 [item, surfaceFrame] : mQueueItems) { if (surfaceFrame) { addSurfaceFrameDroppedForBuffer(surfaceFrame); } } mQueueItems.clear(); mQueuedFrames = 0; mFlinger-\u003emTimeStats-\u003eonDestroy(layerId); mFlinger-\u003emFrameTracer-\u003eonDestroy(layerId); } // Once we have hit this state, the shadow queue may no longer // correctly reflect the incoming BufferQueue's contents, so even if // updateTexImage starts working, the only safe course of action is // to continue to ignore updates. mUpdateTexImageFailed = true; return BAD_VALUE; } bool more_frames_pending = false; if (queuedBuffer) { // Autolock scope auto currentFrameNumber = mConsumer-\u003egetFrameNumber(); Mutex::Autolock lock(mQueueItemLock); // Remove any stale buffers that have been dropped during // updateTexImage while (mQueuedFrames \u003e 0 \u0026\u0026 mQueueItems[0].item.mFrameNumber != currentFrameNumber) { mConsumer-\u003emergeSurfaceDamage(mQueueItems[0].item.mSurfaceDamage); mFlinger-\u003emTimeStats-\u003eremoveTimeRecord(layerId, mQueueItems[0].item.mFrameNumber); if (mQueueItems[0].surfaceFrame) { addSurfaceFrameDroppedForBuffer(mQu","date":"2024-11-06","objectID":"/posts/android13-bufferqueuelayer-updateteximage%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 BufferQueueLayer updateTexImageæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueuelayer-updateteximage%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"BufferLayerConsumer updateTexImage è°ƒç”¨BufferLayerConsumerçš„updateTexImageæ–¹æ³•ï¼š //frameworks/native/surfaces/surfaceflienger/BufferLayerConsumer.cpp status_t BufferLayerConsumer::updateTexImage(BufferRejecter* rejecter, nsecs_t expectedPresentTime, bool* autoRefresh, bool* queuedBuffer, uint64_t maxFrameNumber) { ATRACE_CALL(); BLC_LOGV(\"updateTexImage\"); Mutex::Autolock lock(mMutex); if (mAbandoned) { BLC_LOGE(\"updateTexImage: BufferLayerConsumer is abandoned!\"); return NO_INIT; } BufferItem item; // Acquire the next buffer. // In asynchronous mode the list is guaranteed to be one buffer // deep, while in synchronous mode we use the oldest buffer. status_t err = acquireBufferLocked(\u0026item, expectedPresentTime, maxFrameNumber); if (err != NO_ERROR) { if (err == BufferQueue::NO_BUFFER_AVAILABLE) { err = NO_ERROR; } else if (err == BufferQueue::PRESENT_LATER) { // return the error, without logging } else { BLC_LOGE(\"updateTexImage: acquire failed: %s (%d)\", strerror(-err), err); } return err; } if (autoRefresh) { *autoRefresh = item.mAutoRefresh; } if (queuedBuffer) { *queuedBuffer = item.mQueuedBuffer; } // We call the rejecter here, in case the caller has a reason to // not accept this buffer. This is used by SurfaceFlinger to // reject buffers which have the wrong size //æˆ‘ä»¬åœ¨è¿™é‡Œè°ƒç”¨æ‹’ç»å™¨ï¼Œä»¥é˜²è°ƒç”¨è€…æœ‰ç†ç”±ä¸æ¥å—æ­¤ç¼“å†²åŒºï¼Œ SurfaceFlinger ä½¿ç”¨å®ƒæ¥æ‹’ç»å¤§å°é”™è¯¯çš„ç¼“å†²åŒº int slot = item.mSlot; if (rejecter \u0026\u0026 rejecter-\u003ereject(mSlots[slot].mGraphicBuffer, item)) { releaseBufferLocked(slot, mSlots[slot].mGraphicBuffer); return BUFFER_REJECTED; } // Release the previous buffer. err = updateAndReleaseLocked(item, \u0026mPendingRelease); if (err != NO_ERROR) { return err; } return err; } ä¸Šé¢æ–¹æ³•çš„ä¸»è¦å¤„ç†å¦‚ä¸‹ï¼š 1ã€è°ƒç”¨BufferLayerConsumerçš„acquireBufferLockedæ–¹æ³•ï¼Œä»BufferQueueä¸­è·å–ä¸€ä¸ªå¯ç”¨çš„å›¾åƒç¼“å†²åŒºã€‚ 2ã€è°ƒç”¨BufferLayerConsumerçš„updateAndReleaseLockedæ–¹æ³•ï¼Œé‡Šæ”¾å›¾åƒç¼“å†²åŒºã€‚ ä¸‹é¢åˆ†åˆ«è¿›è¡Œåˆ†æï¼š ","date":"2024-11-06","objectID":"/posts/android13-bufferqueuelayer-updateteximage%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 BufferQueueLayer updateTexImageæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueuelayer-updateteximage%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#bufferlayerconsumer-updateteximage"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"BufferLayerConsumer acquireBufferLocked è°ƒç”¨BufferLayerConsumerçš„acquireBufferLockedæ–¹æ³•ï¼Œä»BufferQueueä¸­è·å–ä¸€ä¸ªå¯ç”¨çš„å›¾åƒç¼“å†²åŒºï¼š //frameworks/native/services/surfaceflinger/BufferLayerConsumer.cpp status_t BufferLayerConsumer::acquireBufferLocked(BufferItem* item, nsecs_t presentWhen, uint64_t maxFrameNumber) { status_t err = ConsumerBase::acquireBufferLocked(item, presentWhen, maxFrameNumber); if (err != NO_ERROR) { return err; } // If item-\u003emGraphicBuffer is not null, this buffer has not been acquired // before, so we need to clean up old references. if (item-\u003emGraphicBuffer != nullptr) { std::lock_guard\u003cstd::mutex\u003e lock(mImagesMutex); if (mImages[item-\u003emSlot] == nullptr || mImages[item-\u003emSlot]-\u003egetBuffer() == nullptr || mImages[item-\u003emSlot]-\u003egetBuffer()-\u003egetId() != item-\u003emGraphicBuffer-\u003egetId()) { mImages[item-\u003emSlot] = std::make_shared\u003c renderengine::impl::ExternalTexture\u003e(item-\u003emGraphicBuffer, mRE, renderengine::impl::ExternalTexture:: Usage::READABLE); } } return NO_ERROR; } ConsumerBase acquireBufferLocked BufferLayerConsumerç»§æ‰¿äºConsumerBaseï¼Œè°ƒç”¨ConsumerBaseçš„acquireBufferLockedæ–¹æ³•ï¼š //frameworks/native/libs/gui/ConsumerBase.cpp sp\u003cIGraphicBufferConsumer\u003e mConsumer; status_t ConsumerBase::acquireBufferLocked(BufferItem *item, nsecs_t presentWhen, uint64_t maxFrameNumber) { if (mAbandoned) { CB_LOGE(\"acquireBufferLocked: ConsumerBase is abandoned!\"); return NO_INIT; } status_t err = mConsumer-\u003eacquireBuffer(item, presentWhen, maxFrameNumber); if (err != NO_ERROR) { return err; } if (item-\u003emGraphicBuffer != nullptr) { if (mSlots[item-\u003emSlot].mGraphicBuffer != nullptr) { freeBufferLocked(item-\u003emSlot); } mSlots[item-\u003emSlot].mGraphicBuffer = item-\u003emGraphicBuffer; } mSlots[item-\u003emSlot].mFrameNumber = item-\u003emFrameNumber; mSlots[item-\u003emSlot].mFence = item-\u003emFence; CB_LOGV(\"acquireBufferLocked: -\u003e slot=%d/%\" PRIu64, item-\u003emSlot, item-\u003emFrameNumber); return OK; } è°ƒç”¨mConsumer(IGraphicBufferConsumer)çš„acquireBufferæ–¹æ³•ï¼ŒIGraphicBufferConsumeræ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”±BpGraphicBufferConsumerå®ç°ï¼š //frameworks/native/libs/gui/IGraphicBufferConsumer.cpp class BpGraphicBufferConsumer : public SafeBpInterface\u003cIGraphicBufferConsumer\u003e { status_t acquireBuffer(BufferItem* buffer, nsecs_t presentWhen, uint64_t maxFrameNumber) override { using Signature = decltype(\u0026IGraphicBufferConsumer::acquireBuffer); return callRemote\u003cSignature\u003e(Tag::ACQUIRE_BUFFER, buffer, presentWhen, maxFrameNumber); } } è°ƒç”¨callRemoteæ–¹æ³•è¿›è¡Œè¿œç¨‹è°ƒç”¨ï¼Œä¹‹åä¼šè¿è¡ŒBnGraphicBufferConsumerçš„onTransactæ–¹æ³•ï¼š //frameworks/native/libs/gui/IGraphicBufferConsumer.cpp status_t BnGraphicBufferConsumer::onTransact(uint32_t code, const Parcel\u0026 data, Parcel* reply, uint32_t flags) { if (code \u003c IBinder::FIRST_CALL_TRANSACTION || code \u003e static_cast\u003cuint32_t\u003e(Tag::LAST)) { return BBinder::onTransact(code, data, reply, flags); } auto tag = static_cast\u003cTag\u003e(code); switch (tag) { case Tag::ACQUIRE_BUFFER: return callLocal(data, reply, \u0026IGraphicBufferConsumer::acquireBuffer); } } } BuffQueueConsumer acquireBuffer BuffQueueConsumerç»§æ‰¿äºBnGraphicBufferConsumerï¼Œè°ƒç”¨BnGraphicBufferConsumerçš„acquireBufferæ–¹æ³•ï¼š Android13 BufferQueueConsumer acquireBufferæµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android13-bufferqueuelayer-updateteximage%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 BufferQueueLayer updateTexImageæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueuelayer-updateteximage%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#bufferlayerconsumer-acquirebufferlocked"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"BufferLayerConsumer acquireBufferLocked è°ƒç”¨BufferLayerConsumerçš„acquireBufferLockedæ–¹æ³•ï¼Œä»BufferQueueä¸­è·å–ä¸€ä¸ªå¯ç”¨çš„å›¾åƒç¼“å†²åŒºï¼š //frameworks/native/services/surfaceflinger/BufferLayerConsumer.cpp status_t BufferLayerConsumer::acquireBufferLocked(BufferItem* item, nsecs_t presentWhen, uint64_t maxFrameNumber) { status_t err = ConsumerBase::acquireBufferLocked(item, presentWhen, maxFrameNumber); if (err != NO_ERROR) { return err; } // If item-\u003emGraphicBuffer is not null, this buffer has not been acquired // before, so we need to clean up old references. if (item-\u003emGraphicBuffer != nullptr) { std::lock_guard lock(mImagesMutex); if (mImages[item-\u003emSlot] == nullptr || mImages[item-\u003emSlot]-\u003egetBuffer() == nullptr || mImages[item-\u003emSlot]-\u003egetBuffer()-\u003egetId() != item-\u003emGraphicBuffer-\u003egetId()) { mImages[item-\u003emSlot] = std::make_shared\u003c renderengine::impl::ExternalTexture\u003e(item-\u003emGraphicBuffer, mRE, renderengine::impl::ExternalTexture:: Usage::READABLE); } } return NO_ERROR; } ConsumerBase acquireBufferLocked BufferLayerConsumerç»§æ‰¿äºConsumerBaseï¼Œè°ƒç”¨ConsumerBaseçš„acquireBufferLockedæ–¹æ³•ï¼š //frameworks/native/libs/gui/ConsumerBase.cpp sp mConsumer; status_t ConsumerBase::acquireBufferLocked(BufferItem *item, nsecs_t presentWhen, uint64_t maxFrameNumber) { if (mAbandoned) { CB_LOGE(\"acquireBufferLocked: ConsumerBase is abandoned!\"); return NO_INIT; } status_t err = mConsumer-\u003eacquireBuffer(item, presentWhen, maxFrameNumber); if (err != NO_ERROR) { return err; } if (item-\u003emGraphicBuffer != nullptr) { if (mSlots[item-\u003emSlot].mGraphicBuffer != nullptr) { freeBufferLocked(item-\u003emSlot); } mSlots[item-\u003emSlot].mGraphicBuffer = item-\u003emGraphicBuffer; } mSlots[item-\u003emSlot].mFrameNumber = item-\u003emFrameNumber; mSlots[item-\u003emSlot].mFence = item-\u003emFence; CB_LOGV(\"acquireBufferLocked: -\u003e slot=%d/%\" PRIu64, item-\u003emSlot, item-\u003emFrameNumber); return OK; } è°ƒç”¨mConsumer(IGraphicBufferConsumer)çš„acquireBufferæ–¹æ³•ï¼ŒIGraphicBufferConsumeræ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”±BpGraphicBufferConsumerå®ç°ï¼š //frameworks/native/libs/gui/IGraphicBufferConsumer.cpp class BpGraphicBufferConsumer : public SafeBpInterface { status_t acquireBuffer(BufferItem* buffer, nsecs_t presentWhen, uint64_t maxFrameNumber) override { using Signature = decltype(\u0026IGraphicBufferConsumer::acquireBuffer); return callRemote(Tag::ACQUIRE_BUFFER, buffer, presentWhen, maxFrameNumber); } } è°ƒç”¨callRemoteæ–¹æ³•è¿›è¡Œè¿œç¨‹è°ƒç”¨ï¼Œä¹‹åä¼šè¿è¡ŒBnGraphicBufferConsumerçš„onTransactæ–¹æ³•ï¼š //frameworks/native/libs/gui/IGraphicBufferConsumer.cpp status_t BnGraphicBufferConsumer::onTransact(uint32_t code, const Parcel\u0026 data, Parcel* reply, uint32_t flags) { if (code \u003c IBinder::FIRST_CALL_TRANSACTION || code \u003e static_cast(Tag::LAST)) { return BBinder::onTransact(code, data, reply, flags); } auto tag = static_cast(code); switch (tag) { case Tag::ACQUIRE_BUFFER: return callLocal(data, reply, \u0026IGraphicBufferConsumer::acquireBuffer); } } } BuffQueueConsumer acquireBuffer BuffQueueConsumerç»§æ‰¿äºBnGraphicBufferConsumerï¼Œè°ƒç”¨BnGraphicBufferConsumerçš„acquireBufferæ–¹æ³•ï¼š Android13 BufferQueueConsumer acquireBufferæµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android13-bufferqueuelayer-updateteximage%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 BufferQueueLayer updateTexImageæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueuelayer-updateteximage%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#consumerbase-acquirebufferlocked"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"BufferLayerConsumer acquireBufferLocked è°ƒç”¨BufferLayerConsumerçš„acquireBufferLockedæ–¹æ³•ï¼Œä»BufferQueueä¸­è·å–ä¸€ä¸ªå¯ç”¨çš„å›¾åƒç¼“å†²åŒºï¼š //frameworks/native/services/surfaceflinger/BufferLayerConsumer.cpp status_t BufferLayerConsumer::acquireBufferLocked(BufferItem* item, nsecs_t presentWhen, uint64_t maxFrameNumber) { status_t err = ConsumerBase::acquireBufferLocked(item, presentWhen, maxFrameNumber); if (err != NO_ERROR) { return err; } // If item-\u003emGraphicBuffer is not null, this buffer has not been acquired // before, so we need to clean up old references. if (item-\u003emGraphicBuffer != nullptr) { std::lock_guard lock(mImagesMutex); if (mImages[item-\u003emSlot] == nullptr || mImages[item-\u003emSlot]-\u003egetBuffer() == nullptr || mImages[item-\u003emSlot]-\u003egetBuffer()-\u003egetId() != item-\u003emGraphicBuffer-\u003egetId()) { mImages[item-\u003emSlot] = std::make_shared\u003c renderengine::impl::ExternalTexture\u003e(item-\u003emGraphicBuffer, mRE, renderengine::impl::ExternalTexture:: Usage::READABLE); } } return NO_ERROR; } ConsumerBase acquireBufferLocked BufferLayerConsumerç»§æ‰¿äºConsumerBaseï¼Œè°ƒç”¨ConsumerBaseçš„acquireBufferLockedæ–¹æ³•ï¼š //frameworks/native/libs/gui/ConsumerBase.cpp sp mConsumer; status_t ConsumerBase::acquireBufferLocked(BufferItem *item, nsecs_t presentWhen, uint64_t maxFrameNumber) { if (mAbandoned) { CB_LOGE(\"acquireBufferLocked: ConsumerBase is abandoned!\"); return NO_INIT; } status_t err = mConsumer-\u003eacquireBuffer(item, presentWhen, maxFrameNumber); if (err != NO_ERROR) { return err; } if (item-\u003emGraphicBuffer != nullptr) { if (mSlots[item-\u003emSlot].mGraphicBuffer != nullptr) { freeBufferLocked(item-\u003emSlot); } mSlots[item-\u003emSlot].mGraphicBuffer = item-\u003emGraphicBuffer; } mSlots[item-\u003emSlot].mFrameNumber = item-\u003emFrameNumber; mSlots[item-\u003emSlot].mFence = item-\u003emFence; CB_LOGV(\"acquireBufferLocked: -\u003e slot=%d/%\" PRIu64, item-\u003emSlot, item-\u003emFrameNumber); return OK; } è°ƒç”¨mConsumer(IGraphicBufferConsumer)çš„acquireBufferæ–¹æ³•ï¼ŒIGraphicBufferConsumeræ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”±BpGraphicBufferConsumerå®ç°ï¼š //frameworks/native/libs/gui/IGraphicBufferConsumer.cpp class BpGraphicBufferConsumer : public SafeBpInterface { status_t acquireBuffer(BufferItem* buffer, nsecs_t presentWhen, uint64_t maxFrameNumber) override { using Signature = decltype(\u0026IGraphicBufferConsumer::acquireBuffer); return callRemote(Tag::ACQUIRE_BUFFER, buffer, presentWhen, maxFrameNumber); } } è°ƒç”¨callRemoteæ–¹æ³•è¿›è¡Œè¿œç¨‹è°ƒç”¨ï¼Œä¹‹åä¼šè¿è¡ŒBnGraphicBufferConsumerçš„onTransactæ–¹æ³•ï¼š //frameworks/native/libs/gui/IGraphicBufferConsumer.cpp status_t BnGraphicBufferConsumer::onTransact(uint32_t code, const Parcel\u0026 data, Parcel* reply, uint32_t flags) { if (code \u003c IBinder::FIRST_CALL_TRANSACTION || code \u003e static_cast(Tag::LAST)) { return BBinder::onTransact(code, data, reply, flags); } auto tag = static_cast(code); switch (tag) { case Tag::ACQUIRE_BUFFER: return callLocal(data, reply, \u0026IGraphicBufferConsumer::acquireBuffer); } } } BuffQueueConsumer acquireBuffer BuffQueueConsumerç»§æ‰¿äºBnGraphicBufferConsumerï¼Œè°ƒç”¨BnGraphicBufferConsumerçš„acquireBufferæ–¹æ³•ï¼š Android13 BufferQueueConsumer acquireBufferæµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android13-bufferqueuelayer-updateteximage%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 BufferQueueLayer updateTexImageæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueuelayer-updateteximage%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#buffqueueconsumer-acquirebuffer"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"BufferLayerConsumer updateAndReleaseLocked è°ƒç”¨BufferLayerConsumerçš„updateAndReleaseLockedæ–¹æ³•ï¼Œé‡Šæ”¾å›¾åƒç¼“å†²åŒºï¼š //frameworks/native/services/surfaceflinger/BufferLayerConsumer.cpp status_t BufferLayerConsumer::updateAndReleaseLocked(const BufferItem\u0026 item, PendingRelease* pendingRelease) { status_t err = NO_ERROR; int slot = item.mSlot; BLC_LOGV(\"updateAndRelease: (slot=%d buf=%p) -\u003e (slot=%d buf=%p)\", mCurrentTexture, (mCurrentTextureBuffer != nullptr \u0026\u0026 mCurrentTextureBuffer-\u003egetBuffer() != nullptr) ? mCurrentTextureBuffer-\u003egetBuffer()-\u003ehandle : 0, slot, mSlots[slot].mGraphicBuffer-\u003ehandle); // Hang onto the pointer so that it isn't freed in the call to // releaseBufferLocked() if we're in shared buffer mode and both buffers are // the same. std::shared_ptr\u003crenderengine::ExternalTexture\u003e nextTextureBuffer; { std::lock_guard\u003cstd::mutex\u003e lock(mImagesMutex); nextTextureBuffer = mImages[slot]; } // release old buffer if (mCurrentTexture != BufferQueue::INVALID_BUFFER_SLOT) { if (pendingRelease == nullptr) { status_t status = releaseBufferLocked(mCurrentTexture, mCurrentTextureBuffer-\u003egetBuffer()); if (status \u003c NO_ERROR) { BLC_LOGE(\"updateAndRelease: failed to release buffer: %s (%d)\", strerror(-status), status); err = status; // keep going, with error raised [?] } } else { pendingRelease-\u003ecurrentTexture = mCurrentTexture; pendingRelease-\u003egraphicBuffer = mCurrentTextureBuffer-\u003egetBuffer(); pendingRelease-\u003eisPending = true; } } // Update the BufferLayerConsumer state. mCurrentTexture = slot; mCurrentTextureBuffer = nextTextureBuffer; mCurrentCrop = item.mCrop; mCurrentTransform = item.mTransform; mCurrentScalingMode = item.mScalingMode; mCurrentTimestamp = item.mTimestamp; mCurrentDataSpace = static_cast\u003cui::Dataspace\u003e(item.mDataSpace); mCurrentHdrMetadata = item.mHdrMetadata; mCurrentFence = item.mFence; mCurrentFenceTime = item.mFenceTime; mCurrentFrameNumber = item.mFrameNumber; mCurrentTransformToDisplayInverse = item.mTransformToDisplayInverse; mCurrentSurfaceDamage = item.mSurfaceDamage; mCurrentApi = item.mApi; computeCurrentTransformMatrixLocked(); return err; } ConsumerBase releaseBufferLocked BufferLayerConsumerç»§æ‰¿äºConsumerBaseï¼Œè°ƒç”¨ConsumerBaseçš„releaseBufferLockedæ–¹æ³•ï¼š //frameworks/native/libs/gui/ConsumerBase.cpp status_t ConsumerBase::releaseBufferLocked( int slot, const sp\u003cGraphicBuffer\u003e graphicBuffer, EGLDisplay display, EGLSyncKHR eglFence) { if (mAbandoned) { CB_LOGE(\"releaseBufferLocked: ConsumerBase is abandoned!\"); return NO_INIT; } // If consumer no longer tracks this graphicBuffer (we received a new // buffer on the same slot), the buffer producer is definitely no longer // tracking it. if (!stillTracking(slot, graphicBuffer)) { return OK; } CB_LOGV(\"releaseBufferLocked: slot=%d/%\" PRIu64, slot, mSlots[slot].mFrameNumber); status_t err = mConsumer-\u003ereleaseBuffer(slot, mSlots[slot].mFrameNumber, display, eglFence, mSlots[slot].mFence); if (err == IGraphicBufferConsumer::STALE_BUFFER_SLOT) { freeBufferLocked(slot); } mPrevFinalReleaseFence = mSlots[slot].mFence; mSlots[slot].mFence = Fence::NO_FENCE; return err; } è°ƒç”¨mConsumer(IGraphicBufferConsumer)çš„releaseBuffer //frameworks/native/include/gui/IGraphicBufferConsumer.h using ReleaseBuffer = decltype(\u0026IGraphicBufferConsumer::releaseHelper); //frameworks/native/libs/gui/IGraphicBufferConsumer.cpp status_t BnGraphicBufferConsumer::onTransact(uint32_t code, const Parcel\u0026 data, Parcel* reply, uint32_t flags) { if (code \u003c IBinder::FIRST_CALL_TRANSACTION || code \u003e static_cast\u003cuint32_t\u003e(Tag::LAST)) { return BBinder::onTransact(code, data, reply, flags); } auto tag = static_cast\u003cTag\u003e(code); switch (tag) { case Tag::RELEASE_BUFFER: return callLocal(data, reply, \u0026IGraphicBufferConsumer::releaseHelper); } } } seBufferæ–¹æ³•ï¼ŒIGraphicBufferConsumeræ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”±BpGraphicBufferConsumerå®ç°ï¼š //frameworks/native/libs/gui/IGraphicBufferConsumer.cpp class BpGraphicBufferConsumer : public SafeBpInterface\u003cIGraphicBufferConsumer\u003e { status_t releaseBuffer(int buf, uint64_t frameNumber, EGLDisplay display __attribut","date":"2024-11-06","objectID":"/posts/android13-bufferqueuelayer-updateteximage%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:2","tags":["clippings","è½¬è½½","blog"],"title":"Android13 BufferQueueLayer updateTexImageæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueuelayer-updateteximage%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#bufferlayerconsumer-updateandreleaselocked"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"BufferLayerConsumer updateAndReleaseLocked è°ƒç”¨BufferLayerConsumerçš„updateAndReleaseLockedæ–¹æ³•ï¼Œé‡Šæ”¾å›¾åƒç¼“å†²åŒºï¼š //frameworks/native/services/surfaceflinger/BufferLayerConsumer.cpp status_t BufferLayerConsumer::updateAndReleaseLocked(const BufferItem\u0026 item, PendingRelease* pendingRelease) { status_t err = NO_ERROR; int slot = item.mSlot; BLC_LOGV(\"updateAndRelease: (slot=%d buf=%p) -\u003e (slot=%d buf=%p)\", mCurrentTexture, (mCurrentTextureBuffer != nullptr \u0026\u0026 mCurrentTextureBuffer-\u003egetBuffer() != nullptr) ? mCurrentTextureBuffer-\u003egetBuffer()-\u003ehandle : 0, slot, mSlots[slot].mGraphicBuffer-\u003ehandle); // Hang onto the pointer so that it isn't freed in the call to // releaseBufferLocked() if we're in shared buffer mode and both buffers are // the same. std::shared_ptr nextTextureBuffer; { std::lock_guard lock(mImagesMutex); nextTextureBuffer = mImages[slot]; } // release old buffer if (mCurrentTexture != BufferQueue::INVALID_BUFFER_SLOT) { if (pendingRelease == nullptr) { status_t status = releaseBufferLocked(mCurrentTexture, mCurrentTextureBuffer-\u003egetBuffer()); if (status \u003c NO_ERROR) { BLC_LOGE(\"updateAndRelease: failed to release buffer: %s (%d)\", strerror(-status), status); err = status; // keep going, with error raised [?] } } else { pendingRelease-\u003ecurrentTexture = mCurrentTexture; pendingRelease-\u003egraphicBuffer = mCurrentTextureBuffer-\u003egetBuffer(); pendingRelease-\u003eisPending = true; } } // Update the BufferLayerConsumer state. mCurrentTexture = slot; mCurrentTextureBuffer = nextTextureBuffer; mCurrentCrop = item.mCrop; mCurrentTransform = item.mTransform; mCurrentScalingMode = item.mScalingMode; mCurrentTimestamp = item.mTimestamp; mCurrentDataSpace = static_cast(item.mDataSpace); mCurrentHdrMetadata = item.mHdrMetadata; mCurrentFence = item.mFence; mCurrentFenceTime = item.mFenceTime; mCurrentFrameNumber = item.mFrameNumber; mCurrentTransformToDisplayInverse = item.mTransformToDisplayInverse; mCurrentSurfaceDamage = item.mSurfaceDamage; mCurrentApi = item.mApi; computeCurrentTransformMatrixLocked(); return err; } ConsumerBase releaseBufferLocked BufferLayerConsumerç»§æ‰¿äºConsumerBaseï¼Œè°ƒç”¨ConsumerBaseçš„releaseBufferLockedæ–¹æ³•ï¼š //frameworks/native/libs/gui/ConsumerBase.cpp status_t ConsumerBase::releaseBufferLocked( int slot, const sp graphicBuffer, EGLDisplay display, EGLSyncKHR eglFence) { if (mAbandoned) { CB_LOGE(\"releaseBufferLocked: ConsumerBase is abandoned!\"); return NO_INIT; } // If consumer no longer tracks this graphicBuffer (we received a new // buffer on the same slot), the buffer producer is definitely no longer // tracking it. if (!stillTracking(slot, graphicBuffer)) { return OK; } CB_LOGV(\"releaseBufferLocked: slot=%d/%\" PRIu64, slot, mSlots[slot].mFrameNumber); status_t err = mConsumer-\u003ereleaseBuffer(slot, mSlots[slot].mFrameNumber, display, eglFence, mSlots[slot].mFence); if (err == IGraphicBufferConsumer::STALE_BUFFER_SLOT) { freeBufferLocked(slot); } mPrevFinalReleaseFence = mSlots[slot].mFence; mSlots[slot].mFence = Fence::NO_FENCE; return err; } è°ƒç”¨mConsumer(IGraphicBufferConsumer)çš„releaseBuffer //frameworks/native/include/gui/IGraphicBufferConsumer.h using ReleaseBuffer = decltype(\u0026IGraphicBufferConsumer::releaseHelper); //frameworks/native/libs/gui/IGraphicBufferConsumer.cpp status_t BnGraphicBufferConsumer::onTransact(uint32_t code, const Parcel\u0026 data, Parcel* reply, uint32_t flags) { if (code \u003c IBinder::FIRST_CALL_TRANSACTION || code \u003e static_cast(Tag::LAST)) { return BBinder::onTransact(code, data, reply, flags); } auto tag = static_cast(code); switch (tag) { case Tag::RELEASE_BUFFER: return callLocal(data, reply, \u0026IGraphicBufferConsumer::releaseHelper); } } } seBufferæ–¹æ³•ï¼ŒIGraphicBufferConsumeræ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”±BpGraphicBufferConsumerå®ç°ï¼š //frameworks/native/libs/gui/IGraphicBufferConsumer.cpp class BpGraphicBufferConsumer : public SafeBpInterface { status_t releaseBuffer(int buf, uint64_t frameNumber, EGLDisplay display __attribut","date":"2024-11-06","objectID":"/posts/android13-bufferqueuelayer-updateteximage%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:2","tags":["clippings","è½¬è½½","blog"],"title":"Android13 BufferQueueLayer updateTexImageæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueuelayer-updateteximage%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#consumerbase-releasebufferlocked"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"BufferLayerConsumer updateAndReleaseLocked è°ƒç”¨BufferLayerConsumerçš„updateAndReleaseLockedæ–¹æ³•ï¼Œé‡Šæ”¾å›¾åƒç¼“å†²åŒºï¼š //frameworks/native/services/surfaceflinger/BufferLayerConsumer.cpp status_t BufferLayerConsumer::updateAndReleaseLocked(const BufferItem\u0026 item, PendingRelease* pendingRelease) { status_t err = NO_ERROR; int slot = item.mSlot; BLC_LOGV(\"updateAndRelease: (slot=%d buf=%p) -\u003e (slot=%d buf=%p)\", mCurrentTexture, (mCurrentTextureBuffer != nullptr \u0026\u0026 mCurrentTextureBuffer-\u003egetBuffer() != nullptr) ? mCurrentTextureBuffer-\u003egetBuffer()-\u003ehandle : 0, slot, mSlots[slot].mGraphicBuffer-\u003ehandle); // Hang onto the pointer so that it isn't freed in the call to // releaseBufferLocked() if we're in shared buffer mode and both buffers are // the same. std::shared_ptr nextTextureBuffer; { std::lock_guard lock(mImagesMutex); nextTextureBuffer = mImages[slot]; } // release old buffer if (mCurrentTexture != BufferQueue::INVALID_BUFFER_SLOT) { if (pendingRelease == nullptr) { status_t status = releaseBufferLocked(mCurrentTexture, mCurrentTextureBuffer-\u003egetBuffer()); if (status \u003c NO_ERROR) { BLC_LOGE(\"updateAndRelease: failed to release buffer: %s (%d)\", strerror(-status), status); err = status; // keep going, with error raised [?] } } else { pendingRelease-\u003ecurrentTexture = mCurrentTexture; pendingRelease-\u003egraphicBuffer = mCurrentTextureBuffer-\u003egetBuffer(); pendingRelease-\u003eisPending = true; } } // Update the BufferLayerConsumer state. mCurrentTexture = slot; mCurrentTextureBuffer = nextTextureBuffer; mCurrentCrop = item.mCrop; mCurrentTransform = item.mTransform; mCurrentScalingMode = item.mScalingMode; mCurrentTimestamp = item.mTimestamp; mCurrentDataSpace = static_cast(item.mDataSpace); mCurrentHdrMetadata = item.mHdrMetadata; mCurrentFence = item.mFence; mCurrentFenceTime = item.mFenceTime; mCurrentFrameNumber = item.mFrameNumber; mCurrentTransformToDisplayInverse = item.mTransformToDisplayInverse; mCurrentSurfaceDamage = item.mSurfaceDamage; mCurrentApi = item.mApi; computeCurrentTransformMatrixLocked(); return err; } ConsumerBase releaseBufferLocked BufferLayerConsumerç»§æ‰¿äºConsumerBaseï¼Œè°ƒç”¨ConsumerBaseçš„releaseBufferLockedæ–¹æ³•ï¼š //frameworks/native/libs/gui/ConsumerBase.cpp status_t ConsumerBase::releaseBufferLocked( int slot, const sp graphicBuffer, EGLDisplay display, EGLSyncKHR eglFence) { if (mAbandoned) { CB_LOGE(\"releaseBufferLocked: ConsumerBase is abandoned!\"); return NO_INIT; } // If consumer no longer tracks this graphicBuffer (we received a new // buffer on the same slot), the buffer producer is definitely no longer // tracking it. if (!stillTracking(slot, graphicBuffer)) { return OK; } CB_LOGV(\"releaseBufferLocked: slot=%d/%\" PRIu64, slot, mSlots[slot].mFrameNumber); status_t err = mConsumer-\u003ereleaseBuffer(slot, mSlots[slot].mFrameNumber, display, eglFence, mSlots[slot].mFence); if (err == IGraphicBufferConsumer::STALE_BUFFER_SLOT) { freeBufferLocked(slot); } mPrevFinalReleaseFence = mSlots[slot].mFence; mSlots[slot].mFence = Fence::NO_FENCE; return err; } è°ƒç”¨mConsumer(IGraphicBufferConsumer)çš„releaseBuffer //frameworks/native/include/gui/IGraphicBufferConsumer.h using ReleaseBuffer = decltype(\u0026IGraphicBufferConsumer::releaseHelper); //frameworks/native/libs/gui/IGraphicBufferConsumer.cpp status_t BnGraphicBufferConsumer::onTransact(uint32_t code, const Parcel\u0026 data, Parcel* reply, uint32_t flags) { if (code \u003c IBinder::FIRST_CALL_TRANSACTION || code \u003e static_cast(Tag::LAST)) { return BBinder::onTransact(code, data, reply, flags); } auto tag = static_cast(code); switch (tag) { case Tag::RELEASE_BUFFER: return callLocal(data, reply, \u0026IGraphicBufferConsumer::releaseHelper); } } } seBufferæ–¹æ³•ï¼ŒIGraphicBufferConsumeræ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”±BpGraphicBufferConsumerå®ç°ï¼š //frameworks/native/libs/gui/IGraphicBufferConsumer.cpp class BpGraphicBufferConsumer : public SafeBpInterface { status_t releaseBuffer(int buf, uint64_t frameNumber, EGLDisplay display __attribut","date":"2024-11-06","objectID":"/posts/android13-bufferqueuelayer-updateteximage%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:2","tags":["clippings","è½¬è½½","blog"],"title":"Android13 BufferQueueLayer updateTexImageæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueuelayer-updateteximage%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#buffqueueconsumer-releasebuffer"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"BufferQueueProducerçš„dequeueBufferæ–¹æ³•æ˜¯Androidç³»ç»Ÿä¸­ç”¨äºä»BufferQueueä¸­è·å–å¯ç”¨çš„ç¼“å†²åŒºçš„æ–¹æ³•ã€‚BufferQueueæ˜¯ä¸€ä¸ªç”¨äºåœ¨ä¸åŒçº¿ç¨‹ä¹‹é—´ä¼ é€’å›¾åƒæ•°æ®çš„é˜Ÿåˆ—ï¼Œå®ƒé€šå¸¸ç”¨äºå›¾åƒæ¸²æŸ“å’Œè§†é¢‘ç¼–è§£ç ç­‰åœºæ™¯ã€‚ dequeueBufferæ–¹æ³•çš„ä½œç”¨æ˜¯ä»BufferQueueä¸­è·å–ä¸€ä¸ªå¯ç”¨çš„ç¼“å†²åŒºï¼Œå¹¶è¿”å›è¯¥ç¼“å†²åŒºçš„ç´¢å¼•ã€‚å¦‚æœæ²¡æœ‰å¯ç”¨çš„ç¼“å†²åŒºï¼Œåˆ™è¯¥æ–¹æ³•ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰å¯ç”¨çš„ç¼“å†²åŒºä¸ºæ­¢ã€‚ åœ¨è°ƒç”¨dequeueBufferæ–¹æ³•ä¹‹å‰ï¼Œéœ€è¦å…ˆé€šè¿‡BufferQueueçš„getBufferCountæ–¹æ³•è·å–å¯ç”¨ç¼“å†²åŒºçš„æ•°é‡ã€‚ç„¶åï¼Œé€šè¿‡dequeueBufferæ–¹æ³•è·å–ä¸€ä¸ªå¯ç”¨çš„ç¼“å†²åŒºï¼Œå¹¶å°†å…¶ç´¢å¼•ä½œä¸ºå‚æ•°ä¼ é€’ç»™å…¶ä»–ç›¸å…³çš„æ–¹æ³•ï¼Œå¦‚å›¾åƒæ¸²æŸ“æˆ–è§†é¢‘ç¼–è§£ç ç­‰ã€‚ ä»£ç å¦‚ä¸‹ï¼š //frameworks/native/libs/gui/BufferQueueProducer.cpp class BufferQueueProducer : public BnGraphicBufferProducer { status_t BufferQueueProducer::dequeueBuffer(int* outSlot, sp\u003candroid::Fence\u003e* outFence, uint32_t width, uint32_t height, PixelFormat format, uint64_t usage, uint64_t* outBufferAge, FrameEventHistoryDelta* outTimestamps) { ATRACE_CALL(); { // Autolock scope std::lock_guard\u003cstd::mutex\u003e lock(mCore-\u003emMutex); mConsumerName = mCore-\u003emConsumerName; if (mCore-\u003emIsAbandoned) { BQ_LOGE(\"dequeueBuffer: BufferQueue has been abandoned\"); return NO_INIT; } if (mCore-\u003emConnectedApi == BufferQueueCore::NO_CONNECTED_API) { BQ_LOGE(\"dequeueBuffer: BufferQueue has no connected producer\"); return NO_INIT; } } // Autolock scope BQ_LOGV(\"dequeueBuffer: w=%u h=%u format=%#x, usage=%#\" PRIx64, width, height, format, usage); if ((width \u0026\u0026 !height) || (!width \u0026\u0026 height)) { BQ_LOGE(\"dequeueBuffer: invalid size: w=%u h=%u\", width, height); return BAD_VALUE; } status_t returnFlags = NO_ERROR; EGLDisplay eglDisplay = EGL_NO_DISPLAY; EGLSyncKHR eglFence = EGL_NO_SYNC_KHR; bool attachedByConsumer = false; { // Autolock scope std::unique_lock\u003cstd::mutex\u003e lock(mCore-\u003emMutex); // If we don't have a free buffer, but we are currently allocating, we wait until allocation // is finished such that we don't allocate in parallel. if (mCore-\u003emFreeBuffers.empty() \u0026\u0026 mCore-\u003emIsAllocating) { mDequeueWaitingForAllocation = true; mCore-\u003ewaitWhileAllocatingLocked(lock); mDequeueWaitingForAllocation = false; mDequeueWaitingForAllocationCondition.notify_all(); } if (format == 0) { format = mCore-\u003emDefaultBufferFormat; } // Enable the usage bits the consumer requested usage |= mCore-\u003emConsumerUsageBits; const bool useDefaultSize = !width \u0026\u0026 !height; if (useDefaultSize) { width = mCore-\u003emDefaultWidth; height = mCore-\u003emDefaultHeight; if (mCore-\u003emAutoPrerotation \u0026\u0026 (mCore-\u003emTransformHintInUse \u0026 NATIVE_WINDOW_TRANSFORM_ROT_90)) { std::swap(width, height); } } int found = BufferItem::INVALID_BUFFER_SLOT; while (found == BufferItem::INVALID_BUFFER_SLOT) { status_t status = waitForFreeSlotThenRelock(FreeSlotCaller::Dequeue, lock, \u0026found); if (status != NO_ERROR) { return status; } // This should not happen if (found == BufferQueueCore::INVALID_BUFFER_SLOT) { BQ_LOGE(\"dequeueBuffer: no available buffer slots\"); return -EBUSY; } const sp\u003cGraphicBuffer\u003e\u0026 buffer(mSlots[found].mGraphicBuffer); // If we are not allowed to allocate new buffers, // waitForFreeSlotThenRelock must have returned a slot containing a // buffer. If this buffer would require reallocation to meet the // requested attributes, we free it and attempt to get another one. if (!mCore-\u003emAllowAllocation) { if (buffer-\u003eneedsReallocation(width, height, format, BQ_LAYER_COUNT, usage)) { //æ£€æŸ¥æ˜¯å¦å·²åˆ†é…äº†GraphicBuffer if (mCore-\u003emSharedBufferSlot == found) { BQ_LOGE(\"dequeueBuffer: cannot re-allocate a sharedbuffer\"); return BAD_VALUE; } mCore-\u003emFreeSlots.insert(found); mCore-\u003eclearBufferSlotLocked(found); found = BufferItem::INVALID_BUFFER_SLOT; continue; } } } const sp\u003cGraphicBuffer\u003e\u0026 buffer(mSlots[found].mGraphicBuffer); if (mCore-\u003emSharedBufferSlot == found \u0026\u0026 buffer-\u003eneedsReallocation(width, height, format, BQ_LAYER_COUNT, usage)) { BQ_LOGE(\"dequeueBuffer: cannot re-allocate a shared\" \"buffer\"); return BAD_VALUE; } if (mCore-\u003emSharedBufferSlot != found) { mCore-\u003emActiveBuffers.insert(found); } *outSlot = found; ATRACE_BUFFER_INDEX(found); attachedByConsumer = mSlots[found].mNeedsReallocation; mSlots[found].mNeedsReallocation = false; mSlots[found].mBufferState.dequeue(); if ((buffer == nullptr) || buffer-\u003eneedsReallocation(width, height, format, BQ_LAYER_COUNT, usage)) { mSlots","date":"2024-11-06","objectID":"/posts/android13-bufferqueueproducer-dequeuebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 BufferQueueProducer dequeueBufferæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueueproducer-dequeuebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"new GraphicBuffer é€šè¿‡newçš„æ–¹å¼åˆ›å»ºGraphicBufferå¯¹è±¡ï¼š Android13 GraphicBuffer åˆ›å»ºæµç¨‹-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android13-bufferqueueproducer-dequeuebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 BufferQueueProducer dequeueBufferæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueueproducer-dequeuebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#new-graphicbuffer"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"BufferQueueProducerçš„queueBufferæ–¹æ³•ç”¨äºå°†å›¾å½¢ç¼“å†²åŒºæ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ã€‚å½“åº”ç”¨ç¨‹åºå®Œæˆå¯¹å›¾å½¢ç¼“å†²åŒºçš„ç»˜åˆ¶åï¼Œå¯ä»¥è°ƒç”¨queueBufferæ–¹æ³•å°†å…¶æäº¤ç»™SurfaceFlingerè¿›è¡Œæ˜¾ç¤ºã€‚ //frameworks/native/libs/gui/BufferQueueProducer.cpp class BufferQueueProducer : public BnGraphicBufferProducer { status_t BufferQueueProducer::queueBuffer(int slot, const QueueBufferInput \u0026input, QueueBufferOutput *output) { ATRACE_CALL(); ATRACE_BUFFER_INDEX(slot); int64_t requestedPresentTimestamp; bool isAutoTimestamp; android_dataspace dataSpace; Rect crop(Rect::EMPTY_RECT); int scalingMode; uint32_t transform; uint32_t stickyTransform; sp\u003cFence\u003e acquireFence; bool getFrameTimestamps = false; input.deflate(\u0026requestedPresentTimestamp, \u0026isAutoTimestamp, \u0026dataSpace, \u0026crop, \u0026scalingMode, \u0026transform, \u0026acquireFence, \u0026stickyTransform, \u0026getFrameTimestamps); const Region\u0026 surfaceDamage = input.getSurfaceDamage(); const HdrMetadata\u0026 hdrMetadata = input.getHdrMetadata(); if (acquireFence == nullptr) { BQ_LOGE(\"queueBuffer: fence is NULL\"); return BAD_VALUE; } auto acquireFenceTime = std::make_shared\u003cFenceTime\u003e(acquireFence); switch (scalingMode) { case NATIVE_WINDOW_SCALING_MODE_FREEZE: case NATIVE_WINDOW_SCALING_MODE_SCALE_TO_WINDOW: case NATIVE_WINDOW_SCALING_MODE_SCALE_CROP: case NATIVE_WINDOW_SCALING_MODE_NO_SCALE_CROP: break; default: BQ_LOGE(\"queueBuffer: unknown scaling mode %d\", scalingMode); return BAD_VALUE; } sp\u003cIConsumerListener\u003e frameAvailableListener; sp\u003cIConsumerListener\u003e frameReplacedListener; int callbackTicket = 0; uint64_t currentFrameNumber = 0; BufferItem item; { // Autolock scope std::lock_guard\u003cstd::mutex\u003e lock(mCore-\u003emMutex); if (mCore-\u003emIsAbandoned) { BQ_LOGE(\"queueBuffer: BufferQueue has been abandoned\"); return NO_INIT; } if (mCore-\u003emConnectedApi == BufferQueueCore::NO_CONNECTED_API) { BQ_LOGE(\"queueBuffer: BufferQueue has no connected producer\"); return NO_INIT; } if (slot \u003c 0 || slot \u003e= BufferQueueDefs::NUM_BUFFER_SLOTS) { BQ_LOGE(\"queueBuffer: slot index %d out of range [0, %d)\", slot, BufferQueueDefs::NUM_BUFFER_SLOTS); return BAD_VALUE; } else if (!mSlots[slot].mBufferState.isDequeued()) { BQ_LOGE(\"queueBuffer: slot %d is not owned by the producer \" \"(state = %s)\", slot, mSlots[slot].mBufferState.string()); return BAD_VALUE; } else if (!mSlots[slot].mRequestBufferCalled) { BQ_LOGE(\"queueBuffer: slot %d was queued without requesting \" \"a buffer\", slot); return BAD_VALUE; } // If shared buffer mode has just been enabled, cache the slot of the // first buffer that is queued and mark it as the shared buffer. if (mCore-\u003emSharedBufferMode \u0026\u0026 mCore-\u003emSharedBufferSlot == BufferQueueCore::INVALID_BUFFER_SLOT) { mCore-\u003emSharedBufferSlot = slot; mSlots[slot].mBufferState.mShared = true; } BQ_LOGV(\"queueBuffer: slot=%d/%\" PRIu64 \" time=%\" PRIu64 \" dataSpace=%d\" \" validHdrMetadataTypes=0x%x crop=[%d,%d,%d,%d] transform=%#x scale=%s\", slot, mCore-\u003emFrameCounter + 1, requestedPresentTimestamp, dataSpace, hdrMetadata.validTypes, crop.left, crop.top, crop.right, crop.bottom, transform, BufferItem::scalingModeName(static_cast\u003cuint32_t\u003e(scalingMode))); const sp\u003cGraphicBuffer\u003e\u0026 graphicBuffer(mSlots[slot].mGraphicBuffer); Rect bufferRect(graphicBuffer-\u003egetWidth(), graphicBuffer-\u003egetHeight()); Rect croppedRect(Rect::EMPTY_RECT); crop.intersect(bufferRect, \u0026croppedRect); if (croppedRect != crop) { BQ_LOGE(\"queueBuffer: crop rect is not contained within the \" \"buffer in slot %d\", slot); return BAD_VALUE; } // Override UNKNOWN dataspace with consumer default if (dataSpace == HAL_DATASPACE_UNKNOWN) { dataSpace = mCore-\u003emDefaultBufferDataSpace; } mSlots[slot].mFence = acquireFence; mSlots[slot].mBufferState.queue(); // Increment the frame counter and store a local version of it // for use outside the lock on mCore-\u003emMutex. ++mCore-\u003emFrameCounter; currentFrameNumber = mCore-\u003emFrameCounter; mSlots[slot].mFrameNumber = currentFrameNumber; item.mAcquireCalled = mSlots[slot].mAcquireCalled; item.mGraphicBuffer = mSlots[slot].mGraphicBuffer; item.mCrop = crop; item.mTransform = transform \u0026 ~static_cast\u003cuint32_t\u003e(NATIVE_WINDOW_T","date":"2024-11-06","objectID":"/posts/android13-bufferqueueproducer-queuebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 BufferQueueProducer queueBufferæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueueproducer-queuebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"BufferQueueProducerçš„queueBufferæ–¹æ³•ç”¨äºå°†å›¾å½¢ç¼“å†²åŒºæ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ã€‚å½“åº”ç”¨ç¨‹åºå®Œæˆå¯¹å›¾å½¢ç¼“å†²åŒºçš„ç»˜åˆ¶åï¼Œå¯ä»¥è°ƒç”¨queueBufferæ–¹æ³•å°†å…¶æäº¤ç»™SurfaceFlingerè¿›è¡Œæ˜¾ç¤ºã€‚ //frameworks/native/libs/gui/BufferQueueProducer.cpp class BufferQueueProducer : public BnGraphicBufferProducer { status_t BufferQueueProducer::queueBuffer(int slot, const QueueBufferInput \u0026input, QueueBufferOutput *output) { ATRACE_CALL(); ATRACE_BUFFER_INDEX(slot); int64_t requestedPresentTimestamp; bool isAutoTimestamp; android_dataspace dataSpace; Rect crop(Rect::EMPTY_RECT); int scalingMode; uint32_t transform; uint32_t stickyTransform; sp acquireFence; bool getFrameTimestamps = false; input.deflate(\u0026requestedPresentTimestamp, \u0026isAutoTimestamp, \u0026dataSpace, \u0026crop, \u0026scalingMode, \u0026transform, \u0026acquireFence, \u0026stickyTransform, \u0026getFrameTimestamps); const Region\u0026 surfaceDamage = input.getSurfaceDamage(); const HdrMetadata\u0026 hdrMetadata = input.getHdrMetadata(); if (acquireFence == nullptr) { BQ_LOGE(\"queueBuffer: fence is NULL\"); return BAD_VALUE; } auto acquireFenceTime = std::make_shared(acquireFence); switch (scalingMode) { case NATIVE_WINDOW_SCALING_MODE_FREEZE: case NATIVE_WINDOW_SCALING_MODE_SCALE_TO_WINDOW: case NATIVE_WINDOW_SCALING_MODE_SCALE_CROP: case NATIVE_WINDOW_SCALING_MODE_NO_SCALE_CROP: break; default: BQ_LOGE(\"queueBuffer: unknown scaling mode %d\", scalingMode); return BAD_VALUE; } sp frameAvailableListener; sp frameReplacedListener; int callbackTicket = 0; uint64_t currentFrameNumber = 0; BufferItem item; { // Autolock scope std::lock_guard lock(mCore-\u003emMutex); if (mCore-\u003emIsAbandoned) { BQ_LOGE(\"queueBuffer: BufferQueue has been abandoned\"); return NO_INIT; } if (mCore-\u003emConnectedApi == BufferQueueCore::NO_CONNECTED_API) { BQ_LOGE(\"queueBuffer: BufferQueue has no connected producer\"); return NO_INIT; } if (slot \u003c 0 || slot \u003e= BufferQueueDefs::NUM_BUFFER_SLOTS) { BQ_LOGE(\"queueBuffer: slot index %d out of range [0, %d)\", slot, BufferQueueDefs::NUM_BUFFER_SLOTS); return BAD_VALUE; } else if (!mSlots[slot].mBufferState.isDequeued()) { BQ_LOGE(\"queueBuffer: slot %d is not owned by the producer \" \"(state = %s)\", slot, mSlots[slot].mBufferState.string()); return BAD_VALUE; } else if (!mSlots[slot].mRequestBufferCalled) { BQ_LOGE(\"queueBuffer: slot %d was queued without requesting \" \"a buffer\", slot); return BAD_VALUE; } // If shared buffer mode has just been enabled, cache the slot of the // first buffer that is queued and mark it as the shared buffer. if (mCore-\u003emSharedBufferMode \u0026\u0026 mCore-\u003emSharedBufferSlot == BufferQueueCore::INVALID_BUFFER_SLOT) { mCore-\u003emSharedBufferSlot = slot; mSlots[slot].mBufferState.mShared = true; } BQ_LOGV(\"queueBuffer: slot=%d/%\" PRIu64 \" time=%\" PRIu64 \" dataSpace=%d\" \" validHdrMetadataTypes=0x%x crop=[%d,%d,%d,%d] transform=%#x scale=%s\", slot, mCore-\u003emFrameCounter + 1, requestedPresentTimestamp, dataSpace, hdrMetadata.validTypes, crop.left, crop.top, crop.right, crop.bottom, transform, BufferItem::scalingModeName(static_cast(scalingMode))); const sp\u0026 graphicBuffer(mSlots[slot].mGraphicBuffer); Rect bufferRect(graphicBuffer-\u003egetWidth(), graphicBuffer-\u003egetHeight()); Rect croppedRect(Rect::EMPTY_RECT); crop.intersect(bufferRect, \u0026croppedRect); if (croppedRect != crop) { BQ_LOGE(\"queueBuffer: crop rect is not contained within the \" \"buffer in slot %d\", slot); return BAD_VALUE; } // Override UNKNOWN dataspace with consumer default if (dataSpace == HAL_DATASPACE_UNKNOWN) { dataSpace = mCore-\u003emDefaultBufferDataSpace; } mSlots[slot].mFence = acquireFence; mSlots[slot].mBufferState.queue(); // Increment the frame counter and store a local version of it // for use outside the lock on mCore-\u003emMutex. ++mCore-\u003emFrameCounter; currentFrameNumber = mCore-\u003emFrameCounter; mSlots[slot].mFrameNumber = currentFrameNumber; item.mAcquireCalled = mSlots[slot].mAcquireCalled; item.mGraphicBuffer = mSlots[slot].mGraphicBuffer; item.mCrop = crop; item.mTransform = transform \u0026 ~static_cast(NATIVE_WINDOW_T","date":"2024-11-06","objectID":"/posts/android13-bufferqueueproducer-queuebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 BufferQueueProducer queueBufferæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueueproducer-queuebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#bpconsumerlistener-onframeavailable"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"BufferQueueProducerçš„queueBufferæ–¹æ³•ç”¨äºå°†å›¾å½¢ç¼“å†²åŒºæ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ã€‚å½“åº”ç”¨ç¨‹åºå®Œæˆå¯¹å›¾å½¢ç¼“å†²åŒºçš„ç»˜åˆ¶åï¼Œå¯ä»¥è°ƒç”¨queueBufferæ–¹æ³•å°†å…¶æäº¤ç»™SurfaceFlingerè¿›è¡Œæ˜¾ç¤ºã€‚ //frameworks/native/libs/gui/BufferQueueProducer.cpp class BufferQueueProducer : public BnGraphicBufferProducer { status_t BufferQueueProducer::queueBuffer(int slot, const QueueBufferInput \u0026input, QueueBufferOutput *output) { ATRACE_CALL(); ATRACE_BUFFER_INDEX(slot); int64_t requestedPresentTimestamp; bool isAutoTimestamp; android_dataspace dataSpace; Rect crop(Rect::EMPTY_RECT); int scalingMode; uint32_t transform; uint32_t stickyTransform; sp acquireFence; bool getFrameTimestamps = false; input.deflate(\u0026requestedPresentTimestamp, \u0026isAutoTimestamp, \u0026dataSpace, \u0026crop, \u0026scalingMode, \u0026transform, \u0026acquireFence, \u0026stickyTransform, \u0026getFrameTimestamps); const Region\u0026 surfaceDamage = input.getSurfaceDamage(); const HdrMetadata\u0026 hdrMetadata = input.getHdrMetadata(); if (acquireFence == nullptr) { BQ_LOGE(\"queueBuffer: fence is NULL\"); return BAD_VALUE; } auto acquireFenceTime = std::make_shared(acquireFence); switch (scalingMode) { case NATIVE_WINDOW_SCALING_MODE_FREEZE: case NATIVE_WINDOW_SCALING_MODE_SCALE_TO_WINDOW: case NATIVE_WINDOW_SCALING_MODE_SCALE_CROP: case NATIVE_WINDOW_SCALING_MODE_NO_SCALE_CROP: break; default: BQ_LOGE(\"queueBuffer: unknown scaling mode %d\", scalingMode); return BAD_VALUE; } sp frameAvailableListener; sp frameReplacedListener; int callbackTicket = 0; uint64_t currentFrameNumber = 0; BufferItem item; { // Autolock scope std::lock_guard lock(mCore-\u003emMutex); if (mCore-\u003emIsAbandoned) { BQ_LOGE(\"queueBuffer: BufferQueue has been abandoned\"); return NO_INIT; } if (mCore-\u003emConnectedApi == BufferQueueCore::NO_CONNECTED_API) { BQ_LOGE(\"queueBuffer: BufferQueue has no connected producer\"); return NO_INIT; } if (slot \u003c 0 || slot \u003e= BufferQueueDefs::NUM_BUFFER_SLOTS) { BQ_LOGE(\"queueBuffer: slot index %d out of range [0, %d)\", slot, BufferQueueDefs::NUM_BUFFER_SLOTS); return BAD_VALUE; } else if (!mSlots[slot].mBufferState.isDequeued()) { BQ_LOGE(\"queueBuffer: slot %d is not owned by the producer \" \"(state = %s)\", slot, mSlots[slot].mBufferState.string()); return BAD_VALUE; } else if (!mSlots[slot].mRequestBufferCalled) { BQ_LOGE(\"queueBuffer: slot %d was queued without requesting \" \"a buffer\", slot); return BAD_VALUE; } // If shared buffer mode has just been enabled, cache the slot of the // first buffer that is queued and mark it as the shared buffer. if (mCore-\u003emSharedBufferMode \u0026\u0026 mCore-\u003emSharedBufferSlot == BufferQueueCore::INVALID_BUFFER_SLOT) { mCore-\u003emSharedBufferSlot = slot; mSlots[slot].mBufferState.mShared = true; } BQ_LOGV(\"queueBuffer: slot=%d/%\" PRIu64 \" time=%\" PRIu64 \" dataSpace=%d\" \" validHdrMetadataTypes=0x%x crop=[%d,%d,%d,%d] transform=%#x scale=%s\", slot, mCore-\u003emFrameCounter + 1, requestedPresentTimestamp, dataSpace, hdrMetadata.validTypes, crop.left, crop.top, crop.right, crop.bottom, transform, BufferItem::scalingModeName(static_cast(scalingMode))); const sp\u0026 graphicBuffer(mSlots[slot].mGraphicBuffer); Rect bufferRect(graphicBuffer-\u003egetWidth(), graphicBuffer-\u003egetHeight()); Rect croppedRect(Rect::EMPTY_RECT); crop.intersect(bufferRect, \u0026croppedRect); if (croppedRect != crop) { BQ_LOGE(\"queueBuffer: crop rect is not contained within the \" \"buffer in slot %d\", slot); return BAD_VALUE; } // Override UNKNOWN dataspace with consumer default if (dataSpace == HAL_DATASPACE_UNKNOWN) { dataSpace = mCore-\u003emDefaultBufferDataSpace; } mSlots[slot].mFence = acquireFence; mSlots[slot].mBufferState.queue(); // Increment the frame counter and store a local version of it // for use outside the lock on mCore-\u003emMutex. ++mCore-\u003emFrameCounter; currentFrameNumber = mCore-\u003emFrameCounter; mSlots[slot].mFrameNumber = currentFrameNumber; item.mAcquireCalled = mSlots[slot].mAcquireCalled; item.mGraphicBuffer = mSlots[slot].mGraphicBuffer; item.mCrop = crop; item.mTransform = transform \u0026 ~static_cast(NATIVE_WINDOW_T","date":"2024-11-06","objectID":"/posts/android13-bufferqueueproducer-queuebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 BufferQueueProducer queueBufferæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-bufferqueueproducer-queuebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#bufferqueuelayer-onframeavailable"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Choreographerçš„postCallback()æ–¹æ³•ç”¨äºå°†ä¸€ä¸ªä»»åŠ¡æ·»åŠ åˆ°Choreographerçš„ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œä»¥ä¾¿åœ¨ä¸‹ä¸€å¸§ç»˜åˆ¶ä¹‹å‰æ‰§è¡Œï¼Œä»£ç å¦‚ä¸‹ï¼š //frameworks/base/core/java/android/view/Choreographer.java public final class Choreographer { public void postCallback(int callbackType, Runnable action, Object token) { postCallbackDelayed(callbackType, action, token, 0); } } è°ƒç”¨Choreographerçš„postCallbackDelayedæ–¹æ³•ï¼š //frameworks/base/core/java/android/view/Choreographer.java public final class Choreographer { public void postCallbackDelayed(int callbackType, Runnable action, Object token, long delayMillis) { if (action == null) { throw new IllegalArgumentException(\"action must not be null\"); } if (callbackType \u003c 0 || callbackType \u003e CALLBACK_LAST) { throw new IllegalArgumentException(\"callbackType is invalid\"); } postCallbackDelayedInternal(callbackType, action, token, delayMillis); } } è°ƒç”¨Choreographerçš„postCallbackDelayedInternalæ–¹æ³•ï¼š //frameworks/base/core/java/android/view/Choreographer.java public final class Choreographer { private void postCallbackDelayedInternal(int callbackType, Object action, Object token, long delayMillis) { if (DEBUG_FRAMES) { Log.d(TAG, \"PostCallback: type=\" + callbackType + \", action=\" + action + \", token=\" + token + \", delayMillis=\" + delayMillis); } synchronized (mLock) { //æ·»åŠ ç±»å‹ä¸ºcallbackTypeçš„CallbackQueueï¼ˆå°†è¦æ‰§è¡Œçš„å›è°ƒå°è£…è€Œæˆï¼‰ final long now = SystemClock.uptimeMillis(); final long dueTime = now + delayMillis; mCallbackQueues[callbackType].addCallbackLocked(dueTime, action, token); if (dueTime \u003c= now) { //ç«‹å³æ‰§è¡Œ scheduleFrameLocked(now); } else { //å¼‚æ­¥å›è°ƒå»¶è¿Ÿæ‰§è¡Œ Message msg = mHandler.obtainMessage(MSG_DO_SCHEDULE_CALLBACK, action); msg.arg1 = callbackType; msg.setAsynchronous(true); mHandler.sendMessageAtTime(msg, dueTime); } } } } è°ƒç”¨Choreographerçš„scheduleFrameLockedæ–¹æ³•ï¼š //frameworks/base/core/java/android/view/Choreographer.java public final class Choreographer { private void scheduleFrameLocked(long now) { if (!mFrameScheduled) { mFrameScheduled = true; if (USE_VSYNC) { if (DEBUG_FRAMES) { Log.d(TAG, \"Scheduling next frame on vsync.\"); } // If running on the Looper thread, then schedule the vsync immediately, // otherwise post a message to schedule the vsync from the UI thread // as soon as possible. //æ£€æµ‹å½“å‰çš„Looperçº¿ç¨‹æ˜¯ä¸æ˜¯ä¸»çº¿ç¨‹ if (isRunningOnLooperThreadLocked()) { //å½“è¿è¡Œåœ¨Looperçº¿ç¨‹ï¼Œåˆ™ç«‹åˆ»è°ƒåº¦vsync scheduleVsyncLocked(); } else { //åˆ‡æ¢åˆ°ä¸»çº¿ç¨‹ï¼Œè°ƒåº¦vsync Message msg = mHandler.obtainMessage(MSG_DO_SCHEDULE_VSYNC); msg.setAsynchronous(true); mHandler.sendMessageAtFrontOfQueue(msg); } } else { //å¦‚æœæ²¡æœ‰VSYNCçš„åŒæ­¥ï¼Œåˆ™å‘é€æ¶ˆæ¯åˆ·æ–°ç”»é¢ final long nextFrameTime = Math.max( mLastFrameTimeNanos / TimeUtils.NANOS_PER_MS + sFrameDelay, now); if (DEBUG_FRAMES) { Log.d(TAG, \"Scheduling next frame in \" + (nextFrameTime - now) + \" ms.\"); } Message msg = mHandler.obtainMessage(MSG_DO_FRAME); msg.setAsynchronous(true); mHandler.sendMessageAtTime(msg, nextFrameTime); } } } } è°ƒç”¨Choreographerçš„scheduleVsyncLockedæ–¹æ³•ï¼š //frameworks/base/core/java/android/view/Choreographer.java public final class Choreographer { private final FrameDisplayEventReceiver mDisplayEventReceiver; private void scheduleVsyncLocked() { try { Trace.traceBegin(Trace.TRACE_TAG_VIEW, \"Choreographer#scheduleVsyncLocked\"); mDisplayEventReceiver.scheduleVsync(); } finally { Trace.traceEnd(Trace.TRACE_TAG_VIEW); } } } ","date":"2024-11-06","objectID":"/posts/android13-choreographer-postcallback%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 Choreographer postCallbackæµç¨‹åˆ†æ_choreographer.postcallback-CSDNåšå®¢","uri":"/posts/android13-choreographer-postcallback%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"DisplayEventReceiver scheduleVsync è°ƒç”¨mDisplayEventReceiver(FrameDisplayEventReceiver)çš„scheduleVsyncæ–¹æ³•ï¼ŒFrameDisplayEventReceiverç»§æ‰¿DisplayEventReceiverï¼Œå®é™…è°ƒç”¨DisplayEventReceiverçš„scheduleVsyncæ–¹æ³•ï¼š //frameworks/base/core/java/android/view/DisplayEventReceiver.java public abstract class DisplayEventReceiver { public void scheduleVsync() { if (mReceiverPtr == 0) { Log.w(TAG, \"Attempted to schedule a vertical sync pulse but the display event \" + \"receiver has already been disposed.\"); } else { nativeScheduleVsync(mReceiverPtr); } } } ","date":"2024-11-06","objectID":"/posts/android13-choreographer-postcallback%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 Choreographer postCallbackæµç¨‹åˆ†æ_choreographer.postcallback-CSDNåšå®¢","uri":"/posts/android13-choreographer-postcallback%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#displayeventreceiver-schedulevsync"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"nativeScheduleVsync è°ƒç”¨nativeScheduleVsyncæ–¹æ³•ï¼ŒnativeScheduleVsyncæ˜¯ä¸€ä¸ªnativeæ–¹æ³•ï¼Œåœ¨android_view_DisplayEventReceiver.cppä¸­å®ç°ï¼š //frameworks/base/core/jni/android_view_DisplayEventReceiver.cpp static void nativeScheduleVsync(JNIEnv* env, jclass clazz, jlong receiverPtr) { sp\u003cNativeDisplayEventReceiver\u003e receiver = reinterpret_cast\u003cNativeDisplayEventReceiver*\u003e(receiverPtr); status_t status = receiver-\u003escheduleVsync(); //å®‰æ’å‚ç›´åŒæ­¥ if (status) { String8 message; message.appendFormat(\"Failed to schedule next vertical sync pulse. status=%d\", status); jniThrowRuntimeException(env, message.string()); } } DisplayEventDispatcher scheduleVsync è°ƒç”¨DisplayEventDispatcherçš„scheduleVsyncæ–¹æ³•ï¼š //frameworks/native/libs/gui/DisplayEventDispatcher.cpp status_t DisplayEventDispatcher::scheduleVsync() { if (!mWaitingForVsync) { ALOGV(\"dispatcher %p ~ Scheduling vsync.\", this); // Drain all pending events. nsecs_t vsyncTimestamp; PhysicalDisplayId vsyncDisplayId; uint32_t vsyncCount; VsyncEventData vsyncEventData; if (processPendingEvents(\u0026vsyncTimestamp, \u0026vsyncDisplayId, \u0026vsyncCount, \u0026vsyncEventData)) { ALOGE(\"dispatcher %p ~ last event processed while scheduling was for %\" PRId64 \"\", this, ns2ms(static_cast\u003cnsecs_t\u003e(vsyncTimestamp))); } status_t status = mReceiver.requestNextVsync(); if (status) { ALOGW(\"Failed to request next vsync, status=%d\", status); return status; } mWaitingForVsync = true; mLastScheduleVsyncTime = systemTime(SYSTEM_TIME_MONOTONIC); } return OK; }``` è°ƒç”¨processPendingEventsæ–¹æ³•ï¼š ```cpp //frameworks/native/libs/gui/DisplayEventDispatcher.cpp bool DisplayEventDispatcher::processPendingEvents(nsecs_t* outTimestamp, PhysicalDisplayId* outDisplayId, uint32_t* outCount, VsyncEventData* outVsyncEventData) { bool gotVsync = false; DisplayEventReceiver::Event buf[EVENT_BUFFER_SIZE]; ssize_t n; while ((n = mReceiver.getEvents(buf, EVENT_BUFFER_SIZE)) \u003e 0) { ALOGV(\"dispatcher %p ~ Read %d events.\", this, int(n)); mFrameRateOverrides.reserve(n); for (ssize_t i = 0; i \u003c n; i++) { const DisplayEventReceiver::Event\u0026 ev = buf[i]; switch (ev.header.type) { case DisplayEventReceiver::DISPLAY_EVENT_VSYNC: // Later vsync events will just overwrite the info from earlier // ones. That's fine, we only care about the most recent. gotVsync = true; *outTimestamp = ev.header.timestamp; *outDisplayId = ev.header.displayId; *outCount = ev.vsync.count; *outVsyncEventData = ev.vsync.vsyncData; break; case DisplayEventReceiver::DISPLAY_EVENT_HOTPLUG: dispatchHotplug(ev.header.timestamp, ev.header.displayId, ev.hotplug.connected); break; case DisplayEventReceiver::DISPLAY_EVENT_MODE_CHANGE: dispatchModeChanged(ev.header.timestamp, ev.header.displayId, ev.modeChange.modeId, ev.modeChange.vsyncPeriod); break; case DisplayEventReceiver::DISPLAY_EVENT_NULL: dispatchNullEvent(ev.header.timestamp, ev.header.displayId); break; case DisplayEventReceiver::DISPLAY_EVENT_FRAME_RATE_OVERRIDE: mFrameRateOverrides.emplace_back(ev.frameRateOverride); break; case DisplayEventReceiver::DISPLAY_EVENT_FRAME_RATE_OVERRIDE_FLUSH: dispatchFrameRateOverrides(ev.header.timestamp, ev.header.displayId, std::move(mFrameRateOverrides)); break; default: ALOGW(\"dispatcher %p ~ ignoring unknown event type %#x\", this, ev.header.type); break; } } } if (n \u003c 0) { ALOGW(\"Failed to get events from display event dispatcher, status=%d\", status_t(n)); } return gotVsync; } ","date":"2024-11-06","objectID":"/posts/android13-choreographer-postcallback%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 Choreographer postCallbackæµç¨‹åˆ†æ_choreographer.postcallback-CSDNåšå®¢","uri":"/posts/android13-choreographer-postcallback%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#nativeschedulevsync"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"nativeScheduleVsync è°ƒç”¨nativeScheduleVsyncæ–¹æ³•ï¼ŒnativeScheduleVsyncæ˜¯ä¸€ä¸ªnativeæ–¹æ³•ï¼Œåœ¨android_view_DisplayEventReceiver.cppä¸­å®ç°ï¼š //frameworks/base/core/jni/android_view_DisplayEventReceiver.cpp static void nativeScheduleVsync(JNIEnv* env, jclass clazz, jlong receiverPtr) { sp receiver = reinterpret_cast(receiverPtr); status_t status = receiver-\u003escheduleVsync(); //å®‰æ’å‚ç›´åŒæ­¥ if (status) { String8 message; message.appendFormat(\"Failed to schedule next vertical sync pulse. status=%d\", status); jniThrowRuntimeException(env, message.string()); } } DisplayEventDispatcher scheduleVsync è°ƒç”¨DisplayEventDispatcherçš„scheduleVsyncæ–¹æ³•ï¼š //frameworks/native/libs/gui/DisplayEventDispatcher.cpp status_t DisplayEventDispatcher::scheduleVsync() { if (!mWaitingForVsync) { ALOGV(\"dispatcher %p ~ Scheduling vsync.\", this); // Drain all pending events. nsecs_t vsyncTimestamp; PhysicalDisplayId vsyncDisplayId; uint32_t vsyncCount; VsyncEventData vsyncEventData; if (processPendingEvents(\u0026vsyncTimestamp, \u0026vsyncDisplayId, \u0026vsyncCount, \u0026vsyncEventData)) { ALOGE(\"dispatcher %p ~ last event processed while scheduling was for %\" PRId64 \"\", this, ns2ms(static_cast(vsyncTimestamp))); } status_t status = mReceiver.requestNextVsync(); if (status) { ALOGW(\"Failed to request next vsync, status=%d\", status); return status; } mWaitingForVsync = true; mLastScheduleVsyncTime = systemTime(SYSTEM_TIME_MONOTONIC); } return OK; }``` è°ƒç”¨processPendingEventsæ–¹æ³•ï¼š ```cpp //frameworks/native/libs/gui/DisplayEventDispatcher.cpp bool DisplayEventDispatcher::processPendingEvents(nsecs_t* outTimestamp, PhysicalDisplayId* outDisplayId, uint32_t* outCount, VsyncEventData* outVsyncEventData) { bool gotVsync = false; DisplayEventReceiver::Event buf[EVENT_BUFFER_SIZE]; ssize_t n; while ((n = mReceiver.getEvents(buf, EVENT_BUFFER_SIZE)) \u003e 0) { ALOGV(\"dispatcher %p ~ Read %d events.\", this, int(n)); mFrameRateOverrides.reserve(n); for (ssize_t i = 0; i \u003c n; i++) { const DisplayEventReceiver::Event\u0026 ev = buf[i]; switch (ev.header.type) { case DisplayEventReceiver::DISPLAY_EVENT_VSYNC: // Later vsync events will just overwrite the info from earlier // ones. That's fine, we only care about the most recent. gotVsync = true; *outTimestamp = ev.header.timestamp; *outDisplayId = ev.header.displayId; *outCount = ev.vsync.count; *outVsyncEventData = ev.vsync.vsyncData; break; case DisplayEventReceiver::DISPLAY_EVENT_HOTPLUG: dispatchHotplug(ev.header.timestamp, ev.header.displayId, ev.hotplug.connected); break; case DisplayEventReceiver::DISPLAY_EVENT_MODE_CHANGE: dispatchModeChanged(ev.header.timestamp, ev.header.displayId, ev.modeChange.modeId, ev.modeChange.vsyncPeriod); break; case DisplayEventReceiver::DISPLAY_EVENT_NULL: dispatchNullEvent(ev.header.timestamp, ev.header.displayId); break; case DisplayEventReceiver::DISPLAY_EVENT_FRAME_RATE_OVERRIDE: mFrameRateOverrides.emplace_back(ev.frameRateOverride); break; case DisplayEventReceiver::DISPLAY_EVENT_FRAME_RATE_OVERRIDE_FLUSH: dispatchFrameRateOverrides(ev.header.timestamp, ev.header.displayId, std::move(mFrameRateOverrides)); break; default: ALOGW(\"dispatcher %p ~ ignoring unknown event type %#x\", this, ev.header.type); break; } } } if (n \u003c 0) { ALOGW(\"Failed to get events from display event dispatcher, status=%d\", status_t(n)); } return gotVsync; } ","date":"2024-11-06","objectID":"/posts/android13-choreographer-postcallback%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 Choreographer postCallbackæµç¨‹åˆ†æ_choreographer.postcallback-CSDNåšå®¢","uri":"/posts/android13-choreographer-postcallback%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#displayeventdispatcher-schedulevsync"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"EventThreadçš„threadMainæ–¹æ³•æ— é™å¾ªç¯å¤„ç†pendingEvents,å¯¹Vsyncç±»å‹çš„Eventåˆ†å‘åˆ°æ¶ˆè´¹è€…ï¼Œé€šè¿‡å¾€æ¶ˆè´¹è€…çš„FDå†™æ•°æ®ï¼Œé€šçŸ¥APPæœ‰Vsyncä¿¡å·åˆ°æ¥ã€‚pendingEventsä¸­çš„æ¶ˆæ¯å¤„ç†å®Œäº†ï¼Œåˆ†å‘çº¿ç¨‹ç­‰å¾…mConditionçš„é€šçŸ¥ï¼ŒEventThreadçš„threadMainæ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š //frameworks/native/services/surfaceflinger/Scheduler/EventThread.cpp std::vector\u003cDisplayEventReceiver::Event\u003e mPendingEvents; void EventThread::threadMain(std::unique_lock\u003cstd::mutex\u003e\u0026 lock) { // consumers è¡¨ç¤ºå³å°†æ¶ˆè´¹äº‹ä»¶çš„ connection é›†åˆ DisplayEventConsumers consumers; // çŠ¶æ€å€¼ä¸ç­‰äº State::Quit åˆ™ä¸€ç›´å¾ªç¯éå†ï¼Œæ­»å¾ªç¯ while (mState != State::Quit) { std::optional\u003cDisplayEventReceiver::Event\u003e event; // Determine next event to dispatch. // ç¡®å®šä¸‹ä¸€ä¸ªè¦è°ƒåº¦çš„ Event if (!mPendingEvents.empty()) { event = mPendingEvents.front(); // è·å–å¤´éƒ¨ Event mPendingEvents.pop_front(); // å°†å¤´éƒ¨ Event å¼¹å‡º switch (event-\u003eheader.type) { // æ ¹æ® Event ç±»å‹åˆ†åˆ«å¯¹åº”å¤„ç† case DisplayEventReceiver::DISPLAY_EVENT_HOTPLUG: //Eventç±»å‹ä¸ºDISPLAY_EVENT_HOTPLUGï¼Œå³å½“æ˜¾ç¤ºè®¾å¤‡ï¼ˆå¦‚æ˜¾ç¤ºå™¨ï¼‰è¢«æ’å…¥æˆ–æ‹”å‡ºæ—¶äº§ç”Ÿ if (event-\u003ehotplug.connected \u0026\u0026 !mVSyncState) { mVSyncState.emplace(event-\u003eheader.displayId); } else if (!event-\u003ehotplug.connected \u0026\u0026 mVSyncState \u0026\u0026 mVSyncState-\u003edisplayId == event-\u003eheader.displayId) { mVSyncState.reset(); } break; case DisplayEventReceiver::DISPLAY_EVENT_VSYNC: //Eventç±»å‹ä¸ºDISPLAY_EVENT_VSYNCï¼Œå³Vsyncï¼ˆ å‚ç›´åŒæ­¥ï¼‰äº‹ä»¶ if (mInterceptVSyncsCallback) { mInterceptVSyncsCallback(event-\u003eheader.timestamp); } break; } } // æ ‡å¿—ä½ï¼šæ˜¯å¦æœ‰ VSync è¯·æ±‚ï¼Œé»˜è®¤ false bool vsyncRequested = false; // Find connections that should consume this event. // å¾ªç¯éå†å­˜å‚¨ EventThreadConnection çš„ vector å®¹å™¨ mDisplayEventConnectionsï¼ŒæŸ¥æ‰¾è¦æ¶ˆè´¹äº‹ä»¶çš„è¿æ¥ // begin()å‡½æ•°ç”¨äºè¿”å›æŒ‡å‘å‘é‡å®¹å™¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„è¿­ä»£å™¨ auto it = mDisplayEventConnections.begin(); while (it != mDisplayEventConnections.end()) { if (const auto connection = it-\u003epromote()) { // promote ä¸‹é¢å¼•ç”¨æœ‰ä»‹ç» // å¦‚æœæœ‰ä¸€ä¸ª connection çš„ vsyncRequest ä¸ä¸º None åˆ™ vsyncRequested ä¸º true vsyncRequested |= connection-\u003evsyncRequest != VSyncRequest::None; // event ä¸ä¸ºç©ºä¸” shouldConsumeEvent() è¿”å› true åˆ™å°† connection åŠ å…¥åˆ° consumers ç­‰å¾…æ¶ˆè´¹ event // shouldConsumeEvent() æ–¹æ³•ä½œç”¨ï¼šå¯¹äº VSync ç±»å‹çš„äº‹ä»¶ï¼Œåªè¦ VSyncRequest çš„ç±»å‹ä¸æ˜¯ None å°±è¿”å› true if (event \u0026\u0026 shouldConsumeEvent(*event, connection)) { consumers.push_back(connection); } ++it; } else { // è·å–ä¸åˆ° connection åˆ™ä» mDisplayEventConnections ç§»é™¤ it = mDisplayEventConnections.erase(it); } } // consumers ä¸ä¸ºç©ºå³å½“å‰ Event æœ‰ EventThreadConnection æ¥æ¶ˆè´¹ if (!consumers.empty()) { dispatchEvent(*event, consumers); // åˆ†å‘å®Œæ¸…ç©º consumers.clear(); } State nextState; if (mVSyncState \u0026\u0026 vsyncRequested) { // æœ‰ VSync è¯·æ±‚ // è°ƒç”¨ dispatchEvent() æ–¹æ³•éå† consumers ä¸ºå…¶æ¯ä¸ª EventThreadConnection åˆ†å‘äº‹ä»¶ nextState = mVSyncState-\u003esynthetic ? State::SyntheticVSync : State::VSync; } else { ALOGW_IF(!mVSyncState, \"Ignoring VSYNC request while display is disconnected\"); // æ˜¾ç¤ºå™¨ç†„å±æˆ–æ²¡æœ‰è¿æ¥ã€å¿½ç•¥ VSync è¯·æ±‚ nextState = State::Idle; } // mState å€¼é»˜è®¤ä¸º State::Idleï¼Œä¸ nextState ä¸ä¸€è‡´ï¼Œåˆ™åˆ†æƒ…å†µè®¨è®º if (mState != nextState) { if (mState == State::VSync) { // å½“å‰çŠ¶æ€ä¸º State::VSyncï¼Œåˆ™è°ƒç”¨ mVSyncSource çš„ setVSyncEnabled å¹¶ä¼ å…¥ false mVSyncSource-\u003esetVSyncEnabled(false); } else if (nextState == State::VSync) { // nextState çŠ¶æ€ä¸º State::VSyncï¼Œåˆ™è°ƒç”¨ mVSyncSource çš„ setVSyncEnabled å¹¶ä¼ å…¥ true mVSyncSource-\u003esetVSyncEnabled(true); } mState = nextState; } if (event) { // è¿˜æœ‰äº‹ä»¶åˆ™ç»§ç»­å¾ªç¯éå† continue; } // Wait for event or client registration/request. // æ²¡æœ‰äº‹ä»¶ä¸”å½“å‰çŠ¶æ€ä¸ºï¼šState::Idleï¼Œåˆ™çº¿ç¨‹ç»§ç»­ç­‰å¾…äº‹ä»¶æˆ–å®¢æˆ·ç«¯æ³¨å†Œ/è¯·æ±‚ if (mState == State::Idle) { mCondition.wait(lock); } else { // Generate a fake VSYNC after a long timeout in case the driver stalls. When the // display is off, keep feeding clients at 60 Hz. const std::chrono::nanoseconds timeout = mState == State::SyntheticVSync ? 16ms : 1000ms; if (mCondition.wait_for(lock, timeout) == std::cv_status::timeout) { if (mState == State::VSync) { ALOGW(\"Faking VSYNC due to driver stall for thread %s\", mThreadName); std::string debugInfo = \"VsyncSource debug info:\\n\"; mVSyncSource-\u003edump(debugInfo); // Log the debug info line-by-line to avoid logcat overflow auto pos = debugInfo.find('\\n'); while (pos != std::string::npos) { ALOGW(\"%s\", debugInfo.substr(0, pos).c_str()); debugInfo = debugInfo.substr(pos + 1); pos = debugInfo.find('\\n'); } } LOG_FATAL_IF(!mVSyncState","date":"2024-11-06","objectID":"/posts/android13-eventthread-threadmain%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 EventThread threadMainæµç¨‹åˆ†æ_eventthread::threadmain-CSDNåšå®¢","uri":"/posts/android13-eventthread-threadmain%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"EventThread dispatchEvent è°ƒç”¨EventThreadçš„dispatchEventæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Scheduler/EventThread.cpp void EventThread::dispatchEvent(const DisplayEventReceiver::Event\u0026 event, const DisplayEventConsumers\u0026 consumers) { // å¾ªç¯è·å– DisplayEventConsumers ä¸­ä¿å­˜æ¯ä¸ª EventThreadConnection for (const auto\u0026 consumer : consumers) { DisplayEventReceiver::Event copy = event; if (event.header.type == DisplayEventReceiver::DISPLAY_EVENT_VSYNC) { // è·å– VSync ä¿¡å·å‘¨æœŸå³ï¼šå¸§é—´éš” const int64_t frameInterval = mGetVsyncPeriodFunction(consumer-\u003emOwnerUid); copy.vsync.vsyncData.frameInterval = frameInterval; generateFrameTimeline(copy.vsync.vsyncData, frameInterval, copy.header.timestamp, event.vsync.vsyncData.preferredExpectedPresentationTime(), event.vsync.vsyncData.preferredDeadlineTimestamp()); } switch (consumer-\u003epostEvent(copy)) { case NO_ERROR: break; case -EAGAIN: // TODO: Try again if pipe is full. ALOGW(\"Failed dispatching %s for %s\", toString(event).c_str(), toString(*consumer).c_str()); break; default: // Treat EPIPE and other errors as fatal. removeDisplayEventConnectionLocked(consumer); } } } ","date":"2024-11-06","objectID":"/posts/android13-eventthread-threadmain%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 EventThread threadMainæµç¨‹åˆ†æ_eventthread::threadmain-CSDNåšå®¢","uri":"/posts/android13-eventthread-threadmain%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#eventthread-dispatchevent"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"EventThreadConnection postEvent åˆ†å‘ä¹‹è°ƒç”¨çš„consumer-\u003epostEvent(copy)ï¼Œè¿™ä¸ªconsumerå°±æ˜¯ä¸Šé¢åŠ å…¥çš„EventThreadConnectionå¯¹è±¡ã€‚å®ƒçš„postEventå¦‚ä¸‹ï¼š //frameworks/native/services/surfaceflinger/Scheduler/EventThread.cpp status_t EventThreadConnection::postEvent(const DisplayEventReceiver::Event\u0026 event) { constexpr auto toStatus = [](ssize_t size) { return size \u003c 0 ? status_t(size) : status_t(NO_ERROR); }; if (event.header.type == DisplayEventReceiver::DISPLAY_EVENT_FRAME_RATE_OVERRIDE || event.header.type == DisplayEventReceiver::DISPLAY_EVENT_FRAME_RATE_OVERRIDE_FLUSH) { mPendingEvents.emplace_back(event); if (event.header.type == DisplayEventReceiver::DISPLAY_EVENT_FRAME_RATE_OVERRIDE) { return status_t(NO_ERROR); } auto size = DisplayEventReceiver::sendEvents(\u0026mChannel, mPendingEvents.data(), mPendingEvents.size()); mPendingEvents.clear(); return toStatus(size); } auto size = DisplayEventReceiver::sendEvents(\u0026mChannel, \u0026event, 1); return toStatus(size); } DisplayEventReceiver sendEvents mChannel çš„ç±»å‹æ˜¯BitTubeï¼Œä¿å­˜çš„æ˜¯EventThreadConnectionä¸­è®°å½•çš„æ–‡ä»¶æè¿°ç¬¦,è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¼šå¤åˆ¶åˆ°è¿æ¥è¿‡æ¥çš„appè¿›ç¨‹.ç„¶åè°ƒç”¨DisplayEventReceiver::sendEvents(\u0026mChannel, \u0026event, 1)æ–¹æ³•ï¼š //frameworks/native/libs/gui/DisplayEventReceiver.cpp ssize_t DisplayEventReceiver::sendEvents(gui::BitTube* dataChannel, Event const* events, size_t count) { return gui::BitTube::sendObjects(dataChannel, events, count); } BitTube sendObjects è°ƒç”¨BitTubeè°ƒç”¨sendObjectsæ–¹æ³•ï¼š //frameworks/native/libs/gui/BitTube.cpp ssize_t BitTube::sendObjects(BitTube* tube, void const* events, size_t count, size_t objSize) { const char* vaddr = reinterpret_cast\u003cconst char*\u003e(events); // è°ƒç”¨ BitTube çš„ write() æ–¹æ³•æ¥å†™å…¥æ•°æ® ssize_t size = tube-\u003ewrite(vaddr, count * objSize); // should never happen because of SOCK_SEQPACKET LOG_ALWAYS_FATAL_IF((size \u003e= 0) \u0026\u0026 (size % static_cast\u003cssize_t\u003e(objSize)), \"BitTube::sendObjects(count=%zu, size=%zu), res=%zd (partial events were \" \"sent!)\", count, objSize, size); // ALOGE_IF(size\u003c0, \"error %d sending %d events\", size, count); return size \u003c 0 ? size : size / static_cast\u003cssize_t\u003e(objSize); } è°ƒç”¨BitTubeçš„writeæ–¹æ³•ï¼š //frameworks/native/libs/gui/BitTube.cpp ssize_t BitTube::write(void const* vaddr, size_t size) { ssize_t err, len; do { // é€šè¿‡æ–‡ä»¶æè¿°ç¬¦ mSendFd å…³è”çš„ socket ç®¡é“å°†æ•°æ®å‘é€åˆ° vaddr æŒ‡å®šçš„ä¸€æ®µ // size å¤§å°çš„ç¼“å†²åŒºä¸­ï¼Œå¹¶è¿”å›å®é™…å‘é€çš„æ•°æ®å¤§å°ï¼šlen len = ::send(mSendFd, vaddr, size, MSG_DONTWAIT | MSG_NOSIGNAL); // cannot return less than size, since we're using SOCK_SEQPACKET err = len \u003c 0 ? errno : 0; } while (err == EINTR); return err == 0 ? len : -err; } é€šè¿‡è°ƒç”¨ç³»ç»Ÿå‡½æ•°sendå‘ä¸æ¶ˆè´¹è€…å…³è”çš„æ–‡ä»¶æè¿°ç¬¦FDå‘é€ä¿¡å·ï¼Œäºæ˜¯å®ŒæˆVsyncçš„åˆ†å‘ï¼Œåˆ†å‘çš„æ¶ˆæ¯åœ¨Choreographerçš„postCallbackæ–¹æ³•ä¸­å¤„ç†ï¼š Android13 Choreographer postCallbackæµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android13-eventthread-threadmain%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 EventThread threadMainæµç¨‹åˆ†æ_eventthread::threadmain-CSDNåšå®¢","uri":"/posts/android13-eventthread-threadmain%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#eventthreadconnection-postevent"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"EventThreadConnection postEvent åˆ†å‘ä¹‹è°ƒç”¨çš„consumer-\u003epostEvent(copy)ï¼Œè¿™ä¸ªconsumerå°±æ˜¯ä¸Šé¢åŠ å…¥çš„EventThreadConnectionå¯¹è±¡ã€‚å®ƒçš„postEventå¦‚ä¸‹ï¼š //frameworks/native/services/surfaceflinger/Scheduler/EventThread.cpp status_t EventThreadConnection::postEvent(const DisplayEventReceiver::Event\u0026 event) { constexpr auto toStatus = [](ssize_t size) { return size \u003c 0 ? status_t(size) : status_t(NO_ERROR); }; if (event.header.type == DisplayEventReceiver::DISPLAY_EVENT_FRAME_RATE_OVERRIDE || event.header.type == DisplayEventReceiver::DISPLAY_EVENT_FRAME_RATE_OVERRIDE_FLUSH) { mPendingEvents.emplace_back(event); if (event.header.type == DisplayEventReceiver::DISPLAY_EVENT_FRAME_RATE_OVERRIDE) { return status_t(NO_ERROR); } auto size = DisplayEventReceiver::sendEvents(\u0026mChannel, mPendingEvents.data(), mPendingEvents.size()); mPendingEvents.clear(); return toStatus(size); } auto size = DisplayEventReceiver::sendEvents(\u0026mChannel, \u0026event, 1); return toStatus(size); } DisplayEventReceiver sendEvents mChannel çš„ç±»å‹æ˜¯BitTubeï¼Œä¿å­˜çš„æ˜¯EventThreadConnectionä¸­è®°å½•çš„æ–‡ä»¶æè¿°ç¬¦,è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¼šå¤åˆ¶åˆ°è¿æ¥è¿‡æ¥çš„appè¿›ç¨‹.ç„¶åè°ƒç”¨DisplayEventReceiver::sendEvents(\u0026mChannel, \u0026event, 1)æ–¹æ³•ï¼š //frameworks/native/libs/gui/DisplayEventReceiver.cpp ssize_t DisplayEventReceiver::sendEvents(gui::BitTube* dataChannel, Event const* events, size_t count) { return gui::BitTube::sendObjects(dataChannel, events, count); } BitTube sendObjects è°ƒç”¨BitTubeè°ƒç”¨sendObjectsæ–¹æ³•ï¼š //frameworks/native/libs/gui/BitTube.cpp ssize_t BitTube::sendObjects(BitTube* tube, void const* events, size_t count, size_t objSize) { const char* vaddr = reinterpret_cast(events); // è°ƒç”¨ BitTube çš„ write() æ–¹æ³•æ¥å†™å…¥æ•°æ® ssize_t size = tube-\u003ewrite(vaddr, count * objSize); // should never happen because of SOCK_SEQPACKET LOG_ALWAYS_FATAL_IF((size \u003e= 0) \u0026\u0026 (size % static_cast(objSize)), \"BitTube::sendObjects(count=%zu, size=%zu), res=%zd (partial events were \" \"sent!)\", count, objSize, size); // ALOGE_IF(size\u003c0, \"error %d sending %d events\", size, count); return size \u003c 0 ? size : size / static_cast(objSize); } è°ƒç”¨BitTubeçš„writeæ–¹æ³•ï¼š //frameworks/native/libs/gui/BitTube.cpp ssize_t BitTube::write(void const* vaddr, size_t size) { ssize_t err, len; do { // é€šè¿‡æ–‡ä»¶æè¿°ç¬¦ mSendFd å…³è”çš„ socket ç®¡é“å°†æ•°æ®å‘é€åˆ° vaddr æŒ‡å®šçš„ä¸€æ®µ // size å¤§å°çš„ç¼“å†²åŒºä¸­ï¼Œå¹¶è¿”å›å®é™…å‘é€çš„æ•°æ®å¤§å°ï¼šlen len = ::send(mSendFd, vaddr, size, MSG_DONTWAIT | MSG_NOSIGNAL); // cannot return less than size, since we're using SOCK_SEQPACKET err = len \u003c 0 ? errno : 0; } while (err == EINTR); return err == 0 ? len : -err; } é€šè¿‡è°ƒç”¨ç³»ç»Ÿå‡½æ•°sendå‘ä¸æ¶ˆè´¹è€…å…³è”çš„æ–‡ä»¶æè¿°ç¬¦FDå‘é€ä¿¡å·ï¼Œäºæ˜¯å®ŒæˆVsyncçš„åˆ†å‘ï¼Œåˆ†å‘çš„æ¶ˆæ¯åœ¨Choreographerçš„postCallbackæ–¹æ³•ä¸­å¤„ç†ï¼š Android13 Choreographer postCallbackæµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android13-eventthread-threadmain%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 EventThread threadMainæµç¨‹åˆ†æ_eventthread::threadmain-CSDNåšå®¢","uri":"/posts/android13-eventthread-threadmain%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#displayeventreceiver-sendevents"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"EventThreadConnection postEvent åˆ†å‘ä¹‹è°ƒç”¨çš„consumer-\u003epostEvent(copy)ï¼Œè¿™ä¸ªconsumerå°±æ˜¯ä¸Šé¢åŠ å…¥çš„EventThreadConnectionå¯¹è±¡ã€‚å®ƒçš„postEventå¦‚ä¸‹ï¼š //frameworks/native/services/surfaceflinger/Scheduler/EventThread.cpp status_t EventThreadConnection::postEvent(const DisplayEventReceiver::Event\u0026 event) { constexpr auto toStatus = [](ssize_t size) { return size \u003c 0 ? status_t(size) : status_t(NO_ERROR); }; if (event.header.type == DisplayEventReceiver::DISPLAY_EVENT_FRAME_RATE_OVERRIDE || event.header.type == DisplayEventReceiver::DISPLAY_EVENT_FRAME_RATE_OVERRIDE_FLUSH) { mPendingEvents.emplace_back(event); if (event.header.type == DisplayEventReceiver::DISPLAY_EVENT_FRAME_RATE_OVERRIDE) { return status_t(NO_ERROR); } auto size = DisplayEventReceiver::sendEvents(\u0026mChannel, mPendingEvents.data(), mPendingEvents.size()); mPendingEvents.clear(); return toStatus(size); } auto size = DisplayEventReceiver::sendEvents(\u0026mChannel, \u0026event, 1); return toStatus(size); } DisplayEventReceiver sendEvents mChannel çš„ç±»å‹æ˜¯BitTubeï¼Œä¿å­˜çš„æ˜¯EventThreadConnectionä¸­è®°å½•çš„æ–‡ä»¶æè¿°ç¬¦,è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¼šå¤åˆ¶åˆ°è¿æ¥è¿‡æ¥çš„appè¿›ç¨‹.ç„¶åè°ƒç”¨DisplayEventReceiver::sendEvents(\u0026mChannel, \u0026event, 1)æ–¹æ³•ï¼š //frameworks/native/libs/gui/DisplayEventReceiver.cpp ssize_t DisplayEventReceiver::sendEvents(gui::BitTube* dataChannel, Event const* events, size_t count) { return gui::BitTube::sendObjects(dataChannel, events, count); } BitTube sendObjects è°ƒç”¨BitTubeè°ƒç”¨sendObjectsæ–¹æ³•ï¼š //frameworks/native/libs/gui/BitTube.cpp ssize_t BitTube::sendObjects(BitTube* tube, void const* events, size_t count, size_t objSize) { const char* vaddr = reinterpret_cast(events); // è°ƒç”¨ BitTube çš„ write() æ–¹æ³•æ¥å†™å…¥æ•°æ® ssize_t size = tube-\u003ewrite(vaddr, count * objSize); // should never happen because of SOCK_SEQPACKET LOG_ALWAYS_FATAL_IF((size \u003e= 0) \u0026\u0026 (size % static_cast(objSize)), \"BitTube::sendObjects(count=%zu, size=%zu), res=%zd (partial events were \" \"sent!)\", count, objSize, size); // ALOGE_IF(size\u003c0, \"error %d sending %d events\", size, count); return size \u003c 0 ? size : size / static_cast(objSize); } è°ƒç”¨BitTubeçš„writeæ–¹æ³•ï¼š //frameworks/native/libs/gui/BitTube.cpp ssize_t BitTube::write(void const* vaddr, size_t size) { ssize_t err, len; do { // é€šè¿‡æ–‡ä»¶æè¿°ç¬¦ mSendFd å…³è”çš„ socket ç®¡é“å°†æ•°æ®å‘é€åˆ° vaddr æŒ‡å®šçš„ä¸€æ®µ // size å¤§å°çš„ç¼“å†²åŒºä¸­ï¼Œå¹¶è¿”å›å®é™…å‘é€çš„æ•°æ®å¤§å°ï¼šlen len = ::send(mSendFd, vaddr, size, MSG_DONTWAIT | MSG_NOSIGNAL); // cannot return less than size, since we're using SOCK_SEQPACKET err = len \u003c 0 ? errno : 0; } while (err == EINTR); return err == 0 ? len : -err; } é€šè¿‡è°ƒç”¨ç³»ç»Ÿå‡½æ•°sendå‘ä¸æ¶ˆè´¹è€…å…³è”çš„æ–‡ä»¶æè¿°ç¬¦FDå‘é€ä¿¡å·ï¼Œäºæ˜¯å®ŒæˆVsyncçš„åˆ†å‘ï¼Œåˆ†å‘çš„æ¶ˆæ¯åœ¨Choreographerçš„postCallbackæ–¹æ³•ä¸­å¤„ç†ï¼š Android13 Choreographer postCallbackæµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android13-eventthread-threadmain%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 EventThread threadMainæµç¨‹åˆ†æ_eventthread::threadmain-CSDNåšå®¢","uri":"/posts/android13-eventthread-threadmain%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#bittube-sendobjects"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"Surface::dequeueBufferæ˜¯Androidç³»ç»Ÿä¸­Surfaceç±»çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºä»Surfaceä¸­è·å–ä¸€ä¸ªå¯ç”¨çš„Bufferã€‚å®ƒé€šå¸¸åœ¨å›¾å½¢æ¸²æŸ“æˆ–è§†é¢‘æ’­æ”¾ç­‰åœºæ™¯ä¸­ä½¿ç”¨ã€‚ Surface::dequeueBufferçš„è°ƒç”¨åœ°æ–¹å¯ä»¥æœ‰å¤šä¸ªï¼Œå…·ä½“å–å†³äºåº”ç”¨ç¨‹åºçš„å®ç°å’Œä½¿ç”¨åœºæ™¯ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¯èƒ½çš„è°ƒç”¨åœ°æ–¹ï¼š å›¾å½¢æ¸²æŸ“å¼•æ“ï¼šåœ¨å›¾å½¢æ¸²æŸ“å¼•æ“ä¸­ï¼ŒSurface::dequeueBufferé€šå¸¸ç”¨äºè·å–ä¸€ä¸ªå¯ç”¨çš„ç»˜åˆ¶ç¼“å†²åŒºï¼Œä»¥ä¾¿è¿›è¡Œå›¾å½¢ç»˜åˆ¶æ“ä½œã€‚è¿™æ ·å¯ä»¥å®ç°æµç•…çš„å›¾å½¢æ¸²æŸ“æ•ˆæœã€‚ è§†é¢‘æ’­æ”¾å™¨ï¼šåœ¨è§†é¢‘æ’­æ”¾å™¨ä¸­ï¼ŒSurface::dequeueBufferå¯ä»¥ç”¨äºè·å–ä¸€ä¸ªå¯ç”¨çš„è§†é¢‘å¸§ç¼“å†²åŒºï¼Œä»¥ä¾¿å°†è§†é¢‘æ•°æ®è§£ç å¹¶æ˜¾ç¤ºåœ¨å±å¹•ä¸Šã€‚è¿™æ ·å¯ä»¥å®ç°æµç•…çš„è§†é¢‘æ’­æ”¾æ•ˆæœã€‚ å›¾åƒå¤„ç†åº”ç”¨ï¼šåœ¨å›¾åƒå¤„ç†åº”ç”¨ä¸­ï¼ŒSurface::dequeueBufferå¯ä»¥ç”¨äºè·å–ä¸€ä¸ªå¯ç”¨çš„å›¾åƒç¼“å†²åŒºï¼Œä»¥ä¾¿è¿›è¡Œå›¾åƒå¤„ç†æ“ä½œï¼Œå¦‚æ»¤é•œã€ç‰¹æ•ˆç­‰ã€‚è¿™æ ·å¯ä»¥å®ç°å®æ—¶çš„å›¾åƒå¤„ç†æ•ˆæœã€‚ æ¸¸æˆå¼•æ“ï¼šåœ¨æ¸¸æˆå¼•æ“ä¸­ï¼ŒSurface::dequeueBufferå¯ä»¥ç”¨äºè·å–ä¸€ä¸ªå¯ç”¨çš„æ¸¸æˆç”»é¢ç¼“å†²åŒºï¼Œä»¥ä¾¿è¿›è¡Œæ¸¸æˆç”»é¢çš„æ¸²æŸ“å’Œæ›´æ–°ã€‚è¿™æ ·å¯ä»¥å®ç°æµç•…çš„æ¸¸æˆç”»é¢æ•ˆæœã€‚ Surfaceçš„dequeueBufferæ–¹æ³•çš„ä½œç”¨æ˜¯åº”ç”¨ç¨‹åºä¸€ç«¯è¯·æ±‚ç»˜åˆ¶å›¾åƒæ—¶ï¼Œå‘BufferQueueä¸­ç”³è¯·ä¸€å—å¯ç”¨çš„GraphicBufferï¼Œæœ‰äº†è¿™ä¸ªbufferå°±å¯ä»¥ç»˜åˆ¶å›¾åƒæ•°æ®äº†ï¼Œç”Ÿäº§è€…åœ¨ç”Ÿæˆå†…å®¹çš„æ—¶å€™ï¼Œå°±ä¼šæœ‰è¿™ä¹ˆä¸€ä¸ªè¿‡ç¨‹ï¼› ç”Ÿäº§è€…å‘ BufferQueue ä¸­ç”³è¯· slotï¼ˆç¼“å†²æ§½ï¼‰ ç”Ÿäº§è€…æ‹¿åˆ° slotï¼Œä½†æ˜¯ slot å¹¶æ²¡æœ‰å…³è”å¯¹åº”çš„ GraphicBufferï¼ˆç¼“å†²åŒºï¼‰ ç”Ÿäº§è€…åˆ›å»ºä¸€ä¸ªç¼“å†²åŒºï¼Œå¹¶å°†å®ƒä¸ç¼“å†²æ§½ç›¸å…³è”ã€‚ ä¸‹é¢ä»ä»£ç è§’åº¦è¿›è¡Œåˆ†æï¼š //framework/native/libs/gui/Surface.cpp sp\u003cIGraphicBufferProducer\u003e mGraphicBufferProducer; class Surface : public ANativeObjectBase\u003cANativeWindow, Surface, RefBase\u003e { int Surface::dequeueBuffer(android_native_buffer_t** buffer, int* fenceFd) { ATRACE_CALL(); ALOGV(\"Surface::dequeueBuffer\"); IGraphicBufferProducer::DequeueBufferInput dqInput; { Mutex::Autolock lock(mMutex); if (mReportRemovedBuffers) { mRemovedBuffers.clear(); } getDequeueBufferInputLocked(\u0026dqInput); if (mSharedBufferMode \u0026\u0026 mAutoRefresh \u0026\u0026 mSharedBufferSlot != BufferItem::INVALID_BUFFER_SLOT) { sp\u003cGraphicBuffer\u003e\u0026 gbuf(mSlots[mSharedBufferSlot].buffer); if (gbuf != nullptr) { *buffer = gbuf.get(); *fenceFd = -1; return OK; } } } // Drop the lock so that we can still touch the Surface while blocking in IGBP::dequeueBuffer int buf = -1; sp\u003cFence\u003e fence; nsecs_t startTime = systemTime(); FrameEventHistoryDelta frameTimestamps; //è¿™é‡Œå°è¯•å»dequeueBuffer,å› ä¸ºè¿™æ—¶SurfaceFlingerå¯¹åº”Layerçš„slotè¿˜æ²¡æœ‰åˆ†é…buffer,è¿™æ—¶SurfaceFlingerä¼šå›å¤çš„flagä¼šæœ‰BUFFER_NEEDS_REALLOCATIO status_t result = mGraphicBufferProducer-\u003edequeueBuffer(\u0026buf, \u0026fence, dqInput.width, dqInput.height, dqInput.format, dqInput.usage, \u0026mBufferAge, dqInput.getTimestamps ? \u0026frameTimestamps : nullptr); mLastDequeueDuration = systemTime() - startTime; if (result \u003c 0) { ALOGV(\"dequeueBuffer: IGraphicBufferProducer::dequeueBuffer\" \"(%d, %d, %d, %#\" PRIx64 \") failed: %d\", dqInput.width, dqInput.height, dqInput.format, dqInput.usage, result); return result; } if (buf \u003c 0 || buf \u003e= NUM_BUFFER_SLOTS) { ALOGE(\"dequeueBuffer: IGraphicBufferProducer returned invalid slot number %d\", buf); android_errorWriteLog(0x534e4554, \"36991414\"); // SafetyNet logging return FAILED_TRANSACTION; } Mutex::Autolock lock(mMutex); // Write this while holding the mutex mLastDequeueStartTime = startTime; sp\u003cGraphicBuffer\u003e\u0026 gbuf(mSlots[buf].buffer); // this should never happen ALOGE_IF(fence == nullptr, \"Surface::dequeueBuffer: received null Fence! buf=%d\", buf); if (CC_UNLIKELY(atrace_is_tag_enabled(ATRACE_TAG_GRAPHICS))) { static FenceMonitor hwcReleaseThread(\"HWC release\"); hwcReleaseThread.queueFence(fence); } if (result \u0026 IGraphicBufferProducer::RELEASE_ALL_BUFFERS) { freeAllBuffers(); } if (dqInput.getTimestamps) { mFrameEventHistory-\u003eapplyDelta(frameTimestamps); } if ((result \u0026 IGraphicBufferProducer::BUFFER_NEEDS_REALLOCATION) || gbuf == nullptr) { if (mReportRemovedBuffers \u0026\u0026 (gbuf != nullptr)) { mRemovedBuffers.push_back(gbuf); } //è¿™é‡Œæ£€æŸ¥åˆ°dequeueBufferè¿”å›çš„ç»“æœé‡Œå¸¦æœ‰BUFFER_NEEDS_REALLOCATIONæ ‡å¿—å°±ä¼šå‘å‡ºä¸€æ¬¡requestBuffer result = mGraphicBufferProducer-\u003erequestBuffer(buf, \u0026gbuf); if (result != NO_ERROR) { ALOGE(\"dequeueBuffer: IGraphicBufferProducer::requestBuffer failed: %d\", result); mGraphicBufferProducer-\u003ecancelBuffer(buf, fence); return result; } } if (fence-\u003eisValid()) { *fenceFd = fence-\u003edup(); if (*fenceFd == -1) { ALOGE(\"dequeueBuffer: error duping fence: %d\", errno); // dup() should never fail; something is badly wrong. Soldier on // and hope for the best; the worst that should happen is some // visible corruption that lasts until the next frame. } } else { *fenceFd = -1; } *buffer = gbuf.get(); if (mSharedBufferMode \u0026\u0026 mAutoRefresh) { mSharedBufferSlot = buf; mSharedBufferHasBeenQueued = false; } else if (mSharedBufferSlot == buf) { mSha","date":"2024-11-06","objectID":"/posts/android13-surface-dequeuebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 Surface dequeueBufferæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surface-dequeuebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"BpGraphicBufferProducer dequeueBuffer è°ƒç”¨mGraphicBufferProducer(IGraphicBufferProducer)çš„dequeueBufferæ–¹æ³•ï¼ŒIGraphicBufferProduceræ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”±BpGraphicBufferProducerå®ç°ï¼š //frameworks/native/libs/gui/IGraphicBufferProducer.cpp class BpGraphicBufferProducer : public BpInterface\u003cIGraphicBufferProducer\u003e { virtual status_t dequeueBuffer(int* buf, sp\u003cFence\u003e* fence, uint32_t width, uint32_t height, PixelFormat format, uint64_t usage, uint64_t* outBufferAge, FrameEventHistoryDelta* outTimestamps) { Parcel data, reply; bool getFrameTimestamps = (outTimestamps != nullptr); data.writeInterfaceToken(IGraphicBufferProducer::getInterfaceDescriptor()); data.writeUint32(width); data.writeUint32(height); data.writeInt32(static_cast\u003cint32_t\u003e(format)); data.writeUint64(usage); data.writeBool(getFrameTimestamps); status_t result = remote()-\u003etransact(DEQUEUE_BUFFER, data, \u0026reply); if (result != NO_ERROR) { return result; } *buf = reply.readInt32(); *fence = new Fence(); result = reply.read(**fence); if (result != NO_ERROR) { fence-\u003eclear(); return result; } if (outBufferAge) { result = reply.readUint64(outBufferAge); } else { // Read the value even if outBufferAge is nullptr: uint64_t bufferAge; result = reply.readUint64(\u0026bufferAge); } if (result != NO_ERROR) { ALOGE(\"IGBP::dequeueBuffer failed to read buffer age: %d\", result); return result; } if (getFrameTimestamps) { result = reply.read(*outTimestamps); if (result != NO_ERROR) { ALOGE(\"IGBP::dequeueBuffer failed to read timestamps: %d\", result); return result; } } result = reply.readInt32(); return result; } } å‘é€DEQUEUE_BUFFERæ¶ˆæ¯ï¼Œå‘é€çš„æ¶ˆæ¯åœ¨BnGraphicBufferProducerçš„onTransactæ–¹æ³•ä¸­å¤„ç†ï¼š //frameworks/native/libs/gui/IGraphicBufferProducer.cpp status_t BnGraphicBufferProducer::onTransact( uint32_t code, const Parcel\u0026 data, Parcel* reply, uint32_t flags) { switch(code) { case DEQUEUE_BUFFER: { CHECK_INTERFACE(IGraphicBufferProducer, data, reply); uint32_t width = data.readUint32(); uint32_t height = data.readUint32(); PixelFormat format = static_cast\u003cPixelFormat\u003e(data.readInt32()); uint64_t usage = data.readUint64(); uint64_t bufferAge = 0; bool getTimestamps = data.readBool(); int buf = 0; sp\u003cFence\u003e fence = Fence::NO_FENCE; FrameEventHistoryDelta frameTimestamps; int result = dequeueBuffer(\u0026buf, \u0026fence, width, height, format, usage, \u0026bufferAge, getTimestamps ? \u0026frameTimestamps : nullptr); if (fence == nullptr) { ALOGE(\"dequeueBuffer returned a NULL fence, setting to Fence::NO_FENCE\"); fence = Fence::NO_FENCE; } reply-\u003ewriteInt32(buf); reply-\u003ewrite(*fence); reply-\u003ewriteUint64(bufferAge); if (getTimestamps) { reply-\u003ewrite(frameTimestamps); } reply-\u003ewriteInt32(result); return NO_ERROR; } } } ","date":"2024-11-06","objectID":"/posts/android13-surface-dequeuebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 Surface dequeueBufferæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surface-dequeuebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#bpgraphicbufferproducer-dequeuebuffer"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"BufferQueueProducer dequeueBuffer è°ƒç”¨BnGraphicBufferProducerçš„dequeueBufferæ–¹æ³•ï¼ŒBnGraphicBufferProducerç»§æ‰¿äºBufferQueueProducerï¼Œè°ƒç”¨BufferQueueProducerçš„dequeueBufferæ–¹æ³•ï¼š Android13 BufferQueueProducer dequeueBufferæµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android13-surface-dequeuebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 Surface dequeueBufferæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surface-dequeuebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#bufferqueueproducer-dequeuebuffer"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"BpGraphicBufferProducer requestBuffer åœ¨SurfaceFlingerè¿™ç«¯ï¼Œç¬¬ä¸€æ¬¡æ”¶åˆ°dequeueBufferæ—¶å‘ç°åˆ†é…å‡ºæ¥çš„slotæ²¡æœ‰GraphicBufferï¼Œ è¿™æ—¶ä¼šå»ç”³è¯·å¯¹åº”çš„buffer: è°ƒç”¨mGraphicBufferProducer(IGraphicBufferProducer)çš„requestBufferæ–¹æ³•ï¼ŒIGraphicBufferProduceræ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”±BpGraphicBufferProducerå®ç°ï¼š //frameworks/native/libs/gui/IGraphicBufferProducer.cpp class BpGraphicBufferProducer : public BpInterface\u003cIGraphicBufferProducer\u003e { virtual status_t requestBuffer(int bufferIdx, sp\u003cGraphicBuffer\u003e* buf) { Parcel data, reply; data.writeInterfaceToken(IGraphicBufferProducer::getInterfaceDescriptor()); data.writeInt32(bufferIdx); status_t result = remote()-\u003etransact(REQUEST_BUFFER, data, \u0026reply); if (result != NO_ERROR) { return result; } bool nonNull = reply.readInt32(); if (nonNull) { *buf = new GraphicBuffer(); result = reply.read(**buf); if(result != NO_ERROR) { (*buf).clear(); return result; } } result = reply.readInt32(); return result; } } å‘é€REQUEST_BUFFERæ¶ˆæ¯ï¼Œå‘é€çš„æ¶ˆæ¯åœ¨BnGraphicBufferProducerçš„onTransactæ–¹æ³•ä¸­å¤„ç†ï¼š //frameworks/native/libs/gui/IGraphicBufferProducer.cpp status_t BnGraphicBufferProducer::onTransact( uint32_t code, const Parcel\u0026 data, Parcel* reply, uint32_t flags) { switch(code) { case REQUEST_BUFFER: { CHECK_INTERFACE(IGraphicBufferProducer, data, reply); int bufferIdx = data.readInt32(); sp\u003cGraphicBuffer\u003e buffer; int result = requestBuffer(bufferIdx, \u0026buffer); reply-\u003ewriteInt32(buffer != nullptr); if (buffer != nullptr) { reply-\u003ewrite(*buffer); } reply-\u003ewriteInt32(result); return NO_ERROR; } } return BBinder::onTransact(code, data, reply, flags); } ","date":"2024-11-06","objectID":"/posts/android13-surface-dequeuebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 Surface dequeueBufferæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surface-dequeuebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#bpgraphicbufferproducer-requestbuffer"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"BufferQueueProducer requestBuffer è°ƒç”¨BnGraphicBufferProducerçš„requestBufferæ–¹æ³•ï¼ŒBnGraphicBufferProducerç»§æ‰¿äºBufferQueueProducerï¼Œè°ƒç”¨BufferQueueProducerçš„requestBufferæ–¹æ³•ï¼š //frameworks/native/libs/gui/BufferQueueProducer.cpp class BufferQueueProducer : public BnGraphicBufferProducer { status_t BufferQueueProducer::requestBuffer(int slot, sp\u003cGraphicBuffer\u003e* buf) { ATRACE_CALL(); BQ_LOGV(\"requestBuffer: slot %d\", slot); std::lock_guard\u003cstd::mutex\u003e lock(mCore-\u003emMutex); if (mCore-\u003emIsAbandoned) { BQ_LOGE(\"requestBuffer: BufferQueue has been abandoned\"); return NO_INIT; } if (mCore-\u003emConnectedApi == BufferQueueCore::NO_CONNECTED_API) { BQ_LOGE(\"requestBuffer: BufferQueue has no connected producer\"); return NO_INIT; } if (slot \u003c 0 || slot \u003e= BufferQueueDefs::NUM_BUFFER_SLOTS) { BQ_LOGE(\"requestBuffer: slot index %d out of range [0, %d)\", slot, BufferQueueDefs::NUM_BUFFER_SLOTS); return BAD_VALUE; } else if (!mSlots[slot].mBufferState.isDequeued()) { BQ_LOGE(\"requestBuffer: slot %d is not owned by the producer \" \"(state = %s)\", slot, mSlots[slot].mBufferState.string()); return BAD_VALUE; } mSlots[slot].mRequestBufferCalled = true; *buf = mSlots[slot].mGraphicBuffer; return NO_ERROR; } } requestBufferçš„ä¸»è¦ä½œç”¨å°±æ˜¯æŠŠGraphicBufferä¼ é€’åˆ°åº”ç”¨ä¾§ã€‚ ","date":"2024-11-06","objectID":"/posts/android13-surface-dequeuebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:2:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 Surface dequeueBufferæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surface-dequeuebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#bufferqueueproducer-requestbuffer"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"Surfaceçš„lockCanvasç”¨äºè·å–Canvaså¯¹è±¡ï¼Œä»¥ä¾¿è¿›è¡Œç»˜å›¾æ“ä½œï¼Œä»£ç å¦‚ä¸‹ï¼š //frameworks/base/core/java/android/view/Surface.java public class Surface implements Parcelable { public Canvas lockCanvas(Rect inOutDirty) throws Surface.OutOfResourcesException, IllegalArgumentException { synchronized (mLock) { checkNotReleasedLocked(); if (mLockedObject != 0) { // Ideally, nativeLockCanvas() would throw in this situation and prevent the // double-lock, but that won't happen if mNativeObject was updated. We can't // abandon the old mLockedObject because it might still be in use, so instead // we just refuse to re-lock the Surface. throw new IllegalArgumentException(\"Surface was already locked\"); } mLockedObject = nativeLockCanvas(mNativeObject, mCanvas, inOutDirty); return mCanvas; } } } è°ƒç”¨nativeLockCanvasæ–¹æ³•ï¼ŒnativeLockCanvasæ˜¯ä¸€ä¸ªNativeæ–¹æ³•åœ¨android_view_Surface.cppä¸­å®ç°ï¼š //frameworks/base/core/jni/android_view_Surface.cpp static jlong nativeLockCanvas(JNIEnv* env, jclass clazz, jlong nativeObject, jobject canvasObj, jobject dirtyRectObj) { sp\u003cSurface\u003e surface(reinterpret_cast\u003cSurface *\u003e(nativeObject)); if (!isSurfaceValid(surface)) { jniThrowException(env, IllegalArgumentException, NULL); return 0; } if (!ACanvas_isSupportedPixelFormat(ANativeWindow_getFormat(surface.get()))) { native_window_set_buffers_format(surface.get(), PIXEL_FORMAT_RGBA_8888); } Rect dirtyRect(Rect::EMPTY_RECT); Rect* dirtyRectPtr = NULL; if (dirtyRectObj) { dirtyRect.left = env-\u003eGetIntField(dirtyRectObj, gRectClassInfo.left); dirtyRect.top = env-\u003eGetIntField(dirtyRectObj, gRectClassInfo.top); dirtyRect.right = env-\u003eGetIntField(dirtyRectObj, gRectClassInfo.right); dirtyRect.bottom = env-\u003eGetIntField(dirtyRectObj, gRectClassInfo.bottom); dirtyRectPtr = \u0026dirtyRect; } ANativeWindow_Buffer buffer; status_t err = surface-\u003elock(\u0026buffer, dirtyRectPtr); if (err \u003c 0) { const char* const exception = (err == NO_MEMORY) ? OutOfResourcesException : IllegalArgumentException; jniThrowException(env, exception, NULL); return 0; } graphics::Canvas canvas(env, canvasObj); canvas.setBuffer(\u0026buffer, static_cast\u003cint32_t\u003e(surface-\u003egetBuffersDataSpace())); if (dirtyRectPtr) { canvas.clipRect({dirtyRect.left, dirtyRect.top, dirtyRect.right, dirtyRect.bottom}); } if (dirtyRectObj) { env-\u003eSetIntField(dirtyRectObj, gRectClassInfo.left, dirtyRect.left); env-\u003eSetIntField(dirtyRectObj, gRectClassInfo.top, dirtyRect.top); env-\u003eSetIntField(dirtyRectObj, gRectClassInfo.right, dirtyRect.right); env-\u003eSetIntField(dirtyRectObj, gRectClassInfo.bottom, dirtyRect.bottom); } // Create another reference to the surface and return it. This reference // should be passed to nativeUnlockCanvasAndPost in place of mNativeObject, // because the latter could be replaced while the surface is locked. sp\u003cSurface\u003e lockedSurface(surface); lockedSurface-\u003eincStrong(\u0026sRefBaseOwner); return (jlong) lockedSurface.get(); } è°ƒç”¨surface(Surface)çš„lockæ–¹æ³•ï¼š //framework/native/libs/gui/Surface.cpp class Surface : public ANativeObjectBase\u003cANativeWindow, Surface, RefBase\u003e { status_t Surface::lock( ANativeWindow_Buffer* outBuffer, ARect* inOutDirtyBounds) { if (mLockedBuffer != nullptr) { ALOGE(\"Surface::lock failed, already locked\"); return INVALID_OPERATION; } if (!mConnectedToCpu) { int err = Surface::connect(NATIVE_WINDOW_API_CPU); if (err) { return err; } // we're intending to do software rendering from this point setUsage(GRALLOC_USAGE_SW_READ_OFTEN | GRALLOC_USAGE_SW_WRITE_OFTEN); } ANativeWindowBuffer* out; int fenceFd = -1; status_t err = dequeueBuffer(\u0026out, \u0026fenceFd); ALOGE_IF(err, \"dequeueBuffer failed (%s)\", strerror(-err)); if (err == NO_ERROR) { sp\u003cGraphicBuffer\u003e backBuffer(GraphicBuffer::getSelf(out)); const Rect bounds(backBuffer-\u003ewidth, backBuffer-\u003eheight); Region newDirtyRegion; if (inOutDirtyBounds) { newDirtyRegion.set(static_cast\u003cRect const\u0026\u003e(*inOutDirtyBounds)); newDirtyRegion.andSelf(bounds); } else { newDirtyRegion.set(bounds); } // figure out if we can copy the frontbuffer back const sp\u003cGraphicBuffer\u003e\u0026 frontBuffer(mPostedBuffer); const bool canC","date":"2024-11-06","objectID":"/posts/android13-surface-lockcanvas%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 Surface lockCanvasæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surface-lockcanvas%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"Surface connect è°ƒç”¨Surfaceçš„connectæ–¹æ³•ï¼Œå»ºç«‹ä¸SurfaceFlingeræœåŠ¡çš„è¿æ¥ï¼š Android13 Surface connectæµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android13-surface-lockcanvas%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 Surface lockCanvasæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surface-lockcanvas%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surface-connect"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"Surface dequeueBuffer è°ƒç”¨Surfaceçš„dequeueBufferæ–¹æ³•ï¼Œä»Surfaceä¸­è·å–ä¸€ä¸ªå¯ç”¨çš„Bufferï¼š Android13 Surface dequeueBufferæµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android13-surface-lockcanvas%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 Surface lockCanvasæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surface-lockcanvas%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surface-dequeuebuffer"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"Surface::queueBufferæ˜¯Androidç³»ç»Ÿä¸­Surfaceç±»çš„ä¸€ä¸ªæˆå‘˜å‡½æ•°ï¼Œç”¨äºå°†å›¾åƒæ•°æ®æ”¾å…¥Surfaceçš„ç¼“å†²åŒºä¸­ã€‚å®ƒçš„è°ƒç”¨åœ°æ–¹ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªï¼š åº”ç”¨ç¨‹åºï¼šåº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡Surfaceå¯¹è±¡çš„queueBufferå‡½æ•°å°†å›¾åƒæ•°æ®å‘é€ç»™SurfaceFlingeræœåŠ¡ã€‚è¿™æ ·ï¼ŒSurfaceFlingerå°±å¯ä»¥å°†å›¾åƒæ•°æ®è¿›è¡Œåˆæˆå’Œæ˜¾ç¤ºã€‚ SurfaceFlingeræœåŠ¡ï¼šSurfaceFlingeræ˜¯Androidç³»ç»Ÿä¸­è´Ÿè´£æ˜¾ç¤ºåˆæˆçš„æœåŠ¡ã€‚å®ƒä¼šå®šæœŸåœ°ä»å„ä¸ªåº”ç”¨ç¨‹åºçš„Surfaceä¸­è·å–å›¾åƒæ•°æ®ï¼Œå¹¶è¿›è¡Œåˆæˆå’Œæ¸²æŸ“ã€‚åœ¨åˆæˆè¿‡ç¨‹ä¸­ï¼ŒSurfaceFlingerä¼šè°ƒç”¨Surfaceçš„queueBufferå‡½æ•°å°†åˆæˆåçš„å›¾åƒæ•°æ®æ”¾å…¥Surfaceçš„ç¼“å†²åŒºä¸­ã€‚ Hardware Composerï¼šåœ¨ä¸€äº›æ”¯æŒç¡¬ä»¶åŠ é€Ÿçš„è®¾å¤‡ä¸Šï¼ŒSurfaceFlingerä¼šå°†åˆæˆåçš„å›¾åƒæ•°æ®äº¤ç»™Hardware Composeræ¥è¿›è¡Œæœ€ç»ˆçš„æ¸²æŸ“å’Œæ˜¾ç¤ºã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒHardware Composerä¹Ÿä¼šè°ƒç”¨Surfaceçš„queueBufferå‡½æ•°å°†å›¾åƒæ•°æ®æ”¾å…¥ç¡¬ä»¶ç¼“å†²åŒºä¸­ã€‚ å½“å¯¹GraphicBufferçš„ç»˜åˆ¶æ“ä½œå®Œæˆä¹‹åå°±éœ€è¦è°ƒç”¨queueBufferå‡½æ•°å°†è¿™å—bufferæ”¾å…¥BufferQueueé˜Ÿåˆ—ä¸­å¹¶é€šè¿‡å›è°ƒé€šçŸ¥æ¶ˆè´¹è€…ä½¿ç”¨è¿™å—bufferï¼ŒqueueBufferæ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š //framework/native/libs/gui/Surface.cpp sp\u003cIGraphicBufferProducer\u003e mGraphicBufferProducer; class Surface : public ANativeObjectBase\u003cANativeWindow, Surface, RefBase\u003e { int Surface::queueBuffer(android_native_buffer_t* buffer, int fenceFd) { ATRACE_CALL(); ALOGV(\"Surface::queueBuffer\"); Mutex::Autolock lock(mMutex); int i = getSlotFromBufferLocked(buffer); //æ‰¾åˆ°bufferåœ¨mSlotsä¸­çš„ä¸‹æ ‡ if (i \u003c 0) { if (fenceFd \u003e= 0) { close(fenceFd); } return i; } if (mSharedBufferSlot == i \u0026\u0026 mSharedBufferHasBeenQueued) { if (fenceFd \u003e= 0) { close(fenceFd); } return OK; } IGraphicBufferProducer::QueueBufferOutput output; IGraphicBufferProducer::QueueBufferInput input; getQueueBufferInputLocked(buffer, fenceFd, mTimestamp, \u0026input); applyGrallocMetadataLocked(buffer, input); sp\u003cFence\u003e fence = input.fence; nsecs_t now = systemTime(); status_t err = mGraphicBufferProducer-\u003equeueBuffer(i, input, \u0026output); mLastQueueDuration = systemTime() - now; if (err != OK) { ALOGE(\"queueBuffer: error queuing buffer, %d\", err); } onBufferQueuedLocked(i, fence, output); return err; } } ","date":"2024-11-06","objectID":"/posts/android13-surface-queuebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","blog","è½¬è½½"],"title":"Android13 Surface queueBufferæµç¨‹åˆ†æ_surface::queuebuffer-CSDNåšå®¢","uri":"/posts/android13-surface-queuebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"BpGraphicBufferProducer queueBuffer è°ƒç”¨mGraphicBufferProducer(IGraphicBufferProducer)çš„queueBufferæ–¹æ³•ï¼ŒIGraphicBufferProduceræ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”±BpGraphicBufferProducerå®ç°ï¼š //frameworks/native/libs/gui/IGraphicBufferProducer.cpp class BpGraphicBufferProducer : public BpInterface\u003cIGraphicBufferProducer\u003e { virtual status_t queueBuffer(int buf, const QueueBufferInput\u0026 input, QueueBufferOutput* output) { Parcel data, reply; data.writeInterfaceToken(IGraphicBufferProducer::getInterfaceDescriptor()); data.writeInt32(buf); data.write(input); status_t result = remote()-\u003etransact(QUEUE_BUFFER, data, \u0026reply); if (result != NO_ERROR) { return result; } result = reply.read(*output); if (result != NO_ERROR) { return result; } result = reply.readInt32(); return result; } } å‘é€QUEUE_BUFFERæ¶ˆæ¯ï¼Œå‘é€çš„æ¶ˆæ¯åœ¨BnGraphicBufferProducerçš„onTransactæ–¹æ³•ä¸­å¤„ç†ï¼š //frameworks/native/libs/gui/IGraphicBufferProducer.cpp status_t BnGraphicBufferProducer::onTransact( uint32_t code, const Parcel\u0026 data, Parcel* reply, uint32_t flags) { switch(code) { case QUEUE_BUFFER: { CHECK_INTERFACE(IGraphicBufferProducer, data, reply); int buf = data.readInt32(); QueueBufferInput input(data); QueueBufferOutput output; status_t result = queueBuffer(buf, input, \u0026output); reply-\u003ewrite(output); reply-\u003ewriteInt32(result); return NO_ERROR; } } } ","date":"2024-11-06","objectID":"/posts/android13-surface-queuebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","blog","è½¬è½½"],"title":"Android13 Surface queueBufferæµç¨‹åˆ†æ_surface::queuebuffer-CSDNåšå®¢","uri":"/posts/android13-surface-queuebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#bpgraphicbufferproducer-queuebuffer"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"BufferQueueProducer queueBuffer è°ƒç”¨BnGraphicBufferProducerçš„queueBufferæ–¹æ³•ï¼ŒBnGraphicBufferProducerç»§æ‰¿äºBufferQueueProducerï¼Œè°ƒç”¨BufferQueueProducerçš„queueBufferæ–¹æ³•ï¼Œå°†å›¾å½¢ç¼“å†²åŒºæ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ã€‚å½“åº”ç”¨ç¨‹åºå®Œæˆå¯¹å›¾å½¢ç¼“å†²åŒºçš„ç»˜åˆ¶åï¼Œå¯ä»¥è°ƒç”¨queueBufferæ–¹æ³•å°†å…¶æäº¤ç»™SurfaceFlingerè¿›è¡Œæ˜¾ç¤ºã€‚ Android13 BufferQueueProducer queueBufferæµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android13-surface-queuebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","blog","è½¬è½½"],"title":"Android13 Surface queueBufferæµç¨‹åˆ†æ_surface::queuebuffer-CSDNåšå®¢","uri":"/posts/android13-surface-queuebuffer%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#bufferqueueproducer-queuebuffer"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"Surfaceçš„unlockCanvasAndPostç”¨äºè§£é”å¹¶æäº¤Surfaceä¸Šçš„ç”»å¸ƒå†…å®¹ï¼Œä»£ç å¦‚ä¸‹ï¼š //frameworks/base/core/java/android/view/Surface.java public class Surface implements Parcelable { public void unlockCanvasAndPost(Canvas canvas) { synchronized (mLock) { checkNotReleasedLocked(); if (mHwuiContext != null) { mHwuiContext.unlockAndPost(canvas); } else { unlockSwCanvasAndPost(canvas); } } } } è°ƒç”¨Surfaceçš„unlockSwCanvasAndPostæ–¹æ³•ï¼š //frameworks/base/core/java/android/view/Surface.java public class Surface implements Parcelable { private void unlockSwCanvasAndPost(Canvas canvas) { if (canvas != mCanvas) { throw new IllegalArgumentException(\"canvas object must be the same instance that \" + \"was previously returned by lockCanvas\"); } if (mNativeObject != mLockedObject) { Log.w(TAG, \"WARNING: Surface's mNativeObject (0x\" + Long.toHexString(mNativeObject) + \") != mLockedObject (0x\" + Long.toHexString(mLockedObject) +\")\"); } if (mLockedObject == 0) { throw new IllegalStateException(\"Surface was not locked\"); } try { nativeUnlockCanvasAndPost(mLockedObject, canvas); } finally { nativeRelease(mLockedObject); mLockedObject = 0; } } } è°ƒç”¨nativeUnlockCanvasAndPostæ–¹æ³•ï¼ŒnativeLockCanvasæ˜¯ä¸€ä¸ªNativeæ–¹æ³•åœ¨android_view_Surface.cppä¸­å®ç°ï¼š //frameworks/base/core/jni/android_view_Surface.cpp static void nativeUnlockCanvasAndPost(JNIEnv* env, jclass clazz, jlong nativeObject, jobject canvasObj) { sp\u003cSurface\u003e surface(reinterpret_cast\u003cSurface *\u003e(nativeObject)); if (!isSurfaceValid(surface)) { return; } // detach the canvas from the surface graphics::Canvas canvas(env, canvasObj); canvas.setBuffer(nullptr, ADATASPACE_UNKNOWN); // unlock surface status_t err = surface-\u003eunlockAndPost(); if (err \u003c 0) { jniThrowException(env, IllegalArgumentException, NULL); } } è°ƒç”¨surface(Surface)çš„unlockAndPostæ–¹æ³•ï¼š //framework/native/libs/gui/Surface.cpp class Surface : public ANativeObjectBase\u003cANativeWindow, Surface, RefBase\u003e { status_t Surface::unlockAndPost() { if (mLockedBuffer == nullptr) { ALOGE(\"Surface::unlockAndPost failed, no locked buffer\"); return INVALID_OPERATION; } int fd = -1; status_t err = mLockedBuffer-\u003eunlockAsync(\u0026fd); ALOGE_IF(err, \"failed unlocking buffer (%p)\", mLockedBuffer-\u003ehandle); err = queueBuffer(mLockedBuffer.get(), fd); ALOGE_IF(err, \"queueBuffer (handle=%p) failed (%s)\", mLockedBuffer-\u003ehandle, strerror(-err)); mPostedBuffer = mLockedBuffer; mLockedBuffer = nullptr; return err; } } ","date":"2024-11-06","objectID":"/posts/android13-surface-unlockcanvasandpost%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 Surface unlockCanvasAndPostæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surface-unlockcanvasandpost%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":["å›¾å½¢æ˜¾ç¤º"],"content":"Surface queueBuffer è°ƒç”¨Surfaceçš„queueBufferæ–¹æ³•ï¼Œå°†å›¾åƒæ•°æ®æ”¾å…¥Surfaceçš„ç¼“å†²åŒºä¸­ï¼š Android13 Surface queueBufferæµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android13-surface-unlockcanvasandpost%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 Surface unlockCanvasAndPostæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surface-unlockcanvasandpost%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surface-queuebuffer"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"SurfaceFlingerçš„commitæ–¹æ³•ç”¨äºå°†åº”ç”¨ç¨‹åºçš„ç»˜åˆ¶ç»“æœæäº¤åˆ°å±å¹•ä¸Šæ˜¾ç¤ºã€‚ ä¸»è¦å°±æ˜¯å¤„ç†appç«¯å‘èµ·çš„ä¸€ç³»åˆ—transactionçš„äº‹åŠ¡è¯·æ±‚ï¼Œéœ€è¦å¯¹è¿™äº›è¯·æ±‚è¿›è¡Œè¯†åˆ«æ˜¯å¦å½“å‰å¸§å¤„ç†ï¼Œå¤„ç†è¿‡ç¨‹å°±æ˜¯æŠŠäº‹åŠ¡ä¸­çš„å±æ€§å–å‡ºï¼Œç„¶åæ›´æ–°åˆ°Layerä¸­ï¼Œå¶å°”bufferæ›´æ–°çš„è¿˜éœ€è¦è¿›è¡Œç›¸å…³çš„latchbufferæ“ä½œï¼ŒSurfaceFlingerçš„commitä»£ç å¦‚ä¸‹ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp bool SurfaceFlinger::commit(nsecs_t frameTime, int64_t vsyncId, nsecs_t expectedVsyncTime) //è¿™é‡ŒframeTimeä»£è¡¨å½“å‰æ—¶é—´ï¼ŒexpectedVsyncTimeä»£è¡¨ç¡¬ä»¶vsyncæ—¶é—´ï¼Œå³å±å¹•å…ˆçš„vsyncæ—¶é—´ FTL_FAKE_GUARD(kMainThreadContext) { // we set this once at the beginning of commit to ensure consistency throughout the whole frame mPowerHintSessionData.sessionEnabled = mPowerAdvisor-\u003eusePowerHintSession(); if (mPowerHintSessionData.sessionEnabled) { mPowerHintSessionData.commitStart = systemTime(); } // calculate the expected present time once and use the cached // value throughout this frame to make sure all layers are // seeing this same value. if (expectedVsyncTime \u003e= frameTime) { mExpectedPresentTime = expectedVsyncTime; } else { const DisplayStatInfo stats = mScheduler-\u003egetDisplayStatInfo(frameTime); mExpectedPresentTime = calculateExpectedPresentTime(stats); } const nsecs_t lastScheduledPresentTime = mScheduledPresentTime; mScheduledPresentTime = expectedVsyncTime; if (mPowerHintSessionData.sessionEnabled) { mPowerAdvisor-\u003esetTargetWorkDuration(mExpectedPresentTime - mPowerHintSessionData.commitStart); } const auto vsyncIn = [\u0026] { if (!ATRACE_ENABLED()) return 0.f; return (mExpectedPresentTime - systemTime()) / 1e6f; }(); ATRACE_FORMAT(\"%s %\" PRId64 \" vsyncIn %.2fms%s\", __func__, vsyncId, vsyncIn, mExpectedPresentTime == expectedVsyncTime ? \"\" : \" (adjusted)\"); // When Backpressure propagation is enabled we want to give a small grace period // for the present fence to fire instead of just giving up on this frame to handle cases // where present fence is just about to get signaled. const int graceTimeForPresentFenceMs = (mPropagateBackpressureClientComposition || !mHadClientComposition) ? 1 : 0; // Pending frames may trigger backpressure propagation. const TracedOrdinal\u003cbool\u003e framePending = {\"PrevFramePending\", previousFramePending(graceTimeForPresentFenceMs)}; // Frame missed counts for metrics tracking. // A frame is missed if the prior frame is still pending. If no longer pending, // then we still count the frame as missed if the predicted present time // was further in the past than when the fence actually fired. // Add some slop to correct for drift. This should generally be // smaller than a typical frame duration, but should not be so small // that it reports reasonable drift as a missed frame. const DisplayStatInfo stats = mScheduler-\u003egetDisplayStatInfo(systemTime()); const nsecs_t frameMissedSlop = stats.vsyncPeriod / 2; const nsecs_t previousPresentTime = previousFramePresentTime(); const TracedOrdinal\u003cbool\u003e frameMissed = {\"PrevFrameMissed\", framePending || (previousPresentTime \u003e= 0 \u0026\u0026 (lastScheduledPresentTime \u003c previousPresentTime - frameMissedSlop))}; const TracedOrdinal\u003cbool\u003e hwcFrameMissed = {\"PrevHwcFrameMissed\", mHadDeviceComposition \u0026\u0026 frameMissed}; const TracedOrdinal\u003cbool\u003e gpuFrameMissed = {\"PrevGpuFrameMissed\", mHadClientComposition \u0026\u0026 frameMissed}; if (frameMissed) { mFrameMissedCount++; mTimeStats-\u003eincrementMissedFrames(); } if (hwcFrameMissed) { mHwcFrameMissedCount++; } if (gpuFrameMissed) { mGpuFrameMissedCount++; } // If we are in the middle of a mode change and the fence hasn't // fired yet just wait for the next commit. // å¦‚æœæˆ‘ä»¬æ­£å¤„äºæ¨¡å¼æ›´æ”¹çš„è¿‡ç¨‹ä¸­ï¼Œå¹¶ä¸”å›´æ å°šæœªè§¦å‘ï¼Œè¯·ç­‰å¾…ä¸‹ä¸€æ¬¡æäº¤ã€‚ if (mSetActiveModePending) { if (framePending) { mScheduler-\u003escheduleFrame(); return false; } // We received the present fence from the HWC, so we assume it successfully updated // the mode, hence we update SF. mSetActiveModePending = false; { Mutex::Autolock lock(mStateLock); updateInternalStateWithChangedMode(); } } if (framePending) { if ((hwcFrameMissed \u0026\u0026 !gpuFrameMissed) || mPropagateBackpressureClientComposition) { scheduleCommit(FrameHint::kNone); return false; } } if (mTracingEnabledChanged) { mLayerTracingEnabled = mLayerTracing.isEn","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger commit(æäº¤)æµç¨‹åˆ†æ_surfaceflinger::commit-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"SurfaceFlinger commitCreatedLayers è°ƒç”¨SurfaceFlingerçš„commitCreatedLayersï¼Œåˆ›å»ºçš„layerï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp bool SurfaceFlinger::commitCreatedLayers() { std::vector\u003cLayerCreatedState\u003e createdLayers; { std::scoped_lock\u003cstd::mutex\u003e lock(mCreatedLayersLock); createdLayers = std::move(mCreatedLayers); mCreatedLayers.clear(); if (createdLayers.size() == 0) { return false; } } Mutex::Autolock _l(mStateLock); for (const auto\u0026 createdLayer : createdLayers) { handleLayerCreatedLocked(createdLayer); } createdLayers.clear(); mLayersAdded = true; return true; } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger commit(æäº¤)æµç¨‹åˆ†æ_surfaceflinger::commit-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-commitcreatedlayers"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"SurfaceFlinger flushTransactionQueues è°ƒç”¨SurfaceFlingerçš„flushTransactionQueuesæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp bool SurfaceFlinger::flushTransactionQueues(int64_t vsyncId) { // to prevent onHandleDestroyed from being called while the lock is held, // we must keep a copy of the transactions (specifically the composer // states) around outside the scope of the lock std::vector\u003cTransactionState\u003e transactions; // Layer handles that have transactions with buffers that are ready to be applied. std::unordered_map\u003csp\u003cIBinder\u003e, uint64_t, SpHash\u003cIBinder\u003e\u003e bufferLayersReadyToPresent; std::unordered_set\u003csp\u003cIBinder\u003e, SpHash\u003cIBinder\u003e\u003e applyTokensWithUnsignaledTransactions; { Mutex::Autolock _l(mStateLock); { Mutex::Autolock _l(mQueueLock); int lastTransactionsPendingBarrier = 0; int transactionsPendingBarrier = 0; // First collect transactions from the pending transaction queues. // We are not allowing unsignaled buffers here as we want to // collect all the transactions from applyTokens that are ready first. //åˆ·æ–°ä¸€ä¸‹PendingTransactionQueuesï¼Œè¿™ä¸ªä¸»è¦æ˜¯ä¸Šæ¬¡vsyncä¸­æ²¡æœ‰æ»¡è¶³æ¡ä»¶çš„Transactionæ”¾å…¥çš„ transactionsPendingBarrier = flushPendingTransactionQueues(transactions, bufferLayersReadyToPresent, applyTokensWithUnsignaledTransactions, /*tryApplyUnsignaled*/ false); // Second, collect transactions from the transaction queue. // Here as well we are not allowing unsignaled buffers for the same // reason as above. //å¼€å§‹éå†å½“æ¬¡vsyncçš„mTransactionQueue while (!mTransactionQueue.empty()) { auto\u0026 transaction = mTransactionQueue.front(); //åˆ¤æ–­æ˜¯å¦å¤„äºmPendingTransactionQueuesé˜Ÿé‡Œé‡Œé¢ const bool pendingTransactions = mPendingTransactionQueues.find(transaction.applyToken) != mPendingTransactionQueues.end(); //è¿™é‡Œæœ‰ä¸ªreadyçš„åˆ¤æ–­ï¼Œä¸»è¦å°±æ˜¯çœ‹çœ‹å½“å‰çš„Transactionæ˜¯å¦å·²ç»readyï¼Œæ²¡æœ‰readyåˆ™ä¸äºˆè¿›è¡Œä¼ é€’Transaction const auto ready = [\u0026]() REQUIRES(mStateLock) { if (pendingTransactions) { ATRACE_NAME(\"pendingTransactions\"); return TransactionReadiness::NotReady; } return transactionIsReadyToBeApplied(transaction, transaction.frameTimelineInfo, transaction.isAutoTimestamp, transaction.desiredPresentTime, transaction.originUid, transaction.states, bufferLayersReadyToPresent, transactions.size(), /*tryApplyUnsignaled*/ false); //æ£€æŸ¥å½“å‰çš„äº‹åŠ¡æ˜¯å¦å‡†å¤‡å¥½è¢«åº”ç”¨ }(); ATRACE_INT(\"TransactionReadiness\", static_cast\u003cint\u003e(ready)); if (ready != TransactionReadiness::Ready) { if (ready == TransactionReadiness::NotReadyBarrier) { transactionsPendingBarrier++; } //æ”¾å…¥mPendingTransactionQueues mPendingTransactionQueues[transaction.applyToken].push(std::move(transaction)); } else { //å·²ç»readyåˆ™è¿›å…¥å¦‚ä¸‹çš„æ“ä½œ transaction.traverseStatesWithBuffers([\u0026](const layer_state_t\u0026 state) { const bool frameNumberChanged = state.bufferData-\u003eflags.test( BufferData::BufferDataChange::frameNumberChanged); //ä¼šæŠŠstateæ”¾å…¥åˆ°bufferLayersReadyToPresentè¿™ä¸ªmapä¸­ if (frameNumberChanged) { bufferLayersReadyToPresent[state.surface] = state.bufferData-\u003eframeNumber; } else { // Barrier function only used for BBQ which always includes a frame number. // This value only used for barrier logic. bufferLayersReadyToPresent[state.surface] = std::numeric_limits\u003cuint64_t\u003e::max(); } }); //æœ€é‡è¦çš„æ”¾å…¥åˆ°transactions transactions.emplace_back(std::move(transaction)); } //ä»mTransactionQueueè¿™é‡Œç§»é™¤ mTransactionQueue.pop_front(); ATRACE_INT(\"TransactionQueue\", mTransactionQueue.size()); } // Transactions with a buffer pending on a barrier may be on a different applyToken // than the transaction which satisfies our barrier. In fact this is the exact use case // that the primitive is designed for. This means we may first process // the barrier dependent transaction, determine it ineligible to complete // and then satisfy in a later inner iteration of flushPendingTransactionQueues. // The barrier dependent transaction was eligible to be presented in this frame // but we would have prevented it without case. To fix this we continually // loop through flushPendingTransactionQueues until we perform an iteration // where the number of transactionsPendingBarrier doesn't change. This way // we can co","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger commit(æäº¤)æµç¨‹åˆ†æ_surfaceflinger::commit-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-flushtransactionqueues"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"SurfaceFlinger transactionIsReadyToBeApplied è°ƒç”¨SurfaceFlingerçš„transactionIsReadyToBeAppliedæ–¹æ³•ï¼Œæ£€æŸ¥å½“å‰çš„äº‹åŠ¡æ˜¯å¦å‡†å¤‡å¥½è¢«åº”ç”¨ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp auto SurfaceFlinger::transactionIsReadyToBeApplied(TransactionState\u0026 transaction, const FrameTimelineInfo\u0026 info, bool isAutoTimestamp, int64_t desiredPresentTime, uid_t originUid, const Vector\u003cComposerState\u003e\u0026 states, const std::unordered_map\u003c sp\u003cIBinder\u003e, uint64_t, SpHash\u003cIBinder\u003e\u003e\u0026 bufferLayersReadyToPresent, size_t totalTXapplied, bool tryApplyUnsignaled) const -\u003e TransactionReadiness { ATRACE_FORMAT(\"transactionIsReadyToBeApplied vsyncId: %\" PRId64, info.vsyncId); const nsecs_t expectedPresentTime = mExpectedPresentTime.load(); // Do not present if the desiredPresentTime has not passed unless it is more than one second // in the future. We ignore timestamps more than 1 second in the future for stability reasons. if (!isAutoTimestamp \u0026\u0026 desiredPresentTime \u003e= expectedPresentTime \u0026\u0026 desiredPresentTime \u003c expectedPresentTime + s2ns(1)) { ATRACE_NAME(\"not current\"); return TransactionReadiness::NotReady; } if (!mScheduler-\u003eisVsyncValid(expectedPresentTime, originUid)) { ATRACE_NAME(\"!isVsyncValid\"); return TransactionReadiness::NotReady; } // If the client didn't specify desiredPresentTime, use the vsyncId to determine the expected // present time of this transaction. if (isAutoTimestamp \u0026\u0026 frameIsEarly(expectedPresentTime, info.vsyncId)) { ATRACE_NAME(\"frameIsEarly\"); return TransactionReadiness::NotReady; } bool fenceUnsignaled = false; auto queueProcessTime = systemTime(); //å…³é”®éƒ¨åˆ†å¯¹transactionçš„statesè¿›è¡ŒæŒ¨ä¸ªstateéå†æƒ…å†µ for (const ComposerState\u0026 state : states) { const layer_state_t\u0026 s = state.state; sp\u003cLayer\u003e layer = nullptr; //è¿™é‡Œä¼šåˆ¤æ–­åˆ°åº•æœ‰æ²¡æœ‰surfaceã€‚æ²¡æœ‰çš„è¯å°±ä¸ä¼šè¿›å…¥ä¸‹é¢åˆ¤æ–­ç¯èŠ‚ if (s.surface) { layer = fromHandle(s.surface).promote(); } else if (s.hasBufferChanges()) { ALOGW(\"Transaction with buffer, but no Layer?\"); continue; } if (!layer) { continue; } if (s.hasBufferChanges() \u0026\u0026 s.bufferData-\u003ehasBarrier \u0026\u0026 ((layer-\u003egetDrawingState().frameNumber) \u003c s.bufferData-\u003ebarrierFrameNumber)) { const bool willApplyBarrierFrame = (bufferLayersReadyToPresent.find(s.surface) != bufferLayersReadyToPresent.end()) \u0026\u0026 (bufferLayersReadyToPresent.at(s.surface) \u003e= s.bufferData-\u003ebarrierFrameNumber); if (!willApplyBarrierFrame) { ATRACE_NAME(\"NotReadyBarrier\"); return TransactionReadiness::NotReadyBarrier; } } //æ³¨æ„è¿™é‡Œä¼šæœ‰ä¸€ä¸ªæ ‡å¿—allowLatchUnsignaledæ„æ€æ˜¯æ˜¯å¦å¯ä»¥latchésignaledçš„buffer const bool allowLatchUnsignaled = tryApplyUnsignaled \u0026\u0026 shouldLatchUnsignaled(layer, s, states.size(), totalTXapplied); ATRACE_FORMAT(\"%s allowLatchUnsignaled=%s\", layer-\u003egetName().c_str(), allowLatchUnsignaled ? \"true\" : \"false\"); const bool acquireFenceChanged = s.bufferData \u0026\u0026 s.bufferData-\u003eflags.test(BufferData::BufferDataChange::fenceChanged) \u0026\u0026 s.bufferData-\u003eacquireFence; //è¿™é‡Œä¼šè¿›è¡Œå…³é”®çš„åˆ¤æ–­ï¼Œåˆ¤æ–­stateçš„bufferData-\u003eacquireFenceæ˜¯å¦å·²ç»signaled fenceUnsignaled = fenceUnsignaled || (acquireFenceChanged \u0026\u0026 s.bufferData-\u003eacquireFence-\u003egetStatus() == Fence::Status::Unsignaled); //å¦‚æœfenceUnsignaledå±äºfenceUnsignaledï¼ŒallowLatchUnsignaledä¹Ÿä¸ºfalse if (fenceUnsignaled \u0026\u0026 !allowLatchUnsignaled) { if (!transaction.sentFenceTimeoutWarning \u0026\u0026 queueProcessTime - transaction.queueTime \u003e std::chrono::nanoseconds(4s).count()) { transaction.sentFenceTimeoutWarning = true; auto listener = s.bufferData-\u003ereleaseBufferListener; if (listener) { listener-\u003eonTransactionQueueStalled(); } } //é‚£ä¹ˆå°±ä»£è¡¨ä¸å¯ä»¥ä¼ é€’transactionï¼Œä¼šè¿”å›NotReady ATRACE_NAME(\"fence unsignaled\"); return TransactionReadiness::NotReady; } if (s.hasBufferChanges()) { // If backpressure is enabled and we already have a buffer to commit, keep the // transaction in the queue. const bool hasPendingBuffer = bufferLayersReadyToPresent.find(s.surface) != bufferLayersReadyToPresent.end(); //å¦‚æœå‰é¢å·²ç»æœ‰stateæ”¾å…¥äº†ï¼Œåˆ™ä¸åœ¨æ”¾å…¥ï¼Œä¼šæ”¾å…¥pending if (layer-\u003ebackpressureEnabled() \u0026\u0026 hasPendingBuffer \u0026\u0026 isAutoTimestamp) { ATRACE_NAME(\"hasPendingBuffer\"); return TransactionReadiness::NotReady; } } } return fenceUnsignaled ? TransactionReadiness::R","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:2:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger commit(æäº¤)æµç¨‹åˆ†æ_surfaceflinger::commit-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-transactionisreadytobeapplied"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"SurfaceFlinger applyTransactions è°ƒç”¨SurfaceFlingerçš„applyTransactionsæ–¹æ³•ï¼Œåº”ç”¨äº‹åŠ¡ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp bool SurfaceFlinger::applyTransactions(std::vector\u003cTransactionState\u003e\u0026 transactions, int64_t vsyncId) { bool needsTraversal = false; // Now apply all transactions. //éå†æ¯ä¸€ä¸ªä¸Šé¢åˆ¤æ–­ä¸ºreadyçš„transaction for (auto\u0026 transaction : transactions) { //æ ¸å¿ƒæ–¹æ³•åˆè°ƒç”¨åˆ°äº†applyTransactionState needsTraversal |= applyTransactionState(transaction.frameTimelineInfo, transaction.states, transaction.displays, transaction.flags, transaction.inputWindowCommands, transaction.desiredPresentTime, transaction.isAutoTimestamp, transaction.buffer, transaction.postTime, transaction.permissions, transaction.hasListenerCallbacks, transaction.listenerCallbacks, transaction.originPid, transaction.originUid, transaction.id); if (transaction.transactionCommittedSignal) { mTransactionCommittedSignals.emplace_back( std::move(transaction.transactionCommittedSignal)); } } if (mTransactionTracing) { mTransactionTracing-\u003eaddCommittedTransactions(transactions, vsyncId); } return needsTraversal; } SurfaceFlinger applyTransactionState è°ƒç”¨SurfaceFlingerçš„applyTransactionStateæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp bool SurfaceFlinger::applyTransactionState(const FrameTimelineInfo\u0026 frameTimelineInfo, Vector\u003cComposerState\u003e\u0026 states, const Vector\u003cDisplayState\u003e\u0026 displays, uint32_t flags, const InputWindowCommands\u0026 inputWindowCommands, const int64_t desiredPresentTime, bool isAutoTimestamp, const client_cache_t\u0026 uncacheBuffer, const int64_t postTime, uint32_t permissions, bool hasListenerCallbacks, const std::vector\u003cListenerCallbacks\u003e\u0026 listenerCallbacks, int originPid, int originUid, uint64_t transactionId) { uint32_t transactionFlags = 0; //éå†æ˜¯transactionçš„dispplays for (const DisplayState\u0026 display : displays) { //éå†æ˜¯å¦æœ‰dispplayç›¸å…³çš„å˜åŒ– transactionFlags |= setDisplayStateLocked(display); } // start and end registration for listeners w/ no surface so they can get their callback. Note // that listeners with SurfaceControls will start registration during setClientStateLocked // below. for (const auto\u0026 listener : listenerCallbacks) { mTransactionCallbackInvoker.addEmptyTransaction(listener); } uint32_t clientStateFlags = 0; for (int i = 0; i \u003c states.size(); i++) { //æœ€å…³é”®æ–¹æ³•å¼€å§‹éå†ä¸€ä¸ªä¸ªçš„states ComposerState\u0026 state = states.editItemAt(i); //è°ƒç”¨åˆ°äº†setClientStateLockedæ–¹æ³• clientStateFlags |= setClientStateLocked(frameTimelineInfo, state, desiredPresentTime, isAutoTimestamp, postTime, permissions); if ((flags \u0026 eAnimation) \u0026\u0026 state.state.surface) { if (const auto layer = fromHandle(state.state.surface).promote()) { using LayerUpdateType = scheduler::LayerHistory::LayerUpdateType; mScheduler-\u003erecordLayerHistory(layer.get(), isAutoTimestamp ? 0 : desiredPresentTime, LayerUpdateType::AnimationTX); } } } transactionFlags |= clientStateFlags; if (permissions \u0026 layer_state_t::Permission::ACCESS_SURFACE_FLINGER) { transactionFlags |= addInputWindowCommands(inputWindowCommands); } else if (!inputWindowCommands.empty()) { ALOGE(\"Only privileged callers are allowed to send input commands.\"); } if (uncacheBuffer.isValid()) { ClientCache::getInstance().erase(uncacheBuffer); } // If a synchronous transaction is explicitly requested without any changes, force a transaction // anyway. This can be used as a flush mechanism for previous async transactions. // Empty animation transaction can be used to simulate back-pressure, so also force a // transaction for empty animation transactions. if (transactionFlags == 0 \u0026\u0026 ((flags \u0026 eSynchronous) || (flags \u0026 eAnimation))) { transactionFlags = eTransactionNeeded; } bool needsTraversal = false; if (transactionFlags) { if (mInterceptor-\u003eisEnabled()) { mInterceptor-\u003esaveTransaction(states, mCurrentState.displays, displays, flags, originPid, originUid, transactionId); } // We are on the main thread, we are about to preform a traversal. Clear the traversal bit // so we don't have to wake up again next frame to preform an unneces","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:2:2","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger commit(æäº¤)æµç¨‹åˆ†æ_surfaceflinger::commit-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-applytransactions"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"SurfaceFlinger applyTransactions è°ƒç”¨SurfaceFlingerçš„applyTransactionsæ–¹æ³•ï¼Œåº”ç”¨äº‹åŠ¡ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp bool SurfaceFlinger::applyTransactions(std::vector\u0026 transactions, int64_t vsyncId) { bool needsTraversal = false; // Now apply all transactions. //éå†æ¯ä¸€ä¸ªä¸Šé¢åˆ¤æ–­ä¸ºreadyçš„transaction for (auto\u0026 transaction : transactions) { //æ ¸å¿ƒæ–¹æ³•åˆè°ƒç”¨åˆ°äº†applyTransactionState needsTraversal |= applyTransactionState(transaction.frameTimelineInfo, transaction.states, transaction.displays, transaction.flags, transaction.inputWindowCommands, transaction.desiredPresentTime, transaction.isAutoTimestamp, transaction.buffer, transaction.postTime, transaction.permissions, transaction.hasListenerCallbacks, transaction.listenerCallbacks, transaction.originPid, transaction.originUid, transaction.id); if (transaction.transactionCommittedSignal) { mTransactionCommittedSignals.emplace_back( std::move(transaction.transactionCommittedSignal)); } } if (mTransactionTracing) { mTransactionTracing-\u003eaddCommittedTransactions(transactions, vsyncId); } return needsTraversal; } SurfaceFlinger applyTransactionState è°ƒç”¨SurfaceFlingerçš„applyTransactionStateæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp bool SurfaceFlinger::applyTransactionState(const FrameTimelineInfo\u0026 frameTimelineInfo, Vector\u0026 states, const Vector\u0026 displays, uint32_t flags, const InputWindowCommands\u0026 inputWindowCommands, const int64_t desiredPresentTime, bool isAutoTimestamp, const client_cache_t\u0026 uncacheBuffer, const int64_t postTime, uint32_t permissions, bool hasListenerCallbacks, const std::vector\u0026 listenerCallbacks, int originPid, int originUid, uint64_t transactionId) { uint32_t transactionFlags = 0; //éå†æ˜¯transactionçš„dispplays for (const DisplayState\u0026 display : displays) { //éå†æ˜¯å¦æœ‰dispplayç›¸å…³çš„å˜åŒ– transactionFlags |= setDisplayStateLocked(display); } // start and end registration for listeners w/ no surface so they can get their callback. Note // that listeners with SurfaceControls will start registration during setClientStateLocked // below. for (const auto\u0026 listener : listenerCallbacks) { mTransactionCallbackInvoker.addEmptyTransaction(listener); } uint32_t clientStateFlags = 0; for (int i = 0; i \u003c states.size(); i++) { //æœ€å…³é”®æ–¹æ³•å¼€å§‹éå†ä¸€ä¸ªä¸ªçš„states ComposerState\u0026 state = states.editItemAt(i); //è°ƒç”¨åˆ°äº†setClientStateLockedæ–¹æ³• clientStateFlags |= setClientStateLocked(frameTimelineInfo, state, desiredPresentTime, isAutoTimestamp, postTime, permissions); if ((flags \u0026 eAnimation) \u0026\u0026 state.state.surface) { if (const auto layer = fromHandle(state.state.surface).promote()) { using LayerUpdateType = scheduler::LayerHistory::LayerUpdateType; mScheduler-\u003erecordLayerHistory(layer.get(), isAutoTimestamp ? 0 : desiredPresentTime, LayerUpdateType::AnimationTX); } } } transactionFlags |= clientStateFlags; if (permissions \u0026 layer_state_t::Permission::ACCESS_SURFACE_FLINGER) { transactionFlags |= addInputWindowCommands(inputWindowCommands); } else if (!inputWindowCommands.empty()) { ALOGE(\"Only privileged callers are allowed to send input commands.\"); } if (uncacheBuffer.isValid()) { ClientCache::getInstance().erase(uncacheBuffer); } // If a synchronous transaction is explicitly requested without any changes, force a transaction // anyway. This can be used as a flush mechanism for previous async transactions. // Empty animation transaction can be used to simulate back-pressure, so also force a // transaction for empty animation transactions. if (transactionFlags == 0 \u0026\u0026 ((flags \u0026 eSynchronous) || (flags \u0026 eAnimation))) { transactionFlags = eTransactionNeeded; } bool needsTraversal = false; if (transactionFlags) { if (mInterceptor-\u003eisEnabled()) { mInterceptor-\u003esaveTransaction(states, mCurrentState.displays, displays, flags, originPid, originUid, transactionId); } // We are on the main thread, we are about to preform a traversal. Clear the traversal bit // so we don't have to wake up again next frame to preform an unneces","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:2:2","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger commit(æäº¤)æµç¨‹åˆ†æ_surfaceflinger::commit-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-applytransactionstate"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"SurfaceFlinger applyTransactions è°ƒç”¨SurfaceFlingerçš„applyTransactionsæ–¹æ³•ï¼Œåº”ç”¨äº‹åŠ¡ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp bool SurfaceFlinger::applyTransactions(std::vector\u0026 transactions, int64_t vsyncId) { bool needsTraversal = false; // Now apply all transactions. //éå†æ¯ä¸€ä¸ªä¸Šé¢åˆ¤æ–­ä¸ºreadyçš„transaction for (auto\u0026 transaction : transactions) { //æ ¸å¿ƒæ–¹æ³•åˆè°ƒç”¨åˆ°äº†applyTransactionState needsTraversal |= applyTransactionState(transaction.frameTimelineInfo, transaction.states, transaction.displays, transaction.flags, transaction.inputWindowCommands, transaction.desiredPresentTime, transaction.isAutoTimestamp, transaction.buffer, transaction.postTime, transaction.permissions, transaction.hasListenerCallbacks, transaction.listenerCallbacks, transaction.originPid, transaction.originUid, transaction.id); if (transaction.transactionCommittedSignal) { mTransactionCommittedSignals.emplace_back( std::move(transaction.transactionCommittedSignal)); } } if (mTransactionTracing) { mTransactionTracing-\u003eaddCommittedTransactions(transactions, vsyncId); } return needsTraversal; } SurfaceFlinger applyTransactionState è°ƒç”¨SurfaceFlingerçš„applyTransactionStateæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp bool SurfaceFlinger::applyTransactionState(const FrameTimelineInfo\u0026 frameTimelineInfo, Vector\u0026 states, const Vector\u0026 displays, uint32_t flags, const InputWindowCommands\u0026 inputWindowCommands, const int64_t desiredPresentTime, bool isAutoTimestamp, const client_cache_t\u0026 uncacheBuffer, const int64_t postTime, uint32_t permissions, bool hasListenerCallbacks, const std::vector\u0026 listenerCallbacks, int originPid, int originUid, uint64_t transactionId) { uint32_t transactionFlags = 0; //éå†æ˜¯transactionçš„dispplays for (const DisplayState\u0026 display : displays) { //éå†æ˜¯å¦æœ‰dispplayç›¸å…³çš„å˜åŒ– transactionFlags |= setDisplayStateLocked(display); } // start and end registration for listeners w/ no surface so they can get their callback. Note // that listeners with SurfaceControls will start registration during setClientStateLocked // below. for (const auto\u0026 listener : listenerCallbacks) { mTransactionCallbackInvoker.addEmptyTransaction(listener); } uint32_t clientStateFlags = 0; for (int i = 0; i \u003c states.size(); i++) { //æœ€å…³é”®æ–¹æ³•å¼€å§‹éå†ä¸€ä¸ªä¸ªçš„states ComposerState\u0026 state = states.editItemAt(i); //è°ƒç”¨åˆ°äº†setClientStateLockedæ–¹æ³• clientStateFlags |= setClientStateLocked(frameTimelineInfo, state, desiredPresentTime, isAutoTimestamp, postTime, permissions); if ((flags \u0026 eAnimation) \u0026\u0026 state.state.surface) { if (const auto layer = fromHandle(state.state.surface).promote()) { using LayerUpdateType = scheduler::LayerHistory::LayerUpdateType; mScheduler-\u003erecordLayerHistory(layer.get(), isAutoTimestamp ? 0 : desiredPresentTime, LayerUpdateType::AnimationTX); } } } transactionFlags |= clientStateFlags; if (permissions \u0026 layer_state_t::Permission::ACCESS_SURFACE_FLINGER) { transactionFlags |= addInputWindowCommands(inputWindowCommands); } else if (!inputWindowCommands.empty()) { ALOGE(\"Only privileged callers are allowed to send input commands.\"); } if (uncacheBuffer.isValid()) { ClientCache::getInstance().erase(uncacheBuffer); } // If a synchronous transaction is explicitly requested without any changes, force a transaction // anyway. This can be used as a flush mechanism for previous async transactions. // Empty animation transaction can be used to simulate back-pressure, so also force a // transaction for empty animation transactions. if (transactionFlags == 0 \u0026\u0026 ((flags \u0026 eSynchronous) || (flags \u0026 eAnimation))) { transactionFlags = eTransactionNeeded; } bool needsTraversal = false; if (transactionFlags) { if (mInterceptor-\u003eisEnabled()) { mInterceptor-\u003esaveTransaction(states, mCurrentState.displays, displays, flags, originPid, originUid, transactionId); } // We are on the main thread, we are about to preform a traversal. Clear the traversal bit // so we don't have to wake up again next frame to preform an unneces","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:2:2","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger commit(æäº¤)æµç¨‹åˆ†æ_surfaceflinger::commit-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-setclientstatelocked"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"SurfaceFlinger commitTransactions è°ƒç”¨SurfaceFlingerçš„commitTransactionsæ–¹æ³•ï¼Œè¿›è¡ŒTransactionæäº¤ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::commitTransactions() { ATRACE_CALL(); // Keep a copy of the drawing state (that is going to be overwritten // by commitTransactionsLocked) outside of mStateLock so that the side // effects of the State assignment don't happen with mStateLock held, // which can cause deadlocks. State drawingState(mDrawingState); Mutex::Autolock lock(mStateLock); mDebugInTransaction = systemTime(); // Here we're guaranteed that some transaction flags are set // so we can call commitTransactionsLocked unconditionally. // We clear the flags with mStateLock held to guarantee that // mCurrentState won't change until the transaction is committed. modulateVsync(\u0026VsyncModulator::onTransactionCommit); commitTransactionsLocked(clearTransactionFlags(eTransactionMask)); mDebugInTransaction = 0; } è°ƒç”¨SurfaceFlingerçš„commitTransactionsLockedæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::commitTransactionsLocked(uint32_t transactionFlags) { // Commit display transactions. const bool displayTransactionNeeded = transactionFlags \u0026 eDisplayTransactionNeeded; if (displayTransactionNeeded) { //å¦‚æœéœ€è¦æ˜¾ç¤º processDisplayChangesLocked(); //å¤„ç†æ˜¾ç¤ºå˜åŒ–ç›¸å…³ processDisplayHotplugEventsLocked(); } mForceTransactionDisplayChange = displayTransactionNeeded; if (mSomeChildrenChanged) { mVisibleRegionsDirty = true; mSomeChildrenChanged = false; } // Update transform hint. if (transactionFlags \u0026 (eTransformHintUpdateNeeded | eDisplayTransactionNeeded)) { // Layers and/or displays have changed, so update the transform hint for each layer. // // NOTE: we do this here, rather than when presenting the display so that // the hint is set before we acquire a buffer from the surface texture. // // NOTE: layer transactions have taken place already, so we use their // drawing state. However, SurfaceFlinger's own transaction has not // happened yet, so we must use the current state layer list // (soon to become the drawing state list). // sp\u003cconst DisplayDevice\u003e hintDisplay; ui::LayerStack layerStack; mCurrentState.traverse([\u0026](Layer* layer) REQUIRES(mStateLock) { // NOTE: we rely on the fact that layers are sorted by // layerStack first (so we don't have to traverse the list // of displays for every layer). if (const auto filter = layer-\u003egetOutputFilter(); layerStack != filter.layerStack) { layerStack = filter.layerStack; hintDisplay = nullptr; // Find the display that includes the layer. for (const auto\u0026 [token, display] : mDisplays) { if (!display-\u003egetCompositionDisplay()-\u003eincludesLayer(filter)) { continue; } // Pick the primary display if another display mirrors the layer. if (hintDisplay) { hintDisplay = nullptr; break; } hintDisplay = display; } } if (!hintDisplay) { // NOTE: TEMPORARY FIX ONLY. Real fix should cause layers to // redraw after transform hint changes. See bug 8508397. // could be null when this layer is using a layerStack // that is not visible on any display. Also can occur at // screen off/on times. hintDisplay = getDefaultDisplayDeviceLocked(); } layer-\u003eupdateTransformHint(hintDisplay-\u003egetTransformHint()); }); } if (mLayersAdded) { mLayersAdded = false; // Layers have been added. mVisibleRegionsDirty = true; } // some layers might have been removed, so // we need to update the regions they're exposing. if (mLayersRemoved) { mLayersRemoved = false; mVisibleRegionsDirty = true; mDrawingState.traverseInZOrder([\u0026](Layer* layer) { if (mLayersPendingRemoval.indexOf(layer) \u003e= 0) { // this layer is not visible anymore Region visibleReg; visibleReg.set(layer-\u003egetScreenBounds()); invalidateLayerStack(layer, visibleReg); } }); } doCommitTransactions(); signalSynchronousTransactions(CountDownLatch::eSyncTransaction); mAnimTransactionPending = false; } ä¸Šé¢æ–¹æ³•ä¸»è¦å¤„ç†å¦‚ä¸‹ï¼š 1ã€è°ƒç”¨SurfaceFlingerçš„processDisplayChangesLockedæ–¹æ³•ï¼Œå¤„ç†æ˜¾ç¤ºå™¨å˜åŒ–ç›¸å…³ã€‚ 2ã€è°ƒç”¨SurfaceFlingerçš„doCommitTransactionsæ–¹æ³•ï¼Œæ‰§è¡Œæäº¤äº‹åŠ¡ã€‚ ä¸‹é¢åˆ†åˆ«è¿›è¡Œåˆ†","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger commit(æäº¤)æµç¨‹åˆ†æ_surfaceflinger::commit-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-committransactions"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"SurfaceFlinger processDisplayChangesLocked è°ƒç”¨SurfaceFlingerçš„processDisplayChangesLockedæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::processDisplayChangesLocked() { // here we take advantage of Vector's copy-on-write semantics to // improve performance by skipping the transaction entirely when // know that the lists are identical const KeyedVector\u003cwp\u003cIBinder\u003e, DisplayDeviceState\u003e\u0026 curr(mCurrentState.displays); const KeyedVector\u003cwp\u003cIBinder\u003e, DisplayDeviceState\u003e\u0026 draw(mDrawingState.displays); if (!curr.isIdenticalTo(draw)) { mVisibleRegionsDirty = true; // find the displays that were removed // (ie: in drawing state but not in current state) // also handle displays that changed // (ie: displays that are in both lists) for (size_t i = 0; i \u003c draw.size(); i++) { const wp\u003cIBinder\u003e\u0026 displayToken = draw.keyAt(i); const ssize_t j = curr.indexOfKey(displayToken); if (j \u003c 0) { // in drawing state but not in current state // å¤„äºç»˜å›¾çŠ¶æ€ï¼Œä½†ä¸åœ¨å½“å‰çŠ¶æ€ processDisplayRemoved(displayToken); } else { // this display is in both lists. see if something changed. // æ­¤æ˜¾ç¤ºåœ¨ä¸¤ä¸ªåˆ—è¡¨ä¸­ã€‚çœ‹çœ‹æ˜¯å¦æœ‰å˜åŒ–ã€‚ const DisplayDeviceState\u0026 currentState = curr[j]; const DisplayDeviceState\u0026 drawingState = draw[i]; processDisplayChanged(displayToken, currentState, drawingState); } } // find displays that were added // æŸ¥æ‰¾å·²æ·»åŠ çš„æ˜¾ç¤º // (ie: in current state but not in drawing state) for (size_t i = 0; i \u003c curr.size(); i++) { const wp\u003cIBinder\u003e\u0026 displayToken = curr.keyAt(i); if (draw.indexOfKey(displayToken) \u003c 0) { processDisplayAdded(displayToken, curr[i]); } } } mDrawingState.displays = mCurrentState.displays; } ä¸Šé¢æ–¹æ³•æ ¹æ®ä¸åŒçš„è°ƒèŠ‚è°ƒç”¨å¦‚ä¸‹æ–¹æ³•ï¼š 1ã€è°ƒç”¨processDisplayRemovedæ–¹æ³•ï¼Œå¤„ç†æ˜¾ç¤ºå™¨åˆ é™¤ã€‚ 2ã€è°ƒç”¨processDisplayChangedæ–¹æ³•ï¼Œå¤„ç†æ˜¾ç¤ºå™¨å˜æ›´ã€‚ 3ã€è°ƒç”¨processDisplayAddedæ–¹æ³•ï¼Œå¤„ç†æ˜¾ç¤ºå™¨æ·»åŠ ã€‚ ä¸‹é¢åˆ†åˆ«è¿›è¡Œåˆ†æï¼š SurfaceFlinger processDisplayRemoved è°ƒç”¨processDisplayRemovedæ–¹æ³•ï¼Œå¤„ç†æ˜¾ç¤ºå™¨åˆ é™¤ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::processDisplayRemoved(const wp\u003cIBinder\u003e\u0026 displayToken) { auto display = getDisplayDeviceLocked(displayToken); if (display) { display-\u003edisconnect(); //ä¸Displayæ–­å¼€è¿æ¥ if (display-\u003eisVirtual()) { releaseVirtualDisplay(display-\u003egetVirtualId()); //å¦‚æœæ˜¯è™šæ‹Ÿæ˜¾ç¤ºå™¨ï¼Œå°±è¿›è¡Œèµ„æºé‡Šæ”¾ } else { dispatchDisplayHotplugEvent(display-\u003egetPhysicalId(), false); //åˆ†é…æ˜¾ç¤ºå™¨çƒ­æ’æ‹”äº‹ä»¶ } } mDisplays.erase(displayToken); if (display \u0026\u0026 display-\u003eisVirtual()) { static_cast\u003cvoid\u003e(mScheduler-\u003eschedule([display = std::move(display)] { // Destroy the display without holding the mStateLock. // This is a temporary solution until we can manage transaction queues without // holding the mStateLock. // With blast, the IGBP that is passed to the VirtualDisplaySurface is owned by the // client. When the IGBP is disconnected, its buffer cache in SF will be cleared // via SurfaceComposerClient::doUncacheBufferTransaction. This call from the client // ends up running on the main thread causing a deadlock since setTransactionstate // will try to acquire the mStateLock. Instead we extend the lifetime of // DisplayDevice and destroy it in the main thread without holding the mStateLock. // The display will be disconnected and removed from the mDisplays list so it will // not be accessible. })); } } SurfaceFlinger processDisplayChanged è°ƒç”¨processDisplayChangedæ–¹æ³•ï¼Œå¤„ç†æ˜¾ç¤ºå™¨å˜æ›´ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::processDisplayChanged(const wp\u003cIBinder\u003e\u0026 displayToken, const DisplayDeviceState\u0026 currentState, const DisplayDeviceState\u0026 drawingState) { const sp\u003cIBinder\u003e currentBinder = IInterface::asBinder(currentState.surface); const sp\u003cIBinder\u003e drawingBinder = IInterface::asBinder(drawingState.surface); // Recreate the DisplayDevice if the surface or sequence ID changed. // å¦‚æœå›¾é¢æˆ–åºåˆ— ID å‘ç”Ÿæ›´æ”¹ï¼Œè¯·é‡æ–°åˆ›å»º DisplayDeviceã€‚ if (currentBinder != drawingBinder || currentState.sequenceId != drawingState.sequenceId) { getRenderEngine().cleanFramebufferCache(); if (const auto display = getDisplayDeviceLocked(displayToken)) { display-\u003edisconnect(); if (display-\u003eisVirtual()) { releaseVirtualDisplay(display-\u003eget","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger commit(æäº¤)æµç¨‹åˆ†æ_surfaceflinger::commit-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-processdisplaychangeslocked"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"SurfaceFlinger processDisplayChangesLocked è°ƒç”¨SurfaceFlingerçš„processDisplayChangesLockedæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::processDisplayChangesLocked() { // here we take advantage of Vector's copy-on-write semantics to // improve performance by skipping the transaction entirely when // know that the lists are identical const KeyedVector","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger commit(æäº¤)æµç¨‹åˆ†æ_surfaceflinger::commit-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-processdisplayremoved"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"SurfaceFlinger processDisplayChangesLocked è°ƒç”¨SurfaceFlingerçš„processDisplayChangesLockedæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::processDisplayChangesLocked() { // here we take advantage of Vector's copy-on-write semantics to // improve performance by skipping the transaction entirely when // know that the lists are identical const KeyedVector","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger commit(æäº¤)æµç¨‹åˆ†æ_surfaceflinger::commit-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-processdisplaychanged"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"SurfaceFlinger processDisplayChangesLocked è°ƒç”¨SurfaceFlingerçš„processDisplayChangesLockedæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::processDisplayChangesLocked() { // here we take advantage of Vector's copy-on-write semantics to // improve performance by skipping the transaction entirely when // know that the lists are identical const KeyedVector","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger commit(æäº¤)æµç¨‹åˆ†æ_surfaceflinger::commit-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-processdisplayadded"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"SurfaceFlinger doCommitTransactions è°ƒç”¨SurfaceFlingerçš„doCommitTransactionsæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::doCommitTransactions() { ATRACE_CALL(); if (!mLayersPendingRemoval.isEmpty()) { // Notify removed layers now that they can't be drawn from for (const auto\u0026 l : mLayersPendingRemoval) { // Ensure any buffers set to display on any children are released. if (l-\u003eisRemovedFromCurrentState()) { l-\u003elatchAndReleaseBuffer(); } // If a layer has a parent, we allow it to out-live it's handle // with the idea that the parent holds a reference and will eventually // be cleaned up. However no one cleans up the top-level so we do so // here. if (l-\u003eisAtRoot()) { l-\u003esetIsAtRoot(false); mCurrentState.layersSortedByZ.remove(l); } // If the layer has been removed and has no parent, then it will not be reachable // when traversing layers on screen. Add the layer to the offscreenLayers set to // ensure we can copy its current to drawing state. if (!l-\u003egetParent()) { mOffscreenLayers.emplace(l.get()); } } mLayersPendingRemoval.clear(); } // If this transaction is part of a window animation then the next frame // we composite should be considered an animation as well. //æœ€å…³é”®mCurrentStateèµ‹å€¼ç»™äº†mDrawingState mAnimCompositionPending = mAnimTransactionPending; mDrawingState = mCurrentState; // clear the \"changed\" flags in current state mCurrentState.colorMatrixChanged = false; if (mVisibleRegionsDirty) { for (const auto\u0026 rootLayer : mDrawingState.layersSortedByZ) { rootLayer-\u003ecommitChildList(); } } commitOffscreenLayers(); if (mNumClones \u003e 0) { mDrawingState.traverse([\u0026](Layer* layer) { layer-\u003eupdateMirrorInfo(); }); } } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:2","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger commit(æäº¤)æµç¨‹åˆ†æ_surfaceflinger::commit-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-docommittransactions"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"SurfaceFlinger latchBuffers è°ƒç”¨SurfaceFlingerçš„latchBuffersæ–¹æ³•ï¼Œå°†åº”ç”¨ç¨‹åºçš„å›¾å½¢ç¼“å†²åŒºï¼ˆbufferï¼‰ä¸æ˜¾ç¤ºå™¨è¿›è¡Œå…³è”ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp bool SurfaceFlinger::latchBuffers() { ATRACE_CALL(); const nsecs_t latchTime = systemTime(); bool visibleRegions = false; bool frameQueued = false; bool newDataLatched = false; const nsecs_t expectedPresentTime = mExpectedPresentTime.load(); // Store the set of layers that need updates. This set must not change as // buffers are being latched, as this could result in a deadlock. // Example: Two producers share the same command stream and: // 1.) Layer 0 is latched // 2.) Layer 0 gets a new frame // 2.) Layer 1 gets a new frame // 3.) Layer 1 is latched. // Display is now waiting on Layer 1's frame, which is behind layer 0's // second frame. But layer 0's second frame could be waiting on display. mDrawingState.traverse([\u0026](Layer* layer) { if (layer-\u003eclearTransactionFlags(eTransactionNeeded) || mForceTransactionDisplayChange) { const uint32_t flags = layer-\u003edoTransaction(0); if (flags \u0026 Layer::eVisibleRegion) { mVisibleRegionsDirty = true; } } //åˆ¤æ–­æ˜¯å¦æœ‰buffer if (layer-\u003ehasReadyFrame()) { frameQueued = true; //æ˜¯å¦åº”è¯¥æ˜¾ç¤º if (layer-\u003eshouldPresentNow(expectedPresentTime)) { //å¦‚æœè¦æ˜¾ç¤ºæ”¾å…¥åˆ°mLayersWithQueuedFramesé˜Ÿåˆ— mLayersWithQueuedFrames.emplace(layer); } else { ATRACE_NAME(\"!layer-\u003eshouldPresentNow()\"); layer-\u003euseEmptyDamage(); } } else { layer-\u003euseEmptyDamage(); } }); //ä¸Šé¢ä¸»è¦æ˜¯ä¸ºäº†ä»sfçš„mDrawingStateéå†å¯»æ‰¾å‡ºæœ‰bufferçš„layer mForceTransactionDisplayChange = false; // The client can continue submitting buffers for offscreen layers, but they will not // be shown on screen. Therefore, we need to latch and release buffers of offscreen // layers to ensure dequeueBuffer doesn't block indefinitely. for (Layer* offscreenLayer : mOffscreenLayers) { offscreenLayer-\u003etraverse(LayerVector::StateSet::Drawing, [\u0026](Layer* l) { l-\u003elatchAndReleaseBuffer(); }); } //å¦‚æœbufferé˜Ÿåˆ—ä¸ä¸ºç©º if (!mLayersWithQueuedFrames.empty()) { // mStateLock is needed for latchBuffer as LayerRejecter::reject() // writes to Layer current state. See also b/119481871 Mutex::Autolock lock(mStateLock); for (const auto\u0026 layer : mLayersWithQueuedFrames) { //è¿›è¡Œå…³é”®çš„latchBufferæ“ä½œ,ç„¶ånewDataLatchedè®¾ç½®æˆäº†true if (layer-\u003elatchBuffer(visibleRegions, latchTime, expectedPresentTime)) { mLayersPendingRefresh.push_back(layer); /è¿™é‡Œæœ‰latchBufferè¯´æ˜æœ‰bufferåˆ·æ–°ï¼Œæ”¾å…¥mLayersPendingRefresh newDataLatched = true; } layer-\u003euseSurfaceDamage(); } } mVisibleRegionsDirty |= visibleRegions; // If we will need to wake up at some time in the future to deal with a // queued frame that shouldn't be displayed during this vsync period, wake // up during the next vsync period to check again. if (frameQueued \u0026\u0026 (mLayersWithQueuedFrames.empty() || !newDataLatched)) { scheduleCommit(FrameHint::kNone); } // enter boot animation on first buffer latch if (CC_UNLIKELY(mBootStage == BootStage::BOOTLOADER \u0026\u0026 newDataLatched)) { ALOGI(\"Enter boot animation\"); mBootStage = BootStage::BOOTANIMATION; } if (mNumClones \u003e 0) { mDrawingState.traverse([\u0026](Layer* layer) { layer-\u003eupdateCloneBufferInfo(); }); } // Only continue with the refresh if there is actually new work to do return !mLayersWithQueuedFrames.empty() \u0026\u0026 newDataLatched; } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:4:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger commit(æäº¤)æµç¨‹åˆ†æ_surfaceflinger::commit-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-latchbuffers"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"BufferLayer latchBuffer è°ƒç”¨layerçš„latchBufferæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/BufferLayer.cpp bool BufferLayer::latchBuffer(bool\u0026 recomputeVisibleRegions, nsecs_t latchTime, nsecs_t expectedPresentTime) { ATRACE_CALL(); bool refreshRequired = latchSidebandStream(recomputeVisibleRegions); if (refreshRequired) { return refreshRequired; } // If the head buffer's acquire fence hasn't signaled yet, return and // try again later // å¦‚æœå¤´éƒ¨ç¼“å†²åŒºçš„é‡‡é›†å›´æ å°šæœªå‘å‡ºä¿¡å·ï¼Œè¯·è¿”å›å¹¶ç¨åé‡è¯• if (!fenceHasSignaled()) { ATRACE_NAME(\"!fenceHasSignaled()\"); mFlinger-\u003eonLayerUpdate(); // (692) SurfaceFlinger onLayerUpdateæµç¨‹åˆ†æ | çŸ¥è¯†ç®¡ç† - PingCode return false; } // Capture the old state of the layer for comparisons later const State\u0026 s(getDrawingState()); const bool oldOpacity = isOpaque(s); BufferInfo oldBufferInfo = mBufferInfo; //è°ƒç”¨åˆ°BufferStateLayerä¸­çš„updateTexImageï¼Œè¿™é‡Œä¸šåŠ¡ä¸»è¦è¿”å›å¯¹åº”çš„recomputeVisibleRegions status_t err = updateTexImage(recomputeVisibleRegions, latchTime, expectedPresentTime); if (err != NO_ERROR) { return false; } //è¿™é‡Œä¸»è¦å§stateçš„ç›¸å…³bufferæ•°æ®èµ‹å€¼ç»™mBufferInfo err = updateActiveBuffer(); if (err != NO_ERROR) { return false; } //èµ‹å€¼ä¸€ä¸‹framenumber err = updateFrameNumber(); if (err != NO_ERROR) { return false; } //è¿™é‡Œåˆä¸€æ¬¡å§mDrawingStateä¸­BufferInfoéœ€è¦çš„å¤§éƒ¨åˆ†æ•°æ®è¿›è¡Œèµ‹å€¼ gatherBufferInfo(); if (oldBufferInfo.mBuffer == nullptr) { // the first time we receive a buffer, we need to trigger a // geometry invalidation. recomputeVisibleRegions = true; } if ((mBufferInfo.mCrop != oldBufferInfo.mCrop) || (mBufferInfo.mTransform != oldBufferInfo.mTransform) || (mBufferInfo.mScaleMode != oldBufferInfo.mScaleMode) || (mBufferInfo.mTransformToDisplayInverse != oldBufferInfo.mTransformToDisplayInverse)) { recomputeVisibleRegions = true; } if (oldBufferInfo.mBuffer != nullptr) { uint32_t bufWidth = mBufferInfo.mBuffer-\u003egetWidth(); uint32_t bufHeight = mBufferInfo.mBuffer-\u003egetHeight(); if (bufWidth != oldBufferInfo.mBuffer-\u003egetWidth() || bufHeight != oldBufferInfo.mBuffer-\u003egetHeight()) { recomputeVisibleRegions = true; } } if (oldOpacity != isOpaque(s)) { recomputeVisibleRegions = true; } return true; } BufferQueueLayer updateTexImage è°ƒç”¨BufferLayerçš„updateTexImageæ–¹æ³•ï¼ŒBufferQueueLayerç»§æ‰¿ä¸äºBufferLayerï¼Œè°ƒç”¨BufferQueueLayerçš„updateTexImageæ–¹æ³•ï¼š Android13 BufferQueueLayer updateTexImageæµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:4:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger commit(æäº¤)æµç¨‹åˆ†æ_surfaceflinger::commit-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#bufferlayer-latchbuffer"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"BufferLayer latchBuffer è°ƒç”¨layerçš„latchBufferæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/BufferLayer.cpp bool BufferLayer::latchBuffer(bool\u0026 recomputeVisibleRegions, nsecs_t latchTime, nsecs_t expectedPresentTime) { ATRACE_CALL(); bool refreshRequired = latchSidebandStream(recomputeVisibleRegions); if (refreshRequired) { return refreshRequired; } // If the head buffer's acquire fence hasn't signaled yet, return and // try again later // å¦‚æœå¤´éƒ¨ç¼“å†²åŒºçš„é‡‡é›†å›´æ å°šæœªå‘å‡ºä¿¡å·ï¼Œè¯·è¿”å›å¹¶ç¨åé‡è¯• if (!fenceHasSignaled()) { ATRACE_NAME(\"!fenceHasSignaled()\"); mFlinger-\u003eonLayerUpdate(); // (692) SurfaceFlinger onLayerUpdateæµç¨‹åˆ†æ | çŸ¥è¯†ç®¡ç† - PingCode return false; } // Capture the old state of the layer for comparisons later const State\u0026 s(getDrawingState()); const bool oldOpacity = isOpaque(s); BufferInfo oldBufferInfo = mBufferInfo; //è°ƒç”¨åˆ°BufferStateLayerä¸­çš„updateTexImageï¼Œè¿™é‡Œä¸šåŠ¡ä¸»è¦è¿”å›å¯¹åº”çš„recomputeVisibleRegions status_t err = updateTexImage(recomputeVisibleRegions, latchTime, expectedPresentTime); if (err != NO_ERROR) { return false; } //è¿™é‡Œä¸»è¦å§stateçš„ç›¸å…³bufferæ•°æ®èµ‹å€¼ç»™mBufferInfo err = updateActiveBuffer(); if (err != NO_ERROR) { return false; } //èµ‹å€¼ä¸€ä¸‹framenumber err = updateFrameNumber(); if (err != NO_ERROR) { return false; } //è¿™é‡Œåˆä¸€æ¬¡å§mDrawingStateä¸­BufferInfoéœ€è¦çš„å¤§éƒ¨åˆ†æ•°æ®è¿›è¡Œèµ‹å€¼ gatherBufferInfo(); if (oldBufferInfo.mBuffer == nullptr) { // the first time we receive a buffer, we need to trigger a // geometry invalidation. recomputeVisibleRegions = true; } if ((mBufferInfo.mCrop != oldBufferInfo.mCrop) || (mBufferInfo.mTransform != oldBufferInfo.mTransform) || (mBufferInfo.mScaleMode != oldBufferInfo.mScaleMode) || (mBufferInfo.mTransformToDisplayInverse != oldBufferInfo.mTransformToDisplayInverse)) { recomputeVisibleRegions = true; } if (oldBufferInfo.mBuffer != nullptr) { uint32_t bufWidth = mBufferInfo.mBuffer-\u003egetWidth(); uint32_t bufHeight = mBufferInfo.mBuffer-\u003egetHeight(); if (bufWidth != oldBufferInfo.mBuffer-\u003egetWidth() || bufHeight != oldBufferInfo.mBuffer-\u003egetHeight()) { recomputeVisibleRegions = true; } } if (oldOpacity != isOpaque(s)) { recomputeVisibleRegions = true; } return true; } BufferQueueLayer updateTexImage è°ƒç”¨BufferLayerçš„updateTexImageæ–¹æ³•ï¼ŒBufferQueueLayerç»§æ‰¿ä¸äºBufferLayerï¼Œè°ƒç”¨BufferQueueLayerçš„updateTexImageæ–¹æ³•ï¼š Android13 BufferQueueLayer updateTexImageæµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:4:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger commit(æäº¤)æµç¨‹åˆ†æ_surfaceflinger::commit-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#bufferqueuelayer-updateteximage"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"SurfaceFlinger updateLayerGeometry è°ƒç”¨SurfaceFlingerçš„updateLayerGeometryæ–¹æ³•ï¼Œè¿™æ¬¡vsyncæ˜¾ç¤ºåˆ·æ–°çš„layerè¿›è¡Œè„åŒºè®¾ç½®ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::updateLayerGeometry() { ATRACE_CALL(); if (mVisibleRegionsDirty) { computeLayerBounds(); //è§¦å‘å„ä¸ªlayerè®¡ç®—å¯¹äºçš„bound } //å‰é¢æœ‰bufferçš„é›†åˆmLayersPendingRefreshè¿›è¡Œå¯¹åº”displayçš„dirtyRegionæ›´æ–° for (auto\u0026 layer : mLayersPendingRefresh) { Region visibleReg; visibleReg.set(layer-\u003egetScreenBounds()); invalidateLayerStack(layer, visibleReg); //åˆ·æ–°ä¸€ä¸‹displayçš„dirtyRegion } mLayersPendingRefresh.clear(); } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:5:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger commit(æäº¤)æµç¨‹åˆ†æ_surfaceflinger::commit-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-updatelayergeometry"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"SurfaceFlinger invalidateLayerStack è°ƒç”¨SurfaceFlingerçš„invalidateLayerStackæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::invalidateLayerStack(const sp\u003cconst Layer\u003e\u0026 layer, const Region\u0026 dirty) { for (const auto\u0026 [token, displayDevice] : FTL_FAKE_GUARD(mStateLock, mDisplays)) { auto display = displayDevice-\u003egetCompositionDisplay(); if (display-\u003eincludesLayer(layer-\u003egetOutputFilter())) { //å¯»æ‰¾åˆ°å¯¹åº”çš„display display-\u003eeditState().dirtyRegion.orSelf(dirty); //è®¾ç½®åˆ°äº†display-\u003eeditStateä¸­ } } } ä¸Šé¢ä¸»è¦å°±æ˜¯å¹²äº†ä¸€ä»¶äº‹ï¼Œæ ¹æ®è¿™æ¬¡æœ‰bufferçš„Layerè¿›è¡Œéå†ï¼Œåˆ·æ–°å¯¹åº”displayçš„dirtyRegionã€‚ ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:5:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger commit(æäº¤)æµç¨‹åˆ†æ_surfaceflinger::commit-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-invalidatelayerstack"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"SurfaceFlinger updateInputFlinger è°ƒç”¨SurfaceFlingerçš„updateInputFlingeræ–¹æ³•ï¼Œæ›´æ–°è¾“å…¥å¤„ç†ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::updateInputFlinger() { ATRACE_CALL(); if (!mInputFlinger) { return; } std::vector\u003cWindowInfo\u003e windowInfos; std::vector\u003cDisplayInfo\u003e displayInfos; bool updateWindowInfo = false; if (mVisibleRegionsDirty || mInputInfoChanged) { mInputInfoChanged = false; updateWindowInfo = true; //è¿›è¡Œéå†æ•´ä¸ªç³»ç»Ÿçš„layerå’Œdisplayè½¬å˜æˆwindowInfosï¼ŒdisplayInfosä¿¡æ¯ buildWindowInfos(windowInfos, displayInfos); } if (!updateWindowInfo \u0026\u0026 mInputWindowCommands.empty()) { return; } //è¿™é‡Œæ”¾å…¥å­çº¿ç¨‹è¿›è¡Œç›¸å¯¹åº”è·¨è¿›ç¨‹é€šè®¯ BackgroundExecutor::getInstance().sendCallbacks({[updateWindowInfo, windowInfos = std::move(windowInfos), displayInfos = std::move(displayInfos), inputWindowCommands = std::move(mInputWindowCommands), inputFlinger = mInputFlinger, this]() { ATRACE_NAME(\"BackgroundExecutor::updateInputFlinger\"); if (updateWindowInfo) { //è¿™é‡Œè°ƒç”¨æ˜¯mWindowInfosListenerInvokerè¿›è¡Œçš„windowInfos, displayInfosè¿›è¡Œè·¨è¿›ç¨‹ä¼ é€’ mWindowInfosListenerInvoker-\u003ewindowInfosChanged(windowInfos, displayInfos, inputWindowCommands.syncInputWindows); } else if (inputWindowCommands.syncInputWindows) { // If the caller requested to sync input windows, but there are no // changes to input windows, notify immediately. windowInfosReported(); } for (const auto\u0026 focusRequest : inputWindowCommands.focusRequests) { //ç›´æ¥è°ƒç”¨inputFlingerçš„bpbinderè·¨è¿›ç¨‹è®¾ç½®setFocusedWindow inputFlinger-\u003esetFocusedWindow(focusRequest); } }}); mInputWindowCommands.clear(); } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:6:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger commit(æäº¤)æµç¨‹åˆ†æ_surfaceflinger::commit-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-updateinputflinger"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"SurfaceFlingerçš„compositeæ–¹æ³•ï¼Œç”¨äºå°†å¤šä¸ªçª—å£çš„å›¾åƒè¿›è¡Œåˆæˆï¼Œä¸»è¦è´Ÿè´£å¯¹ç›¸å…³è¦è¿›è¡Œä¸Šå¸§çš„layerè¿›è¡Œï¼Œè¯†åˆ«æ’åºå¥½ï¼Œç„¶ååˆæˆï¼Œæœ‰hwcåˆæˆçš„ä¼šæ„å»ºå¯¹åº”OutputLayerä¼ é€’hwcï¼ŒGPUåˆæˆåˆ™ç›´æ¥åˆæˆï¼Œå†ä¼ é€’åˆ°hwcä¸­ï¼Œå®ƒä¸»è¦å®Œæˆä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š ä»é˜Ÿåˆ—ä¸­è·å–æ‰€æœ‰å¾…åˆæˆçš„ç¼“å†²åŒºã€‚ å°†è¿™äº›ç¼“å†²åŒºæŒ‰ç…§ä¸€å®šçš„é¡ºåºè¿›è¡Œåˆæˆï¼Œç”Ÿæˆæœ€ç»ˆçš„å›¾åƒã€‚ å°†åˆæˆåçš„å›¾åƒæäº¤ç»™HWCè¿›è¡Œæ˜¾ç¤ºã€‚ SurfaceFlingerçš„compositeæ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp std::unique_ptr\u003ccompositionengine::CompositionEngine\u003e mCompositionEngine; void SurfaceFlinger::composite(nsecs_t frameTime, int64_t vsyncId) FTL_FAKE_GUARD(kMainThreadContext) { ATRACE_FORMAT(\"%s %\" PRId64, __func__, vsyncId); if (mPowerHintSessionData.sessionEnabled) { mPowerHintSessionData.compositeStart = systemTime(); } compositionengine::CompositionRefreshArgs refreshArgs; const auto\u0026 displays = FTL_FAKE_GUARD(mStateLock, mDisplays); refreshArgs.outputs.reserve(displays.size()); for (const auto\u0026 [_, display] : displays) { refreshArgs.outputs.push_back(display-\u003egetCompositionDisplay()); } mDrawingState.traverseInZOrder([\u0026refreshArgs](Layer* layer) { if (auto layerFE = layer-\u003egetCompositionEngineLayerFE()) refreshArgs.layers.push_back(layerFE); }); refreshArgs.layersWithQueuedFrames.reserve(mLayersWithQueuedFrames.size()); for (auto layer : mLayersWithQueuedFrames) { if (auto layerFE = layer-\u003egetCompositionEngineLayerFE()) refreshArgs.layersWithQueuedFrames.push_back(layerFE); } refreshArgs.outputColorSetting = useColorManagement ? mDisplayColorSetting : compositionengine::OutputColorSetting::kUnmanaged; refreshArgs.colorSpaceAgnosticDataspace = mColorSpaceAgnosticDataspace; refreshArgs.forceOutputColorMode = mForceColorMode; refreshArgs.updatingOutputGeometryThisFrame = mVisibleRegionsDirty; refreshArgs.updatingGeometryThisFrame = mGeometryDirty.exchange(false) || mVisibleRegionsDirty; refreshArgs.blursAreExpensive = mBlursAreExpensive; refreshArgs.internalDisplayRotationFlags = DisplayDevice::getPrimaryDisplayRotationFlags(); if (CC_UNLIKELY(mDrawingState.colorMatrixChanged)) { refreshArgs.colorTransformMatrix = mDrawingState.colorMatrix; mDrawingState.colorMatrixChanged = false; } refreshArgs.devOptForceClientComposition = mDebugDisableHWC; if (mDebugFlashDelay != 0) { refreshArgs.devOptForceClientComposition = true; refreshArgs.devOptFlashDirtyRegionsDelay = std::chrono::milliseconds(mDebugFlashDelay); } const auto expectedPresentTime = mExpectedPresentTime.load(); const auto prevVsyncTime = mScheduler-\u003egetPreviousVsyncFrom(expectedPresentTime); const auto hwcMinWorkDuration = mVsyncConfiguration-\u003egetCurrentConfigs().hwcMinWorkDuration; refreshArgs.earliestPresentTime = prevVsyncTime - hwcMinWorkDuration; refreshArgs.previousPresentFence = mPreviousPresentFences[0].fenceTime; refreshArgs.scheduledFrameTime = mScheduler-\u003egetScheduledFrameTime(); refreshArgs.expectedPresentTime = expectedPresentTime; // Store the present time just before calling to the composition engine so we could notify // the scheduler. const auto presentTime = systemTime(); mCompositionEngine-\u003epresent(refreshArgs); if (mPowerHintSessionData.sessionEnabled) { mPowerHintSessionData.presentEnd = systemTime(); } mTimeStats-\u003erecordFrameDuration(frameTime, systemTime()); if (mScheduler-\u003eonPostComposition(presentTime)) { scheduleComposite(FrameHint::kNone); } postFrame(); postComposition(); const bool prevFrameHadClientComposition = mHadClientComposition; mHadClientComposition = mHadDeviceComposition = mReusedClientComposition = false; TimeStats::ClientCompositionRecord clientCompositionRecord; for (const auto\u0026 [_, display] : displays) { const auto\u0026 state = display-\u003egetCompositionDisplay()-\u003egetState(); mHadClientComposition |= state.usesClientComposition \u0026\u0026 !state.reusedClientComposition; mHadDeviceComposition |= state.usesDeviceComposition; mReusedClientComposition |= state.reusedClientComposition; clientCompositionRecord.predicted |= (state.strategyPrediction != CompositionStrategyPredictionState::DISABLED); clientCompositionRecord.predictionSucceeded |= (state.strategyPrediction == CompositionStrategyPredictionState::SUCCESS); } clientCompositionRecord.hadClientComp","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"CompositionEngine preComposition è°ƒç”¨CompositionEngineçš„preCompositionæ–¹æ³•ï¼Œè¿›è¡Œåˆæˆå‰é¢„å¤„ç†ï¼š //frameworks/native/services/surfaceflinger/CompositionEngine/src/CompositionEngine.cpp void CompositionEngine::preComposition(CompositionRefreshArgs\u0026 args) { ATRACE_CALL(); ALOGV(__FUNCTION__); bool needsAnotherUpdate = false; mRefreshStartTime = systemTime(SYSTEM_TIME_MONOTONIC); //éå†æ‰€æœ‰layerï¼Œè¿›è¡Œlayeré¢„åˆæˆ for (auto\u0026 layer : args.layers) { if (layer-\u003eonPreComposition(mRefreshStartTime)) { needsAnotherUpdate = true; } } mNeedsAnotherUpdate = needsAnotherUpdate; } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#compositionengine-precomposition"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"BufferLayer onPreComposition è°ƒç”¨Layerçš„onPreCompositionæ–¹æ³•ï¼ŒBufferLayerç»§æ‰¿äºLayerï¼š //frameworks/native/services/surfaceflinger/BufferLayer.cpp bool BufferLayer::onPreComposition(nsecs_t) { return hasReadyFrame(); } è°ƒç”¨BufferLayerçš„hasReadyFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/BufferLayer.cpp bool BufferLayer::hasReadyFrame() const { return hasFrameUpdate() || getSidebandStreamChanged() || getAutoRefresh(); } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#bufferlayer-onprecomposition"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output prepare è°ƒç”¨Outputçš„prepareæ–¹æ³•ï¼Œè¿›è¡Œé¢„åˆæˆï¼š /frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::prepare(const compositionengine::CompositionRefreshArgs\u0026 refreshArgs, LayerFESet\u0026 geomSnapshots) { ATRACE_CALL(); ALOGV(__FUNCTION__); rebuildLayerStacks(refreshArgs, geomSnapshots); //Outputå®é™…ä¸Šå°±æ˜¯displayï¼Œ é€šè¿‡è°ƒç”¨æ¯ä¸ªDisplayçš„rebuildLayerStacks ï¼Œå»ºç«‹display çš„ LayerStacks. } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#output-prepare"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output rebuildLayerStacks è°ƒç”¨Outputçš„rebuildLayerStacksæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::rebuildLayerStacks(const compositionengine::CompositionRefreshArgs\u0026 refreshArgs, LayerFESet\u0026 layerFESet) { ATRACE_CALL(); ALOGV(__FUNCTION__); auto\u0026 outputState = editState(); // Do nothing if this output is not enabled or there is no need to perform this update if (!outputState.isEnabled || CC_LIKELY(!refreshArgs.updatingOutputGeometryThisFrame)) { return; } // Process the layers to determine visibility and coverage compositionengine::Output::CoverageState coverage{layerFESet}; collectVisibleLayers(refreshArgs, coverage); // Compute the resulting coverage for this output, and store it for later const ui::Transform\u0026 tr = outputState.transform; Region undefinedRegion{outputState.displaySpace.getBoundsAsRect()}; undefinedRegion.subtractSelf(tr.transform(coverage.aboveOpaqueLayers)); outputState.undefinedRegion = undefinedRegion; outputState.dirtyRegion.orSelf(coverage.dirtyRegion); } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:2:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#output-rebuildlayerstacks"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output present è°ƒç”¨Outputçš„presentæ–¹æ³•ï¼Œè¿›è¡ŒLayeråˆæˆã€‚ //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::present(const compositionengine::CompositionRefreshArgs\u0026 refreshArgs) { ATRACE_CALL(); ALOGV(__FUNCTION__); updateColorProfile(refreshArgs); //æ›´æ–°é¢œè‰²é…ç½®æ–‡ä»¶ updateCompositionState(refreshArgs); //æ›´æ–°åˆæˆçŠ¶æ€ planComposition(); //è®¡åˆ’åˆæˆ writeCompositionState(refreshArgs); //å†™å…¥åˆæˆçŠ¶æ€ setColorTransform(refreshArgs); //è®¾ç½®é¢œè‰²çŸ©é˜µ beginFrame(); //å¼€å§‹å¸§ GpuCompositionResult result; const bool predictCompositionStrategy = canPredictCompositionStrategy(refreshArgs); if (predictCompositionStrategy) { result = prepareFrameAsync(refreshArgs); //å‡†å¤‡å¸§æ•°æ®ä»¥è¿›è¡Œæ˜¾ç¤º(Asyncæ–¹å¼) } else { prepareFrame(); //å‡†å¤‡å¸§æ•°æ®ä»¥è¿›è¡Œæ˜¾ç¤º } devOptRepaintFlash(refreshArgs); //å¤„ç†æ˜¾ç¤ºè¾“å‡ºè®¾å¤‡çš„å¯é€‰é‡ç»˜é—ªçƒ finishFrame(refreshArgs, std::move(result)); //å®Œæˆå¸§ postFramebuffer(); //å°†å¸§ç¼“å†²åŒºï¼ˆframebufferï¼‰çš„å†…å®¹å‘é€åˆ°æ˜¾ç¤ºè®¾å¤‡è¿›è¡Œæ˜¾ç¤º renderCachedSets(refreshArgs); //è¿›è¡Œæ¸²æŸ“ç¼“å­˜è®¾ç½® } ä¸Šé¢æ–¹æ³•ä¸»è¦å¤„ç†å¦‚ä¸‹ï¼š 1ã€è°ƒç”¨Outputçš„updateColorProfileæ–¹æ³•ï¼Œæ›´æ–°é¢œè‰²é…ç½®ã€‚ 2ã€è°ƒç”¨Outputçš„updateCompositionStateæ–¹æ³•ï¼Œæ›´æ–°åˆæˆçŠ¶æ€ã€‚ 3ã€è°ƒç”¨Outputçš„planCompositionæ–¹æ³•ï¼Œè®¡åˆ’åˆæˆã€‚ 4ã€è°ƒç”¨Outputçš„writeCompositionStateæ–¹æ³•ï¼Œå†™å…¥åˆæˆçŠ¶æ€ã€‚ 5ã€è°ƒç”¨Outputçš„setColorTransformæ–¹æ³•ï¼Œè®¾ç½®é¢œè‰²çŸ©é˜µã€‚ 6ã€è°ƒç”¨Outputçš„beginFrameæ–¹æ³•ï¼Œå¼€å§‹å¸§ã€‚ 7ã€è°ƒç”¨Outputçš„prepareFrameAsyncæ–¹æ³•ï¼Œå‡†å¤‡å¸§æ•°æ®ä»¥è¿›è¡Œæ˜¾ç¤º(Asyncæ–¹å¼)ã€‚ 8ã€è°ƒç”¨Outputçš„prepareFrameæ–¹æ³•ï¼Œå‡†å¤‡å¸§æ•°æ®ä»¥è¿›è¡Œæ˜¾ç¤ºã€‚ 9ã€è°ƒç”¨Outputçš„devOptRepaintFlashæ–¹æ³•ï¼Œå¤„ç†æ˜¾ç¤ºè¾“å‡ºè®¾å¤‡çš„å¯é€‰é‡ç»˜é—ªçƒã€‚ 10ã€è°ƒç”¨Outputçš„finishFrameæ–¹æ³•ï¼Œå®Œæˆå¸§ã€‚ 11ã€è°ƒç”¨Outputçš„postFramebufferæ–¹æ³•ï¼Œå°†å¸§ç¼“å†²åŒºï¼ˆframebufferï¼‰çš„å†…å®¹å‘é€åˆ°æ˜¾ç¤ºè®¾å¤‡è¿›è¡Œæ˜¾ç¤ºã€‚ 12ã€è°ƒç”¨Outputçš„renderCachedSetsæ–¹æ³•ï¼Œè¿›è¡Œæ¸²æŸ“ç¼“å­˜è®¾ç½®ã€‚ ä¸‹é¢åˆ†åˆ«è¿›è¡Œåˆ†æï¼š ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#output-present"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output updateColorProfile è°ƒç”¨Outputçš„updateColorProfileæ–¹æ³•ï¼Œæ›´æ–°é¢œè‰²é…ç½®ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::updateColorProfile(const compositionengine::CompositionRefreshArgs\u0026 refreshArgs) { setColorProfile(pickColorProfile(refreshArgs)); } è°ƒç”¨Outputçš„setColorProfileæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::setColorProfile(const ColorProfile\u0026 colorProfile) { ui::Dataspace targetDataspace = getDisplayColorProfile()-\u003egetTargetDataspace(colorProfile.mode, colorProfile.dataspace, colorProfile.colorSpaceAgnosticDataspace); auto\u0026 outputState = editState(); if (outputState.colorMode == colorProfile.mode \u0026\u0026 outputState.dataspace == colorProfile.dataspace \u0026\u0026 outputState.renderIntent == colorProfile.renderIntent \u0026\u0026 outputState.targetDataspace == targetDataspace) { return; } outputState.colorMode = colorProfile.mode; outputState.dataspace = colorProfile.dataspace; outputState.renderIntent = colorProfile.renderIntent; outputState.targetDataspace = targetDataspace; mRenderSurface-\u003esetBufferDataspace(colorProfile.dataspace); //è®¾ç½®ç¼“å­˜æ•°æ®ç©ºé—´ ALOGV(\"Set active color mode: %s (%d), active render intent: %s (%d)\", decodeColorMode(colorProfile.mode).c_str(), colorProfile.mode, decodeRenderIntent(colorProfile.renderIntent).c_str(), colorProfile.renderIntent); dirtyEntireOutput(); //é‡ç½®è„åŒº } ä¸Šé¢æ–¹æ³•ä¸»è¦å¤„ç†å¦‚ä¸‹ï¼š 1ã€è°ƒç”¨mRenderSurface(RenderSurface)çš„setBufferDataspaceæ–¹æ³•ï¼Œè®¾ç½®ç¼“å­˜æ•°æ®ç©ºé—´ã€‚ 2ã€è°ƒç”¨Outputçš„dirtyEntireOutputæ–¹æ³•ï¼Œé‡ç½®è„åŒºã€‚ ä¸‹é¢åˆ†åˆ«è¿›è¡Œåˆ†æï¼š RenderSurface setBufferDataspace è°ƒç”¨mRenderSurface(RenderSurface)çš„setBufferDataspaceæ–¹æ³•ï¼Œè®¾ç½®ç¼“å­˜æ•°æ®ç©ºé—´ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/RenderSurface.cpp void RenderSurface::setBufferDataspace(ui::Dataspace dataspace) { native_window_set_buffers_data_space(mNativeWindow.get(), static_cast\u003candroid_dataspace\u003e(dataspace)); } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#output-updatecolorprofile"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output updateColorProfile è°ƒç”¨Outputçš„updateColorProfileæ–¹æ³•ï¼Œæ›´æ–°é¢œè‰²é…ç½®ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::updateColorProfile(const compositionengine::CompositionRefreshArgs\u0026 refreshArgs) { setColorProfile(pickColorProfile(refreshArgs)); } è°ƒç”¨Outputçš„setColorProfileæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::setColorProfile(const ColorProfile\u0026 colorProfile) { ui::Dataspace targetDataspace = getDisplayColorProfile()-\u003egetTargetDataspace(colorProfile.mode, colorProfile.dataspace, colorProfile.colorSpaceAgnosticDataspace); auto\u0026 outputState = editState(); if (outputState.colorMode == colorProfile.mode \u0026\u0026 outputState.dataspace == colorProfile.dataspace \u0026\u0026 outputState.renderIntent == colorProfile.renderIntent \u0026\u0026 outputState.targetDataspace == targetDataspace) { return; } outputState.colorMode = colorProfile.mode; outputState.dataspace = colorProfile.dataspace; outputState.renderIntent = colorProfile.renderIntent; outputState.targetDataspace = targetDataspace; mRenderSurface-\u003esetBufferDataspace(colorProfile.dataspace); //è®¾ç½®ç¼“å­˜æ•°æ®ç©ºé—´ ALOGV(\"Set active color mode: %s (%d), active render intent: %s (%d)\", decodeColorMode(colorProfile.mode).c_str(), colorProfile.mode, decodeRenderIntent(colorProfile.renderIntent).c_str(), colorProfile.renderIntent); dirtyEntireOutput(); //é‡ç½®è„åŒº } ä¸Šé¢æ–¹æ³•ä¸»è¦å¤„ç†å¦‚ä¸‹ï¼š 1ã€è°ƒç”¨mRenderSurface(RenderSurface)çš„setBufferDataspaceæ–¹æ³•ï¼Œè®¾ç½®ç¼“å­˜æ•°æ®ç©ºé—´ã€‚ 2ã€è°ƒç”¨Outputçš„dirtyEntireOutputæ–¹æ³•ï¼Œé‡ç½®è„åŒºã€‚ ä¸‹é¢åˆ†åˆ«è¿›è¡Œåˆ†æï¼š RenderSurface setBufferDataspace è°ƒç”¨mRenderSurface(RenderSurface)çš„setBufferDataspaceæ–¹æ³•ï¼Œè®¾ç½®ç¼“å­˜æ•°æ®ç©ºé—´ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/RenderSurface.cpp void RenderSurface::setBufferDataspace(ui::Dataspace dataspace) { native_window_set_buffers_data_space(mNativeWindow.get(), static_cast(dataspace)); } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#rendersurface-setbufferdataspace"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output updateCompositionState è°ƒç”¨Outputçš„updateCompositionStateæ–¹æ³•ï¼Œæ›´æ–°åˆæˆçŠ¶æ€ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::updateCompositionState(const compositionengine::CompositionRefreshArgs\u0026 refreshArgs) { ATRACE_CALL(); ALOGV(__FUNCTION__); if (!getState().isEnabled) { return; } mLayerRequestingBackgroundBlur = findLayerRequestingBackgroundComposition(); bool forceClientComposition = mLayerRequestingBackgroundBlur != nullptr; for (auto* layer : getOutputLayersOrderedByZ()) { layer-\u003eupdateCompositionState(refreshArgs.updatingGeometryThisFrame, refreshArgs.devOptForceClientComposition || forceClientComposition, refreshArgs.internalDisplayRotationFlags); if (mLayerRequestingBackgroundBlur == layer) { forceClientComposition = false; } } } OutputLayer updateCompositionState è°ƒç”¨OutputLayerçš„updateCompositionStateæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/OutputLayer.cpp void OutputLayer::updateCompositionState( bool includeGeometry, bool forceClientComposition, ui::Transform::RotationFlags internalDisplayRotationFlags) { const auto* layerFEState = getLayerFE().getCompositionState(); if (!layerFEState) { return; } const auto\u0026 outputState = getOutput().getState(); const auto\u0026 profile = *getOutput().getDisplayColorProfile(); auto\u0026 state = editState(); if (includeGeometry) { // Clear the forceClientComposition flag before it is set for any // reason. Note that since it can be set by some checks below when // updating the geometry state, we only clear it when updating the // geometry since those conditions for forcing client composition won't // go away otherwise. state.forceClientComposition = false; state.displayFrame = calculateOutputDisplayFrame(); state.sourceCrop = calculateOutputSourceCrop(internalDisplayRotationFlags); state.bufferTransform = static_cast\u003cHwc2::Transform\u003e( calculateOutputRelativeBufferTransform(internalDisplayRotationFlags)); if ((layerFEState-\u003eisSecure \u0026\u0026 !outputState.isSecure) || (state.bufferTransform \u0026 ui::Transform::ROT_INVALID)) { state.forceClientComposition = true; } } // Determine the output dependent dataspace for this layer. If it is // colorspace agnostic, it just uses the dataspace chosen for the output to // avoid the need for color conversion. state.dataspace = layerFEState-\u003eisColorspaceAgnostic \u0026\u0026 outputState.targetDataspace != ui::Dataspace::UNKNOWN ? outputState.targetDataspace : layerFEState-\u003edataspace; // Override the dataspace transfer from 170M to sRGB if the device configuration requests this. // We do this here instead of in buffer info so that dumpsys can still report layers that are // using the 170M transfer. Also we only do this if the colorspace is not agnostic for the // layer, in case the color profile uses a 170M transfer function. if (outputState.treat170mAsSrgb \u0026\u0026 !layerFEState-\u003eisColorspaceAgnostic \u0026\u0026 (state.dataspace \u0026 HAL_DATASPACE_TRANSFER_MASK) == HAL_DATASPACE_TRANSFER_SMPTE_170M) { state.dataspace = static_cast\u003cui::Dataspace\u003e( (state.dataspace \u0026 HAL_DATASPACE_STANDARD_MASK) | (state.dataspace \u0026 HAL_DATASPACE_RANGE_MASK) | HAL_DATASPACE_TRANSFER_SRGB); } // For hdr content, treat the white point as the display brightness - HDR content should not be // boosted or dimmed. // If the layer explicitly requests to disable dimming, then don't dim either. if (isHdrDataspace(state.dataspace) || getOutput().getState().displayBrightnessNits == getOutput().getState().sdrWhitePointNits || getOutput().getState().displayBrightnessNits == 0.f || !layerFEState-\u003edimmingEnabled) { state.dimmingRatio = 1.f; state.whitePointNits = getOutput().getState().displayBrightnessNits; } else { state.dimmingRatio = std::clamp(getOutput().getState().sdrWhitePointNits / getOutput().getState().displayBrightnessNits, 0.f, 1.f); state.whitePointNits = getOutput().getState().sdrWhitePointNits; } // These are evaluated every frame as they can potentially change at any // time. if (layerFEState-\u003eforceClientComposition || !profile.isDataspaceSuppor","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:2","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#output-updatecompositionstate"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output updateCompositionState è°ƒç”¨Outputçš„updateCompositionStateæ–¹æ³•ï¼Œæ›´æ–°åˆæˆçŠ¶æ€ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::updateCompositionState(const compositionengine::CompositionRefreshArgs\u0026 refreshArgs) { ATRACE_CALL(); ALOGV(__FUNCTION__); if (!getState().isEnabled) { return; } mLayerRequestingBackgroundBlur = findLayerRequestingBackgroundComposition(); bool forceClientComposition = mLayerRequestingBackgroundBlur != nullptr; for (auto* layer : getOutputLayersOrderedByZ()) { layer-\u003eupdateCompositionState(refreshArgs.updatingGeometryThisFrame, refreshArgs.devOptForceClientComposition || forceClientComposition, refreshArgs.internalDisplayRotationFlags); if (mLayerRequestingBackgroundBlur == layer) { forceClientComposition = false; } } } OutputLayer updateCompositionState è°ƒç”¨OutputLayerçš„updateCompositionStateæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/OutputLayer.cpp void OutputLayer::updateCompositionState( bool includeGeometry, bool forceClientComposition, ui::Transform::RotationFlags internalDisplayRotationFlags) { const auto* layerFEState = getLayerFE().getCompositionState(); if (!layerFEState) { return; } const auto\u0026 outputState = getOutput().getState(); const auto\u0026 profile = *getOutput().getDisplayColorProfile(); auto\u0026 state = editState(); if (includeGeometry) { // Clear the forceClientComposition flag before it is set for any // reason. Note that since it can be set by some checks below when // updating the geometry state, we only clear it when updating the // geometry since those conditions for forcing client composition won't // go away otherwise. state.forceClientComposition = false; state.displayFrame = calculateOutputDisplayFrame(); state.sourceCrop = calculateOutputSourceCrop(internalDisplayRotationFlags); state.bufferTransform = static_cast( calculateOutputRelativeBufferTransform(internalDisplayRotationFlags)); if ((layerFEState-\u003eisSecure \u0026\u0026 !outputState.isSecure) || (state.bufferTransform \u0026 ui::Transform::ROT_INVALID)) { state.forceClientComposition = true; } } // Determine the output dependent dataspace for this layer. If it is // colorspace agnostic, it just uses the dataspace chosen for the output to // avoid the need for color conversion. state.dataspace = layerFEState-\u003eisColorspaceAgnostic \u0026\u0026 outputState.targetDataspace != ui::Dataspace::UNKNOWN ? outputState.targetDataspace : layerFEState-\u003edataspace; // Override the dataspace transfer from 170M to sRGB if the device configuration requests this. // We do this here instead of in buffer info so that dumpsys can still report layers that are // using the 170M transfer. Also we only do this if the colorspace is not agnostic for the // layer, in case the color profile uses a 170M transfer function. if (outputState.treat170mAsSrgb \u0026\u0026 !layerFEState-\u003eisColorspaceAgnostic \u0026\u0026 (state.dataspace \u0026 HAL_DATASPACE_TRANSFER_MASK) == HAL_DATASPACE_TRANSFER_SMPTE_170M) { state.dataspace = static_cast( (state.dataspace \u0026 HAL_DATASPACE_STANDARD_MASK) | (state.dataspace \u0026 HAL_DATASPACE_RANGE_MASK) | HAL_DATASPACE_TRANSFER_SRGB); } // For hdr content, treat the white point as the display brightness - HDR content should not be // boosted or dimmed. // If the layer explicitly requests to disable dimming, then don't dim either. if (isHdrDataspace(state.dataspace) || getOutput().getState().displayBrightnessNits == getOutput().getState().sdrWhitePointNits || getOutput().getState().displayBrightnessNits == 0.f || !layerFEState-\u003edimmingEnabled) { state.dimmingRatio = 1.f; state.whitePointNits = getOutput().getState().displayBrightnessNits; } else { state.dimmingRatio = std::clamp(getOutput().getState().sdrWhitePointNits / getOutput().getState().displayBrightnessNits, 0.f, 1.f); state.whitePointNits = getOutput().getState().sdrWhitePointNits; } // These are evaluated every frame as they can potentially change at any // time. if (layerFEState-\u003eforceClientComposition || !profile.isDataspaceSuppor","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:2","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#outputlayer-updatecompositionstate"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output planComposition è°ƒç”¨Outputçš„planCompositionæ–¹æ³•ï¼Œè®¡åˆ’åˆæˆï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::planComposition() { if (!mPlanner || !getState().isEnabled) { return; } ATRACE_CALL(); ALOGV(__FUNCTION__); mPlanner-\u003eplan(getOutputLayersOrderedByZ()); } Planner plan è°ƒç”¨Plannerçš„planæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Planner.cpp void Planner::plan( compositionengine::Output::OutputLayersEnumerator\u003ccompositionengine::Output\u003e\u0026\u0026 layers) { ATRACE_CALL(); std::unordered_set\u003cLayerId\u003e removedLayers; removedLayers.reserve(mPreviousLayers.size()); std::transform(mPreviousLayers.begin(), mPreviousLayers.end(), std::inserter(removedLayers, removedLayers.begin()), [](const auto\u0026 layer) { return layer.first; }); std::vector\u003cLayerId\u003e currentLayerIds; for (auto layer : layers) { LayerId id = layer-\u003egetLayerFE().getSequence(); if (const auto layerEntry = mPreviousLayers.find(id); layerEntry != mPreviousLayers.end()) { // Track changes from previous info LayerState\u0026 state = layerEntry-\u003esecond; ftl::Flags\u003cLayerStateField\u003e differences = state.update(layer); if (differences.get() == 0) { state.incrementFramesSinceBufferUpdate(); } else { ALOGV(\"Layer %s changed: %s\", state.getName().c_str(), differences.string().c_str()); if (differences.test(LayerStateField::Buffer)) { state.resetFramesSinceBufferUpdate(); } else { state.incrementFramesSinceBufferUpdate(); } } } else { LayerState state(layer); ALOGV(\"Added layer %s\", state.getName().c_str()); mPreviousLayers.emplace(std::make_pair(id, std::move(state))); } currentLayerIds.emplace_back(id); if (const auto found = removedLayers.find(id); found != removedLayers.end()) { removedLayers.erase(found); } } mCurrentLayers.clear(); mCurrentLayers.reserve(currentLayerIds.size()); std::transform(currentLayerIds.cbegin(), currentLayerIds.cend(), std::back_inserter(mCurrentLayers), [this](LayerId id) { LayerState* state = \u0026mPreviousLayers.at(id); state-\u003egetOutputLayer()-\u003eeditState().overrideInfo = {}; return state; }); const NonBufferHash hash = getNonBufferHash(mCurrentLayers); mFlattenedHash = mFlattener.flattenLayers(mCurrentLayers, hash, std::chrono::steady_clock::now()); const bool layersWereFlattened = hash != mFlattenedHash; ALOGV(\"[%s] Initial hash %zx flattened hash %zx\", __func__, hash, mFlattenedHash); if (mPredictorEnabled) { mPredictedPlan = mPredictor.getPredictedPlan(layersWereFlattened ? std::vector\u003cconst LayerState*\u003e() : mCurrentLayers, mFlattenedHash); if (mPredictedPlan) { ALOGV(\"[%s] Predicting plan %s\", __func__, to_string(mPredictedPlan-\u003eplan).c_str()); } else { ALOGV(\"[%s] No prediction found\\n\", __func__); } } // Clean up the set of previous layers now that the view of the LayerStates in the flattener are // up-to-date. for (LayerId removedLayer : removedLayers) { if (const auto layerEntry = mPreviousLayers.find(removedLayer); layerEntry != mPreviousLayers.end()) { const auto\u0026 [id, state] = *layerEntry; ALOGV(\"Removed layer %s\", state.getName().c_str()); mPreviousLayers.erase(removedLayer); } } } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:3","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#output-plancomposition"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output planComposition è°ƒç”¨Outputçš„planCompositionæ–¹æ³•ï¼Œè®¡åˆ’åˆæˆï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::planComposition() { if (!mPlanner || !getState().isEnabled) { return; } ATRACE_CALL(); ALOGV(__FUNCTION__); mPlanner-\u003eplan(getOutputLayersOrderedByZ()); } Planner plan è°ƒç”¨Plannerçš„planæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Planner.cpp void Planner::plan( compositionengine::Output::OutputLayersEnumerator\u0026\u0026 layers) { ATRACE_CALL(); std::unordered_set removedLayers; removedLayers.reserve(mPreviousLayers.size()); std::transform(mPreviousLayers.begin(), mPreviousLayers.end(), std::inserter(removedLayers, removedLayers.begin()), [](const auto\u0026 layer) { return layer.first; }); std::vector currentLayerIds; for (auto layer : layers) { LayerId id = layer-\u003egetLayerFE().getSequence(); if (const auto layerEntry = mPreviousLayers.find(id); layerEntry != mPreviousLayers.end()) { // Track changes from previous info LayerState\u0026 state = layerEntry-\u003esecond; ftl::Flags differences = state.update(layer); if (differences.get() == 0) { state.incrementFramesSinceBufferUpdate(); } else { ALOGV(\"Layer %s changed: %s\", state.getName().c_str(), differences.string().c_str()); if (differences.test(LayerStateField::Buffer)) { state.resetFramesSinceBufferUpdate(); } else { state.incrementFramesSinceBufferUpdate(); } } } else { LayerState state(layer); ALOGV(\"Added layer %s\", state.getName().c_str()); mPreviousLayers.emplace(std::make_pair(id, std::move(state))); } currentLayerIds.emplace_back(id); if (const auto found = removedLayers.find(id); found != removedLayers.end()) { removedLayers.erase(found); } } mCurrentLayers.clear(); mCurrentLayers.reserve(currentLayerIds.size()); std::transform(currentLayerIds.cbegin(), currentLayerIds.cend(), std::back_inserter(mCurrentLayers), [this](LayerId id) { LayerState* state = \u0026mPreviousLayers.at(id); state-\u003egetOutputLayer()-\u003eeditState().overrideInfo = {}; return state; }); const NonBufferHash hash = getNonBufferHash(mCurrentLayers); mFlattenedHash = mFlattener.flattenLayers(mCurrentLayers, hash, std::chrono::steady_clock::now()); const bool layersWereFlattened = hash != mFlattenedHash; ALOGV(\"[%s] Initial hash %zx flattened hash %zx\", __func__, hash, mFlattenedHash); if (mPredictorEnabled) { mPredictedPlan = mPredictor.getPredictedPlan(layersWereFlattened ? std::vector() : mCurrentLayers, mFlattenedHash); if (mPredictedPlan) { ALOGV(\"[%s] Predicting plan %s\", __func__, to_string(mPredictedPlan-\u003eplan).c_str()); } else { ALOGV(\"[%s] No prediction found\\n\", __func__); } } // Clean up the set of previous layers now that the view of the LayerStates in the flattener are // up-to-date. for (LayerId removedLayer : removedLayers) { if (const auto layerEntry = mPreviousLayers.find(removedLayer); layerEntry != mPreviousLayers.end()) { const auto\u0026 [id, state] = *layerEntry; ALOGV(\"Removed layer %s\", state.getName().c_str()); mPreviousLayers.erase(removedLayer); } } } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:3","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#planner-plan"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output writeCompositionState è°ƒç”¨Outputçš„writeCompositionStateæ–¹æ³•ï¼Œå†™å…¥åˆæˆçŠ¶æ€ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::writeCompositionState(const compositionengine::CompositionRefreshArgs\u0026 refreshArgs) { ATRACE_CALL(); ALOGV(__FUNCTION__); if (!getState().isEnabled) { return; } editState().earliestPresentTime = refreshArgs.earliestPresentTime; editState().previousPresentFence = refreshArgs.previousPresentFence; editState().expectedPresentTime = refreshArgs.expectedPresentTime; compositionengine::OutputLayer* peekThroughLayer = nullptr; sp\u003cGraphicBuffer\u003e previousOverride = nullptr; bool includeGeometry = refreshArgs.updatingGeometryThisFrame; uint32_t z = 0; bool overrideZ = false; uint64_t outputLayerHash = 0; for (auto* layer : getOutputLayersOrderedByZ()) { if (layer == peekThroughLayer) { // No longer needed, although it should not show up again, so // resetting it is not truly needed either. peekThroughLayer = nullptr; // peekThroughLayer was already drawn ahead of its z order. continue; } bool skipLayer = false; const auto\u0026 overrideInfo = layer-\u003egetState().overrideInfo; if (overrideInfo.buffer != nullptr) { if (previousOverride \u0026\u0026 overrideInfo.buffer-\u003egetBuffer() == previousOverride) { ALOGV(\"Skipping redundant buffer\"); skipLayer = true; } else { // First layer with the override buffer. if (overrideInfo.peekThroughLayer) { peekThroughLayer = overrideInfo.peekThroughLayer; // Draw peekThroughLayer first. overrideZ = true; includeGeometry = true; constexpr bool isPeekingThrough = true; peekThroughLayer-\u003ewriteStateToHWC(includeGeometry, false, z++, overrideZ, isPeekingThrough); outputLayerHash ^= android::hashCombine( reinterpret_cast\u003cuint64_t\u003e(\u0026peekThroughLayer-\u003egetLayerFE()), z, includeGeometry, overrideZ, isPeekingThrough, peekThroughLayer-\u003erequiresClientComposition()); } previousOverride = overrideInfo.buffer-\u003egetBuffer(); } } constexpr bool isPeekingThrough = false; layer-\u003ewriteStateToHWC(includeGeometry, skipLayer, z++, overrideZ, isPeekingThrough); if (!skipLayer) { outputLayerHash ^= android::hashCombine( reinterpret_cast\u003cuint64_t\u003e(\u0026layer-\u003egetLayerFE()), z, includeGeometry, overrideZ, isPeekingThrough, layer-\u003erequiresClientComposition()); } } editState().outputLayerHash = outputLayerHash; } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:4","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#output-writecompositionstate"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output setColorTransform è°ƒç”¨Outputçš„setColorTransformæ–¹æ³•ï¼Œè®¾ç½®é¢œè‰²çŸ©é˜µï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::setColorTransform(const compositionengine::CompositionRefreshArgs\u0026 args) { auto\u0026 colorTransformMatrix = editState().colorTransformMatrix; if (!args.colorTransformMatrix || colorTransformMatrix == args.colorTransformMatrix) { return; } colorTransformMatrix = *args.colorTransformMatrix; dirtyEntireOutput(); } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:5","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#output-setcolortransform"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output beginFrame è°ƒç”¨Outputçš„beginFrameæ–¹æ³•ï¼Œå¼€å§‹å¸§ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::beginFrame() { auto\u0026 outputState = editState(); const bool dirty = !getDirtyRegion().isEmpty(); const bool empty = getOutputLayerCount() == 0; const bool wasEmpty = !outputState.lastCompositionHadVisibleLayers; // If nothing has changed (!dirty), don't recompose. // If something changed, but we don't currently have any visible layers, // and didn't when we last did a composition, then skip it this time. // The second rule does two things: // - When all layers are removed from a display, we'll emit one black // frame, then nothing more until we get new layers. // - When a display is created with a private layer stack, we won't // emit any black frames until a layer is added to the layer stack. const bool mustRecompose = dirty \u0026\u0026 !(empty \u0026\u0026 wasEmpty); const char flagPrefix[] = {'-', '+'}; static_cast\u003cvoid\u003e(flagPrefix); ALOGV_IF(\"%s: %s composition for %s (%cdirty %cempty %cwasEmpty)\", __FUNCTION__, mustRecompose ? \"doing\" : \"skipping\", getName().c_str(), flagPrefix[dirty], flagPrefix[empty], flagPrefix[wasEmpty]); mRenderSurface-\u003ebeginFrame(mustRecompose); if (mustRecompose) { outputState.lastCompositionHadVisibleLayers = !empty; } } RenderSurface beginFrame è°ƒç”¨mRenderSurface(RenderSurface)çš„beginFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/RenderSurface.cpp const sp\u003cDisplaySurface\u003e mDisplaySurface; status_t RenderSurface::beginFrame(bool mustRecompose) { return mDisplaySurface-\u003ebeginFrame(mustRecompose); } è°ƒç”¨mDisplaySurface(DisplaySurface)çš„beginFrameæ–¹æ³•ï¼ŒFramebufferSurfaceç»§æ‰¿DisplaySurfaceï¼Œè°ƒç”¨FramebufferSurfaceçš„beginFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/FramebufferSurface.cpp status_t FramebufferSurface::beginFrame(bool /*mustRecompose*/) { return NO_ERROR; } VirtualDisplaySurface beginFrame è°ƒç”¨mDisplaySurface(DisplaySurface)çš„beginFrameæ–¹æ³•ï¼ŒVirtualDisplaySurfaceç»§æ‰¿DisplaySurfaceï¼Œè°ƒç”¨VirtualDisplaySurfaceçš„beginFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/VirtualDisplaySurface.cpp status_t VirtualDisplaySurface::beginFrame(bool mustRecompose) { if (GpuVirtualDisplayId::tryCast(mDisplayId)) { return NO_ERROR; } mMustRecompose = mustRecompose; VDS_LOGW_IF(mDebugState != DebugState::Idle, \"Unexpected %s in %s state\", __func__, ftl::enum_string(mDebugState).c_str()); mDebugState = DebugState::Begun; return refreshOutputBuffer(); } è°ƒç”¨VirtualDisplaySurfaceçš„refreshOutputBufferæ–¹æ³•ï¼Œåˆ·æ–°è¾“å‡ºç¼“å†²åŒºï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/VirtualDisplaySurface.cpp HWComposer\u0026 mHwc; status_t VirtualDisplaySurface::refreshOutputBuffer() { LOG_ALWAYS_FATAL_IF(GpuVirtualDisplayId::tryCast(mDisplayId).has_value()); if (mOutputProducerSlot \u003e= 0) { mSource[SOURCE_SINK]-\u003ecancelBuffer( mapProducer2SourceSlot(SOURCE_SINK, mOutputProducerSlot), mOutputFence); } int sslot; status_t result = dequeueBuffer(SOURCE_SINK, mOutputFormat, mOutputUsage, \u0026sslot, \u0026mOutputFence); if (result \u003c 0) return result; mOutputProducerSlot = mapSource2ProducerSlot(SOURCE_SINK, sslot); // On GPU-only frames, we don't have the right output buffer acquire fence // until after GPU calls queueBuffer(). So here we just set the buffer // (for use in HWC prepare) but not the fence; we'll call this again with // the proper fence once we have it. const auto halDisplayId = HalVirtualDisplayId::tryCast(mDisplayId); LOG_FATAL_IF(!halDisplayId); result = mHwc.setOutputBuffer(*halDisplayId, Fence::NO_FENCE, mProducerBuffers[mOutputProducerSlot]); return result; } HWComposer setOutputBuffer è°ƒç”¨mHwc(HWComposer)çš„setOutputBufferæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/HWComposer.cpp std::unordered_map\u003cHalDisplayId, DisplayData\u003e mDisplayData; std::unique_ptr\u003cHWC2::Display\u003e hwcDisplay; status_t HWComposer::setOutputBuffer(HalVirtualDisplayId displayId, const sp\u003cFence\u003e\u0026 acquireFence, const sp\u003cGraphicBuffer\u003e\u0026 buffer) { RETURN_IF_INVALID_DISPLAY(displayId, BAD_","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:6","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#output-beginframe"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output beginFrame è°ƒç”¨Outputçš„beginFrameæ–¹æ³•ï¼Œå¼€å§‹å¸§ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::beginFrame() { auto\u0026 outputState = editState(); const bool dirty = !getDirtyRegion().isEmpty(); const bool empty = getOutputLayerCount() == 0; const bool wasEmpty = !outputState.lastCompositionHadVisibleLayers; // If nothing has changed (!dirty), don't recompose. // If something changed, but we don't currently have any visible layers, // and didn't when we last did a composition, then skip it this time. // The second rule does two things: // - When all layers are removed from a display, we'll emit one black // frame, then nothing more until we get new layers. // - When a display is created with a private layer stack, we won't // emit any black frames until a layer is added to the layer stack. const bool mustRecompose = dirty \u0026\u0026 !(empty \u0026\u0026 wasEmpty); const char flagPrefix[] = {'-', '+'}; static_cast(flagPrefix); ALOGV_IF(\"%s: %s composition for %s (%cdirty %cempty %cwasEmpty)\", __FUNCTION__, mustRecompose ? \"doing\" : \"skipping\", getName().c_str(), flagPrefix[dirty], flagPrefix[empty], flagPrefix[wasEmpty]); mRenderSurface-\u003ebeginFrame(mustRecompose); if (mustRecompose) { outputState.lastCompositionHadVisibleLayers = !empty; } } RenderSurface beginFrame è°ƒç”¨mRenderSurface(RenderSurface)çš„beginFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/RenderSurface.cpp const sp mDisplaySurface; status_t RenderSurface::beginFrame(bool mustRecompose) { return mDisplaySurface-\u003ebeginFrame(mustRecompose); } è°ƒç”¨mDisplaySurface(DisplaySurface)çš„beginFrameæ–¹æ³•ï¼ŒFramebufferSurfaceç»§æ‰¿DisplaySurfaceï¼Œè°ƒç”¨FramebufferSurfaceçš„beginFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/FramebufferSurface.cpp status_t FramebufferSurface::beginFrame(bool /*mustRecompose*/) { return NO_ERROR; } VirtualDisplaySurface beginFrame è°ƒç”¨mDisplaySurface(DisplaySurface)çš„beginFrameæ–¹æ³•ï¼ŒVirtualDisplaySurfaceç»§æ‰¿DisplaySurfaceï¼Œè°ƒç”¨VirtualDisplaySurfaceçš„beginFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/VirtualDisplaySurface.cpp status_t VirtualDisplaySurface::beginFrame(bool mustRecompose) { if (GpuVirtualDisplayId::tryCast(mDisplayId)) { return NO_ERROR; } mMustRecompose = mustRecompose; VDS_LOGW_IF(mDebugState != DebugState::Idle, \"Unexpected %s in %s state\", __func__, ftl::enum_string(mDebugState).c_str()); mDebugState = DebugState::Begun; return refreshOutputBuffer(); } è°ƒç”¨VirtualDisplaySurfaceçš„refreshOutputBufferæ–¹æ³•ï¼Œåˆ·æ–°è¾“å‡ºç¼“å†²åŒºï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/VirtualDisplaySurface.cpp HWComposer\u0026 mHwc; status_t VirtualDisplaySurface::refreshOutputBuffer() { LOG_ALWAYS_FATAL_IF(GpuVirtualDisplayId::tryCast(mDisplayId).has_value()); if (mOutputProducerSlot \u003e= 0) { mSource[SOURCE_SINK]-\u003ecancelBuffer( mapProducer2SourceSlot(SOURCE_SINK, mOutputProducerSlot), mOutputFence); } int sslot; status_t result = dequeueBuffer(SOURCE_SINK, mOutputFormat, mOutputUsage, \u0026sslot, \u0026mOutputFence); if (result \u003c 0) return result; mOutputProducerSlot = mapSource2ProducerSlot(SOURCE_SINK, sslot); // On GPU-only frames, we don't have the right output buffer acquire fence // until after GPU calls queueBuffer(). So here we just set the buffer // (for use in HWC prepare) but not the fence; we'll call this again with // the proper fence once we have it. const auto halDisplayId = HalVirtualDisplayId::tryCast(mDisplayId); LOG_FATAL_IF(!halDisplayId); result = mHwc.setOutputBuffer(*halDisplayId, Fence::NO_FENCE, mProducerBuffers[mOutputProducerSlot]); return result; } HWComposer setOutputBuffer è°ƒç”¨mHwc(HWComposer)çš„setOutputBufferæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/HWComposer.cpp std::unordered_map mDisplayData; std::unique_ptr hwcDisplay; status_t HWComposer::setOutputBuffer(HalVirtualDisplayId displayId, const sp\u0026 acquireFence, const sp\u0026 buffer) { RETURN_IF_INVALID_DISPLAY(displayId, BAD_","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:6","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#rendersurface-beginframe"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output beginFrame è°ƒç”¨Outputçš„beginFrameæ–¹æ³•ï¼Œå¼€å§‹å¸§ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::beginFrame() { auto\u0026 outputState = editState(); const bool dirty = !getDirtyRegion().isEmpty(); const bool empty = getOutputLayerCount() == 0; const bool wasEmpty = !outputState.lastCompositionHadVisibleLayers; // If nothing has changed (!dirty), don't recompose. // If something changed, but we don't currently have any visible layers, // and didn't when we last did a composition, then skip it this time. // The second rule does two things: // - When all layers are removed from a display, we'll emit one black // frame, then nothing more until we get new layers. // - When a display is created with a private layer stack, we won't // emit any black frames until a layer is added to the layer stack. const bool mustRecompose = dirty \u0026\u0026 !(empty \u0026\u0026 wasEmpty); const char flagPrefix[] = {'-', '+'}; static_cast(flagPrefix); ALOGV_IF(\"%s: %s composition for %s (%cdirty %cempty %cwasEmpty)\", __FUNCTION__, mustRecompose ? \"doing\" : \"skipping\", getName().c_str(), flagPrefix[dirty], flagPrefix[empty], flagPrefix[wasEmpty]); mRenderSurface-\u003ebeginFrame(mustRecompose); if (mustRecompose) { outputState.lastCompositionHadVisibleLayers = !empty; } } RenderSurface beginFrame è°ƒç”¨mRenderSurface(RenderSurface)çš„beginFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/RenderSurface.cpp const sp mDisplaySurface; status_t RenderSurface::beginFrame(bool mustRecompose) { return mDisplaySurface-\u003ebeginFrame(mustRecompose); } è°ƒç”¨mDisplaySurface(DisplaySurface)çš„beginFrameæ–¹æ³•ï¼ŒFramebufferSurfaceç»§æ‰¿DisplaySurfaceï¼Œè°ƒç”¨FramebufferSurfaceçš„beginFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/FramebufferSurface.cpp status_t FramebufferSurface::beginFrame(bool /*mustRecompose*/) { return NO_ERROR; } VirtualDisplaySurface beginFrame è°ƒç”¨mDisplaySurface(DisplaySurface)çš„beginFrameæ–¹æ³•ï¼ŒVirtualDisplaySurfaceç»§æ‰¿DisplaySurfaceï¼Œè°ƒç”¨VirtualDisplaySurfaceçš„beginFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/VirtualDisplaySurface.cpp status_t VirtualDisplaySurface::beginFrame(bool mustRecompose) { if (GpuVirtualDisplayId::tryCast(mDisplayId)) { return NO_ERROR; } mMustRecompose = mustRecompose; VDS_LOGW_IF(mDebugState != DebugState::Idle, \"Unexpected %s in %s state\", __func__, ftl::enum_string(mDebugState).c_str()); mDebugState = DebugState::Begun; return refreshOutputBuffer(); } è°ƒç”¨VirtualDisplaySurfaceçš„refreshOutputBufferæ–¹æ³•ï¼Œåˆ·æ–°è¾“å‡ºç¼“å†²åŒºï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/VirtualDisplaySurface.cpp HWComposer\u0026 mHwc; status_t VirtualDisplaySurface::refreshOutputBuffer() { LOG_ALWAYS_FATAL_IF(GpuVirtualDisplayId::tryCast(mDisplayId).has_value()); if (mOutputProducerSlot \u003e= 0) { mSource[SOURCE_SINK]-\u003ecancelBuffer( mapProducer2SourceSlot(SOURCE_SINK, mOutputProducerSlot), mOutputFence); } int sslot; status_t result = dequeueBuffer(SOURCE_SINK, mOutputFormat, mOutputUsage, \u0026sslot, \u0026mOutputFence); if (result \u003c 0) return result; mOutputProducerSlot = mapSource2ProducerSlot(SOURCE_SINK, sslot); // On GPU-only frames, we don't have the right output buffer acquire fence // until after GPU calls queueBuffer(). So here we just set the buffer // (for use in HWC prepare) but not the fence; we'll call this again with // the proper fence once we have it. const auto halDisplayId = HalVirtualDisplayId::tryCast(mDisplayId); LOG_FATAL_IF(!halDisplayId); result = mHwc.setOutputBuffer(*halDisplayId, Fence::NO_FENCE, mProducerBuffers[mOutputProducerSlot]); return result; } HWComposer setOutputBuffer è°ƒç”¨mHwc(HWComposer)çš„setOutputBufferæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/HWComposer.cpp std::unordered_map mDisplayData; std::unique_ptr hwcDisplay; status_t HWComposer::setOutputBuffer(HalVirtualDisplayId displayId, const sp\u0026 acquireFence, const sp\u0026 buffer) { RETURN_IF_INVALID_DISPLAY(displayId, BAD_","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:6","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#virtualdisplaysurface-beginframe"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output beginFrame è°ƒç”¨Outputçš„beginFrameæ–¹æ³•ï¼Œå¼€å§‹å¸§ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::beginFrame() { auto\u0026 outputState = editState(); const bool dirty = !getDirtyRegion().isEmpty(); const bool empty = getOutputLayerCount() == 0; const bool wasEmpty = !outputState.lastCompositionHadVisibleLayers; // If nothing has changed (!dirty), don't recompose. // If something changed, but we don't currently have any visible layers, // and didn't when we last did a composition, then skip it this time. // The second rule does two things: // - When all layers are removed from a display, we'll emit one black // frame, then nothing more until we get new layers. // - When a display is created with a private layer stack, we won't // emit any black frames until a layer is added to the layer stack. const bool mustRecompose = dirty \u0026\u0026 !(empty \u0026\u0026 wasEmpty); const char flagPrefix[] = {'-', '+'}; static_cast(flagPrefix); ALOGV_IF(\"%s: %s composition for %s (%cdirty %cempty %cwasEmpty)\", __FUNCTION__, mustRecompose ? \"doing\" : \"skipping\", getName().c_str(), flagPrefix[dirty], flagPrefix[empty], flagPrefix[wasEmpty]); mRenderSurface-\u003ebeginFrame(mustRecompose); if (mustRecompose) { outputState.lastCompositionHadVisibleLayers = !empty; } } RenderSurface beginFrame è°ƒç”¨mRenderSurface(RenderSurface)çš„beginFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/RenderSurface.cpp const sp mDisplaySurface; status_t RenderSurface::beginFrame(bool mustRecompose) { return mDisplaySurface-\u003ebeginFrame(mustRecompose); } è°ƒç”¨mDisplaySurface(DisplaySurface)çš„beginFrameæ–¹æ³•ï¼ŒFramebufferSurfaceç»§æ‰¿DisplaySurfaceï¼Œè°ƒç”¨FramebufferSurfaceçš„beginFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/FramebufferSurface.cpp status_t FramebufferSurface::beginFrame(bool /*mustRecompose*/) { return NO_ERROR; } VirtualDisplaySurface beginFrame è°ƒç”¨mDisplaySurface(DisplaySurface)çš„beginFrameæ–¹æ³•ï¼ŒVirtualDisplaySurfaceç»§æ‰¿DisplaySurfaceï¼Œè°ƒç”¨VirtualDisplaySurfaceçš„beginFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/VirtualDisplaySurface.cpp status_t VirtualDisplaySurface::beginFrame(bool mustRecompose) { if (GpuVirtualDisplayId::tryCast(mDisplayId)) { return NO_ERROR; } mMustRecompose = mustRecompose; VDS_LOGW_IF(mDebugState != DebugState::Idle, \"Unexpected %s in %s state\", __func__, ftl::enum_string(mDebugState).c_str()); mDebugState = DebugState::Begun; return refreshOutputBuffer(); } è°ƒç”¨VirtualDisplaySurfaceçš„refreshOutputBufferæ–¹æ³•ï¼Œåˆ·æ–°è¾“å‡ºç¼“å†²åŒºï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/VirtualDisplaySurface.cpp HWComposer\u0026 mHwc; status_t VirtualDisplaySurface::refreshOutputBuffer() { LOG_ALWAYS_FATAL_IF(GpuVirtualDisplayId::tryCast(mDisplayId).has_value()); if (mOutputProducerSlot \u003e= 0) { mSource[SOURCE_SINK]-\u003ecancelBuffer( mapProducer2SourceSlot(SOURCE_SINK, mOutputProducerSlot), mOutputFence); } int sslot; status_t result = dequeueBuffer(SOURCE_SINK, mOutputFormat, mOutputUsage, \u0026sslot, \u0026mOutputFence); if (result \u003c 0) return result; mOutputProducerSlot = mapSource2ProducerSlot(SOURCE_SINK, sslot); // On GPU-only frames, we don't have the right output buffer acquire fence // until after GPU calls queueBuffer(). So here we just set the buffer // (for use in HWC prepare) but not the fence; we'll call this again with // the proper fence once we have it. const auto halDisplayId = HalVirtualDisplayId::tryCast(mDisplayId); LOG_FATAL_IF(!halDisplayId); result = mHwc.setOutputBuffer(*halDisplayId, Fence::NO_FENCE, mProducerBuffers[mOutputProducerSlot]); return result; } HWComposer setOutputBuffer è°ƒç”¨mHwc(HWComposer)çš„setOutputBufferæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/HWComposer.cpp std::unordered_map mDisplayData; std::unique_ptr hwcDisplay; status_t HWComposer::setOutputBuffer(HalVirtualDisplayId displayId, const sp\u0026 acquireFence, const sp\u0026 buffer) { RETURN_IF_INVALID_DISPLAY(displayId, BAD_","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:6","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#hwcomposer-setoutputbuffer"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output beginFrame è°ƒç”¨Outputçš„beginFrameæ–¹æ³•ï¼Œå¼€å§‹å¸§ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::beginFrame() { auto\u0026 outputState = editState(); const bool dirty = !getDirtyRegion().isEmpty(); const bool empty = getOutputLayerCount() == 0; const bool wasEmpty = !outputState.lastCompositionHadVisibleLayers; // If nothing has changed (!dirty), don't recompose. // If something changed, but we don't currently have any visible layers, // and didn't when we last did a composition, then skip it this time. // The second rule does two things: // - When all layers are removed from a display, we'll emit one black // frame, then nothing more until we get new layers. // - When a display is created with a private layer stack, we won't // emit any black frames until a layer is added to the layer stack. const bool mustRecompose = dirty \u0026\u0026 !(empty \u0026\u0026 wasEmpty); const char flagPrefix[] = {'-', '+'}; static_cast(flagPrefix); ALOGV_IF(\"%s: %s composition for %s (%cdirty %cempty %cwasEmpty)\", __FUNCTION__, mustRecompose ? \"doing\" : \"skipping\", getName().c_str(), flagPrefix[dirty], flagPrefix[empty], flagPrefix[wasEmpty]); mRenderSurface-\u003ebeginFrame(mustRecompose); if (mustRecompose) { outputState.lastCompositionHadVisibleLayers = !empty; } } RenderSurface beginFrame è°ƒç”¨mRenderSurface(RenderSurface)çš„beginFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/RenderSurface.cpp const sp mDisplaySurface; status_t RenderSurface::beginFrame(bool mustRecompose) { return mDisplaySurface-\u003ebeginFrame(mustRecompose); } è°ƒç”¨mDisplaySurface(DisplaySurface)çš„beginFrameæ–¹æ³•ï¼ŒFramebufferSurfaceç»§æ‰¿DisplaySurfaceï¼Œè°ƒç”¨FramebufferSurfaceçš„beginFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/FramebufferSurface.cpp status_t FramebufferSurface::beginFrame(bool /*mustRecompose*/) { return NO_ERROR; } VirtualDisplaySurface beginFrame è°ƒç”¨mDisplaySurface(DisplaySurface)çš„beginFrameæ–¹æ³•ï¼ŒVirtualDisplaySurfaceç»§æ‰¿DisplaySurfaceï¼Œè°ƒç”¨VirtualDisplaySurfaceçš„beginFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/VirtualDisplaySurface.cpp status_t VirtualDisplaySurface::beginFrame(bool mustRecompose) { if (GpuVirtualDisplayId::tryCast(mDisplayId)) { return NO_ERROR; } mMustRecompose = mustRecompose; VDS_LOGW_IF(mDebugState != DebugState::Idle, \"Unexpected %s in %s state\", __func__, ftl::enum_string(mDebugState).c_str()); mDebugState = DebugState::Begun; return refreshOutputBuffer(); } è°ƒç”¨VirtualDisplaySurfaceçš„refreshOutputBufferæ–¹æ³•ï¼Œåˆ·æ–°è¾“å‡ºç¼“å†²åŒºï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/VirtualDisplaySurface.cpp HWComposer\u0026 mHwc; status_t VirtualDisplaySurface::refreshOutputBuffer() { LOG_ALWAYS_FATAL_IF(GpuVirtualDisplayId::tryCast(mDisplayId).has_value()); if (mOutputProducerSlot \u003e= 0) { mSource[SOURCE_SINK]-\u003ecancelBuffer( mapProducer2SourceSlot(SOURCE_SINK, mOutputProducerSlot), mOutputFence); } int sslot; status_t result = dequeueBuffer(SOURCE_SINK, mOutputFormat, mOutputUsage, \u0026sslot, \u0026mOutputFence); if (result \u003c 0) return result; mOutputProducerSlot = mapSource2ProducerSlot(SOURCE_SINK, sslot); // On GPU-only frames, we don't have the right output buffer acquire fence // until after GPU calls queueBuffer(). So here we just set the buffer // (for use in HWC prepare) but not the fence; we'll call this again with // the proper fence once we have it. const auto halDisplayId = HalVirtualDisplayId::tryCast(mDisplayId); LOG_FATAL_IF(!halDisplayId); result = mHwc.setOutputBuffer(*halDisplayId, Fence::NO_FENCE, mProducerBuffers[mOutputProducerSlot]); return result; } HWComposer setOutputBuffer è°ƒç”¨mHwc(HWComposer)çš„setOutputBufferæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/HWComposer.cpp std::unordered_map mDisplayData; std::unique_ptr hwcDisplay; status_t HWComposer::setOutputBuffer(HalVirtualDisplayId displayId, const sp\u0026 acquireFence, const sp\u0026 buffer) { RETURN_IF_INVALID_DISPLAY(displayId, BAD_","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:6","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#hwc2display-setoutputbuffer"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output prepareFrameAsync è°ƒç”¨Outputçš„prepareFrameAsyncæ–¹æ³•ï¼Œå‡†å¤‡å¸§æ•°æ®ä»¥è¿›è¡Œæ˜¾ç¤º(Asyncæ–¹å¼)ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp GpuCompositionResult Output::prepareFrameAsync(const CompositionRefreshArgs\u0026 refreshArgs) { ATRACE_CALL(); ALOGV(__FUNCTION__); auto\u0026 state = editState(); const auto\u0026 previousChanges = state.previousDeviceRequestedChanges; std::optional\u003candroid::HWComposer::DeviceRequestedChanges\u003e changes; resetCompositionStrategy(); auto hwcResult = chooseCompositionStrategyAsync(\u0026changes); if (state.previousDeviceRequestedSuccess) { applyCompositionStrategy(previousChanges); } finishPrepareFrame(); base::unique_fd bufferFence; std::shared_ptr\u003crenderengine::ExternalTexture\u003e buffer; updateProtectedContentState(); const bool dequeueSucceeded = dequeueRenderBuffer(\u0026bufferFence, \u0026buffer); GpuCompositionResult compositionResult; if (dequeueSucceeded) { std::optional\u003cbase::unique_fd\u003e optFd = composeSurfaces(Region::INVALID_REGION, refreshArgs, buffer, bufferFence); if (optFd) { compositionResult.fence = std::move(*optFd); } } auto chooseCompositionSuccess = hwcResult.get(); const bool predictionSucceeded = dequeueSucceeded \u0026\u0026 changes == previousChanges; state.strategyPrediction = predictionSucceeded ? CompositionStrategyPredictionState::SUCCESS : CompositionStrategyPredictionState::FAIL; if (!predictionSucceeded) { ATRACE_NAME(\"CompositionStrategyPredictionMiss\"); resetCompositionStrategy(); if (chooseCompositionSuccess) { applyCompositionStrategy(changes); } finishPrepareFrame(); // Track the dequeued buffer to reuse so we don't need to dequeue another one. compositionResult.buffer = buffer; } else { ATRACE_NAME(\"CompositionStrategyPredictionHit\"); } state.previousDeviceRequestedChanges = std::move(changes); state.previousDeviceRequestedSuccess = chooseCompositionSuccess; return compositionResult; } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:7","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#output-prepareframeasync"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output prepareFrame è°ƒç”¨Outputçš„prepareFrameæ–¹æ³•ï¼Œå‡†å¤‡å¸§æ•°æ®ä»¥è¿›è¡Œæ˜¾ç¤ºï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::prepareFrame() { ATRACE_CALL(); ALOGV(__FUNCTION__); auto\u0026 outputState = editState(); if (!outputState.isEnabled) { return; } std::optional\u003candroid::HWComposer::DeviceRequestedChanges\u003e changes; bool success = chooseCompositionStrategy(\u0026changes); //å‘HWCè¯¢é—®åˆæˆç­–ç•¥ resetCompositionStrategy(); outputState.strategyPrediction = CompositionStrategyPredictionState::DISABLED; outputState.previousDeviceRequestedChanges = changes; outputState.previousDeviceRequestedSuccess = success; if (success) { applyCompositionStrategy(changes); } finishPrepareFrame(); } Output chooseCompositionStrategy è°ƒç”¨Outputçš„chooseCompositionStrategyæ–¹æ³•ï¼Œå‘HWCè¯¢é—®åˆæˆç­–ç•¥ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp std::unique_ptr\u003cHwcAsyncWorker\u003e mHwComposerAsyncWorker; std::future\u003cbool\u003e Output::chooseCompositionStrategyAsync( std::optional\u003candroid::HWComposer::DeviceRequestedChanges\u003e* changes) { return mHwComposerAsyncWorker-\u003esend( [\u0026, changes]() { return chooseCompositionStrategy(changes); }); } è°ƒç”¨mHwComposerAsyncWorker(HwcAsyncWorker)çš„sendæ–¹æ³•ï¼Œè·å–åˆæˆç­–ç•¥ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/HwcAsyncWorker.cpp std::future\u003cbool\u003e HwcAsyncWorker::send(std::function\u003cbool()\u003e task) { std::unique_lock\u003cstd::mutex\u003e lock(mMutex); android::base::ScopedLockAssertion assumeLock(mMutex); mTask = std::packaged_task\u003cbool()\u003e([task = std::move(task)]() { return task(); }); mTaskRequested = true; mCv.notify_one(); return mTask.get_future(); } è¿”å›chooseCompositionStrategyï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Display.cpp bool Display::chooseCompositionStrategy( std::optional\u003candroid::HWComposer::DeviceRequestedChanges\u003e* outChanges) { ATRACE_CALL(); ALOGV(__FUNCTION__); if (mIsDisconnected) { return false; } // If we don't have a HWC display, then we are done. const auto halDisplayId = HalDisplayId::tryCast(mId); if (!halDisplayId) { return false; } // Get any composition changes requested by the HWC device, and apply them. std::optional\u003candroid::HWComposer::DeviceRequestedChanges\u003e changes; auto\u0026 hwc = getCompositionEngine().getHwComposer(); if (status_t result = hwc.getDeviceCompositionChanges(*halDisplayId, anyLayersRequireClientComposition(), getState().earliestPresentTime, getState().previousPresentFence, getState().expectedPresentTime, outChanges); result != NO_ERROR) { ALOGE(\"chooseCompositionStrategy failed for %s: %d (%s)\", getName().c_str(), result, strerror(-result)); return false; } return true; } HWComposer getDeviceCompositionChanges è°ƒç”¨hwc(HWComposer)çš„getDeviceCompositionChangesæ–¹æ³•ï¼Œå‘HWCè·å–åˆæˆç­–ç•¥ï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/HWComposer.cpp status_t HWComposer::getDeviceCompositionChanges( HalDisplayId displayId, bool frameUsesClientComposition, std::chrono::steady_clock::time_point earliestPresentTime, const std::shared_ptr\u003cFenceTime\u003e\u0026 previousPresentFence, nsecs_t expectedPresentTime, std::optional\u003candroid::HWComposer::DeviceRequestedChanges\u003e* outChanges) { ATRACE_CALL(); RETURN_IF_INVALID_DISPLAY(displayId, BAD_INDEX); auto\u0026 displayData = mDisplayData[displayId]; auto\u0026 hwcDisplay = displayData.hwcDisplay; if (!hwcDisplay-\u003eisConnected()) { return NO_ERROR; } uint32_t numTypes = 0; uint32_t numRequests = 0; hal::Error error = hal::Error::NONE; // First try to skip validate altogether. We can do that when // 1. The previous frame has not been presented yet or already passed the // earliest time to present. Otherwise, we may present a frame too early. // 2. There is no client composition. Otherwise, we first need to render the // client target buffer. const bool canSkipValidate = [\u0026] { // We must call validate if we have client composition if (frameUsesClientComposition) { return false; } // If composer supports getting the expected present time, we can skip // as composer will make sure to prevent early presentation if (mComposer-\u003ei","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:8","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#output-prepareframe"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output prepareFrame è°ƒç”¨Outputçš„prepareFrameæ–¹æ³•ï¼Œå‡†å¤‡å¸§æ•°æ®ä»¥è¿›è¡Œæ˜¾ç¤ºï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::prepareFrame() { ATRACE_CALL(); ALOGV(__FUNCTION__); auto\u0026 outputState = editState(); if (!outputState.isEnabled) { return; } std::optional changes; bool success = chooseCompositionStrategy(\u0026changes); //å‘HWCè¯¢é—®åˆæˆç­–ç•¥ resetCompositionStrategy(); outputState.strategyPrediction = CompositionStrategyPredictionState::DISABLED; outputState.previousDeviceRequestedChanges = changes; outputState.previousDeviceRequestedSuccess = success; if (success) { applyCompositionStrategy(changes); } finishPrepareFrame(); } Output chooseCompositionStrategy è°ƒç”¨Outputçš„chooseCompositionStrategyæ–¹æ³•ï¼Œå‘HWCè¯¢é—®åˆæˆç­–ç•¥ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp std::unique_ptr mHwComposerAsyncWorker; std::future Output::chooseCompositionStrategyAsync( std::optional* changes) { return mHwComposerAsyncWorker-\u003esend( [\u0026, changes]() { return chooseCompositionStrategy(changes); }); } è°ƒç”¨mHwComposerAsyncWorker(HwcAsyncWorker)çš„sendæ–¹æ³•ï¼Œè·å–åˆæˆç­–ç•¥ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/HwcAsyncWorker.cpp std::future HwcAsyncWorker::send(std::function task) { std::unique_lock lock(mMutex); android::base::ScopedLockAssertion assumeLock(mMutex); mTask = std::packaged_task([task = std::move(task)]() { return task(); }); mTaskRequested = true; mCv.notify_one(); return mTask.get_future(); } è¿”å›chooseCompositionStrategyï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Display.cpp bool Display::chooseCompositionStrategy( std::optional* outChanges) { ATRACE_CALL(); ALOGV(__FUNCTION__); if (mIsDisconnected) { return false; } // If we don't have a HWC display, then we are done. const auto halDisplayId = HalDisplayId::tryCast(mId); if (!halDisplayId) { return false; } // Get any composition changes requested by the HWC device, and apply them. std::optional changes; auto\u0026 hwc = getCompositionEngine().getHwComposer(); if (status_t result = hwc.getDeviceCompositionChanges(*halDisplayId, anyLayersRequireClientComposition(), getState().earliestPresentTime, getState().previousPresentFence, getState().expectedPresentTime, outChanges); result != NO_ERROR) { ALOGE(\"chooseCompositionStrategy failed for %s: %d (%s)\", getName().c_str(), result, strerror(-result)); return false; } return true; } HWComposer getDeviceCompositionChanges è°ƒç”¨hwc(HWComposer)çš„getDeviceCompositionChangesæ–¹æ³•ï¼Œå‘HWCè·å–åˆæˆç­–ç•¥ï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/HWComposer.cpp status_t HWComposer::getDeviceCompositionChanges( HalDisplayId displayId, bool frameUsesClientComposition, std::chrono::steady_clock::time_point earliestPresentTime, const std::shared_ptr\u0026 previousPresentFence, nsecs_t expectedPresentTime, std::optional* outChanges) { ATRACE_CALL(); RETURN_IF_INVALID_DISPLAY(displayId, BAD_INDEX); auto\u0026 displayData = mDisplayData[displayId]; auto\u0026 hwcDisplay = displayData.hwcDisplay; if (!hwcDisplay-\u003eisConnected()) { return NO_ERROR; } uint32_t numTypes = 0; uint32_t numRequests = 0; hal::Error error = hal::Error::NONE; // First try to skip validate altogether. We can do that when // 1. The previous frame has not been presented yet or already passed the // earliest time to present. Otherwise, we may present a frame too early. // 2. There is no client composition. Otherwise, we first need to render the // client target buffer. const bool canSkipValidate = [\u0026] { // We must call validate if we have client composition if (frameUsesClientComposition) { return false; } // If composer supports getting the expected present time, we can skip // as composer will make sure to prevent early presentation if (mComposer-\u003ei","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:8","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#output-choosecompositionstrategy"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output prepareFrame è°ƒç”¨Outputçš„prepareFrameæ–¹æ³•ï¼Œå‡†å¤‡å¸§æ•°æ®ä»¥è¿›è¡Œæ˜¾ç¤ºï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::prepareFrame() { ATRACE_CALL(); ALOGV(__FUNCTION__); auto\u0026 outputState = editState(); if (!outputState.isEnabled) { return; } std::optional changes; bool success = chooseCompositionStrategy(\u0026changes); //å‘HWCè¯¢é—®åˆæˆç­–ç•¥ resetCompositionStrategy(); outputState.strategyPrediction = CompositionStrategyPredictionState::DISABLED; outputState.previousDeviceRequestedChanges = changes; outputState.previousDeviceRequestedSuccess = success; if (success) { applyCompositionStrategy(changes); } finishPrepareFrame(); } Output chooseCompositionStrategy è°ƒç”¨Outputçš„chooseCompositionStrategyæ–¹æ³•ï¼Œå‘HWCè¯¢é—®åˆæˆç­–ç•¥ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp std::unique_ptr mHwComposerAsyncWorker; std::future Output::chooseCompositionStrategyAsync( std::optional* changes) { return mHwComposerAsyncWorker-\u003esend( [\u0026, changes]() { return chooseCompositionStrategy(changes); }); } è°ƒç”¨mHwComposerAsyncWorker(HwcAsyncWorker)çš„sendæ–¹æ³•ï¼Œè·å–åˆæˆç­–ç•¥ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/HwcAsyncWorker.cpp std::future HwcAsyncWorker::send(std::function task) { std::unique_lock lock(mMutex); android::base::ScopedLockAssertion assumeLock(mMutex); mTask = std::packaged_task([task = std::move(task)]() { return task(); }); mTaskRequested = true; mCv.notify_one(); return mTask.get_future(); } è¿”å›chooseCompositionStrategyï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Display.cpp bool Display::chooseCompositionStrategy( std::optional* outChanges) { ATRACE_CALL(); ALOGV(__FUNCTION__); if (mIsDisconnected) { return false; } // If we don't have a HWC display, then we are done. const auto halDisplayId = HalDisplayId::tryCast(mId); if (!halDisplayId) { return false; } // Get any composition changes requested by the HWC device, and apply them. std::optional changes; auto\u0026 hwc = getCompositionEngine().getHwComposer(); if (status_t result = hwc.getDeviceCompositionChanges(*halDisplayId, anyLayersRequireClientComposition(), getState().earliestPresentTime, getState().previousPresentFence, getState().expectedPresentTime, outChanges); result != NO_ERROR) { ALOGE(\"chooseCompositionStrategy failed for %s: %d (%s)\", getName().c_str(), result, strerror(-result)); return false; } return true; } HWComposer getDeviceCompositionChanges è°ƒç”¨hwc(HWComposer)çš„getDeviceCompositionChangesæ–¹æ³•ï¼Œå‘HWCè·å–åˆæˆç­–ç•¥ï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/HWComposer.cpp status_t HWComposer::getDeviceCompositionChanges( HalDisplayId displayId, bool frameUsesClientComposition, std::chrono::steady_clock::time_point earliestPresentTime, const std::shared_ptr\u0026 previousPresentFence, nsecs_t expectedPresentTime, std::optional* outChanges) { ATRACE_CALL(); RETURN_IF_INVALID_DISPLAY(displayId, BAD_INDEX); auto\u0026 displayData = mDisplayData[displayId]; auto\u0026 hwcDisplay = displayData.hwcDisplay; if (!hwcDisplay-\u003eisConnected()) { return NO_ERROR; } uint32_t numTypes = 0; uint32_t numRequests = 0; hal::Error error = hal::Error::NONE; // First try to skip validate altogether. We can do that when // 1. The previous frame has not been presented yet or already passed the // earliest time to present. Otherwise, we may present a frame too early. // 2. There is no client composition. Otherwise, we first need to render the // client target buffer. const bool canSkipValidate = [\u0026] { // We must call validate if we have client composition if (frameUsesClientComposition) { return false; } // If composer supports getting the expected present time, we can skip // as composer will make sure to prevent early presentation if (mComposer-\u003ei","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:8","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#hwcomposer-getdevicecompositionchanges"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output devOptRepaintFlash è°ƒç”¨Outputçš„devOptRepaintFlashæ–¹æ³•ï¼Œå¤„ç†æ˜¾ç¤ºè¾“å‡ºè®¾å¤‡çš„å¯é€‰é‡ç»˜é—ªçƒï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::devOptRepaintFlash(const compositionengine::CompositionRefreshArgs\u0026 refreshArgs) { if (CC_LIKELY(!refreshArgs.devOptFlashDirtyRegionsDelay)) { return; } if (getState().isEnabled) { if (const auto dirtyRegion = getDirtyRegion(); !dirtyRegion.isEmpty()) { base::unique_fd bufferFence; std::shared_ptr\u003crenderengine::ExternalTexture\u003e buffer; updateProtectedContentState(); dequeueRenderBuffer(\u0026bufferFence, \u0026buffer); static_cast\u003cvoid\u003e(composeSurfaces(dirtyRegion, refreshArgs, buffer, bufferFence)); mRenderSurface-\u003equeueBuffer(base::unique_fd()); } } postFramebuffer(); std::this_thread::sleep_for(*refreshArgs.devOptFlashDirtyRegionsDelay); prepareFrame(); } RenderSurface queueBuffer è°ƒç”¨mRenderSurface(RenderSurface)çš„queueBufferæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/RenderSurface.cpp void RenderSurface::queueBuffer(base::unique_fd readyFence) { auto\u0026 state = mDisplay.getState(); if (state.usesClientComposition || state.flipClientTarget) { // hasFlipClientTargetRequest could return true even if we haven't // dequeued a buffer before. Try dequeueing one if we don't have a // buffer ready. if (mTexture == nullptr) { ALOGI(\"Attempting to queue a client composited buffer without one \" \"previously dequeued for display [%s]. Attempting to dequeue \" \"a scratch buffer now\", mDisplay.getName().c_str()); // We shouldn't deadlock here, since mTexture == nullptr only // after a successful call to queueBuffer, or if dequeueBuffer has // never been called. base::unique_fd unused; dequeueBuffer(\u0026unused); } if (mTexture == nullptr) { ALOGE(\"No buffer is ready for display [%s]\", mDisplay.getName().c_str()); } else { status_t result = mNativeWindow-\u003equeueBuffer(mNativeWindow.get(), mTexture-\u003egetBuffer()-\u003egetNativeBuffer(), dup(readyFence)); if (result != NO_ERROR) { ALOGE(\"Error when queueing buffer for display [%s]: %d\", mDisplay.getName().c_str(), result); // We risk blocking on dequeueBuffer if the primary display failed // to queue up its buffer, so crash here. if (!mDisplay.isVirtual()) { LOG_ALWAYS_FATAL(\"ANativeWindow::queueBuffer failed with error: %d\", result); } else { mNativeWindow-\u003ecancelBuffer(mNativeWindow.get(), mTexture-\u003egetBuffer()-\u003egetNativeBuffer(), dup(readyFence)); } } mTexture = nullptr; } } status_t result = mDisplaySurface-\u003eadvanceFrame(); if (result != NO_ERROR) { ALOGE(\"[%s] failed pushing new frame to HWC: %d\", mDisplay.getName().c_str(), result); } } FramebufferSurface advanceFrame è°ƒç”¨mDisplaySurface(DisplaySurface)çš„advanceFrameæ–¹æ³•ï¼ŒFramebufferSurfaceç»§æ‰¿ä¸DisplaySurfaceï¼Œè°ƒç”¨FramebufferSurfaceçš„advanceFrameæ–¹æ³•ï¼ŒFramebufferSurfaceçš„advanceFrameæ–¹æ³•ç”¨äºæ›´æ–°å¸§å¹¶å°†å…¶æ˜¾ç¤ºåœ¨å±å¹•ä¸Š //frameworks/native/services/surfaceflinger/DisplayHardware/FramebufferSurface.cpp status_t FramebufferSurface::advanceFrame() { uint32_t slot = 0; sp\u003cGraphicBuffer\u003e buf; sp\u003cFence\u003e acquireFence(Fence::NO_FENCE); Dataspace dataspace = Dataspace::UNKNOWN; status_t result = nextBuffer(slot, buf, acquireFence, dataspace); mDataSpace = dataspace; if (result != NO_ERROR) { ALOGE(\"error latching next FramebufferSurface buffer: %s (%d)\", strerror(-result), result); } return result; } è°ƒç”¨FramebufferSurfaceçš„nextBufferæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/FramebufferSurface.cpp status_t FramebufferSurface::nextBuffer(uint32_t\u0026 outSlot, sp\u003cGraphicBuffer\u003e\u0026 outBuffer, sp\u003cFence\u003e\u0026 outFence, Dataspace\u0026 outDataspace) { Mutex::Autolock lock(mMutex); BufferItem item; status_t err = acquireBufferLocked(\u0026item, 0); if (err == BufferQueue::NO_BUFFER_AVAILABLE) { mHwcBufferCache.getHwcBuffer(mCurrentBufferSlot, mCurrentBuffer, \u0026outSlot, \u0026outBuffer); return NO_ERROR; } else if (err != NO_ERROR) { ALOGE(\"error acquiring buffer: %s (%d)\", strerror(-err), err); return err; } // If the BufferQueue has freed and reallocated a buffer in mCurrentSlot // then we may have acquired the slot we already own. If","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:9","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#output-devoptrepaintflash"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output devOptRepaintFlash è°ƒç”¨Outputçš„devOptRepaintFlashæ–¹æ³•ï¼Œå¤„ç†æ˜¾ç¤ºè¾“å‡ºè®¾å¤‡çš„å¯é€‰é‡ç»˜é—ªçƒï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::devOptRepaintFlash(const compositionengine::CompositionRefreshArgs\u0026 refreshArgs) { if (CC_LIKELY(!refreshArgs.devOptFlashDirtyRegionsDelay)) { return; } if (getState().isEnabled) { if (const auto dirtyRegion = getDirtyRegion(); !dirtyRegion.isEmpty()) { base::unique_fd bufferFence; std::shared_ptr buffer; updateProtectedContentState(); dequeueRenderBuffer(\u0026bufferFence, \u0026buffer); static_cast(composeSurfaces(dirtyRegion, refreshArgs, buffer, bufferFence)); mRenderSurface-\u003equeueBuffer(base::unique_fd()); } } postFramebuffer(); std::this_thread::sleep_for(*refreshArgs.devOptFlashDirtyRegionsDelay); prepareFrame(); } RenderSurface queueBuffer è°ƒç”¨mRenderSurface(RenderSurface)çš„queueBufferæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/RenderSurface.cpp void RenderSurface::queueBuffer(base::unique_fd readyFence) { auto\u0026 state = mDisplay.getState(); if (state.usesClientComposition || state.flipClientTarget) { // hasFlipClientTargetRequest could return true even if we haven't // dequeued a buffer before. Try dequeueing one if we don't have a // buffer ready. if (mTexture == nullptr) { ALOGI(\"Attempting to queue a client composited buffer without one \" \"previously dequeued for display [%s]. Attempting to dequeue \" \"a scratch buffer now\", mDisplay.getName().c_str()); // We shouldn't deadlock here, since mTexture == nullptr only // after a successful call to queueBuffer, or if dequeueBuffer has // never been called. base::unique_fd unused; dequeueBuffer(\u0026unused); } if (mTexture == nullptr) { ALOGE(\"No buffer is ready for display [%s]\", mDisplay.getName().c_str()); } else { status_t result = mNativeWindow-\u003equeueBuffer(mNativeWindow.get(), mTexture-\u003egetBuffer()-\u003egetNativeBuffer(), dup(readyFence)); if (result != NO_ERROR) { ALOGE(\"Error when queueing buffer for display [%s]: %d\", mDisplay.getName().c_str(), result); // We risk blocking on dequeueBuffer if the primary display failed // to queue up its buffer, so crash here. if (!mDisplay.isVirtual()) { LOG_ALWAYS_FATAL(\"ANativeWindow::queueBuffer failed with error: %d\", result); } else { mNativeWindow-\u003ecancelBuffer(mNativeWindow.get(), mTexture-\u003egetBuffer()-\u003egetNativeBuffer(), dup(readyFence)); } } mTexture = nullptr; } } status_t result = mDisplaySurface-\u003eadvanceFrame(); if (result != NO_ERROR) { ALOGE(\"[%s] failed pushing new frame to HWC: %d\", mDisplay.getName().c_str(), result); } } FramebufferSurface advanceFrame è°ƒç”¨mDisplaySurface(DisplaySurface)çš„advanceFrameæ–¹æ³•ï¼ŒFramebufferSurfaceç»§æ‰¿ä¸DisplaySurfaceï¼Œè°ƒç”¨FramebufferSurfaceçš„advanceFrameæ–¹æ³•ï¼ŒFramebufferSurfaceçš„advanceFrameæ–¹æ³•ç”¨äºæ›´æ–°å¸§å¹¶å°†å…¶æ˜¾ç¤ºåœ¨å±å¹•ä¸Š //frameworks/native/services/surfaceflinger/DisplayHardware/FramebufferSurface.cpp status_t FramebufferSurface::advanceFrame() { uint32_t slot = 0; sp buf; sp acquireFence(Fence::NO_FENCE); Dataspace dataspace = Dataspace::UNKNOWN; status_t result = nextBuffer(slot, buf, acquireFence, dataspace); mDataSpace = dataspace; if (result != NO_ERROR) { ALOGE(\"error latching next FramebufferSurface buffer: %s (%d)\", strerror(-result), result); } return result; } è°ƒç”¨FramebufferSurfaceçš„nextBufferæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/FramebufferSurface.cpp status_t FramebufferSurface::nextBuffer(uint32_t\u0026 outSlot, sp\u0026 outBuffer, sp\u0026 outFence, Dataspace\u0026 outDataspace) { Mutex::Autolock lock(mMutex); BufferItem item; status_t err = acquireBufferLocked(\u0026item, 0); if (err == BufferQueue::NO_BUFFER_AVAILABLE) { mHwcBufferCache.getHwcBuffer(mCurrentBufferSlot, mCurrentBuffer, \u0026outSlot, \u0026outBuffer); return NO_ERROR; } else if (err != NO_ERROR) { ALOGE(\"error acquiring buffer: %s (%d)\", strerror(-err), err); return err; } // If the BufferQueue has freed and reallocated a buffer in mCurrentSlot // then we may have acquired the slot we already own. If","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:9","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#rendersurface-queuebuffer"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output devOptRepaintFlash è°ƒç”¨Outputçš„devOptRepaintFlashæ–¹æ³•ï¼Œå¤„ç†æ˜¾ç¤ºè¾“å‡ºè®¾å¤‡çš„å¯é€‰é‡ç»˜é—ªçƒï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::devOptRepaintFlash(const compositionengine::CompositionRefreshArgs\u0026 refreshArgs) { if (CC_LIKELY(!refreshArgs.devOptFlashDirtyRegionsDelay)) { return; } if (getState().isEnabled) { if (const auto dirtyRegion = getDirtyRegion(); !dirtyRegion.isEmpty()) { base::unique_fd bufferFence; std::shared_ptr buffer; updateProtectedContentState(); dequeueRenderBuffer(\u0026bufferFence, \u0026buffer); static_cast(composeSurfaces(dirtyRegion, refreshArgs, buffer, bufferFence)); mRenderSurface-\u003equeueBuffer(base::unique_fd()); } } postFramebuffer(); std::this_thread::sleep_for(*refreshArgs.devOptFlashDirtyRegionsDelay); prepareFrame(); } RenderSurface queueBuffer è°ƒç”¨mRenderSurface(RenderSurface)çš„queueBufferæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/RenderSurface.cpp void RenderSurface::queueBuffer(base::unique_fd readyFence) { auto\u0026 state = mDisplay.getState(); if (state.usesClientComposition || state.flipClientTarget) { // hasFlipClientTargetRequest could return true even if we haven't // dequeued a buffer before. Try dequeueing one if we don't have a // buffer ready. if (mTexture == nullptr) { ALOGI(\"Attempting to queue a client composited buffer without one \" \"previously dequeued for display [%s]. Attempting to dequeue \" \"a scratch buffer now\", mDisplay.getName().c_str()); // We shouldn't deadlock here, since mTexture == nullptr only // after a successful call to queueBuffer, or if dequeueBuffer has // never been called. base::unique_fd unused; dequeueBuffer(\u0026unused); } if (mTexture == nullptr) { ALOGE(\"No buffer is ready for display [%s]\", mDisplay.getName().c_str()); } else { status_t result = mNativeWindow-\u003equeueBuffer(mNativeWindow.get(), mTexture-\u003egetBuffer()-\u003egetNativeBuffer(), dup(readyFence)); if (result != NO_ERROR) { ALOGE(\"Error when queueing buffer for display [%s]: %d\", mDisplay.getName().c_str(), result); // We risk blocking on dequeueBuffer if the primary display failed // to queue up its buffer, so crash here. if (!mDisplay.isVirtual()) { LOG_ALWAYS_FATAL(\"ANativeWindow::queueBuffer failed with error: %d\", result); } else { mNativeWindow-\u003ecancelBuffer(mNativeWindow.get(), mTexture-\u003egetBuffer()-\u003egetNativeBuffer(), dup(readyFence)); } } mTexture = nullptr; } } status_t result = mDisplaySurface-\u003eadvanceFrame(); if (result != NO_ERROR) { ALOGE(\"[%s] failed pushing new frame to HWC: %d\", mDisplay.getName().c_str(), result); } } FramebufferSurface advanceFrame è°ƒç”¨mDisplaySurface(DisplaySurface)çš„advanceFrameæ–¹æ³•ï¼ŒFramebufferSurfaceç»§æ‰¿ä¸DisplaySurfaceï¼Œè°ƒç”¨FramebufferSurfaceçš„advanceFrameæ–¹æ³•ï¼ŒFramebufferSurfaceçš„advanceFrameæ–¹æ³•ç”¨äºæ›´æ–°å¸§å¹¶å°†å…¶æ˜¾ç¤ºåœ¨å±å¹•ä¸Š //frameworks/native/services/surfaceflinger/DisplayHardware/FramebufferSurface.cpp status_t FramebufferSurface::advanceFrame() { uint32_t slot = 0; sp buf; sp acquireFence(Fence::NO_FENCE); Dataspace dataspace = Dataspace::UNKNOWN; status_t result = nextBuffer(slot, buf, acquireFence, dataspace); mDataSpace = dataspace; if (result != NO_ERROR) { ALOGE(\"error latching next FramebufferSurface buffer: %s (%d)\", strerror(-result), result); } return result; } è°ƒç”¨FramebufferSurfaceçš„nextBufferæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/FramebufferSurface.cpp status_t FramebufferSurface::nextBuffer(uint32_t\u0026 outSlot, sp\u0026 outBuffer, sp\u0026 outFence, Dataspace\u0026 outDataspace) { Mutex::Autolock lock(mMutex); BufferItem item; status_t err = acquireBufferLocked(\u0026item, 0); if (err == BufferQueue::NO_BUFFER_AVAILABLE) { mHwcBufferCache.getHwcBuffer(mCurrentBufferSlot, mCurrentBuffer, \u0026outSlot, \u0026outBuffer); return NO_ERROR; } else if (err != NO_ERROR) { ALOGE(\"error acquiring buffer: %s (%d)\", strerror(-err), err); return err; } // If the BufferQueue has freed and reallocated a buffer in mCurrentSlot // then we may have acquired the slot we already own. If","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:9","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#framebuffersurface-advanceframe"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output devOptRepaintFlash è°ƒç”¨Outputçš„devOptRepaintFlashæ–¹æ³•ï¼Œå¤„ç†æ˜¾ç¤ºè¾“å‡ºè®¾å¤‡çš„å¯é€‰é‡ç»˜é—ªçƒï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::devOptRepaintFlash(const compositionengine::CompositionRefreshArgs\u0026 refreshArgs) { if (CC_LIKELY(!refreshArgs.devOptFlashDirtyRegionsDelay)) { return; } if (getState().isEnabled) { if (const auto dirtyRegion = getDirtyRegion(); !dirtyRegion.isEmpty()) { base::unique_fd bufferFence; std::shared_ptr buffer; updateProtectedContentState(); dequeueRenderBuffer(\u0026bufferFence, \u0026buffer); static_cast(composeSurfaces(dirtyRegion, refreshArgs, buffer, bufferFence)); mRenderSurface-\u003equeueBuffer(base::unique_fd()); } } postFramebuffer(); std::this_thread::sleep_for(*refreshArgs.devOptFlashDirtyRegionsDelay); prepareFrame(); } RenderSurface queueBuffer è°ƒç”¨mRenderSurface(RenderSurface)çš„queueBufferæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/RenderSurface.cpp void RenderSurface::queueBuffer(base::unique_fd readyFence) { auto\u0026 state = mDisplay.getState(); if (state.usesClientComposition || state.flipClientTarget) { // hasFlipClientTargetRequest could return true even if we haven't // dequeued a buffer before. Try dequeueing one if we don't have a // buffer ready. if (mTexture == nullptr) { ALOGI(\"Attempting to queue a client composited buffer without one \" \"previously dequeued for display [%s]. Attempting to dequeue \" \"a scratch buffer now\", mDisplay.getName().c_str()); // We shouldn't deadlock here, since mTexture == nullptr only // after a successful call to queueBuffer, or if dequeueBuffer has // never been called. base::unique_fd unused; dequeueBuffer(\u0026unused); } if (mTexture == nullptr) { ALOGE(\"No buffer is ready for display [%s]\", mDisplay.getName().c_str()); } else { status_t result = mNativeWindow-\u003equeueBuffer(mNativeWindow.get(), mTexture-\u003egetBuffer()-\u003egetNativeBuffer(), dup(readyFence)); if (result != NO_ERROR) { ALOGE(\"Error when queueing buffer for display [%s]: %d\", mDisplay.getName().c_str(), result); // We risk blocking on dequeueBuffer if the primary display failed // to queue up its buffer, so crash here. if (!mDisplay.isVirtual()) { LOG_ALWAYS_FATAL(\"ANativeWindow::queueBuffer failed with error: %d\", result); } else { mNativeWindow-\u003ecancelBuffer(mNativeWindow.get(), mTexture-\u003egetBuffer()-\u003egetNativeBuffer(), dup(readyFence)); } } mTexture = nullptr; } } status_t result = mDisplaySurface-\u003eadvanceFrame(); if (result != NO_ERROR) { ALOGE(\"[%s] failed pushing new frame to HWC: %d\", mDisplay.getName().c_str(), result); } } FramebufferSurface advanceFrame è°ƒç”¨mDisplaySurface(DisplaySurface)çš„advanceFrameæ–¹æ³•ï¼ŒFramebufferSurfaceç»§æ‰¿ä¸DisplaySurfaceï¼Œè°ƒç”¨FramebufferSurfaceçš„advanceFrameæ–¹æ³•ï¼ŒFramebufferSurfaceçš„advanceFrameæ–¹æ³•ç”¨äºæ›´æ–°å¸§å¹¶å°†å…¶æ˜¾ç¤ºåœ¨å±å¹•ä¸Š //frameworks/native/services/surfaceflinger/DisplayHardware/FramebufferSurface.cpp status_t FramebufferSurface::advanceFrame() { uint32_t slot = 0; sp buf; sp acquireFence(Fence::NO_FENCE); Dataspace dataspace = Dataspace::UNKNOWN; status_t result = nextBuffer(slot, buf, acquireFence, dataspace); mDataSpace = dataspace; if (result != NO_ERROR) { ALOGE(\"error latching next FramebufferSurface buffer: %s (%d)\", strerror(-result), result); } return result; } è°ƒç”¨FramebufferSurfaceçš„nextBufferæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/FramebufferSurface.cpp status_t FramebufferSurface::nextBuffer(uint32_t\u0026 outSlot, sp\u0026 outBuffer, sp\u0026 outFence, Dataspace\u0026 outDataspace) { Mutex::Autolock lock(mMutex); BufferItem item; status_t err = acquireBufferLocked(\u0026item, 0); if (err == BufferQueue::NO_BUFFER_AVAILABLE) { mHwcBufferCache.getHwcBuffer(mCurrentBufferSlot, mCurrentBuffer, \u0026outSlot, \u0026outBuffer); return NO_ERROR; } else if (err != NO_ERROR) { ALOGE(\"error acquiring buffer: %s (%d)\", strerror(-err), err); return err; } // If the BufferQueue has freed and reallocated a buffer in mCurrentSlot // then we may have acquired the slot we already own. If","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:9","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#hwcomposer-setclienttarget"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output devOptRepaintFlash è°ƒç”¨Outputçš„devOptRepaintFlashæ–¹æ³•ï¼Œå¤„ç†æ˜¾ç¤ºè¾“å‡ºè®¾å¤‡çš„å¯é€‰é‡ç»˜é—ªçƒï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::devOptRepaintFlash(const compositionengine::CompositionRefreshArgs\u0026 refreshArgs) { if (CC_LIKELY(!refreshArgs.devOptFlashDirtyRegionsDelay)) { return; } if (getState().isEnabled) { if (const auto dirtyRegion = getDirtyRegion(); !dirtyRegion.isEmpty()) { base::unique_fd bufferFence; std::shared_ptr buffer; updateProtectedContentState(); dequeueRenderBuffer(\u0026bufferFence, \u0026buffer); static_cast(composeSurfaces(dirtyRegion, refreshArgs, buffer, bufferFence)); mRenderSurface-\u003equeueBuffer(base::unique_fd()); } } postFramebuffer(); std::this_thread::sleep_for(*refreshArgs.devOptFlashDirtyRegionsDelay); prepareFrame(); } RenderSurface queueBuffer è°ƒç”¨mRenderSurface(RenderSurface)çš„queueBufferæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/RenderSurface.cpp void RenderSurface::queueBuffer(base::unique_fd readyFence) { auto\u0026 state = mDisplay.getState(); if (state.usesClientComposition || state.flipClientTarget) { // hasFlipClientTargetRequest could return true even if we haven't // dequeued a buffer before. Try dequeueing one if we don't have a // buffer ready. if (mTexture == nullptr) { ALOGI(\"Attempting to queue a client composited buffer without one \" \"previously dequeued for display [%s]. Attempting to dequeue \" \"a scratch buffer now\", mDisplay.getName().c_str()); // We shouldn't deadlock here, since mTexture == nullptr only // after a successful call to queueBuffer, or if dequeueBuffer has // never been called. base::unique_fd unused; dequeueBuffer(\u0026unused); } if (mTexture == nullptr) { ALOGE(\"No buffer is ready for display [%s]\", mDisplay.getName().c_str()); } else { status_t result = mNativeWindow-\u003equeueBuffer(mNativeWindow.get(), mTexture-\u003egetBuffer()-\u003egetNativeBuffer(), dup(readyFence)); if (result != NO_ERROR) { ALOGE(\"Error when queueing buffer for display [%s]: %d\", mDisplay.getName().c_str(), result); // We risk blocking on dequeueBuffer if the primary display failed // to queue up its buffer, so crash here. if (!mDisplay.isVirtual()) { LOG_ALWAYS_FATAL(\"ANativeWindow::queueBuffer failed with error: %d\", result); } else { mNativeWindow-\u003ecancelBuffer(mNativeWindow.get(), mTexture-\u003egetBuffer()-\u003egetNativeBuffer(), dup(readyFence)); } } mTexture = nullptr; } } status_t result = mDisplaySurface-\u003eadvanceFrame(); if (result != NO_ERROR) { ALOGE(\"[%s] failed pushing new frame to HWC: %d\", mDisplay.getName().c_str(), result); } } FramebufferSurface advanceFrame è°ƒç”¨mDisplaySurface(DisplaySurface)çš„advanceFrameæ–¹æ³•ï¼ŒFramebufferSurfaceç»§æ‰¿ä¸DisplaySurfaceï¼Œè°ƒç”¨FramebufferSurfaceçš„advanceFrameæ–¹æ³•ï¼ŒFramebufferSurfaceçš„advanceFrameæ–¹æ³•ç”¨äºæ›´æ–°å¸§å¹¶å°†å…¶æ˜¾ç¤ºåœ¨å±å¹•ä¸Š //frameworks/native/services/surfaceflinger/DisplayHardware/FramebufferSurface.cpp status_t FramebufferSurface::advanceFrame() { uint32_t slot = 0; sp buf; sp acquireFence(Fence::NO_FENCE); Dataspace dataspace = Dataspace::UNKNOWN; status_t result = nextBuffer(slot, buf, acquireFence, dataspace); mDataSpace = dataspace; if (result != NO_ERROR) { ALOGE(\"error latching next FramebufferSurface buffer: %s (%d)\", strerror(-result), result); } return result; } è°ƒç”¨FramebufferSurfaceçš„nextBufferæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/FramebufferSurface.cpp status_t FramebufferSurface::nextBuffer(uint32_t\u0026 outSlot, sp\u0026 outBuffer, sp\u0026 outFence, Dataspace\u0026 outDataspace) { Mutex::Autolock lock(mMutex); BufferItem item; status_t err = acquireBufferLocked(\u0026item, 0); if (err == BufferQueue::NO_BUFFER_AVAILABLE) { mHwcBufferCache.getHwcBuffer(mCurrentBufferSlot, mCurrentBuffer, \u0026outSlot, \u0026outBuffer); return NO_ERROR; } else if (err != NO_ERROR) { ALOGE(\"error acquiring buffer: %s (%d)\", strerror(-err), err); return err; } // If the BufferQueue has freed and reallocated a buffer in mCurrentSlot // then we may have acquired the slot we already own. If","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:9","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#hwc2display-setoutputbuffer-1"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output finishFrame è°ƒç”¨Outputçš„finishFrameæ–¹æ³•ï¼Œå®Œæˆå¸§ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::finishFrame(const CompositionRefreshArgs\u0026 refreshArgs, GpuCompositionResult\u0026\u0026 result) { ATRACE_CALL(); ALOGV(__FUNCTION__); const auto\u0026 outputState = getState(); if (!outputState.isEnabled) { return; } std::optional\u003cbase::unique_fd\u003e optReadyFence; std::shared_ptr\u003crenderengine::ExternalTexture\u003e buffer; base::unique_fd bufferFence; if (outputState.strategyPrediction == CompositionStrategyPredictionState::SUCCESS) { optReadyFence = std::move(result.fence); } else { if (result.bufferAvailable()) { buffer = std::move(result.buffer); bufferFence = std::move(result.fence); } else { updateProtectedContentState(); if (!dequeueRenderBuffer(\u0026bufferFence, \u0026buffer)) { return; } } // Repaint the framebuffer (if needed), getting the optional fence for when // the composition completes. optReadyFence = composeSurfaces(Region::INVALID_REGION, refreshArgs, buffer, bufferFence); } if (!optReadyFence) { return; } // swap buffers (presentation) mRenderSurface-\u003equeueBuffer(std::move(*optReadyFence)); } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:10","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#output-finishframe"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output postFramebuffer è°ƒç”¨Outputçš„postFramebufferæ–¹æ³•ï¼Œå°†å¸§ç¼“å†²åŒºï¼ˆframebufferï¼‰çš„å†…å®¹å‘é€åˆ°æ˜¾ç¤ºè®¾å¤‡è¿›è¡Œæ˜¾ç¤ºï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::postFramebuffer() { ATRACE_CALL(); ALOGV(__FUNCTION__); if (!getState().isEnabled) { return; } auto\u0026 outputState = editState(); outputState.dirtyRegion.clear(); mRenderSurface-\u003eflip(); auto frame = presentAndGetFrameFences(); mRenderSurface-\u003eonPresentDisplayCompleted(); for (auto* layer : getOutputLayersOrderedByZ()) { // The layer buffer from the previous frame (if any) is released // by HWC only when the release fence from this frame (if any) is // signaled. Always get the release fence from HWC first. sp\u003cFence\u003e releaseFence = Fence::NO_FENCE; if (auto hwcLayer = layer-\u003egetHwcLayer()) { if (auto f = frame.layerFences.find(hwcLayer); f != frame.layerFences.end()) { releaseFence = f-\u003esecond; } } // If the layer was client composited in the previous frame, we // need to merge with the previous client target acquire fence. // Since we do not track that, always merge with the current // client target acquire fence when it is available, even though // this is suboptimal. // TODO(b/121291683): Track previous frame client target acquire fence. if (outputState.usesClientComposition) { releaseFence = Fence::merge(\"LayerRelease\", releaseFence, frame.clientTargetAcquireFence); } layer-\u003egetLayerFE().onLayerDisplayed( ftl::yield\u003cFenceResult\u003e(std::move(releaseFence)).share()); } // We've got a list of layers needing fences, that are disjoint with // OutputLayersOrderedByZ. The best we can do is to // supply them with the present fence. for (auto\u0026 weakLayer : mReleasedLayers) { if (const auto layer = weakLayer.promote()) { layer-\u003eonLayerDisplayed(ftl::yield\u003cFenceResult\u003e(frame.presentFence).share()); } } // Clear out the released layers now that we're done with them. mReleasedLayers.clear(); } ä¸Šé¢æ–¹æ³•ä¸»è¦å¤„ç†å¦‚ä¸‹ï¼š 1ã€è°ƒç”¨Outputçš„presentAndGetFrameFencesæ–¹æ³•ï¼Œé€šè¿‡presentAndGetReleaseFencesæ˜¾ç¤ºè·å–releaseFencesã€‚ 2ã€è°ƒç”¨BufferQueueLayerçš„onLayerDisplayedæ–¹æ³•ã€‚ ä¸‹é¢åˆ†åˆ«è¿›è¡Œåˆ†æã€‚ Output presentAndGetFrameFences è°ƒç”¨Outputçš„presentAndGetFrameFencesæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp compositionengine::Output::FrameFences Output::presentAndGetFrameFences() { compositionengine::Output::FrameFences result; if (getState().usesClientComposition) { result.clientTargetAcquireFence = mRenderSurface-\u003egetClientTargetAcquireFence(); } return result; } è°ƒç”¨mRenderSurface(RenderSurface)çš„getClientTargetAcquireFenceæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/RenderSurface.cpp const sp\u003cDisplaySurface\u003e mDisplaySurface; const sp\u003cFence\u003e\u0026 RenderSurface::getClientTargetAcquireFence() const { return mDisplaySurface-\u003egetClientTargetAcquireFence(); } FramebufferSurface getClientTargetAcquireFence è°ƒç”¨mDisplaySurface(DisplaySurface)çš„prepareFrameæ–¹æ³•ï¼ŒFramebufferSurface ç»§æ‰¿äºDisplaySurfaceï¼Œå› æ­¤è°ƒç”¨FramebufferSurfaceçš„getClientTargetAcquireFenceæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/FramebufferSurface.cpp const sp\u003cFence\u003e\u0026 FramebufferSurface::getClientTargetAcquireFence() const { return mCurrentFence; } BufferQueueLayer onLayerDisplayed è°ƒç”¨Layerçš„onLayerDisplayedæ–¹æ³•ï¼ŒBufferQueueLayerç»§æ‰¿äºBuffeLayerï¼ŒBuffeLayerç”±ç»§æ‰¿äºLayerï¼Œå› æ­¤è°ƒç”¨BufferQueueLayerçš„onLayerDisplayedæ–¹æ³•ï¼š Android13 BufferQueueLayer onLayerDisplayedæµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:11","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#output-postframebuffer"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output postFramebuffer è°ƒç”¨Outputçš„postFramebufferæ–¹æ³•ï¼Œå°†å¸§ç¼“å†²åŒºï¼ˆframebufferï¼‰çš„å†…å®¹å‘é€åˆ°æ˜¾ç¤ºè®¾å¤‡è¿›è¡Œæ˜¾ç¤ºï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::postFramebuffer() { ATRACE_CALL(); ALOGV(__FUNCTION__); if (!getState().isEnabled) { return; } auto\u0026 outputState = editState(); outputState.dirtyRegion.clear(); mRenderSurface-\u003eflip(); auto frame = presentAndGetFrameFences(); mRenderSurface-\u003eonPresentDisplayCompleted(); for (auto* layer : getOutputLayersOrderedByZ()) { // The layer buffer from the previous frame (if any) is released // by HWC only when the release fence from this frame (if any) is // signaled. Always get the release fence from HWC first. sp releaseFence = Fence::NO_FENCE; if (auto hwcLayer = layer-\u003egetHwcLayer()) { if (auto f = frame.layerFences.find(hwcLayer); f != frame.layerFences.end()) { releaseFence = f-\u003esecond; } } // If the layer was client composited in the previous frame, we // need to merge with the previous client target acquire fence. // Since we do not track that, always merge with the current // client target acquire fence when it is available, even though // this is suboptimal. // TODO(b/121291683): Track previous frame client target acquire fence. if (outputState.usesClientComposition) { releaseFence = Fence::merge(\"LayerRelease\", releaseFence, frame.clientTargetAcquireFence); } layer-\u003egetLayerFE().onLayerDisplayed( ftl::yield(std::move(releaseFence)).share()); } // We've got a list of layers needing fences, that are disjoint with // OutputLayersOrderedByZ. The best we can do is to // supply them with the present fence. for (auto\u0026 weakLayer : mReleasedLayers) { if (const auto layer = weakLayer.promote()) { layer-\u003eonLayerDisplayed(ftl::yield(frame.presentFence).share()); } } // Clear out the released layers now that we're done with them. mReleasedLayers.clear(); } ä¸Šé¢æ–¹æ³•ä¸»è¦å¤„ç†å¦‚ä¸‹ï¼š 1ã€è°ƒç”¨Outputçš„presentAndGetFrameFencesæ–¹æ³•ï¼Œé€šè¿‡presentAndGetReleaseFencesæ˜¾ç¤ºè·å–releaseFencesã€‚ 2ã€è°ƒç”¨BufferQueueLayerçš„onLayerDisplayedæ–¹æ³•ã€‚ ä¸‹é¢åˆ†åˆ«è¿›è¡Œåˆ†æã€‚ Output presentAndGetFrameFences è°ƒç”¨Outputçš„presentAndGetFrameFencesæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp compositionengine::Output::FrameFences Output::presentAndGetFrameFences() { compositionengine::Output::FrameFences result; if (getState().usesClientComposition) { result.clientTargetAcquireFence = mRenderSurface-\u003egetClientTargetAcquireFence(); } return result; } è°ƒç”¨mRenderSurface(RenderSurface)çš„getClientTargetAcquireFenceæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/RenderSurface.cpp const sp mDisplaySurface; const sp\u0026 RenderSurface::getClientTargetAcquireFence() const { return mDisplaySurface-\u003egetClientTargetAcquireFence(); } FramebufferSurface getClientTargetAcquireFence è°ƒç”¨mDisplaySurface(DisplaySurface)çš„prepareFrameæ–¹æ³•ï¼ŒFramebufferSurface ç»§æ‰¿äºDisplaySurfaceï¼Œå› æ­¤è°ƒç”¨FramebufferSurfaceçš„getClientTargetAcquireFenceæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/FramebufferSurface.cpp const sp\u0026 FramebufferSurface::getClientTargetAcquireFence() const { return mCurrentFence; } BufferQueueLayer onLayerDisplayed è°ƒç”¨Layerçš„onLayerDisplayedæ–¹æ³•ï¼ŒBufferQueueLayerç»§æ‰¿äºBuffeLayerï¼ŒBuffeLayerç”±ç»§æ‰¿äºLayerï¼Œå› æ­¤è°ƒç”¨BufferQueueLayerçš„onLayerDisplayedæ–¹æ³•ï¼š Android13 BufferQueueLayer onLayerDisplayedæµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:11","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#output-presentandgetframefences"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output postFramebuffer è°ƒç”¨Outputçš„postFramebufferæ–¹æ³•ï¼Œå°†å¸§ç¼“å†²åŒºï¼ˆframebufferï¼‰çš„å†…å®¹å‘é€åˆ°æ˜¾ç¤ºè®¾å¤‡è¿›è¡Œæ˜¾ç¤ºï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::postFramebuffer() { ATRACE_CALL(); ALOGV(__FUNCTION__); if (!getState().isEnabled) { return; } auto\u0026 outputState = editState(); outputState.dirtyRegion.clear(); mRenderSurface-\u003eflip(); auto frame = presentAndGetFrameFences(); mRenderSurface-\u003eonPresentDisplayCompleted(); for (auto* layer : getOutputLayersOrderedByZ()) { // The layer buffer from the previous frame (if any) is released // by HWC only when the release fence from this frame (if any) is // signaled. Always get the release fence from HWC first. sp releaseFence = Fence::NO_FENCE; if (auto hwcLayer = layer-\u003egetHwcLayer()) { if (auto f = frame.layerFences.find(hwcLayer); f != frame.layerFences.end()) { releaseFence = f-\u003esecond; } } // If the layer was client composited in the previous frame, we // need to merge with the previous client target acquire fence. // Since we do not track that, always merge with the current // client target acquire fence when it is available, even though // this is suboptimal. // TODO(b/121291683): Track previous frame client target acquire fence. if (outputState.usesClientComposition) { releaseFence = Fence::merge(\"LayerRelease\", releaseFence, frame.clientTargetAcquireFence); } layer-\u003egetLayerFE().onLayerDisplayed( ftl::yield(std::move(releaseFence)).share()); } // We've got a list of layers needing fences, that are disjoint with // OutputLayersOrderedByZ. The best we can do is to // supply them with the present fence. for (auto\u0026 weakLayer : mReleasedLayers) { if (const auto layer = weakLayer.promote()) { layer-\u003eonLayerDisplayed(ftl::yield(frame.presentFence).share()); } } // Clear out the released layers now that we're done with them. mReleasedLayers.clear(); } ä¸Šé¢æ–¹æ³•ä¸»è¦å¤„ç†å¦‚ä¸‹ï¼š 1ã€è°ƒç”¨Outputçš„presentAndGetFrameFencesæ–¹æ³•ï¼Œé€šè¿‡presentAndGetReleaseFencesæ˜¾ç¤ºè·å–releaseFencesã€‚ 2ã€è°ƒç”¨BufferQueueLayerçš„onLayerDisplayedæ–¹æ³•ã€‚ ä¸‹é¢åˆ†åˆ«è¿›è¡Œåˆ†æã€‚ Output presentAndGetFrameFences è°ƒç”¨Outputçš„presentAndGetFrameFencesæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp compositionengine::Output::FrameFences Output::presentAndGetFrameFences() { compositionengine::Output::FrameFences result; if (getState().usesClientComposition) { result.clientTargetAcquireFence = mRenderSurface-\u003egetClientTargetAcquireFence(); } return result; } è°ƒç”¨mRenderSurface(RenderSurface)çš„getClientTargetAcquireFenceæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/RenderSurface.cpp const sp mDisplaySurface; const sp\u0026 RenderSurface::getClientTargetAcquireFence() const { return mDisplaySurface-\u003egetClientTargetAcquireFence(); } FramebufferSurface getClientTargetAcquireFence è°ƒç”¨mDisplaySurface(DisplaySurface)çš„prepareFrameæ–¹æ³•ï¼ŒFramebufferSurface ç»§æ‰¿äºDisplaySurfaceï¼Œå› æ­¤è°ƒç”¨FramebufferSurfaceçš„getClientTargetAcquireFenceæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/FramebufferSurface.cpp const sp\u0026 FramebufferSurface::getClientTargetAcquireFence() const { return mCurrentFence; } BufferQueueLayer onLayerDisplayed è°ƒç”¨Layerçš„onLayerDisplayedæ–¹æ³•ï¼ŒBufferQueueLayerç»§æ‰¿äºBuffeLayerï¼ŒBuffeLayerç”±ç»§æ‰¿äºLayerï¼Œå› æ­¤è°ƒç”¨BufferQueueLayerçš„onLayerDisplayedæ–¹æ³•ï¼š Android13 BufferQueueLayer onLayerDisplayedæµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:11","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#framebuffersurface-getclienttargetacquirefence"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output postFramebuffer è°ƒç”¨Outputçš„postFramebufferæ–¹æ³•ï¼Œå°†å¸§ç¼“å†²åŒºï¼ˆframebufferï¼‰çš„å†…å®¹å‘é€åˆ°æ˜¾ç¤ºè®¾å¤‡è¿›è¡Œæ˜¾ç¤ºï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::postFramebuffer() { ATRACE_CALL(); ALOGV(__FUNCTION__); if (!getState().isEnabled) { return; } auto\u0026 outputState = editState(); outputState.dirtyRegion.clear(); mRenderSurface-\u003eflip(); auto frame = presentAndGetFrameFences(); mRenderSurface-\u003eonPresentDisplayCompleted(); for (auto* layer : getOutputLayersOrderedByZ()) { // The layer buffer from the previous frame (if any) is released // by HWC only when the release fence from this frame (if any) is // signaled. Always get the release fence from HWC first. sp releaseFence = Fence::NO_FENCE; if (auto hwcLayer = layer-\u003egetHwcLayer()) { if (auto f = frame.layerFences.find(hwcLayer); f != frame.layerFences.end()) { releaseFence = f-\u003esecond; } } // If the layer was client composited in the previous frame, we // need to merge with the previous client target acquire fence. // Since we do not track that, always merge with the current // client target acquire fence when it is available, even though // this is suboptimal. // TODO(b/121291683): Track previous frame client target acquire fence. if (outputState.usesClientComposition) { releaseFence = Fence::merge(\"LayerRelease\", releaseFence, frame.clientTargetAcquireFence); } layer-\u003egetLayerFE().onLayerDisplayed( ftl::yield(std::move(releaseFence)).share()); } // We've got a list of layers needing fences, that are disjoint with // OutputLayersOrderedByZ. The best we can do is to // supply them with the present fence. for (auto\u0026 weakLayer : mReleasedLayers) { if (const auto layer = weakLayer.promote()) { layer-\u003eonLayerDisplayed(ftl::yield(frame.presentFence).share()); } } // Clear out the released layers now that we're done with them. mReleasedLayers.clear(); } ä¸Šé¢æ–¹æ³•ä¸»è¦å¤„ç†å¦‚ä¸‹ï¼š 1ã€è°ƒç”¨Outputçš„presentAndGetFrameFencesæ–¹æ³•ï¼Œé€šè¿‡presentAndGetReleaseFencesæ˜¾ç¤ºè·å–releaseFencesã€‚ 2ã€è°ƒç”¨BufferQueueLayerçš„onLayerDisplayedæ–¹æ³•ã€‚ ä¸‹é¢åˆ†åˆ«è¿›è¡Œåˆ†æã€‚ Output presentAndGetFrameFences è°ƒç”¨Outputçš„presentAndGetFrameFencesæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp compositionengine::Output::FrameFences Output::presentAndGetFrameFences() { compositionengine::Output::FrameFences result; if (getState().usesClientComposition) { result.clientTargetAcquireFence = mRenderSurface-\u003egetClientTargetAcquireFence(); } return result; } è°ƒç”¨mRenderSurface(RenderSurface)çš„getClientTargetAcquireFenceæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/RenderSurface.cpp const sp mDisplaySurface; const sp\u0026 RenderSurface::getClientTargetAcquireFence() const { return mDisplaySurface-\u003egetClientTargetAcquireFence(); } FramebufferSurface getClientTargetAcquireFence è°ƒç”¨mDisplaySurface(DisplaySurface)çš„prepareFrameæ–¹æ³•ï¼ŒFramebufferSurface ç»§æ‰¿äºDisplaySurfaceï¼Œå› æ­¤è°ƒç”¨FramebufferSurfaceçš„getClientTargetAcquireFenceæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/DisplayHardware/FramebufferSurface.cpp const sp\u0026 FramebufferSurface::getClientTargetAcquireFence() const { return mCurrentFence; } BufferQueueLayer onLayerDisplayed è°ƒç”¨Layerçš„onLayerDisplayedæ–¹æ³•ï¼ŒBufferQueueLayerç»§æ‰¿äºBuffeLayerï¼ŒBuffeLayerç”±ç»§æ‰¿äºLayerï¼Œå› æ­¤è°ƒç”¨BufferQueueLayerçš„onLayerDisplayedæ–¹æ³•ï¼š Android13 BufferQueueLayer onLayerDisplayedæµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:11","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#bufferqueuelayer-onlayerdisplayed"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output renderCachedSets è°ƒç”¨Outputçš„renderCachedSetsæ–¹æ³•ï¼Œè¿›è¡Œæ¸²æŸ“ç¼“å­˜è®¾ç½®ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::renderCachedSets(const CompositionRefreshArgs\u0026 refreshArgs) { if (mPlanner) { mPlanner-\u003erenderCachedSets(getState(), refreshArgs.scheduledFrameTime); } } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:12","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#output-rendercachedsets"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output dirtyEntireOutput è°ƒç”¨Outputçš„dirtyEntireOutputæ–¹æ³•ï¼Œé‡ç½®è„åŒºï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp OutputCompositionState outputState ; Region dirtyRegion; using OutputCompositionState = compositionengine::impl::OutputCompositionState; void Output::dirtyEntireOutput() { auto\u0026 outputState = editState(); outputState.dirtyRegion.set(outputState.displaySpace.getBoundsAsRect()); } Region set è°ƒç”¨outputState(OutputCompositionState )å†…æˆå‘˜å˜é‡dirtyRegion(Region)çš„setæ–¹æ³•ï¼Œè®¾ç½®è„åŒºï¼š //frameworks/native/libs/ui/Region.cpp FatVector\u003cRect\u003e mStorage; void Region::set(const Rect\u0026 r) { mStorage.clear(); mStorage.push_back(r); } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:13","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#output-dirtyentireoutput"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output dirtyEntireOutput è°ƒç”¨Outputçš„dirtyEntireOutputæ–¹æ³•ï¼Œé‡ç½®è„åŒºï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp OutputCompositionState outputState ; Region dirtyRegion; using OutputCompositionState = compositionengine::impl::OutputCompositionState; void Output::dirtyEntireOutput() { auto\u0026 outputState = editState(); outputState.dirtyRegion.set(outputState.displaySpace.getBoundsAsRect()); } Region set è°ƒç”¨outputState(OutputCompositionState )å†…æˆå‘˜å˜é‡dirtyRegion(Region)çš„setæ–¹æ³•ï¼Œè®¾ç½®è„åŒºï¼š //frameworks/native/libs/ui/Region.cpp FatVector mStorage; void Region::set(const Rect\u0026 r) { mStorage.clear(); mStorage.push_back(r); } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:13","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#region-set"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output finishPrepareFrame è°ƒç”¨Outputçš„finishPrepareFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::finishPrepareFrame() { const auto\u0026 state = getState(); if (mPlanner) { mPlanner-\u003ereportFinalPlan(getOutputLayersOrderedByZ()); } mRenderSurface-\u003eprepareFrame(state.usesClientComposition, state.usesDeviceComposition); } Planner reportFinalPlan è°ƒç”¨mPlanner(Planner)çš„reportFinalPlanæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Planner.cpp void Planner::reportFinalPlan( compositionengine::Output::OutputLayersEnumerator\u003ccompositionengine::Output\u003e\u0026\u0026 layers) { ATRACE_CALL(); if (!mPredictorEnabled) { return; } Plan finalPlan; const GraphicBuffer* currentOverrideBuffer = nullptr; bool hasSkippedLayers = false; for (auto layer : layers) { if (!layer-\u003egetState().overrideInfo.buffer) { continue; } const GraphicBuffer* overrideBuffer = layer-\u003egetState().overrideInfo.buffer-\u003egetBuffer().get(); if (overrideBuffer != nullptr \u0026\u0026 overrideBuffer == currentOverrideBuffer) { // Skip this layer since it is part of a previous cached set hasSkippedLayers = true; continue; } currentOverrideBuffer = overrideBuffer; const bool forcedOrRequestedClient = layer-\u003egetState().forceClientComposition || layer-\u003erequiresClientComposition(); finalPlan.addLayerType( forcedOrRequestedClient ? aidl::android::hardware::graphics::composer3::Composition::CLIENT : layer-\u003egetLayerFE().getCompositionState()-\u003ecompositionType); } mPredictor.recordResult(mPredictedPlan, mFlattenedHash, mCurrentLayers, hasSkippedLayers, finalPlan); } è°ƒç”¨mPredictor(Predictor)çš„recordResultæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Predictor.cpp void Predictor::recordResult(std::optional\u003cPredictedPlan\u003e predictedPlan, NonBufferHash flattenedHash, const std::vector\u003cconst LayerState*\u003e\u0026 layers, bool hasSkippedLayers, Plan result) { if (predictedPlan) { recordPredictedResult(*predictedPlan, layers, std::move(result)); return; } ++mMissCount; if (!hasSkippedLayers \u0026\u0026 findSimilarPrediction(layers, result)) { return; } ALOGV(\"[%s] Adding novel candidate %zx\", __func__, flattenedHash); mCandidates.emplace_front(flattenedHash, Prediction(layers, result)); if (mCandidates.size() \u003e MAX_CANDIDATES) { mCandidates.pop_back(); } } RenderSurface prepareFrame è°ƒç”¨RenderSurfaceçš„prepareFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/RenderSurface.cpp const sp\u003cDisplaySurface\u003e mDisplaySurface; void RenderSurface::prepareFrame(bool usesClientComposition, bool usesDeviceComposition) { const auto compositionType = [=] { using CompositionType = DisplaySurface::CompositionType; if (usesClientComposition \u0026\u0026 usesDeviceComposition) return CompositionType::Mixed; if (usesClientComposition) return CompositionType::Gpu; if (usesDeviceComposition) return CompositionType::Hwc; // Nothing to do -- when turning the screen off we get a frame like // this. Call it a HWC frame since we won't be doing any GPU work but // will do a prepare/set cycle. return CompositionType::Hwc; }(); if (status_t result = mDisplaySurface-\u003eprepareFrame(compositionType); result != NO_ERROR) { ALOGE(\"updateCompositionType failed for %s: %d (%s)\", mDisplay.getName().c_str(), result, strerror(-result)); } } VirtualDisplaySurface prepareFrame è°ƒç”¨mDisplaySurface(DisplaySurface)çš„prepareFrameæ–¹æ³•ï¼ŒVirtualDisplaySurfaceç»§æ‰¿äºDisplaySurfaceï¼Œå› æ­¤è°ƒç”¨DisplaySurfaceçš„prepareFrameæ–¹æ³•ï¼ŒDisplaySurfaceçš„prepareFrameæ–¹æ³•ç”¨äºå‡†å¤‡å¸§ //frameworks/native/services/surfaceflinger/DisplayHardware/VirtualDisplaySurface.cpp status_t VirtualDisplaySurface::prepareFrame(CompositionType compositionType) { if (GpuVirtualDisplayId::tryCast(mDisplayId)) { return NO_ERROR; } VDS_LOGW_IF(mDebugState != DebugState::Begun, \"Unexpected %s in %s state\", __func__, ftl::enum_string(mDebugState).c_str()); mDebugState = DebugState::Prepared; mCompositionType = compositionType; if (mForceHwcCopy \u0026\u0026 mCompositionType == CompositionType::Gpu) { // Some hardware can do RGB-\u003eYUV conversion more efficiently in ha","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:14","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#output-finishprepareframe"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output finishPrepareFrame è°ƒç”¨Outputçš„finishPrepareFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::finishPrepareFrame() { const auto\u0026 state = getState(); if (mPlanner) { mPlanner-\u003ereportFinalPlan(getOutputLayersOrderedByZ()); } mRenderSurface-\u003eprepareFrame(state.usesClientComposition, state.usesDeviceComposition); } Planner reportFinalPlan è°ƒç”¨mPlanner(Planner)çš„reportFinalPlanæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Planner.cpp void Planner::reportFinalPlan( compositionengine::Output::OutputLayersEnumerator\u0026\u0026 layers) { ATRACE_CALL(); if (!mPredictorEnabled) { return; } Plan finalPlan; const GraphicBuffer* currentOverrideBuffer = nullptr; bool hasSkippedLayers = false; for (auto layer : layers) { if (!layer-\u003egetState().overrideInfo.buffer) { continue; } const GraphicBuffer* overrideBuffer = layer-\u003egetState().overrideInfo.buffer-\u003egetBuffer().get(); if (overrideBuffer != nullptr \u0026\u0026 overrideBuffer == currentOverrideBuffer) { // Skip this layer since it is part of a previous cached set hasSkippedLayers = true; continue; } currentOverrideBuffer = overrideBuffer; const bool forcedOrRequestedClient = layer-\u003egetState().forceClientComposition || layer-\u003erequiresClientComposition(); finalPlan.addLayerType( forcedOrRequestedClient ? aidl::android::hardware::graphics::composer3::Composition::CLIENT : layer-\u003egetLayerFE().getCompositionState()-\u003ecompositionType); } mPredictor.recordResult(mPredictedPlan, mFlattenedHash, mCurrentLayers, hasSkippedLayers, finalPlan); } è°ƒç”¨mPredictor(Predictor)çš„recordResultæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Predictor.cpp void Predictor::recordResult(std::optional predictedPlan, NonBufferHash flattenedHash, const std::vector\u0026 layers, bool hasSkippedLayers, Plan result) { if (predictedPlan) { recordPredictedResult(*predictedPlan, layers, std::move(result)); return; } ++mMissCount; if (!hasSkippedLayers \u0026\u0026 findSimilarPrediction(layers, result)) { return; } ALOGV(\"[%s] Adding novel candidate %zx\", __func__, flattenedHash); mCandidates.emplace_front(flattenedHash, Prediction(layers, result)); if (mCandidates.size() \u003e MAX_CANDIDATES) { mCandidates.pop_back(); } } RenderSurface prepareFrame è°ƒç”¨RenderSurfaceçš„prepareFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/RenderSurface.cpp const sp mDisplaySurface; void RenderSurface::prepareFrame(bool usesClientComposition, bool usesDeviceComposition) { const auto compositionType = [=] { using CompositionType = DisplaySurface::CompositionType; if (usesClientComposition \u0026\u0026 usesDeviceComposition) return CompositionType::Mixed; if (usesClientComposition) return CompositionType::Gpu; if (usesDeviceComposition) return CompositionType::Hwc; // Nothing to do -- when turning the screen off we get a frame like // this. Call it a HWC frame since we won't be doing any GPU work but // will do a prepare/set cycle. return CompositionType::Hwc; }(); if (status_t result = mDisplaySurface-\u003eprepareFrame(compositionType); result != NO_ERROR) { ALOGE(\"updateCompositionType failed for %s: %d (%s)\", mDisplay.getName().c_str(), result, strerror(-result)); } } VirtualDisplaySurface prepareFrame è°ƒç”¨mDisplaySurface(DisplaySurface)çš„prepareFrameæ–¹æ³•ï¼ŒVirtualDisplaySurfaceç»§æ‰¿äºDisplaySurfaceï¼Œå› æ­¤è°ƒç”¨DisplaySurfaceçš„prepareFrameæ–¹æ³•ï¼ŒDisplaySurfaceçš„prepareFrameæ–¹æ³•ç”¨äºå‡†å¤‡å¸§ //frameworks/native/services/surfaceflinger/DisplayHardware/VirtualDisplaySurface.cpp status_t VirtualDisplaySurface::prepareFrame(CompositionType compositionType) { if (GpuVirtualDisplayId::tryCast(mDisplayId)) { return NO_ERROR; } VDS_LOGW_IF(mDebugState != DebugState::Begun, \"Unexpected %s in %s state\", __func__, ftl::enum_string(mDebugState).c_str()); mDebugState = DebugState::Prepared; mCompositionType = compositionType; if (mForceHwcCopy \u0026\u0026 mCompositionType == CompositionType::Gpu) { // Some hardware can do RGB-\u003eYUV conversion more efficiently in ha","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:14","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#planner-reportfinalplan"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output finishPrepareFrame è°ƒç”¨Outputçš„finishPrepareFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::finishPrepareFrame() { const auto\u0026 state = getState(); if (mPlanner) { mPlanner-\u003ereportFinalPlan(getOutputLayersOrderedByZ()); } mRenderSurface-\u003eprepareFrame(state.usesClientComposition, state.usesDeviceComposition); } Planner reportFinalPlan è°ƒç”¨mPlanner(Planner)çš„reportFinalPlanæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Planner.cpp void Planner::reportFinalPlan( compositionengine::Output::OutputLayersEnumerator\u0026\u0026 layers) { ATRACE_CALL(); if (!mPredictorEnabled) { return; } Plan finalPlan; const GraphicBuffer* currentOverrideBuffer = nullptr; bool hasSkippedLayers = false; for (auto layer : layers) { if (!layer-\u003egetState().overrideInfo.buffer) { continue; } const GraphicBuffer* overrideBuffer = layer-\u003egetState().overrideInfo.buffer-\u003egetBuffer().get(); if (overrideBuffer != nullptr \u0026\u0026 overrideBuffer == currentOverrideBuffer) { // Skip this layer since it is part of a previous cached set hasSkippedLayers = true; continue; } currentOverrideBuffer = overrideBuffer; const bool forcedOrRequestedClient = layer-\u003egetState().forceClientComposition || layer-\u003erequiresClientComposition(); finalPlan.addLayerType( forcedOrRequestedClient ? aidl::android::hardware::graphics::composer3::Composition::CLIENT : layer-\u003egetLayerFE().getCompositionState()-\u003ecompositionType); } mPredictor.recordResult(mPredictedPlan, mFlattenedHash, mCurrentLayers, hasSkippedLayers, finalPlan); } è°ƒç”¨mPredictor(Predictor)çš„recordResultæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Predictor.cpp void Predictor::recordResult(std::optional predictedPlan, NonBufferHash flattenedHash, const std::vector\u0026 layers, bool hasSkippedLayers, Plan result) { if (predictedPlan) { recordPredictedResult(*predictedPlan, layers, std::move(result)); return; } ++mMissCount; if (!hasSkippedLayers \u0026\u0026 findSimilarPrediction(layers, result)) { return; } ALOGV(\"[%s] Adding novel candidate %zx\", __func__, flattenedHash); mCandidates.emplace_front(flattenedHash, Prediction(layers, result)); if (mCandidates.size() \u003e MAX_CANDIDATES) { mCandidates.pop_back(); } } RenderSurface prepareFrame è°ƒç”¨RenderSurfaceçš„prepareFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/RenderSurface.cpp const sp mDisplaySurface; void RenderSurface::prepareFrame(bool usesClientComposition, bool usesDeviceComposition) { const auto compositionType = [=] { using CompositionType = DisplaySurface::CompositionType; if (usesClientComposition \u0026\u0026 usesDeviceComposition) return CompositionType::Mixed; if (usesClientComposition) return CompositionType::Gpu; if (usesDeviceComposition) return CompositionType::Hwc; // Nothing to do -- when turning the screen off we get a frame like // this. Call it a HWC frame since we won't be doing any GPU work but // will do a prepare/set cycle. return CompositionType::Hwc; }(); if (status_t result = mDisplaySurface-\u003eprepareFrame(compositionType); result != NO_ERROR) { ALOGE(\"updateCompositionType failed for %s: %d (%s)\", mDisplay.getName().c_str(), result, strerror(-result)); } } VirtualDisplaySurface prepareFrame è°ƒç”¨mDisplaySurface(DisplaySurface)çš„prepareFrameæ–¹æ³•ï¼ŒVirtualDisplaySurfaceç»§æ‰¿äºDisplaySurfaceï¼Œå› æ­¤è°ƒç”¨DisplaySurfaceçš„prepareFrameæ–¹æ³•ï¼ŒDisplaySurfaceçš„prepareFrameæ–¹æ³•ç”¨äºå‡†å¤‡å¸§ //frameworks/native/services/surfaceflinger/DisplayHardware/VirtualDisplaySurface.cpp status_t VirtualDisplaySurface::prepareFrame(CompositionType compositionType) { if (GpuVirtualDisplayId::tryCast(mDisplayId)) { return NO_ERROR; } VDS_LOGW_IF(mDebugState != DebugState::Begun, \"Unexpected %s in %s state\", __func__, ftl::enum_string(mDebugState).c_str()); mDebugState = DebugState::Prepared; mCompositionType = compositionType; if (mForceHwcCopy \u0026\u0026 mCompositionType == CompositionType::Gpu) { // Some hardware can do RGB-\u003eYUV conversion more efficiently in ha","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:14","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#rendersurface-prepareframe"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output finishPrepareFrame è°ƒç”¨Outputçš„finishPrepareFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::finishPrepareFrame() { const auto\u0026 state = getState(); if (mPlanner) { mPlanner-\u003ereportFinalPlan(getOutputLayersOrderedByZ()); } mRenderSurface-\u003eprepareFrame(state.usesClientComposition, state.usesDeviceComposition); } Planner reportFinalPlan è°ƒç”¨mPlanner(Planner)çš„reportFinalPlanæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Planner.cpp void Planner::reportFinalPlan( compositionengine::Output::OutputLayersEnumerator\u0026\u0026 layers) { ATRACE_CALL(); if (!mPredictorEnabled) { return; } Plan finalPlan; const GraphicBuffer* currentOverrideBuffer = nullptr; bool hasSkippedLayers = false; for (auto layer : layers) { if (!layer-\u003egetState().overrideInfo.buffer) { continue; } const GraphicBuffer* overrideBuffer = layer-\u003egetState().overrideInfo.buffer-\u003egetBuffer().get(); if (overrideBuffer != nullptr \u0026\u0026 overrideBuffer == currentOverrideBuffer) { // Skip this layer since it is part of a previous cached set hasSkippedLayers = true; continue; } currentOverrideBuffer = overrideBuffer; const bool forcedOrRequestedClient = layer-\u003egetState().forceClientComposition || layer-\u003erequiresClientComposition(); finalPlan.addLayerType( forcedOrRequestedClient ? aidl::android::hardware::graphics::composer3::Composition::CLIENT : layer-\u003egetLayerFE().getCompositionState()-\u003ecompositionType); } mPredictor.recordResult(mPredictedPlan, mFlattenedHash, mCurrentLayers, hasSkippedLayers, finalPlan); } è°ƒç”¨mPredictor(Predictor)çš„recordResultæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Predictor.cpp void Predictor::recordResult(std::optional predictedPlan, NonBufferHash flattenedHash, const std::vector\u0026 layers, bool hasSkippedLayers, Plan result) { if (predictedPlan) { recordPredictedResult(*predictedPlan, layers, std::move(result)); return; } ++mMissCount; if (!hasSkippedLayers \u0026\u0026 findSimilarPrediction(layers, result)) { return; } ALOGV(\"[%s] Adding novel candidate %zx\", __func__, flattenedHash); mCandidates.emplace_front(flattenedHash, Prediction(layers, result)); if (mCandidates.size() \u003e MAX_CANDIDATES) { mCandidates.pop_back(); } } RenderSurface prepareFrame è°ƒç”¨RenderSurfaceçš„prepareFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/RenderSurface.cpp const sp mDisplaySurface; void RenderSurface::prepareFrame(bool usesClientComposition, bool usesDeviceComposition) { const auto compositionType = [=] { using CompositionType = DisplaySurface::CompositionType; if (usesClientComposition \u0026\u0026 usesDeviceComposition) return CompositionType::Mixed; if (usesClientComposition) return CompositionType::Gpu; if (usesDeviceComposition) return CompositionType::Hwc; // Nothing to do -- when turning the screen off we get a frame like // this. Call it a HWC frame since we won't be doing any GPU work but // will do a prepare/set cycle. return CompositionType::Hwc; }(); if (status_t result = mDisplaySurface-\u003eprepareFrame(compositionType); result != NO_ERROR) { ALOGE(\"updateCompositionType failed for %s: %d (%s)\", mDisplay.getName().c_str(), result, strerror(-result)); } } VirtualDisplaySurface prepareFrame è°ƒç”¨mDisplaySurface(DisplaySurface)çš„prepareFrameæ–¹æ³•ï¼ŒVirtualDisplaySurfaceç»§æ‰¿äºDisplaySurfaceï¼Œå› æ­¤è°ƒç”¨DisplaySurfaceçš„prepareFrameæ–¹æ³•ï¼ŒDisplaySurfaceçš„prepareFrameæ–¹æ³•ç”¨äºå‡†å¤‡å¸§ //frameworks/native/services/surfaceflinger/DisplayHardware/VirtualDisplaySurface.cpp status_t VirtualDisplaySurface::prepareFrame(CompositionType compositionType) { if (GpuVirtualDisplayId::tryCast(mDisplayId)) { return NO_ERROR; } VDS_LOGW_IF(mDebugState != DebugState::Begun, \"Unexpected %s in %s state\", __func__, ftl::enum_string(mDebugState).c_str()); mDebugState = DebugState::Prepared; mCompositionType = compositionType; if (mForceHwcCopy \u0026\u0026 mCompositionType == CompositionType::Gpu) { // Some hardware can do RGB-\u003eYUV conversion more efficiently in ha","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:14","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#virtualdisplaysurface-prepareframe"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output finishPrepareFrame è°ƒç”¨Outputçš„finishPrepareFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::finishPrepareFrame() { const auto\u0026 state = getState(); if (mPlanner) { mPlanner-\u003ereportFinalPlan(getOutputLayersOrderedByZ()); } mRenderSurface-\u003eprepareFrame(state.usesClientComposition, state.usesDeviceComposition); } Planner reportFinalPlan è°ƒç”¨mPlanner(Planner)çš„reportFinalPlanæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Planner.cpp void Planner::reportFinalPlan( compositionengine::Output::OutputLayersEnumerator\u0026\u0026 layers) { ATRACE_CALL(); if (!mPredictorEnabled) { return; } Plan finalPlan; const GraphicBuffer* currentOverrideBuffer = nullptr; bool hasSkippedLayers = false; for (auto layer : layers) { if (!layer-\u003egetState().overrideInfo.buffer) { continue; } const GraphicBuffer* overrideBuffer = layer-\u003egetState().overrideInfo.buffer-\u003egetBuffer().get(); if (overrideBuffer != nullptr \u0026\u0026 overrideBuffer == currentOverrideBuffer) { // Skip this layer since it is part of a previous cached set hasSkippedLayers = true; continue; } currentOverrideBuffer = overrideBuffer; const bool forcedOrRequestedClient = layer-\u003egetState().forceClientComposition || layer-\u003erequiresClientComposition(); finalPlan.addLayerType( forcedOrRequestedClient ? aidl::android::hardware::graphics::composer3::Composition::CLIENT : layer-\u003egetLayerFE().getCompositionState()-\u003ecompositionType); } mPredictor.recordResult(mPredictedPlan, mFlattenedHash, mCurrentLayers, hasSkippedLayers, finalPlan); } è°ƒç”¨mPredictor(Predictor)çš„recordResultæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Predictor.cpp void Predictor::recordResult(std::optional predictedPlan, NonBufferHash flattenedHash, const std::vector\u0026 layers, bool hasSkippedLayers, Plan result) { if (predictedPlan) { recordPredictedResult(*predictedPlan, layers, std::move(result)); return; } ++mMissCount; if (!hasSkippedLayers \u0026\u0026 findSimilarPrediction(layers, result)) { return; } ALOGV(\"[%s] Adding novel candidate %zx\", __func__, flattenedHash); mCandidates.emplace_front(flattenedHash, Prediction(layers, result)); if (mCandidates.size() \u003e MAX_CANDIDATES) { mCandidates.pop_back(); } } RenderSurface prepareFrame è°ƒç”¨RenderSurfaceçš„prepareFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/RenderSurface.cpp const sp mDisplaySurface; void RenderSurface::prepareFrame(bool usesClientComposition, bool usesDeviceComposition) { const auto compositionType = [=] { using CompositionType = DisplaySurface::CompositionType; if (usesClientComposition \u0026\u0026 usesDeviceComposition) return CompositionType::Mixed; if (usesClientComposition) return CompositionType::Gpu; if (usesDeviceComposition) return CompositionType::Hwc; // Nothing to do -- when turning the screen off we get a frame like // this. Call it a HWC frame since we won't be doing any GPU work but // will do a prepare/set cycle. return CompositionType::Hwc; }(); if (status_t result = mDisplaySurface-\u003eprepareFrame(compositionType); result != NO_ERROR) { ALOGE(\"updateCompositionType failed for %s: %d (%s)\", mDisplay.getName().c_str(), result, strerror(-result)); } } VirtualDisplaySurface prepareFrame è°ƒç”¨mDisplaySurface(DisplaySurface)çš„prepareFrameæ–¹æ³•ï¼ŒVirtualDisplaySurfaceç»§æ‰¿äºDisplaySurfaceï¼Œå› æ­¤è°ƒç”¨DisplaySurfaceçš„prepareFrameæ–¹æ³•ï¼ŒDisplaySurfaceçš„prepareFrameæ–¹æ³•ç”¨äºå‡†å¤‡å¸§ //frameworks/native/services/surfaceflinger/DisplayHardware/VirtualDisplaySurface.cpp status_t VirtualDisplaySurface::prepareFrame(CompositionType compositionType) { if (GpuVirtualDisplayId::tryCast(mDisplayId)) { return NO_ERROR; } VDS_LOGW_IF(mDebugState != DebugState::Begun, \"Unexpected %s in %s state\", __func__, ftl::enum_string(mDebugState).c_str()); mDebugState = DebugState::Prepared; mCompositionType = compositionType; if (mForceHwcCopy \u0026\u0026 mCompositionType == CompositionType::Gpu) { // Some hardware can do RGB-\u003eYUV conversion more efficiently in ha","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:14","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#hwcomposer-setoutputbuffer-1"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Output finishPrepareFrame è°ƒç”¨Outputçš„finishPrepareFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp void Output::finishPrepareFrame() { const auto\u0026 state = getState(); if (mPlanner) { mPlanner-\u003ereportFinalPlan(getOutputLayersOrderedByZ()); } mRenderSurface-\u003eprepareFrame(state.usesClientComposition, state.usesDeviceComposition); } Planner reportFinalPlan è°ƒç”¨mPlanner(Planner)çš„reportFinalPlanæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Planner.cpp void Planner::reportFinalPlan( compositionengine::Output::OutputLayersEnumerator\u0026\u0026 layers) { ATRACE_CALL(); if (!mPredictorEnabled) { return; } Plan finalPlan; const GraphicBuffer* currentOverrideBuffer = nullptr; bool hasSkippedLayers = false; for (auto layer : layers) { if (!layer-\u003egetState().overrideInfo.buffer) { continue; } const GraphicBuffer* overrideBuffer = layer-\u003egetState().overrideInfo.buffer-\u003egetBuffer().get(); if (overrideBuffer != nullptr \u0026\u0026 overrideBuffer == currentOverrideBuffer) { // Skip this layer since it is part of a previous cached set hasSkippedLayers = true; continue; } currentOverrideBuffer = overrideBuffer; const bool forcedOrRequestedClient = layer-\u003egetState().forceClientComposition || layer-\u003erequiresClientComposition(); finalPlan.addLayerType( forcedOrRequestedClient ? aidl::android::hardware::graphics::composer3::Composition::CLIENT : layer-\u003egetLayerFE().getCompositionState()-\u003ecompositionType); } mPredictor.recordResult(mPredictedPlan, mFlattenedHash, mCurrentLayers, hasSkippedLayers, finalPlan); } è°ƒç”¨mPredictor(Predictor)çš„recordResultæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/Predictor.cpp void Predictor::recordResult(std::optional predictedPlan, NonBufferHash flattenedHash, const std::vector\u0026 layers, bool hasSkippedLayers, Plan result) { if (predictedPlan) { recordPredictedResult(*predictedPlan, layers, std::move(result)); return; } ++mMissCount; if (!hasSkippedLayers \u0026\u0026 findSimilarPrediction(layers, result)) { return; } ALOGV(\"[%s] Adding novel candidate %zx\", __func__, flattenedHash); mCandidates.emplace_front(flattenedHash, Prediction(layers, result)); if (mCandidates.size() \u003e MAX_CANDIDATES) { mCandidates.pop_back(); } } RenderSurface prepareFrame è°ƒç”¨RenderSurfaceçš„prepareFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/CompositionEngin/src/RenderSurface.cpp const sp mDisplaySurface; void RenderSurface::prepareFrame(bool usesClientComposition, bool usesDeviceComposition) { const auto compositionType = [=] { using CompositionType = DisplaySurface::CompositionType; if (usesClientComposition \u0026\u0026 usesDeviceComposition) return CompositionType::Mixed; if (usesClientComposition) return CompositionType::Gpu; if (usesDeviceComposition) return CompositionType::Hwc; // Nothing to do -- when turning the screen off we get a frame like // this. Call it a HWC frame since we won't be doing any GPU work but // will do a prepare/set cycle. return CompositionType::Hwc; }(); if (status_t result = mDisplaySurface-\u003eprepareFrame(compositionType); result != NO_ERROR) { ALOGE(\"updateCompositionType failed for %s: %d (%s)\", mDisplay.getName().c_str(), result, strerror(-result)); } } VirtualDisplaySurface prepareFrame è°ƒç”¨mDisplaySurface(DisplaySurface)çš„prepareFrameæ–¹æ³•ï¼ŒVirtualDisplaySurfaceç»§æ‰¿äºDisplaySurfaceï¼Œå› æ­¤è°ƒç”¨DisplaySurfaceçš„prepareFrameæ–¹æ³•ï¼ŒDisplaySurfaceçš„prepareFrameæ–¹æ³•ç”¨äºå‡†å¤‡å¸§ //frameworks/native/services/surfaceflinger/DisplayHardware/VirtualDisplaySurface.cpp status_t VirtualDisplaySurface::prepareFrame(CompositionType compositionType) { if (GpuVirtualDisplayId::tryCast(mDisplayId)) { return NO_ERROR; } VDS_LOGW_IF(mDebugState != DebugState::Begun, \"Unexpected %s in %s state\", __func__, ftl::enum_string(mDebugState).c_str()); mDebugState = DebugState::Prepared; mCompositionType = compositionType; if (mForceHwcCopy \u0026\u0026 mCompositionType == CompositionType::Gpu) { // Some hardware can do RGB-\u003eYUV conversion more efficiently in ha","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:3:14","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#hwc2display-setoutputbuffer-2"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"onComposerHalHotplugæ˜¯ä¸€ä¸ªAndroidç³»ç»Ÿä¸­çš„ä¸€ä¸ªäº‹ä»¶å›è°ƒå‡½æ•°ï¼Œç”¨äºå¤„ç†Composer HALï¼ˆHardware Abstraction Layerï¼‰çš„çƒ­æ’æ‹”äº‹ä»¶ã€‚Composer HALæ˜¯Androidç³»ç»Ÿä¸­è´Ÿè´£å¤„ç†å›¾å½¢æ¸²æŸ“å’Œæ˜¾ç¤ºçš„ç¡¬ä»¶æŠ½è±¡å±‚ï¼Œå®ƒä¸ç¡¬ä»¶é©±åŠ¨ç¨‹åºå’Œå›¾å½¢æœåŠ¡ä¹‹é—´è¿›è¡Œé€šä¿¡ã€‚ å½“å‘ç”ŸComposer HALçš„çƒ­æ’æ‹”äº‹ä»¶æ—¶ï¼Œç³»ç»Ÿä¼šè°ƒç”¨onComposerHalHotplugå‡½æ•°æ¥é€šçŸ¥ç›¸å…³çš„åº”ç”¨ç¨‹åºã€‚è¿™ä¸ªå‡½æ•°å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­å®ç°ï¼Œä»¥ä¾¿åœ¨çƒ­æ’æ‹”äº‹ä»¶å‘ç”Ÿæ—¶æ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚ SurfaceFlingerçš„onComposerHalHotplugæ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::onComposerHalHotplug(hal::HWDisplayId hwcDisplayId, hal::Connection connection) { const bool connected = connection == hal::Connection::CONNECTED; ALOGI(\"%s HAL display %\" PRIu64, connected ? \"Connecting\" : \"Disconnecting\", hwcDisplayId); // Only lock if we're not on the main thread. This function is normally // called on a hwbinder thread, but for the primary display it's called on // the main thread with the state lock already held, so don't attempt to // acquire it here. ConditionalLock lock(mStateLock, std::this_thread::get_id() != mMainThreadId); mPendingHotplugEvents.emplace_back(HotplugEvent{hwcDisplayId, connection}); if (std::this_thread::get_id() == mMainThreadId) { // Process all pending hot plug events immediately if we are on the main thread. // å¦‚æœæˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹ä¸Šï¼Œè¯·ç«‹å³å¤„ç†æ‰€æœ‰å¾…å¤„ç†çš„çƒ­æ’æ‹”äº‹ä»¶ã€‚ processDisplayHotplugEventsLocked(); } setTransactionFlags(eDisplayTransactionNeeded); } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-oncomposerhalhotplug%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger onComposerHalHotplugæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-oncomposerhalhotplug%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"SurfaceFlinger processDisplayHotplugEventsLocked è°ƒç”¨SurfaceFlingerçš„processDisplayHotplugEventsLockedæ–¹æ³•ï¼Œå¤„ç†æ‰€æœ‰å¾…å¤„ç†çš„çƒ­æ’æ‹”äº‹ä»¶ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::processDisplayHotplugEventsLocked() { for (const auto\u0026 event : mPendingHotplugEvents) { std::optional\u003cDisplayIdentificationInfo\u003e info = getHwComposer().onHotplug(event.hwcDisplayId, event.connection); if (!info) { continue; } const auto displayId = info-\u003eid; const auto token = mPhysicalDisplayTokens.get(displayId); if (event.connection == hal::Connection::CONNECTED) { auto [supportedModes, activeMode] = loadDisplayModes(displayId); if (!token) { ALOGV(\"Creating display %s\", to_string(displayId).c_str()); DisplayDeviceState state; state.physical = {.id = displayId, .type = getHwComposer().getDisplayConnectionType(displayId), .hwcDisplayId = event.hwcDisplayId, .deviceProductInfo = std::move(info-\u003edeviceProductInfo), .supportedModes = std::move(supportedModes), .activeMode = std::move(activeMode)}; state.isSecure = true; // All physical displays are currently considered secure. state.displayName = std::move(info-\u003ename); sp\u003cIBinder\u003e token = new BBinder(); mCurrentState.displays.add(token, state); mPhysicalDisplayTokens.try_emplace(displayId, std::move(token)); mInterceptor-\u003esaveDisplayCreation(state); } else { ALOGV(\"Recreating display %s\", to_string(displayId).c_str()); auto\u0026 state = mCurrentState.displays.editValueFor(token-\u003eget()); state.sequenceId = DisplayDeviceState{}.sequenceId; // Generate new sequenceId. state.physical-\u003esupportedModes = std::move(supportedModes); state.physical-\u003eactiveMode = std::move(activeMode); if (getHwComposer().updatesDeviceProductInfoOnHotplugReconnect()) { state.physical-\u003edeviceProductInfo = std::move(info-\u003edeviceProductInfo); } } } else { ALOGV(\"Removing display %s\", to_string(displayId).c_str()); if (const ssize_t index = mCurrentState.displays.indexOfKey(token-\u003eget()); index \u003e= 0) { const DisplayDeviceState\u0026 state = mCurrentState.displays.valueAt(index); mInterceptor-\u003esaveDisplayDeletion(state.sequenceId); mCurrentState.displays.removeItemsAt(index); } mPhysicalDisplayTokens.erase(displayId); } processDisplayChangesLocked(); } mPendingHotplugEvents.clear(); } è°ƒç”¨processDisplayChangesLockedæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::processDisplayChangesLocked() { // here we take advantage of Vector's copy-on-write semantics to // improve performance by skipping the transaction entirely when // know that the lists are identical const KeyedVector\u003cwp\u003cIBinder\u003e, DisplayDeviceState\u003e\u0026 curr(mCurrentState.displays); const KeyedVector\u003cwp\u003cIBinder\u003e, DisplayDeviceState\u003e\u0026 draw(mDrawingState.displays); if (!curr.isIdenticalTo(draw)) { mVisibleRegionsDirty = true; // find the displays that were removed // (ie: in drawing state but not in current state) // also handle displays that changed // (ie: displays that are in both lists) for (size_t i = 0; i \u003c draw.size(); i++) { const wp\u003cIBinder\u003e\u0026 displayToken = draw.keyAt(i); const ssize_t j = curr.indexOfKey(displayToken); if (j \u003c 0) { // in drawing state but not in current state processDisplayRemoved(displayToken); } else { // this display is in both lists. see if something changed. const DisplayDeviceState\u0026 currentState = curr[j]; const DisplayDeviceState\u0026 drawingState = draw[i]; processDisplayChanged(displayToken, currentState, drawingState); } } // find displays that were added // (ie: in current state but not in drawing state) for (size_t i = 0; i \u003c curr.size(); i++) { const wp\u003cIBinder\u003e\u0026 displayToken = curr.keyAt(i); if (draw.indexOfKey(displayToken) \u003c 0) { processDisplayAdded(displayToken, curr[i]); } } } mDrawingState.displays = mCurrentState.displays; } ä¸Šé¢æ–¹æ³•ä¸»è¦å¤„ç†å¦‚ä¸‹ï¼š 1ã€è°ƒç”¨processDisplayRemovedæ–¹æ³•ã€‚ 2ã€è°ƒç”¨processDisplayChangedæ–¹æ³•ã€‚ 3ã€è°ƒç”¨processDisplayAddedæ–¹æ³•ã€‚ ä¸‹é¢åˆ†åˆ«è¿›è¡Œåˆ†æï¼š ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-oncomposerhalhotplug%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger onComposerHalHotplugæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-oncomposerhalhotplug%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-processdisplayhotplugeventslocked"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"surfaceflinger processDisplayRemoved è°ƒç”¨processDisplayRemovedæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::processDisplayRemoved(const wp\u003cIBinder\u003e\u0026 displayToken) { auto display = getDisplayDeviceLocked(displayToken); if (display) { display-\u003edisconnect(); if (display-\u003eisVirtual()) { releaseVirtualDisplay(display-\u003egetVirtualId()); } else { dispatchDisplayHotplugEvent(display-\u003egetPhysicalId(), false); } } mDisplays.erase(displayToken); if (display \u0026\u0026 display-\u003eisVirtual()) { static_cast\u003cvoid\u003e(mScheduler-\u003eschedule([display = std::move(display)] { // Destroy the display without holding the mStateLock. // This is a temporary solution until we can manage transaction queues without // holding the mStateLock. // With blast, the IGBP that is passed to the VirtualDisplaySurface is owned by the // client. When the IGBP is disconnected, its buffer cache in SF will be cleared // via SurfaceComposerClient::doUncacheBufferTransaction. This call from the client // ends up running on the main thread causing a deadlock since setTransactionstate // will try to acquire the mStateLock. Instead we extend the lifetime of // DisplayDevice and destroy it in the main thread without holding the mStateLock. // The display will be disconnected and removed from the mDisplays list so it will // not be accessible. })); } } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-oncomposerhalhotplug%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger onComposerHalHotplugæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-oncomposerhalhotplug%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-processdisplayremoved"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"surfaceflinger processDisplayChanged è°ƒç”¨processDisplayChangedæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::processDisplayChanged(const wp\u003cIBinder\u003e\u0026 displayToken, const DisplayDeviceState\u0026 currentState, const DisplayDeviceState\u0026 drawingState) { const sp\u003cIBinder\u003e currentBinder = IInterface::asBinder(currentState.surface); const sp\u003cIBinder\u003e drawingBinder = IInterface::asBinder(drawingState.surface); // Recreate the DisplayDevice if the surface or sequence ID changed. if (currentBinder != drawingBinder || currentState.sequenceId != drawingState.sequenceId) { getRenderEngine().cleanFramebufferCache(); if (const auto display = getDisplayDeviceLocked(displayToken)) { display-\u003edisconnect(); if (display-\u003eisVirtual()) { releaseVirtualDisplay(display-\u003egetVirtualId()); } } mDisplays.erase(displayToken); if (const auto\u0026 physical = currentState.physical) { getHwComposer().allocatePhysicalDisplay(physical-\u003ehwcDisplayId, physical-\u003eid); } processDisplayAdded(displayToken, currentState); if (currentState.physical) { const auto display = getDisplayDeviceLocked(displayToken); setPowerModeInternal(display, hal::PowerMode::ON); // TODO(b/175678251) Call a listener instead. if (currentState.physical-\u003ehwcDisplayId == getHwComposer().getPrimaryHwcDisplayId()) { updateInternalDisplayVsyncLocked(display); } } return; } if (const auto display = getDisplayDeviceLocked(displayToken)) { if (currentState.layerStack != drawingState.layerStack) { display-\u003esetLayerStack(currentState.layerStack); } if (currentState.flags != drawingState.flags) { display-\u003esetFlags(currentState.flags); } if ((currentState.orientation != drawingState.orientation) || (currentState.layerStackSpaceRect != drawingState.layerStackSpaceRect) || (currentState.orientedDisplaySpaceRect != drawingState.orientedDisplaySpaceRect)) { display-\u003esetProjection(currentState.orientation, currentState.layerStackSpaceRect, currentState.orientedDisplaySpaceRect); if (isDisplayActiveLocked(display)) { mActiveDisplayTransformHint = display-\u003egetTransformHint(); } } if (currentState.width != drawingState.width || currentState.height != drawingState.height) { display-\u003esetDisplaySize(currentState.width, currentState.height); if (isDisplayActiveLocked(display)) { onActiveDisplaySizeChanged(display); } } } } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-oncomposerhalhotplug%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:2","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger onComposerHalHotplugæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-oncomposerhalhotplug%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-processdisplaychanged"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Surfaceflinger processDisplayAdded è°ƒç”¨processDisplayAddedæ–¹æ³•ï¼š /frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::processDisplayAdded(const wp\u003cIBinder\u003e\u0026 displayToken, const DisplayDeviceState\u0026 state) { ui::Size resolution(0, 0); ui::PixelFormat pixelFormat = static_cast\u003cui::PixelFormat\u003e(PIXEL_FORMAT_UNKNOWN); if (state.physical) { resolution = state.physical-\u003eactiveMode-\u003egetResolution(); pixelFormat = static_cast\u003cui::PixelFormat\u003e(PIXEL_FORMAT_RGBA_8888); } else if (state.surface != nullptr) { int status = state.surface-\u003equery(NATIVE_WINDOW_WIDTH, \u0026resolution.width); ALOGE_IF(status != NO_ERROR, \"Unable to query width (%d)\", status); status = state.surface-\u003equery(NATIVE_WINDOW_HEIGHT, \u0026resolution.height); ALOGE_IF(status != NO_ERROR, \"Unable to query height (%d)\", status); int format; status = state.surface-\u003equery(NATIVE_WINDOW_FORMAT, \u0026format); ALOGE_IF(status != NO_ERROR, \"Unable to query format (%d)\", status); pixelFormat = static_cast\u003cui::PixelFormat\u003e(format); } else { // Virtual displays without a surface are dormant: // they have external state (layer stack, projection, // etc.) but no internal state (i.e. a DisplayDevice). return; } compositionengine::DisplayCreationArgsBuilder builder; if (const auto\u0026 physical = state.physical) { builder.setId(physical-\u003eid); } else { builder.setId(acquireVirtualDisplay(resolution, pixelFormat)); } builder.setPixels(resolution); builder.setIsSecure(state.isSecure); builder.setPowerAdvisor(mPowerAdvisor.get()); builder.setName(state.displayName); auto compositionDisplay = getCompositionEngine().createDisplay(builder.build()); compositionDisplay-\u003esetLayerCachingEnabled(mLayerCachingEnabled); sp\u003ccompositionengine::DisplaySurface\u003e displaySurface; sp\u003cIGraphicBufferProducer\u003e producer; sp\u003cIGraphicBufferProducer\u003e bqProducer; sp\u003cIGraphicBufferConsumer\u003e bqConsumer; getFactory().createBufferQueue(\u0026bqProducer, \u0026bqConsumer, /*consumerIsSurfaceFlinger =*/false); if (state.isVirtual()) { const auto displayId = VirtualDisplayId::tryCast(compositionDisplay-\u003egetId()); LOG_FATAL_IF(!displayId); auto surface = sp\u003cVirtualDisplaySurface\u003e::make(getHwComposer(), *displayId, state.surface, bqProducer, bqConsumer, state.displayName); displaySurface = surface; producer = std::move(surface); } else { ALOGE_IF(state.surface != nullptr, \"adding a supported display, but rendering \" \"surface is provided (%p), ignoring it\", state.surface.get()); const auto displayId = PhysicalDisplayId::tryCast(compositionDisplay-\u003egetId()); LOG_FATAL_IF(!displayId); displaySurface = sp\u003cFramebufferSurface\u003e::make(getHwComposer(), *displayId, bqConsumer, state.physical-\u003eactiveMode-\u003egetResolution(), ui::Size(maxGraphicsWidth, maxGraphicsHeight)); producer = bqProducer; } LOG_FATAL_IF(!displaySurface); auto display = setupNewDisplayDeviceInternal(displayToken, std::move(compositionDisplay), state, displaySurface, producer); if (display-\u003eisPrimary()) { initScheduler(display); } if (!state.isVirtual()) { dispatchDisplayHotplugEvent(display-\u003egetPhysicalId(), true); } mDisplays.try_emplace(displayToken, std::move(display)); } SurfaceFlinger initScheduler è°ƒç”¨initScheduleræ–¹æ³•ï¼Œåˆå§‹åŒ–Schedulerï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp std::unique_ptr\u003cscheduler::Scheduler\u003e mScheduler; void SurfaceFlinger::initScheduler(const sp\u003cDisplayDevice\u003e\u0026 display) { if (mScheduler) { // If the scheduler is already initialized, this means that we received // a hotplug(connected) on the primary display. In that case we should // update the scheduler with the most recent display information. ALOGW(\"Scheduler already initialized, updating instead\"); mScheduler-\u003esetRefreshRateConfigs(display-\u003eholdRefreshRateConfigs()); return; } const auto currRefreshRate = display-\u003egetActiveMode()-\u003egetFps(); mRefreshRateStats = std::make_unique\u003cscheduler::RefreshRateStats\u003e(*mTimeStats, currRefreshRate, hal::PowerMode::OFF); mVsyncConfiguration = getFactory().createVsyncConfiguration(currRefreshRate); mVsyncModulator = sp\u003cVsyncModulator\u003e:","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-oncomposerhalhotplug%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:3","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger onComposerHalHotplugæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-oncomposerhalhotplug%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-processdisplayadded"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Surfaceflinger processDisplayAdded è°ƒç”¨processDisplayAddedæ–¹æ³•ï¼š /frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::processDisplayAdded(const wp\u0026 displayToken, const DisplayDeviceState\u0026 state) { ui::Size resolution(0, 0); ui::PixelFormat pixelFormat = static_cast(PIXEL_FORMAT_UNKNOWN); if (state.physical) { resolution = state.physical-\u003eactiveMode-\u003egetResolution(); pixelFormat = static_cast(PIXEL_FORMAT_RGBA_8888); } else if (state.surface != nullptr) { int status = state.surface-\u003equery(NATIVE_WINDOW_WIDTH, \u0026resolution.width); ALOGE_IF(status != NO_ERROR, \"Unable to query width (%d)\", status); status = state.surface-\u003equery(NATIVE_WINDOW_HEIGHT, \u0026resolution.height); ALOGE_IF(status != NO_ERROR, \"Unable to query height (%d)\", status); int format; status = state.surface-\u003equery(NATIVE_WINDOW_FORMAT, \u0026format); ALOGE_IF(status != NO_ERROR, \"Unable to query format (%d)\", status); pixelFormat = static_cast(format); } else { // Virtual displays without a surface are dormant: // they have external state (layer stack, projection, // etc.) but no internal state (i.e. a DisplayDevice). return; } compositionengine::DisplayCreationArgsBuilder builder; if (const auto\u0026 physical = state.physical) { builder.setId(physical-\u003eid); } else { builder.setId(acquireVirtualDisplay(resolution, pixelFormat)); } builder.setPixels(resolution); builder.setIsSecure(state.isSecure); builder.setPowerAdvisor(mPowerAdvisor.get()); builder.setName(state.displayName); auto compositionDisplay = getCompositionEngine().createDisplay(builder.build()); compositionDisplay-\u003esetLayerCachingEnabled(mLayerCachingEnabled); sp displaySurface; sp producer; sp bqProducer; sp bqConsumer; getFactory().createBufferQueue(\u0026bqProducer, \u0026bqConsumer, /*consumerIsSurfaceFlinger =*/false); if (state.isVirtual()) { const auto displayId = VirtualDisplayId::tryCast(compositionDisplay-\u003egetId()); LOG_FATAL_IF(!displayId); auto surface = sp::make(getHwComposer(), *displayId, state.surface, bqProducer, bqConsumer, state.displayName); displaySurface = surface; producer = std::move(surface); } else { ALOGE_IF(state.surface != nullptr, \"adding a supported display, but rendering \" \"surface is provided (%p), ignoring it\", state.surface.get()); const auto displayId = PhysicalDisplayId::tryCast(compositionDisplay-\u003egetId()); LOG_FATAL_IF(!displayId); displaySurface = sp::make(getHwComposer(), *displayId, bqConsumer, state.physical-\u003eactiveMode-\u003egetResolution(), ui::Size(maxGraphicsWidth, maxGraphicsHeight)); producer = bqProducer; } LOG_FATAL_IF(!displaySurface); auto display = setupNewDisplayDeviceInternal(displayToken, std::move(compositionDisplay), state, displaySurface, producer); if (display-\u003eisPrimary()) { initScheduler(display); } if (!state.isVirtual()) { dispatchDisplayHotplugEvent(display-\u003egetPhysicalId(), true); } mDisplays.try_emplace(displayToken, std::move(display)); } SurfaceFlinger initScheduler è°ƒç”¨initScheduleræ–¹æ³•ï¼Œåˆå§‹åŒ–Schedulerï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp std::unique_ptr mScheduler; void SurfaceFlinger::initScheduler(const sp\u0026 display) { if (mScheduler) { // If the scheduler is already initialized, this means that we received // a hotplug(connected) on the primary display. In that case we should // update the scheduler with the most recent display information. ALOGW(\"Scheduler already initialized, updating instead\"); mScheduler-\u003esetRefreshRateConfigs(display-\u003eholdRefreshRateConfigs()); return; } const auto currRefreshRate = display-\u003egetActiveMode()-\u003egetFps(); mRefreshRateStats = std::make_unique(*mTimeStats, currRefreshRate, hal::PowerMode::OFF); mVsyncConfiguration = getFactory().createVsyncConfiguration(currRefreshRate); mVsyncModulator = sp:","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-oncomposerhalhotplug%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:3","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger onComposerHalHotplugæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-oncomposerhalhotplug%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-initscheduler"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Surfaceflinger processDisplayAdded è°ƒç”¨processDisplayAddedæ–¹æ³•ï¼š /frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::processDisplayAdded(const wp\u0026 displayToken, const DisplayDeviceState\u0026 state) { ui::Size resolution(0, 0); ui::PixelFormat pixelFormat = static_cast(PIXEL_FORMAT_UNKNOWN); if (state.physical) { resolution = state.physical-\u003eactiveMode-\u003egetResolution(); pixelFormat = static_cast(PIXEL_FORMAT_RGBA_8888); } else if (state.surface != nullptr) { int status = state.surface-\u003equery(NATIVE_WINDOW_WIDTH, \u0026resolution.width); ALOGE_IF(status != NO_ERROR, \"Unable to query width (%d)\", status); status = state.surface-\u003equery(NATIVE_WINDOW_HEIGHT, \u0026resolution.height); ALOGE_IF(status != NO_ERROR, \"Unable to query height (%d)\", status); int format; status = state.surface-\u003equery(NATIVE_WINDOW_FORMAT, \u0026format); ALOGE_IF(status != NO_ERROR, \"Unable to query format (%d)\", status); pixelFormat = static_cast(format); } else { // Virtual displays without a surface are dormant: // they have external state (layer stack, projection, // etc.) but no internal state (i.e. a DisplayDevice). return; } compositionengine::DisplayCreationArgsBuilder builder; if (const auto\u0026 physical = state.physical) { builder.setId(physical-\u003eid); } else { builder.setId(acquireVirtualDisplay(resolution, pixelFormat)); } builder.setPixels(resolution); builder.setIsSecure(state.isSecure); builder.setPowerAdvisor(mPowerAdvisor.get()); builder.setName(state.displayName); auto compositionDisplay = getCompositionEngine().createDisplay(builder.build()); compositionDisplay-\u003esetLayerCachingEnabled(mLayerCachingEnabled); sp displaySurface; sp producer; sp bqProducer; sp bqConsumer; getFactory().createBufferQueue(\u0026bqProducer, \u0026bqConsumer, /*consumerIsSurfaceFlinger =*/false); if (state.isVirtual()) { const auto displayId = VirtualDisplayId::tryCast(compositionDisplay-\u003egetId()); LOG_FATAL_IF(!displayId); auto surface = sp::make(getHwComposer(), *displayId, state.surface, bqProducer, bqConsumer, state.displayName); displaySurface = surface; producer = std::move(surface); } else { ALOGE_IF(state.surface != nullptr, \"adding a supported display, but rendering \" \"surface is provided (%p), ignoring it\", state.surface.get()); const auto displayId = PhysicalDisplayId::tryCast(compositionDisplay-\u003egetId()); LOG_FATAL_IF(!displayId); displaySurface = sp::make(getHwComposer(), *displayId, bqConsumer, state.physical-\u003eactiveMode-\u003egetResolution(), ui::Size(maxGraphicsWidth, maxGraphicsHeight)); producer = bqProducer; } LOG_FATAL_IF(!displaySurface); auto display = setupNewDisplayDeviceInternal(displayToken, std::move(compositionDisplay), state, displaySurface, producer); if (display-\u003eisPrimary()) { initScheduler(display); } if (!state.isVirtual()) { dispatchDisplayHotplugEvent(display-\u003egetPhysicalId(), true); } mDisplays.try_emplace(displayToken, std::move(display)); } SurfaceFlinger initScheduler è°ƒç”¨initScheduleræ–¹æ³•ï¼Œåˆå§‹åŒ–Schedulerï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp std::unique_ptr mScheduler; void SurfaceFlinger::initScheduler(const sp\u0026 display) { if (mScheduler) { // If the scheduler is already initialized, this means that we received // a hotplug(connected) on the primary display. In that case we should // update the scheduler with the most recent display information. ALOGW(\"Scheduler already initialized, updating instead\"); mScheduler-\u003esetRefreshRateConfigs(display-\u003eholdRefreshRateConfigs()); return; } const auto currRefreshRate = display-\u003egetActiveMode()-\u003egetFps(); mRefreshRateStats = std::make_unique(*mTimeStats, currRefreshRate, hal::PowerMode::OFF); mVsyncConfiguration = getFactory().createVsyncConfiguration(currRefreshRate); mVsyncModulator = sp:","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-oncomposerhalhotplug%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:3","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger onComposerHalHotplugæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-oncomposerhalhotplug%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#new-scheduler"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Surfaceflinger processDisplayAdded è°ƒç”¨processDisplayAddedæ–¹æ³•ï¼š /frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::processDisplayAdded(const wp\u0026 displayToken, const DisplayDeviceState\u0026 state) { ui::Size resolution(0, 0); ui::PixelFormat pixelFormat = static_cast(PIXEL_FORMAT_UNKNOWN); if (state.physical) { resolution = state.physical-\u003eactiveMode-\u003egetResolution(); pixelFormat = static_cast(PIXEL_FORMAT_RGBA_8888); } else if (state.surface != nullptr) { int status = state.surface-\u003equery(NATIVE_WINDOW_WIDTH, \u0026resolution.width); ALOGE_IF(status != NO_ERROR, \"Unable to query width (%d)\", status); status = state.surface-\u003equery(NATIVE_WINDOW_HEIGHT, \u0026resolution.height); ALOGE_IF(status != NO_ERROR, \"Unable to query height (%d)\", status); int format; status = state.surface-\u003equery(NATIVE_WINDOW_FORMAT, \u0026format); ALOGE_IF(status != NO_ERROR, \"Unable to query format (%d)\", status); pixelFormat = static_cast(format); } else { // Virtual displays without a surface are dormant: // they have external state (layer stack, projection, // etc.) but no internal state (i.e. a DisplayDevice). return; } compositionengine::DisplayCreationArgsBuilder builder; if (const auto\u0026 physical = state.physical) { builder.setId(physical-\u003eid); } else { builder.setId(acquireVirtualDisplay(resolution, pixelFormat)); } builder.setPixels(resolution); builder.setIsSecure(state.isSecure); builder.setPowerAdvisor(mPowerAdvisor.get()); builder.setName(state.displayName); auto compositionDisplay = getCompositionEngine().createDisplay(builder.build()); compositionDisplay-\u003esetLayerCachingEnabled(mLayerCachingEnabled); sp displaySurface; sp producer; sp bqProducer; sp bqConsumer; getFactory().createBufferQueue(\u0026bqProducer, \u0026bqConsumer, /*consumerIsSurfaceFlinger =*/false); if (state.isVirtual()) { const auto displayId = VirtualDisplayId::tryCast(compositionDisplay-\u003egetId()); LOG_FATAL_IF(!displayId); auto surface = sp::make(getHwComposer(), *displayId, state.surface, bqProducer, bqConsumer, state.displayName); displaySurface = surface; producer = std::move(surface); } else { ALOGE_IF(state.surface != nullptr, \"adding a supported display, but rendering \" \"surface is provided (%p), ignoring it\", state.surface.get()); const auto displayId = PhysicalDisplayId::tryCast(compositionDisplay-\u003egetId()); LOG_FATAL_IF(!displayId); displaySurface = sp::make(getHwComposer(), *displayId, bqConsumer, state.physical-\u003eactiveMode-\u003egetResolution(), ui::Size(maxGraphicsWidth, maxGraphicsHeight)); producer = bqProducer; } LOG_FATAL_IF(!displaySurface); auto display = setupNewDisplayDeviceInternal(displayToken, std::move(compositionDisplay), state, displaySurface, producer); if (display-\u003eisPrimary()) { initScheduler(display); } if (!state.isVirtual()) { dispatchDisplayHotplugEvent(display-\u003egetPhysicalId(), true); } mDisplays.try_emplace(displayToken, std::move(display)); } SurfaceFlinger initScheduler è°ƒç”¨initScheduleræ–¹æ³•ï¼Œåˆå§‹åŒ–Schedulerï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp std::unique_ptr mScheduler; void SurfaceFlinger::initScheduler(const sp\u0026 display) { if (mScheduler) { // If the scheduler is already initialized, this means that we received // a hotplug(connected) on the primary display. In that case we should // update the scheduler with the most recent display information. ALOGW(\"Scheduler already initialized, updating instead\"); mScheduler-\u003esetRefreshRateConfigs(display-\u003eholdRefreshRateConfigs()); return; } const auto currRefreshRate = display-\u003egetActiveMode()-\u003egetFps(); mRefreshRateStats = std::make_unique(*mTimeStats, currRefreshRate, hal::PowerMode::OFF); mVsyncConfiguration = getFactory().createVsyncConfiguration(currRefreshRate); mVsyncModulator = sp:","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-oncomposerhalhotplug%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:3","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger onComposerHalHotplugæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-oncomposerhalhotplug%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#scheduler-createconnection"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"onComposerHalVsyncæ˜¯ä¸€ä¸ªAndroidç³»ç»Ÿä¸­çš„ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œç”¨äºåœ¨å‚ç›´åŒæ­¥ï¼ˆVsyncï¼‰äº‹ä»¶å‘ç”Ÿæ—¶é€šçŸ¥åº”ç”¨ç¨‹åºã€‚Vsyncæ˜¯æŒ‡æ˜¾ç¤ºå™¨åˆ·æ–°çš„æ—¶é—´ç‚¹ï¼Œå®ƒé€šå¸¸ä»¥å›ºå®šçš„é¢‘ç‡å‘ç”Ÿï¼Œæ¯”å¦‚60Hzã€‚åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡æ³¨å†ŒonComposerHalVsyncå›è°ƒå‡½æ•°æ¥è·å–Vsyncäº‹ä»¶çš„é€šçŸ¥ã€‚ å½“Vsyncäº‹ä»¶å‘ç”Ÿæ—¶ï¼Œç³»ç»Ÿä¼šè°ƒç”¨æ³¨å†Œäº†onComposerHalVsyncå›è°ƒå‡½æ•°çš„åº”ç”¨ç¨‹åºï¼Œå¹¶ä¼ é€’ä¸€ä¸ªæ—¶é—´æˆ³å‚æ•°ï¼Œè¡¨ç¤ºVsyncäº‹ä»¶å‘ç”Ÿçš„æ—¶é—´ç‚¹ã€‚åº”ç”¨ç¨‹åºå¯ä»¥åˆ©ç”¨è¿™ä¸ªæ—¶é—´æˆ³æ¥è¿›è¡Œä¸€äº›ä¸æ˜¾ç¤ºç›¸å…³çš„æ“ä½œï¼Œæ¯”å¦‚æ›´æ–°UIç•Œé¢æˆ–è€…è¿›è¡ŒåŠ¨ç”»æ•ˆæœçš„è®¡ç®—ã€‚ onComposerHalVsyncå‡½æ•°é€šå¸¸æ˜¯åœ¨åº•å±‚ç¡¬ä»¶æŠ½è±¡å±‚ï¼ˆHALï¼‰ä¸­å®ç°çš„ï¼Œå®ƒä¸å…·ä½“çš„ç¡¬ä»¶è®¾å¤‡ç›¸å…³ã€‚åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡è°ƒç”¨ç³»ç»Ÿæä¾›çš„APIæ¥æ³¨å†Œå’Œå–æ¶ˆonComposerHalVsyncå›è°ƒå‡½æ•°ã€‚ SurfaceFlingerçš„onComposerHalVsyncæ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š //frameworks/native/services/surfaceflinger/Surfaceflinger.cpp void SurfaceFlinger::onComposerHalVsync(hal::HWDisplayId hwcDisplayId, int64_t timestamp, std::optional\u003chal::VsyncPeriodNanos\u003e vsyncPeriod) { const std::string tracePeriod = [vsyncPeriod]() { if (ATRACE_ENABLED() \u0026\u0026 vsyncPeriod) { std::stringstream ss; ss \u003c\u003c \"(\" \u003c\u003c *vsyncPeriod \u003c\u003c \")\"; return ss.str(); } return std::string(); }(); ATRACE_FORMAT(\"onComposerHalVsync%s\", tracePeriod.c_str()); Mutex::Autolock lock(mStateLock); const auto displayId = getHwComposer().toPhysicalDisplayId(hwcDisplayId); if (displayId) { const auto token = getPhysicalDisplayTokenLocked(*displayId); const auto display = getDisplayDeviceLocked(token); display-\u003eonVsync(timestamp); } if (!getHwComposer().onVsync(hwcDisplayId, timestamp)) { return; } const bool isActiveDisplay = displayId \u0026\u0026 getPhysicalDisplayTokenLocked(*displayId) == mActiveDisplayToken; if (!isActiveDisplay) { // For now, we don't do anything with non active display vsyncs. return; } bool periodFlushed = false; mScheduler-\u003eaddResyncSample(timestamp, vsyncPeriod, \u0026periodFlushed); if (periodFlushed) { modulateVsync(\u0026VsyncModulator::onRefreshRateChangeCompleted); } } è°ƒç”¨modulateVsyncæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/SurfaceFlinger.h class SurfaceFlinger : public BnSurfaceComposer, public PriorityDumper, private IBinder::DeathRecipient, private HWC2::ComposerCallback, private ICompositor, private scheduler::ISchedulerCallback { class BufferCountTracker { void modulateVsync(Handler handler, Args... args) { if (const auto config = (*mVsyncModulator.*handler)(args...)) { const auto vsyncPeriod = mScheduler-\u003egetVsyncPeriodFromRefreshRateConfigs(); setVsyncConfig(*config, vsyncPeriod); } } } è°ƒç”¨setVsyncConfigæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp std::unique_ptr\u003cscheduler::Scheduler\u003e mScheduler; void SurfaceFlinger::setVsyncConfig(const VsyncModulator::VsyncConfig\u0026 config, nsecs_t vsyncPeriod) { mScheduler-\u003esetDuration(mAppConnectionHandle, /*workDuration=*/config.appWorkDuration, /*readyDuration=*/config.sfWorkDuration); mScheduler-\u003esetDuration(mSfConnectionHandle, /*workDuration=*/std::chrono::nanoseconds(vsyncPeriod), /*readyDuration=*/config.sfWorkDuration); mScheduler-\u003esetDuration(config.sfWorkDuration); } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-oncomposerhalvsync%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger onComposerHalVsyncæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-oncomposerhalvsync%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"Scheduler setDuration è°ƒç”¨Schedulerçš„setDurationæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Scheduler/Scheduler.cpp void Scheduler::setDuration(ConnectionHandle handle, std::chrono::nanoseconds workDuration, std::chrono::nanoseconds readyDuration) { android::EventThread* thread; { std::lock_guard\u003cstd::mutex\u003e lock(mConnectionsLock); RETURN_IF_INVALID_HANDLE(handle); thread = mConnections[handle].thread.get(); } thread-\u003esetDuration(workDuration, readyDuration); } ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-oncomposerhalvsync%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger onComposerHalVsyncæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-oncomposerhalvsync%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#scheduler-setduration"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"EventThread setDuration è°ƒç”¨EventThreadçš„setDurationæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Scheduler/EventThread.cpp const std::unique_ptr\u003cVSyncSource\u003e mVSyncSource GUARDED_BY(mMutex); void EventThread::setDuration(std::chrono::nanoseconds workDuration, std::chrono::nanoseconds readyDuration) { std::lock_guard\u003cstd::mutex\u003e lock(mMutex); mVSyncSource-\u003esetDuration(workDuration, readyDuration); } è°ƒç”¨mVSyncSource(VSyncSource)çš„setDurationæ–¹æ³•ï¼ŒDispSyncSourceç»§æ‰¿VSyncSourceï¼Œè°ƒç”¨DispSyncSourceçš„setDurationæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Scheduler/DispSyncSource.cpp class DispSyncSource final : public VSyncSource { void DispSyncSource::setDuration(std::chrono::nanoseconds workDuration, std::chrono::nanoseconds readyDuration) { std::lock_guard lock(mVsyncMutex); mWorkDuration = workDuration; mReadyDuration = readyDuration; // If we're not enabled, we don't need to mess with the listeners if (!mEnabled) { return; } mCallbackRepeater-\u003estart(mWorkDuration, mReadyDuration); } } mCallbackRepeaterçš„mRegistrationç»‘å®šçš„æ˜¯DispSyncSource::onVsyncCallbackï¼Œå› æ­¤startæ–¹æ³•æœ€åä¼šæ‰§è¡Œè¿™ä¸ªonVsyncCallbackï¼š //frameworks/native/services/surfaceflinger/Scheduler/DispSyncSource.cpp void DispSyncSource::onVsyncCallback(nsecs_t vsyncTime, nsecs_t targetWakeupTime, nsecs_t readyTime) { VSyncSource::Callback* callback; { std::lock_guard lock(mCallbackMutex); callback = mCallback; } if (callback != nullptr) { callback-\u003eonVSyncEvent(targetWakeupTime, vsyncTime, readyTime); } } EventThread onVSyncEvent è¿›è€Œæ‰§è¡Œåˆ°DispSyncSource.mCallback.onVSyncEventæ–¹æ³•ï¼Œè€ŒDispSyncSource.mCallbackçš„callbackå®è´¨æ˜¯EventThread,æ‰€ä»¥å›è°ƒå°†è¿›å…¥åˆ°EventThread.onVSyncEventæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Scheduler/EventThread.cpp void EventThread::onVSyncEvent(nsecs_t timestamp, VSyncSource::VSyncData vsyncData) { std::lock_guard\u003cstd::mutex\u003e lock(mMutex); LOG_FATAL_IF(!mVSyncState); mPendingEvents.push_back(makeVSync(mVSyncState-\u003edisplayId, timestamp, ++mVSyncState-\u003ecount, vsyncData.expectedPresentationTime, vsyncData.deadlineTimestamp)); mCondition.notify_all(); } EventThread threadMain è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè°ƒç”¨äº†makeVSyncç”Ÿæˆä¸€ä¸ªEventå¹¶åŠ å…¥åˆ°mPendingEventsåé¢ï¼Œç„¶åè°ƒç”¨mCondition.notify_all()ï¼Œé€šçŸ¥ç­‰å¾…çš„çº¿ç¨‹ï¼Œç»§ç»­æ‰§è¡ŒEventçš„åˆ†å‘æ–¹æ³•threadMainï¼š Android13 EventThread threadMainæµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-oncomposerhalvsync%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger onComposerHalVsyncæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-oncomposerhalvsync%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#eventthread-setduration"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"EventThread setDuration è°ƒç”¨EventThreadçš„setDurationæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Scheduler/EventThread.cpp const std::unique_ptr mVSyncSource GUARDED_BY(mMutex); void EventThread::setDuration(std::chrono::nanoseconds workDuration, std::chrono::nanoseconds readyDuration) { std::lock_guard lock(mMutex); mVSyncSource-\u003esetDuration(workDuration, readyDuration); } è°ƒç”¨mVSyncSource(VSyncSource)çš„setDurationæ–¹æ³•ï¼ŒDispSyncSourceç»§æ‰¿VSyncSourceï¼Œè°ƒç”¨DispSyncSourceçš„setDurationæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Scheduler/DispSyncSource.cpp class DispSyncSource final : public VSyncSource { void DispSyncSource::setDuration(std::chrono::nanoseconds workDuration, std::chrono::nanoseconds readyDuration) { std::lock_guard lock(mVsyncMutex); mWorkDuration = workDuration; mReadyDuration = readyDuration; // If we're not enabled, we don't need to mess with the listeners if (!mEnabled) { return; } mCallbackRepeater-\u003estart(mWorkDuration, mReadyDuration); } } mCallbackRepeaterçš„mRegistrationç»‘å®šçš„æ˜¯DispSyncSource::onVsyncCallbackï¼Œå› æ­¤startæ–¹æ³•æœ€åä¼šæ‰§è¡Œè¿™ä¸ªonVsyncCallbackï¼š //frameworks/native/services/surfaceflinger/Scheduler/DispSyncSource.cpp void DispSyncSource::onVsyncCallback(nsecs_t vsyncTime, nsecs_t targetWakeupTime, nsecs_t readyTime) { VSyncSource::Callback* callback; { std::lock_guard lock(mCallbackMutex); callback = mCallback; } if (callback != nullptr) { callback-\u003eonVSyncEvent(targetWakeupTime, vsyncTime, readyTime); } } EventThread onVSyncEvent è¿›è€Œæ‰§è¡Œåˆ°DispSyncSource.mCallback.onVSyncEventæ–¹æ³•ï¼Œè€ŒDispSyncSource.mCallbackçš„callbackå®è´¨æ˜¯EventThread,æ‰€ä»¥å›è°ƒå°†è¿›å…¥åˆ°EventThread.onVSyncEventæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Scheduler/EventThread.cpp void EventThread::onVSyncEvent(nsecs_t timestamp, VSyncSource::VSyncData vsyncData) { std::lock_guard lock(mMutex); LOG_FATAL_IF(!mVSyncState); mPendingEvents.push_back(makeVSync(mVSyncState-\u003edisplayId, timestamp, ++mVSyncState-\u003ecount, vsyncData.expectedPresentationTime, vsyncData.deadlineTimestamp)); mCondition.notify_all(); } EventThread threadMain è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè°ƒç”¨äº†makeVSyncç”Ÿæˆä¸€ä¸ªEventå¹¶åŠ å…¥åˆ°mPendingEventsåé¢ï¼Œç„¶åè°ƒç”¨mCondition.notify_all()ï¼Œé€šçŸ¥ç­‰å¾…çš„çº¿ç¨‹ï¼Œç»§ç»­æ‰§è¡ŒEventçš„åˆ†å‘æ–¹æ³•threadMainï¼š Android13 EventThread threadMainæµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-oncomposerhalvsync%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger onComposerHalVsyncæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-oncomposerhalvsync%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#eventthread-onvsyncevent"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"EventThread setDuration è°ƒç”¨EventThreadçš„setDurationæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Scheduler/EventThread.cpp const std::unique_ptr mVSyncSource GUARDED_BY(mMutex); void EventThread::setDuration(std::chrono::nanoseconds workDuration, std::chrono::nanoseconds readyDuration) { std::lock_guard lock(mMutex); mVSyncSource-\u003esetDuration(workDuration, readyDuration); } è°ƒç”¨mVSyncSource(VSyncSource)çš„setDurationæ–¹æ³•ï¼ŒDispSyncSourceç»§æ‰¿VSyncSourceï¼Œè°ƒç”¨DispSyncSourceçš„setDurationæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Scheduler/DispSyncSource.cpp class DispSyncSource final : public VSyncSource { void DispSyncSource::setDuration(std::chrono::nanoseconds workDuration, std::chrono::nanoseconds readyDuration) { std::lock_guard lock(mVsyncMutex); mWorkDuration = workDuration; mReadyDuration = readyDuration; // If we're not enabled, we don't need to mess with the listeners if (!mEnabled) { return; } mCallbackRepeater-\u003estart(mWorkDuration, mReadyDuration); } } mCallbackRepeaterçš„mRegistrationç»‘å®šçš„æ˜¯DispSyncSource::onVsyncCallbackï¼Œå› æ­¤startæ–¹æ³•æœ€åä¼šæ‰§è¡Œè¿™ä¸ªonVsyncCallbackï¼š //frameworks/native/services/surfaceflinger/Scheduler/DispSyncSource.cpp void DispSyncSource::onVsyncCallback(nsecs_t vsyncTime, nsecs_t targetWakeupTime, nsecs_t readyTime) { VSyncSource::Callback* callback; { std::lock_guard lock(mCallbackMutex); callback = mCallback; } if (callback != nullptr) { callback-\u003eonVSyncEvent(targetWakeupTime, vsyncTime, readyTime); } } EventThread onVSyncEvent è¿›è€Œæ‰§è¡Œåˆ°DispSyncSource.mCallback.onVSyncEventæ–¹æ³•ï¼Œè€ŒDispSyncSource.mCallbackçš„callbackå®è´¨æ˜¯EventThread,æ‰€ä»¥å›è°ƒå°†è¿›å…¥åˆ°EventThread.onVSyncEventæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Scheduler/EventThread.cpp void EventThread::onVSyncEvent(nsecs_t timestamp, VSyncSource::VSyncData vsyncData) { std::lock_guard lock(mMutex); LOG_FATAL_IF(!mVSyncState); mPendingEvents.push_back(makeVSync(mVSyncState-\u003edisplayId, timestamp, ++mVSyncState-\u003ecount, vsyncData.expectedPresentationTime, vsyncData.deadlineTimestamp)); mCondition.notify_all(); } EventThread threadMain è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè°ƒç”¨äº†makeVSyncç”Ÿæˆä¸€ä¸ªEventå¹¶åŠ å…¥åˆ°mPendingEventsåé¢ï¼Œç„¶åè°ƒç”¨mCondition.notify_all()ï¼Œé€šçŸ¥ç­‰å¾…çš„çº¿ç¨‹ï¼Œç»§ç»­æ‰§è¡ŒEventçš„åˆ†å‘æ–¹æ³•threadMainï¼š Android13 EventThread threadMainæµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-oncomposerhalvsync%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:1","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger onComposerHalVsyncæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-oncomposerhalvsync%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#eventthread-threadmain"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"SurfaceFlingerçš„onLayerUpdateæ–¹æ³•ç”¨äºåœ¨å›¾å½¢å±‚æ›´æ–°æ—¶è¿›è¡Œç›¸åº”çš„å¤„ç†ï¼Œä»£ç å¦‚ä¸‹ï¼š void SurfaceFlinger::onLayerUpdate() { scheduleCommit(FrameHint::kActive); } è°ƒç”¨SurfaceFlingerçš„scheduleCommitæ–¹æ³•ï¼š //frameworks/native/service/surfaceflinger/SurfaeFlinger.cpp std::unique_ptr\u003cscheduler::Scheduler\u003e mScheduler; void SurfaceFlinger::scheduleCommit(FrameHint hint) { if (hint == FrameHint::kActive) { mScheduler-\u003eresetIdleTimer(); } mPowerAdvisor-\u003enotifyDisplayUpdateImminent(); mScheduler-\u003escheduleFrame(); } è°ƒç”¨mScheduler(Scheduler)çš„scheduleFrameæ–¹æ³•ï¼ŒSchedulerç»§æ‰¿äºMessageQueueï¼Œè°ƒç”¨MessageQueueçš„scheduleFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Scheduler/MessageQueue.cpp Vsync mVsync; std::unique_ptr\u003cscheduler::VSyncCallbackRegistration\u003e registration; void MessageQueue::scheduleFrame() { ATRACE_CALL(); { std::lock_guard lock(mInjector.mutex); if (CC_UNLIKELY(mInjector.connection)) { ALOGD(\"%s while injecting VSYNC\", __FUNCTION__); mInjector.connection-\u003erequestNextVsync(); return; } } std::lock_guard lock(mVsync.mutex); mVsync.scheduledFrameTime = mVsync.registration-\u003eschedule({.workDuration = mVsync.workDuration.get().count(), .readyDuration = 0, .earliestVsync = mVsync.lastCallbackTime.count()}); } è°ƒç”¨mVsync(Vsync)æˆå‘˜å˜é‡registrationçš„scheduleæ–¹æ³•ï¼Œè€ŒmVsync.registrationåœ¨MessageQueueçš„initVsyncä¸­æ³¨å†Œï¼š //frameworks/native/services/surfaceflinger/Scheduler/MessageQueue.cpp void MessageQueue::initVsync(scheduler::VSyncDispatch\u0026 dispatch, frametimeline::TokenManager\u0026 tokenManager, std::chrono::nanoseconds workDuration) { setDuration(workDuration); mVsync.tokenManager = \u0026tokenManager; mVsync.registration = std::make_unique\u003c scheduler::VSyncCallbackRegistration\u003e(dispatch, std::bind(\u0026MessageQueue::vsyncCallback, this, std::placeholders::_1, std::placeholders::_2, std::placeholders::_3), \"sf\"); } å› æ­¤ä¼šè°ƒç”¨åˆ°MessageQueueçš„vsyncCallbackæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Scheduler/MessageQueue.cpp void MessageQueue::vsyncCallback(nsecs_t vsyncTime, nsecs_t targetWakeupTime, nsecs_t readyTime) { ATRACE_CALL(); // Trace VSYNC-sf mVsync.value = (mVsync.value + 1) % 2; { std::lock_guard lock(mVsync.mutex); mVsync.lastCallbackTime = std::chrono::nanoseconds(vsyncTime); mVsync.scheduledFrameTime.reset(); } const auto vsyncId = mVsync.tokenManager-\u003egenerateTokenForPredictions( {targetWakeupTime, readyTime, vsyncTime}); mHandler-\u003edispatchFrame(vsyncId, vsyncTime); } è°ƒç”¨Handlerçš„dispatchFrameæ–¹æ³•ï¼š //frameworks/native/services/surfaceflinger/Scheduler/MessageQueue.cpp void MessageQueue::Handler::dispatchFrame(int64_t vsyncId, nsecs_t expectedVsyncTime) { if (!mFramePending.exchange(true)) { mVsyncId = vsyncId; mExpectedVsyncTime = expectedVsyncTime; mQueue.mLooper-\u003esendMessage(this, Message()); } } å‘é€Messageï¼Œæ¶ˆæ¯åœ¨Handlerçš„handleMessageæ–¹æ³•ä¸­å¤„ç†ï¼š //frameworks/native/services/surfaceflinger/Scheduler/MessageQueue.cpp ICompositor\u0026 mCompositor; void MessageQueue::Handler::handleMessage(const Message\u0026) { mFramePending.store(false); const nsecs_t frameTime = systemTime(); auto\u0026 compositor = mQueue.mCompositor; if (!compositor.commit(frameTime, mVsyncId, mExpectedVsyncTime)) { return; } compositor.composite(frameTime, mVsyncId); compositor.sample(); } ä¸Šé¢æ–¹æ³•ä¸»è¦å¤„ç†å¦‚ä¸‹ï¼š 1ã€è°ƒç”¨mCompositor(ICompositor)çš„commitæ–¹æ³•ã€‚ 2ã€è°ƒç”¨mCompositor(ICompositor)çš„compositeæ–¹æ³•ã€‚ ä¸‹é¢åˆ†åˆ«è¿›è¡Œåˆ†æï¼š ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-onlayerupdate%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger onLayerUpdateæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-onlayerupdate%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"SurfaceFlinger commit è°ƒç”¨mCompositor(ICompositor)çš„commitæ–¹æ³•ï¼ŒICompositoræ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”±SurfaceFlingerå®ç°ï¼ŒSurfaceFlingerçš„commitæ–¹æ³•ç”¨äºå°†åº”ç”¨ç¨‹åºçš„ç»˜åˆ¶ç»“æœæäº¤åˆ°å±å¹•ä¸Šæ˜¾ç¤ºï¼š Android13 SurfaceFlinger commit(æäº¤)æµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-onlayerupdate%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger onLayerUpdateæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-onlayerupdate%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-commit"},{"categories":null,"collections":"å›¾å½¢æ˜¾ç¤º","content":"SurfaceFlinger composite è°ƒç”¨mCompositor(ICompositor)çš„commitæ–¹æ³•ï¼ŒICompositoræ˜¯ä¸€ä¸ªæ¥å£ï¼Œç”±SurfaceFlingerå®ç°ï¼ŒSurfaceFlingerçš„compositeç”¨äºå°†å¤šä¸ªçª—å£çš„å›¾åƒè¿›è¡Œåˆæˆï¼š Android13 SurfaceFlinger composite(åˆæˆ)æµç¨‹åˆ†æ-CSDNåšå®¢ ","date":"2024-11-06","objectID":"/posts/android13-surfaceflinger-onlayerupdate%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"Android13 SurfaceFlinger onLayerUpdateæµç¨‹åˆ†æ-CSDNåšå®¢","uri":"/posts/android13-surfaceflinger-onlayerupdate%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfaceflinger-composite"},{"categories":null,"collections":"WMS","content":"Android1****4 - WindowManagerServiceä¹‹å®¢æˆ·ç«¯Activity****å¸ƒå±€ ","date":"2024-11-06","objectID":"/posts/android14-windowmanagerservice%E4%B9%8B%E5%AE%A2%E6%88%B7%E7%AB%AFactivity%E5%B8%83%E5%B1%80-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"Android14 - WindowManagerServiceä¹‹å®¢æˆ·ç«¯Activityå¸ƒå±€-CSDNåšå®¢","uri":"/posts/android14-windowmanagerservice%E4%B9%8B%E5%AE%A2%E6%88%B7%E7%AB%AFactivity%E5%B8%83%E5%B1%80-csdn%E5%8D%9A%E5%AE%A2/#a---windowmanagerservice"},{"categories":null,"collections":"WMS","content":"ä¸€**ã€ä¸»è¦è§’è‰²** WMSä½œä¸ºä¸€ä¸ªæœåŠ¡ç«¯ï¼Œæœ‰å¤šç§å®¢æˆ·ç«¯ä¸å…¶äº¤äº’çš„åœºæ™¯ã€‚æˆ‘ä»¬ä»¥å¸¸è§çš„Activityä¸ºä¾‹ï¼š Activityï¼šåœ¨ActivityThreadæ„å»ºä¸€ä¸ªActivityåï¼Œä¼šè°ƒç”¨å…¶attachæ–¹æ³•ï¼Œåœ¨attachä¸­æ„å»ºäº†ä¸€ä¸ªPhoneWindowã€‚ PhoneWindowï¼šä¸€ä¸ªActivityå¯¹åº”ä¸€ä¸ªPhoneWindowã€‚è€Œæ¯ä¸ªPhoneWindowæŒæœ‰ä¸€ä¸ªWindowManagerImplå¯¹è±¡ã€‚ WindowManagerImplï¼šæ˜¯æœåŠ¡ç«¯WMSåœ¨å®¢æˆ·ç«¯çš„ä»£ç†ã€‚è€ŒWindowManagerImplä¸­æŒæœ‰WindowManagerGlobalã€‚ WindowManagerGlobalï¼šæ˜¯è¿›ç¨‹å†…çš„å•ä¾‹ã€‚WindowManagerGlobalä¸ä»…æŒæœ‰WMSæœåŠ¡ç«¯çš„WindowManagerServiceã€WindowSessionçš„å¼•ç”¨ï¼Œå¹¶ä¸”é›†åˆäº†æ‰€æœ‰çš„ViewRootImplã€DecorViewç­‰ ViewRootImplï¼šæ¯ä¸ªActivityå¯¹åº”ä¸€ä¸ªViewRootImpå¯¹è±¡ã€‚ViewRootImpæ˜¯ä½œä¸ºå®¢æˆ·ç«¯ä¸WMSçš„æ¡¥æ¢ã€‚ä»å®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯çš„è§’åº¦ï¼ŒViewRootImpä¸­æŒæœ‰çš„WindowSessionå¯¹è±¡æ˜¯æœåŠ¡ç«¯Sessionçš„å¼•ç”¨ï¼Œä¸€ä¸ªSessionå¯¹åº”ä¸€ä¸ªå®¢æˆ·ç«¯è¿›ç¨‹ã€‚ä»æœåŠ¡ç«¯åˆ°å®¢æˆ·ç«¯çš„è§’åº¦ï¼ŒViewRootImpä¸­æœ‰ä¸€ä¸ªå­ç±»Wï¼Œæ˜¯binderé€šä¿¡çš„æœåŠ¡ç«¯ï¼ŒWå¯¹è±¡çš„å¼•ç”¨è¢«WMSæŒæœ‰ï¼Œç”¨æ¥æœåŠ¡ç«¯å‘å®¢æˆ·ç«¯é€šä¿¡ã€‚å¦å¤–ï¼ŒViewRootImpä¸­æŒæœ‰DecorViewå¯¹è±¡ã€‚ä»é€»è¾‘ä¸Šï¼ŒViewRootImplæ˜¯Viewæ ‘çš„æ ¹ï¼Œä½†å…¶æœ¬èº«å¹¶ä¸æ˜¯ä¸€ä¸ªViewï¼Œåªæ˜¯å®ç°äº†ViewParentæ¥å£ã€‚DecorViewæ˜¯ViewRootImpçš„å­ç±»ï¼ˆè§setView()æ–¹æ³•ä¸­çš„view.assignParent(this)ï¼‰ ï¼‰ DecorViewï¼šæ¯ä¸ªActivityå¯¹åº”ä¸€ä¸ªDecorViewã€‚DecorViewæ˜¯çœŸæ­£çš„é¡¶å±‚Viewï¼Œæ˜¯æœ€å¤–å±‚çš„viewã€‚å…¶inflateÂ PhoneWidowä¼ è¿‡æ¥çš„layoutåï¼Œå°†å…¶addViewä½œä¸ºè‡ªå·±çš„ç¬¬0ä¸ªç±»ã€‚DecorViewç»´æŠ¤äº†ä¸€ä¸ªçª—å£çš„åŸºæœ¬ç»“æ„ï¼ŒåŒ…æ‹¬ä¸»å†…å®¹åŒºåŸŸã€titlebaråŒºåŸŸç­‰ã€‚ ","date":"2024-11-06","objectID":"/posts/android14-windowmanagerservice%E4%B9%8B%E5%AE%A2%E6%88%B7%E7%AB%AFactivity%E5%B8%83%E5%B1%80-csdn%E5%8D%9A%E5%AE%A2/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"Android14 - WindowManagerServiceä¹‹å®¢æˆ·ç«¯Activityå¸ƒå±€-CSDNåšå®¢","uri":"/posts/android14-windowmanagerservice%E4%B9%8B%E5%AE%A2%E6%88%B7%E7%AB%AFactivity%E5%B8%83%E5%B1%80-csdn%E5%8D%9A%E5%AE%A2/#ä¸€ä¸»è¦è§’è‰²"},{"categories":null,"collections":"WMS","content":"äºŒ**ã€**çª—å£çš„æ„å»ºè¿‡ç¨‹ çª—å£çš„ç»“æ„å¤§è‡´å¦‚ä¸‹ï¼š å…¶è¿‡ç¨‹å‚è€ƒä¸Šå›¾ï¼Œåœ¨PhoneWindowçš„åˆå§‹åŒ–è¿‡ç¨‹ä¸­ï¼Œè°ƒç”¨äº†generateLayout(DecorViewÂ decor)æ–¹æ³•ï¼Œå…¶ä¸­å¯¹ä¸€ä¸ªwindowçš„æ•´ä½“ç”»é¢è¿›è¡Œäº†åˆå§‹åŒ–ã€‚ protected ViewGroup generateLayout(DecorView decor) { // Apply data from current theme. // Styleæ¥è‡ªäºTheme xmlæ–‡ä»¶ TypedArray a = getWindowStyle(); mIsFloating = a.getBoolean(R.styleable.Window_windowIsFloating, false); int flagsToUpdate = (FLAG_LAYOUT_IN_SCREEN|FLAG_LAYOUT_INSET_DECOR) \u0026 (~getForcedWindowFlags()); if (mIsFloating) { setLayout(WRAP_CONTENT, WRAP_CONTENT); setFlags(0, flagsToUpdate); } else { setFlags(FLAG_LAYOUT_IN_SCREEN|FLAG_LAYOUT_INSET_DECOR, flagsToUpdate); getAttributes().setFitInsetsSides(0); getAttributes().setFitInsetsTypes(0); } if (a.getBoolean(R.styleable.Window_windowNoTitle, false)) { requestFeature(FEATURE_NO_TITLE); } else if (a.getBoolean(R.styleable.Window_windowActionBar, false)) { // Don't allow an action bar if there is no title. requestFeature(FEATURE_ACTION_BAR); } if (a.getBoolean(R.styleable.Window_windowActionBarOverlay, false)) { requestFeature(FEATURE_ACTION_BAR_OVERLAY); } if (a.getBoolean(R.styleable.Window_windowActionModeOverlay, false)) { requestFeature(FEATURE_ACTION_MODE_OVERLAY); } if (a.getBoolean(R.styleable.Window_windowFullscreen, false)) { setFlags(FLAG_FULLSCREEN, FLAG_FULLSCREEN \u0026 (~getForcedWindowFlags())); } if (a.getBoolean(R.styleable.Window_windowTranslucentStatus, false)) { setFlags(FLAG_TRANSLUCENT_STATUS, FLAG_TRANSLUCENT_STATUS \u0026 (~getForcedWindowFlags())); } if (a.getBoolean(R.styleable.Window_windowTranslucentNavigation, false)) { setFlags(FLAG_TRANSLUCENT_NAVIGATION, FLAG_TRANSLUCENT_NAVIGATION \u0026 (~getForcedWindowFlags())); } if (a.getBoolean(R.styleable.Window_windowShowWallpaper, false)) { setFlags(FLAG_SHOW_WALLPAPER, FLAG_SHOW_WALLPAPER\u0026(~getForcedWindowFlags())); } if (a.getBoolean(R.styleable.Window_windowEnableSplitTouch, getContext().getApplicationInfo().targetSdkVersion \u003e= android.os.Build.VERSION_CODES.HONEYCOMB)) { setFlags(FLAG_SPLIT_TOUCH, FLAG_SPLIT_TOUCH\u0026(~getForcedWindowFlags())); } a.getValue(R.styleable.Window_windowMinWidthMajor, mMinWidthMajor); a.getValue(R.styleable.Window_windowMinWidthMinor, mMinWidthMinor); if (DEBUG) Log.d(TAG, \"Min width minor: \" + mMinWidthMinor.coerceToString() + \", major: \" + mMinWidthMajor.coerceToString()); if (a.hasValue(R.styleable.Window_windowFixedWidthMajor)) { if (mFixedWidthMajor == null) mFixedWidthMajor = new TypedValue(); a.getValue(R.styleable.Window_windowFixedWidthMajor, mFixedWidthMajor); } if (a.hasValue(R.styleable.Window_windowFixedWidthMinor)) { if (mFixedWidthMinor == null) mFixedWidthMinor = new TypedValue(); a.getValue(R.styleable.Window_windowFixedWidthMinor, mFixedWidthMinor); } if (a.hasValue(R.styleable.Window_windowFixedHeightMajor)) { if (mFixedHeightMajor == null) mFixedHeightMajor = new TypedValue(); a.getValue(R.styleable.Window_windowFixedHeightMajor, mFixedHeightMajor); } if (a.hasValue(R.styleable.Window_windowFixedHeightMinor)) { if (mFixedHeightMinor == null) mFixedHeightMinor = new TypedValue(); a.getValue(R.styleable.Window_windowFixedHeightMinor, mFixedHeightMinor); } if (a.getBoolean(R.styleable.Window_windowContentTransitions, false)) { requestFeature(FEATURE_CONTENT_TRANSITIONS); } if (a.getBoolean(R.styleable.Window_windowActivityTransitions, false)) { requestFeature(FEATURE_ACTIVITY_TRANSITIONS); } mIsTranslucent = a.getBoolean(R.styleable.Window_windowIsTranslucent, false); final Context context = getContext(); final int targetSdk = context.getApplicationInfo().targetSdkVersion; final boolean targetPreL = targetSdk \u003c android.os.Build.VERSION_CODES.LOLLIPOP; final boolean targetPreQ = targetSdk \u003c Build.VERSION_CODES.Q; if (!mForcedStatusBarColor) { mStatusBarColor = a.getColor(R.styleable.Window_statusBarColor, Color.BLACK); } if (!mForcedNavigationBarColor) { final int navBarCompatibleColor = context.getColor(R.color.navigation_bar_compatible); final int navBarDefaultColor = context.getColor(R.color.navigation_bar_default); final int navBarColor = a.getColo","date":"2024-11-06","objectID":"/posts/android14-windowmanagerservice%E4%B9%8B%E5%AE%A2%E6%88%B7%E7%AB%AFactivity%E5%B8%83%E5%B1%80-csdn%E5%8D%9A%E5%AE%A2/:3:0","tags":["clippings","è½¬è½½","blog"],"title":"Android14 - WindowManagerServiceä¹‹å®¢æˆ·ç«¯Activityå¸ƒå±€-CSDNåšå®¢","uri":"/posts/android14-windowmanagerservice%E4%B9%8B%E5%AE%A2%E6%88%B7%E7%AB%AFactivity%E5%B8%83%E5%B1%80-csdn%E5%8D%9A%E5%AE%A2/#äºŒçª—å£çš„æ„å»ºè¿‡ç¨‹"},{"categories":null,"collections":["æ€§èƒ½ä¼˜åŒ–"],"content":"[TOC] ","date":"2024-11-06","objectID":"/posts/android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96getresources%E4%B8%8Ebinder%E4%BA%A4%E7%81%AB%E5%AF%BC%E8%87%B4%E7%9A%84%E7%95%8C%E9%9D%A2%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96/:0:0","tags":["clippings","è½¬è½½","blog","å¡é¡¿","Trace","Perfetto"],"title":"Androidæ€§èƒ½ä¼˜åŒ–ï¼šgetResources()ä¸Binderäº¤ç«å¯¼è‡´çš„ç•Œé¢å¡é¡¿ä¼˜åŒ–","uri":"/posts/android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96getresources%E4%B8%8Ebinder%E4%BA%A4%E7%81%AB%E5%AF%BC%E8%87%B4%E7%9A%84%E7%95%8C%E9%9D%A2%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96/#"},{"categories":null,"collections":["æ€§èƒ½ä¼˜åŒ–"],"content":"èƒŒæ™¯ æŸè½®æµ‹è¯•å‘ç°ï¼Œæˆ‘ä»¬çš„è®¾å¤‡è¿è¡Œä¸€ä¸ªç¬¬ä¸‰æ–¹çš„Appæ—¶ï¼Œå¡é¡¿æ„Ÿéå¸¸æ˜æ˜¾ï¼š ç•Œé¢åŠ è½½å¾ˆæ…¢ï¼ŒèŠèŠ±è½¬åŠå¤© æ»‘å±æåº¦ä¸è·Ÿæ‰‹ï¼Œç›®æµ‹è§‚æ„Ÿå¸§ç‡ä½äº15 å¯¹æ¯”æœºï¼ˆç«å“ï¼‰ä¹Ÿä¼šç¨å¾®ä¸€ç‚¹å¡ï¼Œä½†æ˜¯å¥½å¾ˆå¤šï¼ŒåŸºæœ¬ä¸ä¼šæœ‰å¾ˆå¤§æ„Ÿè§‰çš„å¡é¡¿ å¯ä»¥åˆæ­¥åˆ¤å®šæˆ‘ä»¬çš„è®¾å¤‡å­˜åœ¨æ€§èƒ½é—®é¢˜ï¼ŒäºŸéœ€ä¼˜åŒ–ï¼Œæ‹‰å¹³åˆ°ç«å“æ°´å‡†ã€‚ æœ€åå‘ç°ï¼Œè¿™ä¸ªé—®é¢˜å®é™…ä¸Šæ˜¯åº”ç”¨è‡ªèº«å¥‡æ€ªçš„å®ç°ï¼ˆgetResources()çš„é‡è½½ï¼‰ï¼ŒåŠ ä¸ŠBinderè¿‡åº¦è°ƒç”¨ï¼ˆæ²‰é‡çš„Binderè€—æ—¶ï¼‰å¯¼è‡´çš„ã€‚ æœ¬æ–‡åšè®°å½•å’Œåˆ†äº«ã€‚ å…¶ä¸­å¯¹æ¯”æœºé…ç½®ã€Androidç‰ˆæœ¬å‡ä¸æœ¬æœºä¸åŒï¼Œä¸åšå˜é‡å‚è€ƒã€‚ ","date":"2024-11-06","objectID":"/posts/android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96getresources%E4%B8%8Ebinder%E4%BA%A4%E7%81%AB%E5%AF%BC%E8%87%B4%E7%9A%84%E7%95%8C%E9%9D%A2%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96/:1:0","tags":["clippings","è½¬è½½","blog","å¡é¡¿","Trace","Perfetto"],"title":"Androidæ€§èƒ½ä¼˜åŒ–ï¼šgetResources()ä¸Binderäº¤ç«å¯¼è‡´çš„ç•Œé¢å¡é¡¿ä¼˜åŒ–","uri":"/posts/android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96getresources%E4%B8%8Ebinder%E4%BA%A4%E7%81%AB%E5%AF%BC%E8%87%B4%E7%9A%84%E7%95%8C%E9%9D%A2%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96/#èƒŒæ™¯"},{"categories":null,"collections":["æ€§èƒ½ä¼˜åŒ–"],"content":"è§‚æµ‹ ç”±äºè¿™ä¸ªå¯çˆ±çš„Appæ˜¯ç¬¬ä¸‰æ–¹çš„Appï¼ˆåº”ç”¨å¸‚åœºä¸‹è½½çš„ï¼‰ï¼Œæˆ‘ä»¬æ²¡æœ‰æºç ï¼Œåªèƒ½ä»ç³»ç»Ÿç«¯å»å¹²æ¶‰ã€‚å…ˆæŠ“ä¸€ä»½traceã€‚ ","date":"2024-11-06","objectID":"/posts/android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96getresources%E4%B8%8Ebinder%E4%BA%A4%E7%81%AB%E5%AF%BC%E8%87%B4%E7%9A%84%E7%95%8C%E9%9D%A2%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96/:2:0","tags":["clippings","è½¬è½½","blog","å¡é¡¿","Trace","Perfetto"],"title":"Androidæ€§èƒ½ä¼˜åŒ–ï¼šgetResources()ä¸Binderäº¤ç«å¯¼è‡´çš„ç•Œé¢å¡é¡¿ä¼˜åŒ–","uri":"/posts/android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96getresources%E4%B8%8Ebinder%E4%BA%A4%E7%81%AB%E5%AF%BC%E8%87%B4%E7%9A%84%E7%95%8C%E9%9D%A2%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96/#è§‚æµ‹"},{"categories":null,"collections":["æ€§èƒ½ä¼˜åŒ–"],"content":"1. traceä½“ç°UIç»˜åˆ¶æ“ä½œä¸¥é‡è€—æ—¶ traceä¸€æŠ“ä¸€çœ‹ï¼Œæ˜¾ç„¶Appä¸»çº¿ç¨‹å·²ç»é™·å…¥å›°å¢ƒã€‚å¯ä»¥çœ‹åˆ°ï¼š CPUä½¿ç”¨ç‡å¹¶ä¸é«˜ ä¸»çº¿ç¨‹å‡ ä¹å®Œå…¨åœ¨æ‰§è¡ŒTraversalå·¥ä½œï¼ˆmersureå’Œlayoutï¼‰ measureå’Œlayoutæåº¦è€—æ—¶ï¼Œæ˜¾ç„¶è¾¾ä¸åˆ°åˆç†çš„å¸§ç‡è¦æ±‚ï¼ˆç”šè‡³è¿PPTå¸§ç‡éƒ½èµ¶ä¸ä¸Šï¼‰ å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä»½traceè¡¨æ˜Appçš„æ•´ä¸ªmeasureå’Œlayoutå·¥ä½œå­˜åœ¨æ•´ä½“æ€§çš„ä¸åˆç†è€—æ—¶ã€‚ä½†å¹¶ä¸èƒ½å‡†ç¡®æç¤ºç»†èŠ‚ï¼Œä¹Ÿä¸èƒ½çœ‹å‡ºé—®é¢˜éƒ¨åˆ†ã€‚å¯ä»¥è‚¯å®šï¼Œè€—æ—¶å·¥ä½œä½äºAppå±‚ï¼ˆä¸æ˜¯æŒ‡è€—æ—¶åŸå› ä¹Ÿæ¥è‡ªAppï¼‰ã€‚ ","date":"2024-11-06","objectID":"/posts/android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96getresources%E4%B8%8Ebinder%E4%BA%A4%E7%81%AB%E5%AF%BC%E8%87%B4%E7%9A%84%E7%95%8C%E9%9D%A2%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96/:3:0","tags":["clippings","è½¬è½½","blog","å¡é¡¿","Trace","Perfetto"],"title":"Androidæ€§èƒ½ä¼˜åŒ–ï¼šgetResources()ä¸Binderäº¤ç«å¯¼è‡´çš„ç•Œé¢å¡é¡¿ä¼˜åŒ–","uri":"/posts/android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96getresources%E4%B8%8Ebinder%E4%BA%A4%E7%81%AB%E5%AF%BC%E8%87%B4%E7%9A%84%E7%95%8C%E9%9D%A2%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96/#1-traceä½“ç°uiç»˜åˆ¶æ“ä½œä¸¥é‡è€—æ—¶"},{"categories":null,"collections":["æ€§èƒ½ä¼˜åŒ–"],"content":"2. æ’æŸ¥measureå’Œlayoutæ…¢çš„åŸå› ï¼šå¯ç–‘çš„å¤šæ¬¡binder ä¸Šé¢å¯ä»¥ç¡®è®¤ç»˜åˆ¶ç¼“æ…¢é€ æˆè€—æ—¶ã€‚ä½†æ˜¯ä¸€æ¥Appä¸æ˜¯è‡ªå·±çš„ï¼ŒäºŒæ¥è¿™ä¹ˆå¤æ‚çš„è°ƒç”¨ï¼Œé€šè¿‡åˆ†æè°ƒç”¨ã€è·Ÿä»£ç æ¥å®šä½æ…¢æ–¹æ³•ã€æ…¢è·¯å¾„æ˜¾ç„¶è¶³å¤Ÿä½æ•ˆã€‚ å®šä½åˆ°Traversalï¼Œç»Ÿè®¡ä¸€ä¸‹Traversalå„éƒ¨åˆ†çš„è€—æ—¶å æ¯”ï¼Œå¯ä»¥å¤§è‡´å®šä½å‡ºè€—æ—¶éƒ¨åˆ†å¯èƒ½æ˜¯ä»€ä¹ˆä¸šåŠ¡çš„ï¼š å¯ä»¥çœ‹åˆ°ï¼Œtraversalæ„å¤–åœ°åŒ…å«äº†æ•°é‡å·¨å¤§çš„binderè°ƒç”¨ï¼Œå®ƒå æ®æ€»è€—æ—¶çš„80%+ï¼Œä½¿å¾—åº”ç”¨å±‚ç»˜å›¾è¶…å‡ºç”Ÿå‘½çº¿10å€ä»¥ä¸Šï¼š è¿™æ¬¡doFrame-\u003etravesalè€—æ—¶æ¥è¿‘200msï¼Œå±äº\"æ— æ³•ä½¿ç”¨çš„åƒåœ¾\"çº§åˆ«ï¼Œä¸æ˜¯æ€§èƒ½é—®é¢˜è€Œæ˜¯æ•…éšœ binderè°ƒç”¨ï¼ˆbinder transactionï¼‰æ¬¡æ•°å¾ˆå¤šï¼Œåœ¨å‡ æ¯«ç§’çš„æ—¶é—´é‡Œï¼ˆé¢„æœŸçš„ä¸€æ¬¡åº”ç”¨å±‚ç»˜å›¾æ—¶é—´ï¼‰è¿›è¡Œäº†194æ¬¡IPC binderè€—æ—¶å æ¯”å¾ˆé«˜ï¼š83%å·¦å³ è¿˜æœ‰ä¸€ä¸ªioctlè°ƒç”¨æ¬¡æ•°ä¹Ÿå¾ˆå¤šã€å¾ˆè€—æ—¶ï¼›ç”±äºbinderé©±åŠ¨è°ƒç”¨talkWithDriver()éœ€è¦ä½¿ç”¨ioctlï¼Œå› æ­¤è¿™é‡Œåˆæ­¥åˆ¤æ–­ioctlæ˜¯binder IPCçš„ä¼´ç”Ÿï¼Œæ— ç¢ ç”Ÿå‘½çº¿ï¼šå¯¹äº60Hzçš„å±å¹•ï¼Œç”Ÿå‘½çº¿ä¸º16mså·¦å³ã€‚ä½†æ˜¯16msä¸ºå›¾å½¢æ ˆå…¨é“¾è·¯çš„æé™æ—¶é—´ï¼Œç•™ç»™åº”ç”¨å±‚çš„æ—¶é—´æ›´ä½ å¯ä»¥ç¡®è®¤ï¼Œè¿‡å¤šçš„binderè°ƒç”¨å¯¼è‡´äº†è¿™ä¸ªæ¼ç«çš„æ€§èƒ½é—®é¢˜ã€‚ ","date":"2024-11-06","objectID":"/posts/android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96getresources%E4%B8%8Ebinder%E4%BA%A4%E7%81%AB%E5%AF%BC%E8%87%B4%E7%9A%84%E7%95%8C%E9%9D%A2%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96/:4:0","tags":["clippings","è½¬è½½","blog","å¡é¡¿","Trace","Perfetto"],"title":"Androidæ€§èƒ½ä¼˜åŒ–ï¼šgetResources()ä¸Binderäº¤ç«å¯¼è‡´çš„ç•Œé¢å¡é¡¿ä¼˜åŒ–","uri":"/posts/android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96getresources%E4%B8%8Ebinder%E4%BA%A4%E7%81%AB%E5%AF%BC%E8%87%B4%E7%9A%84%E7%95%8C%E9%9D%A2%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96/#2-æ’æŸ¥measureå’Œlayoutæ…¢çš„åŸå› å¯ç–‘çš„å¤šæ¬¡binder"},{"categories":null,"collections":["æ€§èƒ½ä¼˜åŒ–"],"content":"3. binderï¼šåœ¨å“ªã€è°ä¸ºã€ä¸ºä½•é¢‘ç¹è°ƒç”¨ é€šå¸¸åº”ç”¨ï¼ˆå’Œåº”ç”¨é›†æˆçš„åº“ï¼‰ï¼Œå‡ºäºä¸€å®šçš„ç›®çš„ï¼Œä¼šé€šè¿‡IBinderã€AIDLã€å°è£…ç»„ä»¶ï¼ˆå¦‚startServiceï¼‰ã€ç›´æ¥è°ƒç”¨é©±åŠ¨èŠ‚ç‚¹ï¼ˆtalkWithDriverï¼‰ç­‰æ–¹å¼æ¥è¿›è¡Œä¸€æ¬¡Binder IPCã€‚ æ€§èƒ½é—®é¢˜ä¸­ï¼Œä¸Binder IPCç›¸å…³çš„ï¼Œæœ€å¸¸è§çš„ä¸»è¦å¦‚ä¸‹ï¼š é¢‘ç¹è°ƒç”¨Binder å…³é”®ã€æ•æ„Ÿã€ç´§å¼ çš„ä½ç½®è°ƒç”¨Binder Binderå¯¹ç«¯å“åº”å¤ªæ…¢ï¼Œå¯¹ç«¯ç¹å¿™ Binderä¼ é€’çš„æ•°æ®å¤ªå¤§ Binderå®¢æˆ·ç«¯çº¿ç¨‹æ•°è¶…é™ï¼ˆå‘èµ·è¯·æ±‚çš„çº¿ç¨‹æ»¡ï¼‰ BinderæœåŠ¡ç«¯çº¿ç¨‹æ•°è¶…é™ï¼ˆå¤„ç†è¯·æ±‚çš„çº¿ç¨‹æ»¡ï¼‰ å¯¹äºBinderä¼ é€’æ•°æ®å¤ªå¤§ã€çº¿ç¨‹æ•°å¯¼è‡´çš„æ€§èƒ½é—®é¢˜ï¼Œç”±äºåº”ç”¨ä¸æ˜¯è‡ªå·±çš„ï¼ˆä¸å¥½å¹²æ¶‰ã€ä¸å…³æ³¨ï¼‰ï¼Œä¸”å¯¹æ¯”æœºå¡é¡¿ä¸é‚£ä¹ˆæ˜æ˜¾ï¼ˆå¯ä»¥ç²—ç•¥æ’é™¤ï¼‰ï¼Œå› æ­¤ä¸å¤ªå€¼å¾—å»çœ‹ã€‚ï¼ˆå¦å¤–æˆ‘ä»¬æ˜¯åœ¨æ»‘å±çš„æ—¶å€™å¡çš„ï¼Œä¸»çº¿ç¨‹UIHandlerä¹Ÿåšä¸åˆ°å¹¶å‘å‘å‡ºBinder IPCï¼‰ è¿™é‡Œè¿˜æ˜¯å±•ç¤ºä¸€ä¸‹æ€ä¹ˆåˆ†æã€‚ä¸‹åˆ—å‘½ä»¤å¯ä»¥æä¾›ä¸€äº›å…³äºbinderçŠ¶æ€ã€tractionçŠ¶æ€ã€ä¼ é€’æ•°æ®å¤§å°ç­‰å†…å®¹ï¼š cat /sys/kernel/debug/binder/failed_transaction_log cat /sys/kernel/debug/binder/transaction_log cat /sys/kernel/debug/binder/transactions åŒæ ·çš„ï¼Œæˆ‘ä»¬ä¸å¥½å…³æ³¨åº”ç”¨ä¸ºä½•è°ƒç”¨binderï¼ˆå› ä¸ºæ²¡æœ‰Appçš„ä»£ç ï¼Œæœ€è¿‘ä¹Ÿå¿™çš„ä¸æƒ³é€†å‘å®ƒï¼›ä½†å®é™…ä¸Šæœ€åæˆ‘ä»¬çŸ¥é“äº†ä¸ºä½•è°ƒç”¨ï¼‰ï¼Œä¹Ÿå¾ˆæ˜¾ç„¶æ˜¯åœ¨å“ªè°ƒç”¨çš„ï¼ˆåœ¨App UIçº¿ç¨‹ performTraversalæ—¶è°ƒç”¨çš„ï¼‰ï¼Œå› æ­¤å…ˆæ¥çœ‹çœ‹è¿™ç¾¤IPCçš„å¯¹ç«¯æ˜¯è°ã€‚ traceä¸€çœ‹ï¼Œbinderè°ƒç”¨ç¡®å®å¾ˆå¤šï¼ˆç”»è“ç´«è‰²çº¿éƒ¨åˆ†éƒ½æ˜¯binderï¼›æœ¬æ˜¯ç»†çº¿ï¼Œæº¢æ»¡åˆ™åˆšï¼‰ï¼š ä¸Šå›¾binderè°ƒç”¨å¾ˆå¤šï¼Œå…¶å®å¾ˆå¤šæ˜¯åŒä¸€ç§ç±»ï¼Œå„IPCéƒ½æœ€ç»ˆå½’å±äºä¸€ç±»Binderã€‚åˆ†ç±»çœ‹ï¼Œæ•°é‡å·¨å¤§ã€å æ¯”æœ€é«˜çš„ä¸¤ç±»binderï¼ˆç§°ä¸ºç¬¬ä¸€éƒ¨åˆ†binderå’Œç¬¬äºŒéƒ¨åˆ†binderï¼‰æ˜¯å€¼å¾—æ¢è®¨çš„ä¸»è¦è€—æ—¶éƒ¨åˆ†ã€‚ é¦–å…ˆï¼Œåˆ†æç¬¬ä¸€éƒ¨åˆ†binderçš„å¯¹ç«¯ã€‚è·Ÿè¸ªå‘ç°ç¬¬ä¸€éƒ¨åˆ†binderâ€œé£â€å¾€SurafceFlingerï¼Œè€—æ—¶è¾ƒçŸ­ï¼Œæ¬¡æ•°åˆç†ï¼Œè¯„ä¼°æ­£å¸¸ï¼Œä¸å†è·Ÿè¿›ï¼Œä¸è´´å›¾å±•ç¤ºã€‚ ç¬¬äºŒéƒ¨åˆ†binderï¼Œä»æ¬¡æ•°ã€è€—æ—¶æ¥çœ‹ï¼Œç¡®å®å¯ç–‘ã€‚å®ƒä»Appè¿›ç¨‹â€œé£â€å¾€System_serverï¼ˆFrameworkæœåŠ¡å±‚ï¼‰ï¼š ","date":"2024-11-06","objectID":"/posts/android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96getresources%E4%B8%8Ebinder%E4%BA%A4%E7%81%AB%E5%AF%BC%E8%87%B4%E7%9A%84%E7%95%8C%E9%9D%A2%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96/:5:0","tags":["clippings","è½¬è½½","blog","å¡é¡¿","Trace","Perfetto"],"title":"Androidæ€§èƒ½ä¼˜åŒ–ï¼šgetResources()ä¸Binderäº¤ç«å¯¼è‡´çš„ç•Œé¢å¡é¡¿ä¼˜åŒ–","uri":"/posts/android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96getresources%E4%B8%8Ebinder%E4%BA%A4%E7%81%AB%E5%AF%BC%E8%87%B4%E7%9A%84%E7%95%8C%E9%9D%A2%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96/#3-binderåœ¨å“ªè°ä¸ºä¸ºä½•é¢‘ç¹è°ƒç”¨"},{"categories":null,"collections":["æ€§èƒ½ä¼˜åŒ–"],"content":"4. binderï¼šé¢‘ç¹è°ƒç”¨çš„å…·ä½“å®šä½ æ€§èƒ½åˆ†æçš„å…¶ä¸­ä¸€ä¸ªå…³é”®æ–¹å‘æ˜¯æ‰¾åˆ°æ…¢æ–¹æ³•ã€æ…¢è·¯å¾„ã€‚ä¸Šé¢ä¸€æ­¥å·²ç»ä½“ç°äº†ï¼Œæ…¢æ˜¯å› ä¸ºAppåœ¨æ•æ„Ÿä¸”å…³é”®çš„ä½ç½®è°ƒç”¨äº†Binderï¼Œè¿™ä¸ªbinderçš„å¯¹ç«¯æ˜¯Frameworkã€‚ ä»ç³»ç»Ÿä¾§åˆ†æè¿™ä¸ªbinderçš„æ€§èƒ½ï¼Œéš¾ä»¥åƒAppé‚£æ ·è½»æ¾å®šä½â€”â€”å› ä¸ºAppé‡Œé¢æœ‰å¤šå°‘ä¸ªè°ƒç”¨ã€ç³»ç»Ÿé‡Œé¢æš´éœ²äº†å¤šå°‘ä¸ªbinderï¼Œåœ¨å“ªé‡Œè§¦å‘çš„ï¼Œéƒ½ä¸å¥½æã€‚ å› æ­¤ç›´æ¥æ¥ç²—æš´çš„æ–¹æ³•ï¼ŒæŠŠæ‰€æœ‰binderè°ƒç”¨æŠ“å †æ ˆä¸‹æ¥ã€‚ å¤šæ¬¡å¤ç°ã€å¤šæ¬¡æŠ“å–ï¼Œé˜…è¯»å †æ ˆã€æ€»ç»“åˆ†ç±»ï¼Œå¯ä»¥æŠ“åˆ°è››ä¸é©¬è¿¹ã€‚ç”±äºæœ€é•¿çš„å †æ ˆé«˜è¾¾33ä¸‡è¡Œï¼ˆåŒ…å«åˆç†çš„æ­£å¸¸çš„binderå’Œé€ æˆæ€§èƒ½é—®é¢˜çš„binderï¼‰ï¼Œä¸”æŠ“äº†å¥½å‡ ä»½ï¼Œè¿™é‡Œåªèƒ½å°†é—®é¢˜çš„å…³é”®ç‚¹åšä¸ªå±•ç¤ºè¾“å‡ºã€‚ ls 20230209.fk.trace binder.20230209.2.fk.trace.log binder.20230209.4.fk.trace.log binder.20230209.fk.trace.log binder.20230210.1.fk.trace.log 20230209.ok.trace binder.20230209.3.fk.trace.log binder.20230209.5.fk.trace.log binder.20230209.ok.trace.log fkè¡¨ç¤ºfuckï¼Œå³ä¸æ­£å¸¸æƒ…å†µä¸‹çš„binderå †æ ˆï¼›okè¡¨ç¤ºæ­£å¸¸ã€‚ å…¶ä¸­æ€§èƒ½æ•…éšœå¯¹åº”çš„å †æ ˆå¦‚ä¸‹ï¼ˆå‡ ç±»æœ‰æ€§èƒ½é—®é¢˜çš„binderè°ƒç”¨ï¼›ä»…æˆªå–å…³é”®ä½ç½®ï¼‰ï¼š ç¬¬ä¸€ä¸ªå †æ ˆæ”¾å…¨ä¸€äº›ï¼Œå¯ä»¥çœ‹å‡ºï¼Œåœ¨æ­£å¸¸çš„traversalè¿‡ç¨‹ä¸­ï¼ŒViewä½“ç³»æ­£å¸¸è°ƒç”¨getResources()ï¼Œbinderå‘ç”Ÿåœ¨getResources()å†…éƒ¨ï¼šå®ƒè°ƒç”¨äº†IWindowManager.getInitialDisplayDensity()ï¼Œé€šè¿‡binderâ€œé£â€åˆ°system_serverï¼š Count: 15 Trace: java.lang.Throwable at android.os.BinderProxy.transact(BinderProxy.java:547) at android.view.IWindowManager$Stub$Proxy.getInitialDisplayDensity(IWindowManager.java:3025) at java.lang.reflect.Method.invoke(Native Method) at refactor.common.base.FActivity.e5(FActivity.java:7) at refactor.common.base.FActivity.getResources(FActivity.java:7) at androidx.appcompat.widget.ContentFrameLayout.onMeasure(ContentFrameLayout.java:1) at android.view.View.measure(View.java:25597) at android.view.ViewGroup.measureChildWithMargins(ViewGroup.java:7114) at android.widget.LinearLayout.measureChildBeforeLayout(LinearLayout.java:1632) at android.widget.LinearLayout.measureVertical(LinearLayout.java:922) at android.widget.LinearLayout.onMeasure(LinearLayout.java:801) at android.view.View.measure(View.java:25597) at android.view.ViewGroup.measureChildWithMargins(ViewGroup.java:7114) at android.widget.FrameLayout.onMeasure(FrameLayout.java:331) at android.view.View.measure(View.java:25597) at android.view.ViewGroup.measureChildWithMargins(ViewGroup.java:7114) at android.widget.LinearLayout.measureChildBeforeLayout(LinearLayout.java:1632) at android.widget.LinearLayout.measureVertical(LinearLayout.java:922) at android.widget.LinearLayout.onMeasure(LinearLayout.java:801) at android.view.View.measure(View.java:25597) at android.view.ViewGroup.measureChildWithMargins(ViewGroup.java:7114) at android.widget.FrameLayout.onMeasure(FrameLayout.java:331) at com.android.internal.policy.DecorView.onMeasure(DecorView.java:763) at android.view.View.measure(View.java:25597) at android.view.ViewRootImpl.performMeasure(ViewRootImpl.java:3665) at android.view.ViewRootImpl.measureHierarchy(ViewRootImpl.java:2302) at android.view.ViewRootImpl.performTraversals(ViewRootImpl.java:2564) at android.view.ViewRootImpl.doTraversal(ViewRootImpl.java:2026) at android.view.ViewRootImpl$TraversalRunnable.run(ViewRootImpl.java:8469) at android.view.Choreographer$CallbackRecord.run(Choreographer.java:972) at android.view.Choreographer.doCallbacks(Choreographer.java:796) at android.view.Choreographer.doFrame(Choreographer.java:731) at android.view.Choreographer$FrameDisplayEventReceiver.run(Choreographer.java:957) at android.os.Handler.handleCallback(Handler.java:938) at android.os.Handler.dispatchMessage(Handler.java:99) at android.os.Looper.loop(Looper.java:223) at android.app.ActivityThread.main(ActivityThread.java:8024) at java.lang.reflect.Method.invoke(Native Method) at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:605) at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:947) å…¶å®è¿™é‡Œå·²ç»èƒ½çœ‹å‡ºé—®é¢˜ï¼Œå¹¶ä¸”çœ‹æ¸…é—®é¢˜çš„ä¸¥é‡æ€§äº†ã€‚å¯ä»¥è¯´ï¼Œtarversalé˜¶æ®µæ˜¯ä¸€ä¸ªAppæœ€ç´§å¼ ã€æœ€é‡è¦çš„é˜¶æ®µä¹‹ä¸€ï¼Œåœ¨è¿™ä¸ªå…³é”®æ—¶é—´çª—å£å†…ï¼Œè¿˜è°ƒç”¨äº†binderé€šä¿¡è¿™ä¸€ä¸å¯é çš„æ–¹æ³•ï¼ˆIPCæ˜¯ä¸å¯é¢„æœŸçš„ï¼‰ï¼Œå¯¹æ€§èƒ½å½±å“å¾ˆå¤§ã€‚ è¯¥åº”ç”¨çš„Viewå®ç°å–œæ¬¢åœ¨traversalé˜¶æ®µè°ƒç”¨ä¸Šè¿°Binderï¼ŒåŒ…æ‹¬ä½†ä¸é™äºå¦‚ä¸‹å‡ ä¸ªï¼š Count: 5 Trace: java.lang.Throwable at android.os.BinderProxy.transact(BinderProxy.java:547) at android.view.IWindowManager$Stub$Proxy.getInitialDisplayDensity(IWindowManager.java:3025) at java.lang.reflect.Method.invoke(Native Method) at refactor.common.base.FActivity.e5(FActivity.java:7) at refactor.common.base.FActivity.getResources(FActivity.java:7) at android.widget.FrameLayout.onMeasure(FrameLayout.java:221) at androi","date":"2024-11-06","objectID":"/posts/android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96getresources%E4%B8%8Ebinder%E4%BA%A4%E7%81%AB%E5%AF%BC%E8%87%B4%E7%9A%84%E7%95%8C%E9%9D%A2%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96/:6:0","tags":["clippings","è½¬è½½","blog","å¡é¡¿","Trace","Perfetto"],"title":"Androidæ€§èƒ½ä¼˜åŒ–ï¼šgetResources()ä¸Binderäº¤ç«å¯¼è‡´çš„ç•Œé¢å¡é¡¿ä¼˜åŒ–","uri":"/posts/android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96getresources%E4%B8%8Ebinder%E4%BA%A4%E7%81%AB%E5%AF%BC%E8%87%B4%E7%9A%84%E7%95%8C%E9%9D%A2%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96/#4-binderé¢‘ç¹è°ƒç”¨çš„å…·ä½“å®šä½"},{"categories":null,"collections":["æ€§èƒ½ä¼˜åŒ–"],"content":"ç»“è®º Appåœ¨å¤šä¸ªä¸åŒçš„Viewï¼ˆåŠå…¶å­ç±»ViewGroupå’ŒViewGroupçš„å­ç±»ä»¬ï¼‰ï¼Œåœ¨ä¸åˆé€‚çš„æ—¶æœºé¢‘ç¹è°ƒç”¨äº†Binderï¼Œä»¥å¾ˆä½çš„CPUå ç”¨ï¼Œé¢†å…ˆæ€§åœ°å®ç°äº†å¾ˆå¡çš„æ•ˆæœã€‚ è™½ç„¶å¡é¡¿çš„è´¡çŒ®æ¥è‡ªä¸åŒçš„Viewè°ƒç”¨çš„åŒåBinderï¼Œè¿™ä¸ªbinderå´æ˜¯åŒä¸€ä¸ªæ¥å£ï¼ˆä¸æ˜“å˜çš„getInitialDisplayDensity()ï¼Œè¿™æ„å‘³ç€è¿”å›å€¼å¯ä»¥è¢«ç¼“å­˜ä¸‹æ¥å¹¶ç¡®ä¿æœ‰æ•ˆï¼‰ï¼Œè€Œä¸”è§¦å‘çš„ç›´æ¥åŸå› æ˜¯åŒä¸€ä¸ªâ€”â€”Appåœ¨Context.getResources()æ–¹æ³•å†…éƒ¨è°ƒç”¨äº†è¿™ä¸ªbinderï¼ŒgetResources()åœ¨Appè¿è¡Œæ—¶ä¼šè¢«é¢‘ç¹è°ƒç”¨ï¼ˆå°¤å…¶æ˜¯Viewåˆ›å»ºã€ç»˜åˆ¶é˜¶æ®µï¼‰ã€‚ Context.getResources()é»˜è®¤å®ç°æ˜¯ç›´æ¥è¿”å›mResourcesï¼Œä½†æ˜¯ä¼šæœ‰å¯çˆ±çš„äººä¼šoverrideå®ƒï¼ˆæˆ–é€šè¿‡ä¼˜ç¾çš„kotlinæ‰©å±•å‡½æ•°ï¼‰ï¼Œå¾€é‡Œé¢å¡å…¥è€—æ—¶çš„æ…¢æ–¹æ³•ã€‚ æ¸…æ™°çš„å®šä½åˆ°äº†æ…¢æ–¹æ³•ã€å¡é¡¿æ ¹å› åï¼Œè¿˜æœ‰ä¸€ä¸ªæ®‹é…·çš„é—®é¢˜ï¼šå¯¹æ¯”æœºä¸å¡ã€‚ å›ç­”è¿™ä¸ªé—®é¢˜æ„Ÿè§‰åƒæ˜¯å¯¹è‡ªå·±å†™å‡ºæ¥çš„å¡é¡¿å‹ä»£ç æœ‰ç‚¹æ¬²ç›–å¼¥å½°çš„æ„Ÿè§‰ã€‚ä¸è¿‡ç»è¿‡åˆ†æï¼Œæ’é™¤æ‰ç«å“çš„ä¼˜åŒ–ã€Appåœ¨ç«å“çš„Androidç‰ˆæœ¬ï¼ˆAndroidç‰ˆæœ¬å’Œæˆ‘ä»¬ä¸ä¸€æ ·ï¼‰ä¸Šä¸šåŠ¡é€»è¾‘ä¸åŒã€ç«å“çš„ç³»ç»ŸåŸç”Ÿé€»è¾‘å°±ä¸ä¸€æ ·ï¼ˆAndroidç‰ˆæœ¬åŸç”Ÿé€»è¾‘å·®å¼‚ï¼‰è¿™ä¸‰ä¸ªå˜é‡å› ç´ åï¼Œç»“åˆä»£ç é˜…è¯»ï¼Œå‘ç°æˆ‘ä»¬çš„View Treeåœ¨Measureå’ŒLayouté˜¶æ®µï¼Œæˆ‘ä»¬è‡ªå·±æ·»åŠ çš„åŠŸèƒ½ä¼šæ¯”åŸç”Ÿè¦è°ƒç”¨æ›´å¤šæ¬¡çš„getResources()æ–¹æ³•ã€‚ è¿™åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹éå¸¸æ­£å¸¸ï¼ˆé€»è¾‘ä¸Šä¹Ÿæ­£å¸¸ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•åªæœ‰ä¸€è¡Œç›´æ¥è¿”å›Resourceså¯¹è±¡å®ä¾‹çš„ä»£ç ï¼‰ï¼Œç¢°åˆ°ä¸€ä¸ªåœ¨è¶…é«˜é¢‘æ–¹æ³•é‡Œé¢åŠ æ…¢è°ƒç”¨ã€ä¸å¯é IPCçš„Appååªèƒ½å‚»çœ¼è®¤æ ½ã€‚ ","date":"2024-11-06","objectID":"/posts/android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96getresources%E4%B8%8Ebinder%E4%BA%A4%E7%81%AB%E5%AF%BC%E8%87%B4%E7%9A%84%E7%95%8C%E9%9D%A2%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96/:7:0","tags":["clippings","è½¬è½½","blog","å¡é¡¿","Trace","Perfetto"],"title":"Androidæ€§èƒ½ä¼˜åŒ–ï¼šgetResources()ä¸Binderäº¤ç«å¯¼è‡´çš„ç•Œé¢å¡é¡¿ä¼˜åŒ–","uri":"/posts/android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96getresources%E4%B8%8Ebinder%E4%BA%A4%E7%81%AB%E5%AF%BC%E8%87%B4%E7%9A%84%E7%95%8C%E9%9D%A2%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96/#ç»“è®º"},{"categories":null,"collections":["æ€§èƒ½ä¼˜åŒ–"],"content":"æ–¹æ¡ˆ ä»Appè§’åº¦çœ‹ï¼Œå®ƒé”™çš„å¾ˆç¦»è°±ã€‚ä¼˜åŒ–æ–¹æ¡ˆä¹Ÿå¾ˆç®€å•ï¼Œå»æ‰ä¸€ä¸ªå¤šä½™çš„ã€è¿‡åº¦çš„Binderè°ƒç”¨ï¼Œä¸€èˆ¬æ˜¯å°†è°ƒç”¨é›†ä¸­åœ¨å…³é”®ä½ç½®ï¼ˆä¸´ç•ŒåŒºï¼‰ä»¥å¤–ã€ç¼“å­˜è¿”å›å€¼ï¼ˆç¡®ä¿è¿”å›å€¼æ²¡æœ‰å¤±æ•ˆçš„å‰æä¸‹é‡ç”¨cacheï¼‰ã€ä¸åœ¨é«˜é¢‘æ–¹æ³•é‡Œé¢åŠ ä¸œè¥¿ã€å°½é‡ä¸override sdkæ–¹æ³•ç­‰ç­‰ã€‚ åœ¨ç³»ç»Ÿä¾§ï¼Œæœ¬ç€æ‹‰å¹³ç”šè‡³è¶…è¶Šç«å“çš„æ„¿æ™¯ï¼ŒåŒæ ·æœ‰å‡å°‘binderè°ƒç”¨çš„ä¼˜åŒ–ç›®æ ‡ã€‚ä¸è®ºæ˜¯å¯¹åº”ç”¨è‡ªèº«é—®é¢˜çš„è§£å†³ï¼Œè¿˜æ˜¯å¯¹ç«å“çš„ç«äº‰æ€§è·Ÿè¿›ï¼Œæ— æ‰€è°“ï¼Œéƒ½å‡ºæ‰‹ã€‚ä¸»è¦æœ‰å¦‚ä¸‹ä¸€äº›æ–¹æ¡ˆï¼š Frameworkå¯ä»¥å®ç°ç¼“å­˜ï¼Œåœ¨Binder IPCå‘å‡ºå‰æ£€æŸ¥æœ‰æ•ˆæ€§ï¼Œä»…åœ¨å¤±æ•ˆåçœŸæ­£å‘å‡ºIPC æŠŠæˆ‘ä»¬åŠ è¿›å»çš„é¢å¤–çš„getResources()å»æ‰ã€é‡æ„ åœ¨ä¸¥é…·çš„ç«äº‰ã€é«˜æ ‡å‡†çš„è¦æ±‚ä¸‹ï¼Œä¼šå°†è€ƒè™‘ä¸€äº›éæ ‡å‡†çš„æ“ä½œï¼ˆé­”æ”¹ï¼‰ æœ‰æ•ˆæ€§ï¼Œæ˜¯æŒ‡IPCå¯¹ç«¯è¿”å›çš„å†…å®¹æ²¡æœ‰å‘ç”Ÿæ”¹å˜ï¼ˆæœ¬è´¨ä¸Šæ˜¯è½¯ä»¶ç»´æŠ¤çš„çŠ¶æ€å¹¶æœªå‘ç”Ÿæ”¹å˜ï¼‰ã€‚æ¯”å¦‚ï¼Œä»æœªæ—‹è½¬è¿‡å±å¹•ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸Šä¸€æ¬¡è·å–çš„å±å¹•å®½é«˜å°±ä»ç„¶æœ‰æ•ˆï¼Œä¸éœ€è¦å†æ¬¡è·å–ï¼Œè€Œåº”å¤ç”¨ç¼“å­˜ æœ€ç»ˆæ–¹æ¡ˆ2é‡‡ç”¨å¹¶å–å¾—è‰¯å¥½æ•ˆæœï¼šå¸§ç‡æå‡å‡ å€ã€è·Ÿæ‰‹äº†ï¼Œè¿˜æœ‰ä¸€ç‚¹å¡å¡çš„ï¼ˆAppè‡ªå·±çš„+åŸç”Ÿçš„getResources()è°ƒç”¨ï¼‰ï¼Œè¾¾åˆ°å’Œç«å“ä¸€è‡´çš„æ°´å‡†äº†ã€‚ ","date":"2024-11-06","objectID":"/posts/android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96getresources%E4%B8%8Ebinder%E4%BA%A4%E7%81%AB%E5%AF%BC%E8%87%B4%E7%9A%84%E7%95%8C%E9%9D%A2%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96/:8:0","tags":["clippings","è½¬è½½","blog","å¡é¡¿","Trace","Perfetto"],"title":"Androidæ€§èƒ½ä¼˜åŒ–ï¼šgetResources()ä¸Binderäº¤ç«å¯¼è‡´çš„ç•Œé¢å¡é¡¿ä¼˜åŒ–","uri":"/posts/android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96getresources%E4%B8%8Ebinder%E4%BA%A4%E7%81%AB%E5%AF%BC%E8%87%B4%E7%9A%84%E7%95%8C%E9%9D%A2%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96/#æ–¹æ¡ˆ"},{"categories":null,"collections":["æ€§èƒ½ä¼˜åŒ–"],"content":"å‚è€ƒ Context.getResources()æºç å‚è€ƒ ","date":"2024-11-06","objectID":"/posts/android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96getresources%E4%B8%8Ebinder%E4%BA%A4%E7%81%AB%E5%AF%BC%E8%87%B4%E7%9A%84%E7%95%8C%E9%9D%A2%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96/:9:0","tags":["clippings","è½¬è½½","blog","å¡é¡¿","Trace","Perfetto"],"title":"Androidæ€§èƒ½ä¼˜åŒ–ï¼šgetResources()ä¸Binderäº¤ç«å¯¼è‡´çš„ç•Œé¢å¡é¡¿ä¼˜åŒ–","uri":"/posts/android%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96getresources%E4%B8%8Ebinder%E4%BA%A4%E7%81%AB%E5%AF%BC%E8%87%B4%E7%9A%84%E7%95%8C%E9%9D%A2%E5%8D%A1%E9%A1%BF%E4%BC%98%E5%8C%96/#å‚è€ƒ"},{"categories":null,"collections":["PMS","Framework"],"content":"æœ¬æ–‡é€‚ç”¨äºAndroid 12ä¸­å¢åŠ ç³»ç»ŸæœåŠ¡ã€‚ ç›®å½• 1.æ€»ä½“æ­¥éª¤ 2ã€è¯¦ç»†æ­¥éª¤ 2.1 åˆ›å»ºAIDLæ–‡ä»¶ 2.2 æŠ¥é”™ä¿®æ”¹ 2.2.1 AIDLæ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆçš„Javaæ–‡ä»¶æŠ¥é”™ 2.2.2 AIDLæ–‡ä»¶Observer/Callback/Listenerå‘½åæŠ¥é”™ä¿®æ”¹ 2.2.3 æ³¨å†Œæ–¹æ³•æŠ¥é”™ 2.2.4Â é¿å…ä½¿ç”¨æšä¸¾ç±»enum 2.2.5 Callbackå¦‚ä½•è®©APPè®¿é—®åˆ° 3. Contextä¸­å®šä¹‰service name 4. ç¼–å†™SystemService 5. åœ¨SystemServerç±»ä¸­æ³¨å†Œæ–°å¢çš„ç³»ç»ŸæœåŠ¡ 6. ç¼–å†™ç³»ç»ŸManagerç±» 7. æ³¨å†Œç³»ç»ŸManagerç±» 8. åº”ç”¨è°ƒç”¨ ","date":"2024-11-06","objectID":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/:0:0","tags":["clippings","è½¬è½½","blog"],"title":"Frameworkå±‚æ·»åŠ SystemServiceå’ŒManagerçš„è¶…è¯¦ç»†æ­¥éª¤_frameworkæ·»åŠ æ–°service-CSDNåšå®¢","uri":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/#"},{"categories":null,"collections":["PMS","Framework"],"content":"1.æ€»ä½“æ­¥éª¤ ","date":"2024-11-06","objectID":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/:1:0","tags":["clippings","è½¬è½½","blog"],"title":"Frameworkå±‚æ·»åŠ SystemServiceå’ŒManagerçš„è¶…è¯¦ç»†æ­¥éª¤_frameworkæ·»åŠ æ–°service-CSDNåšå®¢","uri":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/#1æ€»ä½“æ­¥éª¤"},{"categories":null,"collections":["PMS","Framework"],"content":"2ã€è¯¦ç»†æ­¥éª¤ ","date":"2024-11-06","objectID":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/:2:0","tags":["clippings","è½¬è½½","blog"],"title":"Frameworkå±‚æ·»åŠ SystemServiceå’ŒManagerçš„è¶…è¯¦ç»†æ­¥éª¤_frameworkæ·»åŠ æ–°service-CSDNåšå®¢","uri":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/#2è¯¦ç»†æ­¥éª¤"},{"categories":null,"collections":["PMS","Framework"],"content":"2.1 åˆ›å»ºAIDLæ–‡ä»¶ **åœ¨framework/base/core/java/android/appä¸‹åˆ›å»ºAIDLæ–‡ä»¶ï¼Œ**å¦‚æœä¸šåŠ¡æ¯”è¾ƒå¤æ‚ï¼Œå¯ä»¥åˆ›å»ºæ¨¡å—æ–‡ä»¶å¤¹ã€‚ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š framework/base/core/java/android/app/devicemanager/IDeviceManager.aidl package android.app.devicemanager;import android.app.devicemanager.DeviceEntity;import android.app.devicemanager.IDeviceObserver;interface IDeviceManager {int bindDivice(int deviceId); DeviceEntity getDeviceEntity(int deviceId);void registerDeviceObserver(in IDeviceObserver observer);void unregisterDeviceObserver(in IDeviceObserver observer);} framework/base/core/java/android/app/devicemanager/IDiviceObserver.aidl package android.app.devicemanager;import android.app.devicemanager.DeviceEntity;oneway interface IDiviceObserver{void onBindChanged(int state, int deviceId);void onStateChanged(int state, int deviceId);} framework/base/core/java/android/app/devicemanager/DeviceEntity.aidl package android.app.devicemanager;parcelable DeviceEntity; ","date":"2024-11-06","objectID":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/:2:1","tags":["clippings","è½¬è½½","blog"],"title":"Frameworkå±‚æ·»åŠ SystemServiceå’ŒManagerçš„è¶…è¯¦ç»†æ­¥éª¤_frameworkæ·»åŠ æ–°service-CSDNåšå®¢","uri":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/#21-åˆ›å»ºaidlæ–‡ä»¶"},{"categories":null,"collections":["PMS","Framework"],"content":"2.2 æŠ¥é”™ä¿®æ”¹ ä¸Šè¿°å†™æ³•ä¼šæŠ¥éå¸¸å¤šçš„é”™ï¼Œè¯·å‚è€ƒAndroid 12Â APIè§„èŒƒï¼šè¯·å‚è€ƒ https://www.cnblogs.com/wanghongzhu/p/14729469.html ã€‚ é’ˆå¯¹ä¸Šè¿°ä»£ç æ‰€çŠ¯çš„é”™è¯¯ï¼Œä¹Ÿå°±æ˜¯å¤§å®¶åœ¨Android 12ç‰ˆæœ¬ä¸­ä½¿ç”¨make -j32 framework-minus-apexç¼–è¯‘frameworkå±‚çš„æŠ¥é”™ä¿®æ”¹ã€‚ 2.2.1 AIDLæ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆçš„Javaæ–‡ä»¶æŠ¥é”™ è¿™æ˜¯å› ä¸ºAIDLè‡ªåŠ¨ç”Ÿæˆçš„Javaæ–‡ä»¶ä¸æ»¡è¶³Android 12 framework APIçš„è§„èŒƒï¼šframeworkå±‚ä¸èƒ½ç›´æ¥æš´éœ²åŸç”ŸAIDLæ–‡ä»¶ã€‚ ä¿®æ”¹çš„æ–¹å¼æ˜¯åœ¨aidlæ–‡ä»¶ä¸Šæ·»åŠ @hideï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œè¿™æ ·å°±å¯ä»¥è§£å†³æ‰€æœ‰AIDLè‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶ã€‚ï¼ˆè¿™æ˜¯æ‰’éå›½å†…å…¨ç½‘éƒ½æ²¡åœ¨æ‰¾åˆ°ï¼Œåœ¨Googleä¸­æ‰æ‰¾åˆ°çš„æ ¹æœ¬è§£å†³åŠæ³•ï¼‰ package android.app.devicemanager;import android.app.devicemanager.DeviceEntity;import android.app.devicemanager.IDeviceObserver;interface IDeviceManager {int bindDivice(int deviceId); DeviceEntity getDeviceEntity(int deviceId);void registerDeviceObserver(in IDeviceObserver observer);void unregisterDeviceObserver(in IDeviceObserver observer);} out/srcjars/android/app/devicemanager/IDiviceObserver.java:60: error: Methods calling system APIs should rethrow `RemoteException` as `RuntimeException` (but do not list it in the throws clause) [RethrowRemoteException] out/srcjars/android/app/devicemanager/IDiviceObserver.java:70: error: Missing nullability on method `asBinder` return [MissingNullability] out/srcjars/android/app/devicemanager/IDiviceObserver.java:75: error: Raw AIDL interfaces must not be exposed: Stub extends Binder [RawAidl] 2.2.2 AIDLæ–‡ä»¶Observer/Callback/Listenerå‘½åæŠ¥é”™ä¿®æ”¹ Observerå‘½åæŠ¥é”™ï¼ŒAndroid Lint å·¥å…·å¯¹callbackå’Œlisteneræœ‰ä¸¥æ ¼çš„æ ¡éªŒï¼Œä¸å»ºè®®ä½¿ç”¨Observerä½œä¸ºå›è°ƒï¼Œè¦ç”¨callbackæˆ–è€…listenerã€‚ å½“åªæœ‰ä¸€ä¸ªå›è°ƒæ–¹æ³•ä¸”æ°¸è¿œä¸ä¼šæœ‰å…¶ä»–å›è°ƒæ–¹æ³•æ—¶ä½¿ç”¨Listenerï¼Œä¸”æ³¨å†Œç›‘å¬å’Œè§£æ³¨å†Œç›‘å¬çš„æ–¹æ³•å¿…é¡»æ˜¯add/removeå¼€å¤´ï¼Œå¦åˆ™Android Lintç¼–è¯‘ä¸è¿‡ã€‚ å½“æœ‰å¤šä¸ªå›è°ƒæ–¹æ³•æ—¶ï¼Œæˆ–è€…æœ‰å…³è”çš„å¸¸é‡æ—¶ï¼Œåº”è¯¥ä½¿ç”¨Callbackã€‚Callbackç±»å¯ä»¥æ˜¯ä¸€ä¸ªinterfaceæˆ–è€…abstract classã€‚æ·»åŠ callbackå’Œå»æ‰callbackåº”è¯¥ä½¿ç”¨registerå’Œunregisterå¼€å¤´çš„æ–¹æ³•ã€‚ callbackä¸­çš„æ–¹æ³•åº”è¯¥ä»¥on-å¼€å¤´ã€‚ è¯·ä¸­æ‹›çš„å°ä¼™ä¼´è‡ªè¡Œä¿®æ”¹ã€‚ 2.2.3 æ³¨å†Œæ–¹æ³•æŠ¥é”™ Registration methods should have overload that accepts delivery Executor: `registerDeviceCallback` [ExecutorRegistration] æ˜¯ä¸æ˜¯ä¸€è„¸æ‡µï¼Œçœ‹ä¸æ˜ç™½å•¥æ„æ€ï¼Œä»¥å‰å¾ˆæ—©çš„frameworkå±‚çš„managerï¼Œæ²¡å•¥å‚è€ƒä»·å€¼ï¼Œæ¨èå‚è€ƒæ–°çš„managerå’ŒAPIè§„èŒƒï¼Œå› ä¸ºç°æœ‰çš„æ³¨å†Œå›è°ƒçš„æ–¹æ³•å¿…é¡»æ˜¯ä¸¤ä¸ªå‚æ•°ï¼Œå…¶ä¸­ä¸€ä¸ªå¿…é¡»ä¸ºExecutorï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ public void registerFooCallback( @NonNull @CallbackExecutor Executor executor,@NonNull FooCallback callback)public void unregisterFooCallback(@NonNull FooCallback callback) {} 2.2.4Â é¿å…ä½¿ç”¨æšä¸¾ç±»enum åœ¨Frameworkå±‚ä½¿ç”¨enumä¼šæŠ¥é”™ï¼šEnums are discouraged in Android APIs [Enum]ï¼Œå› æ­¤ä¸€èˆ¬éƒ½ç”¨@intDefä»£æ›¿ï¼Œä½¿ç”¨æ–°çš„æ³¨è§£è¡¨ç¤ºã€‚ 2.2.5 Callbackå¦‚ä½•è®©APPè®¿é—®åˆ° å‰è¾¹2.2.1 AIDLæ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆçš„Javaæ–‡ä»¶æŠ¥é”™ï¼Œä¸ºäº†è§£å†³éœ€è¦æ·»åŠ @hideï¼Œä½†æ˜¯æ·»åŠ è¯¥æ³¨è§£åï¼ŒAppså°±è®¿é—®ä¸åˆ°è¯¥callbackï¼Œå¦‚ä½•å®ç°Binderé€šä¿¡å‘¢ï¼Ÿ è§£å†³åŠæ³•ï¼š åˆ›å»ºä¸€ä¸ªpublic abstract class DeviceCallbackï¼Œå¯¹appsæš´éœ²è¯¥ç±»ï¼Œè®©Appsæ·»åŠ æ³¨å†Œçš„æ—¶å€™åˆ›å»ºè¯¥ç±»çš„å®ä¾‹ã€‚ ç„¶åå†frameworkå±‚managerä¸­å®ç°DeviceManagerç±»ä¸IDeviceCallback.aidlçš„ä¸€ä¸€æ˜ å°„å…³ç³»ã€‚ è¿™æ ·åšçš„å¥½å¤„ï¼š å³èƒ½é¿å…æš´éœ²åŸç”Ÿçš„AIDLæ–‡ä»¶ï¼Œè€Œä¸”Appsä¸ç”¨å®ç°ICallback.aidlä¸­æ‰€æœ‰çš„æ–¹æ³•ã€‚ //åˆ›å»ºæš´éœ²ç»™Appsçš„æŠ½è±¡ç±»Â package android.app.devicemanager;public abstract class DiviceCallback {void onBindChanged(int state, int deviceId);void onStateChanged(int state, int deviceId);} //Managerä¸­å¯¹åº”çš„æ˜ å°„å…³ç³»Â package android.app.devicemanager;import android.app.devicemanager.IDeiceCallback;import android.app.devicemanager.DevoceCallback;import java.util.concurrent.Executor;public class DeviceManager {private ArrayMap\u003cDeviceCallback, DeviceCallbackEntry\u003e mCallbackMap = new ArrayMap\u003c\u003e();private static final class DeviceCallbackEntry extends IDeviceCallback.Stub {final DeviceCallback mCallback;final Executor mExecutor; DeviceCallbackEntry( DeviceCallback callback, Executor executor) { mCallback = callback; mExecutor = executor; }public void onBindChanged(int state, int deviceId) { mExecutor.executor(() -\u003e mCallback.onBindChanged(state, deviceId)); } ... }public void registerDeviceCallback(@Nullable Executor executor,@NonNull DeviceCallback callback) {if(callback == null || mCallbackMap.containsKey(calback)) {return; }DeviceCallbackEntry entry = new DeviceCallbackEntry(callback, executor); mCallbackMap.put(callback, entry);final IDeviceManager service = getService();try { service.registerDeviceCallback(entry); } catch (RemoteException e) {throw e.rethrowFromSystemServer(); } }} ","date":"2024-11-06","objectID":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/:2:2","tags":["clippings","è½¬è½½","blog"],"title":"Frameworkå±‚æ·»åŠ SystemServiceå’ŒManagerçš„è¶…è¯¦ç»†æ­¥éª¤_frameworkæ·»åŠ æ–°service-CSDNåšå®¢","uri":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/#22-æŠ¥é”™ä¿®æ”¹"},{"categories":null,"collections":["PMS","Framework"],"content":"2.2 æŠ¥é”™ä¿®æ”¹ ä¸Šè¿°å†™æ³•ä¼šæŠ¥éå¸¸å¤šçš„é”™ï¼Œè¯·å‚è€ƒAndroid 12Â APIè§„èŒƒï¼šè¯·å‚è€ƒ https://www.cnblogs.com/wanghongzhu/p/14729469.html ã€‚ é’ˆå¯¹ä¸Šè¿°ä»£ç æ‰€çŠ¯çš„é”™è¯¯ï¼Œä¹Ÿå°±æ˜¯å¤§å®¶åœ¨Android 12ç‰ˆæœ¬ä¸­ä½¿ç”¨make -j32 framework-minus-apexç¼–è¯‘frameworkå±‚çš„æŠ¥é”™ä¿®æ”¹ã€‚ 2.2.1 AIDLæ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆçš„Javaæ–‡ä»¶æŠ¥é”™ è¿™æ˜¯å› ä¸ºAIDLè‡ªåŠ¨ç”Ÿæˆçš„Javaæ–‡ä»¶ä¸æ»¡è¶³Android 12 framework APIçš„è§„èŒƒï¼šframeworkå±‚ä¸èƒ½ç›´æ¥æš´éœ²åŸç”ŸAIDLæ–‡ä»¶ã€‚ ä¿®æ”¹çš„æ–¹å¼æ˜¯åœ¨aidlæ–‡ä»¶ä¸Šæ·»åŠ @hideï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œè¿™æ ·å°±å¯ä»¥è§£å†³æ‰€æœ‰AIDLè‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶ã€‚ï¼ˆè¿™æ˜¯æ‰’éå›½å†…å…¨ç½‘éƒ½æ²¡åœ¨æ‰¾åˆ°ï¼Œåœ¨Googleä¸­æ‰æ‰¾åˆ°çš„æ ¹æœ¬è§£å†³åŠæ³•ï¼‰ package android.app.devicemanager;import android.app.devicemanager.DeviceEntity;import android.app.devicemanager.IDeviceObserver;interface IDeviceManager {int bindDivice(int deviceId); DeviceEntity getDeviceEntity(int deviceId);void registerDeviceObserver(in IDeviceObserver observer);void unregisterDeviceObserver(in IDeviceObserver observer);} out/srcjars/android/app/devicemanager/IDiviceObserver.java:60: error: Methods calling system APIs should rethrow `RemoteException` as `RuntimeException` (but do not list it in the throws clause) [RethrowRemoteException] out/srcjars/android/app/devicemanager/IDiviceObserver.java:70: error: Missing nullability on method `asBinder` return [MissingNullability] out/srcjars/android/app/devicemanager/IDiviceObserver.java:75: error: Raw AIDL interfaces must not be exposed: Stub extends Binder [RawAidl] 2.2.2 AIDLæ–‡ä»¶Observer/Callback/Listenerå‘½åæŠ¥é”™ä¿®æ”¹ Observerå‘½åæŠ¥é”™ï¼ŒAndroid Lint å·¥å…·å¯¹callbackå’Œlisteneræœ‰ä¸¥æ ¼çš„æ ¡éªŒï¼Œä¸å»ºè®®ä½¿ç”¨Observerä½œä¸ºå›è°ƒï¼Œè¦ç”¨callbackæˆ–è€…listenerã€‚ å½“åªæœ‰ä¸€ä¸ªå›è°ƒæ–¹æ³•ä¸”æ°¸è¿œä¸ä¼šæœ‰å…¶ä»–å›è°ƒæ–¹æ³•æ—¶ä½¿ç”¨Listenerï¼Œä¸”æ³¨å†Œç›‘å¬å’Œè§£æ³¨å†Œç›‘å¬çš„æ–¹æ³•å¿…é¡»æ˜¯add/removeå¼€å¤´ï¼Œå¦åˆ™Android Lintç¼–è¯‘ä¸è¿‡ã€‚ å½“æœ‰å¤šä¸ªå›è°ƒæ–¹æ³•æ—¶ï¼Œæˆ–è€…æœ‰å…³è”çš„å¸¸é‡æ—¶ï¼Œåº”è¯¥ä½¿ç”¨Callbackã€‚Callbackç±»å¯ä»¥æ˜¯ä¸€ä¸ªinterfaceæˆ–è€…abstract classã€‚æ·»åŠ callbackå’Œå»æ‰callbackåº”è¯¥ä½¿ç”¨registerå’Œunregisterå¼€å¤´çš„æ–¹æ³•ã€‚ callbackä¸­çš„æ–¹æ³•åº”è¯¥ä»¥on-å¼€å¤´ã€‚ è¯·ä¸­æ‹›çš„å°ä¼™ä¼´è‡ªè¡Œä¿®æ”¹ã€‚ 2.2.3 æ³¨å†Œæ–¹æ³•æŠ¥é”™ Registration methods should have overload that accepts delivery Executor: `registerDeviceCallback` [ExecutorRegistration] æ˜¯ä¸æ˜¯ä¸€è„¸æ‡µï¼Œçœ‹ä¸æ˜ç™½å•¥æ„æ€ï¼Œä»¥å‰å¾ˆæ—©çš„frameworkå±‚çš„managerï¼Œæ²¡å•¥å‚è€ƒä»·å€¼ï¼Œæ¨èå‚è€ƒæ–°çš„managerå’ŒAPIè§„èŒƒï¼Œå› ä¸ºç°æœ‰çš„æ³¨å†Œå›è°ƒçš„æ–¹æ³•å¿…é¡»æ˜¯ä¸¤ä¸ªå‚æ•°ï¼Œå…¶ä¸­ä¸€ä¸ªå¿…é¡»ä¸ºExecutorï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ public void registerFooCallback( @NonNull @CallbackExecutor Executor executor,@NonNull FooCallback callback)public void unregisterFooCallback(@NonNull FooCallback callback) {} 2.2.4Â é¿å…ä½¿ç”¨æšä¸¾ç±»enum åœ¨Frameworkå±‚ä½¿ç”¨enumä¼šæŠ¥é”™ï¼šEnums are discouraged in Android APIs [Enum]ï¼Œå› æ­¤ä¸€èˆ¬éƒ½ç”¨@intDefä»£æ›¿ï¼Œä½¿ç”¨æ–°çš„æ³¨è§£è¡¨ç¤ºã€‚ 2.2.5 Callbackå¦‚ä½•è®©APPè®¿é—®åˆ° å‰è¾¹2.2.1 AIDLæ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆçš„Javaæ–‡ä»¶æŠ¥é”™ï¼Œä¸ºäº†è§£å†³éœ€è¦æ·»åŠ @hideï¼Œä½†æ˜¯æ·»åŠ è¯¥æ³¨è§£åï¼ŒAppså°±è®¿é—®ä¸åˆ°è¯¥callbackï¼Œå¦‚ä½•å®ç°Binderé€šä¿¡å‘¢ï¼Ÿ è§£å†³åŠæ³•ï¼š åˆ›å»ºä¸€ä¸ªpublic abstract class DeviceCallbackï¼Œå¯¹appsæš´éœ²è¯¥ç±»ï¼Œè®©Appsæ·»åŠ æ³¨å†Œçš„æ—¶å€™åˆ›å»ºè¯¥ç±»çš„å®ä¾‹ã€‚ ç„¶åå†frameworkå±‚managerä¸­å®ç°DeviceManagerç±»ä¸IDeviceCallback.aidlçš„ä¸€ä¸€æ˜ å°„å…³ç³»ã€‚ è¿™æ ·åšçš„å¥½å¤„ï¼š å³èƒ½é¿å…æš´éœ²åŸç”Ÿçš„AIDLæ–‡ä»¶ï¼Œè€Œä¸”Appsä¸ç”¨å®ç°ICallback.aidlä¸­æ‰€æœ‰çš„æ–¹æ³•ã€‚ //åˆ›å»ºæš´éœ²ç»™Appsçš„æŠ½è±¡ç±»Â package android.app.devicemanager;public abstract class DiviceCallback {void onBindChanged(int state, int deviceId);void onStateChanged(int state, int deviceId);} //Managerä¸­å¯¹åº”çš„æ˜ å°„å…³ç³»Â package android.app.devicemanager;import android.app.devicemanager.IDeiceCallback;import android.app.devicemanager.DevoceCallback;import java.util.concurrent.Executor;public class DeviceManager {private ArrayMap mCallbackMap = new ArrayMap\u003c\u003e();private static final class DeviceCallbackEntry extends IDeviceCallback.Stub {final DeviceCallback mCallback;final Executor mExecutor; DeviceCallbackEntry( DeviceCallback callback, Executor executor) { mCallback = callback; mExecutor = executor; }public void onBindChanged(int state, int deviceId) { mExecutor.executor(() -\u003e mCallback.onBindChanged(state, deviceId)); } ... }public void registerDeviceCallback(@Nullable Executor executor,@NonNull DeviceCallback callback) {if(callback == null || mCallbackMap.containsKey(calback)) {return; }DeviceCallbackEntry entry = new DeviceCallbackEntry(callback, executor); mCallbackMap.put(callback, entry);final IDeviceManager service = getService();try { service.registerDeviceCallback(entry); } catch (RemoteException e) {throw e.rethrowFromSystemServer(); } }} ","date":"2024-11-06","objectID":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/:2:2","tags":["clippings","è½¬è½½","blog"],"title":"Frameworkå±‚æ·»åŠ SystemServiceå’ŒManagerçš„è¶…è¯¦ç»†æ­¥éª¤_frameworkæ·»åŠ æ–°service-CSDNåšå®¢","uri":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/#221-aidlæ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆçš„javaæ–‡ä»¶æŠ¥é”™"},{"categories":null,"collections":["PMS","Framework"],"content":"2.2 æŠ¥é”™ä¿®æ”¹ ä¸Šè¿°å†™æ³•ä¼šæŠ¥éå¸¸å¤šçš„é”™ï¼Œè¯·å‚è€ƒAndroid 12Â APIè§„èŒƒï¼šè¯·å‚è€ƒ https://www.cnblogs.com/wanghongzhu/p/14729469.html ã€‚ é’ˆå¯¹ä¸Šè¿°ä»£ç æ‰€çŠ¯çš„é”™è¯¯ï¼Œä¹Ÿå°±æ˜¯å¤§å®¶åœ¨Android 12ç‰ˆæœ¬ä¸­ä½¿ç”¨make -j32 framework-minus-apexç¼–è¯‘frameworkå±‚çš„æŠ¥é”™ä¿®æ”¹ã€‚ 2.2.1 AIDLæ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆçš„Javaæ–‡ä»¶æŠ¥é”™ è¿™æ˜¯å› ä¸ºAIDLè‡ªåŠ¨ç”Ÿæˆçš„Javaæ–‡ä»¶ä¸æ»¡è¶³Android 12 framework APIçš„è§„èŒƒï¼šframeworkå±‚ä¸èƒ½ç›´æ¥æš´éœ²åŸç”ŸAIDLæ–‡ä»¶ã€‚ ä¿®æ”¹çš„æ–¹å¼æ˜¯åœ¨aidlæ–‡ä»¶ä¸Šæ·»åŠ @hideï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œè¿™æ ·å°±å¯ä»¥è§£å†³æ‰€æœ‰AIDLè‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶ã€‚ï¼ˆè¿™æ˜¯æ‰’éå›½å†…å…¨ç½‘éƒ½æ²¡åœ¨æ‰¾åˆ°ï¼Œåœ¨Googleä¸­æ‰æ‰¾åˆ°çš„æ ¹æœ¬è§£å†³åŠæ³•ï¼‰ package android.app.devicemanager;import android.app.devicemanager.DeviceEntity;import android.app.devicemanager.IDeviceObserver;interface IDeviceManager {int bindDivice(int deviceId); DeviceEntity getDeviceEntity(int deviceId);void registerDeviceObserver(in IDeviceObserver observer);void unregisterDeviceObserver(in IDeviceObserver observer);} out/srcjars/android/app/devicemanager/IDiviceObserver.java:60: error: Methods calling system APIs should rethrow `RemoteException` as `RuntimeException` (but do not list it in the throws clause) [RethrowRemoteException] out/srcjars/android/app/devicemanager/IDiviceObserver.java:70: error: Missing nullability on method `asBinder` return [MissingNullability] out/srcjars/android/app/devicemanager/IDiviceObserver.java:75: error: Raw AIDL interfaces must not be exposed: Stub extends Binder [RawAidl] 2.2.2 AIDLæ–‡ä»¶Observer/Callback/Listenerå‘½åæŠ¥é”™ä¿®æ”¹ Observerå‘½åæŠ¥é”™ï¼ŒAndroid Lint å·¥å…·å¯¹callbackå’Œlisteneræœ‰ä¸¥æ ¼çš„æ ¡éªŒï¼Œä¸å»ºè®®ä½¿ç”¨Observerä½œä¸ºå›è°ƒï¼Œè¦ç”¨callbackæˆ–è€…listenerã€‚ å½“åªæœ‰ä¸€ä¸ªå›è°ƒæ–¹æ³•ä¸”æ°¸è¿œä¸ä¼šæœ‰å…¶ä»–å›è°ƒæ–¹æ³•æ—¶ä½¿ç”¨Listenerï¼Œä¸”æ³¨å†Œç›‘å¬å’Œè§£æ³¨å†Œç›‘å¬çš„æ–¹æ³•å¿…é¡»æ˜¯add/removeå¼€å¤´ï¼Œå¦åˆ™Android Lintç¼–è¯‘ä¸è¿‡ã€‚ å½“æœ‰å¤šä¸ªå›è°ƒæ–¹æ³•æ—¶ï¼Œæˆ–è€…æœ‰å…³è”çš„å¸¸é‡æ—¶ï¼Œåº”è¯¥ä½¿ç”¨Callbackã€‚Callbackç±»å¯ä»¥æ˜¯ä¸€ä¸ªinterfaceæˆ–è€…abstract classã€‚æ·»åŠ callbackå’Œå»æ‰callbackåº”è¯¥ä½¿ç”¨registerå’Œunregisterå¼€å¤´çš„æ–¹æ³•ã€‚ callbackä¸­çš„æ–¹æ³•åº”è¯¥ä»¥on-å¼€å¤´ã€‚ è¯·ä¸­æ‹›çš„å°ä¼™ä¼´è‡ªè¡Œä¿®æ”¹ã€‚ 2.2.3 æ³¨å†Œæ–¹æ³•æŠ¥é”™ Registration methods should have overload that accepts delivery Executor: `registerDeviceCallback` [ExecutorRegistration] æ˜¯ä¸æ˜¯ä¸€è„¸æ‡µï¼Œçœ‹ä¸æ˜ç™½å•¥æ„æ€ï¼Œä»¥å‰å¾ˆæ—©çš„frameworkå±‚çš„managerï¼Œæ²¡å•¥å‚è€ƒä»·å€¼ï¼Œæ¨èå‚è€ƒæ–°çš„managerå’ŒAPIè§„èŒƒï¼Œå› ä¸ºç°æœ‰çš„æ³¨å†Œå›è°ƒçš„æ–¹æ³•å¿…é¡»æ˜¯ä¸¤ä¸ªå‚æ•°ï¼Œå…¶ä¸­ä¸€ä¸ªå¿…é¡»ä¸ºExecutorï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ public void registerFooCallback( @NonNull @CallbackExecutor Executor executor,@NonNull FooCallback callback)public void unregisterFooCallback(@NonNull FooCallback callback) {} 2.2.4Â é¿å…ä½¿ç”¨æšä¸¾ç±»enum åœ¨Frameworkå±‚ä½¿ç”¨enumä¼šæŠ¥é”™ï¼šEnums are discouraged in Android APIs [Enum]ï¼Œå› æ­¤ä¸€èˆ¬éƒ½ç”¨@intDefä»£æ›¿ï¼Œä½¿ç”¨æ–°çš„æ³¨è§£è¡¨ç¤ºã€‚ 2.2.5 Callbackå¦‚ä½•è®©APPè®¿é—®åˆ° å‰è¾¹2.2.1 AIDLæ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆçš„Javaæ–‡ä»¶æŠ¥é”™ï¼Œä¸ºäº†è§£å†³éœ€è¦æ·»åŠ @hideï¼Œä½†æ˜¯æ·»åŠ è¯¥æ³¨è§£åï¼ŒAppså°±è®¿é—®ä¸åˆ°è¯¥callbackï¼Œå¦‚ä½•å®ç°Binderé€šä¿¡å‘¢ï¼Ÿ è§£å†³åŠæ³•ï¼š åˆ›å»ºä¸€ä¸ªpublic abstract class DeviceCallbackï¼Œå¯¹appsæš´éœ²è¯¥ç±»ï¼Œè®©Appsæ·»åŠ æ³¨å†Œçš„æ—¶å€™åˆ›å»ºè¯¥ç±»çš„å®ä¾‹ã€‚ ç„¶åå†frameworkå±‚managerä¸­å®ç°DeviceManagerç±»ä¸IDeviceCallback.aidlçš„ä¸€ä¸€æ˜ å°„å…³ç³»ã€‚ è¿™æ ·åšçš„å¥½å¤„ï¼š å³èƒ½é¿å…æš´éœ²åŸç”Ÿçš„AIDLæ–‡ä»¶ï¼Œè€Œä¸”Appsä¸ç”¨å®ç°ICallback.aidlä¸­æ‰€æœ‰çš„æ–¹æ³•ã€‚ //åˆ›å»ºæš´éœ²ç»™Appsçš„æŠ½è±¡ç±»Â package android.app.devicemanager;public abstract class DiviceCallback {void onBindChanged(int state, int deviceId);void onStateChanged(int state, int deviceId);} //Managerä¸­å¯¹åº”çš„æ˜ å°„å…³ç³»Â package android.app.devicemanager;import android.app.devicemanager.IDeiceCallback;import android.app.devicemanager.DevoceCallback;import java.util.concurrent.Executor;public class DeviceManager {private ArrayMap mCallbackMap = new ArrayMap\u003c\u003e();private static final class DeviceCallbackEntry extends IDeviceCallback.Stub {final DeviceCallback mCallback;final Executor mExecutor; DeviceCallbackEntry( DeviceCallback callback, Executor executor) { mCallback = callback; mExecutor = executor; }public void onBindChanged(int state, int deviceId) { mExecutor.executor(() -\u003e mCallback.onBindChanged(state, deviceId)); } ... }public void registerDeviceCallback(@Nullable Executor executor,@NonNull DeviceCallback callback) {if(callback == null || mCallbackMap.containsKey(calback)) {return; }DeviceCallbackEntry entry = new DeviceCallbackEntry(callback, executor); mCallbackMap.put(callback, entry);final IDeviceManager service = getService();try { service.registerDeviceCallback(entry); } catch (RemoteException e) {throw e.rethrowFromSystemServer(); } }} ","date":"2024-11-06","objectID":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/:2:2","tags":["clippings","è½¬è½½","blog"],"title":"Frameworkå±‚æ·»åŠ SystemServiceå’ŒManagerçš„è¶…è¯¦ç»†æ­¥éª¤_frameworkæ·»åŠ æ–°service-CSDNåšå®¢","uri":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/#222-aidlæ–‡ä»¶observercallbacklistenerå‘½åæŠ¥é”™ä¿®æ”¹"},{"categories":null,"collections":["PMS","Framework"],"content":"2.2 æŠ¥é”™ä¿®æ”¹ ä¸Šè¿°å†™æ³•ä¼šæŠ¥éå¸¸å¤šçš„é”™ï¼Œè¯·å‚è€ƒAndroid 12Â APIè§„èŒƒï¼šè¯·å‚è€ƒ https://www.cnblogs.com/wanghongzhu/p/14729469.html ã€‚ é’ˆå¯¹ä¸Šè¿°ä»£ç æ‰€çŠ¯çš„é”™è¯¯ï¼Œä¹Ÿå°±æ˜¯å¤§å®¶åœ¨Android 12ç‰ˆæœ¬ä¸­ä½¿ç”¨make -j32 framework-minus-apexç¼–è¯‘frameworkå±‚çš„æŠ¥é”™ä¿®æ”¹ã€‚ 2.2.1 AIDLæ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆçš„Javaæ–‡ä»¶æŠ¥é”™ è¿™æ˜¯å› ä¸ºAIDLè‡ªåŠ¨ç”Ÿæˆçš„Javaæ–‡ä»¶ä¸æ»¡è¶³Android 12 framework APIçš„è§„èŒƒï¼šframeworkå±‚ä¸èƒ½ç›´æ¥æš´éœ²åŸç”ŸAIDLæ–‡ä»¶ã€‚ ä¿®æ”¹çš„æ–¹å¼æ˜¯åœ¨aidlæ–‡ä»¶ä¸Šæ·»åŠ @hideï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œè¿™æ ·å°±å¯ä»¥è§£å†³æ‰€æœ‰AIDLè‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶ã€‚ï¼ˆè¿™æ˜¯æ‰’éå›½å†…å…¨ç½‘éƒ½æ²¡åœ¨æ‰¾åˆ°ï¼Œåœ¨Googleä¸­æ‰æ‰¾åˆ°çš„æ ¹æœ¬è§£å†³åŠæ³•ï¼‰ package android.app.devicemanager;import android.app.devicemanager.DeviceEntity;import android.app.devicemanager.IDeviceObserver;interface IDeviceManager {int bindDivice(int deviceId); DeviceEntity getDeviceEntity(int deviceId);void registerDeviceObserver(in IDeviceObserver observer);void unregisterDeviceObserver(in IDeviceObserver observer);} out/srcjars/android/app/devicemanager/IDiviceObserver.java:60: error: Methods calling system APIs should rethrow `RemoteException` as `RuntimeException` (but do not list it in the throws clause) [RethrowRemoteException] out/srcjars/android/app/devicemanager/IDiviceObserver.java:70: error: Missing nullability on method `asBinder` return [MissingNullability] out/srcjars/android/app/devicemanager/IDiviceObserver.java:75: error: Raw AIDL interfaces must not be exposed: Stub extends Binder [RawAidl] 2.2.2 AIDLæ–‡ä»¶Observer/Callback/Listenerå‘½åæŠ¥é”™ä¿®æ”¹ Observerå‘½åæŠ¥é”™ï¼ŒAndroid Lint å·¥å…·å¯¹callbackå’Œlisteneræœ‰ä¸¥æ ¼çš„æ ¡éªŒï¼Œä¸å»ºè®®ä½¿ç”¨Observerä½œä¸ºå›è°ƒï¼Œè¦ç”¨callbackæˆ–è€…listenerã€‚ å½“åªæœ‰ä¸€ä¸ªå›è°ƒæ–¹æ³•ä¸”æ°¸è¿œä¸ä¼šæœ‰å…¶ä»–å›è°ƒæ–¹æ³•æ—¶ä½¿ç”¨Listenerï¼Œä¸”æ³¨å†Œç›‘å¬å’Œè§£æ³¨å†Œç›‘å¬çš„æ–¹æ³•å¿…é¡»æ˜¯add/removeå¼€å¤´ï¼Œå¦åˆ™Android Lintç¼–è¯‘ä¸è¿‡ã€‚ å½“æœ‰å¤šä¸ªå›è°ƒæ–¹æ³•æ—¶ï¼Œæˆ–è€…æœ‰å…³è”çš„å¸¸é‡æ—¶ï¼Œåº”è¯¥ä½¿ç”¨Callbackã€‚Callbackç±»å¯ä»¥æ˜¯ä¸€ä¸ªinterfaceæˆ–è€…abstract classã€‚æ·»åŠ callbackå’Œå»æ‰callbackåº”è¯¥ä½¿ç”¨registerå’Œunregisterå¼€å¤´çš„æ–¹æ³•ã€‚ callbackä¸­çš„æ–¹æ³•åº”è¯¥ä»¥on-å¼€å¤´ã€‚ è¯·ä¸­æ‹›çš„å°ä¼™ä¼´è‡ªè¡Œä¿®æ”¹ã€‚ 2.2.3 æ³¨å†Œæ–¹æ³•æŠ¥é”™ Registration methods should have overload that accepts delivery Executor: `registerDeviceCallback` [ExecutorRegistration] æ˜¯ä¸æ˜¯ä¸€è„¸æ‡µï¼Œçœ‹ä¸æ˜ç™½å•¥æ„æ€ï¼Œä»¥å‰å¾ˆæ—©çš„frameworkå±‚çš„managerï¼Œæ²¡å•¥å‚è€ƒä»·å€¼ï¼Œæ¨èå‚è€ƒæ–°çš„managerå’ŒAPIè§„èŒƒï¼Œå› ä¸ºç°æœ‰çš„æ³¨å†Œå›è°ƒçš„æ–¹æ³•å¿…é¡»æ˜¯ä¸¤ä¸ªå‚æ•°ï¼Œå…¶ä¸­ä¸€ä¸ªå¿…é¡»ä¸ºExecutorï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ public void registerFooCallback( @NonNull @CallbackExecutor Executor executor,@NonNull FooCallback callback)public void unregisterFooCallback(@NonNull FooCallback callback) {} 2.2.4Â é¿å…ä½¿ç”¨æšä¸¾ç±»enum åœ¨Frameworkå±‚ä½¿ç”¨enumä¼šæŠ¥é”™ï¼šEnums are discouraged in Android APIs [Enum]ï¼Œå› æ­¤ä¸€èˆ¬éƒ½ç”¨@intDefä»£æ›¿ï¼Œä½¿ç”¨æ–°çš„æ³¨è§£è¡¨ç¤ºã€‚ 2.2.5 Callbackå¦‚ä½•è®©APPè®¿é—®åˆ° å‰è¾¹2.2.1 AIDLæ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆçš„Javaæ–‡ä»¶æŠ¥é”™ï¼Œä¸ºäº†è§£å†³éœ€è¦æ·»åŠ @hideï¼Œä½†æ˜¯æ·»åŠ è¯¥æ³¨è§£åï¼ŒAppså°±è®¿é—®ä¸åˆ°è¯¥callbackï¼Œå¦‚ä½•å®ç°Binderé€šä¿¡å‘¢ï¼Ÿ è§£å†³åŠæ³•ï¼š åˆ›å»ºä¸€ä¸ªpublic abstract class DeviceCallbackï¼Œå¯¹appsæš´éœ²è¯¥ç±»ï¼Œè®©Appsæ·»åŠ æ³¨å†Œçš„æ—¶å€™åˆ›å»ºè¯¥ç±»çš„å®ä¾‹ã€‚ ç„¶åå†frameworkå±‚managerä¸­å®ç°DeviceManagerç±»ä¸IDeviceCallback.aidlçš„ä¸€ä¸€æ˜ å°„å…³ç³»ã€‚ è¿™æ ·åšçš„å¥½å¤„ï¼š å³èƒ½é¿å…æš´éœ²åŸç”Ÿçš„AIDLæ–‡ä»¶ï¼Œè€Œä¸”Appsä¸ç”¨å®ç°ICallback.aidlä¸­æ‰€æœ‰çš„æ–¹æ³•ã€‚ //åˆ›å»ºæš´éœ²ç»™Appsçš„æŠ½è±¡ç±»Â package android.app.devicemanager;public abstract class DiviceCallback {void onBindChanged(int state, int deviceId);void onStateChanged(int state, int deviceId);} //Managerä¸­å¯¹åº”çš„æ˜ å°„å…³ç³»Â package android.app.devicemanager;import android.app.devicemanager.IDeiceCallback;import android.app.devicemanager.DevoceCallback;import java.util.concurrent.Executor;public class DeviceManager {private ArrayMap mCallbackMap = new ArrayMap\u003c\u003e();private static final class DeviceCallbackEntry extends IDeviceCallback.Stub {final DeviceCallback mCallback;final Executor mExecutor; DeviceCallbackEntry( DeviceCallback callback, Executor executor) { mCallback = callback; mExecutor = executor; }public void onBindChanged(int state, int deviceId) { mExecutor.executor(() -\u003e mCallback.onBindChanged(state, deviceId)); } ... }public void registerDeviceCallback(@Nullable Executor executor,@NonNull DeviceCallback callback) {if(callback == null || mCallbackMap.containsKey(calback)) {return; }DeviceCallbackEntry entry = new DeviceCallbackEntry(callback, executor); mCallbackMap.put(callback, entry);final IDeviceManager service = getService();try { service.registerDeviceCallback(entry); } catch (RemoteException e) {throw e.rethrowFromSystemServer(); } }} ","date":"2024-11-06","objectID":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/:2:2","tags":["clippings","è½¬è½½","blog"],"title":"Frameworkå±‚æ·»åŠ SystemServiceå’ŒManagerçš„è¶…è¯¦ç»†æ­¥éª¤_frameworkæ·»åŠ æ–°service-CSDNåšå®¢","uri":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/#223-æ³¨å†Œæ–¹æ³•æŠ¥é”™"},{"categories":null,"collections":["PMS","Framework"],"content":"2.2 æŠ¥é”™ä¿®æ”¹ ä¸Šè¿°å†™æ³•ä¼šæŠ¥éå¸¸å¤šçš„é”™ï¼Œè¯·å‚è€ƒAndroid 12Â APIè§„èŒƒï¼šè¯·å‚è€ƒ https://www.cnblogs.com/wanghongzhu/p/14729469.html ã€‚ é’ˆå¯¹ä¸Šè¿°ä»£ç æ‰€çŠ¯çš„é”™è¯¯ï¼Œä¹Ÿå°±æ˜¯å¤§å®¶åœ¨Android 12ç‰ˆæœ¬ä¸­ä½¿ç”¨make -j32 framework-minus-apexç¼–è¯‘frameworkå±‚çš„æŠ¥é”™ä¿®æ”¹ã€‚ 2.2.1 AIDLæ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆçš„Javaæ–‡ä»¶æŠ¥é”™ è¿™æ˜¯å› ä¸ºAIDLè‡ªåŠ¨ç”Ÿæˆçš„Javaæ–‡ä»¶ä¸æ»¡è¶³Android 12 framework APIçš„è§„èŒƒï¼šframeworkå±‚ä¸èƒ½ç›´æ¥æš´éœ²åŸç”ŸAIDLæ–‡ä»¶ã€‚ ä¿®æ”¹çš„æ–¹å¼æ˜¯åœ¨aidlæ–‡ä»¶ä¸Šæ·»åŠ @hideï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œè¿™æ ·å°±å¯ä»¥è§£å†³æ‰€æœ‰AIDLè‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶ã€‚ï¼ˆè¿™æ˜¯æ‰’éå›½å†…å…¨ç½‘éƒ½æ²¡åœ¨æ‰¾åˆ°ï¼Œåœ¨Googleä¸­æ‰æ‰¾åˆ°çš„æ ¹æœ¬è§£å†³åŠæ³•ï¼‰ package android.app.devicemanager;import android.app.devicemanager.DeviceEntity;import android.app.devicemanager.IDeviceObserver;interface IDeviceManager {int bindDivice(int deviceId); DeviceEntity getDeviceEntity(int deviceId);void registerDeviceObserver(in IDeviceObserver observer);void unregisterDeviceObserver(in IDeviceObserver observer);} out/srcjars/android/app/devicemanager/IDiviceObserver.java:60: error: Methods calling system APIs should rethrow `RemoteException` as `RuntimeException` (but do not list it in the throws clause) [RethrowRemoteException] out/srcjars/android/app/devicemanager/IDiviceObserver.java:70: error: Missing nullability on method `asBinder` return [MissingNullability] out/srcjars/android/app/devicemanager/IDiviceObserver.java:75: error: Raw AIDL interfaces must not be exposed: Stub extends Binder [RawAidl] 2.2.2 AIDLæ–‡ä»¶Observer/Callback/Listenerå‘½åæŠ¥é”™ä¿®æ”¹ Observerå‘½åæŠ¥é”™ï¼ŒAndroid Lint å·¥å…·å¯¹callbackå’Œlisteneræœ‰ä¸¥æ ¼çš„æ ¡éªŒï¼Œä¸å»ºè®®ä½¿ç”¨Observerä½œä¸ºå›è°ƒï¼Œè¦ç”¨callbackæˆ–è€…listenerã€‚ å½“åªæœ‰ä¸€ä¸ªå›è°ƒæ–¹æ³•ä¸”æ°¸è¿œä¸ä¼šæœ‰å…¶ä»–å›è°ƒæ–¹æ³•æ—¶ä½¿ç”¨Listenerï¼Œä¸”æ³¨å†Œç›‘å¬å’Œè§£æ³¨å†Œç›‘å¬çš„æ–¹æ³•å¿…é¡»æ˜¯add/removeå¼€å¤´ï¼Œå¦åˆ™Android Lintç¼–è¯‘ä¸è¿‡ã€‚ å½“æœ‰å¤šä¸ªå›è°ƒæ–¹æ³•æ—¶ï¼Œæˆ–è€…æœ‰å…³è”çš„å¸¸é‡æ—¶ï¼Œåº”è¯¥ä½¿ç”¨Callbackã€‚Callbackç±»å¯ä»¥æ˜¯ä¸€ä¸ªinterfaceæˆ–è€…abstract classã€‚æ·»åŠ callbackå’Œå»æ‰callbackåº”è¯¥ä½¿ç”¨registerå’Œunregisterå¼€å¤´çš„æ–¹æ³•ã€‚ callbackä¸­çš„æ–¹æ³•åº”è¯¥ä»¥on-å¼€å¤´ã€‚ è¯·ä¸­æ‹›çš„å°ä¼™ä¼´è‡ªè¡Œä¿®æ”¹ã€‚ 2.2.3 æ³¨å†Œæ–¹æ³•æŠ¥é”™ Registration methods should have overload that accepts delivery Executor: `registerDeviceCallback` [ExecutorRegistration] æ˜¯ä¸æ˜¯ä¸€è„¸æ‡µï¼Œçœ‹ä¸æ˜ç™½å•¥æ„æ€ï¼Œä»¥å‰å¾ˆæ—©çš„frameworkå±‚çš„managerï¼Œæ²¡å•¥å‚è€ƒä»·å€¼ï¼Œæ¨èå‚è€ƒæ–°çš„managerå’ŒAPIè§„èŒƒï¼Œå› ä¸ºç°æœ‰çš„æ³¨å†Œå›è°ƒçš„æ–¹æ³•å¿…é¡»æ˜¯ä¸¤ä¸ªå‚æ•°ï¼Œå…¶ä¸­ä¸€ä¸ªå¿…é¡»ä¸ºExecutorï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ public void registerFooCallback( @NonNull @CallbackExecutor Executor executor,@NonNull FooCallback callback)public void unregisterFooCallback(@NonNull FooCallback callback) {} 2.2.4Â é¿å…ä½¿ç”¨æšä¸¾ç±»enum åœ¨Frameworkå±‚ä½¿ç”¨enumä¼šæŠ¥é”™ï¼šEnums are discouraged in Android APIs [Enum]ï¼Œå› æ­¤ä¸€èˆ¬éƒ½ç”¨@intDefä»£æ›¿ï¼Œä½¿ç”¨æ–°çš„æ³¨è§£è¡¨ç¤ºã€‚ 2.2.5 Callbackå¦‚ä½•è®©APPè®¿é—®åˆ° å‰è¾¹2.2.1 AIDLæ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆçš„Javaæ–‡ä»¶æŠ¥é”™ï¼Œä¸ºäº†è§£å†³éœ€è¦æ·»åŠ @hideï¼Œä½†æ˜¯æ·»åŠ è¯¥æ³¨è§£åï¼ŒAppså°±è®¿é—®ä¸åˆ°è¯¥callbackï¼Œå¦‚ä½•å®ç°Binderé€šä¿¡å‘¢ï¼Ÿ è§£å†³åŠæ³•ï¼š åˆ›å»ºä¸€ä¸ªpublic abstract class DeviceCallbackï¼Œå¯¹appsæš´éœ²è¯¥ç±»ï¼Œè®©Appsæ·»åŠ æ³¨å†Œçš„æ—¶å€™åˆ›å»ºè¯¥ç±»çš„å®ä¾‹ã€‚ ç„¶åå†frameworkå±‚managerä¸­å®ç°DeviceManagerç±»ä¸IDeviceCallback.aidlçš„ä¸€ä¸€æ˜ å°„å…³ç³»ã€‚ è¿™æ ·åšçš„å¥½å¤„ï¼š å³èƒ½é¿å…æš´éœ²åŸç”Ÿçš„AIDLæ–‡ä»¶ï¼Œè€Œä¸”Appsä¸ç”¨å®ç°ICallback.aidlä¸­æ‰€æœ‰çš„æ–¹æ³•ã€‚ //åˆ›å»ºæš´éœ²ç»™Appsçš„æŠ½è±¡ç±»Â package android.app.devicemanager;public abstract class DiviceCallback {void onBindChanged(int state, int deviceId);void onStateChanged(int state, int deviceId);} //Managerä¸­å¯¹åº”çš„æ˜ å°„å…³ç³»Â package android.app.devicemanager;import android.app.devicemanager.IDeiceCallback;import android.app.devicemanager.DevoceCallback;import java.util.concurrent.Executor;public class DeviceManager {private ArrayMap mCallbackMap = new ArrayMap\u003c\u003e();private static final class DeviceCallbackEntry extends IDeviceCallback.Stub {final DeviceCallback mCallback;final Executor mExecutor; DeviceCallbackEntry( DeviceCallback callback, Executor executor) { mCallback = callback; mExecutor = executor; }public void onBindChanged(int state, int deviceId) { mExecutor.executor(() -\u003e mCallback.onBindChanged(state, deviceId)); } ... }public void registerDeviceCallback(@Nullable Executor executor,@NonNull DeviceCallback callback) {if(callback == null || mCallbackMap.containsKey(calback)) {return; }DeviceCallbackEntry entry = new DeviceCallbackEntry(callback, executor); mCallbackMap.put(callback, entry);final IDeviceManager service = getService();try { service.registerDeviceCallback(entry); } catch (RemoteException e) {throw e.rethrowFromSystemServer(); } }} ","date":"2024-11-06","objectID":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/:2:2","tags":["clippings","è½¬è½½","blog"],"title":"Frameworkå±‚æ·»åŠ SystemServiceå’ŒManagerçš„è¶…è¯¦ç»†æ­¥éª¤_frameworkæ·»åŠ æ–°service-CSDNåšå®¢","uri":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/#224é¿å…ä½¿ç”¨æšä¸¾ç±»enum"},{"categories":null,"collections":["PMS","Framework"],"content":"2.2 æŠ¥é”™ä¿®æ”¹ ä¸Šè¿°å†™æ³•ä¼šæŠ¥éå¸¸å¤šçš„é”™ï¼Œè¯·å‚è€ƒAndroid 12Â APIè§„èŒƒï¼šè¯·å‚è€ƒ https://www.cnblogs.com/wanghongzhu/p/14729469.html ã€‚ é’ˆå¯¹ä¸Šè¿°ä»£ç æ‰€çŠ¯çš„é”™è¯¯ï¼Œä¹Ÿå°±æ˜¯å¤§å®¶åœ¨Android 12ç‰ˆæœ¬ä¸­ä½¿ç”¨make -j32 framework-minus-apexç¼–è¯‘frameworkå±‚çš„æŠ¥é”™ä¿®æ”¹ã€‚ 2.2.1 AIDLæ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆçš„Javaæ–‡ä»¶æŠ¥é”™ è¿™æ˜¯å› ä¸ºAIDLè‡ªåŠ¨ç”Ÿæˆçš„Javaæ–‡ä»¶ä¸æ»¡è¶³Android 12 framework APIçš„è§„èŒƒï¼šframeworkå±‚ä¸èƒ½ç›´æ¥æš´éœ²åŸç”ŸAIDLæ–‡ä»¶ã€‚ ä¿®æ”¹çš„æ–¹å¼æ˜¯åœ¨aidlæ–‡ä»¶ä¸Šæ·»åŠ @hideï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œè¿™æ ·å°±å¯ä»¥è§£å†³æ‰€æœ‰AIDLè‡ªåŠ¨ç”Ÿæˆçš„æ–‡ä»¶ã€‚ï¼ˆè¿™æ˜¯æ‰’éå›½å†…å…¨ç½‘éƒ½æ²¡åœ¨æ‰¾åˆ°ï¼Œåœ¨Googleä¸­æ‰æ‰¾åˆ°çš„æ ¹æœ¬è§£å†³åŠæ³•ï¼‰ package android.app.devicemanager;import android.app.devicemanager.DeviceEntity;import android.app.devicemanager.IDeviceObserver;interface IDeviceManager {int bindDivice(int deviceId); DeviceEntity getDeviceEntity(int deviceId);void registerDeviceObserver(in IDeviceObserver observer);void unregisterDeviceObserver(in IDeviceObserver observer);} out/srcjars/android/app/devicemanager/IDiviceObserver.java:60: error: Methods calling system APIs should rethrow `RemoteException` as `RuntimeException` (but do not list it in the throws clause) [RethrowRemoteException] out/srcjars/android/app/devicemanager/IDiviceObserver.java:70: error: Missing nullability on method `asBinder` return [MissingNullability] out/srcjars/android/app/devicemanager/IDiviceObserver.java:75: error: Raw AIDL interfaces must not be exposed: Stub extends Binder [RawAidl] 2.2.2 AIDLæ–‡ä»¶Observer/Callback/Listenerå‘½åæŠ¥é”™ä¿®æ”¹ Observerå‘½åæŠ¥é”™ï¼ŒAndroid Lint å·¥å…·å¯¹callbackå’Œlisteneræœ‰ä¸¥æ ¼çš„æ ¡éªŒï¼Œä¸å»ºè®®ä½¿ç”¨Observerä½œä¸ºå›è°ƒï¼Œè¦ç”¨callbackæˆ–è€…listenerã€‚ å½“åªæœ‰ä¸€ä¸ªå›è°ƒæ–¹æ³•ä¸”æ°¸è¿œä¸ä¼šæœ‰å…¶ä»–å›è°ƒæ–¹æ³•æ—¶ä½¿ç”¨Listenerï¼Œä¸”æ³¨å†Œç›‘å¬å’Œè§£æ³¨å†Œç›‘å¬çš„æ–¹æ³•å¿…é¡»æ˜¯add/removeå¼€å¤´ï¼Œå¦åˆ™Android Lintç¼–è¯‘ä¸è¿‡ã€‚ å½“æœ‰å¤šä¸ªå›è°ƒæ–¹æ³•æ—¶ï¼Œæˆ–è€…æœ‰å…³è”çš„å¸¸é‡æ—¶ï¼Œåº”è¯¥ä½¿ç”¨Callbackã€‚Callbackç±»å¯ä»¥æ˜¯ä¸€ä¸ªinterfaceæˆ–è€…abstract classã€‚æ·»åŠ callbackå’Œå»æ‰callbackåº”è¯¥ä½¿ç”¨registerå’Œunregisterå¼€å¤´çš„æ–¹æ³•ã€‚ callbackä¸­çš„æ–¹æ³•åº”è¯¥ä»¥on-å¼€å¤´ã€‚ è¯·ä¸­æ‹›çš„å°ä¼™ä¼´è‡ªè¡Œä¿®æ”¹ã€‚ 2.2.3 æ³¨å†Œæ–¹æ³•æŠ¥é”™ Registration methods should have overload that accepts delivery Executor: `registerDeviceCallback` [ExecutorRegistration] æ˜¯ä¸æ˜¯ä¸€è„¸æ‡µï¼Œçœ‹ä¸æ˜ç™½å•¥æ„æ€ï¼Œä»¥å‰å¾ˆæ—©çš„frameworkå±‚çš„managerï¼Œæ²¡å•¥å‚è€ƒä»·å€¼ï¼Œæ¨èå‚è€ƒæ–°çš„managerå’ŒAPIè§„èŒƒï¼Œå› ä¸ºç°æœ‰çš„æ³¨å†Œå›è°ƒçš„æ–¹æ³•å¿…é¡»æ˜¯ä¸¤ä¸ªå‚æ•°ï¼Œå…¶ä¸­ä¸€ä¸ªå¿…é¡»ä¸ºExecutorï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ public void registerFooCallback( @NonNull @CallbackExecutor Executor executor,@NonNull FooCallback callback)public void unregisterFooCallback(@NonNull FooCallback callback) {} 2.2.4Â é¿å…ä½¿ç”¨æšä¸¾ç±»enum åœ¨Frameworkå±‚ä½¿ç”¨enumä¼šæŠ¥é”™ï¼šEnums are discouraged in Android APIs [Enum]ï¼Œå› æ­¤ä¸€èˆ¬éƒ½ç”¨@intDefä»£æ›¿ï¼Œä½¿ç”¨æ–°çš„æ³¨è§£è¡¨ç¤ºã€‚ 2.2.5 Callbackå¦‚ä½•è®©APPè®¿é—®åˆ° å‰è¾¹2.2.1 AIDLæ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆçš„Javaæ–‡ä»¶æŠ¥é”™ï¼Œä¸ºäº†è§£å†³éœ€è¦æ·»åŠ @hideï¼Œä½†æ˜¯æ·»åŠ è¯¥æ³¨è§£åï¼ŒAppså°±è®¿é—®ä¸åˆ°è¯¥callbackï¼Œå¦‚ä½•å®ç°Binderé€šä¿¡å‘¢ï¼Ÿ è§£å†³åŠæ³•ï¼š åˆ›å»ºä¸€ä¸ªpublic abstract class DeviceCallbackï¼Œå¯¹appsæš´éœ²è¯¥ç±»ï¼Œè®©Appsæ·»åŠ æ³¨å†Œçš„æ—¶å€™åˆ›å»ºè¯¥ç±»çš„å®ä¾‹ã€‚ ç„¶åå†frameworkå±‚managerä¸­å®ç°DeviceManagerç±»ä¸IDeviceCallback.aidlçš„ä¸€ä¸€æ˜ å°„å…³ç³»ã€‚ è¿™æ ·åšçš„å¥½å¤„ï¼š å³èƒ½é¿å…æš´éœ²åŸç”Ÿçš„AIDLæ–‡ä»¶ï¼Œè€Œä¸”Appsä¸ç”¨å®ç°ICallback.aidlä¸­æ‰€æœ‰çš„æ–¹æ³•ã€‚ //åˆ›å»ºæš´éœ²ç»™Appsçš„æŠ½è±¡ç±»Â package android.app.devicemanager;public abstract class DiviceCallback {void onBindChanged(int state, int deviceId);void onStateChanged(int state, int deviceId);} //Managerä¸­å¯¹åº”çš„æ˜ å°„å…³ç³»Â package android.app.devicemanager;import android.app.devicemanager.IDeiceCallback;import android.app.devicemanager.DevoceCallback;import java.util.concurrent.Executor;public class DeviceManager {private ArrayMap mCallbackMap = new ArrayMap\u003c\u003e();private static final class DeviceCallbackEntry extends IDeviceCallback.Stub {final DeviceCallback mCallback;final Executor mExecutor; DeviceCallbackEntry( DeviceCallback callback, Executor executor) { mCallback = callback; mExecutor = executor; }public void onBindChanged(int state, int deviceId) { mExecutor.executor(() -\u003e mCallback.onBindChanged(state, deviceId)); } ... }public void registerDeviceCallback(@Nullable Executor executor,@NonNull DeviceCallback callback) {if(callback == null || mCallbackMap.containsKey(calback)) {return; }DeviceCallbackEntry entry = new DeviceCallbackEntry(callback, executor); mCallbackMap.put(callback, entry);final IDeviceManager service = getService();try { service.registerDeviceCallback(entry); } catch (RemoteException e) {throw e.rethrowFromSystemServer(); } }} ","date":"2024-11-06","objectID":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/:2:2","tags":["clippings","è½¬è½½","blog"],"title":"Frameworkå±‚æ·»åŠ SystemServiceå’ŒManagerçš„è¶…è¯¦ç»†æ­¥éª¤_frameworkæ·»åŠ æ–°service-CSDNåšå®¢","uri":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/#225-callbackå¦‚ä½•è®©appè®¿é—®åˆ°"},{"categories":null,"collections":["PMS","Framework"],"content":"3. Contextä¸­å®šä¹‰service name åœ¨frameworks/base/core/java/android/content/Context.javaä¸­å¢åŠ ä¸€å¥ public static final String DEVICE_MANAGER_SERVICE = \"device_manager\"; ","date":"2024-11-06","objectID":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/:3:0","tags":["clippings","è½¬è½½","blog"],"title":"Frameworkå±‚æ·»åŠ SystemServiceå’ŒManagerçš„è¶…è¯¦ç»†æ­¥éª¤_frameworkæ·»åŠ æ–°service-CSDNåšå®¢","uri":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/#3-contextä¸­å®šä¹‰service-name"},{"categories":null,"collections":["PMS","Framework"],"content":"4. ç¼–å†™SystemService **åœ¨framework/base/services/core/java/com/android/service/ä¸‹åˆ›å»ºç³»ç»ŸæœåŠ¡ï¼Œ**å¦‚æœä¸šåŠ¡æ¯”è¾ƒå¤æ‚ï¼Œå¯ä»¥åˆ›å»ºæ¨¡å—æ–‡ä»¶å¤¹ã€‚ framework/base/services/core/java/com/android/service/devicemanage/DeviceManagerService.java extends IDeviceManager.Stubï¼Œé‡å†™è¯¥AILDæ–‡ä»¶ä¸­æ–¹æ³•ã€‚è¯¥AIDLæ–‡ä»¶æ˜¯SystemServiceä¸ç³»ç»Ÿmanagerè¿›è¡ŒIPCçš„æ¡¥æ¢ã€‚ å®šä¹‰é™æ€å†…éƒ¨ç±»Lifecycleï¼Œextends SystemServiceï¼Œé‡å†™onStart()æ–¹æ³•ï¼ŒæŠŠDeviceManagerServiceå‘å¸ƒåˆ°ServiceMangeræœåŠ¡ä¸­ã€‚ package com.android.service.devicemanager;import android.app.devicemanager.DeviceEntity;import android.content.Context;import android.app.devicemanager.IDeviceManager;import android.app.devicemanager.IDeviceObserver;import android.os.RemoteException;public class DeviceManagerService extends IDeviceManager.Stub {private final Context mContext;public DeviceManagerService(Context mContext) {this.mContext = mContext; }public static class Lifecycle extends SystemService {private final DeciceManagerService mService;public Lifecycle(Context context) {super(context); mService = new DeciceManagerService(context); }@Overridepublic void onStart() { publishBinderService(Context.DEVICE_MANAGER_SERVICE, mService); } }@Overridepublic int bindDivice(int deviceId) throws RemoteException {return 0; }@Overridepublic DeviceEntity getDeviceEntity(int deviceId) throws RemoteException {return null; }@Overridepublic void registerDeviceObserver(IDeviceObserver observer) { }@Overridepublic void unregisterDeviceObserver(IDeviceObserver observer) throws RemoteException { }} ","date":"2024-11-06","objectID":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/:4:0","tags":["clippings","è½¬è½½","blog"],"title":"Frameworkå±‚æ·»åŠ SystemServiceå’ŒManagerçš„è¶…è¯¦ç»†æ­¥éª¤_frameworkæ·»åŠ æ–°service-CSDNåšå®¢","uri":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/#4-ç¼–å†™systemservice"},{"categories":null,"collections":["PMS","Framework"],"content":"5. åœ¨SystemServerç±»ä¸­æ³¨å†Œæ–°å¢çš„ç³»ç»ŸæœåŠ¡ **åœ¨frameworks/base/services/java/com/android/server/SystemServer.javaçš„startOtherServices()**ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç  t.traceBegin(\"StartLocationManagerService\");mSystemServiceManager.startService(DeviceManagerService.Lifecycle.class);t.traceEnd(); ","date":"2024-11-06","objectID":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/:5:0","tags":["clippings","è½¬è½½","blog"],"title":"Frameworkå±‚æ·»åŠ SystemServiceå’ŒManagerçš„è¶…è¯¦ç»†æ­¥éª¤_frameworkæ·»åŠ æ–°service-CSDNåšå®¢","uri":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/#5-åœ¨systemserverç±»ä¸­æ³¨å†Œæ–°å¢çš„ç³»ç»ŸæœåŠ¡"},{"categories":null,"collections":["PMS","Framework"],"content":"6. ç¼–å†™ç³»ç»ŸManagerç±» åœ¨framework/base/core/java/android/app/devicemanagerä¸‹åˆ›å»ºDeviceManagerç±» åœ¨DeviceManagerç±»ä¸ŠåŠ æ³¨è§£@SystemService()ï¼Œå‚æ•°æ˜¯ç¬¬2æ­¥ä¸­Contextä¸­å®šä¹‰service nameã€‚æ³¨æ„è¯¥å‚æ•°ä¸DeviceManagerServiceä¸­çš„é™æ€å†…éƒ¨ç±»çš„Lifecycleçš„onStart()æ–¹æ³•ä¸­publishBinderService(Context.DEVICE_MANAGER_SERVICE, mService)ä¸€è‡´ã€‚ å®ç°getService()æ–¹æ³•ï¼Œè¿”å›IDeviceManagerçš„å•ä¾‹ï¼› åˆ©ç”¨Singletonå·¥å…·ç±»é€šè¿‡Binderè·å–DeviceManagerServiceçš„å•ä¾‹ï¼› å¯¹å¤–æä¾›æ¥å£ï¼Œå†…éƒ¨å®ç°è°ƒç”¨serviceå¯¹åº”çš„å®ç°æ¥å£ã€‚ package android.app.devicemanager;import android.content.Context;import android.os.IBinder;import android.os.RemoteException;@SystemService(Context.DEVICE_MANAGER_SERVICE)public class DeviceManager {private mContext mContext;private DeviceManager(Context context) {this.mContext = context; }public static IDeviceManager getService() {return IDeviceManagerSingleton.get(); }public static final Singleton\u003cIDeviceManager\u003e IDeviceManagerSingleton = () -\u003e {final IBinder binder = ServiceManager.getService(Context.DEVICE_MANAGER_SERVICE);return IDeviceManager.Stub.asInterface(binder); };public int bindDivice(int deviceId) {final IDeviceManager service = getService();try {return service.bindDivice(deviceId); } catch (RemoteException e) {throw e.rethrowFromSystemServer(); } }} ","date":"2024-11-06","objectID":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/:6:0","tags":["clippings","è½¬è½½","blog"],"title":"Frameworkå±‚æ·»åŠ SystemServiceå’ŒManagerçš„è¶…è¯¦ç»†æ­¥éª¤_frameworkæ·»åŠ æ–°service-CSDNåšå®¢","uri":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/#6-ç¼–å†™ç³»ç»Ÿmanagerç±»"},{"categories":null,"collections":["PMS","Framework"],"content":"7. æ³¨å†Œç³»ç»ŸManagerç±» åœ¨framework/base/core/java/android/app/SystemServiceRegistry.javaç±»çš„jé™æ€ä»£ç å—static{}ä¸­å¢åŠ ä»¥ä¸‹ä»£ç  registerService(Context.DEVICE_MANAGER_SERVICE, DeviceManager.class, new CachedServiceFetcher\u003cDeviceManager\u003e() {@Overridepublic DeviceManager createService(ContextImpl ctx) {return new DeviceManager(ctx.getOuterContext()); }}); ","date":"2024-11-06","objectID":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/:7:0","tags":["clippings","è½¬è½½","blog"],"title":"Frameworkå±‚æ·»åŠ SystemServiceå’ŒManagerçš„è¶…è¯¦ç»†æ­¥éª¤_frameworkæ·»åŠ æ–°service-CSDNåšå®¢","uri":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/#7-æ³¨å†Œç³»ç»Ÿmanagerç±»"},{"categories":null,"collections":["PMS","Framework"],"content":"8. åº”ç”¨è°ƒç”¨ DeviceManager mDeviceManager = (DeviceManager) mContext.getSystemService(Context.DEVICE_MANAGER_SERVICE);int deviceId = 1;mDeviceManager.bindDevice(deviceId); ä»¥ä¸Šæ˜¯åœ¨frameworkå±‚æ·»åŠ ä¸€ä¸ªå®Œæ•´SystemServiceå’Œmanagerçš„è¿‡ç¨‹ã€‚ åœ¨Android 12ä¸­æ·»åŠ ä¸€ä¸ªç³»ç»Ÿserviceï¼Œç®€ç›´åˆ°å¤„è¸©é›·ï¼Œé˜…è¯»äº†æ•´ä¸ªAPIè§„èŒƒï¼Œå„ç§è¿½è¸ªæºç ï¼Œæ‰æŠŠframeworkå±‚çš„ç¼–è¯‘é€šè¿‡ï¼Œå¦‚æœä½ å–œæ¬¢è¯·æ”¶è—æˆ–è€…ç‚¹èµå“¦ï¼ ","date":"2024-11-06","objectID":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/:8:0","tags":["clippings","è½¬è½½","blog"],"title":"Frameworkå±‚æ·»åŠ SystemServiceå’ŒManagerçš„è¶…è¯¦ç»†æ­¥éª¤_frameworkæ·»åŠ æ–°service-CSDNåšå®¢","uri":"/posts/framework%E5%B1%82%E6%B7%BB%E5%8A%A0systemservice%E5%92%8Cmanager%E7%9A%84%E8%B6%85%E8%AF%A6%E7%BB%86%E6%AD%A5%E9%AA%A4_framework%E6%B7%BB%E5%8A%A0%E6%96%B0service-csdn%E5%8D%9A%E5%AE%A2/#8-åº”ç”¨è°ƒç”¨"},{"categories":null,"collections":["SurfaceControl","Framework","å›¾å½¢æ˜¾ç¤º"],"content":"SurfaceComposerClientåˆ›å»º SurfaceComposerClientå¯¹è±¡æ˜¯åœ¨å“ªé‡Œåˆ›å»ºçš„å‘¢?æ˜¯åœ¨SurfaceSessionæ„é€ æ—¶å€™åˆ›å»º frameworks/base/core/jni/android_view_SurfaceSession.cpp static jlong nativeCreate(JNIEnv* env, jclass clazz) { SurfaceComposerClient* client = new SurfaceComposerClient(); client-\u003eincStrong((void*)nativeCreate); return reinterpret_cast\u003cjlong\u003e(client); } è¿™é‡Œçš„SurfaceSessionæ˜¯åœ¨å“ªé‡Œåˆ›å»ºçš„å‘¢ï¼Ÿè¿™é‡Œç›´æ¥ä¸Šå †æ ˆ å®é™…æ˜¯åœ¨ViewRootImplæ„é€ æœŸé—´å°±åˆ›å»º ","date":"2024-11-06","objectID":"/posts/surfacecontrol%E5%8F%8Asurfaceflinger%E4%B8%AD%E7%9A%84layer%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:1","tags":["clippings","blog","è½¬è½½"],"title":"SurfaceControlåŠSurfaceFlingerä¸­çš„Layeråˆ›å»ºè¿‡ç¨‹æ·±å…¥å‰–æ-CSDNåšå®¢","uri":"/posts/surfacecontrol%E5%8F%8Asurfaceflinger%E4%B8%AD%E7%9A%84layer%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfacecomposerclientåˆ›å»º"},{"categories":null,"collections":["SurfaceControl","Framework","å›¾å½¢æ˜¾ç¤º"],"content":"SurfaceComposerClientçš„mClientåˆå§‹åŒ– è¿™é‡Œçš„mClientæ˜¯è°å‘¢ï¼Ÿç±»å‹æ˜¯ sp mClient; çœ‹å¾—å‡ºæ˜¯ä¸€ä¸ªæ¥å£ çœ‹ä¸‹SurfaceComposerClientæ„é€ æ—¶å€™ä¼šä¸sfè¿›è¡Œè·¨è¿›ç¨‹createConnectionåˆ›å»ºé“¾æ¥ï¼Œè¿”å›çš„å¯¹è±¡å°±æ˜¯Clientå¯¹è±¡ã€‚ void SurfaceComposerClient::onFirstRef() { sp\u003cISurfaceComposer\u003e sf(ComposerService::getComposerService()); if (sf != nullptr \u0026\u0026 mStatus == NO_INIT) { sp\u003cISurfaceComposerClient\u003e conn; conn = sf-\u003ecreateConnection(); if (conn != nullptr) { mClient = conn; mStatus = NO_ERROR; } } } è¿™é‡Œåˆå‡ºç°äº†ComposerService::getComposerService() frameworks/native/libs/gui/SurfaceComposerClient.cpp sp\u003cISurfaceComposer\u003e ComposerService::getComposerService() { ComposerService\u0026 instance = ComposerService::getInstance(); if (instance.mComposerService == nullptr) { if (ComposerService::getInstance().connectLocked()) { WindowInfosListenerReporter::getInstance()-\u003ereconnect(instance.mComposerService); } } return instance.mComposerService; } //connectLockedå®ç° bool ComposerService::connectLocked() { const String16 name(\"SurfaceFlinger\"); //å°±æ˜¯è·å–sfçš„bpä»£ç†ï¼Œèµ‹å€¼ç»™mComposerService mComposerService = waitForService\u003cISurfaceComposer\u003e(name); return true; } æ‰€ä»¥ä¸Šé¢onFirstRefä¸­sf-\u003ecreateConnection()è°ƒç”¨åˆ°sfäº†ï¼Œsfä»£ç å¦‚ä¸‹ frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp sp\u003cISurfaceComposerClient\u003e SurfaceFlinger::createConnection() { const sp\u003cClient\u003e client = new Client(this); return client-\u003einitCheck() == NO_ERROR ? client : nullptr; } sfç«¯å°±æ˜¯ç®€å•åˆ›å»ºäº†ä¸€ä¸ªClientå¯¹è±¡ï¼Œè¿™é‡Œæ¥çœ‹çœ‹ å…¶å®Clientæœ¬è´¨æ˜¯ä¸€ä¸ªBinderå¯¹è±¡çš„BpBinderå³è·¨è¿›ç¨‹çš„ä»£ç†ï¼Œè¿œç«¯çš„BnBinderåœ¨SurfaceFlingerçš„Client.cpp æ€è€ƒä¸ºå•¥æœ‰äº†sfä»£ç†ï¼Œè¿˜éœ€è¦Clientï¼š å“ˆå“ˆï¼Œå…¶å®è¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†å¸®åŠ©sfè¿›è¡Œè§£è€¦ä¸€éƒ¨åˆ†å·¥ä½œ ","date":"2024-11-06","objectID":"/posts/surfacecontrol%E5%8F%8Asurfaceflinger%E4%B8%AD%E7%9A%84layer%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:2","tags":["clippings","blog","è½¬è½½"],"title":"SurfaceControlåŠSurfaceFlingerä¸­çš„Layeråˆ›å»ºè¿‡ç¨‹æ·±å…¥å‰–æ-CSDNåšå®¢","uri":"/posts/surfacecontrol%E5%8F%8Asurfaceflinger%E4%B8%AD%E7%9A%84layer%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfacecomposerclientçš„mclientåˆå§‹åŒ–"},{"categories":null,"collections":["SurfaceControl","Framework","å›¾å½¢æ˜¾ç¤º"],"content":"SurfaceControlï¼ŒLayeråˆ›å»º frameworks/base/core/jni/android_view_SurfaceControl.cpp static jlong nativeCreate(JNIEnv* env, jclass clazz, jobject sessionObj, jstring nameStr, jint w, jint h, jint format, jint flags, jlong parentObject, jobject metadataParcel) { sp\u003cSurfaceComposerClient\u003e client; status_t err = client-\u003ecreateSurfaceChecked(String8(name.c_str()), w, h, format, \u0026surface, flags, parentHandle, std::move(metadata)); surface-\u003eincStrong((void *)nativeCreate); return reinterpret_cast\u003cjlong\u003e(surface.get()); } ä¸»è¦è°ƒç”¨åˆ°äº†SurfaceComposerClientçš„createSurfaceCheckedã€‚ ä¸‹é¢çœ‹çœ‹ SurfaceComposerClient::createSurfaceCheckedæ–¹æ³• status_t SurfaceComposerClient::createSurfaceChecked(const String8\u0026 name, uint32_t w, uint32_t h, PixelFormat format, sp\u003cSurfaceControl\u003e* outSurface, uint32_t flags, const sp\u003cIBinder\u003e\u0026 parentHandle, LayerMetadata metadata, uint32_t* outTransformHint) { err = mClient-\u003ecreateSurface(name, w, h, format, flags, parentHandle, std::move(metadata), \u0026handle, \u0026gbp, \u0026id, \u0026transformHint); } if (err == NO_ERROR) { *outSurface = new SurfaceControl(this, handle, gbp, id, w, h, format, transformHint, flags); } return err; } æœ€åä¼šè°ƒç”¨åˆ°Clientçš„createSurface frameworks/native/services/surfaceflinger/Client.cpp status_t Client::createSurface(const String8\u0026 name, uint32_t /* w */, uint32_t /* h */, PixelFormat /* format */, uint32_t flags, const sp\u003cIBinder\u003e\u0026 parentHandle, LayerMetadata metadata, sp\u003cIBinder\u003e* outHandle, sp\u003cIGraphicBufferProducer\u003e* /* gbp */, int32_t* outLayerId, uint32_t* outTransformHint) { // We rely on createLayer to check permissions. LayerCreationArgs args(mFlinger.get(), this, name.c_str(), flags, std::move(metadata)); return mFlinger-\u003ecreateLayer(args, outHandle, parentHandle, outLayerId, nullptr, outTransformHint); } æ¥ä¸‹æ¥å°±æ˜¯è·¨è¿›ç¨‹åˆ°äº†Sfç«¯ status_t SurfaceFlinger::createLayer(LayerCreationArgs\u0026 args, sp\u003cIBinder\u003e* outHandle, const sp\u003cIBinder\u003e\u0026 parentHandle, int32_t* outLayerId, const sp\u003cLayer\u003e\u0026 parentLayer, uint32_t* outTransformHint) { sp\u003cLayer\u003e layer; //æ ¹æ®ä¸åŒçš„flagsåˆ›å»ºä¸åŒçš„Layerï¼Œå¸¸è§æƒ…å†µï¼šæœ‰bufferæ•°æ®çš„ä¸€èˆ¬æ˜¯createBufferStateLayerï¼Œæ²¡æœ‰bufferçš„å°±æ˜¯createContainerLayer switch (args.flags \u0026 ISurfaceComposerClient::eFXSurfaceMask) { case ISurfaceComposerClient::eFXSurfaceBufferQueue: case ISurfaceComposerClient::eFXSurfaceBufferState: { result = createBufferStateLayer(args, outHandle, \u0026layer); std::atomic\u003cint32_t\u003e* pendingBufferCounter = layer-\u003egetPendingBufferCounter(); if (pendingBufferCounter) { std::string counterName = layer-\u003egetPendingBufferCounterName(); mBufferCountTracker.add((*outHandle)-\u003elocalBinder(), counterName, pendingBufferCounter); } } break; case ISurfaceComposerClient::eFXSurfaceEffect: result = createEffectLayer(args, outHandle, \u0026layer); break; case ISurfaceComposerClient::eFXSurfaceContainer: result = createContainerLayer(args, outHandle, \u0026layer); break; default: result = BAD_VALUE; break; } int parentId = -1; sp\u003cLayer\u003e parentSp = parent.promote(); if (parentSp != nullptr) { parentId = parentSp-\u003egetSequence(); } //è°ƒç”¨åˆ°addClientLayeræ–¹æ³• result = addClientLayer(args.client, *outHandle, layer, parent, addToRoot, outTransformHint); if (result != NO_ERROR) { return result; } *outLayerId = layer-\u003esequence; return result; } status_t SurfaceFlinger::addClientLayer(const sp\u003cClient\u003e\u0026 client, const sp\u003cIBinder\u003e\u0026 handle, const sp\u003cLayer\u003e\u0026 layer, const wp\u003cLayer\u003e\u0026 parent, bool addToRoot, uint32_t* outTransformHint) { { //æ”¾å…¥åˆ°mCreatedLayersé›†åˆä¸­ std::scoped_lock\u003cstd::mutex\u003e lock(mCreatedLayersLock); mCreatedLayers.emplace_back(layer, parent, addToRoot); } if (client != nullptr) { /clientä¸layerä¼šè¿›è¡Œç»‘å®š client-\u003eattachLayer(handle, layer); } //è®¾ç½®äº‹ç‰©flag setTransactionFlags(eTransactionNeeded); return NO_ERROR; } ç®€å•æ€»ç»“å›¾ï¼š ) ","date":"2024-11-06","objectID":"/posts/surfacecontrol%E5%8F%8Asurfaceflinger%E4%B8%AD%E7%9A%84layer%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/:0:3","tags":["clippings","blog","è½¬è½½"],"title":"SurfaceControlåŠSurfaceFlingerä¸­çš„Layeråˆ›å»ºè¿‡ç¨‹æ·±å…¥å‰–æ-CSDNåšå®¢","uri":"/posts/surfacecontrol%E5%8F%8Asurfaceflinger%E4%B8%AD%E7%9A%84layer%E5%88%9B%E5%BB%BA%E8%BF%87%E7%A8%8B%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/#surfacecontrollayeråˆ›å»º"},{"categories":null,"collections":["SurfaceControl","å›¾å½¢æ˜¾ç¤º"],"content":"èƒŒæ™¯ å‰é¢å·²ç»è®²è§£æ¸…æ¥šäº†SurfaceControlæ•´ä¸ªåˆ›å»ºè¿‡ç¨‹ï¼Œä¸€èˆ¬SurfaceControléƒ½æ˜¯ä¸€ä¸ªé™æ€å›¾å±‚çš„ä»£è¡¨ï¼Œä½†å¾€å¾€åªæœ‰é™æ€ä¸€ä¸ªå›¾å±‚æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œå³åªæ˜¯åˆ›å»ºäº†ä¸€ä¸ªå›¾å±‚å…¶å®å•¥ä¹Ÿçœ‹ä¸åˆ°ï¼Œæ›´å¤šéœ€è¦æ˜¯SurfaceControlå¯¹åº”çš„Transaction,è¿™ä¸ªäº‹åŠ¡æ‰æ˜¯çœŸæ­£å¯ä»¥è®©SurfaceControlå¯ä»¥æ˜¾ç¤ºçš„å…³é”®æ‰€åœ¨ï¼ŒTransactionæ‰æ˜¯ç›¸å½“äºä¸€ä¸ªä¸ªçš„åŠ¨ä½œè®©SurfaceControlé™æ€ä¸œè¥¿å¯ä»¥åŠ¨èµ·æ¥ï¼Œæ¥ä¸‹æ¥å°†è¯¦ç»†åˆ†æä¸€ä¸‹Transactionã€‚ ","date":"2024-11-06","objectID":"/posts/surfacecontrol%E4%B9%8Btransaction%E4%BA%8B%E7%89%A9%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-android-framework%E5%AE%9E%E6%88%98%E5%BC%80%E5%8F%91-csdn%E5%8D%9A%E5%AE%A2/:0:1","tags":["clippings","blog","Framework"],"title":"SurfaceControlä¹‹Transactionäº‹ç‰©æ·±å…¥å‰–æ-android frameworkå®æˆ˜å¼€å‘-CSDNåšå®¢","uri":"/posts/surfacecontrol%E4%B9%8Btransaction%E4%BA%8B%E7%89%A9%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-android-framework%E5%AE%9E%E6%88%98%E5%BC%80%E5%8F%91-csdn%E5%8D%9A%E5%AE%A2/#èƒŒæ™¯"},{"categories":null,"collections":["SurfaceControl","å›¾å½¢æ˜¾ç¤º"],"content":"å¸¸è§Transactionä½¿ç”¨æ¡ˆä¾‹ private final Transaction mTransaction = new Transaction();//æ„å»ºæˆ–è€…è·å–ä¸€ä¸ªäº‹ç‰© mTransaction.setLayerStack(mSurfaceControl, mDisplayLayerStack); //å¼€å§‹ç”¨äº‹ç‰©å¯¹è±¡ï¼Œå¯¹ä¸€ä¸ªä¸ªSurfaceControlè¿›è¡Œè®¾ç½®å±æ€§ mTransaction.setWindowCrop(mSurfaceControl, mDisplayWidth, mDisplayHeight);//å¼€å§‹ç”¨äº‹ç‰©å¯¹è±¡ï¼Œå¯¹ä¸€ä¸ªä¸ªSurfaceControlè¿›è¡Œè®¾ç½®å±æ€§ mTransaction.apply();//é’ˆå¯¹äº‹ç‰©è¿›è¡Œapplyæ“ä½œ ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼ŒTransactionæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„äº‹ç‰©å¯¹è±¡ï¼Œä¸“é—¨ç”¨äºæ“ä½œä¸€ä¸ªä¸ªSurfaceControlçš„å±æ€§ï¼Œä½†å¹¶ä¸æ˜¯å±äºSurfaceControlå¯¹è±¡çš„æˆå‘˜ï¼Œå³Transactionå®Œå…¨å¯ä»¥å®ç°ä¸€å¯¹å¤šä¸ªSurfaceControlæƒ…å†µã€‚ ","date":"2024-11-06","objectID":"/posts/surfacecontrol%E4%B9%8Btransaction%E4%BA%8B%E7%89%A9%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-android-framework%E5%AE%9E%E6%88%98%E5%BC%80%E5%8F%91-csdn%E5%8D%9A%E5%AE%A2/:0:2","tags":["clippings","blog","Framework"],"title":"SurfaceControlä¹‹Transactionäº‹ç‰©æ·±å…¥å‰–æ-android frameworkå®æˆ˜å¼€å‘-CSDNåšå®¢","uri":"/posts/surfacecontrol%E4%B9%8Btransaction%E4%BA%8B%E7%89%A9%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-android-framework%E5%AE%9E%E6%88%98%E5%BC%80%E5%8F%91-csdn%E5%8D%9A%E5%AE%A2/#å¸¸è§transactionä½¿ç”¨æ¡ˆä¾‹"},{"categories":null,"collections":["SurfaceControl","å›¾å½¢æ˜¾ç¤º"],"content":"Transactionçš„æ„é€  frameworks/base/core/java/android/view/SurfaceControl.java public Transaction() { this(nativeCreateTransaction()); } æ¥çœ‹çœ‹nativeCreateTransactionæ–¹æ³• frameworks/base/core/jni/android_view_SurfaceControl.cpp static jlong nativeCreateTransaction(JNIEnv* env, jclass clazz) { return reinterpret_cast\u003cjlong\u003e(new SurfaceComposerClient::Transaction); } å°±æ˜¯ç®€å•çš„æ„é€ äº†ä¸€ä¸ªSurfaceComposerClient::Transactionå¯¹è±¡ frameworks/native/libs/gui/SurfaceComposerClient.cpp SurfaceComposerClient::Transaction::Transaction() { mId = generateId(); } å¯ä»¥çœ‹åˆ°å¦‚æœé»˜è®¤çš„æ„é€ çš„Transactionå…¶å®å•¥ä¹Ÿæ²¡æœ‰å¹²ï¼Œå°±æ˜¯ç”Ÿæˆäº†ä¸ªIdç„¶åèµ‹å€¼ç»™äº†mIdæˆå‘˜å˜é‡ã€‚ ","date":"2024-11-06","objectID":"/posts/surfacecontrol%E4%B9%8Btransaction%E4%BA%8B%E7%89%A9%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-android-framework%E5%AE%9E%E6%88%98%E5%BC%80%E5%8F%91-csdn%E5%8D%9A%E5%AE%A2/:0:3","tags":["clippings","blog","Framework"],"title":"SurfaceControlä¹‹Transactionäº‹ç‰©æ·±å…¥å‰–æ-android frameworkå®æˆ˜å¼€å‘-CSDNåšå®¢","uri":"/posts/surfacecontrol%E4%B9%8Btransaction%E4%BA%8B%E7%89%A9%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-android-framework%E5%AE%9E%E6%88%98%E5%BC%80%E5%8F%91-csdn%E5%8D%9A%E5%AE%A2/#transactionçš„æ„é€ "},{"categories":null,"collections":["SurfaceControl","å›¾å½¢æ˜¾ç¤º"],"content":"Transactionç›¸å…³ä»‹ç» ä¸»è¦æˆå‘˜ layer_state_tç»“æ„ä½“ ç”¨æ¥ä»£è¡¨Layerå›¾å±‚çš„çš„ç›¸å…³ä¿¡æ¯ï¼ŒSurfaceControlä¸sfçš„Layerå…±ç”¨è¿™ä¸ªlayer_state_tç»“æ„ä½“ï¼Œlayer_state_tåŒ…æ‹¬layeræ‰€æœ‰å±æ€§ ä¸»è¦æˆå‘˜å¦‚ä¸‹ï¼š å¯ä»¥çœ‹åˆ°å¸¸è§çš„ä¸»è¦å±æ€§ï¼šåæ ‡ï¼Œé•¿å®½ï¼Œå˜æ¢çŸ©é˜µï¼Œå˜åŒ–å€¼whatï¼Œflagsï¼Œmaskç­‰ï¼Œä¸€èˆ¬æ˜¯ä¸€ä¸ªå›¾å±‚å°±æœ‰ä¸€ä¸ªlayer_state_tç»“æ„ä½“ã€‚ ComposerStatesç»“æ„ä½“ struct ComposerState { layer_state_t state; status_t write(Parcel\u0026 output) const; status_t read(const Parcel\u0026 input); }; å¯ä»¥çœ‹å‡ºå°±æ˜¯layer_state_tè¿›è¡Œäº†ä¸€ä¸ªåŒ…è£…è€Œå·² mComposerStates å®šä¹‰å¦‚ä¸‹ï¼š std::unordered_map\u003csp, ComposerState, IBinderHash\u003e mComposerStates; å¯ä»¥çœ‹å‡ºæ¥å…¶å®å°±æ˜¯ä¸€ä¸ªè£…è½½ComposerStateçš„mapå®¹å™¨ï¼Œmapçš„keyæ˜¯æ¯ä¸ªSurfaceControlçš„handle,å…·ä½“å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ªmComposerStatesçš„å®¹å™¨æ·»åŠ æ–¹æ³•ï¼š layer_state_t* SurfaceComposerClient::Transaction::getLayerState(const sp\u003cSurfaceControl\u003e\u0026 sc) { auto handle = sc-\u003egetLayerStateHandle();//è·å–SurfaceControlçš„handleï¼Œ //åˆ¤æ–­æ˜¯å¦mComposerStateså®¹å™¨æ˜¯å¦å­˜åœ¨è¿™ä¸ªscçš„ç›¸å…³ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿›å…¥æ·»åŠ  if (mComposerStates.count(handle) == 0) { // we don't have it, add an initialized layer_state to our list ComposerState s;//åˆå§‹åŒ–ä¸€ä¸ªComposerState s.state.surface = handle; s.state.layerId = sc-\u003egetLayerId(); mComposerStates[handle] = s;//æŠŠåˆå§‹åŒ–çš„ComposerStateæ”¾åˆ°mapé›†åˆmComposerStatesä¸­ } //å¦‚æœå­˜åœ¨ï¼Œåˆ™ç›´æ¥é€šè¿‡handleä»mComposerStatesè·å–stateè¿”å› return \u0026(mComposerStates[handle].state); } ä¸Šé¢å…¶å®å¯ä»¥å¾—å‡ºå¦‚ä¸‹ç»“è®ºï¼š 1ã€æ¯ä¸ªTransactionéƒ½æœ‰è‡ªå·±çš„ä¸€ä¸ªmComposerStatesé›†åˆ 2ã€mComposerStatesé›†åˆä¼šæ”¾å…¥Transactionä¸­ä¼šæ“ä½œçš„SurfaceControlå¯¹åº”çš„layer_state_t è¡¥å……ä¸€ä¸‹ sc-\u003egetLayerStateHandleæ–¹æ³•ï¼š sp\u003cIBinder\u003e SurfaceControl::getLayerStateHandle() const { return mHandle; } è¿™ä¸ªmHandleå…¶å®å°±æ˜¯sfç«¯åˆ›å»ºä¸€ä¸ªHandle sp\u003cIBinder\u003e Layer::getHandle() { Mutex::Autolock _l(mLock); if (mGetHandleCalled) { ALOGE(\"Get handle called twice\" ); return nullptr; } mGetHandleCalled = true; return new Handle(mFlinger, this); } å³mHandleæ˜¯sfç«¯ä»£è¡¨Layerçš„BpBinderå¯¹è±¡ã€‚ ä¸»è¦æ–¹æ³• ä¸€äº›å±æ€§å¸¸è§è®¾ç½®æ–¹æ³• //å¯ä»¥çœ‹åˆ°ä¸€èˆ¬å±æ€§æ“ä½œæ–¹æ³•ç¬¬ä¸€å‚æ•°æ˜¯SurfaceControlï¼Œåé¢å±æ€§éœ€è¦å‚æ•° SurfaceComposerClient::Transaction\u0026 SurfaceComposerClient::Transaction::setPosition( const sp\u003cSurfaceControl\u003e\u0026 sc, float x, float y) { layer_state_t* s = getLayerState(sc); //è·å–scå¯¹åº”çš„layer_state_t s-\u003ewhat |= layer_state_t::ePositionChanged;//æ”¹å˜whatï¼Œå³æ ‡è®°layer_state_tå“ªä¸ªå±æ€§æ˜¯æœ‰å˜åŒ–çš„ï¼Œæ–¹ä¾¿sfè¿›è¡Œè¯†åˆ«è·å– s-\u003ex = x; //æ¥ä¸‹æ¥æ‰æ˜¯æ”¹å˜å…·ä½“çš„å€¼ s-\u003ey = y; registerSurfaceControlForCallback(sc); return *this; } ä¸Šé¢å°±æ˜¯ä¸€ä¸ªç»å…¸çš„Transactionæ”¹å˜å±æ€§çš„æ–¹æ³•ï¼Œå¸¸è§„å°±æ˜¯ä»¥ä¸‹å‡ æ­¥ï¼š 1ã€é€šè¿‡ä¼ é€’æ¥çš„scï¼Œè·å–scçš„layer_state_t 2ã€æ ‡è®°layer_state_tçš„whatå±æ€§ï¼Œä¸»è¦ä¸ºäº†æ˜æ˜¾è¡¨è¾¾å‡ºå“ªä¸ªå±æ€§å˜åŒ–äº† 3ã€è¿›è¡Œå…·ä½“å±æ€§æ”¹å˜ å…¶ä»–çš„å±æ€§æ–¹æ³•å¥—è·¯éƒ½å’Œä¸Šé¢åŸºæœ¬ä¸€æ · mergeæ–¹æ³• ä¸»è¦ç›®çš„æ˜¯æŠŠå¤šä¸ªTransactionçš„å†…å®¹åˆå¹¶åˆ°ä¸€ä¸ªï¼Œå³æŠŠotherçš„è¿™ä¸ªTransactionå†…å®¹éƒ½æ‹·è´åˆ°å½“å‰Transaction SurfaceComposerClient::Transaction\u0026 SurfaceComposerClient::Transaction::merge(Transaction\u0026\u0026 other) { for (auto const\u0026 [handle, composerState] : other.mComposerStates) { if (mComposerStates.count(handle) == 0) { mComposerStates[handle] = composerState; } else { if (composerState.state.what \u0026 layer_state_t::eBufferChanged) { releaseBufferIfOverwriting(mComposerStates[handle].state); } mComposerStates[handle].state.merge(composerState.state); } } for (auto const\u0026 state : other.mDisplayStates) { ssize_t index = mDisplayStates.indexOf(state); if (index \u003c 0) { mDisplayStates.add(state); } else { mDisplayStates.editItemAt(static_cast\u003csize_t\u003e(index)).merge(state); } } for (const auto\u0026 [listener, callbackInfo] : other.mListenerCallbacks) { auto\u0026 [callbackIds, surfaceControls] = callbackInfo; mListenerCallbacks[listener].callbackIds.insert(std::make_move_iterator( callbackIds.begin()), std::make_move_iterator(callbackIds.end())); mListenerCallbacks[listener].surfaceControls.insert(surfaceControls.begin(), surfaceControls.end()); auto\u0026 currentProcessCallbackInfo = mListenerCallbacks[TransactionCompletedListener::getIInstance()]; currentProcessCallbackInfo.surfaceControls .insert(std::make_move_iterator(surfaceControls.begin()), std::make_move_iterator(surfaceControls.end())); // register all surface controls for all callbackIds for this listener that is merging for (const auto\u0026 surfaceControl : currentProcessCallbackInfo.surfaceControls) { TransactionCompletedListener::getInstance() -\u003eaddSurfaceControlToCallbacks(surfaceControl, currentProcessCallbackInfo.callbackIds); } } mInputWindowCommands.merge(other.mInputWindowCommands); mContainsBuffer |= other.mContainsBuffer; mEarlyWakeupStart = mEarlyWakeupStart","date":"2024-11-06","objectID":"/posts/surfacecontrol%E4%B9%8Btransaction%E4%BA%8B%E7%89%A9%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-android-framework%E5%AE%9E%E6%88%98%E5%BC%80%E5%8F%91-csdn%E5%8D%9A%E5%AE%A2/:0:4","tags":["clippings","blog","Framework"],"title":"SurfaceControlä¹‹Transactionäº‹ç‰©æ·±å…¥å‰–æ-android frameworkå®æˆ˜å¼€å‘-CSDNåšå®¢","uri":"/posts/surfacecontrol%E4%B9%8Btransaction%E4%BA%8B%E7%89%A9%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-android-framework%E5%AE%9E%E6%88%98%E5%BC%80%E5%8F%91-csdn%E5%8D%9A%E5%AE%A2/#transactionç›¸å…³ä»‹ç»"},{"categories":null,"collections":["SurfaceControl","å›¾å½¢æ˜¾ç¤º"],"content":"Transactionç›¸å…³ä»‹ç» ä¸»è¦æˆå‘˜ layer_state_tç»“æ„ä½“ ç”¨æ¥ä»£è¡¨Layerå›¾å±‚çš„çš„ç›¸å…³ä¿¡æ¯ï¼ŒSurfaceControlä¸sfçš„Layerå…±ç”¨è¿™ä¸ªlayer_state_tç»“æ„ä½“ï¼Œlayer_state_tåŒ…æ‹¬layeræ‰€æœ‰å±æ€§ ä¸»è¦æˆå‘˜å¦‚ä¸‹ï¼š å¯ä»¥çœ‹åˆ°å¸¸è§çš„ä¸»è¦å±æ€§ï¼šåæ ‡ï¼Œé•¿å®½ï¼Œå˜æ¢çŸ©é˜µï¼Œå˜åŒ–å€¼whatï¼Œflagsï¼Œmaskç­‰ï¼Œä¸€èˆ¬æ˜¯ä¸€ä¸ªå›¾å±‚å°±æœ‰ä¸€ä¸ªlayer_state_tç»“æ„ä½“ã€‚ ComposerStatesç»“æ„ä½“ struct ComposerState { layer_state_t state; status_t write(Parcel\u0026 output) const; status_t read(const Parcel\u0026 input); }; å¯ä»¥çœ‹å‡ºå°±æ˜¯layer_state_tè¿›è¡Œäº†ä¸€ä¸ªåŒ…è£…è€Œå·² mComposerStates å®šä¹‰å¦‚ä¸‹ï¼š std::unordered_map mComposerStates; å¯ä»¥çœ‹å‡ºæ¥å…¶å®å°±æ˜¯ä¸€ä¸ªè£…è½½ComposerStateçš„mapå®¹å™¨ï¼Œmapçš„keyæ˜¯æ¯ä¸ªSurfaceControlçš„handle,å…·ä½“å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ªmComposerStatesçš„å®¹å™¨æ·»åŠ æ–¹æ³•ï¼š layer_state_t* SurfaceComposerClient::Transaction::getLayerState(const sp\u0026 sc) { auto handle = sc-\u003egetLayerStateHandle();//è·å–SurfaceControlçš„handleï¼Œ //åˆ¤æ–­æ˜¯å¦mComposerStateså®¹å™¨æ˜¯å¦å­˜åœ¨è¿™ä¸ªscçš„ç›¸å…³ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿›å…¥æ·»åŠ  if (mComposerStates.count(handle) == 0) { // we don't have it, add an initialized layer_state to our list ComposerState s;//åˆå§‹åŒ–ä¸€ä¸ªComposerState s.state.surface = handle; s.state.layerId = sc-\u003egetLayerId(); mComposerStates[handle] = s;//æŠŠåˆå§‹åŒ–çš„ComposerStateæ”¾åˆ°mapé›†åˆmComposerStatesä¸­ } //å¦‚æœå­˜åœ¨ï¼Œåˆ™ç›´æ¥é€šè¿‡handleä»mComposerStatesè·å–stateè¿”å› return \u0026(mComposerStates[handle].state); } ä¸Šé¢å…¶å®å¯ä»¥å¾—å‡ºå¦‚ä¸‹ç»“è®ºï¼š 1ã€æ¯ä¸ªTransactionéƒ½æœ‰è‡ªå·±çš„ä¸€ä¸ªmComposerStatesé›†åˆ 2ã€mComposerStatesé›†åˆä¼šæ”¾å…¥Transactionä¸­ä¼šæ“ä½œçš„SurfaceControlå¯¹åº”çš„layer_state_t è¡¥å……ä¸€ä¸‹ sc-\u003egetLayerStateHandleæ–¹æ³•ï¼š sp SurfaceControl::getLayerStateHandle() const { return mHandle; } è¿™ä¸ªmHandleå…¶å®å°±æ˜¯sfç«¯åˆ›å»ºä¸€ä¸ªHandle sp Layer::getHandle() { Mutex::Autolock _l(mLock); if (mGetHandleCalled) { ALOGE(\"Get handle called twice\" ); return nullptr; } mGetHandleCalled = true; return new Handle(mFlinger, this); } å³mHandleæ˜¯sfç«¯ä»£è¡¨Layerçš„BpBinderå¯¹è±¡ã€‚ ä¸»è¦æ–¹æ³• ä¸€äº›å±æ€§å¸¸è§è®¾ç½®æ–¹æ³• //å¯ä»¥çœ‹åˆ°ä¸€èˆ¬å±æ€§æ“ä½œæ–¹æ³•ç¬¬ä¸€å‚æ•°æ˜¯SurfaceControlï¼Œåé¢å±æ€§éœ€è¦å‚æ•° SurfaceComposerClient::Transaction\u0026 SurfaceComposerClient::Transaction::setPosition( const sp\u0026 sc, float x, float y) { layer_state_t* s = getLayerState(sc); //è·å–scå¯¹åº”çš„layer_state_t s-\u003ewhat |= layer_state_t::ePositionChanged;//æ”¹å˜whatï¼Œå³æ ‡è®°layer_state_tå“ªä¸ªå±æ€§æ˜¯æœ‰å˜åŒ–çš„ï¼Œæ–¹ä¾¿sfè¿›è¡Œè¯†åˆ«è·å– s-\u003ex = x; //æ¥ä¸‹æ¥æ‰æ˜¯æ”¹å˜å…·ä½“çš„å€¼ s-\u003ey = y; registerSurfaceControlForCallback(sc); return *this; } ä¸Šé¢å°±æ˜¯ä¸€ä¸ªç»å…¸çš„Transactionæ”¹å˜å±æ€§çš„æ–¹æ³•ï¼Œå¸¸è§„å°±æ˜¯ä»¥ä¸‹å‡ æ­¥ï¼š 1ã€é€šè¿‡ä¼ é€’æ¥çš„scï¼Œè·å–scçš„layer_state_t 2ã€æ ‡è®°layer_state_tçš„whatå±æ€§ï¼Œä¸»è¦ä¸ºäº†æ˜æ˜¾è¡¨è¾¾å‡ºå“ªä¸ªå±æ€§å˜åŒ–äº† 3ã€è¿›è¡Œå…·ä½“å±æ€§æ”¹å˜ å…¶ä»–çš„å±æ€§æ–¹æ³•å¥—è·¯éƒ½å’Œä¸Šé¢åŸºæœ¬ä¸€æ · mergeæ–¹æ³• ä¸»è¦ç›®çš„æ˜¯æŠŠå¤šä¸ªTransactionçš„å†…å®¹åˆå¹¶åˆ°ä¸€ä¸ªï¼Œå³æŠŠotherçš„è¿™ä¸ªTransactionå†…å®¹éƒ½æ‹·è´åˆ°å½“å‰Transaction SurfaceComposerClient::Transaction\u0026 SurfaceComposerClient::Transaction::merge(Transaction\u0026\u0026 other) { for (auto const\u0026 [handle, composerState] : other.mComposerStates) { if (mComposerStates.count(handle) == 0) { mComposerStates[handle] = composerState; } else { if (composerState.state.what \u0026 layer_state_t::eBufferChanged) { releaseBufferIfOverwriting(mComposerStates[handle].state); } mComposerStates[handle].state.merge(composerState.state); } } for (auto const\u0026 state : other.mDisplayStates) { ssize_t index = mDisplayStates.indexOf(state); if (index \u003c 0) { mDisplayStates.add(state); } else { mDisplayStates.editItemAt(static_cast(index)).merge(state); } } for (const auto\u0026 [listener, callbackInfo] : other.mListenerCallbacks) { auto\u0026 [callbackIds, surfaceControls] = callbackInfo; mListenerCallbacks[listener].callbackIds.insert(std::make_move_iterator( callbackIds.begin()), std::make_move_iterator(callbackIds.end())); mListenerCallbacks[listener].surfaceControls.insert(surfaceControls.begin(), surfaceControls.end()); auto\u0026 currentProcessCallbackInfo = mListenerCallbacks[TransactionCompletedListener::getIInstance()]; currentProcessCallbackInfo.surfaceControls .insert(std::make_move_iterator(surfaceControls.begin()), std::make_move_iterator(surfaceControls.end())); // register all surface controls for all callbackIds for this listener that is merging for (const auto\u0026 surfaceControl : currentProcessCallbackInfo.surfaceControls) { TransactionCompletedListener::getInstance() -\u003eaddSurfaceControlToCallbacks(surfaceControl, currentProcessCallbackInfo.callbackIds); } } mInputWindowCommands.merge(other.mInputWindowCommands); mContainsBuffer |= other.mContainsBuffer; mEarlyWakeupStart = mEarlyWakeupStart","date":"2024-11-06","objectID":"/posts/surfacecontrol%E4%B9%8Btransaction%E4%BA%8B%E7%89%A9%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-android-framework%E5%AE%9E%E6%88%98%E5%BC%80%E5%8F%91-csdn%E5%8D%9A%E5%AE%A2/:0:4","tags":["clippings","blog","Framework"],"title":"SurfaceControlä¹‹Transactionäº‹ç‰©æ·±å…¥å‰–æ-android frameworkå®æˆ˜å¼€å‘-CSDNåšå®¢","uri":"/posts/surfacecontrol%E4%B9%8Btransaction%E4%BA%8B%E7%89%A9%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-android-framework%E5%AE%9E%E6%88%98%E5%BC%80%E5%8F%91-csdn%E5%8D%9A%E5%AE%A2/#ä¸»è¦æˆå‘˜"},{"categories":null,"collections":["SurfaceControl","å›¾å½¢æ˜¾ç¤º"],"content":"Transactionç›¸å…³ä»‹ç» ä¸»è¦æˆå‘˜ layer_state_tç»“æ„ä½“ ç”¨æ¥ä»£è¡¨Layerå›¾å±‚çš„çš„ç›¸å…³ä¿¡æ¯ï¼ŒSurfaceControlä¸sfçš„Layerå…±ç”¨è¿™ä¸ªlayer_state_tç»“æ„ä½“ï¼Œlayer_state_tåŒ…æ‹¬layeræ‰€æœ‰å±æ€§ ä¸»è¦æˆå‘˜å¦‚ä¸‹ï¼š å¯ä»¥çœ‹åˆ°å¸¸è§çš„ä¸»è¦å±æ€§ï¼šåæ ‡ï¼Œé•¿å®½ï¼Œå˜æ¢çŸ©é˜µï¼Œå˜åŒ–å€¼whatï¼Œflagsï¼Œmaskç­‰ï¼Œä¸€èˆ¬æ˜¯ä¸€ä¸ªå›¾å±‚å°±æœ‰ä¸€ä¸ªlayer_state_tç»“æ„ä½“ã€‚ ComposerStatesç»“æ„ä½“ struct ComposerState { layer_state_t state; status_t write(Parcel\u0026 output) const; status_t read(const Parcel\u0026 input); }; å¯ä»¥çœ‹å‡ºå°±æ˜¯layer_state_tè¿›è¡Œäº†ä¸€ä¸ªåŒ…è£…è€Œå·² mComposerStates å®šä¹‰å¦‚ä¸‹ï¼š std::unordered_map mComposerStates; å¯ä»¥çœ‹å‡ºæ¥å…¶å®å°±æ˜¯ä¸€ä¸ªè£…è½½ComposerStateçš„mapå®¹å™¨ï¼Œmapçš„keyæ˜¯æ¯ä¸ªSurfaceControlçš„handle,å…·ä½“å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ªmComposerStatesçš„å®¹å™¨æ·»åŠ æ–¹æ³•ï¼š layer_state_t* SurfaceComposerClient::Transaction::getLayerState(const sp\u0026 sc) { auto handle = sc-\u003egetLayerStateHandle();//è·å–SurfaceControlçš„handleï¼Œ //åˆ¤æ–­æ˜¯å¦mComposerStateså®¹å™¨æ˜¯å¦å­˜åœ¨è¿™ä¸ªscçš„ç›¸å…³ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿›å…¥æ·»åŠ  if (mComposerStates.count(handle) == 0) { // we don't have it, add an initialized layer_state to our list ComposerState s;//åˆå§‹åŒ–ä¸€ä¸ªComposerState s.state.surface = handle; s.state.layerId = sc-\u003egetLayerId(); mComposerStates[handle] = s;//æŠŠåˆå§‹åŒ–çš„ComposerStateæ”¾åˆ°mapé›†åˆmComposerStatesä¸­ } //å¦‚æœå­˜åœ¨ï¼Œåˆ™ç›´æ¥é€šè¿‡handleä»mComposerStatesè·å–stateè¿”å› return \u0026(mComposerStates[handle].state); } ä¸Šé¢å…¶å®å¯ä»¥å¾—å‡ºå¦‚ä¸‹ç»“è®ºï¼š 1ã€æ¯ä¸ªTransactionéƒ½æœ‰è‡ªå·±çš„ä¸€ä¸ªmComposerStatesé›†åˆ 2ã€mComposerStatesé›†åˆä¼šæ”¾å…¥Transactionä¸­ä¼šæ“ä½œçš„SurfaceControlå¯¹åº”çš„layer_state_t è¡¥å……ä¸€ä¸‹ sc-\u003egetLayerStateHandleæ–¹æ³•ï¼š sp SurfaceControl::getLayerStateHandle() const { return mHandle; } è¿™ä¸ªmHandleå…¶å®å°±æ˜¯sfç«¯åˆ›å»ºä¸€ä¸ªHandle sp Layer::getHandle() { Mutex::Autolock _l(mLock); if (mGetHandleCalled) { ALOGE(\"Get handle called twice\" ); return nullptr; } mGetHandleCalled = true; return new Handle(mFlinger, this); } å³mHandleæ˜¯sfç«¯ä»£è¡¨Layerçš„BpBinderå¯¹è±¡ã€‚ ä¸»è¦æ–¹æ³• ä¸€äº›å±æ€§å¸¸è§è®¾ç½®æ–¹æ³• //å¯ä»¥çœ‹åˆ°ä¸€èˆ¬å±æ€§æ“ä½œæ–¹æ³•ç¬¬ä¸€å‚æ•°æ˜¯SurfaceControlï¼Œåé¢å±æ€§éœ€è¦å‚æ•° SurfaceComposerClient::Transaction\u0026 SurfaceComposerClient::Transaction::setPosition( const sp\u0026 sc, float x, float y) { layer_state_t* s = getLayerState(sc); //è·å–scå¯¹åº”çš„layer_state_t s-\u003ewhat |= layer_state_t::ePositionChanged;//æ”¹å˜whatï¼Œå³æ ‡è®°layer_state_tå“ªä¸ªå±æ€§æ˜¯æœ‰å˜åŒ–çš„ï¼Œæ–¹ä¾¿sfè¿›è¡Œè¯†åˆ«è·å– s-\u003ex = x; //æ¥ä¸‹æ¥æ‰æ˜¯æ”¹å˜å…·ä½“çš„å€¼ s-\u003ey = y; registerSurfaceControlForCallback(sc); return *this; } ä¸Šé¢å°±æ˜¯ä¸€ä¸ªç»å…¸çš„Transactionæ”¹å˜å±æ€§çš„æ–¹æ³•ï¼Œå¸¸è§„å°±æ˜¯ä»¥ä¸‹å‡ æ­¥ï¼š 1ã€é€šè¿‡ä¼ é€’æ¥çš„scï¼Œè·å–scçš„layer_state_t 2ã€æ ‡è®°layer_state_tçš„whatå±æ€§ï¼Œä¸»è¦ä¸ºäº†æ˜æ˜¾è¡¨è¾¾å‡ºå“ªä¸ªå±æ€§å˜åŒ–äº† 3ã€è¿›è¡Œå…·ä½“å±æ€§æ”¹å˜ å…¶ä»–çš„å±æ€§æ–¹æ³•å¥—è·¯éƒ½å’Œä¸Šé¢åŸºæœ¬ä¸€æ · mergeæ–¹æ³• ä¸»è¦ç›®çš„æ˜¯æŠŠå¤šä¸ªTransactionçš„å†…å®¹åˆå¹¶åˆ°ä¸€ä¸ªï¼Œå³æŠŠotherçš„è¿™ä¸ªTransactionå†…å®¹éƒ½æ‹·è´åˆ°å½“å‰Transaction SurfaceComposerClient::Transaction\u0026 SurfaceComposerClient::Transaction::merge(Transaction\u0026\u0026 other) { for (auto const\u0026 [handle, composerState] : other.mComposerStates) { if (mComposerStates.count(handle) == 0) { mComposerStates[handle] = composerState; } else { if (composerState.state.what \u0026 layer_state_t::eBufferChanged) { releaseBufferIfOverwriting(mComposerStates[handle].state); } mComposerStates[handle].state.merge(composerState.state); } } for (auto const\u0026 state : other.mDisplayStates) { ssize_t index = mDisplayStates.indexOf(state); if (index \u003c 0) { mDisplayStates.add(state); } else { mDisplayStates.editItemAt(static_cast(index)).merge(state); } } for (const auto\u0026 [listener, callbackInfo] : other.mListenerCallbacks) { auto\u0026 [callbackIds, surfaceControls] = callbackInfo; mListenerCallbacks[listener].callbackIds.insert(std::make_move_iterator( callbackIds.begin()), std::make_move_iterator(callbackIds.end())); mListenerCallbacks[listener].surfaceControls.insert(surfaceControls.begin(), surfaceControls.end()); auto\u0026 currentProcessCallbackInfo = mListenerCallbacks[TransactionCompletedListener::getIInstance()]; currentProcessCallbackInfo.surfaceControls .insert(std::make_move_iterator(surfaceControls.begin()), std::make_move_iterator(surfaceControls.end())); // register all surface controls for all callbackIds for this listener that is merging for (const auto\u0026 surfaceControl : currentProcessCallbackInfo.surfaceControls) { TransactionCompletedListener::getInstance() -\u003eaddSurfaceControlToCallbacks(surfaceControl, currentProcessCallbackInfo.callbackIds); } } mInputWindowCommands.merge(other.mInputWindowCommands); mContainsBuffer |= other.mContainsBuffer; mEarlyWakeupStart = mEarlyWakeupStart","date":"2024-11-06","objectID":"/posts/surfacecontrol%E4%B9%8Btransaction%E4%BA%8B%E7%89%A9%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-android-framework%E5%AE%9E%E6%88%98%E5%BC%80%E5%8F%91-csdn%E5%8D%9A%E5%AE%A2/:0:4","tags":["clippings","blog","Framework"],"title":"SurfaceControlä¹‹Transactionäº‹ç‰©æ·±å…¥å‰–æ-android frameworkå®æˆ˜å¼€å‘-CSDNåšå®¢","uri":"/posts/surfacecontrol%E4%B9%8Btransaction%E4%BA%8B%E7%89%A9%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-android-framework%E5%AE%9E%E6%88%98%E5%BC%80%E5%8F%91-csdn%E5%8D%9A%E5%AE%A2/#ä¸»è¦æ–¹æ³•"},{"categories":null,"collections":["SurfaceControl","å›¾å½¢æ˜¾ç¤º"],"content":"Transactionç›¸å…³ä»‹ç» ä¸»è¦æˆå‘˜ layer_state_tç»“æ„ä½“ ç”¨æ¥ä»£è¡¨Layerå›¾å±‚çš„çš„ç›¸å…³ä¿¡æ¯ï¼ŒSurfaceControlä¸sfçš„Layerå…±ç”¨è¿™ä¸ªlayer_state_tç»“æ„ä½“ï¼Œlayer_state_tåŒ…æ‹¬layeræ‰€æœ‰å±æ€§ ä¸»è¦æˆå‘˜å¦‚ä¸‹ï¼š å¯ä»¥çœ‹åˆ°å¸¸è§çš„ä¸»è¦å±æ€§ï¼šåæ ‡ï¼Œé•¿å®½ï¼Œå˜æ¢çŸ©é˜µï¼Œå˜åŒ–å€¼whatï¼Œflagsï¼Œmaskç­‰ï¼Œä¸€èˆ¬æ˜¯ä¸€ä¸ªå›¾å±‚å°±æœ‰ä¸€ä¸ªlayer_state_tç»“æ„ä½“ã€‚ ComposerStatesç»“æ„ä½“ struct ComposerState { layer_state_t state; status_t write(Parcel\u0026 output) const; status_t read(const Parcel\u0026 input); }; å¯ä»¥çœ‹å‡ºå°±æ˜¯layer_state_tè¿›è¡Œäº†ä¸€ä¸ªåŒ…è£…è€Œå·² mComposerStates å®šä¹‰å¦‚ä¸‹ï¼š std::unordered_map mComposerStates; å¯ä»¥çœ‹å‡ºæ¥å…¶å®å°±æ˜¯ä¸€ä¸ªè£…è½½ComposerStateçš„mapå®¹å™¨ï¼Œmapçš„keyæ˜¯æ¯ä¸ªSurfaceControlçš„handle,å…·ä½“å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ªmComposerStatesçš„å®¹å™¨æ·»åŠ æ–¹æ³•ï¼š layer_state_t* SurfaceComposerClient::Transaction::getLayerState(const sp\u0026 sc) { auto handle = sc-\u003egetLayerStateHandle();//è·å–SurfaceControlçš„handleï¼Œ //åˆ¤æ–­æ˜¯å¦mComposerStateså®¹å™¨æ˜¯å¦å­˜åœ¨è¿™ä¸ªscçš„ç›¸å…³ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿›å…¥æ·»åŠ  if (mComposerStates.count(handle) == 0) { // we don't have it, add an initialized layer_state to our list ComposerState s;//åˆå§‹åŒ–ä¸€ä¸ªComposerState s.state.surface = handle; s.state.layerId = sc-\u003egetLayerId(); mComposerStates[handle] = s;//æŠŠåˆå§‹åŒ–çš„ComposerStateæ”¾åˆ°mapé›†åˆmComposerStatesä¸­ } //å¦‚æœå­˜åœ¨ï¼Œåˆ™ç›´æ¥é€šè¿‡handleä»mComposerStatesè·å–stateè¿”å› return \u0026(mComposerStates[handle].state); } ä¸Šé¢å…¶å®å¯ä»¥å¾—å‡ºå¦‚ä¸‹ç»“è®ºï¼š 1ã€æ¯ä¸ªTransactionéƒ½æœ‰è‡ªå·±çš„ä¸€ä¸ªmComposerStatesé›†åˆ 2ã€mComposerStatesé›†åˆä¼šæ”¾å…¥Transactionä¸­ä¼šæ“ä½œçš„SurfaceControlå¯¹åº”çš„layer_state_t è¡¥å……ä¸€ä¸‹ sc-\u003egetLayerStateHandleæ–¹æ³•ï¼š sp SurfaceControl::getLayerStateHandle() const { return mHandle; } è¿™ä¸ªmHandleå…¶å®å°±æ˜¯sfç«¯åˆ›å»ºä¸€ä¸ªHandle sp Layer::getHandle() { Mutex::Autolock _l(mLock); if (mGetHandleCalled) { ALOGE(\"Get handle called twice\" ); return nullptr; } mGetHandleCalled = true; return new Handle(mFlinger, this); } å³mHandleæ˜¯sfç«¯ä»£è¡¨Layerçš„BpBinderå¯¹è±¡ã€‚ ä¸»è¦æ–¹æ³• ä¸€äº›å±æ€§å¸¸è§è®¾ç½®æ–¹æ³• //å¯ä»¥çœ‹åˆ°ä¸€èˆ¬å±æ€§æ“ä½œæ–¹æ³•ç¬¬ä¸€å‚æ•°æ˜¯SurfaceControlï¼Œåé¢å±æ€§éœ€è¦å‚æ•° SurfaceComposerClient::Transaction\u0026 SurfaceComposerClient::Transaction::setPosition( const sp\u0026 sc, float x, float y) { layer_state_t* s = getLayerState(sc); //è·å–scå¯¹åº”çš„layer_state_t s-\u003ewhat |= layer_state_t::ePositionChanged;//æ”¹å˜whatï¼Œå³æ ‡è®°layer_state_tå“ªä¸ªå±æ€§æ˜¯æœ‰å˜åŒ–çš„ï¼Œæ–¹ä¾¿sfè¿›è¡Œè¯†åˆ«è·å– s-\u003ex = x; //æ¥ä¸‹æ¥æ‰æ˜¯æ”¹å˜å…·ä½“çš„å€¼ s-\u003ey = y; registerSurfaceControlForCallback(sc); return *this; } ä¸Šé¢å°±æ˜¯ä¸€ä¸ªç»å…¸çš„Transactionæ”¹å˜å±æ€§çš„æ–¹æ³•ï¼Œå¸¸è§„å°±æ˜¯ä»¥ä¸‹å‡ æ­¥ï¼š 1ã€é€šè¿‡ä¼ é€’æ¥çš„scï¼Œè·å–scçš„layer_state_t 2ã€æ ‡è®°layer_state_tçš„whatå±æ€§ï¼Œä¸»è¦ä¸ºäº†æ˜æ˜¾è¡¨è¾¾å‡ºå“ªä¸ªå±æ€§å˜åŒ–äº† 3ã€è¿›è¡Œå…·ä½“å±æ€§æ”¹å˜ å…¶ä»–çš„å±æ€§æ–¹æ³•å¥—è·¯éƒ½å’Œä¸Šé¢åŸºæœ¬ä¸€æ · mergeæ–¹æ³• ä¸»è¦ç›®çš„æ˜¯æŠŠå¤šä¸ªTransactionçš„å†…å®¹åˆå¹¶åˆ°ä¸€ä¸ªï¼Œå³æŠŠotherçš„è¿™ä¸ªTransactionå†…å®¹éƒ½æ‹·è´åˆ°å½“å‰Transaction SurfaceComposerClient::Transaction\u0026 SurfaceComposerClient::Transaction::merge(Transaction\u0026\u0026 other) { for (auto const\u0026 [handle, composerState] : other.mComposerStates) { if (mComposerStates.count(handle) == 0) { mComposerStates[handle] = composerState; } else { if (composerState.state.what \u0026 layer_state_t::eBufferChanged) { releaseBufferIfOverwriting(mComposerStates[handle].state); } mComposerStates[handle].state.merge(composerState.state); } } for (auto const\u0026 state : other.mDisplayStates) { ssize_t index = mDisplayStates.indexOf(state); if (index \u003c 0) { mDisplayStates.add(state); } else { mDisplayStates.editItemAt(static_cast(index)).merge(state); } } for (const auto\u0026 [listener, callbackInfo] : other.mListenerCallbacks) { auto\u0026 [callbackIds, surfaceControls] = callbackInfo; mListenerCallbacks[listener].callbackIds.insert(std::make_move_iterator( callbackIds.begin()), std::make_move_iterator(callbackIds.end())); mListenerCallbacks[listener].surfaceControls.insert(surfaceControls.begin(), surfaceControls.end()); auto\u0026 currentProcessCallbackInfo = mListenerCallbacks[TransactionCompletedListener::getIInstance()]; currentProcessCallbackInfo.surfaceControls .insert(std::make_move_iterator(surfaceControls.begin()), std::make_move_iterator(surfaceControls.end())); // register all surface controls for all callbackIds for this listener that is merging for (const auto\u0026 surfaceControl : currentProcessCallbackInfo.surfaceControls) { TransactionCompletedListener::getInstance() -\u003eaddSurfaceControlToCallbacks(surfaceControl, currentProcessCallbackInfo.callbackIds); } } mInputWindowCommands.merge(other.mInputWindowCommands); mContainsBuffer |= other.mContainsBuffer; mEarlyWakeupStart = mEarlyWakeupStart","date":"2024-11-06","objectID":"/posts/surfacecontrol%E4%B9%8Btransaction%E4%BA%8B%E7%89%A9%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-android-framework%E5%AE%9E%E6%88%98%E5%BC%80%E5%8F%91-csdn%E5%8D%9A%E5%AE%A2/:0:4","tags":["clippings","blog","Framework"],"title":"SurfaceControlä¹‹Transactionäº‹ç‰©æ·±å…¥å‰–æ-android frameworkå®æˆ˜å¼€å‘-CSDNåšå®¢","uri":"/posts/surfacecontrol%E4%B9%8Btransaction%E4%BA%8B%E7%89%A9%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-android-framework%E5%AE%9E%E6%88%98%E5%BC%80%E5%8F%91-csdn%E5%8D%9A%E5%AE%A2/#ä¸€äº›å±æ€§å¸¸è§è®¾ç½®æ–¹æ³•"},{"categories":null,"collections":["SurfaceControl","å›¾å½¢æ˜¾ç¤º"],"content":"Transactionç›¸å…³ä»‹ç» ä¸»è¦æˆå‘˜ layer_state_tç»“æ„ä½“ ç”¨æ¥ä»£è¡¨Layerå›¾å±‚çš„çš„ç›¸å…³ä¿¡æ¯ï¼ŒSurfaceControlä¸sfçš„Layerå…±ç”¨è¿™ä¸ªlayer_state_tç»“æ„ä½“ï¼Œlayer_state_tåŒ…æ‹¬layeræ‰€æœ‰å±æ€§ ä¸»è¦æˆå‘˜å¦‚ä¸‹ï¼š å¯ä»¥çœ‹åˆ°å¸¸è§çš„ä¸»è¦å±æ€§ï¼šåæ ‡ï¼Œé•¿å®½ï¼Œå˜æ¢çŸ©é˜µï¼Œå˜åŒ–å€¼whatï¼Œflagsï¼Œmaskç­‰ï¼Œä¸€èˆ¬æ˜¯ä¸€ä¸ªå›¾å±‚å°±æœ‰ä¸€ä¸ªlayer_state_tç»“æ„ä½“ã€‚ ComposerStatesç»“æ„ä½“ struct ComposerState { layer_state_t state; status_t write(Parcel\u0026 output) const; status_t read(const Parcel\u0026 input); }; å¯ä»¥çœ‹å‡ºå°±æ˜¯layer_state_tè¿›è¡Œäº†ä¸€ä¸ªåŒ…è£…è€Œå·² mComposerStates å®šä¹‰å¦‚ä¸‹ï¼š std::unordered_map mComposerStates; å¯ä»¥çœ‹å‡ºæ¥å…¶å®å°±æ˜¯ä¸€ä¸ªè£…è½½ComposerStateçš„mapå®¹å™¨ï¼Œmapçš„keyæ˜¯æ¯ä¸ªSurfaceControlçš„handle,å…·ä½“å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ªmComposerStatesçš„å®¹å™¨æ·»åŠ æ–¹æ³•ï¼š layer_state_t* SurfaceComposerClient::Transaction::getLayerState(const sp\u0026 sc) { auto handle = sc-\u003egetLayerStateHandle();//è·å–SurfaceControlçš„handleï¼Œ //åˆ¤æ–­æ˜¯å¦mComposerStateså®¹å™¨æ˜¯å¦å­˜åœ¨è¿™ä¸ªscçš„ç›¸å…³ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿›å…¥æ·»åŠ  if (mComposerStates.count(handle) == 0) { // we don't have it, add an initialized layer_state to our list ComposerState s;//åˆå§‹åŒ–ä¸€ä¸ªComposerState s.state.surface = handle; s.state.layerId = sc-\u003egetLayerId(); mComposerStates[handle] = s;//æŠŠåˆå§‹åŒ–çš„ComposerStateæ”¾åˆ°mapé›†åˆmComposerStatesä¸­ } //å¦‚æœå­˜åœ¨ï¼Œåˆ™ç›´æ¥é€šè¿‡handleä»mComposerStatesè·å–stateè¿”å› return \u0026(mComposerStates[handle].state); } ä¸Šé¢å…¶å®å¯ä»¥å¾—å‡ºå¦‚ä¸‹ç»“è®ºï¼š 1ã€æ¯ä¸ªTransactionéƒ½æœ‰è‡ªå·±çš„ä¸€ä¸ªmComposerStatesé›†åˆ 2ã€mComposerStatesé›†åˆä¼šæ”¾å…¥Transactionä¸­ä¼šæ“ä½œçš„SurfaceControlå¯¹åº”çš„layer_state_t è¡¥å……ä¸€ä¸‹ sc-\u003egetLayerStateHandleæ–¹æ³•ï¼š sp SurfaceControl::getLayerStateHandle() const { return mHandle; } è¿™ä¸ªmHandleå…¶å®å°±æ˜¯sfç«¯åˆ›å»ºä¸€ä¸ªHandle sp Layer::getHandle() { Mutex::Autolock _l(mLock); if (mGetHandleCalled) { ALOGE(\"Get handle called twice\" ); return nullptr; } mGetHandleCalled = true; return new Handle(mFlinger, this); } å³mHandleæ˜¯sfç«¯ä»£è¡¨Layerçš„BpBinderå¯¹è±¡ã€‚ ä¸»è¦æ–¹æ³• ä¸€äº›å±æ€§å¸¸è§è®¾ç½®æ–¹æ³• //å¯ä»¥çœ‹åˆ°ä¸€èˆ¬å±æ€§æ“ä½œæ–¹æ³•ç¬¬ä¸€å‚æ•°æ˜¯SurfaceControlï¼Œåé¢å±æ€§éœ€è¦å‚æ•° SurfaceComposerClient::Transaction\u0026 SurfaceComposerClient::Transaction::setPosition( const sp\u0026 sc, float x, float y) { layer_state_t* s = getLayerState(sc); //è·å–scå¯¹åº”çš„layer_state_t s-\u003ewhat |= layer_state_t::ePositionChanged;//æ”¹å˜whatï¼Œå³æ ‡è®°layer_state_tå“ªä¸ªå±æ€§æ˜¯æœ‰å˜åŒ–çš„ï¼Œæ–¹ä¾¿sfè¿›è¡Œè¯†åˆ«è·å– s-\u003ex = x; //æ¥ä¸‹æ¥æ‰æ˜¯æ”¹å˜å…·ä½“çš„å€¼ s-\u003ey = y; registerSurfaceControlForCallback(sc); return *this; } ä¸Šé¢å°±æ˜¯ä¸€ä¸ªç»å…¸çš„Transactionæ”¹å˜å±æ€§çš„æ–¹æ³•ï¼Œå¸¸è§„å°±æ˜¯ä»¥ä¸‹å‡ æ­¥ï¼š 1ã€é€šè¿‡ä¼ é€’æ¥çš„scï¼Œè·å–scçš„layer_state_t 2ã€æ ‡è®°layer_state_tçš„whatå±æ€§ï¼Œä¸»è¦ä¸ºäº†æ˜æ˜¾è¡¨è¾¾å‡ºå“ªä¸ªå±æ€§å˜åŒ–äº† 3ã€è¿›è¡Œå…·ä½“å±æ€§æ”¹å˜ å…¶ä»–çš„å±æ€§æ–¹æ³•å¥—è·¯éƒ½å’Œä¸Šé¢åŸºæœ¬ä¸€æ · mergeæ–¹æ³• ä¸»è¦ç›®çš„æ˜¯æŠŠå¤šä¸ªTransactionçš„å†…å®¹åˆå¹¶åˆ°ä¸€ä¸ªï¼Œå³æŠŠotherçš„è¿™ä¸ªTransactionå†…å®¹éƒ½æ‹·è´åˆ°å½“å‰Transaction SurfaceComposerClient::Transaction\u0026 SurfaceComposerClient::Transaction::merge(Transaction\u0026\u0026 other) { for (auto const\u0026 [handle, composerState] : other.mComposerStates) { if (mComposerStates.count(handle) == 0) { mComposerStates[handle] = composerState; } else { if (composerState.state.what \u0026 layer_state_t::eBufferChanged) { releaseBufferIfOverwriting(mComposerStates[handle].state); } mComposerStates[handle].state.merge(composerState.state); } } for (auto const\u0026 state : other.mDisplayStates) { ssize_t index = mDisplayStates.indexOf(state); if (index \u003c 0) { mDisplayStates.add(state); } else { mDisplayStates.editItemAt(static_cast(index)).merge(state); } } for (const auto\u0026 [listener, callbackInfo] : other.mListenerCallbacks) { auto\u0026 [callbackIds, surfaceControls] = callbackInfo; mListenerCallbacks[listener].callbackIds.insert(std::make_move_iterator( callbackIds.begin()), std::make_move_iterator(callbackIds.end())); mListenerCallbacks[listener].surfaceControls.insert(surfaceControls.begin(), surfaceControls.end()); auto\u0026 currentProcessCallbackInfo = mListenerCallbacks[TransactionCompletedListener::getIInstance()]; currentProcessCallbackInfo.surfaceControls .insert(std::make_move_iterator(surfaceControls.begin()), std::make_move_iterator(surfaceControls.end())); // register all surface controls for all callbackIds for this listener that is merging for (const auto\u0026 surfaceControl : currentProcessCallbackInfo.surfaceControls) { TransactionCompletedListener::getInstance() -\u003eaddSurfaceControlToCallbacks(surfaceControl, currentProcessCallbackInfo.callbackIds); } } mInputWindowCommands.merge(other.mInputWindowCommands); mContainsBuffer |= other.mContainsBuffer; mEarlyWakeupStart = mEarlyWakeupStart","date":"2024-11-06","objectID":"/posts/surfacecontrol%E4%B9%8Btransaction%E4%BA%8B%E7%89%A9%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-android-framework%E5%AE%9E%E6%88%98%E5%BC%80%E5%8F%91-csdn%E5%8D%9A%E5%AE%A2/:0:4","tags":["clippings","blog","Framework"],"title":"SurfaceControlä¹‹Transactionäº‹ç‰©æ·±å…¥å‰–æ-android frameworkå®æˆ˜å¼€å‘-CSDNåšå®¢","uri":"/posts/surfacecontrol%E4%B9%8Btransaction%E4%BA%8B%E7%89%A9%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-android-framework%E5%AE%9E%E6%88%98%E5%BC%80%E5%8F%91-csdn%E5%8D%9A%E5%AE%A2/#mergeæ–¹æ³•"},{"categories":null,"collections":["SurfaceControl","å›¾å½¢æ˜¾ç¤º"],"content":"Transactionç›¸å…³ä»‹ç» ä¸»è¦æˆå‘˜ layer_state_tç»“æ„ä½“ ç”¨æ¥ä»£è¡¨Layerå›¾å±‚çš„çš„ç›¸å…³ä¿¡æ¯ï¼ŒSurfaceControlä¸sfçš„Layerå…±ç”¨è¿™ä¸ªlayer_state_tç»“æ„ä½“ï¼Œlayer_state_tåŒ…æ‹¬layeræ‰€æœ‰å±æ€§ ä¸»è¦æˆå‘˜å¦‚ä¸‹ï¼š å¯ä»¥çœ‹åˆ°å¸¸è§çš„ä¸»è¦å±æ€§ï¼šåæ ‡ï¼Œé•¿å®½ï¼Œå˜æ¢çŸ©é˜µï¼Œå˜åŒ–å€¼whatï¼Œflagsï¼Œmaskç­‰ï¼Œä¸€èˆ¬æ˜¯ä¸€ä¸ªå›¾å±‚å°±æœ‰ä¸€ä¸ªlayer_state_tç»“æ„ä½“ã€‚ ComposerStatesç»“æ„ä½“ struct ComposerState { layer_state_t state; status_t write(Parcel\u0026 output) const; status_t read(const Parcel\u0026 input); }; å¯ä»¥çœ‹å‡ºå°±æ˜¯layer_state_tè¿›è¡Œäº†ä¸€ä¸ªåŒ…è£…è€Œå·² mComposerStates å®šä¹‰å¦‚ä¸‹ï¼š std::unordered_map mComposerStates; å¯ä»¥çœ‹å‡ºæ¥å…¶å®å°±æ˜¯ä¸€ä¸ªè£…è½½ComposerStateçš„mapå®¹å™¨ï¼Œmapçš„keyæ˜¯æ¯ä¸ªSurfaceControlçš„handle,å…·ä½“å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ªmComposerStatesçš„å®¹å™¨æ·»åŠ æ–¹æ³•ï¼š layer_state_t* SurfaceComposerClient::Transaction::getLayerState(const sp\u0026 sc) { auto handle = sc-\u003egetLayerStateHandle();//è·å–SurfaceControlçš„handleï¼Œ //åˆ¤æ–­æ˜¯å¦mComposerStateså®¹å™¨æ˜¯å¦å­˜åœ¨è¿™ä¸ªscçš„ç›¸å…³ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿›å…¥æ·»åŠ  if (mComposerStates.count(handle) == 0) { // we don't have it, add an initialized layer_state to our list ComposerState s;//åˆå§‹åŒ–ä¸€ä¸ªComposerState s.state.surface = handle; s.state.layerId = sc-\u003egetLayerId(); mComposerStates[handle] = s;//æŠŠåˆå§‹åŒ–çš„ComposerStateæ”¾åˆ°mapé›†åˆmComposerStatesä¸­ } //å¦‚æœå­˜åœ¨ï¼Œåˆ™ç›´æ¥é€šè¿‡handleä»mComposerStatesè·å–stateè¿”å› return \u0026(mComposerStates[handle].state); } ä¸Šé¢å…¶å®å¯ä»¥å¾—å‡ºå¦‚ä¸‹ç»“è®ºï¼š 1ã€æ¯ä¸ªTransactionéƒ½æœ‰è‡ªå·±çš„ä¸€ä¸ªmComposerStatesé›†åˆ 2ã€mComposerStatesé›†åˆä¼šæ”¾å…¥Transactionä¸­ä¼šæ“ä½œçš„SurfaceControlå¯¹åº”çš„layer_state_t è¡¥å……ä¸€ä¸‹ sc-\u003egetLayerStateHandleæ–¹æ³•ï¼š sp SurfaceControl::getLayerStateHandle() const { return mHandle; } è¿™ä¸ªmHandleå…¶å®å°±æ˜¯sfç«¯åˆ›å»ºä¸€ä¸ªHandle sp Layer::getHandle() { Mutex::Autolock _l(mLock); if (mGetHandleCalled) { ALOGE(\"Get handle called twice\" ); return nullptr; } mGetHandleCalled = true; return new Handle(mFlinger, this); } å³mHandleæ˜¯sfç«¯ä»£è¡¨Layerçš„BpBinderå¯¹è±¡ã€‚ ä¸»è¦æ–¹æ³• ä¸€äº›å±æ€§å¸¸è§è®¾ç½®æ–¹æ³• //å¯ä»¥çœ‹åˆ°ä¸€èˆ¬å±æ€§æ“ä½œæ–¹æ³•ç¬¬ä¸€å‚æ•°æ˜¯SurfaceControlï¼Œåé¢å±æ€§éœ€è¦å‚æ•° SurfaceComposerClient::Transaction\u0026 SurfaceComposerClient::Transaction::setPosition( const sp\u0026 sc, float x, float y) { layer_state_t* s = getLayerState(sc); //è·å–scå¯¹åº”çš„layer_state_t s-\u003ewhat |= layer_state_t::ePositionChanged;//æ”¹å˜whatï¼Œå³æ ‡è®°layer_state_tå“ªä¸ªå±æ€§æ˜¯æœ‰å˜åŒ–çš„ï¼Œæ–¹ä¾¿sfè¿›è¡Œè¯†åˆ«è·å– s-\u003ex = x; //æ¥ä¸‹æ¥æ‰æ˜¯æ”¹å˜å…·ä½“çš„å€¼ s-\u003ey = y; registerSurfaceControlForCallback(sc); return *this; } ä¸Šé¢å°±æ˜¯ä¸€ä¸ªç»å…¸çš„Transactionæ”¹å˜å±æ€§çš„æ–¹æ³•ï¼Œå¸¸è§„å°±æ˜¯ä»¥ä¸‹å‡ æ­¥ï¼š 1ã€é€šè¿‡ä¼ é€’æ¥çš„scï¼Œè·å–scçš„layer_state_t 2ã€æ ‡è®°layer_state_tçš„whatå±æ€§ï¼Œä¸»è¦ä¸ºäº†æ˜æ˜¾è¡¨è¾¾å‡ºå“ªä¸ªå±æ€§å˜åŒ–äº† 3ã€è¿›è¡Œå…·ä½“å±æ€§æ”¹å˜ å…¶ä»–çš„å±æ€§æ–¹æ³•å¥—è·¯éƒ½å’Œä¸Šé¢åŸºæœ¬ä¸€æ · mergeæ–¹æ³• ä¸»è¦ç›®çš„æ˜¯æŠŠå¤šä¸ªTransactionçš„å†…å®¹åˆå¹¶åˆ°ä¸€ä¸ªï¼Œå³æŠŠotherçš„è¿™ä¸ªTransactionå†…å®¹éƒ½æ‹·è´åˆ°å½“å‰Transaction SurfaceComposerClient::Transaction\u0026 SurfaceComposerClient::Transaction::merge(Transaction\u0026\u0026 other) { for (auto const\u0026 [handle, composerState] : other.mComposerStates) { if (mComposerStates.count(handle) == 0) { mComposerStates[handle] = composerState; } else { if (composerState.state.what \u0026 layer_state_t::eBufferChanged) { releaseBufferIfOverwriting(mComposerStates[handle].state); } mComposerStates[handle].state.merge(composerState.state); } } for (auto const\u0026 state : other.mDisplayStates) { ssize_t index = mDisplayStates.indexOf(state); if (index \u003c 0) { mDisplayStates.add(state); } else { mDisplayStates.editItemAt(static_cast(index)).merge(state); } } for (const auto\u0026 [listener, callbackInfo] : other.mListenerCallbacks) { auto\u0026 [callbackIds, surfaceControls] = callbackInfo; mListenerCallbacks[listener].callbackIds.insert(std::make_move_iterator( callbackIds.begin()), std::make_move_iterator(callbackIds.end())); mListenerCallbacks[listener].surfaceControls.insert(surfaceControls.begin(), surfaceControls.end()); auto\u0026 currentProcessCallbackInfo = mListenerCallbacks[TransactionCompletedListener::getIInstance()]; currentProcessCallbackInfo.surfaceControls .insert(std::make_move_iterator(surfaceControls.begin()), std::make_move_iterator(surfaceControls.end())); // register all surface controls for all callbackIds for this listener that is merging for (const auto\u0026 surfaceControl : currentProcessCallbackInfo.surfaceControls) { TransactionCompletedListener::getInstance() -\u003eaddSurfaceControlToCallbacks(surfaceControl, currentProcessCallbackInfo.callbackIds); } } mInputWindowCommands.merge(other.mInputWindowCommands); mContainsBuffer |= other.mContainsBuffer; mEarlyWakeupStart = mEarlyWakeupStart","date":"2024-11-06","objectID":"/posts/surfacecontrol%E4%B9%8Btransaction%E4%BA%8B%E7%89%A9%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-android-framework%E5%AE%9E%E6%88%98%E5%BC%80%E5%8F%91-csdn%E5%8D%9A%E5%AE%A2/:0:4","tags":["clippings","blog","Framework"],"title":"SurfaceControlä¹‹Transactionäº‹ç‰©æ·±å…¥å‰–æ-android frameworkå®æˆ˜å¼€å‘-CSDNåšå®¢","uri":"/posts/surfacecontrol%E4%B9%8Btransaction%E4%BA%8B%E7%89%A9%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-android-framework%E5%AE%9E%E6%88%98%E5%BC%80%E5%8F%91-csdn%E5%8D%9A%E5%AE%A2/#applyæ–¹æ³•"},{"categories":null,"collections":["SurfaceControl","å›¾å½¢æ˜¾ç¤º"],"content":"Transactionç›¸å…³ä»‹ç» ä¸»è¦æˆå‘˜ layer_state_tç»“æ„ä½“ ç”¨æ¥ä»£è¡¨Layerå›¾å±‚çš„çš„ç›¸å…³ä¿¡æ¯ï¼ŒSurfaceControlä¸sfçš„Layerå…±ç”¨è¿™ä¸ªlayer_state_tç»“æ„ä½“ï¼Œlayer_state_tåŒ…æ‹¬layeræ‰€æœ‰å±æ€§ ä¸»è¦æˆå‘˜å¦‚ä¸‹ï¼š å¯ä»¥çœ‹åˆ°å¸¸è§çš„ä¸»è¦å±æ€§ï¼šåæ ‡ï¼Œé•¿å®½ï¼Œå˜æ¢çŸ©é˜µï¼Œå˜åŒ–å€¼whatï¼Œflagsï¼Œmaskç­‰ï¼Œä¸€èˆ¬æ˜¯ä¸€ä¸ªå›¾å±‚å°±æœ‰ä¸€ä¸ªlayer_state_tç»“æ„ä½“ã€‚ ComposerStatesç»“æ„ä½“ struct ComposerState { layer_state_t state; status_t write(Parcel\u0026 output) const; status_t read(const Parcel\u0026 input); }; å¯ä»¥çœ‹å‡ºå°±æ˜¯layer_state_tè¿›è¡Œäº†ä¸€ä¸ªåŒ…è£…è€Œå·² mComposerStates å®šä¹‰å¦‚ä¸‹ï¼š std::unordered_map mComposerStates; å¯ä»¥çœ‹å‡ºæ¥å…¶å®å°±æ˜¯ä¸€ä¸ªè£…è½½ComposerStateçš„mapå®¹å™¨ï¼Œmapçš„keyæ˜¯æ¯ä¸ªSurfaceControlçš„handle,å…·ä½“å¯ä»¥çœ‹ä¸€ä¸‹è¿™ä¸ªmComposerStatesçš„å®¹å™¨æ·»åŠ æ–¹æ³•ï¼š layer_state_t* SurfaceComposerClient::Transaction::getLayerState(const sp\u0026 sc) { auto handle = sc-\u003egetLayerStateHandle();//è·å–SurfaceControlçš„handleï¼Œ //åˆ¤æ–­æ˜¯å¦mComposerStateså®¹å™¨æ˜¯å¦å­˜åœ¨è¿™ä¸ªscçš„ç›¸å…³ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿›å…¥æ·»åŠ  if (mComposerStates.count(handle) == 0) { // we don't have it, add an initialized layer_state to our list ComposerState s;//åˆå§‹åŒ–ä¸€ä¸ªComposerState s.state.surface = handle; s.state.layerId = sc-\u003egetLayerId(); mComposerStates[handle] = s;//æŠŠåˆå§‹åŒ–çš„ComposerStateæ”¾åˆ°mapé›†åˆmComposerStatesä¸­ } //å¦‚æœå­˜åœ¨ï¼Œåˆ™ç›´æ¥é€šè¿‡handleä»mComposerStatesè·å–stateè¿”å› return \u0026(mComposerStates[handle].state); } ä¸Šé¢å…¶å®å¯ä»¥å¾—å‡ºå¦‚ä¸‹ç»“è®ºï¼š 1ã€æ¯ä¸ªTransactionéƒ½æœ‰è‡ªå·±çš„ä¸€ä¸ªmComposerStatesé›†åˆ 2ã€mComposerStatesé›†åˆä¼šæ”¾å…¥Transactionä¸­ä¼šæ“ä½œçš„SurfaceControlå¯¹åº”çš„layer_state_t è¡¥å……ä¸€ä¸‹ sc-\u003egetLayerStateHandleæ–¹æ³•ï¼š sp SurfaceControl::getLayerStateHandle() const { return mHandle; } è¿™ä¸ªmHandleå…¶å®å°±æ˜¯sfç«¯åˆ›å»ºä¸€ä¸ªHandle sp Layer::getHandle() { Mutex::Autolock _l(mLock); if (mGetHandleCalled) { ALOGE(\"Get handle called twice\" ); return nullptr; } mGetHandleCalled = true; return new Handle(mFlinger, this); } å³mHandleæ˜¯sfç«¯ä»£è¡¨Layerçš„BpBinderå¯¹è±¡ã€‚ ä¸»è¦æ–¹æ³• ä¸€äº›å±æ€§å¸¸è§è®¾ç½®æ–¹æ³• //å¯ä»¥çœ‹åˆ°ä¸€èˆ¬å±æ€§æ“ä½œæ–¹æ³•ç¬¬ä¸€å‚æ•°æ˜¯SurfaceControlï¼Œåé¢å±æ€§éœ€è¦å‚æ•° SurfaceComposerClient::Transaction\u0026 SurfaceComposerClient::Transaction::setPosition( const sp\u0026 sc, float x, float y) { layer_state_t* s = getLayerState(sc); //è·å–scå¯¹åº”çš„layer_state_t s-\u003ewhat |= layer_state_t::ePositionChanged;//æ”¹å˜whatï¼Œå³æ ‡è®°layer_state_tå“ªä¸ªå±æ€§æ˜¯æœ‰å˜åŒ–çš„ï¼Œæ–¹ä¾¿sfè¿›è¡Œè¯†åˆ«è·å– s-\u003ex = x; //æ¥ä¸‹æ¥æ‰æ˜¯æ”¹å˜å…·ä½“çš„å€¼ s-\u003ey = y; registerSurfaceControlForCallback(sc); return *this; } ä¸Šé¢å°±æ˜¯ä¸€ä¸ªç»å…¸çš„Transactionæ”¹å˜å±æ€§çš„æ–¹æ³•ï¼Œå¸¸è§„å°±æ˜¯ä»¥ä¸‹å‡ æ­¥ï¼š 1ã€é€šè¿‡ä¼ é€’æ¥çš„scï¼Œè·å–scçš„layer_state_t 2ã€æ ‡è®°layer_state_tçš„whatå±æ€§ï¼Œä¸»è¦ä¸ºäº†æ˜æ˜¾è¡¨è¾¾å‡ºå“ªä¸ªå±æ€§å˜åŒ–äº† 3ã€è¿›è¡Œå…·ä½“å±æ€§æ”¹å˜ å…¶ä»–çš„å±æ€§æ–¹æ³•å¥—è·¯éƒ½å’Œä¸Šé¢åŸºæœ¬ä¸€æ · mergeæ–¹æ³• ä¸»è¦ç›®çš„æ˜¯æŠŠå¤šä¸ªTransactionçš„å†…å®¹åˆå¹¶åˆ°ä¸€ä¸ªï¼Œå³æŠŠotherçš„è¿™ä¸ªTransactionå†…å®¹éƒ½æ‹·è´åˆ°å½“å‰Transaction SurfaceComposerClient::Transaction\u0026 SurfaceComposerClient::Transaction::merge(Transaction\u0026\u0026 other) { for (auto const\u0026 [handle, composerState] : other.mComposerStates) { if (mComposerStates.count(handle) == 0) { mComposerStates[handle] = composerState; } else { if (composerState.state.what \u0026 layer_state_t::eBufferChanged) { releaseBufferIfOverwriting(mComposerStates[handle].state); } mComposerStates[handle].state.merge(composerState.state); } } for (auto const\u0026 state : other.mDisplayStates) { ssize_t index = mDisplayStates.indexOf(state); if (index \u003c 0) { mDisplayStates.add(state); } else { mDisplayStates.editItemAt(static_cast(index)).merge(state); } } for (const auto\u0026 [listener, callbackInfo] : other.mListenerCallbacks) { auto\u0026 [callbackIds, surfaceControls] = callbackInfo; mListenerCallbacks[listener].callbackIds.insert(std::make_move_iterator( callbackIds.begin()), std::make_move_iterator(callbackIds.end())); mListenerCallbacks[listener].surfaceControls.insert(surfaceControls.begin(), surfaceControls.end()); auto\u0026 currentProcessCallbackInfo = mListenerCallbacks[TransactionCompletedListener::getIInstance()]; currentProcessCallbackInfo.surfaceControls .insert(std::make_move_iterator(surfaceControls.begin()), std::make_move_iterator(surfaceControls.end())); // register all surface controls for all callbackIds for this listener that is merging for (const auto\u0026 surfaceControl : currentProcessCallbackInfo.surfaceControls) { TransactionCompletedListener::getInstance() -\u003eaddSurfaceControlToCallbacks(surfaceControl, currentProcessCallbackInfo.callbackIds); } } mInputWindowCommands.merge(other.mInputWindowCommands); mContainsBuffer |= other.mContainsBuffer; mEarlyWakeupStart = mEarlyWakeupStart","date":"2024-11-06","objectID":"/posts/surfacecontrol%E4%B9%8Btransaction%E4%BA%8B%E7%89%A9%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-android-framework%E5%AE%9E%E6%88%98%E5%BC%80%E5%8F%91-csdn%E5%8D%9A%E5%AE%A2/:0:4","tags":["clippings","blog","Framework"],"title":"SurfaceControlä¹‹Transactionäº‹ç‰©æ·±å…¥å‰–æ-android frameworkå®æˆ˜å¼€å‘-CSDNåšå®¢","uri":"/posts/surfacecontrol%E4%B9%8Btransaction%E4%BA%8B%E7%89%A9%E6%B7%B1%E5%85%A5%E5%89%96%E6%9E%90-android-framework%E5%AE%9E%E6%88%98%E5%BC%80%E5%8F%91-csdn%E5%8D%9A%E5%AE%A2/#è¡¥å……sfç«¯çš„å¤„ç†"},{"categories":["hello"],"collections":null,"content":"Welcome to Hugo FixIt! This is your very first post. ","date":"2022-09-29","objectID":"/posts/hello-world/:0:0","tags":["FixIt"],"title":"Hello World","uri":"/posts/hello-world/#"}]