# Linux ä¸‹ä½¿ç”¨ Tar ä¸Ž Pigz è¿›è¡Œå¤šæ ¸åŽ‹ç¼©

## å®žç”¨å‘½ä»¤æ±‡æ€»

| ä»»åŠ¡     | å‘½ä»¤                                                              |
| ------ | --------------------------------------------------------------- |
| å¤šæ ¸åŽ‹ç¼©ç›®å½• | \`tar -cvf - /data                                              |
| å¤šæ ¸è§£åŽ‹æ–‡ä»¶ | \`pigz -dc -p 4 /backup/data.tar.gz                             |
| ç®€å†™åŽ‹ç¼©å‘½ä»¤ | `tar --use-compress-program="pigz -p 4" -cvf data.tar.gz /data` |
| ç®€å†™è§£åŽ‹å‘½ä»¤ | `tar --use-compress-program="pigz -dp 4" -xvf data.tar.gz`      |
| åŽ‹ç¼©å‘½ä»¤   | tar -cvf - /data \| pigz -p \$(nproc)-2 > /backup/backup.tar.gz |
| è§£åŽ‹     | pigz -dc -p \$(nproc)-2 /backup/backup.tar.gz \| tar -xvf -     |

-p \$(nproc)-1

## ðŸ“˜ Linux ä¸‹ä½¿ç”¨ tar ä¸Ž pigz è¿›è¡Œå¤šæ ¸åŽ‹ç¼©

## ä¸€ã€æ¦‚è¿°

åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œ `tar` æ˜¯æœ€å¸¸ç”¨çš„å½’æ¡£ï¼ˆæ‰“åŒ…ï¼‰å·¥å…·ä¹‹ä¸€ï¼Œç”¨äºŽå°†å¤šä¸ªæ–‡ä»¶æˆ–ç›®å½•åˆå¹¶ä¸ºä¸€ä¸ªæ–‡ä»¶ã€‚\
è€Œ `gzip` æ˜¯å¸¸ç”¨çš„åŽ‹ç¼©å·¥å…·ï¼Œç”¨äºŽå¯¹æ–‡ä»¶å†…å®¹è¿›è¡ŒåŽ‹ç¼©ã€‚

`tar` ä¸Ž `gzip` å¸¸æ­é…ä½¿ç”¨å½¢æˆå‘½ä»¤ï¼š

```
tar -czf backup.tar.gz /data
```

ä½†è¿™ç§æ–¹å¼çš„ä¸€ä¸ªæ˜Žæ˜¾é™åˆ¶æ˜¯ï¼š

> âš ï¸ `tar` ä¸Ž `gzip` å‡ä¸ºå•çº¿ç¨‹ç¨‹åºï¼Œåªèƒ½ä½¿ç”¨ä¸€ä¸ª CPU æ ¸å¿ƒã€‚

å½“ç³»ç»Ÿ CPU è¾ƒå¤šã€æ–‡ä»¶è¾ƒå¤§æ—¶ï¼ˆå¦‚ 10GB ä»¥ä¸Šï¼‰ï¼Œè¿™ç§å•çº¿ç¨‹åŽ‹ç¼©ä¼šæˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚

ä¸ºè§£å†³è¿™ä¸€é—®é¢˜ï¼ŒæŽ¨èä½¿ç”¨ `**pigz**` **ï¼ˆParallel Implementation of GZipï¼‰** ï¼Œ\
å®ƒæ˜¯ `gzip` çš„å¤šçº¿ç¨‹ç‰ˆæœ¬ï¼Œå¯ä»¥å……åˆ†åˆ©ç”¨å¤šæ ¸ CPU è¿›è¡ŒåŽ‹ç¼©ã€‚

***

## äºŒã€tar ä¸Ž pigz çš„å…³ç³»ä¸Žå·¥ä½œæ–¹å¼

`tar` ä¸Ž `pigz` å®žé™…æ˜¯ä¸¤ä¸ªç‹¬ç«‹ç¨‹åºï¼š

| ç¨‹åº       | åŠŸèƒ½                    | æ˜¯å¦å¤šçº¿ç¨‹ |
| -------- | --------------------- | ----- |
| **tar**  | è´Ÿè´£æ‰“åŒ…ï¼ˆå°†å¤šä¸ªæ–‡ä»¶åˆå¹¶ä¸ºä¸€ä¸ªæ•°æ®æµï¼‰   | âŒ å•çº¿ç¨‹ |
| **pigz** | è´Ÿè´£åŽ‹ç¼©ï¼ˆå°†æ•°æ®æµåŽ‹ç¼©æˆ gzip æ ¼å¼ï¼‰ | âœ… å¤šçº¿ç¨‹ |

### 1ï¸âƒ£ tar çš„èŒè´£

`tar` çš„ä»»åŠ¡æ˜¯è¯»å–æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ•°æ®ï¼Œç„¶åŽè¾“å‡ºä¸€ä¸ª **æœªåŽ‹ç¼©çš„æ•°æ®æµ** ã€‚\
è¿™ä¸ªè¿‡ç¨‹å‡ ä¹Žä¸æ¶‰åŠå¤æ‚è®¡ç®—ï¼Œä¸»è¦æ˜¯ I/O æ“ä½œã€‚

ç¤ºä¾‹ï¼š

```
tar -cvf - /data
```

è¿™æ¡å‘½ä»¤ä¸ä¼šç”Ÿæˆæ–‡ä»¶ï¼Œè€Œæ˜¯å°†å½’æ¡£å†…å®¹è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼ˆstdoutï¼‰ã€‚\
`-` è¡¨ç¤ºâ€œå†™åˆ°æ ‡å‡†è¾“å‡ºâ€ã€‚

***

### 2ï¸âƒ£ pigz çš„èŒè´£

`pigz` ä»Žæ ‡å‡†è¾“å…¥ï¼ˆstdinï¼‰æŽ¥æ”¶æ•°æ®æµï¼Œå¹¶å¯¹å…¶è¿›è¡Œå¹¶è¡ŒåŽ‹ç¼©ã€‚

ç¤ºä¾‹ï¼š

```
pigz -p 4 > backup.tar.gz
```

`-p 4` è¡¨ç¤ºä½¿ç”¨ 4 ä¸ªçº¿ç¨‹è¿›è¡ŒåŽ‹ç¼©ã€‚\
å®ƒä¼šæ ¹æ® CPU æ ¸å¿ƒæ•°é‡è‡ªåŠ¨åˆ’åˆ†åŽ‹ç¼©å—å¹¶å¹¶è¡Œè®¡ç®—ã€‚

***

### 3ï¸âƒ£ äºŒè€…çš„ç»„åˆï¼šæµå¼ç®¡é“åŽ‹ç¼©

é€šè¿‡ Linux ç®¡é“ï¼ˆ `|` ï¼‰æœºåˆ¶ï¼Œå¯ä»¥è®© `tar` ä¸Ž `pigz` åŒæ—¶å·¥ä½œï¼š

```
tar -cvf - /data | pigz -p 4 > /backup/backup.tar.gz
```

æ‰§è¡Œæ—¶çš„å¹¶è¡Œæµç¨‹å¦‚ä¸‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ tar: è¯»å–æ–‡ä»¶å¹¶æ‰“åŒ…æµå¼è¾“å‡º â”‚ ---> â”‚ pigz: å¤šçº¿ç¨‹åŽ‹ç¼©æ•°æ®æµ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        (å•çº¿ç¨‹)                          (å¤šçº¿ç¨‹)1.2.3.4.
```

**è¿è¡Œç»“æžœï¼š**

* `tar` ä¾ç„¶æ˜¯å•çº¿ç¨‹ï¼›
* `pigz` ä½¿ç”¨ 4 ä¸ª CPU æ ¸ï¼›
* ç®¡é“æœºåˆ¶ä¿è¯ä¸¤è€…è¾¹è¯»è¾¹åŽ‹ç¼©ã€æ— é¡»ä¸­é—´æ–‡ä»¶ï¼›
* æ•´ä½“ CPU åˆ©ç”¨çŽ‡é«˜ã€å†…å­˜å ç”¨ä½Žã€åŽ‹ç¼©é€Ÿåº¦æ˜¾è‘—æå‡ã€‚

***

## ä¸‰ã€ä¸ºä»€ä¹ˆ tar åªèƒ½ä½¿ç”¨ä¸€ä¸ª CPUï¼Ÿ

`tar` æ˜¯ä¸€ç§å…¸åž‹çš„â€œæµå¼å½’æ¡£â€å·¥å…·ï¼Œå®ƒé¡ºåºåœ°éåŽ†æ–‡ä»¶ç³»ç»Ÿã€è¯»å–æ–‡ä»¶å¹¶å†™å…¥è¾“å‡ºæµã€‚\
è¿™ç§é¡ºåºå¤„ç†æ¨¡å¼çš„æ ¸å¿ƒç‰¹ç‚¹æ˜¯ï¼š

* æ¯æ¬¡åªå¤„ç†ä¸€ä¸ªæ–‡ä»¶ï¼›
* ä¸è¿›è¡Œå¤æ‚è¿ç®—ï¼›
* ä¸å…·å¤‡æ•°æ®å—åˆ’åˆ†ä¸Žå¹¶å‘å¤„ç†æœºåˆ¶ï¼›
* å¹¶å‘è¯»å–æ–‡ä»¶è¿˜å¯èƒ½ç ´åå½’æ¡£çš„é¡ºåºä¸€è‡´æ€§ã€‚

å› æ­¤ï¼š

> ðŸ§  ç»“è®ºï¼š `tar` çš„æ ¸å¿ƒç“¶é¢ˆä¸æ˜¯ CPUï¼Œè€Œæ˜¯ç£ç›˜ I/Oã€‚

å³ä½¿æœºå™¨æœ‰ 8 æ ¸ã€16 æ ¸ï¼Œ `tar` è‡ªèº«ä»ç„¶åªä½¿ç”¨ 1 ä¸ªæ ¸å¿ƒã€‚

***

## å››ã€å¦‚ä½•ä½¿ç”¨å¤šæ ¸è¿›è¡ŒåŽ‹ç¼©

### âœ… æ–¹æ¡ˆä¸€ï¼štar + pigzï¼ˆæŽ¨èï¼‰

```
tar -cvf - /data | pigz -p 4 > /backup/backup.tar.gz
```

è¯´æ˜Žï¼š

| å‚æ•°          | å«ä¹‰            |
| ----------- | ------------- |
| `-cvf -`    | æ‰“åŒ…å¹¶è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡º    |
| `pigz -p 4` | ä½¿ç”¨ 4 ä¸ªçº¿ç¨‹åŽ‹ç¼©    |
| `>`         | å°†åŽ‹ç¼©åŽçš„æ•°æ®å†™å…¥ç›®æ ‡æ–‡ä»¶ |

æ€§èƒ½ç‰¹å¾ï¼š

* `tar` å ç”¨çº¦ 1 æ ¸ï¼›
* `pigz` å ç”¨ 4 æ ¸ï¼›
* æ€»å…±åˆ©ç”¨ 5 æ ¸ï¼›
* åŽ‹ç¼©é€Ÿåº¦é€šå¸¸æ˜¯å•çº¿ç¨‹ gzip çš„ 3~5 å€ã€‚

***

### âœ… æ–¹æ¡ˆäºŒï¼štar å†…ç½®è°ƒç”¨ pigzï¼ˆæ›´ç®€æ´ï¼‰

è®¸å¤š Linux å‘è¡Œç‰ˆçš„ `tar` å·²æ”¯æŒç›´æŽ¥ä½¿ç”¨ `pigz` æ›¿ä»£ `gzip` ï¼š

```
tar --use-compress-program="pigz -p 4" -cvf /backup/backup.tar.gz /data
```

ç­‰ä»·äºŽï¼š

```
tar -cvf - /data | pigz -p 4 > /backup/backup.tar.gz
```

ä¼˜ç‚¹ï¼š

* å‘½ä»¤æ›´ç®€æ´ï¼›
* å½’æ¡£å’ŒåŽ‹ç¼©ç”± tar ç®¡ç†ï¼›
* åŒæ ·æ”¯æŒå¤šæ ¸ã€‚

***

### âœ… æ–¹æ¡ˆä¸‰ï¼šè§£åŽ‹æ—¶å¤šæ ¸è§£åŽ‹

åŒæ ·ï¼Œè§£åŽ‹æ—¶ä¹Ÿå¯ä»¥åˆ©ç”¨å¤šæ ¸ï¼š

```
pigz -dc -p 4 /backup/backup.tar.gz | tar -xvf -
```

æˆ–è€…æ›´ç®€æ´çš„å½¢å¼ï¼š

```
tar --use-compress-program="pigz -dp 4" -xvf /backup/backup.tar.gz
```

***

## äº”ã€æ€§èƒ½å¯¹æ¯”ç¤ºä¾‹ï¼ˆ8 æ ¸ CPUï¼‰

| å·¥å…·    | åŽ‹ç¼©æ–¹å¼        | CPUä½¿ç”¨   | åŽ‹ç¼©æ—¶é—´(18GBæ–‡ä»¶)  |
| ----- | ----------- | ------- | ------------- |
| \`tar | gzip\`      | å•çº¿ç¨‹     | 100% of 1 CPU |
| \`tar | pigz -p 4\` | å¤šçº¿ç¨‹ï¼ˆ4æ ¸ï¼‰ | ~400%         |
| \`tar | pigz -p 8\` | å¤šçº¿ç¨‹ï¼ˆ8æ ¸ï¼‰ | ~800%         |

ï¼ˆå®žé™…é€Ÿåº¦å–å†³äºŽç£ç›˜ I/Oã€æ–‡ä»¶ç±»åž‹ã€åŽ‹ç¼©æ¯”ç­‰å› ç´ ï¼‰

***

## å…­ã€åœ¨ç”Ÿäº§çŽ¯å¢ƒä¸­çš„æœ€ä½³å®žè·µ

| åœºæ™¯       | æŽ¨èå‘½ä»¤                      | è¯´æ˜Ž                                |
| -------- | ------------------------- | --------------------------------- |
| 4 æ ¸æœºå™¨    | \`tar -cvf - /data        | pigz -p 3 > /backup/data.tar.gz\` |
| 8 æ ¸æœºå™¨    | \`tar -cvf - /data        | pigz -p 6 > /backup/data.tar.gz\` |
| è‡ªåŠ¨æ£€æµ‹ CPU | `pigz -p $(($(nproc)-1))` | è‡ªåŠ¨ä½¿ç”¨é™¤ 1 å¤–çš„å…¨éƒ¨ CPU                  |

***

## ä¸ƒã€æ€»ç»“

| é¡¹ç›®         | tar   | gzip       | pigz     |
| ---------- | ----- | ---------- | -------- |
| åŠŸèƒ½         | æ‰“åŒ…    | åŽ‹ç¼©         | å¤šçº¿ç¨‹åŽ‹ç¼©    |
| æ˜¯å¦å¤šçº¿ç¨‹      | âŒ     | âŒ          | âœ…        |
| å¯æ›¿ä»£ gzip   | âŒ     | âœ…          | âœ…        |
| æŽ¨èç”¨é€”       | æ‰“åŒ…æ–‡ä»¶  | å…¼å®¹è€ç³»ç»ŸåŽ‹ç¼©    | çŽ°ä»£å¤šæ ¸çŽ¯å¢ƒåŽ‹ç¼© |
| ä¸Ž tar é…åˆæ–¹å¼ | è¾“å‡ºåˆ°ç®¡é“ | `tar -czf` | \`tar    |

***

## ä¹ã€ç»“è¯­

* `tar` çš„ç“¶é¢ˆæ˜¯ I/Oï¼Œè€Œéž CPUï¼›

* `pigz` èƒ½æ˜¾è‘—æé«˜åŽ‹ç¼©æ€§èƒ½ï¼›

* `tar + pigz` çš„ç»„åˆæ˜¯å¤§æ–‡ä»¶å¤‡ä»½çš„ä¸šç•Œæœ€ä½³å®žè·µï¼›

* åˆç†æŽ§åˆ¶çº¿ç¨‹æ•°é‡ï¼ˆå¦‚ `-p 3` æˆ– `-p $(nproc)-1` ï¼‰å¯ä»¥åœ¨æ€§èƒ½ä¸Žç³»ç»Ÿç¨³å®šæ€§é—´å–å¾—æœ€ä½³å¹³è¡¡ã€‚


---

> ä½œè€…: [wentao](https://github.com/huang8604)  
> URL: https://huang8604.github.io/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/  

