<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>Android - 深入浅出理解SeLinux-CSDN博客 - 文韬的文档</title><meta name=author content="wentao"><meta name=description content="官方文档：
https://source.android.com/docs/security/features/selinux
https://source.android.com/docs/security/features/selinux/images/SELinux_Treble.pdf
Your visual how-to guide for SELinux policy enforcement | Opensource.com
SeLinux（Security-Enhanced Linux）是一个标签系统（labeling system）。每个进程都有一个label（称为process label），每个文件系统所涵盖的文件/目录、网络端口、设备等对象也有一个lable（称为Object label）。SeLinux通过编写规则来控制一个process label对一个Object label的访问，这个规则称之为策略（Policy）。SeLinux的这种安全机制称为Mandatory Access Control (MAC)，是在内核层实现的。
"><meta name=keywords content='clippings,转载,blog'><meta itemprop=name content="Android - 深入浅出理解SeLinux-CSDN博客"><meta itemprop=description content="官方文档：
https://source.android.com/docs/security/features/selinux
https://source.android.com/docs/security/features/selinux/images/SELinux_Treble.pdf
Your visual how-to guide for SELinux policy enforcement | Opensource.com
SeLinux（Security-Enhanced Linux）是一个标签系统（labeling system）。每个进程都有一个label（称为process label），每个文件系统所涵盖的文件/目录、网络端口、设备等对象也有一个lable（称为Object label）。SeLinux通过编写规则来控制一个process label对一个Object label的访问，这个规则称之为策略（Policy）。SeLinux的这种安全机制称为Mandatory Access Control (MAC)，是在内核层实现的。"><meta itemprop=datePublished content="2024-11-06T06:57:56+00:00"><meta itemprop=dateModified content="2024-11-05T01:34:01+00:00"><meta itemprop=wordCount content="9616"><meta itemprop=keywords content="Clippings,转载,Blog"><meta property="og:url" content="https://huang8604.github.io/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/"><meta property="og:site_name" content="文韬的文档"><meta property="og:title" content="Android - 深入浅出理解SeLinux-CSDN博客"><meta property="og:description" content="官方文档：
https://source.android.com/docs/security/features/selinux
https://source.android.com/docs/security/features/selinux/images/SELinux_Treble.pdf
Your visual how-to guide for SELinux policy enforcement | Opensource.com
SeLinux（Security-Enhanced Linux）是一个标签系统（labeling system）。每个进程都有一个label（称为process label），每个文件系统所涵盖的文件/目录、网络端口、设备等对象也有一个lable（称为Object label）。SeLinux通过编写规则来控制一个process label对一个Object label的访问，这个规则称之为策略（Policy）。SeLinux的这种安全机制称为Mandatory Access Control (MAC)，是在内核层实现的。"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-06T06:57:56+00:00"><meta property="article:modified_time" content="2024-11-05T01:34:01+00:00"><meta property="article:tag" content="Clippings"><meta property="article:tag" content="转载"><meta property="article:tag" content="Blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="Android - 深入浅出理解SeLinux-CSDN博客"><meta name=twitter:description content="官方文档：
https://source.android.com/docs/security/features/selinux
https://source.android.com/docs/security/features/selinux/images/SELinux_Treble.pdf
Your visual how-to guide for SELinux policy enforcement | Opensource.com
SeLinux（Security-Enhanced Linux）是一个标签系统（labeling system）。每个进程都有一个label（称为process label），每个文件系统所涵盖的文件/目录、网络端口、设备等对象也有一个lable（称为Object label）。SeLinux通过编写规则来控制一个process label对一个Object label的访问，这个规则称之为策略（Policy）。SeLinux的这种安全机制称为Mandatory Access Control (MAC)，是在内核层实现的。"><meta name=application-name content="文涛的记录"><meta name=apple-mobile-web-app-title content="文涛的记录"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical type=text/html href=https://huang8604.github.io/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/ title="Android - 深入浅出理解SeLinux-CSDN博客 - 文韬的文档"><link rel=prev type=text/html href=https://huang8604.github.io/posts/android-%E8%AE%B0%E5%BD%95%E7%B3%BB%E7%BB%9F%E7%A9%BA%E9%97%B4%E7%9A%84%E9%AB%98%E9%80%9A%E7%AD%94%E7%96%91/ title="Android 记录系统空间的高通答疑"><link rel=next type=text/html href=https://huang8604.github.io/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/ title="adsp wristdown 流程与实现"><link rel=alternate type=text/markdown href=https://huang8604.github.io/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/index.md title="Android - 深入浅出理解SeLinux-CSDN博客 - 文韬的文档"><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Android - 深入浅出理解SeLinux-CSDN博客","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/huang8604.github.io\/posts\/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2\/"},"genre":"posts","keywords":"clippings, 转载, blog","wordcount":9616,"url":"https:\/\/huang8604.github.io\/posts\/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2\/","datePublished":"2024-11-06T06:57:56+00:00","dateModified":"2024-11-05T01:34:01+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"wentao"},"description":""}</script><script src=/js/head/color-scheme.min.js></script></head><body data-header-desktop=sticky data-header-mobile=auto><div class=wrapper data-page-style=wide><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=文韬的文档><img class=logo src=/images/doc.jpg alt=文韬的文档 height=32 width=32><span class=header-title-text>文韬的文档</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/archives/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 归档</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/collections/><i class="fa-solid fa-group fa-fw fa-sm" aria-hidden=true></i> 合集</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容…… id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=文韬的文档><img class=logo src=/images/doc.jpg alt=文韬的文档 height=26 width=26><span class=header-title-text>文韬的文档</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容…… id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/archives/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 归档</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/collections/><i class="fa-solid fa-group fa-fw fa-sm" aria-hidden=true></i> 合集</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label=合集></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>Android - 深入浅出理解SeLinux-CSDN博客</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/huang8604 title=作者 target=_blank rel="external nofollow noopener noreferrer author" class=author><img class=avatar src='https://www.gravatar.com/avatar/b89538cdbc35c279ce1df9f3435f42a1?s=32&d=' alt=wentao height=16 width=16>&nbsp;wentao</a></span><span class=post-included-in>&nbsp;收录于 <a href=/collections/%E5%9B%BE%E5%BD%A2%E6%98%BE%E7%A4%BA/ class=post-collection title="合集 - 图形显示"><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i> 图形显示</a></span></div><div class=post-meta-line><span title="发布于 2024-11-06 06:57:56"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden=true></i><time datetime=2024-11-06>2024-11-06</time></span>&nbsp;<span title="更新于 2024-11-05 01:34:01"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden=true></i><time datetime=2024-11-05>2024-11-05</time></span>&nbsp;<span title="9616 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 9700 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 20 分钟</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#设计><strong>设计</strong></a></li></ul></li><li><a href=#2-概念><strong>2. 概念</strong></a><ul><li><a href=#21规则policyrule或叫accessvectorrule><strong>2.1 规则Policy Rule（或叫Access Vector Rule）</strong></a></li><li><a href=#22规则里的关键字说明><strong>2.2 规则里的关键字说明</strong></a><ul><li><a href=#rulename><strong>Rule Name</strong></a></li><li><a href=#type><strong>Type</strong></a><ul><li><a href=#attribute><strong>Attribute</strong></a></li><li><a href=#domain><strong>domain</strong></a></li><li><a href=#file_type><strong>file_type</strong></a></li></ul></li><li><a href=#class><strong>Class</strong></a></li><li><a href=#permissions><strong>Permissions</strong></a></li><li><a href=#示例><strong>示例</strong></a></li></ul></li><li><a href=#23context><strong>2.3 Context</strong></a><ul><li><a href=#进程contextseapp_contexts><strong>进程Context（seapp_contexts）</strong></a></li><li><a href=#文件context><strong>文件Context</strong></a></li><li><a href=#securitycontext><strong>Security Context</strong></a></li><li><a href=#seinfo><strong>seinfo</strong></a></li><li><a href=#untrusted_app><strong>untrusted</strong>**_<strong><strong>a</strong></strong>pp**</a></li><li><a href=#查看当前context><strong>查看当前Context</strong></a></li></ul></li></ul></li><li><a href=#3-selinux的配置><strong>3. SeLinux的配置</strong></a><ul><li><a href=#31-selinux><strong>3</strong>**.**<strong>1</strong> <strong>SeLinux<strong><strong>文件</strong></strong>体系</strong></a><ul><li><ul><li><a href=#boardconfigmkmakefile><strong>BoardConfig.mk makefile</strong></a></li><li><a href=#system_ext和product分区><strong>system_ext</strong> <strong>和</strong> <strong>product分区</strong></a></li></ul></li></ul></li><li><a href=#32policy文件><strong>3</strong>**.2** <strong>Policy文件</strong></a><ul><li><ul><li><a href=#te文件><strong>TE****文件</strong></a></li><li><a href=#contextfiles><strong>Context files</strong></a></li><li><a href=#attribute-1><strong>Attribute</strong></a></li><li><a href=#security_classes><strong>security_classes</strong></a></li></ul></li></ul></li><li><a href=#33typeenforcement文件>**3.<strong><strong>3</strong> <strong>TE</strong></strong>（Type Enforcement）**<strong>文件</strong></a><ul><li><a href=#te文件语法解析><strong>TE文件语法解析</strong></a></li></ul></li></ul></li><li><a href=#4selinux的编译>​​​​​​​4. <strong>SeLinux的编译</strong></a><ul><li><a href=#41-编译selinux-policy><strong>4</strong>**.**<strong>1</strong> <strong>编译****SeLinux</strong> <strong>Policy</strong></a></li><li><a href=#42预编译><strong>4.2 预编译</strong></a></li></ul></li><li><a href=#5-实践><strong>5. 实践</strong></a><ul><li><a href=#51-开启><strong>5</strong>**.**<strong>1</strong> <strong>开启<strong><strong>Se</strong></strong>L<strong><strong>i</strong></strong>n<strong><strong>u</strong></strong>x</strong></a></li><li><a href=#52设定selinux模式>**5.**<strong>2</strong> <strong>设定SeLinux模式</strong></a></li><li><a href=#53-处理><strong>5</strong>**.**<strong>3</strong> <strong>处理<strong><strong>异常</strong></strong>LOG</strong></a><ul><li><a href=#使用auditallow><strong>使用auditallow<strong><strong>生成</strong></strong>TE</strong></a></li></ul></li></ul></li></ul></nav></div></div><div class=content id=content><p>官方文档：</p><p><a href=https://source.android.com/docs/security/features/selinux title=https://source.android.com/docs/security/features/selinux target=_blank rel="external nofollow noopener noreferrer">https://source.android.com/docs/security/features/selinux</a></p><p><a href=https://source.android.com/docs/security/features/selinux/images/SELinux_Treble.pdf title=https://source.android.com/docs/security/features/selinux/images/SELinux_Treble.pdf target=_blank rel="external nofollow noopener noreferrer">https://source.android.com/docs/security/features/selinux/images/SELinux_Treble.pdf</a></p><p><a href=https://opensource.com/business/13/11/selinux-policy-guide title="Your visual how-to guide for SELinux policy enforcement | Opensource.com" target=_blank rel="external nofollow noopener noreferrer">Your visual how-to guide for SELinux policy enforcement | Opensource.com</a></p><p>SeLinux（Security-Enhanced Linux）是一个标签系统（labeling system）。每个进程都有一个label（称为process label），每个文件系统所涵盖的文件/目录、网络端口、设备等对象也有一个lable（称为Object label）。SeLinux通过编写规则来控制一个process label对一个Object label的访问，这个规则称之为策略（Policy）。SeLinux的这种安全机制称为Mandatory Access Control (MAC)，是在内核层实现的。</p><p>在标准的Linux上，也就是未实施SeLinux的Linux上，传统的访问控制是通过owner/group + permission flags（比如rwx）实现的，称之为Discretionary Access Control (DAC).</p><p>SeLinux和传统的DAC不是替代的关系，而是并行的关系。两者同时在起作用。之所以出现SeLinux，是因为传统DAC的安全机制过于粗粝，而Selinux提供了更为细致和安全的访问控制。简言之，传统DAC机制下，一旦你获得了root权限，将无所不能，但在SeLinux的机制下，即使获得了root权限，也仍然需要遵循已经设置好的访问策略，只有指定的进程才可以访问指定的文件。</p><p>SeLinux有两种运行模式：</p><ul><li>Permissive mode：当访问并未授权时，不会阻止访问，但会打印log</li><li>Enforcing mode：当访问未被授权时，会阻止访问，并且会打印log</li></ul><p>log将出现在dmesg和logcat。</p><p>除了可以对整体进行模式设置，也可以针对某个进程单独设置某个模式，除此之外的进程使用全局模式。</p><h3 class=heading-element id=设计><span><strong>设计</strong></span>
<a href=#%e8%ae%be%e8%ae%a1 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>SeLinux在Android 4~7和Android 8以后采用了不同的设计</p><p>Android 4~7上，SeLinux的策略是作为一个整体来编译和更新的；</p><p>Android 8及以后，SeLinux采用了模块化、动态化设计，Platform（可以理解为AOSP的部分）、Non-Platform（vendor、odm、oem的部分，这里总体称为vendor部分）的SeLinux策略分别独立编译、升级。</p><p>附一张Android设备的架构图：</p><p><a class=lightgallery href=https://picgo.myjojo.fun:666/i/2024/10/12/670a460123295.png title=f463c287b1ece4ba4e7f06d0e102abbf\_MD5 data-thumbnail=https://picgo.myjojo.fun:666/i/2024/10/12/670a460123295.png data-sub-html="<h2>f463c287b1ece4ba4e7f06d0e102abbf\_MD5</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2024/10/12/670a460123295.png alt=f463c287b1ece4ba4e7f06d0e102abbf\_MD5></a></p><p>编译后会生成对应的img文件</p><p>● system.img. Contains mainly Android framework.</p><p>● boot.img. (kernel/ramdisk) Contains Linux kernel + Android patches.</p><p>● vendor.img. Contains SoC-specific code and configurations.</p><p>● odm.img. Contains device-specific code and configurations.</p><p>● oem.img. Contains OEM/carrier-related configurations and customizations.</p><p>● bootloader. Brings up the kernel (vendor-proprietary).</p><p>● radio. Modem (proprietary).</p><p>Android 8以后，SeLinux的策略文件可以伴随相应的img独立编译或者OTA。</p><h2 class=heading-element id=2-概念><span><strong>2. 概念</strong></span>
<a href=#2-%e6%a6%82%e5%bf%b5 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>什么是标签（Label）？怎么基于Label对访问进行控制？</p><p>先抛开Label这个概念不说。所谓SeLinux里的访问控制，就是判定一个Source有没有权限去访问Target。这里的Source一般就是进程，Target最长见的就是文件系统（比如文件、目录、socket、设备等等），当然还有其他类型的Target。换句话说，SeLinux的机制就是通过读取一个“规则”，来控制一个进程有没有权限去访问一个文件（或其他类型）。</p><p>上面说的“规则”，在SeLinux里的术语叫做Policy（策略）或叫Access Vector Rule。是可以由AOSP和厂商、供应商来编写的。</p><p>上面的Source，还叫做Subject（主体）</p><p>上面的Target，还叫做Object（对象或客体）</p><p>Label、Source、Target、Subject、Object，这些都不重要， 在实际语法中并没有相关关键词，只要各种资料里出现这些词的时候知道其所指就可以。</p><h3 class=heading-element id=21规则policyrule或叫accessvectorrule><span><strong>2.1 规则Policy Rule（或叫Access Vector Rule）</strong></span>
<a href=#21%e8%a7%84%e5%88%99policyrule%e6%88%96%e5%8f%abaccessvectorrule class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>策略规则的语法为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-kotlin data-lang=kotlin><span class=line><span class=cl><span class=n>allow</span> <span class=n>source</span> <span class=n>target</span><span class=p>:</span><span class=k>class</span> <span class=nc>permissions</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><ul><li>Source - The type (or attribute) of the subject of the rule. Who is requesting the access?（是谁在请求访问一个资源）</li><li>Target - The type (or attribute) of the object. To what is the access requested?（被访问的对象）</li><li>Class - The kind of object (e.g. file, socket) being accessed.（被访问者的类型）</li><li>Permissions - The operation (or set of operations) (e.g. read, write) being performed.（对Target具体要做什么操作？比如对被访问者是文件来说，是要读、写它还是其他操作？）</li></ul><p>具体例子如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cobol data-lang=cobol><span class=line><span class=cl><span class=c>allow </span><span class=nv>sample_app</span><span class=err> </span><span class=nv>app_data_file</span><span class=p>:</span><span class=kr>file </span><span class=err>{ </span><span class=kr>read</span><span class=err> </span><span class=kr>write </span><span class=err>}</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><p>这个例子是说，允许sample_app这个进程去访问app_data_file（它是一个file类型，也就是文件），允许的操作是read和write。</p><p>而其实这里的sample_app并不是一个真正的具体的进程名，而是在系统编译阶段就定义好的一个标签（Label），一些真正的进程被映射到sample_app这个标签上，那么在执行上面规则的时候，其实生效的、有权限访问app_data_file的是所有映射了sample_app标签的那些进程。同样的，app_data_file也不是一个具体的文件名。它也是一个提前声明了的标签，一些真正的文件被映射到这个标签上，sample_app有权访问的是所映射的这些文件。</p><p><a class=lightgallery href=https://picgo.myjojo.fun:666/i/2024/10/12/670a460122661.png title=bf156f6a023d402861339106a2ca1f65\_MD5 data-thumbnail=https://picgo.myjojo.fun:666/i/2024/10/12/670a460122661.png data-sub-html="<h2>bf156f6a023d402861339106a2ca1f65\_MD5</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2024/10/12/670a460122661.png alt=bf156f6a023d402861339106a2ca1f65\_MD5></a></p><p>从这里看出来，有别于传统DAC的Owner、Group、Permissions 的控制方式，所谓的“基于标签系统”的SeLinux，就是这种通过声明标签的方式来表述访问规则的。</p><p>标签只是一种概念性的东西，具体体现在策略文件里，则是抽象成了Type、Attribute、Class、Permissions这些具体关键字。</p><h3 class=heading-element id=22规则里的关键字说明><span><strong>2.2 规则里的关键字说明</strong></span>
<a href=#22%e8%a7%84%e5%88%99%e9%87%8c%e7%9a%84%e5%85%b3%e9%94%ae%e5%ad%97%e8%af%b4%e6%98%8e class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>以下面这个规则举例</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cobol data-lang=cobol><span class=line><span class=cl><span class=c>allow </span><span class=nv>sample_app</span><span class=err> </span><span class=nv>app_data_file</span><span class=p>:</span><span class=kr>file </span><span class=err>{ </span><span class=kr>read</span><span class=err> </span><span class=kr>write </span><span class=err>}</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><h4 class=heading-element id=rulename><span><strong>Rule Name</strong></span>
<a href=#rulename class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>上面规则示例中，allow就是Rule Name的一种。SeLinux有多种RuleName：</p><ul><li>allow：表示允许Source对Target执行许可的操作</li><li>neverallow：表示不允许Source对Target执行制定的操作</li><li>auditallow：表示允许操作并记录访问决策信息</li><li>dontaudit：表示不记录违反规则的决策信息，切违反规则不影响运行。</li></ul><p>其中allow是用的最多的。</p><h4 class=heading-element id=type><span><strong>Type</strong></span>
<a href=#type class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>上面的示例中，sample_app、app_data_file都是一个Type。简单理解就是将一个或几个进程声明为Type A， 将一个或多个文件声明为Type B。那么在控制这个进程有没有权限访问这个文件的时候，只用A和B来表示就可以了。</p><p>这样做有什么好处？“一类进程”总比具体的“一个进程”要灵活的多。把多个进程声明为同一个Type，那么在写规则的时候只要描述这个Type，那么这个Type对应的所有进程都会生效。文件或其他对象也是同样的。</p><p>也就是说，在规则中描述Source能不能访问Target，是通过Type来表述的。</p><p>Type是厂商或供应商可以自定义的</p><h5 class=heading-element id=attribute><span><strong>Attribute</strong></span>
<a href=#attribute class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>将多个Type归为一组，就是一个Attribute。</p><p>通俗的说，把一些进程声明为Type，但是多个Type有某种共通的特性，就可以把这些Type声明为同一个Attribute。在描述规则的时候，可以将Source或者Target指定为一个Attribute而不是Type，这样所有属于这个Attribute的Type都生效。</p><p>AOSP本身内置了一些Attribute，而这些Attribute很多都是约定俗称的固定含义。比如：</p><h5 class=heading-element id=domain><span><strong>domain</strong></span>
<a href=#domain class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>所有进程的type必须归属于domain。domain因此成了进程type的常见表述。</p><h5 class=heading-element id=file_type><span><strong>file_type</strong></span>
<a href=#file_type class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>所有文件type都归属于file_type</p><p>&mldr;</p><p>AOSP内置的Attribute见</p><blockquote><p>platform/system/sepolicy/public/attributes</p><p>platform/system/sepolicy/private/attributes</p><p>platform/system/sepolicy/prebuilts/api/[version]/public/attributes</p><p>platform/system/sepolicy/prebuilts/api/[version]/private/attributes</p></blockquote><h4 class=heading-element id=class><span><strong>Class</strong></span>
<a href=#class class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>上面示例中，“:file”就是一个Class。简单说就是将某些被访问对象归为一种Class，比如说被访问的是文件，Class一般就是file，如果是目录，Class就是dir，如果是socket，Class就是socket等等。Class是AOSP内定义好的，一般不需要自定义</p><p>具体有那些Class，可见源码platform/system/sepolicy/private/security_classes</p><p>Class是用来做什么的？其实是与Permissions相关的。</p><h4 class=heading-element id=permissions><span><strong>Permissions</strong></span>
<a href=#permissions class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>即示例中的 { read write }。表示具体可以做什么操作。不同的Class有不同的Permissions集合。罗列一些Class对应的Permission（非完整）：</p><table><tbody><tr><td colspan=1 rowspan=1><p><span>Class</span></p></td><td colspan=1 rowspan=1><p><span>Permission</span></p></td></tr><tr><td colspan=1 rowspan=1><p><span>file</span></p></td><td colspan=1 rowspan=1><p><span>ioctl&nbsp;read&nbsp;write&nbsp;create&nbsp;getattr&nbsp;setattr&nbsp;lock&nbsp;relabelfrom&nbsp;relabelto&nbsp;append&nbsp;unlink&nbsp;link&nbsp;rename&nbsp;execute&nbsp;swapon&nbsp;quotaon&nbsp;mounton</span></p></td></tr><tr><td colspan=1 rowspan=1><p><span>directory</span></p></td><td colspan=1 rowspan=1><p><span>add_name&nbsp;remove_name&nbsp;reparent&nbsp;search&nbsp;rmdir&nbsp;open&nbsp;audit_access&nbsp;execmod</span></p></td></tr><tr><td colspan=1 rowspan=1><p><span>socket</span></p></td><td colspan=1 rowspan=1><p><span>ioctl&nbsp;read&nbsp;write&nbsp;create&nbsp;getattr&nbsp;setattr&nbsp;lock&nbsp;relabelfrom&nbsp;relabelto&nbsp;append&nbsp;bind&nbsp;connect&nbsp;listen&nbsp;accept&nbsp;getopt&nbsp;setopt&nbsp;shutdown&nbsp;recvfrom&nbsp;sendto&nbsp;recv_msg&nbsp;send_msg&nbsp;name_bind</span></p></td></tr><tr><td colspan=1 rowspan=1><p><span>filesystem</span></p></td><td colspan=1 rowspan=1><p><span>mount&nbsp;remount&nbsp;unmount&nbsp;getattr&nbsp;relabelfrom&nbsp;relabelto&nbsp;transition&nbsp;associate&nbsp;quotamod&nbsp;quotaget</span></p></td></tr><tr><td colspan=1 rowspan=1><p><span>process</span></p></td><td colspan=1 rowspan=1><p><span>fork&nbsp;transition&nbsp;sigchld&nbsp;sigkill&nbsp;sigstop&nbsp;signull&nbsp;signal&nbsp;ptrace&nbsp;getsched&nbsp;setsched&nbsp;getsession&nbsp;getpgid&nbsp;setpgid&nbsp;getcap&nbsp;setcap&nbsp;share&nbsp;getattr&nbsp;setexec&nbsp;setfscreate&nbsp;noatsecure&nbsp;siginh&nbsp;setrlimit&nbsp;rlimitinh&nbsp;dyntransition&nbsp;setcurrent&nbsp;execmem&nbsp;execstack&nbsp;execheap&nbsp;setkeycreate&nbsp;setsockcreate</span></p></td></tr><tr><td colspan=1 rowspan=1><p><span>security</span></p></td><td colspan=1 rowspan=1><p><span>compute_av&nbsp;compute_create&nbsp;compute_member&nbsp;check_context&nbsp;load_policy&nbsp;compute_relabel&nbsp;compute_user&nbsp;setenforce&nbsp;setbool&nbsp;setsecparam&nbsp;setcheckreqprot&nbsp;read_policy</span></p></td></tr><tr><td colspan=1 rowspan=1><p><span>capability</span></p></td><td colspan=1 rowspan=1><p><span>chown&nbsp;dac_override&nbsp;dac_read_search&nbsp;fowner&nbsp;fsetid&nbsp;kill&nbsp;setgid&nbsp;setuid&nbsp;setpcap&nbsp;linux_immutable&nbsp;net_bind_service&nbsp;net_broadcast&nbsp;net_admin&nbsp;net_raw&nbsp;ipc_lock&nbsp;ipc_owner&nbsp;sys_module&nbsp;sys_rawio&nbsp;sys_chroot&nbsp;sys_ptrace&nbsp;sys_pacct&nbsp;sys_admin&nbsp;sys_boot&nbsp;sys_nice&nbsp;sys_resource&nbsp;sys_time&nbsp;sys_tty_config&nbsp;mknod&nbsp;lease&nbsp;audit_write&nbsp;audit_control&nbsp;setfcap</span></p></td></tr><tr><td colspan=1 rowspan=1><p><strong><span>MORE</span></strong></p></td><td colspan=1 rowspan=1><p><strong><span>AND&nbsp;MORE</span></strong></p></td></tr></tbody></table><p>可以从对应的Class中选取任意个Permission</p><p>Class与Perimssion的完整映射具体见源码：kernel/arm64/security/selinux/include/classmap.h</p><h4 class=heading-element id=示例><span><strong>示例</strong></span>
<a href=#%e7%a4%ba%e4%be%8b class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p><a class=lightgallery href=https://picgo.myjojo.fun:666/i/2024/10/12/670a460121437.png title=161e79e977c6d226e5c3d195a2e75e58\_MD5 data-thumbnail=https://picgo.myjojo.fun:666/i/2024/10/12/670a460121437.png data-sub-html="<h2>161e79e977c6d226e5c3d195a2e75e58\_MD5</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2024/10/12/670a460121437.png alt=161e79e977c6d226e5c3d195a2e75e58\_MD5></a></p><p>以控制狗是否有权吃猫粮狗粮为例。</p><p>有一个狗叫小黄， 一种狗粮叫“狗粮A”。</p><p>现在声明一个Type叫dog，一个Type叫dog_chow，系统本身内置了Class叫food，food对应的permissions里包含了eat这个权限。</p><p>随后将小黄映射到dog这个type，将狗粮A映射到dog_chow这个type</p><p>这样，在添加了这样一条规则后，小黄就有权限去吃狗粮A了：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=cl><span class=nt>allow</span> <span class=nt>dog</span> <span class=nt>dog_chow</span><span class=p>:</span><span class=nd>food</span> <span class=nt>eat</span><span class=o>;</span></span></span></code></pre></td></tr></table></div></div><p>此时如果还有一只狗小白，那么可以将小白映射到dog这个type，这样小白也可以有权限吃狗粮A。</p><h3 class=heading-element id=23context><span><strong>2.3 Context</strong></span>
<a href=#23context class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>上面所说的“映射”，即将一个进程关联到一个Type，或者将一个文件关联到一个Type，是通过context来完成的。</p><h4 class=heading-element id=进程contextseapp_contexts><span><strong>进程Context（seapp_contexts）</strong></span>
<a href=#%e8%bf%9b%e7%a8%8bcontextseapp_contexts class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>一个进程的Context条目可能如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cobol data-lang=cobol><span class=line><span class=cl><span class=c>user=_</span><span class=nv>app</span><span class=err> </span><span class=nv>isPrivApp</span><span class=o>=</span><span class=nb>true</span><span class=err> </span><span class=nv>name</span><span class=o>=</span><span class=nv>com</span><span class=p>.</span><span class=nv>android</span><span class=p>.</span><span class=nv>vzwomatrigger</span><span class=err> </span><span class=nv>domain</span><span class=o>=</span><span class=nv>vzwomatrigger_app</span><span class=err> </span><span class=kp>type</span><span class=o>=</span><span class=nv>privapp_data_file</span><span class=err> </span><span class=nv>levelFrom</span><span class=o>=</span><span class=kp>all</span></span></span></code></pre></td></tr></table></div></div><p>user=_app代表这是一个常规的app；</p><p>isPrivApp=true代表这是一个预置app；</p><p>name=com.android.vzwomatrigger 指定了进程名</p><p>domain=vzwomatrigger_app 将进程名关联到一个type</p><p>type=privapp_data_file 这是一个文件type，指定了app的data directory目录所属的type</p><p>levelFrom=all MLS/MCS的level相关</p><p>AOSP内置进程Context见platform/system/sepolicy/private/seapp_contexts</p><p>供应商或厂商要定义自己的seapp_context，将在/vender下或&lt;root>/device/manufacturer/device-name/sepolicy下相应目录添加</p><h4 class=heading-element id=文件context><span><strong>文件Context</strong></span>
<a href=#%e6%96%87%e4%bb%b6context class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>一个文件的Context可能这样：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-haskell data-lang=haskell><span class=line><span class=cl><span class=o>/</span><span class=n>system</span><span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=n>bcc</span>                 <span class=n>u</span><span class=kt>:</span><span class=n>object_r</span><span class=kt>:</span><span class=n>rs_exec</span><span class=kt>:</span><span class=n>s0</span></span></span></code></pre></td></tr></table></div></div><p>/system/bin/bcc 指的是具体文件</p><p>u:object_r:rs_exec:s0是一个security context。其中的rs_exec为type。这样文件和type就进行了关联</p><h4 class=heading-element id=securitycontext><span><strong>Security Context</strong></span>
<a href=#securitycontext class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>其格式为：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-haskell data-lang=haskell><span class=line><span class=cl><span class=nf>user</span><span class=kt>:</span><span class=n>role</span><span class=kt>:</span><span class=kr>type</span><span class=kt>:</span><span class=n>sensitivity</span><span class=p>[</span><span class=kt>:</span><span class=n>categories</span><span class=p>]</span></span></span></code></pre></td></tr></table></div></div><p>在Android中，</p><p>user是固定的，永远为u</p><p>role是固定的，访问者（称subject或source）永远为r；被访问者（称object或target）永远为object_r。一般情况下，进程一方就是subject，文件一方就是object，所以一般进程的role为r，文件的role为object_r。</p><p>type为与文件关联的type</p><p>sensitivity是固定的，永远为s0</p><p>categories是Multi-Level Security (MLS) 协议，用来隔离一个app的data，防止被另一个app访问，或者隔离不同用户间对同一个app data的访问。</p><blockquote><p>AOSP内置的文件Context见platform/system/sepolicy/private/file_contexts</p></blockquote><h4 class=heading-element id=seinfo><span><strong>seinfo</strong></span>
<a href=#seinfo class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>seapp_context里除了可以将一个具体应用映射到一个domain，也可以将seinf映射到domain。mac_permissions.xml里定义了seinfo。其会根据app所属的signature来为其分配一个seinfo。</p><p>比如：</p><p>platform/system/sepolicy/private/mac_permissions.xml</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=c>&lt;!-- Platform dev key in AOSP --&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;signer</span> <span class=na>signature=</span><span class=s>&#34;@PLATFORM&#34;</span> <span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;seinfo</span> <span class=na>value=</span><span class=s>&#34;platform&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/signer&gt;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=c>&lt;!-- Sdk Sandbox key --&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;signer</span> <span class=na>signature=</span><span class=s>&#34;@SDK_SANDBOX&#34;</span> <span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;seinfo</span> <span class=na>value=</span><span class=s>&#34;sdk_sandbox&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/signer&gt;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=c>&lt;!-- Bluetooth key in AOSP --&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;signer</span> <span class=na>signature=</span><span class=s>&#34;@BLUETOOTH&#34;</span> <span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;seinfo</span> <span class=na>value=</span><span class=s>&#34;bluetooth&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/signer&gt;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=c>&lt;!-- Media key in AOSP --&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;signer</span> <span class=na>signature=</span><span class=s>&#34;@MEDIA&#34;</span> <span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;seinfo</span> <span class=na>value=</span><span class=s>&#34;media&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/signer&gt;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=nt>&lt;signer</span> <span class=na>signature=</span><span class=s>&#34;@NETWORK_STACK&#34;</span> <span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>      <span class=nt>&lt;seinfo</span> <span class=na>value=</span><span class=s>&#34;network_stack&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/signer&gt;</span></span></span></code></pre></td></tr></table></div></div><p>也就是说所有拥有PLATFORM signature的app，将拥有platform这个seinfo。在seapp_context中可以如下配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=n>user</span><span class=o>=</span><span class=n>radio</span> <span class=n>seinfo</span><span class=o>=</span><span class=n>platform</span> <span class=n>domain</span><span class=o>=</span><span class=n>radio</span> <span class=n>type</span><span class=o>=</span><span class=n>radio_data_file</span></span></span></code></pre></td></tr></table></div></div><p>所有拥有platform签名的，并且未配置具体context的app，将遵循其seinfo platform的规则。</p><h4 class=heading-element id=untrusted_app><span><strong>untrusted</strong>**_<strong><strong>a</strong></strong>pp**</span>
<a href=#untrusted_app class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>既为配置seinfo，又未配置seapp_context的app，将默认为untrusted_app。各级seapp_context中也有对untrusted_app的权限配置。</p><h4 class=heading-element id=查看当前context><span><strong>查看当前Context</strong></span>
<a href=#%e6%9f%a5%e7%9c%8b%e5%bd%93%e5%89%8dcontext class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>要看进程的Context，使用ps -Z</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-haskell data-lang=haskell><span class=line><span class=cl><span class=nf>emu64xa</span><span class=kt>:/</span> <span class=o>$</span> <span class=n>ps</span> <span class=o>-</span><span class=kt>AZ</span> <span class=o>|</span> <span class=n>grep</span> <span class=n>google</span>
</span></span><span class=line><span class=cl><span class=nf>u</span><span class=kt>:</span><span class=n>r</span><span class=kt>:</span><span class=n>hal_camera_default</span><span class=kt>:</span><span class=n>s0</span>      <span class=n>system</span>         <span class=mi>362</span>     <span class=mi>1</span>   <span class=mi>10891800</span>   <span class=mi>3272</span> <span class=mi>0</span>                   <span class=mi>0</span> <span class=kt>S</span> <span class=n>android</span><span class=o>.</span><span class=n>hardware</span><span class=o>.</span><span class=n>camera</span><span class=o>.</span><span class=n>provider</span><span class=o>@</span><span class=mf>2.7</span><span class=o>-</span><span class=n>service</span><span class=o>-</span><span class=n>google</span>
</span></span><span class=line><span class=cl><span class=nf>u</span><span class=kt>:</span><span class=n>r</span><span class=kt>:</span><span class=n>permissioncontroller_app</span><span class=kt>:</span><span class=n>s0</span><span class=kt>:</span><span class=n>c179</span><span class=p>,</span><span class=n>c256</span><span class=p>,</span><span class=n>c512</span><span class=p>,</span><span class=n>c768</span> <span class=n>u0_a179</span> <span class=mi>976</span> <span class=mi>354</span> <span class=mi>13918328</span> <span class=mi>83660</span> <span class=mi>0</span>          <span class=mi>0</span> <span class=kt>S</span> <span class=n>com</span><span class=o>.</span><span class=n>google</span><span class=o>.</span><span class=n>android</span><span class=o>.</span><span class=n>permissioncontroller</span>
</span></span><span class=line><span class=cl><span class=nf>u</span><span class=kt>:</span><span class=n>r</span><span class=kt>:</span><span class=n>bluetooth</span><span class=kt>:</span><span class=n>s0</span>               <span class=n>bluetooth</span>     <span class=mi>1033</span>   <span class=mi>354</span>   <span class=mi>14050488</span>  <span class=mi>73628</span> <span class=mi>0</span>                   <span class=mi>0</span> <span class=kt>S</span> <span class=n>com</span><span class=o>.</span><span class=n>google</span><span class=o>.</span><span class=n>android</span><span class=o>.</span><span class=n>bluetooth</span>
</span></span><span class=line><span class=cl><span class=nf>u</span><span class=kt>:</span><span class=n>r</span><span class=kt>:</span><span class=n>priv_app</span><span class=kt>:</span><span class=n>s0</span><span class=kt>:</span><span class=n>c512</span><span class=p>,</span><span class=n>c768</span>      <span class=n>u0_a167</span>       <span class=mi>1090</span>   <span class=mi>354</span>   <span class=mi>14016372</span> <span class=mi>119796</span> <span class=mi>0</span>                   <span class=mi>0</span> <span class=kt>S</span> <span class=n>com</span><span class=o>.</span><span class=n>google</span><span class=o>.</span><span class=n>android</span><span class=o>.</span><span class=n>apps</span><span class=o>.</span><span class=n>nexuslauncher</span>
</span></span><span class=line><span class=cl><span class=nf>u</span><span class=kt>:</span><span class=n>r</span><span class=kt>:</span><span class=n>priv_app</span><span class=kt>:</span><span class=n>s0</span><span class=kt>:</span><span class=n>c512</span><span class=p>,</span><span class=n>c768</span>      <span class=n>u0_a170</span>       <span class=mi>1157</span>   <span class=mi>354</span>   <span class=mi>13873728</span>  <span class=mi>68724</span> <span class=mi>0</span>                   <span class=mi>0</span> <span class=kt>S</span> <span class=n>com</span><span class=o>.</span><span class=n>google</span><span class=o>.</span><span class=n>android</span><span class=o>.</span><span class=n>ext</span><span class=o>.</span><span class=n>services</span>
</span></span><span class=line><span class=cl><span class=nf>u</span><span class=kt>:</span><span class=n>r</span><span class=kt>:</span><span class=n>untrusted_app_32</span><span class=kt>:</span><span class=n>s0</span><span class=kt>:</span><span class=n>c142</span><span class=p>,</span><span class=n>c256</span><span class=p>,</span><span class=n>c512</span><span class=p>,</span><span class=n>c768</span> <span class=n>u0_a142</span> <span class=mi>1393</span> <span class=mi>354</span> <span class=mi>14070168</span> <span class=mi>104520</span> <span class=mi>0</span>                <span class=mi>0</span> <span class=kt>S</span> <span class=n>com</span><span class=o>.</span><span class=n>google</span><span class=o>.</span><span class=n>android</span><span class=o>.</span><span class=n>inputmethod</span><span class=o>.</span><span class=n>latin</span></span></span></code></pre></td></tr></table></div></div><p>查看文件的Context，使用</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-haskell data-lang=haskell><span class=line><span class=cl><span class=nf>emu64xa</span><span class=kt>:/</span> <span class=o>$</span> <span class=n>ls</span> <span class=o>-</span><span class=kt>Z</span>
</span></span><span class=line><span class=cl><span class=nf>u</span><span class=kt>:</span><span class=n>object_r</span><span class=kt>:</span><span class=n>cgroup</span><span class=kt>:</span><span class=n>s0</span>                <span class=n>acct</span>         <span class=n>u</span><span class=kt>:</span><span class=n>object_r</span><span class=kt>:</span><span class=n>tmpfs</span><span class=kt>:</span><span class=n>s0</span>                 <span class=n>debug_ramdisk</span>    <span class=n>u</span><span class=kt>:</span><span class=n>object_r</span><span class=kt>:</span><span class=n>vendor_file</span><span class=kt>:</span><span class=n>s0</span>           <span class=n>odm</span>                     <span class=n>u</span><span class=kt>:</span><span class=n>object_r</span><span class=kt>:</span><span class=n>sysfs</span><span class=kt>:</span><span class=n>s0</span>                 <span class=n>sys</span>
</span></span><span class=line><span class=cl><span class=nf>u</span><span class=kt>:</span><span class=n>object_r</span><span class=kt>:</span><span class=n>apex_mnt_dir</span><span class=kt>:</span><span class=n>s0</span>          <span class=n>apex</span>         <span class=n>u</span><span class=kt>:</span><span class=n>object_r</span><span class=kt>:</span><span class=n>device</span><span class=kt>:</span><span class=n>s0</span>                <span class=n>dev</span>              <span class=n>u</span><span class=kt>:</span><span class=n>object_r</span><span class=kt>:</span><span class=n>vendor_file</span><span class=kt>:</span><span class=n>s0</span>           <span class=n>odm_dlkm</span>                <span class=n>u</span><span class=kt>:</span><span class=n>object_r</span><span class=kt>:</span><span class=n>system_file</span><span class=kt>:</span><span class=n>s0</span>           <span class=n>system</span>
</span></span><span class=line><span class=cl><span class=nf>u</span><span class=kt>:</span><span class=n>object_r</span><span class=kt>:</span><span class=n>rootfs</span><span class=kt>:</span><span class=n>s0</span>                <span class=n>bin</span>          <span class=n>u</span><span class=kt>:</span><span class=n>object_r</span><span class=kt>:</span><span class=n>rootfs</span><span class=kt>:</span><span class=n>s0</span>                <span class=n>etc</span>              <span class=n>u</span><span class=kt>:</span><span class=n>object_r</span><span class=kt>:</span><span class=n>oemfs</span><span class=kt>:</span><span class=n>s0</span>                 <span class=n>oem</span>                     <span class=o>?</span>                                  
</span></span><span class=line><span class=cl><span class=o>...</span></span></span></code></pre></td></tr></table></div></div><h2 class=heading-element id=3-selinux的配置><span><strong>3. SeLinux的配置</strong></span>
<a href=#3-selinux%e7%9a%84%e9%85%8d%e7%bd%ae class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>参见<a href=https://android.googlesource.com/platform/system/sepolicy/ title=https://android.googlesource.com/platform/system/sepolicy/ target=_blank rel="external nofollow noopener noreferrer">https://android.googlesource.com/platform/system/sepolicy/</a></p><h3 class=heading-element id=31-selinux><span><strong>3</strong>**.**<strong>1</strong> <strong>SeLinux<strong><strong>文件</strong></strong>体系</strong></span>
<a href=#31-selinux class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>之前提到Android架构中大致包含AOSP、厂商、Vendor等部分。在Android 8以上的系统中，AOSP和厂商、供应商的部分是独立配置的，方便OTA更新。</p><p>针对这种架构，SeLinux的Policy文件体系包含以下目录：</p><p><strong>system/sepolicy/public</strong>：这部分是AOSP公开给vender使用的，作为其基础api。比如声明了domain的attribute就在这下面：platform/system/sepolicy/public/attributes。这部分Policy需要做兼容处理，因为Vender引用了这里policy，如果OTA单独升级了AOSP，需要做向后兼容处理。详见<a href=https://source.android.com/docs/security/features/selinux/compatibility title=https://source.android.com/docs/security/features/selinux/compatibility target=_blank rel="external nofollow noopener noreferrer">https://source.android.com/docs/security/features/selinux/compatibility</a></p><p><strong>system/sepolicy/private</strong>：AOSP内部使用的，即system image内部用的policy。vender不应该感知到这部分policy</p><p><strong>system/sepolicy/vendor</strong>：vender部分的policy</p><p><strong>device/manufacturer/device-name/sepolicy</strong>：特定设备的policy，比如三星设备：device/samsung/tuna/sepolicy</p><h5 class=heading-element id=boardconfigmkmakefile><span><strong>BoardConfig.mk makefile</strong></span>
<a href=#boardconfigmkmakefile class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>AOSP的SeLinux Policy文件一般不需要更改，或少量更改。厂商侧主要修改和定制的Policy在/device/manufacturer/device-name/下，/device/manufacturer/device-name/BoardConfig.mk用于指定Policy文件的具体路径，通过BOARD_VENDOR_SEPOLICY_DIRS，比如：</p><p>device/samsung/tuna/BoardConfig.mk</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-haskell data-lang=haskell><span class=line><span class=cl><span class=kt>BOARD_VENDOR_SEPOLICY_DIRS</span> <span class=o>+=</span> <span class=n>device</span><span class=o>/</span><span class=n>samsung</span><span class=o>/</span><span class=n>tuna</span><span class=o>/</span><span class=n>sepolicy</span></span></span></code></pre></td></tr></table></div></div><h5 class=heading-element id=system_ext和product分区><span><strong>system_ext</strong> <strong>和</strong> <strong>product分区</strong></span>
<a href=#system_ext%e5%92%8cproduct%e5%88%86%e5%8c%ba class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>在Android 11及以上系统中，system_ext 和 product分区也独立出单独的policy，并且区分了public和private。public部分同样共vender引用。system_ext和product的版本兼容处理由各partner自己负责，AOSP不负责。</p><p>SYSTEM_EXT_PUBLIC_SEPOLICY_DIRS：指定system_ext的public的目录，安装到system_ext分区。</p><p>SYSTEM_EXT_PRIVATE_SEPOLICY_DIRS：指定system_ext的private目录。system_ext内部使用。安装到system_ext分区</p><p>PRODUCT_PUBLIC_SEPOLICY_DIRS：指定product分区的public目录。安装到product分区</p><p>PRODUCT_PRIVATE_SEPOLICY_DIRS：指定product的private目录。安装到product分区。</p><h3 class=heading-element id=32policy文件><span><strong>3</strong>**.2** <strong>Policy文件</strong></span>
<a href=#32policy%e6%96%87%e4%bb%b6 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>把SeLinux策略配置相关的文件统称为Policy文件</p><p>Policy文件一般包含：</p><h5 class=heading-element id=te文件><span><strong>TE****文件</strong></span>
<a href=#te%e6%96%87%e4%bb%b6 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>就是一堆.te文件。TE里定义了Type、访问规则等。对进程和文件Type的定义、访问规则的定制就只在TE里完成的。一般每个进程有一个独立的te文件，而所有文件的te统一声明在一个file.te文件中。详见3.3节</p><h5 class=heading-element id=contextfiles><span><strong>Context files</strong></span>
<a href=#contextfiles class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p><strong>file_contexts</strong>：前面说过，file_contexts里面定义了文件的context，用于将文件目录和文件的type关联起来。</p><p><strong>genfs_contexts</strong>：用于将文件系统（比如/proc和vfat）与type关联起来。</p><p><strong>property_contexts</strong>：用于将Android系统properties与type关联起来</p><p><strong>service_contexts</strong>：用于将service进程与type关联</p><p><strong>seapp_contexts</strong>：用于将app与type关联</p><p><strong>mac_permissions.xml</strong>：根据app的signature或包名，为app分配一个seinfo。seinfo用于在app没有明确关联一个type时归属一个默认type。</p><p><strong>keystore2_key_contexts</strong> ：为Keystore 2.0 namespaces分配一个label。</p><h5 class=heading-element id=attribute-1><span><strong>Attribute</strong></span>
<a href=#attribute-1 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>用来声明Attribute</p><h5 class=heading-element id=security_classes><span><strong>security_classes</strong></span>
<a href=#security_classes class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>用来声明Class</p><h3 class=heading-element id=33typeenforcement文件><span>**3.<strong><strong>3</strong> <strong>TE</strong></strong>（Type Enforcement）**<strong>文件</strong></span>
<a href=#33typeenforcement%e6%96%87%e4%bb%b6 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>所有的规则配置，或称Policy，都写在.te文件中。编写完TE文件后，将TE文件放在对应目录下，Android系统编译后.te文件将被编译成.cil文件。在init进程启动阶段，会将.cil文件汇总统一编译成一个命名为policy的文件。cil文件是可读的，policy文件是二进制的。在系统运行时最终加载使用的是policy文件。</p><p>policy文件一般在/sys/fs/selinux/policy</p><p>一般一个进程单独声明一个TE文件。比如一个dhcp进程单独有一个te文件叫dhcp.te。而文件的te统一整合在file.te（比如platform/system/sepolicy/public/file.te）中。</p><p>针对Platform（AOSP的部分）、Non-Platform（厂商、供应商的部分），TE会有不同的放置目录。</p><p>下面是TE文件的一个例子：</p><p>platform/system/sepolicy/public/dhcp.te</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-haskell data-lang=haskell><span class=line><span class=cl><span class=kr>type</span> <span class=n>dhcp</span><span class=p>,</span> <span class=n>domain</span><span class=p>;</span><span class=n>permissive</span> <span class=n>dhcp</span><span class=p>;</span><span class=kr>type</span> <span class=n>dhcp_exec</span><span class=p>,</span> <span class=n>exec_type</span><span class=p>,</span> <span class=n>file_type</span><span class=p>;</span><span class=kr>type</span> <span class=n>dhcp_data_file</span><span class=p>,</span> <span class=n>file_type</span><span class=p>,</span> <span class=n>data_file_type</span><span class=p>;</span><span class=n>init_daemon_domain</span><span class=p>(</span><span class=n>dhcp</span><span class=p>)</span><span class=n>net_domain</span><span class=p>(</span><span class=n>dhcp</span><span class=p>)</span><span class=n>allow</span> <span class=n>dhcp</span> <span class=n>self</span><span class=kt>:</span><span class=n>capability</span> <span class=p>{</span> <span class=n>setgid</span> <span class=n>setuid</span> <span class=n>net_admin</span> <span class=n>net_raw</span> <span class=n>net_bind_service</span><span class=p>};</span><span class=n>allow</span> <span class=n>dhcp</span> <span class=n>self</span><span class=kt>:</span><span class=n>packet_socket</span> <span class=n>create_socket_perms</span><span class=p>;</span><span class=n>allow</span> <span class=n>dhcp</span> <span class=n>self</span><span class=kt>:</span><span class=n>netlink_route_socket</span> <span class=p>{</span> <span class=n>create_socket_perms</span> <span class=n>nlmsg_write</span> <span class=p>};</span><span class=n>allow</span> <span class=n>dhcp</span> <span class=n>shell_exec</span><span class=kt>:</span><span class=n>file</span> <span class=n>rx_file_perms</span><span class=p>;</span><span class=n>allow</span> <span class=n>dhcp</span> <span class=n>system_file</span><span class=kt>:</span><span class=n>file</span> <span class=n>rx_file_perms</span><span class=p>;</span><span class=o>#</span> <span class=kt>For</span> <span class=o>/</span><span class=n>proc</span><span class=o>/</span><span class=n>sys</span><span class=o>/</span><span class=n>net</span><span class=o>/</span><span class=n>ipv4</span><span class=o>/</span><span class=n>conf</span><span class=o>/*/</span><span class=n>promote_secondariesallow</span> <span class=n>dhcp</span> <span class=n>proc_net</span><span class=kt>:</span><span class=n>file</span> <span class=n>write</span><span class=p>;</span><span class=n>allow</span> <span class=n>dhcp</span> <span class=n>system_prop</span><span class=kt>:</span><span class=n>property_service</span> <span class=n>set</span> <span class=p>;</span><span class=n>unix_socket_connect</span><span class=p>(</span><span class=n>dhcp</span><span class=p>,</span> <span class=n>property</span><span class=p>,</span> <span class=n>init</span><span class=p>)</span><span class=n>type_transition</span> <span class=n>dhcp</span> <span class=n>system_data_file</span><span class=kt>:</span><span class=p>{</span> <span class=n>dir</span> <span class=n>file</span> <span class=p>}</span> <span class=n>dhcp_data_file</span><span class=p>;</span><span class=n>allow</span> <span class=n>dhcp</span> <span class=n>dhcp_data_file</span><span class=kt>:</span><span class=n>dir</span> <span class=n>create_dir_perms</span><span class=p>;</span><span class=n>allow</span> <span class=n>dhcp</span> <span class=n>dhcp_data_file</span><span class=kt>:</span><span class=n>file</span> <span class=n>create_file_perms</span><span class=p>;</span><span class=n>allow</span> <span class=n>dhcp</span> <span class=n>netd</span><span class=kt>:</span><span class=n>fd</span> <span class=n>use</span><span class=p>;</span><span class=n>allow</span> <span class=n>dhcp</span> <span class=n>netd</span><span class=kt>:</span><span class=n>fifo_file</span> <span class=n>rw_file_perms</span><span class=p>;</span><span class=n>allow</span> <span class=n>dhcp</span> <span class=n>netd</span><span class=kt>:</span><span class=p>{</span> <span class=n>dgram_socket_class_set</span> <span class=n>unix_stream_socket</span> <span class=p>}</span> <span class=p>{</span> <span class=n>read</span> <span class=n>write</span> <span class=p>};</span><span class=n>allow</span> <span class=n>dhcp</span> <span class=n>netd</span><span class=kt>:</span><span class=p>{</span> <span class=n>netlink_kobject_uevent_socket</span> <span class=n>netlink_route_socketnetlink_nflog_socket</span> <span class=p>}</span> <span class=p>{</span> <span class=n>read</span> <span class=n>write</span> <span class=p>};</span></span></span></code></pre></td></tr></table></div></div><h4 class=heading-element id=te文件语法解析><span><strong>TE文件语法解析</strong></span>
<a href=#te%e6%96%87%e4%bb%b6%e8%af%ad%e6%b3%95%e8%a7%a3%e6%9e%90 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>type dhcp, domain; &ndash; 声明一个type名为dhcp，其继承domain这个Attribute，也就是说在声明时便继承了domain所拥有的权限。domain属性是进程专用的，很显然这是一个进程的te文件。</p><p>permissive dhcp; &ndash; 将dhcp标识为permissive模式。之前说到，SeLinux开启模式可以全局设置，也可以针对进程单独设置。这里是单独设置该进程的模式。</p><p>type dhcp_exec, exec_type, file_type; &ndash; 声明一个type名为dhcp_exec， 从属于exec_type和file_type两个Attribute。也就是说同时继承两个Attribute所代表的文件。exec_type用于代表可执行文件，也就是进程的可执行文件入口；file_type代表通用文件。从这里我们知道dhcp_exec代表dhcp可执行文件的入口。</p><p>init_daemon_domain(dhcp) &ndash; 这是一个宏，代表这是一个从init启动的进程，并且可以同init通信。宏的源码见platform/system/sepolicy/public/te_macros</p><p>net_domain &ndash; 也是一个宏，可以进行通用的网络操作，比如读写TCP包，操作socket等。</p><p>allow dhcp self:capability { setgid setuid net_admin net_raw net_bind_service}; &ndash; 这个就是具体的规则描述了。dhcp是source方， self是target方，capability是一个Class名，其后是可以做的操作。这句话是说允许dhcp这个进程对自己做setgid等操作。self关键字用来表示source可以对自己做什么操作。</p><p>除了上面例子里出现的关键字，有时我们还会看到typeattribute这个关键字：它代表将之前已经声明过的Type关联到一个之前声明过的Attribute。</p><blockquote><p>更多语法见<a href=https://selinuxproject.org/page/TypeStatements title="TypeStatements - SELinux Wiki" target=_blank rel="external nofollow noopener noreferrer">TypeStatements - SELinux Wiki</a></p></blockquote><h2 class=heading-element id=4selinux的编译><span>​​​​​​​4. <strong>SeLinux的编译</strong></span>
<a href=#4selinux%e7%9a%84%e7%bc%96%e8%af%91 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 class=heading-element id=41-编译selinux-policy><span><strong>4</strong>**.**<strong>1</strong> <strong>编译****SeLinux</strong> <strong>Policy</strong></span>
<a href=#41-%e7%bc%96%e8%af%91selinux-policy class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>Android 8以上编译过程中将把/system 和 /vendor下的policy合并。这个逻辑体现在/platform/system/sepolicy/Android.mk。</p><p>具体policy位置：</p><table><tbody><tr><td colspan=1 rowspan=1><p><span>Location</span></p></td><td colspan=1 rowspan=1><p><span>Contains</span></p></td></tr><tr><td colspan=1 rowspan=1><p><span>system/</span><span>sepolicy/</span><span>public</span></p></td><td colspan=1 rowspan=1><p><span>The&nbsp;platform's&nbsp;sepolicy&nbsp;API</span></p></td></tr><tr><td colspan=1 rowspan=1><p><span>system/</span><span>sepolicy/</span><span>private</span></p></td><td colspan=1 rowspan=1><p><span>Platform&nbsp;implementation&nbsp;details&nbsp;(vendors&nbsp;can&nbsp;ignore)</span></p></td></tr><tr><td colspan=1 rowspan=1><p><span>system/</span><span>sepolicy/</span><span>vendor</span></p></td><td colspan=1 rowspan=1><p><span>Policy&nbsp;and&nbsp;context&nbsp;files&nbsp;that&nbsp;vendors&nbsp;can&nbsp;use&nbsp;(vendors&nbsp;can&nbsp;ignore&nbsp;if&nbsp;desired)</span></p></td></tr><tr><td colspan=1 rowspan=1><p><span>BOARD_</span><span>SEPOLICY_</span><span>DIRS</span></p></td><td colspan=1 rowspan=1><p><span>Vendor&nbsp;sepolicy</span></p></td></tr><tr><td colspan=1 rowspan=1><p><span>BOARD_</span><span>ODM_</span><span>SEPOLICY_</span><span>DIRS</span> <span>(Android&nbsp;9&nbsp;and&nbsp;higher)</span></p></td><td colspan=1 rowspan=1><p><span>Odm&nbsp;sepolicy</span></p></td></tr><tr><td colspan=1 rowspan=1><p><span>SYSTEM_</span><span>EXT_</span><span>PUBLIC_</span><span>SEPOLICY_</span><span>DIRS</span> <span>(Android&nbsp;11&nbsp;and&nbsp;higher)</span></p></td><td colspan=1 rowspan=1><p><span>System_ext's&nbsp;sepolicy&nbsp;API</span></p></td></tr><tr><td colspan=1 rowspan=1><p><span>SYSTEM_</span><span>EXT_</span><span>PRIVATE_</span><span>SEPOLICY_</span><span>DIRS</span> <span>(Android&nbsp;11&nbsp;and&nbsp;higher)</span></p></td><td colspan=1 rowspan=1><p><span>System_ext&nbsp;implementation&nbsp;details&nbsp;(vendors&nbsp;can&nbsp;ignore)</span></p></td></tr><tr><td colspan=1 rowspan=1><p><span>PRODUCT_</span><span>PUBLIC_</span><span>SEPOLICY_</span><span>DIRS</span> <span>(Android&nbsp;11&nbsp;and&nbsp;higher)</span></p></td><td colspan=1 rowspan=1><p><span>Product's&nbsp;sepolicy&nbsp;API</span></p></td></tr><tr><td colspan=1 rowspan=1><p><span>PRODUCT_</span><span>PRIVATE_</span><span>SEPOLICY_</span><span>DIRS</span> <span>(Android&nbsp;11&nbsp;and&nbsp;higher)</span></p></td><td colspan=1 rowspan=1><p><span>Product&nbsp;implementation&nbsp;details&nbsp;(vendors&nbsp;can&nbsp;ignore)</span></p></td></tr></tbody></table><p>编译过程：</p><ol><li>将Policy转化成CIL（ Common Intermediate Language ）文件，包括</li><li>system + system_ext + product的public部分的policy</li><li>合并private + public policy</li><li>合并public + vendor and BOARD_SEPOLICY_DIRS policy</li><li>将public部分的policy进行整理成对应版本policy，作为vendor policy的一部分。然后将public的policy传给合并后的public + vendor and BOARD_SEPOLICY_DIRS policy，告知其哪部分可以连接到platform的attribute</li><li>创建一个mapping文件，连接platform和vendor的部分。</li><li>合并所有的policy文件，整合mapping、platform和vender的policy，最终输出一个二进制的名为policy的文件。一般这个文件的位置在/sys/fs/sepolicy/policy。这个policy最终会被kernel加载。这个工作是在init进程初始化时进行的。也就是说是在运行时进行的。</li></ol><h3 class=heading-element id=42预编译><span><strong>4.2 预编译</strong></span>
<a href=#42%e9%a2%84%e7%bc%96%e8%af%91 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>在SeLinux正式开启之前，init进程会收集所有的cil文件，将其编译成policy，这个过程需要花费1-2秒时间。为了更快完成此过程，会将CIL在编一阶段预编译，放在/vendor/etc/selinux/precompiled_sepolicy和/odm/etc/selinux/precompiled_sepolicy下，并且附有sha256 摘要。运行时会检查sha256是否有变化，如果没有变化就直接使用预编译的文件。</p><h2 class=heading-element id=5-实践><span><strong>5. 实践</strong></span>
<a href=#5-%e5%ae%9e%e8%b7%b5 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 class=heading-element id=51-开启><span><strong>5</strong>**.**<strong>1</strong> <strong>开启<strong><strong>Se</strong></strong>L<strong><strong>i</strong></strong>n<strong><strong>u</strong></strong>x</strong></span>
<a href=#51-%e5%bc%80%e5%90%af class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>编译kernel时，指定CONFIG_SECURITY_SELINUX=y。</p><p>比如在kernel/arm64/arch/arm64/configs/defconfig中添加此配置。</p><p>在kernel/arm64/include/linux/selinux.h会对该配置进行判断：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=cp>#ifdef CONFIG_SECURITY_SELINUXbool selinux_is_enabled(void);#elsestatic inline bool selinux_is_enabled(void){return false;}#endif	#endif </span></span></span></code></pre></td></tr></table></div></div><h3 class=heading-element id=52设定selinux模式><span>**5.**<strong>2</strong> <strong>设定SeLinux模式</strong></span>
<a href=#52%e8%ae%be%e5%ae%9aselinux%e6%a8%a1%e5%bc%8f class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>在厂商目录的BoardConfig.mk中（比如/device/google/trout/trout_arm64/BoardConfig.mk）添加如下配置，可改变SeLinux模式</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cobol data-lang=cobol><span class=line><span class=cl><span class=c>BOARD_</span><span class=nv>KERNEL_CMDLINE</span><span class=err> </span><span class=p>:</span><span class=o>=</span><span class=err> </span><span class=nv>androidboot</span><span class=p>.</span><span class=nv>selinux</span><span class=o>=</span><span class=nv>permissive</span></span></span></code></pre></td></tr></table></div></div><p>或</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cobol data-lang=cobol><span class=line><span class=cl><span class=c>BOARD_</span><span class=nv>BOOTCONFIG</span><span class=err> </span><span class=p>:</span><span class=o>=</span><span class=err> </span><span class=nv>androidboot</span><span class=p>.</span><span class=nv>selinux</span><span class=o>=</span><span class=nv>permissive</span></span></span></code></pre></td></tr></table></div></div><p>上面两个配置只用于开发阶段。正式版本需要移除，否则无法通过CTS。即正式版本上，SeLinux是强制enforcing模式。</p><p><strong>非正式的修改方法：</strong></p><p>ALLOW_PERMISSIVE_SELINUX宏定义了是否启用permissivve模式。</p><p>在core/init/Android.bp中有对该宏设置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cobol data-lang=cobol><span class=line><span class=cl><span class=c>init_f</span><span class=nv>irst_stage_cc_defaults</span> <span class=err>{
</span></span></span><span class=line><span class=cl><span class=err></span>	<span class=p>...</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>	cflag</span><span class=nv>s</span><span class=p>:</span> <span class=err>[
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>      </span>  <span class=s2>&#34;-Wall&#34;</span><span class=p>,</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>      </span>  <span class=s2>&#34;-Wextra&#34;</span><span class=p>,</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>      </span>  <span class=s2>&#34;-Wno-unused-parameter&#34;</span><span class=p>,</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>      </span>  <span class=s2>&#34;-Werror&#34;</span><span class=p>,</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>      </span>  <span class=s2>&#34;-DALLOW_FIRST_STAGE_CONSOLE=0&#34;</span><span class=p>,</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>      </span>  <span class=s2>&#34;-DALLOW_LOCAL_PROP_OVERRIDE=0&#34;</span><span class=p>,</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>      </span>  <span class=s2>&#34;-DALLOW_PERMISSIVE_SELINUX=0&#34;</span><span class=p>,</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>      </span>  <span class=s2>&#34;-DREBOOT_BOOTLOADER_ON_PANIC=0&#34;</span><span class=p>,</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>      </span>  <span class=s2>&#34;-DWORLD_WRITABLE_KMSG=0&#34;</span><span class=p>,</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>      </span>  <span class=s2>&#34;-DDUMP_ON_UMOUNT_FAILURE=0&#34;</span><span class=p>,</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>      </span>  <span class=s2>&#34;-DSHUTDOWN_ZERO_TIMEOUT=0&#34;</span><span class=p>,</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>      </span>  <span class=s2>&#34;-DLOG_UEVENTS=0&#34;</span><span class=p>,</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c>      </span>  <span class=s2>&#34;-DSEPOLICY_VERSION=30&#34;</span><span class=p>,</span> <span class=o>//</span> <span class=nv>TODO</span><span class=p>(</span><span class=nv>jiyong</span><span class=p>):</span> <span class=nv>externalize</span> <span class=nv>the</span> <span class=nv>version</span> <span class=kp>number
</span></span></span><span class=line><span class=cl><span class=kp>    </span><span class=err>]</span><span class=p>,</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>}</span></span></span></code></pre></td></tr></table></div></div><p>实际的生效位置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=n>core</span><span class=p>/</span><span class=k>init</span><span class=p>/</span><span class=n>selinux</span><span class=p>.</span><span class=n>cppbool</span> <span class=n>IsEnforcing</span><span class=p>()</span> <span class=p>{</span><span class=k>if</span> <span class=p>(</span><span class=n>ALLOW_PERMISSIVE_SELINUX</span><span class=p>)</span> <span class=p>{</span><span class=k>return</span> <span class=n>StatusFromProperty</span><span class=p>()</span> <span class=p>==</span> <span class=n>SELINUX_ENFORCING</span><span class=p>;</span>    <span class=p>}</span><span class=k>return</span> <span class=kc>true</span><span class=p>;}</span></span></span></code></pre></td></tr></table></div></div><h3 class=heading-element id=53-处理><span><strong>5</strong>**.**<strong>3</strong> <strong>处理<strong><strong>异常</strong></strong>LOG</strong></span>
<a href=#53-%e5%a4%84%e7%90%86 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>厂商或供应上在添加了一些进程、访问行为、策略等之后，需要确认是否符合SeLinux规则。</p><p>如果有任何访问限制出现，则会打印log：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cobol data-lang=cobol><span class=line><span class=cl><span class=c>02-05 </span><span class=mi>15</span><span class=p>:</span><span class=mi>06</span><span class=p>:</span><span class=mi>30</span><span class=p>.</span><span class=mi>448   450   450 </span><span class=nf>E</span><span class=err> </span><span class=nv>SELinux</span><span class=err> </span><span class=p>:</span><span class=err> </span><span class=nv>avc</span><span class=p>:</span><span class=err>  </span><span class=nv>denied</span><span class=err>  { </span><span class=nv>find</span><span class=err> }</span> <span class=kp>for</span><span class=err> </span><span class=nv>pid</span><span class=o>=</span><span class=mi>3059 </span><span class=nv>uid</span><span class=o>=</span><span class=mi>10074 </span><span class=nv>name</span><span class=o>=</span><span class=nv>media</span><span class=p>.</span><span class=nv>metrics</span><span class=err> </span><span class=nv>scontext</span><span class=o>=</span><span class=nv>u</span><span class=p>:</span><span class=nv>r</span><span class=p>:</span><span class=nv>testapp</span><span class=p>:</span><span class=nv>s0</span><span class=p>:</span><span class=nv>c512</span><span class=p>,</span><span class=nv>c768</span><span class=err> </span><span class=nv>tcontext</span><span class=o>=</span><span class=nv>u</span><span class=p>:</span><span class=nv>object_r</span><span class=p>:</span><span class=nv>mediametrics_service</span><span class=p>:</span><span class=nv>s0</span><span class=err> </span><span class=nv>tclass</span><span class=o>=</span><span class=nv>service_manager</span><span class=err> </span><span class=nv>permissive</span><span class=o>=</span><span class=mi>0</span></span></span></code></pre></td></tr></table></div></div><p>精简下log，只需avc:后面的即可</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cobol data-lang=cobol><span class=line><span class=cl><span class=c>avc:  </span><span class=nv>denied</span><span class=err>  { </span><span class=nv>find</span><span class=err> }</span> <span class=kp>for</span><span class=err> </span><span class=nv>pid</span><span class=o>=</span><span class=mi>3059 </span><span class=nv>uid</span><span class=o>=</span><span class=mi>10074 </span><span class=nv>name</span><span class=o>=</span><span class=nv>media</span><span class=p>.</span><span class=nv>metrics</span><span class=err> </span><span class=nv>scontext</span><span class=o>=</span><span class=nv>u</span><span class=p>:</span><span class=nv>r</span><span class=p>:</span><span class=nv>testapp</span><span class=p>:</span><span class=nv>s0</span><span class=p>:</span><span class=nv>c512</span><span class=p>,</span><span class=nv>c768</span><span class=err> </span><span class=nv>tcontext</span><span class=o>=</span><span class=nv>u</span><span class=p>:</span><span class=nv>object_r</span><span class=p>:</span><span class=nv>mediametrics_service</span><span class=p>:</span><span class=nv>s0</span><span class=err> </span><span class=nv>tclass</span><span class=o>=</span><span class=nv>service_manager</span><span class=err> </span><span class=nv>permissive</span><span class=o>=</span><span class=mi>0</span></span></span></code></pre></td></tr></table></div></div><p>各字段含义：</p><p>{ find }：被组织的行为。</p><p>scontext（可以理解为source context的缩写）：该行为的执行者的context；</p><p>tcontext（可以理解为target context的缩写：）被访问者的context；</p><p>tclass：被访问者的class，详见本文之前的解释。</p><h4 class=heading-element id=使用auditallow><span> <strong>使用auditallow<strong><strong>生成</strong></strong>TE</strong></span>
<a href=#%e4%bd%bf%e7%94%a8auditallow class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>ubuntu中，通过apt-get audit2allow安装audit2allow。</p><p>获取policy文件：</p><p>/sys/fs/selinux/policy</p><p>将上面的avc log保存在test.avc文件中，然后执行：</p><p>audit2allow -i test.avc -p policy > hynex.te</p><p>即生成TE文件。再将TE加入到SeLinux编译目录sepolicy即可修复异常log。</p></div><div class=collection-card><div class="collection-title text-secondary">收录于 <a href=/collections/%E5%9B%BE%E5%BD%A2%E6%98%BE%E7%A4%BA/><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i> <span>合集・图形显示</span></span></a> 43</div><div class=collection-nav><a href=/posts/%E6%B1%87%E6%80%BBbinder%E7%9B%B8%E5%85%B3%E4%B8%80%E4%BA%9B%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98-%E5%AE%89%E5%8D%93%E7%B3%BB%E7%BB%9F%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/ class=collection-nav-item rel=prev title=汇总binder相关一些常见面试题-安卓系统常见面试题-CSDN博客><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i><span>汇总binder相关一些常见面试题-安卓系统常见面试题-CSDN博客</span>
</a><a href=/posts/android%E5%85%89%E6%84%9F%E8%87%AA%E5%8A%A8%E8%B0%83%E8%8A%82%E4%BA%AE%E5%BA%A6_%E9%AB%98%E9%80%9A-%E5%85%89%E6%84%9F%E8%87%AA%E5%8A%A8%E8%B0%83%E8%8A%82%E9%85%8D%E7%BD%AE-xml-csdn%E5%8D%9A%E5%AE%A2/ class=collection-nav-item rel=next title="Android：光感自动调节亮度_高通 光感自动调节配置 Xml-CSDN博客"><span>Android：光感自动调节亮度_高通 光感自动调节配置 Xml-CSDN博客</span><i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2024-11-05 01:34:01">更新于 2024-11-05&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://huang8604.github.io/posts/android-%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E7%90%86%E8%A7%A3selinux-csdn%E5%8D%9A%E5%AE%A2/ data-title="Android - 深入浅出理解SeLinux-CSDN博客"><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/clippings/ class=post-tag title="标签 - Clippings">Clippings</a><a href=/tags/%E8%BD%AC%E8%BD%BD/ class=post-tag title="标签 - 转载">转载</a><a href=/tags/blog/ class=post-tag title="标签 - Blog">Blog</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/android-%E8%AE%B0%E5%BD%95%E7%B3%BB%E7%BB%9F%E7%A9%BA%E9%97%B4%E7%9A%84%E9%AB%98%E9%80%9A%E7%AD%94%E7%96%91/ class=post-nav-item rel=prev title="Android 记录系统空间的高通答疑"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>Android 记录系统空间的高通答疑</a><a href=/posts/adsp-wristdown-%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%AE%9E%E7%8E%B0/ class=post-nav-item rel=next title="Adsp Wristdown 流程与实现">Adsp Wristdown 流程与实现<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div class=post-reward><div class=comment></div><input type=checkbox class=reward-input name=reward id=fi-reward hidden>
<label class=reward-button for=fi-reward><i class="fa-solid fa-qrcode fa-fw" aria-hidden=true></i>赞赏</label><div class=reward-ways data-mode=static></div></div><div id=comments><div id=giscus class=comment><script src=https://giscus.app/client.js data-repo=huang8604/huang8604.github.io data-repo-id=R_kgDOMx3bEg data-category=Announcements data-category-id=DIC_kwDOMx3bEs4CigIp data-mapping=pathname data-strict=0 data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-loading=lazy crossorigin=anonymous async defer></script></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></article><aside class=toc id=toc-auto aria-label=目录><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside></main><footer class=footer><div class=footer-container><div class="footer-line powered">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.152.2"><img class=hugo-icon src=/images/hugo.min.svg alt="Hugo logo"> Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.3.20"><img class=fixit-icon src=/images/fixit.min.svg alt="FixIt logo"> FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2021 - 2025</span><span class=author itemprop=copyrightHolder>
<a href=https://github.com/huang8604 target=_blank rel="external nofollow noopener noreferrer">wentao</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class="variant-numeric d-none">0%</span></div><div class="fixed-button view-comments d-none" role=button aria-label=查看评论><i class="fa-solid fa-comment fa-fw" aria-hidden=true></i></div></div><div id=mask></div><noscript><div class=noscript-warning>该网站在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=preload href=/lib/katex/katex.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/katex/katex.min.css></noscript><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/fuse/fuse.min.js defer></script><script src=/lib/instant-page/instantpage.min.js async defer type=module></script><script src=/lib/lightgallery/lightgallery.min.js defer></script><script src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js defer></script><script src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:199},comment:{enable:!0,expired:!1,giscus:{darkTheme:"dark",lightTheme:"light",origin:"https://giscus.app"}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/search.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:50,threshold:.3,type:"fuse",useExtendedSearch:!1},version:"v0.3.20"}</script><script src=/js/theme.min.js defer></script><script src=/js/custom.min.js defer></script></body></html>