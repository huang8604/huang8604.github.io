<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>Android13 SurfaceFlinger Composite(合成)流程分析-CSDN博客 - 文韬的文档</title><meta name=author content="wentao"><meta name=description content="SurfaceFlinger的composite方法，用于将多个窗口的图像进行合成，主要负责对相关要进行上帧的layer进行，识别排序好，然后合成，有hwc合成的会构建对应OutputLayer传递hwc，GPU合成则直接合成，再传递到hwc中，它主要完成以下几个步骤：
"><meta name=keywords content='clippings,转载,blog'><meta itemprop=name content="Android13 SurfaceFlinger composite(合成)流程分析-CSDN博客"><meta itemprop=description content="SurfaceFlinger的composite方法，用于将多个窗口的图像进行合成，主要负责对相关要进行上帧的layer进行，识别排序好，然后合成，有hwc合成的会构建对应OutputLayer传递hwc，GPU合成则直接合成，再传递到hwc中，它主要完成以下几个步骤："><meta itemprop=datePublished content="2024-11-06T06:57:52+00:00"><meta itemprop=dateModified content="2024-11-05T01:33:58+00:00"><meta itemprop=wordCount content="9639"><meta itemprop=keywords content="Clippings,转载,Blog"><meta property="og:url" content="https://huang8604.github.io/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/"><meta property="og:site_name" content="文韬的文档"><meta property="og:title" content="Android13 SurfaceFlinger composite(合成)流程分析-CSDN博客"><meta property="og:description" content="SurfaceFlinger的composite方法，用于将多个窗口的图像进行合成，主要负责对相关要进行上帧的layer进行，识别排序好，然后合成，有hwc合成的会构建对应OutputLayer传递hwc，GPU合成则直接合成，再传递到hwc中，它主要完成以下几个步骤："><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-06T06:57:52+00:00"><meta property="article:modified_time" content="2024-11-05T01:33:58+00:00"><meta property="article:tag" content="Clippings"><meta property="article:tag" content="转载"><meta property="article:tag" content="Blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="Android13 SurfaceFlinger composite(合成)流程分析-CSDN博客"><meta name=twitter:description content="SurfaceFlinger的composite方法，用于将多个窗口的图像进行合成，主要负责对相关要进行上帧的layer进行，识别排序好，然后合成，有hwc合成的会构建对应OutputLayer传递hwc，GPU合成则直接合成，再传递到hwc中，它主要完成以下几个步骤："><meta name=application-name content="文涛的记录"><meta name=apple-mobile-web-app-title content="文涛的记录"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical type=text/html href=https://huang8604.github.io/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/ title="Android13 SurfaceFlinger composite(合成)流程分析-CSDN博客 - 文韬的文档"><link rel=prev type=text/html href=https://huang8604.github.io/posts/android13-surfaceflinger-oncomposerhalhotplug%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/ title="Android13 SurfaceFlinger onComposerHalHotplug流程分析-CSDN博客"><link rel=next type=text/html href=https://huang8604.github.io/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/ title="Android13 SurfaceFlinger commit(提交)流程分析_surfaceflinger::commit-CSDN博客"><link rel=alternate type=text/markdown href=https://huang8604.github.io/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/index.md title="Android13 SurfaceFlinger composite(合成)流程分析-CSDN博客 - 文韬的文档"><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Android13 SurfaceFlinger composite(合成)流程分析-CSDN博客","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/huang8604.github.io\/posts\/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2\/"},"genre":"posts","keywords":"clippings, 转载, blog","wordcount":9639,"url":"https:\/\/huang8604.github.io\/posts\/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2\/","datePublished":"2024-11-06T06:57:52+00:00","dateModified":"2024-11-05T01:33:58+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"wentao"},"description":""}</script><script src=/js/head/color-scheme.min.js></script></head><body data-header-desktop=sticky data-header-mobile=auto><div class=wrapper data-page-style=wide><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=文韬的文档><img class=logo src=/images/doc.jpg alt=文韬的文档 height=32 width=32><span class=header-title-text>文韬的文档</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/archives/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 归档</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/collections/><i class="fa-solid fa-group fa-fw fa-sm" aria-hidden=true></i> 合集</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容…… id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=文韬的文档><img class=logo src=/images/doc.jpg alt=文韬的文档 height=26 width=26><span class=header-title-text>文韬的文档</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容…… id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/archives/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 归档</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/collections/><i class="fa-solid fa-group fa-fw fa-sm" aria-hidden=true></i> 合集</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label=合集></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>Android13 SurfaceFlinger Composite(合成)流程分析-CSDN博客</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/huang8604 title=作者 target=_blank rel="external nofollow noopener noreferrer author" class=author><img class=avatar src='https://www.gravatar.com/avatar/b89538cdbc35c279ce1df9f3435f42a1?s=32&d=' alt=wentao height=16 width=16>&nbsp;wentao</a></span><span class=post-included-in>&nbsp;收录于 <a href=/collections/%E5%9B%BE%E5%BD%A2%E6%98%BE%E7%A4%BA/ class=post-collection title="合集 - 图形显示"><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i> 图形显示</a></span></div><div class=post-meta-line><span title="发布于 2024-11-06 06:57:52"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden=true></i><time datetime=2024-11-06>2024-11-06</time></span>&nbsp;<span title="更新于 2024-11-05 01:33:58"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden=true></i><time datetime=2024-11-05>2024-11-05</time></span>&nbsp;<span title="9639 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 9700 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 20 分钟</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#compositionengine-precomposition>CompositionEngine preComposition</a><ul><li><a href=#bufferlayer-onprecomposition>BufferLayer onPreComposition</a></li></ul></li><li><a href=#output-prepare>Output prepare</a><ul><li><a href=#output-rebuildlayerstacks>Output rebuildLayerStacks</a></li></ul></li><li><a href=#output-present>Output present</a><ul><li><a href=#output-updatecolorprofile>Output updateColorProfile</a><ul><li><a href=#rendersurface-setbufferdataspace>RenderSurface setBufferDataspace</a></li></ul></li><li><a href=#output-updatecompositionstate>Output updateCompositionState</a><ul><li><a href=#outputlayer-updatecompositionstate>OutputLayer updateCompositionState</a></li></ul></li><li><a href=#output-plancomposition>Output planComposition</a><ul><li><a href=#planner-plan>Planner plan</a></li></ul></li><li><a href=#output-writecompositionstate>Output writeCompositionState</a></li><li><a href=#output-setcolortransform>Output setColorTransform</a></li><li><a href=#output-beginframe>Output beginFrame</a><ul><li><a href=#rendersurface-beginframe>RenderSurface beginFrame</a><ul><li><a href=#virtualdisplaysurface-beginframe>VirtualDisplaySurface beginFrame</a><ul><li><a href=#hwcomposer-setoutputbuffer>HWComposer setOutputBuffer</a></li><li><a href=#hwc2display-setoutputbuffer>HWC2::Display setOutputBuffer</a></li></ul></li></ul></li></ul></li><li><a href=#output-prepareframeasync>Output prepareFrameAsync</a></li><li><a href=#output-prepareframe>Output prepareFrame</a><ul><li><a href=#output-choosecompositionstrategy>Output chooseCompositionStrategy</a><ul><li><a href=#hwcomposer-getdevicecompositionchanges>HWComposer getDeviceCompositionChanges</a></li></ul></li></ul></li><li><a href=#output-devoptrepaintflash>Output devOptRepaintFlash</a><ul><li><a href=#rendersurface-queuebuffer>RenderSurface queueBuffer</a><ul><li><a href=#framebuffersurface-advanceframe>FramebufferSurface advanceFrame</a><ul><li><a href=#hwcomposer-setclienttarget>HWComposer setClientTarget</a></li><li><a href=#hwc2display-setoutputbuffer-1>HWC2::Display setOutputBuffer</a></li></ul></li></ul></li></ul></li><li><a href=#output-finishframe>Output finishFrame</a></li><li><a href=#output-postframebuffer>Output postFramebuffer</a><ul><li><a href=#output-presentandgetframefences>Output presentAndGetFrameFences</a><ul><li><a href=#framebuffersurface-getclienttargetacquirefence>FramebufferSurface getClientTargetAcquireFence</a></li></ul></li><li><a href=#bufferqueuelayer-onlayerdisplayed>BufferQueueLayer onLayerDisplayed</a></li></ul></li><li><a href=#output-rendercachedsets>Output renderCachedSets</a></li><li><a href=#output-dirtyentireoutput>Output dirtyEntireOutput</a><ul><li><a href=#region-set>Region set</a></li></ul></li><li><a href=#output-finishprepareframe>Output finishPrepareFrame</a><ul><li><a href=#planner-reportfinalplan>Planner reportFinalPlan</a></li><li><a href=#rendersurface-prepareframe>RenderSurface prepareFrame</a><ul><li><a href=#virtualdisplaysurface-prepareframe>VirtualDisplaySurface prepareFrame</a><ul><li><a href=#hwcomposer-setoutputbuffer-1>HWComposer setOutputBuffer</a></li><li><a href=#hwc2display-setoutputbuffer-2>HWC2::Display setOutputBuffer</a></li></ul></li></ul></li></ul></li></ul></li></ul></nav></div></div><div class=content id=content><p>SurfaceFlinger的composite方法，用于将多个窗口的图像进行合成，主要负责对相关要进行上帧的layer进行，识别排序好，然后合成，有hwc合成的会构建对应OutputLayer传递hwc，GPU合成则直接合成，再传递到hwc中，它主要完成以下几个步骤：</p><ol><li>从队列中获取所有待合成的缓冲区。</li><li>将这些缓冲区按照一定的顺序进行合成，生成最终的图像。</li><li>将合成后的图像提交给HWC进行显示。</li></ol><p>SurfaceFlinger的composite方法代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/Surfaceflinger.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>compositionengine</span><span class=o>::</span><span class=n>CompositionEngine</span><span class=o>&gt;</span> <span class=n>mCompositionEngine</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>SurfaceFlinger</span><span class=o>::</span><span class=n>composite</span><span class=p>(</span><span class=n>nsecs_t</span> <span class=n>frameTime</span><span class=p>,</span> <span class=kt>int64_t</span> <span class=n>vsyncId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>FTL_FAKE_GUARD</span><span class=p>(</span><span class=n>kMainThreadContext</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ATRACE_FORMAT</span><span class=p>(</span><span class=s>&#34;%s %&#34;</span> <span class=n>PRId64</span><span class=p>,</span> <span class=n>__func__</span><span class=p>,</span> <span class=n>vsyncId</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>mPowerHintSessionData</span><span class=p>.</span><span class=n>sessionEnabled</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mPowerHintSessionData</span><span class=p>.</span><span class=n>compositeStart</span> <span class=o>=</span> <span class=n>systemTime</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>compositionengine</span><span class=o>::</span><span class=n>CompositionRefreshArgs</span> <span class=n>refreshArgs</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=n>displays</span> <span class=o>=</span> <span class=n>FTL_FAKE_GUARD</span><span class=p>(</span><span class=n>mStateLock</span><span class=p>,</span> <span class=n>mDisplays</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>refreshArgs</span><span class=p>.</span><span class=n>outputs</span><span class=p>.</span><span class=n>reserve</span><span class=p>(</span><span class=n>displays</span><span class=p>.</span><span class=n>size</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=k>const</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=p>[</span><span class=n>_</span><span class=p>,</span> <span class=n>display</span><span class=p>]</span> <span class=o>:</span> <span class=n>displays</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>refreshArgs</span><span class=p>.</span><span class=n>outputs</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>display</span><span class=o>-&gt;</span><span class=n>getCompositionDisplay</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>mDrawingState</span><span class=p>.</span><span class=n>traverseInZOrder</span><span class=p>([</span><span class=o>&amp;</span><span class=n>refreshArgs</span><span class=p>](</span><span class=n>Layer</span><span class=o>*</span> <span class=n>layer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>auto</span> <span class=n>layerFE</span> <span class=o>=</span> <span class=n>layer</span><span class=o>-&gt;</span><span class=n>getCompositionEngineLayerFE</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=n>refreshArgs</span><span class=p>.</span><span class=n>layers</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>layerFE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=n>refreshArgs</span><span class=p>.</span><span class=n>layersWithQueuedFrames</span><span class=p>.</span><span class=n>reserve</span><span class=p>(</span><span class=n>mLayersWithQueuedFrames</span><span class=p>.</span><span class=n>size</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=k>auto</span> <span class=nl>layer</span> <span class=p>:</span> <span class=n>mLayersWithQueuedFrames</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>auto</span> <span class=n>layerFE</span> <span class=o>=</span> <span class=n>layer</span><span class=o>-&gt;</span><span class=n>getCompositionEngineLayerFE</span><span class=p>())</span>
</span></span><span class=line><span class=cl>            <span class=n>refreshArgs</span><span class=p>.</span><span class=n>layersWithQueuedFrames</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>layerFE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>refreshArgs</span><span class=p>.</span><span class=n>outputColorSetting</span> <span class=o>=</span> <span class=n>useColorManagement</span>
</span></span><span class=line><span class=cl>            <span class=o>?</span> <span class=nl>mDisplayColorSetting</span>
</span></span><span class=line><span class=cl>            <span class=p>:</span> <span class=n>compositionengine</span><span class=o>::</span><span class=n>OutputColorSetting</span><span class=o>::</span><span class=n>kUnmanaged</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>refreshArgs</span><span class=p>.</span><span class=n>colorSpaceAgnosticDataspace</span> <span class=o>=</span> <span class=n>mColorSpaceAgnosticDataspace</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>refreshArgs</span><span class=p>.</span><span class=n>forceOutputColorMode</span> <span class=o>=</span> <span class=n>mForceColorMode</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>refreshArgs</span><span class=p>.</span><span class=n>updatingOutputGeometryThisFrame</span> <span class=o>=</span> <span class=n>mVisibleRegionsDirty</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>refreshArgs</span><span class=p>.</span><span class=n>updatingGeometryThisFrame</span> <span class=o>=</span> <span class=n>mGeometryDirty</span><span class=p>.</span><span class=n>exchange</span><span class=p>(</span><span class=nb>false</span><span class=p>)</span> <span class=o>||</span> <span class=n>mVisibleRegionsDirty</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>refreshArgs</span><span class=p>.</span><span class=n>blursAreExpensive</span> <span class=o>=</span> <span class=n>mBlursAreExpensive</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>refreshArgs</span><span class=p>.</span><span class=n>internalDisplayRotationFlags</span> <span class=o>=</span> <span class=n>DisplayDevice</span><span class=o>::</span><span class=n>getPrimaryDisplayRotationFlags</span><span class=p>();</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>CC_UNLIKELY</span><span class=p>(</span><span class=n>mDrawingState</span><span class=p>.</span><span class=n>colorMatrixChanged</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>refreshArgs</span><span class=p>.</span><span class=n>colorTransformMatrix</span> <span class=o>=</span> <span class=n>mDrawingState</span><span class=p>.</span><span class=n>colorMatrix</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>mDrawingState</span><span class=p>.</span><span class=n>colorMatrixChanged</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>refreshArgs</span><span class=p>.</span><span class=n>devOptForceClientComposition</span> <span class=o>=</span> <span class=n>mDebugDisableHWC</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>mDebugFlashDelay</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>refreshArgs</span><span class=p>.</span><span class=n>devOptForceClientComposition</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>refreshArgs</span><span class=p>.</span><span class=n>devOptFlashDirtyRegionsDelay</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>milliseconds</span><span class=p>(</span><span class=n>mDebugFlashDelay</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=k>auto</span> <span class=n>expectedPresentTime</span> <span class=o>=</span> <span class=n>mExpectedPresentTime</span><span class=p>.</span><span class=n>load</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=k>auto</span> <span class=n>prevVsyncTime</span> <span class=o>=</span> <span class=n>mScheduler</span><span class=o>-&gt;</span><span class=n>getPreviousVsyncFrom</span><span class=p>(</span><span class=n>expectedPresentTime</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=k>auto</span> <span class=n>hwcMinWorkDuration</span> <span class=o>=</span> <span class=n>mVsyncConfiguration</span><span class=o>-&gt;</span><span class=n>getCurrentConfigs</span><span class=p>().</span><span class=n>hwcMinWorkDuration</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>refreshArgs</span><span class=p>.</span><span class=n>earliestPresentTime</span> <span class=o>=</span> <span class=n>prevVsyncTime</span> <span class=o>-</span> <span class=n>hwcMinWorkDuration</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>refreshArgs</span><span class=p>.</span><span class=n>previousPresentFence</span> <span class=o>=</span> <span class=n>mPreviousPresentFences</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=n>fenceTime</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>refreshArgs</span><span class=p>.</span><span class=n>scheduledFrameTime</span> <span class=o>=</span> <span class=n>mScheduler</span><span class=o>-&gt;</span><span class=n>getScheduledFrameTime</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>refreshArgs</span><span class=p>.</span><span class=n>expectedPresentTime</span> <span class=o>=</span> <span class=n>expectedPresentTime</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=c1>// Store the present time just before calling to the composition engine so we could notify
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// the scheduler.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>const</span> <span class=k>auto</span> <span class=n>presentTime</span> <span class=o>=</span> <span class=n>systemTime</span><span class=p>();</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>mCompositionEngine</span><span class=o>-&gt;</span><span class=n>present</span><span class=p>(</span><span class=n>refreshArgs</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>mPowerHintSessionData</span><span class=p>.</span><span class=n>sessionEnabled</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mPowerHintSessionData</span><span class=p>.</span><span class=n>presentEnd</span> <span class=o>=</span> <span class=n>systemTime</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>mTimeStats</span><span class=o>-&gt;</span><span class=n>recordFrameDuration</span><span class=p>(</span><span class=n>frameTime</span><span class=p>,</span> <span class=n>systemTime</span><span class=p>());</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>mScheduler</span><span class=o>-&gt;</span><span class=n>onPostComposition</span><span class=p>(</span><span class=n>presentTime</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>scheduleComposite</span><span class=p>(</span><span class=n>FrameHint</span><span class=o>::</span><span class=n>kNone</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>postFrame</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>postComposition</span><span class=p>();</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=kt>bool</span> <span class=n>prevFrameHadClientComposition</span> <span class=o>=</span> <span class=n>mHadClientComposition</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>mHadClientComposition</span> <span class=o>=</span> <span class=n>mHadDeviceComposition</span> <span class=o>=</span> <span class=n>mReusedClientComposition</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>TimeStats</span><span class=o>::</span><span class=n>ClientCompositionRecord</span> <span class=n>clientCompositionRecord</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=k>const</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=p>[</span><span class=n>_</span><span class=p>,</span> <span class=n>display</span><span class=p>]</span> <span class=o>:</span> <span class=n>displays</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=n>state</span> <span class=o>=</span> <span class=n>display</span><span class=o>-&gt;</span><span class=n>getCompositionDisplay</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>getState</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>mHadClientComposition</span> <span class=o>|=</span> <span class=n>state</span><span class=p>.</span><span class=n>usesClientComposition</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>state</span><span class=p>.</span><span class=n>reusedClientComposition</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>mHadDeviceComposition</span> <span class=o>|=</span> <span class=n>state</span><span class=p>.</span><span class=n>usesDeviceComposition</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>mReusedClientComposition</span> <span class=o>|=</span> <span class=n>state</span><span class=p>.</span><span class=n>reusedClientComposition</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>clientCompositionRecord</span><span class=p>.</span><span class=n>predicted</span> <span class=o>|=</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=n>state</span><span class=p>.</span><span class=n>strategyPrediction</span> <span class=o>!=</span> <span class=n>CompositionStrategyPredictionState</span><span class=o>::</span><span class=n>DISABLED</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>clientCompositionRecord</span><span class=p>.</span><span class=n>predictionSucceeded</span> <span class=o>|=</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=n>state</span><span class=p>.</span><span class=n>strategyPrediction</span> <span class=o>==</span> <span class=n>CompositionStrategyPredictionState</span><span class=o>::</span><span class=n>SUCCESS</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>clientCompositionRecord</span><span class=p>.</span><span class=n>hadClientComposition</span> <span class=o>=</span> <span class=n>mHadClientComposition</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>clientCompositionRecord</span><span class=p>.</span><span class=n>reused</span> <span class=o>=</span> <span class=n>mReusedClientComposition</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>clientCompositionRecord</span><span class=p>.</span><span class=n>changed</span> <span class=o>=</span> <span class=n>prevFrameHadClientComposition</span> <span class=o>!=</span> <span class=n>mHadClientComposition</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>mTimeStats</span><span class=o>-&gt;</span><span class=n>pushCompositionStrategyState</span><span class=p>(</span><span class=n>clientCompositionRecord</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=c1>// TODO: b/160583065 Enable skip validation when SF caches all client composition layers
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>const</span> <span class=kt>bool</span> <span class=n>usedGpuComposition</span> <span class=o>=</span> <span class=n>mHadClientComposition</span> <span class=o>||</span> <span class=n>mReusedClientComposition</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>modulateVsync</span><span class=p>(</span><span class=o>&amp;</span><span class=n>VsyncModulator</span><span class=o>::</span><span class=n>onDisplayRefresh</span><span class=p>,</span> <span class=n>usedGpuComposition</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>mLayersWithQueuedFrames</span><span class=p>.</span><span class=n>clear</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>mLayerTracingEnabled</span> <span class=o>&amp;&amp;</span> <span class=n>mLayerTracing</span><span class=p>.</span><span class=n>flagIsSet</span><span class=p>(</span><span class=n>LayerTracing</span><span class=o>::</span><span class=n>TRACE_COMPOSITION</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// This will block and should only be used for debugging.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mLayerTracing</span><span class=p>.</span><span class=n>notify</span><span class=p>(</span><span class=n>mVisibleRegionsDirty</span><span class=p>,</span> <span class=n>frameTime</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>mVisibleRegionsWereDirtyThisFrame</span> <span class=o>=</span> <span class=n>mVisibleRegionsDirty</span><span class=p>;</span> <span class=c1>// Cache value for use in post-comp
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mVisibleRegionsDirty</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>mCompositionEngine</span><span class=o>-&gt;</span><span class=n>needsAnotherUpdate</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>scheduleCommit</span><span class=p>(</span><span class=n>FrameHint</span><span class=o>::</span><span class=n>kNone</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=c1>// calculate total render time for performance hinting if adpf cpu hint is enabled,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>mPowerHintSessionData</span><span class=p>.</span><span class=n>sessionEnabled</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=n>nsecs_t</span> <span class=n>flingerDuration</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=n>mPowerHintSessionData</span><span class=p>.</span><span class=n>presentEnd</span> <span class=o>-</span> <span class=n>mPowerHintSessionData</span><span class=p>.</span><span class=n>commitStart</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>mPowerAdvisor</span><span class=o>-&gt;</span><span class=n>sendActualWorkDuration</span><span class=p>(</span><span class=n>flingerDuration</span><span class=p>,</span> <span class=n>mPowerHintSessionData</span><span class=p>.</span><span class=n>presentEnd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>调用CompositionEngine的present，开始真正的Layer合成：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngine/src/CompositionEngine.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=n>CompositionEngine</span><span class=o>::</span><span class=n>present</span><span class=p>(</span><span class=n>CompositionRefreshArgs</span><span class=o>&amp;</span> <span class=n>args</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ATRACE_CALL</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ALOGV</span><span class=p>(</span><span class=n>__FUNCTION__</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>preComposition</span><span class=p>(</span><span class=n>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// latchedLayers is used to track the set of front-end layer state that
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// has been latched across all outputs for the prepare step, and is not
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// needed for anything else.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>LayerFESet</span> <span class=n>latchedLayers</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>(</span><span class=k>const</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=nl>output</span> <span class=p>:</span> <span class=n>args</span><span class=p>.</span><span class=n>outputs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>output</span><span class=o>-&gt;</span><span class=n>prepare</span><span class=p>(</span><span class=n>args</span><span class=p>,</span> <span class=n>latchedLayers</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>updateLayerStateFromFE</span><span class=p>(</span><span class=n>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=k>const</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=nl>output</span> <span class=p>:</span> <span class=n>args</span><span class=p>.</span><span class=n>outputs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>output</span><span class=o>-&gt;</span><span class=n>present</span><span class=p>(</span><span class=n>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>上面方面主要处理如下：</p><p>1、调用CompositionEngine的preComposition方法，进行layer预合成。</p><p>2、调用Output的prepare方法，进行预合成。</p><p>3、调用Output的present方法，进行Layer合成。</p><p>下面分别进行分析：</p><h2 class=heading-element id=compositionengine-precomposition><span>CompositionEngine preComposition</span>
<a href=#compositionengine-precomposition class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>调用CompositionEngine的preComposition方法，进行合成前预处理：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngine/src/CompositionEngine.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=n>CompositionEngine</span><span class=o>::</span><span class=n>preComposition</span><span class=p>(</span><span class=n>CompositionRefreshArgs</span><span class=o>&amp;</span> <span class=n>args</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ATRACE_CALL</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ALOGV</span><span class=p>(</span><span class=n>__FUNCTION__</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=n>needsAnotherUpdate</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>mRefreshStartTime</span> <span class=o>=</span> <span class=n>systemTime</span><span class=p>(</span><span class=n>SYSTEM_TIME_MONOTONIC</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=c1>//遍历所有layer，进行layer预合成
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=k>auto</span><span class=o>&amp;</span> <span class=nl>layer</span> <span class=p>:</span> <span class=n>args</span><span class=p>.</span><span class=n>layers</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>layer</span><span class=o>-&gt;</span><span class=n>onPreComposition</span><span class=p>(</span><span class=n>mRefreshStartTime</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>needsAnotherUpdate</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>mNeedsAnotherUpdate</span> <span class=o>=</span> <span class=n>needsAnotherUpdate</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 class=heading-element id=bufferlayer-onprecomposition><span>BufferLayer onPreComposition</span>
<a href=#bufferlayer-onprecomposition class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>调用Layer的onPreComposition方法，BufferLayer继承于Layer：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/BufferLayer.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>bool</span> <span class=n>BufferLayer</span><span class=o>::</span><span class=n>onPreComposition</span><span class=p>(</span><span class=n>nsecs_t</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>hasReadyFrame</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>调用BufferLayer的hasReadyFrame方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/BufferLayer.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>bool</span> <span class=n>BufferLayer</span><span class=o>::</span><span class=n>hasReadyFrame</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>hasFrameUpdate</span><span class=p>()</span> <span class=o>||</span> <span class=n>getSidebandStreamChanged</span><span class=p>()</span> <span class=o>||</span> <span class=n>getAutoRefresh</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 class=heading-element id=output-prepare><span>Output prepare</span>
<a href=#output-prepare class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>调用Output的prepare方法，进行预合成：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=o>/</span><span class=n>frameworks</span><span class=o>/</span><span class=n>native</span><span class=o>/</span><span class=n>services</span><span class=o>/</span><span class=n>surfaceflinger</span><span class=o>/</span><span class=n>CompositionEngin</span><span class=o>/</span><span class=n>src</span><span class=o>/</span><span class=n>Output</span><span class=p>.</span><span class=n>cpp</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>Output</span><span class=o>::</span><span class=n>prepare</span><span class=p>(</span><span class=k>const</span> <span class=n>compositionengine</span><span class=o>::</span><span class=n>CompositionRefreshArgs</span><span class=o>&amp;</span> <span class=n>refreshArgs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                     <span class=n>LayerFESet</span><span class=o>&amp;</span> <span class=n>geomSnapshots</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ATRACE_CALL</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ALOGV</span><span class=p>(</span><span class=n>__FUNCTION__</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>rebuildLayerStacks</span><span class=p>(</span><span class=n>refreshArgs</span><span class=p>,</span> <span class=n>geomSnapshots</span><span class=p>);</span> <span class=c1>//Output实际上就是display， 通过调用每个Display的rebuildLayerStacks ，建立display 的 LayerStacks.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 class=heading-element id=output-rebuildlayerstacks><span>Output rebuildLayerStacks</span>
<a href=#output-rebuildlayerstacks class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>调用Output的rebuildLayerStacks方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=n>Output</span><span class=o>::</span><span class=n>rebuildLayerStacks</span><span class=p>(</span><span class=k>const</span> <span class=n>compositionengine</span><span class=o>::</span><span class=n>CompositionRefreshArgs</span><span class=o>&amp;</span> <span class=n>refreshArgs</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>LayerFESet</span><span class=o>&amp;</span> <span class=n>layerFESet</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ATRACE_CALL</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ALOGV</span><span class=p>(</span><span class=n>__FUNCTION__</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>auto</span><span class=o>&amp;</span> <span class=n>outputState</span> <span class=o>=</span> <span class=n>editState</span><span class=p>();</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=c1>// Do nothing if this output is not enabled or there is no need to perform this update
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>outputState</span><span class=p>.</span><span class=n>isEnabled</span> <span class=o>||</span> <span class=n>CC_LIKELY</span><span class=p>(</span><span class=o>!</span><span class=n>refreshArgs</span><span class=p>.</span><span class=n>updatingOutputGeometryThisFrame</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=c1>// Process the layers to determine visibility and coverage
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>compositionengine</span><span class=o>::</span><span class=n>Output</span><span class=o>::</span><span class=n>CoverageState</span> <span class=n>coverage</span><span class=p>{</span><span class=n>layerFESet</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=n>collectVisibleLayers</span><span class=p>(</span><span class=n>refreshArgs</span><span class=p>,</span> <span class=n>coverage</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=c1>// Compute the resulting coverage for this output, and store it for later
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>const</span> <span class=n>ui</span><span class=o>::</span><span class=n>Transform</span><span class=o>&amp;</span> <span class=n>tr</span> <span class=o>=</span> <span class=n>outputState</span><span class=p>.</span><span class=n>transform</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Region</span> <span class=n>undefinedRegion</span><span class=p>{</span><span class=n>outputState</span><span class=p>.</span><span class=n>displaySpace</span><span class=p>.</span><span class=n>getBoundsAsRect</span><span class=p>()};</span>
</span></span><span class=line><span class=cl>    <span class=n>undefinedRegion</span><span class=p>.</span><span class=n>subtractSelf</span><span class=p>(</span><span class=n>tr</span><span class=p>.</span><span class=n>transform</span><span class=p>(</span><span class=n>coverage</span><span class=p>.</span><span class=n>aboveOpaqueLayers</span><span class=p>));</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>outputState</span><span class=p>.</span><span class=n>undefinedRegion</span> <span class=o>=</span> <span class=n>undefinedRegion</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>outputState</span><span class=p>.</span><span class=n>dirtyRegion</span><span class=p>.</span><span class=n>orSelf</span><span class=p>(</span><span class=n>coverage</span><span class=p>.</span><span class=n>dirtyRegion</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 class=heading-element id=output-present><span>Output present</span>
<a href=#output-present class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>调用Output的present方法，进行Layer合成。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=n>Output</span><span class=o>::</span><span class=n>present</span><span class=p>(</span><span class=k>const</span> <span class=n>compositionengine</span><span class=o>::</span><span class=n>CompositionRefreshArgs</span><span class=o>&amp;</span> <span class=n>refreshArgs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ATRACE_CALL</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ALOGV</span><span class=p>(</span><span class=n>__FUNCTION__</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>updateColorProfile</span><span class=p>(</span><span class=n>refreshArgs</span><span class=p>);</span> <span class=c1>//更新颜色配置文件
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>updateCompositionState</span><span class=p>(</span><span class=n>refreshArgs</span><span class=p>);</span> <span class=c1>//更新合成状态
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>planComposition</span><span class=p>();</span> <span class=c1>//计划合成
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>writeCompositionState</span><span class=p>(</span><span class=n>refreshArgs</span><span class=p>);</span> <span class=c1>//写入合成状态
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>setColorTransform</span><span class=p>(</span><span class=n>refreshArgs</span><span class=p>);</span> <span class=c1>//设置颜色矩阵
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>beginFrame</span><span class=p>();</span> <span class=c1>//开始帧
</span></span></span><span class=line><span class=cl><span class=c1></span> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>GpuCompositionResult</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=kt>bool</span> <span class=n>predictCompositionStrategy</span> <span class=o>=</span> <span class=n>canPredictCompositionStrategy</span><span class=p>(</span><span class=n>refreshArgs</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>predictCompositionStrategy</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>=</span> <span class=n>prepareFrameAsync</span><span class=p>(</span><span class=n>refreshArgs</span><span class=p>);</span> <span class=c1>//准备帧数据以进行显示(Async方式)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>prepareFrame</span><span class=p>();</span> <span class=c1>//准备帧数据以进行显示
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>devOptRepaintFlash</span><span class=p>(</span><span class=n>refreshArgs</span><span class=p>);</span> <span class=c1>//处理显示输出设备的可选重绘闪烁
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>finishFrame</span><span class=p>(</span><span class=n>refreshArgs</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>result</span><span class=p>));</span> <span class=c1>//完成帧
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>postFramebuffer</span><span class=p>();</span> <span class=c1>//将帧缓冲区（framebuffer）的内容发送到显示设备进行显示
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>renderCachedSets</span><span class=p>(</span><span class=n>refreshArgs</span><span class=p>);</span> <span class=c1>//进行渲染缓存设置
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>上面方法主要处理如下：</p><p>1、调用Output的updateColorProfile方法，更新颜色配置。</p><p>2、调用Output的updateCompositionState方法，更新合成状态。</p><p>3、调用Output的planComposition方法，计划合成。</p><p>4、调用Output的writeCompositionState方法，写入合成状态。</p><p>5、调用Output的setColorTransform方法，设置颜色矩阵。</p><p>6、调用Output的beginFrame方法，开始帧。</p><p>7、调用Output的prepareFrameAsync方法，准备帧数据以进行显示(Async方式)。</p><p>8、调用Output的prepareFrame方法，准备帧数据以进行显示。</p><p>9、调用Output的devOptRepaintFlash方法，处理显示输出设备的可选重绘闪烁。</p><p>10、调用Output的finishFrame方法，完成帧。</p><p>11、调用Output的postFramebuffer方法，将帧缓冲区（framebuffer）的内容发送到显示设备进行显示。</p><p>12、调用Output的renderCachedSets方法，进行渲染缓存设置。</p><p>下面分别进行分析：</p><h3 class=heading-element id=output-updatecolorprofile><span>Output updateColorProfile</span>
<a href=#output-updatecolorprofile class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>调用Output的updateColorProfile方法，更新颜色配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=n>Output</span><span class=o>::</span><span class=n>updateColorProfile</span><span class=p>(</span><span class=k>const</span> <span class=n>compositionengine</span><span class=o>::</span><span class=n>CompositionRefreshArgs</span><span class=o>&amp;</span> <span class=n>refreshArgs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>setColorProfile</span><span class=p>(</span><span class=n>pickColorProfile</span><span class=p>(</span><span class=n>refreshArgs</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>调用Output的setColorProfile方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=n>Output</span><span class=o>::</span><span class=n>setColorProfile</span><span class=p>(</span><span class=k>const</span> <span class=n>ColorProfile</span><span class=o>&amp;</span> <span class=n>colorProfile</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ui</span><span class=o>::</span><span class=n>Dataspace</span> <span class=n>targetDataspace</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>            <span class=n>getDisplayColorProfile</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>getTargetDataspace</span><span class=p>(</span><span class=n>colorProfile</span><span class=p>.</span><span class=n>mode</span><span class=p>,</span> <span class=n>colorProfile</span><span class=p>.</span><span class=n>dataspace</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                         <span class=n>colorProfile</span><span class=p>.</span><span class=n>colorSpaceAgnosticDataspace</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>auto</span><span class=o>&amp;</span> <span class=n>outputState</span> <span class=o>=</span> <span class=n>editState</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>outputState</span><span class=p>.</span><span class=n>colorMode</span> <span class=o>==</span> <span class=n>colorProfile</span><span class=p>.</span><span class=n>mode</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=n>outputState</span><span class=p>.</span><span class=n>dataspace</span> <span class=o>==</span> <span class=n>colorProfile</span><span class=p>.</span><span class=n>dataspace</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=n>outputState</span><span class=p>.</span><span class=n>renderIntent</span> <span class=o>==</span> <span class=n>colorProfile</span><span class=p>.</span><span class=n>renderIntent</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=n>outputState</span><span class=p>.</span><span class=n>targetDataspace</span> <span class=o>==</span> <span class=n>targetDataspace</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>outputState</span><span class=p>.</span><span class=n>colorMode</span> <span class=o>=</span> <span class=n>colorProfile</span><span class=p>.</span><span class=n>mode</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>outputState</span><span class=p>.</span><span class=n>dataspace</span> <span class=o>=</span> <span class=n>colorProfile</span><span class=p>.</span><span class=n>dataspace</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>outputState</span><span class=p>.</span><span class=n>renderIntent</span> <span class=o>=</span> <span class=n>colorProfile</span><span class=p>.</span><span class=n>renderIntent</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>outputState</span><span class=p>.</span><span class=n>targetDataspace</span> <span class=o>=</span> <span class=n>targetDataspace</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>mRenderSurface</span><span class=o>-&gt;</span><span class=n>setBufferDataspace</span><span class=p>(</span><span class=n>colorProfile</span><span class=p>.</span><span class=n>dataspace</span><span class=p>);</span> <span class=c1>//设置缓存数据空间
</span></span></span><span class=line><span class=cl><span class=c1></span> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>ALOGV</span><span class=p>(</span><span class=s>&#34;Set active color mode: %s (%d), active render intent: %s (%d)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>decodeColorMode</span><span class=p>(</span><span class=n>colorProfile</span><span class=p>.</span><span class=n>mode</span><span class=p>).</span><span class=n>c_str</span><span class=p>(),</span> <span class=n>colorProfile</span><span class=p>.</span><span class=n>mode</span><span class=p>,</span>
</span></span><span class=line><span class=cl>          <span class=n>decodeRenderIntent</span><span class=p>(</span><span class=n>colorProfile</span><span class=p>.</span><span class=n>renderIntent</span><span class=p>).</span><span class=n>c_str</span><span class=p>(),</span> <span class=n>colorProfile</span><span class=p>.</span><span class=n>renderIntent</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>dirtyEntireOutput</span><span class=p>();</span> <span class=c1>//重置脏区
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>上面方法主要处理如下：</p><p>1、调用mRenderSurface(RenderSurface)的setBufferDataspace方法，设置缓存数据空间。</p><p>2、调用Output的dirtyEntireOutput方法，重置脏区。</p><p>下面分别进行分析：</p><h4 class=heading-element id=rendersurface-setbufferdataspace><span>RenderSurface setBufferDataspace</span>
<a href=#rendersurface-setbufferdataspace class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>调用mRenderSurface(RenderSurface)的setBufferDataspace方法，设置缓存数据空间：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/RenderSurface.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=n>RenderSurface</span><span class=o>::</span><span class=n>setBufferDataspace</span><span class=p>(</span><span class=n>ui</span><span class=o>::</span><span class=n>Dataspace</span> <span class=n>dataspace</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>native_window_set_buffers_data_space</span><span class=p>(</span><span class=n>mNativeWindow</span><span class=p>.</span><span class=n>get</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                                         <span class=k>static_cast</span><span class=o>&lt;</span><span class=n>android_dataspace</span><span class=o>&gt;</span><span class=p>(</span><span class=n>dataspace</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 class=heading-element id=output-updatecompositionstate><span>Output updateCompositionState</span>
<a href=#output-updatecompositionstate class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>调用Output的updateCompositionState方法，更新合成状态：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=n>Output</span><span class=o>::</span><span class=n>updateCompositionState</span><span class=p>(</span><span class=k>const</span> <span class=n>compositionengine</span><span class=o>::</span><span class=n>CompositionRefreshArgs</span><span class=o>&amp;</span> <span class=n>refreshArgs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ATRACE_CALL</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ALOGV</span><span class=p>(</span><span class=n>__FUNCTION__</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>getState</span><span class=p>().</span><span class=n>isEnabled</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>mLayerRequestingBackgroundBlur</span> <span class=o>=</span> <span class=n>findLayerRequestingBackgroundComposition</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=n>forceClientComposition</span> <span class=o>=</span> <span class=n>mLayerRequestingBackgroundBlur</span> <span class=o>!=</span> <span class=k>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=k>auto</span><span class=o>*</span> <span class=nl>layer</span> <span class=p>:</span> <span class=n>getOutputLayersOrderedByZ</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>layer</span><span class=o>-&gt;</span><span class=n>updateCompositionState</span><span class=p>(</span><span class=n>refreshArgs</span><span class=p>.</span><span class=n>updatingGeometryThisFrame</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                      <span class=n>refreshArgs</span><span class=p>.</span><span class=n>devOptForceClientComposition</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>                                              <span class=n>forceClientComposition</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                      <span class=n>refreshArgs</span><span class=p>.</span><span class=n>internalDisplayRotationFlags</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>mLayerRequestingBackgroundBlur</span> <span class=o>==</span> <span class=n>layer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>forceClientComposition</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h4 class=heading-element id=outputlayer-updatecompositionstate><span>OutputLayer updateCompositionState</span>
<a href=#outputlayer-updatecompositionstate class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>调用OutputLayer的updateCompositionState方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/OutputLayer.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=n>OutputLayer</span><span class=o>::</span><span class=n>updateCompositionState</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=kt>bool</span> <span class=n>includeGeometry</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>forceClientComposition</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>ui</span><span class=o>::</span><span class=n>Transform</span><span class=o>::</span><span class=n>RotationFlags</span> <span class=n>internalDisplayRotationFlags</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=k>auto</span><span class=o>*</span> <span class=n>layerFEState</span> <span class=o>=</span> <span class=n>getLayerFE</span><span class=p>().</span><span class=n>getCompositionState</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>layerFEState</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=n>outputState</span> <span class=o>=</span> <span class=n>getOutput</span><span class=p>().</span><span class=n>getState</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=n>profile</span> <span class=o>=</span> <span class=o>*</span><span class=n>getOutput</span><span class=p>().</span><span class=n>getDisplayColorProfile</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span><span class=o>&amp;</span> <span class=n>state</span> <span class=o>=</span> <span class=n>editState</span><span class=p>();</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>includeGeometry</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Clear the forceClientComposition flag before it is set for any
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// reason. Note that since it can be set by some checks below when
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// updating the geometry state, we only clear it when updating the
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// geometry since those conditions for forcing client composition won&#39;t
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// go away otherwise.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>state</span><span class=p>.</span><span class=n>forceClientComposition</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=n>state</span><span class=p>.</span><span class=n>displayFrame</span> <span class=o>=</span> <span class=n>calculateOutputDisplayFrame</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=n>state</span><span class=p>.</span><span class=n>sourceCrop</span> <span class=o>=</span> <span class=n>calculateOutputSourceCrop</span><span class=p>(</span><span class=n>internalDisplayRotationFlags</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>state</span><span class=p>.</span><span class=n>bufferTransform</span> <span class=o>=</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=n>Hwc2</span><span class=o>::</span><span class=n>Transform</span><span class=o>&gt;</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>calculateOutputRelativeBufferTransform</span><span class=p>(</span><span class=n>internalDisplayRotationFlags</span><span class=p>));</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>((</span><span class=n>layerFEState</span><span class=o>-&gt;</span><span class=n>isSecure</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>outputState</span><span class=p>.</span><span class=n>isSecure</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=n>state</span><span class=p>.</span><span class=n>bufferTransform</span> <span class=o>&amp;</span> <span class=n>ui</span><span class=o>::</span><span class=n>Transform</span><span class=o>::</span><span class=n>ROT_INVALID</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>state</span><span class=p>.</span><span class=n>forceClientComposition</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=c1>// Determine the output dependent dataspace for this layer. If it is
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// colorspace agnostic, it just uses the dataspace chosen for the output to
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// avoid the need for color conversion.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>state</span><span class=p>.</span><span class=n>dataspace</span> <span class=o>=</span> <span class=n>layerFEState</span><span class=o>-&gt;</span><span class=n>isColorspaceAgnostic</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>                    <span class=n>outputState</span><span class=p>.</span><span class=n>targetDataspace</span> <span class=o>!=</span> <span class=n>ui</span><span class=o>::</span><span class=n>Dataspace</span><span class=o>::</span><span class=n>UNKNOWN</span>
</span></span><span class=line><span class=cl>            <span class=o>?</span> <span class=n>outputState</span><span class=p>.</span><span class=nl>targetDataspace</span>
</span></span><span class=line><span class=cl>            <span class=p>:</span> <span class=n>layerFEState</span><span class=o>-&gt;</span><span class=n>dataspace</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=c1>// Override the dataspace transfer from 170M to sRGB if the device configuration requests this.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// We do this here instead of in buffer info so that dumpsys can still report layers that are
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// using the 170M transfer. Also we only do this if the colorspace is not agnostic for the
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// layer, in case the color profile uses a 170M transfer function.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>outputState</span><span class=p>.</span><span class=n>treat170mAsSrgb</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>layerFEState</span><span class=o>-&gt;</span><span class=n>isColorspaceAgnostic</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=n>state</span><span class=p>.</span><span class=n>dataspace</span> <span class=o>&amp;</span> <span class=n>HAL_DATASPACE_TRANSFER_MASK</span><span class=p>)</span> <span class=o>==</span> <span class=n>HAL_DATASPACE_TRANSFER_SMPTE_170M</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>state</span><span class=p>.</span><span class=n>dataspace</span> <span class=o>=</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=n>ui</span><span class=o>::</span><span class=n>Dataspace</span><span class=o>&gt;</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=n>state</span><span class=p>.</span><span class=n>dataspace</span> <span class=o>&amp;</span> <span class=n>HAL_DATASPACE_STANDARD_MASK</span><span class=p>)</span> <span class=o>|</span>
</span></span><span class=line><span class=cl>                <span class=p>(</span><span class=n>state</span><span class=p>.</span><span class=n>dataspace</span> <span class=o>&amp;</span> <span class=n>HAL_DATASPACE_RANGE_MASK</span><span class=p>)</span> <span class=o>|</span> <span class=n>HAL_DATASPACE_TRANSFER_SRGB</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=c1>// For hdr content, treat the white point as the display brightness - HDR content should not be
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// boosted or dimmed.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// If the layer explicitly requests to disable dimming, then don&#39;t dim either.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>isHdrDataspace</span><span class=p>(</span><span class=n>state</span><span class=p>.</span><span class=n>dataspace</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>        <span class=n>getOutput</span><span class=p>().</span><span class=n>getState</span><span class=p>().</span><span class=n>displayBrightnessNits</span> <span class=o>==</span> <span class=n>getOutput</span><span class=p>().</span><span class=n>getState</span><span class=p>().</span><span class=n>sdrWhitePointNits</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>        <span class=n>getOutput</span><span class=p>().</span><span class=n>getState</span><span class=p>().</span><span class=n>displayBrightnessNits</span> <span class=o>==</span> <span class=mf>0.f</span> <span class=o>||</span> <span class=o>!</span><span class=n>layerFEState</span><span class=o>-&gt;</span><span class=n>dimmingEnabled</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>state</span><span class=p>.</span><span class=n>dimmingRatio</span> <span class=o>=</span> <span class=mf>1.f</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>state</span><span class=p>.</span><span class=n>whitePointNits</span> <span class=o>=</span> <span class=n>getOutput</span><span class=p>().</span><span class=n>getState</span><span class=p>().</span><span class=n>displayBrightnessNits</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>state</span><span class=p>.</span><span class=n>dimmingRatio</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>clamp</span><span class=p>(</span><span class=n>getOutput</span><span class=p>().</span><span class=n>getState</span><span class=p>().</span><span class=n>sdrWhitePointNits</span> <span class=o>/</span>
</span></span><span class=line><span class=cl>                                                <span class=n>getOutput</span><span class=p>().</span><span class=n>getState</span><span class=p>().</span><span class=n>displayBrightnessNits</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                        <span class=mf>0.f</span><span class=p>,</span> <span class=mf>1.f</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>state</span><span class=p>.</span><span class=n>whitePointNits</span> <span class=o>=</span> <span class=n>getOutput</span><span class=p>().</span><span class=n>getState</span><span class=p>().</span><span class=n>sdrWhitePointNits</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=c1>// These are evaluated every frame as they can potentially change at any
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// time.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>layerFEState</span><span class=o>-&gt;</span><span class=n>forceClientComposition</span> <span class=o>||</span> <span class=o>!</span><span class=n>profile</span><span class=p>.</span><span class=n>isDataspaceSupported</span><span class=p>(</span><span class=n>state</span><span class=p>.</span><span class=n>dataspace</span><span class=p>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>        <span class=n>forceClientComposition</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>state</span><span class=p>.</span><span class=n>forceClientComposition</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 class=heading-element id=output-plancomposition><span>Output planComposition</span>
<a href=#output-plancomposition class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>调用Output的planComposition方法，计划合成：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=n>Output</span><span class=o>::</span><span class=n>planComposition</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>mPlanner</span> <span class=o>||</span> <span class=o>!</span><span class=n>getState</span><span class=p>().</span><span class=n>isEnabled</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>ATRACE_CALL</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ALOGV</span><span class=p>(</span><span class=n>__FUNCTION__</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>mPlanner</span><span class=o>-&gt;</span><span class=n>plan</span><span class=p>(</span><span class=n>getOutputLayersOrderedByZ</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h4 class=heading-element id=planner-plan><span>Planner plan</span>
<a href=#planner-plan class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>调用Planner的plan方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span><span class=lnt>92
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/Planner.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=n>Planner</span><span class=o>::</span><span class=n>plan</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>compositionengine</span><span class=o>::</span><span class=n>Output</span><span class=o>::</span><span class=n>OutputLayersEnumerator</span><span class=o>&lt;</span><span class=n>compositionengine</span><span class=o>::</span><span class=n>Output</span><span class=o>&gt;&amp;&amp;</span> <span class=n>layers</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ATRACE_CALL</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>unordered_set</span><span class=o>&lt;</span><span class=n>LayerId</span><span class=o>&gt;</span> <span class=n>removedLayers</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>removedLayers</span><span class=p>.</span><span class=n>reserve</span><span class=p>(</span><span class=n>mPreviousLayers</span><span class=p>.</span><span class=n>size</span><span class=p>());</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>transform</span><span class=p>(</span><span class=n>mPreviousLayers</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span> <span class=n>mPreviousLayers</span><span class=p>.</span><span class=n>end</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                   <span class=n>std</span><span class=o>::</span><span class=n>inserter</span><span class=p>(</span><span class=n>removedLayers</span><span class=p>,</span> <span class=n>removedLayers</span><span class=p>.</span><span class=n>begin</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>                   <span class=p>[](</span><span class=k>const</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=n>layer</span><span class=p>)</span> <span class=p>{</span> <span class=k>return</span> <span class=n>layer</span><span class=p>.</span><span class=n>first</span><span class=p>;</span> <span class=p>});</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>LayerId</span><span class=o>&gt;</span> <span class=n>currentLayerIds</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=k>auto</span> <span class=nl>layer</span> <span class=p>:</span> <span class=n>layers</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>LayerId</span> <span class=n>id</span> <span class=o>=</span> <span class=n>layer</span><span class=o>-&gt;</span><span class=n>getLayerFE</span><span class=p>().</span><span class=n>getSequence</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>const</span> <span class=k>auto</span> <span class=n>layerEntry</span> <span class=o>=</span> <span class=n>mPreviousLayers</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>id</span><span class=p>);</span> <span class=n>layerEntry</span> <span class=o>!=</span> <span class=n>mPreviousLayers</span><span class=p>.</span><span class=n>end</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Track changes from previous info
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>LayerState</span><span class=o>&amp;</span> <span class=n>state</span> <span class=o>=</span> <span class=n>layerEntry</span><span class=o>-&gt;</span><span class=n>second</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>ftl</span><span class=o>::</span><span class=n>Flags</span><span class=o>&lt;</span><span class=n>LayerStateField</span><span class=o>&gt;</span> <span class=n>differences</span> <span class=o>=</span> <span class=n>state</span><span class=p>.</span><span class=n>update</span><span class=p>(</span><span class=n>layer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>differences</span><span class=p>.</span><span class=n>get</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>state</span><span class=p>.</span><span class=n>incrementFramesSinceBufferUpdate</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>ALOGV</span><span class=p>(</span><span class=s>&#34;Layer %s changed: %s&#34;</span><span class=p>,</span> <span class=n>state</span><span class=p>.</span><span class=n>getName</span><span class=p>().</span><span class=n>c_str</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                      <span class=n>differences</span><span class=p>.</span><span class=n>string</span><span class=p>().</span><span class=n>c_str</span><span class=p>());</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=p>(</span><span class=n>differences</span><span class=p>.</span><span class=n>test</span><span class=p>(</span><span class=n>LayerStateField</span><span class=o>::</span><span class=n>Buffer</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>state</span><span class=p>.</span><span class=n>resetFramesSinceBufferUpdate</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>state</span><span class=p>.</span><span class=n>incrementFramesSinceBufferUpdate</span><span class=p>();</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>LayerState</span> <span class=nf>state</span><span class=p>(</span><span class=n>layer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>ALOGV</span><span class=p>(</span><span class=s>&#34;Added layer %s&#34;</span><span class=p>,</span> <span class=n>state</span><span class=p>.</span><span class=n>getName</span><span class=p>().</span><span class=n>c_str</span><span class=p>());</span>
</span></span><span class=line><span class=cl>            <span class=n>mPreviousLayers</span><span class=p>.</span><span class=n>emplace</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>make_pair</span><span class=p>(</span><span class=n>id</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>state</span><span class=p>)));</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=n>currentLayerIds</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>const</span> <span class=k>auto</span> <span class=n>found</span> <span class=o>=</span> <span class=n>removedLayers</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>id</span><span class=p>);</span> <span class=n>found</span> <span class=o>!=</span> <span class=n>removedLayers</span><span class=p>.</span><span class=n>end</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>removedLayers</span><span class=p>.</span><span class=n>erase</span><span class=p>(</span><span class=n>found</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>mCurrentLayers</span><span class=p>.</span><span class=n>clear</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>mCurrentLayers</span><span class=p>.</span><span class=n>reserve</span><span class=p>(</span><span class=n>currentLayerIds</span><span class=p>.</span><span class=n>size</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>transform</span><span class=p>(</span><span class=n>currentLayerIds</span><span class=p>.</span><span class=n>cbegin</span><span class=p>(),</span> <span class=n>currentLayerIds</span><span class=p>.</span><span class=n>cend</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                   <span class=n>std</span><span class=o>::</span><span class=n>back_inserter</span><span class=p>(</span><span class=n>mCurrentLayers</span><span class=p>),</span> <span class=p>[</span><span class=k>this</span><span class=p>](</span><span class=n>LayerId</span> <span class=n>id</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                       <span class=n>LayerState</span><span class=o>*</span> <span class=n>state</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>mPreviousLayers</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=n>id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                       <span class=n>state</span><span class=o>-&gt;</span><span class=n>getOutputLayer</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>editState</span><span class=p>().</span><span class=n>overrideInfo</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=cl>                       <span class=k>return</span> <span class=n>state</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                   <span class=p>});</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>NonBufferHash</span> <span class=n>hash</span> <span class=o>=</span> <span class=n>getNonBufferHash</span><span class=p>(</span><span class=n>mCurrentLayers</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>mFlattenedHash</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>            <span class=n>mFlattener</span><span class=p>.</span><span class=n>flattenLayers</span><span class=p>(</span><span class=n>mCurrentLayers</span><span class=p>,</span> <span class=n>hash</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>steady_clock</span><span class=o>::</span><span class=n>now</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=kt>bool</span> <span class=n>layersWereFlattened</span> <span class=o>=</span> <span class=n>hash</span> <span class=o>!=</span> <span class=n>mFlattenedHash</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>ALOGV</span><span class=p>(</span><span class=s>&#34;[%s] Initial hash %zx flattened hash %zx&#34;</span><span class=p>,</span> <span class=n>__func__</span><span class=p>,</span> <span class=n>hash</span><span class=p>,</span> <span class=n>mFlattenedHash</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>mPredictorEnabled</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mPredictedPlan</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=n>mPredictor</span><span class=p>.</span><span class=n>getPredictedPlan</span><span class=p>(</span><span class=n>layersWereFlattened</span> <span class=o>?</span> <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=k>const</span> <span class=n>LayerState</span><span class=o>*&gt;</span><span class=p>()</span>
</span></span><span class=line><span class=cl>                                                                <span class=o>:</span> <span class=n>mCurrentLayers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                            <span class=n>mFlattenedHash</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>mPredictedPlan</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ALOGV</span><span class=p>(</span><span class=s>&#34;[%s] Predicting plan %s&#34;</span><span class=p>,</span> <span class=n>__func__</span><span class=p>,</span> <span class=n>to_string</span><span class=p>(</span><span class=n>mPredictedPlan</span><span class=o>-&gt;</span><span class=n>plan</span><span class=p>).</span><span class=n>c_str</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ALOGV</span><span class=p>(</span><span class=s>&#34;[%s] No prediction found</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>__func__</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=c1>// Clean up the set of previous layers now that the view of the LayerStates in the flattener are
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// up-to-date.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=n>LayerId</span> <span class=nl>removedLayer</span> <span class=p>:</span> <span class=n>removedLayers</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>const</span> <span class=k>auto</span> <span class=n>layerEntry</span> <span class=o>=</span> <span class=n>mPreviousLayers</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>removedLayer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>layerEntry</span> <span class=o>!=</span> <span class=n>mPreviousLayers</span><span class=p>.</span><span class=n>end</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>const</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=p>[</span><span class=n>id</span><span class=p>,</span> <span class=n>state</span><span class=p>]</span> <span class=o>=</span> <span class=o>*</span><span class=n>layerEntry</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>ALOGV</span><span class=p>(</span><span class=s>&#34;Removed layer %s&#34;</span><span class=p>,</span> <span class=n>state</span><span class=p>.</span><span class=n>getName</span><span class=p>().</span><span class=n>c_str</span><span class=p>());</span>
</span></span><span class=line><span class=cl>            <span class=n>mPreviousLayers</span><span class=p>.</span><span class=n>erase</span><span class=p>(</span><span class=n>removedLayer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 class=heading-element id=output-writecompositionstate><span>Output writeCompositionState</span>
<a href=#output-writecompositionstate class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>调用Output的writeCompositionState方法，写入合成状态：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=n>Output</span><span class=o>::</span><span class=n>writeCompositionState</span><span class=p>(</span><span class=k>const</span> <span class=n>compositionengine</span><span class=o>::</span><span class=n>CompositionRefreshArgs</span><span class=o>&amp;</span> <span class=n>refreshArgs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ATRACE_CALL</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ALOGV</span><span class=p>(</span><span class=n>__FUNCTION__</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>getState</span><span class=p>().</span><span class=n>isEnabled</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>editState</span><span class=p>().</span><span class=n>earliestPresentTime</span> <span class=o>=</span> <span class=n>refreshArgs</span><span class=p>.</span><span class=n>earliestPresentTime</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>editState</span><span class=p>().</span><span class=n>previousPresentFence</span> <span class=o>=</span> <span class=n>refreshArgs</span><span class=p>.</span><span class=n>previousPresentFence</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>editState</span><span class=p>().</span><span class=n>expectedPresentTime</span> <span class=o>=</span> <span class=n>refreshArgs</span><span class=p>.</span><span class=n>expectedPresentTime</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>compositionengine</span><span class=o>::</span><span class=n>OutputLayer</span><span class=o>*</span> <span class=n>peekThroughLayer</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>sp</span><span class=o>&lt;</span><span class=n>GraphicBuffer</span><span class=o>&gt;</span> <span class=n>previousOverride</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=n>includeGeometry</span> <span class=o>=</span> <span class=n>refreshArgs</span><span class=p>.</span><span class=n>updatingGeometryThisFrame</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>z</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=n>overrideZ</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint64_t</span> <span class=n>outputLayerHash</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=k>auto</span><span class=o>*</span> <span class=nl>layer</span> <span class=p>:</span> <span class=n>getOutputLayersOrderedByZ</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>layer</span> <span class=o>==</span> <span class=n>peekThroughLayer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// No longer needed, although it should not show up again, so
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// resetting it is not truly needed either.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>peekThroughLayer</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>            <span class=c1>// peekThroughLayer was already drawn ahead of its z order.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=kt>bool</span> <span class=n>skipLayer</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=n>overrideInfo</span> <span class=o>=</span> <span class=n>layer</span><span class=o>-&gt;</span><span class=n>getState</span><span class=p>().</span><span class=n>overrideInfo</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>overrideInfo</span><span class=p>.</span><span class=n>buffer</span> <span class=o>!=</span> <span class=k>nullptr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>previousOverride</span> <span class=o>&amp;&amp;</span> <span class=n>overrideInfo</span><span class=p>.</span><span class=n>buffer</span><span class=o>-&gt;</span><span class=n>getBuffer</span><span class=p>()</span> <span class=o>==</span> <span class=n>previousOverride</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>ALOGV</span><span class=p>(</span><span class=s>&#34;Skipping redundant buffer&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>skipLayer</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// First layer with the override buffer.
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=p>(</span><span class=n>overrideInfo</span><span class=p>.</span><span class=n>peekThroughLayer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>peekThroughLayer</span> <span class=o>=</span> <span class=n>overrideInfo</span><span class=p>.</span><span class=n>peekThroughLayer</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>                    <span class=c1>// Draw peekThroughLayer first.
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=n>overrideZ</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>includeGeometry</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=k>constexpr</span> <span class=kt>bool</span> <span class=n>isPeekingThrough</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                    <span class=n>peekThroughLayer</span><span class=o>-&gt;</span><span class=n>writeStateToHWC</span><span class=p>(</span><span class=n>includeGeometry</span><span class=p>,</span> <span class=nb>false</span><span class=p>,</span> <span class=n>z</span><span class=o>++</span><span class=p>,</span> <span class=n>overrideZ</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                      <span class=n>isPeekingThrough</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=n>outputLayerHash</span> <span class=o>^=</span> <span class=n>android</span><span class=o>::</span><span class=n>hashCombine</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                            <span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=kt>uint64_t</span><span class=o>&gt;</span><span class=p>(</span><span class=o>&amp;</span><span class=n>peekThroughLayer</span><span class=o>-&gt;</span><span class=n>getLayerFE</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>                            <span class=n>z</span><span class=p>,</span> <span class=n>includeGeometry</span><span class=p>,</span> <span class=n>overrideZ</span><span class=p>,</span> <span class=n>isPeekingThrough</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=n>peekThroughLayer</span><span class=o>-&gt;</span><span class=n>requiresClientComposition</span><span class=p>());</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>                <span class=n>previousOverride</span> <span class=o>=</span> <span class=n>overrideInfo</span><span class=p>.</span><span class=n>buffer</span><span class=o>-&gt;</span><span class=n>getBuffer</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=k>constexpr</span> <span class=kt>bool</span> <span class=n>isPeekingThrough</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>layer</span><span class=o>-&gt;</span><span class=n>writeStateToHWC</span><span class=p>(</span><span class=n>includeGeometry</span><span class=p>,</span> <span class=n>skipLayer</span><span class=p>,</span> <span class=n>z</span><span class=o>++</span><span class=p>,</span> <span class=n>overrideZ</span><span class=p>,</span> <span class=n>isPeekingThrough</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>skipLayer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>outputLayerHash</span> <span class=o>^=</span> <span class=n>android</span><span class=o>::</span><span class=n>hashCombine</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=kt>uint64_t</span><span class=o>&gt;</span><span class=p>(</span><span class=o>&amp;</span><span class=n>layer</span><span class=o>-&gt;</span><span class=n>getLayerFE</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>                    <span class=n>z</span><span class=p>,</span> <span class=n>includeGeometry</span><span class=p>,</span> <span class=n>overrideZ</span><span class=p>,</span> <span class=n>isPeekingThrough</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                    <span class=n>layer</span><span class=o>-&gt;</span><span class=n>requiresClientComposition</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>editState</span><span class=p>().</span><span class=n>outputLayerHash</span> <span class=o>=</span> <span class=n>outputLayerHash</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 class=heading-element id=output-setcolortransform><span>Output setColorTransform</span>
<a href=#output-setcolortransform class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>调用Output的setColorTransform方法，设置颜色矩阵：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=n>Output</span><span class=o>::</span><span class=n>setColorTransform</span><span class=p>(</span><span class=k>const</span> <span class=n>compositionengine</span><span class=o>::</span><span class=n>CompositionRefreshArgs</span><span class=o>&amp;</span> <span class=n>args</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span><span class=o>&amp;</span> <span class=n>colorTransformMatrix</span> <span class=o>=</span> <span class=n>editState</span><span class=p>().</span><span class=n>colorTransformMatrix</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>args</span><span class=p>.</span><span class=n>colorTransformMatrix</span> <span class=o>||</span> <span class=n>colorTransformMatrix</span> <span class=o>==</span> <span class=n>args</span><span class=p>.</span><span class=n>colorTransformMatrix</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>colorTransformMatrix</span> <span class=o>=</span> <span class=o>*</span><span class=n>args</span><span class=p>.</span><span class=n>colorTransformMatrix</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>dirtyEntireOutput</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 class=heading-element id=output-beginframe><span>Output beginFrame</span>
<a href=#output-beginframe class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>调用Output的beginFrame方法，开始帧：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=n>Output</span><span class=o>::</span><span class=n>beginFrame</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span><span class=o>&amp;</span> <span class=n>outputState</span> <span class=o>=</span> <span class=n>editState</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=kt>bool</span> <span class=n>dirty</span> <span class=o>=</span> <span class=o>!</span><span class=n>getDirtyRegion</span><span class=p>().</span><span class=n>isEmpty</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=kt>bool</span> <span class=n>empty</span> <span class=o>=</span> <span class=n>getOutputLayerCount</span><span class=p>()</span> <span class=o>==</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=kt>bool</span> <span class=n>wasEmpty</span> <span class=o>=</span> <span class=o>!</span><span class=n>outputState</span><span class=p>.</span><span class=n>lastCompositionHadVisibleLayers</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=c1>// If nothing has changed (!dirty), don&#39;t recompose.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// If something changed, but we don&#39;t currently have any visible layers,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//   and didn&#39;t when we last did a composition, then skip it this time.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// The second rule does two things:
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// - When all layers are removed from a display, we&#39;ll emit one black
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//   frame, then nothing more until we get new layers.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// - When a display is created with a private layer stack, we won&#39;t
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//   emit any black frames until a layer is added to the layer stack.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>const</span> <span class=kt>bool</span> <span class=n>mustRecompose</span> <span class=o>=</span> <span class=n>dirty</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=n>empty</span> <span class=o>&amp;&amp;</span> <span class=n>wasEmpty</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=kt>char</span> <span class=n>flagPrefix</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=sc>&#39;-&#39;</span><span class=p>,</span> <span class=sc>&#39;+&#39;</span><span class=p>};</span>
</span></span><span class=line><span class=cl>    <span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>void</span><span class=o>&gt;</span><span class=p>(</span><span class=n>flagPrefix</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>ALOGV_IF</span><span class=p>(</span><span class=s>&#34;%s: %s composition for %s (%cdirty %cempty %cwasEmpty)&#34;</span><span class=p>,</span> <span class=n>__FUNCTION__</span><span class=p>,</span>
</span></span><span class=line><span class=cl>             <span class=n>mustRecompose</span> <span class=o>?</span> <span class=s>&#34;doing&#34;</span> <span class=o>:</span> <span class=s>&#34;skipping&#34;</span><span class=p>,</span> <span class=n>getName</span><span class=p>().</span><span class=n>c_str</span><span class=p>(),</span> <span class=n>flagPrefix</span><span class=p>[</span><span class=n>dirty</span><span class=p>],</span>
</span></span><span class=line><span class=cl>             <span class=n>flagPrefix</span><span class=p>[</span><span class=n>empty</span><span class=p>],</span> <span class=n>flagPrefix</span><span class=p>[</span><span class=n>wasEmpty</span><span class=p>]);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>mRenderSurface</span><span class=o>-&gt;</span><span class=n>beginFrame</span><span class=p>(</span><span class=n>mustRecompose</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>mustRecompose</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>outputState</span><span class=p>.</span><span class=n>lastCompositionHadVisibleLayers</span> <span class=o>=</span> <span class=o>!</span><span class=n>empty</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h4 class=heading-element id=rendersurface-beginframe><span>RenderSurface beginFrame</span>
<a href=#rendersurface-beginframe class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>调用mRenderSurface(RenderSurface)的beginFrame方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/RenderSurface.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>const</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>DisplaySurface</span><span class=o>&gt;</span> <span class=n>mDisplaySurface</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>status_t</span> <span class=n>RenderSurface</span><span class=o>::</span><span class=n>beginFrame</span><span class=p>(</span><span class=kt>bool</span> <span class=n>mustRecompose</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>mDisplaySurface</span><span class=o>-&gt;</span><span class=n>beginFrame</span><span class=p>(</span><span class=n>mustRecompose</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>调用mDisplaySurface(DisplaySurface)的beginFrame方法，FramebufferSurface继承DisplaySurface，调用FramebufferSurface的beginFrame方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/DisplayHardware/FramebufferSurface.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>status_t</span> <span class=n>FramebufferSurface</span><span class=o>::</span><span class=n>beginFrame</span><span class=p>(</span><span class=kt>bool</span> <span class=cm>/*mustRecompose*/</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>NO_ERROR</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h5 class=heading-element id=virtualdisplaysurface-beginframe><span>VirtualDisplaySurface beginFrame</span>
<a href=#virtualdisplaysurface-beginframe class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>调用mDisplaySurface(DisplaySurface)的beginFrame方法，VirtualDisplaySurface继承DisplaySurface，调用VirtualDisplaySurface的beginFrame方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/DisplayHardware/VirtualDisplaySurface.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>status_t</span> <span class=n>VirtualDisplaySurface</span><span class=o>::</span><span class=n>beginFrame</span><span class=p>(</span><span class=kt>bool</span> <span class=n>mustRecompose</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>GpuVirtualDisplayId</span><span class=o>::</span><span class=n>tryCast</span><span class=p>(</span><span class=n>mDisplayId</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>NO_ERROR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>mMustRecompose</span> <span class=o>=</span> <span class=n>mustRecompose</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>VDS_LOGW_IF</span><span class=p>(</span><span class=n>mDebugState</span> <span class=o>!=</span> <span class=n>DebugState</span><span class=o>::</span><span class=n>Idle</span><span class=p>,</span> <span class=s>&#34;Unexpected %s in %s state&#34;</span><span class=p>,</span> <span class=n>__func__</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>ftl</span><span class=o>::</span><span class=n>enum_string</span><span class=p>(</span><span class=n>mDebugState</span><span class=p>).</span><span class=n>c_str</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=n>mDebugState</span> <span class=o>=</span> <span class=n>DebugState</span><span class=o>::</span><span class=n>Begun</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nf>refreshOutputBuffer</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>调用VirtualDisplaySurface的refreshOutputBuffer方法，刷新输出缓冲区：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/DisplayHardware/VirtualDisplaySurface.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>HWComposer</span><span class=o>&amp;</span> <span class=n>mHwc</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>status_t</span> <span class=n>VirtualDisplaySurface</span><span class=o>::</span><span class=n>refreshOutputBuffer</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>LOG_ALWAYS_FATAL_IF</span><span class=p>(</span><span class=n>GpuVirtualDisplayId</span><span class=o>::</span><span class=n>tryCast</span><span class=p>(</span><span class=n>mDisplayId</span><span class=p>).</span><span class=n>has_value</span><span class=p>());</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>mOutputProducerSlot</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mSource</span><span class=p>[</span><span class=n>SOURCE_SINK</span><span class=p>]</span><span class=o>-&gt;</span><span class=n>cancelBuffer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>mapProducer2SourceSlot</span><span class=p>(</span><span class=n>SOURCE_SINK</span><span class=p>,</span> <span class=n>mOutputProducerSlot</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>mOutputFence</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>sslot</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>status_t</span> <span class=n>result</span> <span class=o>=</span> <span class=n>dequeueBuffer</span><span class=p>(</span><span class=n>SOURCE_SINK</span><span class=p>,</span> <span class=n>mOutputFormat</span><span class=p>,</span> <span class=n>mOutputUsage</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=n>sslot</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>mOutputFence</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>mOutputProducerSlot</span> <span class=o>=</span> <span class=n>mapSource2ProducerSlot</span><span class=p>(</span><span class=n>SOURCE_SINK</span><span class=p>,</span> <span class=n>sslot</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=c1>// On GPU-only frames, we don&#39;t have the right output buffer acquire fence
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// until after GPU calls queueBuffer(). So here we just set the buffer
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// (for use in HWC prepare) but not the fence; we&#39;ll call this again with
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// the proper fence once we have it.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>const</span> <span class=k>auto</span> <span class=n>halDisplayId</span> <span class=o>=</span> <span class=n>HalVirtualDisplayId</span><span class=o>::</span><span class=n>tryCast</span><span class=p>(</span><span class=n>mDisplayId</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>LOG_FATAL_IF</span><span class=p>(</span><span class=o>!</span><span class=n>halDisplayId</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>mHwc</span><span class=p>.</span><span class=n>setOutputBuffer</span><span class=p>(</span><span class=o>*</span><span class=n>halDisplayId</span><span class=p>,</span> <span class=n>Fence</span><span class=o>::</span><span class=n>NO_FENCE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                  <span class=n>mProducerBuffers</span><span class=p>[</span><span class=n>mOutputProducerSlot</span><span class=p>]);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h6 class=heading-element id=hwcomposer-setoutputbuffer><span>HWComposer setOutputBuffer</span>
<a href=#hwcomposer-setoutputbuffer class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h6><p>调用mHwc(HWComposer)的setOutputBuffer方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/DisplayHardware/HWComposer.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>std</span><span class=o>::</span><span class=n>unordered_map</span><span class=o>&lt;</span><span class=n>HalDisplayId</span><span class=p>,</span> <span class=n>DisplayData</span><span class=o>&gt;</span> <span class=n>mDisplayData</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>HWC2</span><span class=o>::</span><span class=n>Display</span><span class=o>&gt;</span> <span class=n>hwcDisplay</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>status_t</span> <span class=n>HWComposer</span><span class=o>::</span><span class=n>setOutputBuffer</span><span class=p>(</span><span class=n>HalVirtualDisplayId</span> <span class=n>displayId</span><span class=p>,</span> <span class=k>const</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>Fence</span><span class=o>&gt;&amp;</span> <span class=n>acquireFence</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=k>const</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>GraphicBuffer</span><span class=o>&gt;&amp;</span> <span class=n>buffer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>RETURN_IF_INVALID_DISPLAY</span><span class=p>(</span><span class=n>displayId</span><span class=p>,</span> <span class=n>BAD_INDEX</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=n>displayData</span> <span class=o>=</span> <span class=n>mDisplayData</span><span class=p>[</span><span class=n>displayId</span><span class=p>];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>error</span> <span class=o>=</span> <span class=n>displayData</span><span class=p>.</span><span class=n>hwcDisplay</span><span class=o>-&gt;</span><span class=n>setOutputBuffer</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span> <span class=n>acquireFence</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>RETURN_IF_HWC_ERROR</span><span class=p>(</span><span class=n>error</span><span class=p>,</span> <span class=n>displayId</span><span class=p>,</span> <span class=n>UNKNOWN_ERROR</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>NO_ERROR</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h6 class=heading-element id=hwc2display-setoutputbuffer><span>HWC2::Display setOutputBuffer</span>
<a href=#hwc2display-setoutputbuffer class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h6><p>调用HWC2::Display的setOutputBuffer方法，之后就是HWC的处理了。</p><h3 class=heading-element id=output-prepareframeasync><span>Output prepareFrameAsync</span>
<a href=#output-prepareframeasync class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>调用Output的prepareFrameAsync方法，准备帧数据以进行显示(Async方式)：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>GpuCompositionResult</span> <span class=n>Output</span><span class=o>::</span><span class=n>prepareFrameAsync</span><span class=p>(</span><span class=k>const</span> <span class=n>CompositionRefreshArgs</span><span class=o>&amp;</span> <span class=n>refreshArgs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ATRACE_CALL</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ALOGV</span><span class=p>(</span><span class=n>__FUNCTION__</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span><span class=o>&amp;</span> <span class=n>state</span> <span class=o>=</span> <span class=n>editState</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=n>previousChanges</span> <span class=o>=</span> <span class=n>state</span><span class=p>.</span><span class=n>previousDeviceRequestedChanges</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>optional</span><span class=o>&lt;</span><span class=n>android</span><span class=o>::</span><span class=n>HWComposer</span><span class=o>::</span><span class=n>DeviceRequestedChanges</span><span class=o>&gt;</span> <span class=n>changes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>resetCompositionStrategy</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>hwcResult</span> <span class=o>=</span> <span class=n>chooseCompositionStrategyAsync</span><span class=p>(</span><span class=o>&amp;</span><span class=n>changes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>state</span><span class=p>.</span><span class=n>previousDeviceRequestedSuccess</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>applyCompositionStrategy</span><span class=p>(</span><span class=n>previousChanges</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>finishPrepareFrame</span><span class=p>();</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>base</span><span class=o>::</span><span class=n>unique_fd</span> <span class=n>bufferFence</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>renderengine</span><span class=o>::</span><span class=n>ExternalTexture</span><span class=o>&gt;</span> <span class=n>buffer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>updateProtectedContentState</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=kt>bool</span> <span class=n>dequeueSucceeded</span> <span class=o>=</span> <span class=n>dequeueRenderBuffer</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bufferFence</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>buffer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>GpuCompositionResult</span> <span class=n>compositionResult</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>dequeueSucceeded</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>optional</span><span class=o>&lt;</span><span class=n>base</span><span class=o>::</span><span class=n>unique_fd</span><span class=o>&gt;</span> <span class=n>optFd</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=n>composeSurfaces</span><span class=p>(</span><span class=n>Region</span><span class=o>::</span><span class=n>INVALID_REGION</span><span class=p>,</span> <span class=n>refreshArgs</span><span class=p>,</span> <span class=n>buffer</span><span class=p>,</span> <span class=n>bufferFence</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>optFd</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>compositionResult</span><span class=p>.</span><span class=n>fence</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=o>*</span><span class=n>optFd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>chooseCompositionSuccess</span> <span class=o>=</span> <span class=n>hwcResult</span><span class=p>.</span><span class=n>get</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=kt>bool</span> <span class=n>predictionSucceeded</span> <span class=o>=</span> <span class=n>dequeueSucceeded</span> <span class=o>&amp;&amp;</span> <span class=n>changes</span> <span class=o>==</span> <span class=n>previousChanges</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span><span class=p>.</span><span class=n>strategyPrediction</span> <span class=o>=</span> <span class=n>predictionSucceeded</span> <span class=o>?</span> <span class=n>CompositionStrategyPredictionState</span><span class=o>::</span><span class=nl>SUCCESS</span>
</span></span><span class=line><span class=cl>                                                   <span class=p>:</span> <span class=n>CompositionStrategyPredictionState</span><span class=o>::</span><span class=n>FAIL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>predictionSucceeded</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ATRACE_NAME</span><span class=p>(</span><span class=s>&#34;CompositionStrategyPredictionMiss&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>resetCompositionStrategy</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>chooseCompositionSuccess</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>applyCompositionStrategy</span><span class=p>(</span><span class=n>changes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>finishPrepareFrame</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Track the dequeued buffer to reuse so we don&#39;t need to dequeue another one.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>compositionResult</span><span class=p>.</span><span class=n>buffer</span> <span class=o>=</span> <span class=n>buffer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ATRACE_NAME</span><span class=p>(</span><span class=s>&#34;CompositionStrategyPredictionHit&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span><span class=p>.</span><span class=n>previousDeviceRequestedChanges</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>changes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>state</span><span class=p>.</span><span class=n>previousDeviceRequestedSuccess</span> <span class=o>=</span> <span class=n>chooseCompositionSuccess</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>compositionResult</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 class=heading-element id=output-prepareframe><span>Output prepareFrame</span>
<a href=#output-prepareframe class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>调用Output的prepareFrame方法，准备帧数据以进行显示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=n>Output</span><span class=o>::</span><span class=n>prepareFrame</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ATRACE_CALL</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ALOGV</span><span class=p>(</span><span class=n>__FUNCTION__</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>auto</span><span class=o>&amp;</span> <span class=n>outputState</span> <span class=o>=</span> <span class=n>editState</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>outputState</span><span class=p>.</span><span class=n>isEnabled</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>optional</span><span class=o>&lt;</span><span class=n>android</span><span class=o>::</span><span class=n>HWComposer</span><span class=o>::</span><span class=n>DeviceRequestedChanges</span><span class=o>&gt;</span> <span class=n>changes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=n>success</span> <span class=o>=</span> <span class=n>chooseCompositionStrategy</span><span class=p>(</span><span class=o>&amp;</span><span class=n>changes</span><span class=p>);</span> <span class=c1>//向HWC询问合成策略
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>resetCompositionStrategy</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>outputState</span><span class=p>.</span><span class=n>strategyPrediction</span> <span class=o>=</span> <span class=n>CompositionStrategyPredictionState</span><span class=o>::</span><span class=n>DISABLED</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>outputState</span><span class=p>.</span><span class=n>previousDeviceRequestedChanges</span> <span class=o>=</span> <span class=n>changes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>outputState</span><span class=p>.</span><span class=n>previousDeviceRequestedSuccess</span> <span class=o>=</span> <span class=n>success</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>success</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>applyCompositionStrategy</span><span class=p>(</span><span class=n>changes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>finishPrepareFrame</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h4 class=heading-element id=output-choosecompositionstrategy><span>Output chooseCompositionStrategy</span>
<a href=#output-choosecompositionstrategy class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>调用Output的chooseCompositionStrategy方法，向HWC询问合成策略：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>HwcAsyncWorker</span><span class=o>&gt;</span> <span class=n>mHwComposerAsyncWorker</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>std</span><span class=o>::</span><span class=n>future</span><span class=o>&lt;</span><span class=kt>bool</span><span class=o>&gt;</span> <span class=n>Output</span><span class=o>::</span><span class=n>chooseCompositionStrategyAsync</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>optional</span><span class=o>&lt;</span><span class=n>android</span><span class=o>::</span><span class=n>HWComposer</span><span class=o>::</span><span class=n>DeviceRequestedChanges</span><span class=o>&gt;*</span> <span class=n>changes</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>mHwComposerAsyncWorker</span><span class=o>-&gt;</span><span class=n>send</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=o>&amp;</span><span class=p>,</span> <span class=n>changes</span><span class=p>]()</span> <span class=p>{</span> <span class=k>return</span> <span class=nf>chooseCompositionStrategy</span><span class=p>(</span><span class=n>changes</span><span class=p>);</span> <span class=p>});</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>调用mHwComposerAsyncWorker(HwcAsyncWorker)的send方法，获取合成策略：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/HwcAsyncWorker.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>std</span><span class=o>::</span><span class=n>future</span><span class=o>&lt;</span><span class=kt>bool</span><span class=o>&gt;</span> <span class=n>HwcAsyncWorker</span><span class=o>::</span><span class=n>send</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>function</span><span class=o>&lt;</span><span class=kt>bool</span><span class=p>()</span><span class=o>&gt;</span> <span class=n>task</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>unique_lock</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>mutex</span><span class=o>&gt;</span> <span class=n>lock</span><span class=p>(</span><span class=n>mMutex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>android</span><span class=o>::</span><span class=n>base</span><span class=o>::</span><span class=n>ScopedLockAssertion</span> <span class=n>assumeLock</span><span class=p>(</span><span class=n>mMutex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>mTask</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>packaged_task</span><span class=o>&lt;</span><span class=kt>bool</span><span class=p>()</span><span class=o>&gt;</span><span class=p>([</span><span class=n>task</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>task</span><span class=p>)]()</span> <span class=p>{</span> <span class=k>return</span> <span class=nf>task</span><span class=p>();</span> <span class=p>});</span>
</span></span><span class=line><span class=cl>    <span class=n>mTaskRequested</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>mCv</span><span class=p>.</span><span class=n>notify_one</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>mTask</span><span class=p>.</span><span class=n>get_future</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>返回chooseCompositionStrategy：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/Display.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>bool</span> <span class=n>Display</span><span class=o>::</span><span class=n>chooseCompositionStrategy</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>optional</span><span class=o>&lt;</span><span class=n>android</span><span class=o>::</span><span class=n>HWComposer</span><span class=o>::</span><span class=n>DeviceRequestedChanges</span><span class=o>&gt;*</span> <span class=n>outChanges</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ATRACE_CALL</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ALOGV</span><span class=p>(</span><span class=n>__FUNCTION__</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>mIsDisconnected</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=c1>// If we don&#39;t have a HWC display, then we are done.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>const</span> <span class=k>auto</span> <span class=n>halDisplayId</span> <span class=o>=</span> <span class=n>HalDisplayId</span><span class=o>::</span><span class=n>tryCast</span><span class=p>(</span><span class=n>mId</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>halDisplayId</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=c1>// Get any composition changes requested by the HWC device, and apply them.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>std</span><span class=o>::</span><span class=n>optional</span><span class=o>&lt;</span><span class=n>android</span><span class=o>::</span><span class=n>HWComposer</span><span class=o>::</span><span class=n>DeviceRequestedChanges</span><span class=o>&gt;</span> <span class=n>changes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span><span class=o>&amp;</span> <span class=n>hwc</span> <span class=o>=</span> <span class=n>getCompositionEngine</span><span class=p>().</span><span class=n>getHwComposer</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>status_t</span> <span class=n>result</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=n>hwc</span><span class=p>.</span><span class=n>getDeviceCompositionChanges</span><span class=p>(</span><span class=o>*</span><span class=n>halDisplayId</span><span class=p>,</span> <span class=n>anyLayersRequireClientComposition</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                                                <span class=n>getState</span><span class=p>().</span><span class=n>earliestPresentTime</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                <span class=n>getState</span><span class=p>().</span><span class=n>previousPresentFence</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                                <span class=n>getState</span><span class=p>().</span><span class=n>expectedPresentTime</span><span class=p>,</span> <span class=n>outChanges</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span> <span class=o>!=</span> <span class=n>NO_ERROR</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ALOGE</span><span class=p>(</span><span class=s>&#34;chooseCompositionStrategy failed for %s: %d (%s)&#34;</span><span class=p>,</span> <span class=n>getName</span><span class=p>().</span><span class=n>c_str</span><span class=p>(),</span> <span class=n>result</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>strerror</span><span class=p>(</span><span class=o>-</span><span class=n>result</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h5 class=heading-element id=hwcomposer-getdevicecompositionchanges><span>HWComposer getDeviceCompositionChanges</span>
<a href=#hwcomposer-getdevicecompositionchanges class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>调用hwc(HWComposer)的getDeviceCompositionChanges方法，向HWC获取合成策略：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/DisplayHardware/HWComposer.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>status_t</span> <span class=n>HWComposer</span><span class=o>::</span><span class=n>getDeviceCompositionChanges</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>HalDisplayId</span> <span class=n>displayId</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>frameUsesClientComposition</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>steady_clock</span><span class=o>::</span><span class=n>time_point</span> <span class=n>earliestPresentTime</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>FenceTime</span><span class=o>&gt;&amp;</span> <span class=n>previousPresentFence</span><span class=p>,</span> <span class=n>nsecs_t</span> <span class=n>expectedPresentTime</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>std</span><span class=o>::</span><span class=n>optional</span><span class=o>&lt;</span><span class=n>android</span><span class=o>::</span><span class=n>HWComposer</span><span class=o>::</span><span class=n>DeviceRequestedChanges</span><span class=o>&gt;*</span> <span class=n>outChanges</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ATRACE_CALL</span><span class=p>();</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>RETURN_IF_INVALID_DISPLAY</span><span class=p>(</span><span class=n>displayId</span><span class=p>,</span> <span class=n>BAD_INDEX</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>auto</span><span class=o>&amp;</span> <span class=n>displayData</span> <span class=o>=</span> <span class=n>mDisplayData</span><span class=p>[</span><span class=n>displayId</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span><span class=o>&amp;</span> <span class=n>hwcDisplay</span> <span class=o>=</span> <span class=n>displayData</span><span class=p>.</span><span class=n>hwcDisplay</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>hwcDisplay</span><span class=o>-&gt;</span><span class=n>isConnected</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>NO_ERROR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>numTypes</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>numRequests</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>hal</span><span class=o>::</span><span class=n>Error</span> <span class=n>error</span> <span class=o>=</span> <span class=n>hal</span><span class=o>::</span><span class=n>Error</span><span class=o>::</span><span class=n>NONE</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=c1>// First try to skip validate altogether. We can do that when
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 1. The previous frame has not been presented yet or already passed the
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// earliest time to present. Otherwise, we may present a frame too early.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// 2. There is no client composition. Otherwise, we first need to render the
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// client target buffer.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>const</span> <span class=kt>bool</span> <span class=n>canSkipValidate</span> <span class=o>=</span> <span class=p>[</span><span class=o>&amp;</span><span class=p>]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// We must call validate if we have client composition
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>frameUsesClientComposition</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=c1>// If composer supports getting the expected present time, we can skip
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// as composer will make sure to prevent early presentation
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>mComposer</span><span class=o>-&gt;</span><span class=n>isSupported</span><span class=p>(</span><span class=n>Hwc2</span><span class=o>::</span><span class=n>Composer</span><span class=o>::</span><span class=n>OptionalFeature</span><span class=o>::</span><span class=n>ExpectedPresentTime</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=c1>// composer doesn&#39;t support getting the expected present time. We can only
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// skip validate if we know that we are not going to present early.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=n>std</span><span class=o>::</span><span class=n>chrono</span><span class=o>::</span><span class=n>steady_clock</span><span class=o>::</span><span class=n>now</span><span class=p>()</span> <span class=o>&gt;=</span> <span class=n>earliestPresentTime</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>                <span class=n>previousPresentFence</span><span class=o>-&gt;</span><span class=n>getSignalTime</span><span class=p>()</span> <span class=o>==</span> <span class=n>Fence</span><span class=o>::</span><span class=n>SIGNAL_TIME_PENDING</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}();</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>displayData</span><span class=p>.</span><span class=n>validateWasSkipped</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>canSkipValidate</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>sp</span><span class=o>&lt;</span><span class=n>Fence</span><span class=o>&gt;</span> <span class=n>outPresentFence</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kt>uint32_t</span> <span class=n>state</span> <span class=o>=</span> <span class=n>UINT32_MAX</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>error</span> <span class=o>=</span> <span class=n>hwcDisplay</span><span class=o>-&gt;</span><span class=n>presentOrValidate</span><span class=p>(</span><span class=n>expectedPresentTime</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>numTypes</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>numRequests</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                              <span class=o>&amp;</span><span class=n>outPresentFence</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>state</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>hasChangesError</span><span class=p>(</span><span class=n>error</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>RETURN_IF_HWC_ERROR_FOR</span><span class=p>(</span><span class=s>&#34;presentOrValidate&#34;</span><span class=p>,</span> <span class=n>error</span><span class=p>,</span> <span class=n>displayId</span><span class=p>,</span> <span class=n>UNKNOWN_ERROR</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>state</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span> <span class=c1>//Present Succeeded.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>std</span><span class=o>::</span><span class=n>unordered_map</span><span class=o>&lt;</span><span class=n>HWC2</span><span class=o>::</span><span class=n>Layer</span><span class=o>*</span><span class=p>,</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>Fence</span><span class=o>&gt;&gt;</span> <span class=n>releaseFences</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>error</span> <span class=o>=</span> <span class=n>hwcDisplay</span><span class=o>-&gt;</span><span class=n>getReleaseFences</span><span class=p>(</span><span class=o>&amp;</span><span class=n>releaseFences</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>displayData</span><span class=p>.</span><span class=n>releaseFences</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>releaseFences</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>displayData</span><span class=p>.</span><span class=n>lastPresentFence</span> <span class=o>=</span> <span class=n>outPresentFence</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>displayData</span><span class=p>.</span><span class=n>validateWasSkipped</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>displayData</span><span class=p>.</span><span class=n>presentError</span> <span class=o>=</span> <span class=n>error</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>NO_ERROR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Present failed but Validate ran.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>error</span> <span class=o>=</span> <span class=n>hwcDisplay</span><span class=o>-&gt;</span><span class=n>validate</span><span class=p>(</span><span class=n>expectedPresentTime</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>numTypes</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>numRequests</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>ALOGV</span><span class=p>(</span><span class=s>&#34;SkipValidate failed, Falling back to SLOW validate/present&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>hasChangesError</span><span class=p>(</span><span class=n>error</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>RETURN_IF_HWC_ERROR_FOR</span><span class=p>(</span><span class=s>&#34;validate&#34;</span><span class=p>,</span> <span class=n>error</span><span class=p>,</span> <span class=n>displayId</span><span class=p>,</span> <span class=n>BAD_INDEX</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>android</span><span class=o>::</span><span class=n>HWComposer</span><span class=o>::</span><span class=n>DeviceRequestedChanges</span><span class=o>::</span><span class=n>ChangedTypes</span> <span class=n>changedTypes</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>changedTypes</span><span class=p>.</span><span class=n>reserve</span><span class=p>(</span><span class=n>numTypes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>error</span> <span class=o>=</span> <span class=n>hwcDisplay</span><span class=o>-&gt;</span><span class=n>getChangedCompositionTypes</span><span class=p>(</span><span class=o>&amp;</span><span class=n>changedTypes</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>RETURN_IF_HWC_ERROR_FOR</span><span class=p>(</span><span class=s>&#34;getChangedCompositionTypes&#34;</span><span class=p>,</span> <span class=n>error</span><span class=p>,</span> <span class=n>displayId</span><span class=p>,</span> <span class=n>BAD_INDEX</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>displayRequests</span> <span class=o>=</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=n>hal</span><span class=o>::</span><span class=n>DisplayRequest</span><span class=o>&gt;</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>android</span><span class=o>::</span><span class=n>HWComposer</span><span class=o>::</span><span class=n>DeviceRequestedChanges</span><span class=o>::</span><span class=n>LayerRequests</span> <span class=n>layerRequests</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>layerRequests</span><span class=p>.</span><span class=n>reserve</span><span class=p>(</span><span class=n>numRequests</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>error</span> <span class=o>=</span> <span class=n>hwcDisplay</span><span class=o>-&gt;</span><span class=n>getRequests</span><span class=p>(</span><span class=o>&amp;</span><span class=n>displayRequests</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>layerRequests</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>RETURN_IF_HWC_ERROR_FOR</span><span class=p>(</span><span class=s>&#34;getRequests&#34;</span><span class=p>,</span> <span class=n>error</span><span class=p>,</span> <span class=n>displayId</span><span class=p>,</span> <span class=n>BAD_INDEX</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>DeviceRequestedChanges</span><span class=o>::</span><span class=n>ClientTargetProperty</span> <span class=n>clientTargetProperty</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>error</span> <span class=o>=</span> <span class=n>hwcDisplay</span><span class=o>-&gt;</span><span class=n>getClientTargetProperty</span><span class=p>(</span><span class=o>&amp;</span><span class=n>clientTargetProperty</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>outChanges</span><span class=o>-&gt;</span><span class=n>emplace</span><span class=p>(</span><span class=n>DeviceRequestedChanges</span><span class=p>{</span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>changedTypes</span><span class=p>),</span> <span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>displayRequests</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                                               <span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>layerRequests</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                                               <span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>clientTargetProperty</span><span class=p>)});</span>
</span></span><span class=line><span class=cl>    <span class=n>error</span> <span class=o>=</span> <span class=n>hwcDisplay</span><span class=o>-&gt;</span><span class=n>acceptChanges</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>RETURN_IF_HWC_ERROR_FOR</span><span class=p>(</span><span class=s>&#34;acceptChanges&#34;</span><span class=p>,</span> <span class=n>error</span><span class=p>,</span> <span class=n>displayId</span><span class=p>,</span> <span class=n>BAD_INDEX</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>NO_ERROR</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 class=heading-element id=output-devoptrepaintflash><span>Output devOptRepaintFlash</span>
<a href=#output-devoptrepaintflash class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>调用Output的devOptRepaintFlash方法，处理显示输出设备的可选重绘闪烁：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=n>Output</span><span class=o>::</span><span class=n>devOptRepaintFlash</span><span class=p>(</span><span class=k>const</span> <span class=n>compositionengine</span><span class=o>::</span><span class=n>CompositionRefreshArgs</span><span class=o>&amp;</span> <span class=n>refreshArgs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>CC_LIKELY</span><span class=p>(</span><span class=o>!</span><span class=n>refreshArgs</span><span class=p>.</span><span class=n>devOptFlashDirtyRegionsDelay</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>getState</span><span class=p>().</span><span class=n>isEnabled</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>const</span> <span class=k>auto</span> <span class=n>dirtyRegion</span> <span class=o>=</span> <span class=n>getDirtyRegion</span><span class=p>();</span> <span class=o>!</span><span class=n>dirtyRegion</span><span class=p>.</span><span class=n>isEmpty</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>base</span><span class=o>::</span><span class=n>unique_fd</span> <span class=n>bufferFence</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>renderengine</span><span class=o>::</span><span class=n>ExternalTexture</span><span class=o>&gt;</span> <span class=n>buffer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>updateProtectedContentState</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=n>dequeueRenderBuffer</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bufferFence</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>buffer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>void</span><span class=o>&gt;</span><span class=p>(</span><span class=n>composeSurfaces</span><span class=p>(</span><span class=n>dirtyRegion</span><span class=p>,</span> <span class=n>refreshArgs</span><span class=p>,</span> <span class=n>buffer</span><span class=p>,</span> <span class=n>bufferFence</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=n>mRenderSurface</span><span class=o>-&gt;</span><span class=n>queueBuffer</span><span class=p>(</span><span class=n>base</span><span class=o>::</span><span class=n>unique_fd</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>postFramebuffer</span><span class=p>();</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>this_thread</span><span class=o>::</span><span class=n>sleep_for</span><span class=p>(</span><span class=o>*</span><span class=n>refreshArgs</span><span class=p>.</span><span class=n>devOptFlashDirtyRegionsDelay</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>prepareFrame</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h4 class=heading-element id=rendersurface-queuebuffer><span>RenderSurface queueBuffer</span>
<a href=#rendersurface-queuebuffer class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>调用mRenderSurface(RenderSurface)的queueBuffer方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/RenderSurface.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=n>RenderSurface</span><span class=o>::</span><span class=n>queueBuffer</span><span class=p>(</span><span class=n>base</span><span class=o>::</span><span class=n>unique_fd</span> <span class=n>readyFence</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span><span class=o>&amp;</span> <span class=n>state</span> <span class=o>=</span> <span class=n>mDisplay</span><span class=p>.</span><span class=n>getState</span><span class=p>();</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>state</span><span class=p>.</span><span class=n>usesClientComposition</span> <span class=o>||</span> <span class=n>state</span><span class=p>.</span><span class=n>flipClientTarget</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// hasFlipClientTargetRequest could return true even if we haven&#39;t
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// dequeued a buffer before. Try dequeueing one if we don&#39;t have a
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// buffer ready.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>mTexture</span> <span class=o>==</span> <span class=k>nullptr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ALOGI</span><span class=p>(</span><span class=s>&#34;Attempting to queue a client composited buffer without one &#34;</span>
</span></span><span class=line><span class=cl>                  <span class=s>&#34;previously dequeued for display [%s]. Attempting to dequeue &#34;</span>
</span></span><span class=line><span class=cl>                  <span class=s>&#34;a scratch buffer now&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                  <span class=n>mDisplay</span><span class=p>.</span><span class=n>getName</span><span class=p>().</span><span class=n>c_str</span><span class=p>());</span>
</span></span><span class=line><span class=cl>            <span class=c1>// We shouldn&#39;t deadlock here, since mTexture == nullptr only
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// after a successful call to queueBuffer, or if dequeueBuffer has
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// never been called.
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>base</span><span class=o>::</span><span class=n>unique_fd</span> <span class=n>unused</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>dequeueBuffer</span><span class=p>(</span><span class=o>&amp;</span><span class=n>unused</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>mTexture</span> <span class=o>==</span> <span class=k>nullptr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ALOGE</span><span class=p>(</span><span class=s>&#34;No buffer is ready for display [%s]&#34;</span><span class=p>,</span> <span class=n>mDisplay</span><span class=p>.</span><span class=n>getName</span><span class=p>().</span><span class=n>c_str</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>status_t</span> <span class=n>result</span> <span class=o>=</span> <span class=n>mNativeWindow</span><span class=o>-&gt;</span><span class=n>queueBuffer</span><span class=p>(</span><span class=n>mNativeWindow</span><span class=p>.</span><span class=n>get</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                                                         <span class=n>mTexture</span><span class=o>-&gt;</span><span class=n>getBuffer</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>getNativeBuffer</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                                                         <span class=n>dup</span><span class=p>(</span><span class=n>readyFence</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>!=</span> <span class=n>NO_ERROR</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>ALOGE</span><span class=p>(</span><span class=s>&#34;Error when queueing buffer for display [%s]: %d&#34;</span><span class=p>,</span> <span class=n>mDisplay</span><span class=p>.</span><span class=n>getName</span><span class=p>().</span><span class=n>c_str</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                      <span class=n>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=c1>// We risk blocking on dequeueBuffer if the primary display failed
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=c1>// to queue up its buffer, so crash here.
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>mDisplay</span><span class=p>.</span><span class=n>isVirtual</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>LOG_ALWAYS_FATAL</span><span class=p>(</span><span class=s>&#34;ANativeWindow::queueBuffer failed with error: %d&#34;</span><span class=p>,</span> <span class=n>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>mNativeWindow</span><span class=o>-&gt;</span><span class=n>cancelBuffer</span><span class=p>(</span><span class=n>mNativeWindow</span><span class=p>.</span><span class=n>get</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                                                <span class=n>mTexture</span><span class=o>-&gt;</span><span class=n>getBuffer</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>getNativeBuffer</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>                                                <span class=n>dup</span><span class=p>(</span><span class=n>readyFence</span><span class=p>));</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>            <span class=n>mTexture</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>status_t</span> <span class=n>result</span> <span class=o>=</span> <span class=n>mDisplaySurface</span><span class=o>-&gt;</span><span class=n>advanceFrame</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>!=</span> <span class=n>NO_ERROR</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ALOGE</span><span class=p>(</span><span class=s>&#34;[%s] failed pushing new frame to HWC: %d&#34;</span><span class=p>,</span> <span class=n>mDisplay</span><span class=p>.</span><span class=n>getName</span><span class=p>().</span><span class=n>c_str</span><span class=p>(),</span> <span class=n>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h5 class=heading-element id=framebuffersurface-advanceframe><span>FramebufferSurface advanceFrame</span>
<a href=#framebuffersurface-advanceframe class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>调用mDisplaySurface(DisplaySurface)的advanceFrame方法，FramebufferSurface继承与DisplaySurface，调用FramebufferSurface的advanceFrame方法，FramebufferSurface的advanceFrame方法用于更新帧并将其显示在屏幕上</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/DisplayHardware/FramebufferSurface.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>status_t</span> <span class=n>FramebufferSurface</span><span class=o>::</span><span class=n>advanceFrame</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint32_t</span> <span class=n>slot</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>sp</span><span class=o>&lt;</span><span class=n>GraphicBuffer</span><span class=o>&gt;</span> <span class=n>buf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>sp</span><span class=o>&lt;</span><span class=n>Fence</span><span class=o>&gt;</span> <span class=n>acquireFence</span><span class=p>(</span><span class=n>Fence</span><span class=o>::</span><span class=n>NO_FENCE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Dataspace</span> <span class=n>dataspace</span> <span class=o>=</span> <span class=n>Dataspace</span><span class=o>::</span><span class=n>UNKNOWN</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>status_t</span> <span class=n>result</span> <span class=o>=</span> <span class=n>nextBuffer</span><span class=p>(</span><span class=n>slot</span><span class=p>,</span> <span class=n>buf</span><span class=p>,</span> <span class=n>acquireFence</span><span class=p>,</span> <span class=n>dataspace</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>mDataSpace</span> <span class=o>=</span> <span class=n>dataspace</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>!=</span> <span class=n>NO_ERROR</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ALOGE</span><span class=p>(</span><span class=s>&#34;error latching next FramebufferSurface buffer: %s (%d)&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>strerror</span><span class=p>(</span><span class=o>-</span><span class=n>result</span><span class=p>),</span> <span class=n>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>调用FramebufferSurface的nextBuffer方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/DisplayHardware/FramebufferSurface.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>status_t</span> <span class=n>FramebufferSurface</span><span class=o>::</span><span class=n>nextBuffer</span><span class=p>(</span><span class=kt>uint32_t</span><span class=o>&amp;</span> <span class=n>outSlot</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>sp</span><span class=o>&lt;</span><span class=n>GraphicBuffer</span><span class=o>&gt;&amp;</span> <span class=n>outBuffer</span><span class=p>,</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>Fence</span><span class=o>&gt;&amp;</span> <span class=n>outFence</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=n>Dataspace</span><span class=o>&amp;</span> <span class=n>outDataspace</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Mutex</span><span class=o>::</span><span class=n>Autolock</span> <span class=n>lock</span><span class=p>(</span><span class=n>mMutex</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>BufferItem</span> <span class=n>item</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>status_t</span> <span class=n>err</span> <span class=o>=</span> <span class=n>acquireBufferLocked</span><span class=p>(</span><span class=o>&amp;</span><span class=n>item</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>err</span> <span class=o>==</span> <span class=n>BufferQueue</span><span class=o>::</span><span class=n>NO_BUFFER_AVAILABLE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mHwcBufferCache</span><span class=p>.</span><span class=n>getHwcBuffer</span><span class=p>(</span><span class=n>mCurrentBufferSlot</span><span class=p>,</span> <span class=n>mCurrentBuffer</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>outSlot</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>outBuffer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>NO_ERROR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=nf>if</span> <span class=p>(</span><span class=n>err</span> <span class=o>!=</span> <span class=n>NO_ERROR</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ALOGE</span><span class=p>(</span><span class=s>&#34;error acquiring buffer: %s (%d)&#34;</span><span class=p>,</span> <span class=n>strerror</span><span class=p>(</span><span class=o>-</span><span class=n>err</span><span class=p>),</span> <span class=n>err</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>err</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=c1>// If the BufferQueue has freed and reallocated a buffer in mCurrentSlot
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// then we may have acquired the slot we already own.  If we had released
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// our current buffer before we call acquireBuffer then that release call
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// would have returned STALE_BUFFER_SLOT, and we would have called
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// freeBufferLocked on that slot.  Because the buffer slot has already
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// been overwritten with the new buffer all we have to do is skip the
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// releaseBuffer call and we should be in the same state we&#39;d be in if we
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// had released the old buffer first.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>if</span> <span class=p>(</span><span class=n>mCurrentBufferSlot</span> <span class=o>!=</span> <span class=n>BufferQueue</span><span class=o>::</span><span class=n>INVALID_BUFFER_SLOT</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=n>item</span><span class=p>.</span><span class=n>mSlot</span> <span class=o>!=</span> <span class=n>mCurrentBufferSlot</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mHasPendingRelease</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>mPreviousBufferSlot</span> <span class=o>=</span> <span class=n>mCurrentBufferSlot</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>mPreviousBuffer</span> <span class=o>=</span> <span class=n>mCurrentBuffer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>mCurrentBufferSlot</span> <span class=o>=</span> <span class=n>item</span><span class=p>.</span><span class=n>mSlot</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>mCurrentBuffer</span> <span class=o>=</span> <span class=n>mSlots</span><span class=p>[</span><span class=n>mCurrentBufferSlot</span><span class=p>].</span><span class=n>mGraphicBuffer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>mCurrentFence</span> <span class=o>=</span> <span class=n>item</span><span class=p>.</span><span class=n>mFence</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>outFence</span> <span class=o>=</span> <span class=n>item</span><span class=p>.</span><span class=n>mFence</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>mHwcBufferCache</span><span class=p>.</span><span class=n>getHwcBuffer</span><span class=p>(</span><span class=n>mCurrentBufferSlot</span><span class=p>,</span> <span class=n>mCurrentBuffer</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>outSlot</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>outBuffer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>outDataspace</span> <span class=o>=</span> <span class=k>static_cast</span><span class=o>&lt;</span><span class=n>Dataspace</span><span class=o>&gt;</span><span class=p>(</span><span class=n>item</span><span class=p>.</span><span class=n>mDataSpace</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>status_t</span> <span class=n>result</span> <span class=o>=</span> <span class=n>mHwc</span><span class=p>.</span><span class=n>setClientTarget</span><span class=p>(</span><span class=n>mDisplayId</span><span class=p>,</span> <span class=n>outSlot</span><span class=p>,</span> <span class=n>outFence</span><span class=p>,</span> <span class=n>outBuffer</span><span class=p>,</span> <span class=n>outDataspace</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>!=</span> <span class=n>NO_ERROR</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ALOGE</span><span class=p>(</span><span class=s>&#34;error posting framebuffer: %d&#34;</span><span class=p>,</span> <span class=n>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>NO_ERROR</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h6 class=heading-element id=hwcomposer-setclienttarget><span>HWComposer setClientTarget</span>
<a href=#hwcomposer-setclienttarget class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h6><p>调用mHwc(HWComposer)的setClientTarget方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/DisplayHardware/HWComposer.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>std</span><span class=o>::</span><span class=n>unordered_map</span><span class=o>&lt;</span><span class=n>HalDisplayId</span><span class=p>,</span> <span class=n>DisplayData</span><span class=o>&gt;</span> <span class=n>mDisplayData</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>HWC2</span><span class=o>::</span><span class=n>Display</span><span class=o>&gt;</span> <span class=n>hwcDisplay</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>status_t</span> <span class=n>HWComposer</span><span class=o>::</span><span class=n>setClientTarget</span><span class=p>(</span><span class=n>HalDisplayId</span> <span class=n>displayId</span><span class=p>,</span> <span class=kt>uint32_t</span> <span class=n>slot</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=k>const</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>Fence</span><span class=o>&gt;&amp;</span> <span class=n>acquireFence</span><span class=p>,</span> <span class=k>const</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>GraphicBuffer</span><span class=o>&gt;&amp;</span> <span class=n>target</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=n>ui</span><span class=o>::</span><span class=n>Dataspace</span> <span class=n>dataspace</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>RETURN_IF_INVALID_DISPLAY</span><span class=p>(</span><span class=n>displayId</span><span class=p>,</span> <span class=n>BAD_INDEX</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>ALOGV</span><span class=p>(</span><span class=s>&#34;%s for display %s&#34;</span><span class=p>,</span> <span class=n>__FUNCTION__</span><span class=p>,</span> <span class=n>to_string</span><span class=p>(</span><span class=n>displayId</span><span class=p>).</span><span class=n>c_str</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span><span class=o>&amp;</span> <span class=n>hwcDisplay</span> <span class=o>=</span> <span class=n>mDisplayData</span><span class=p>[</span><span class=n>displayId</span><span class=p>].</span><span class=n>hwcDisplay</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>error</span> <span class=o>=</span> <span class=n>hwcDisplay</span><span class=o>-&gt;</span><span class=n>setClientTarget</span><span class=p>(</span><span class=n>slot</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span> <span class=n>acquireFence</span><span class=p>,</span> <span class=n>dataspace</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>RETURN_IF_HWC_ERROR</span><span class=p>(</span><span class=n>error</span><span class=p>,</span> <span class=n>displayId</span><span class=p>,</span> <span class=n>BAD_VALUE</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>NO_ERROR</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h6 class=heading-element id=hwc2display-setoutputbuffer-1><span>HWC2::Display setOutputBuffer</span>
<a href=#hwc2display-setoutputbuffer-1 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h6><p>调用HWC2::Display的setClientTarget方法，之后就是HWC的处理了。</p><h3 class=heading-element id=output-finishframe><span>Output finishFrame</span>
<a href=#output-finishframe class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>调用Output的finishFrame方法，完成帧：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=n>Output</span><span class=o>::</span><span class=n>finishFrame</span><span class=p>(</span><span class=k>const</span> <span class=n>CompositionRefreshArgs</span><span class=o>&amp;</span> <span class=n>refreshArgs</span><span class=p>,</span> <span class=n>GpuCompositionResult</span><span class=o>&amp;&amp;</span> <span class=n>result</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ATRACE_CALL</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ALOGV</span><span class=p>(</span><span class=n>__FUNCTION__</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=n>outputState</span> <span class=o>=</span> <span class=n>getState</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>outputState</span><span class=p>.</span><span class=n>isEnabled</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>optional</span><span class=o>&lt;</span><span class=n>base</span><span class=o>::</span><span class=n>unique_fd</span><span class=o>&gt;</span> <span class=n>optReadyFence</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>std</span><span class=o>::</span><span class=n>shared_ptr</span><span class=o>&lt;</span><span class=n>renderengine</span><span class=o>::</span><span class=n>ExternalTexture</span><span class=o>&gt;</span> <span class=n>buffer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>base</span><span class=o>::</span><span class=n>unique_fd</span> <span class=n>bufferFence</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>outputState</span><span class=p>.</span><span class=n>strategyPrediction</span> <span class=o>==</span> <span class=n>CompositionStrategyPredictionState</span><span class=o>::</span><span class=n>SUCCESS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>optReadyFence</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=n>fence</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=n>bufferAvailable</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>buffer</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=n>buffer</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>bufferFence</span> <span class=o>=</span> <span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=n>fence</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>updateProtectedContentState</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>dequeueRenderBuffer</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bufferFence</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>buffer</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Repaint the framebuffer (if needed), getting the optional fence for when
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// the composition completes.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>optReadyFence</span> <span class=o>=</span> <span class=n>composeSurfaces</span><span class=p>(</span><span class=n>Region</span><span class=o>::</span><span class=n>INVALID_REGION</span><span class=p>,</span> <span class=n>refreshArgs</span><span class=p>,</span> <span class=n>buffer</span><span class=p>,</span> <span class=n>bufferFence</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>optReadyFence</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=c1>// swap buffers (presentation)
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mRenderSurface</span><span class=o>-&gt;</span><span class=n>queueBuffer</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=o>*</span><span class=n>optReadyFence</span><span class=p>));</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 class=heading-element id=output-postframebuffer><span>Output postFramebuffer</span>
<a href=#output-postframebuffer class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>调用Output的postFramebuffer方法，将帧缓冲区（framebuffer）的内容发送到显示设备进行显示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=n>Output</span><span class=o>::</span><span class=n>postFramebuffer</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ATRACE_CALL</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>ALOGV</span><span class=p>(</span><span class=n>__FUNCTION__</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>getState</span><span class=p>().</span><span class=n>isEnabled</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>auto</span><span class=o>&amp;</span> <span class=n>outputState</span> <span class=o>=</span> <span class=n>editState</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>outputState</span><span class=p>.</span><span class=n>dirtyRegion</span><span class=p>.</span><span class=n>clear</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>mRenderSurface</span><span class=o>-&gt;</span><span class=n>flip</span><span class=p>();</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>frame</span> <span class=o>=</span> <span class=n>presentAndGetFrameFences</span><span class=p>();</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>mRenderSurface</span><span class=o>-&gt;</span><span class=n>onPresentDisplayCompleted</span><span class=p>();</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=k>auto</span><span class=o>*</span> <span class=nl>layer</span> <span class=p>:</span> <span class=n>getOutputLayersOrderedByZ</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// The layer buffer from the previous frame (if any) is released
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// by HWC only when the release fence from this frame (if any) is
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// signaled.  Always get the release fence from HWC first.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>sp</span><span class=o>&lt;</span><span class=n>Fence</span><span class=o>&gt;</span> <span class=n>releaseFence</span> <span class=o>=</span> <span class=n>Fence</span><span class=o>::</span><span class=n>NO_FENCE</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>auto</span> <span class=n>hwcLayer</span> <span class=o>=</span> <span class=n>layer</span><span class=o>-&gt;</span><span class=n>getHwcLayer</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=k>auto</span> <span class=n>f</span> <span class=o>=</span> <span class=n>frame</span><span class=p>.</span><span class=n>layerFences</span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=n>hwcLayer</span><span class=p>);</span> <span class=n>f</span> <span class=o>!=</span> <span class=n>frame</span><span class=p>.</span><span class=n>layerFences</span><span class=p>.</span><span class=n>end</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>releaseFence</span> <span class=o>=</span> <span class=n>f</span><span class=o>-&gt;</span><span class=n>second</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=c1>// If the layer was client composited in the previous frame, we
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// need to merge with the previous client target acquire fence.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// Since we do not track that, always merge with the current
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// client target acquire fence when it is available, even though
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// this is suboptimal.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// TODO(b/121291683): Track previous frame client target acquire fence.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>if</span> <span class=p>(</span><span class=n>outputState</span><span class=p>.</span><span class=n>usesClientComposition</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>releaseFence</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                    <span class=n>Fence</span><span class=o>::</span><span class=n>merge</span><span class=p>(</span><span class=s>&#34;LayerRelease&#34;</span><span class=p>,</span> <span class=n>releaseFence</span><span class=p>,</span> <span class=n>frame</span><span class=p>.</span><span class=n>clientTargetAcquireFence</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>layer</span><span class=o>-&gt;</span><span class=n>getLayerFE</span><span class=p>().</span><span class=n>onLayerDisplayed</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>ftl</span><span class=o>::</span><span class=n>yield</span><span class=o>&lt;</span><span class=n>FenceResult</span><span class=o>&gt;</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>releaseFence</span><span class=p>)).</span><span class=n>share</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=c1>// We&#39;ve got a list of layers needing fences, that are disjoint with
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// OutputLayersOrderedByZ.  The best we can do is to
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// supply them with the present fence.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>for</span> <span class=p>(</span><span class=k>auto</span><span class=o>&amp;</span> <span class=nl>weakLayer</span> <span class=p>:</span> <span class=n>mReleasedLayers</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=k>const</span> <span class=k>auto</span> <span class=n>layer</span> <span class=o>=</span> <span class=n>weakLayer</span><span class=p>.</span><span class=n>promote</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>layer</span><span class=o>-&gt;</span><span class=n>onLayerDisplayed</span><span class=p>(</span><span class=n>ftl</span><span class=o>::</span><span class=n>yield</span><span class=o>&lt;</span><span class=n>FenceResult</span><span class=o>&gt;</span><span class=p>(</span><span class=n>frame</span><span class=p>.</span><span class=n>presentFence</span><span class=p>).</span><span class=n>share</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=c1>// Clear out the released layers now that we&#39;re done with them.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>mReleasedLayers</span><span class=p>.</span><span class=n>clear</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>上面方法主要处理如下：</p><p>1、调用Output的presentAndGetFrameFences方法，通过presentAndGetReleaseFences显示获取releaseFences。</p><p>2、调用BufferQueueLayer的onLayerDisplayed方法。</p><p>下面分别进行分析。</p><h4 class=heading-element id=output-presentandgetframefences><span>Output presentAndGetFrameFences</span>
<a href=#output-presentandgetframefences class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>调用Output的presentAndGetFrameFences方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>compositionengine</span><span class=o>::</span><span class=n>Output</span><span class=o>::</span><span class=n>FrameFences</span> <span class=n>Output</span><span class=o>::</span><span class=n>presentAndGetFrameFences</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>compositionengine</span><span class=o>::</span><span class=n>Output</span><span class=o>::</span><span class=n>FrameFences</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>getState</span><span class=p>().</span><span class=n>usesClientComposition</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>result</span><span class=p>.</span><span class=n>clientTargetAcquireFence</span> <span class=o>=</span> <span class=n>mRenderSurface</span><span class=o>-&gt;</span><span class=n>getClientTargetAcquireFence</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>调用mRenderSurface(RenderSurface)的getClientTargetAcquireFence方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/RenderSurface.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>const</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>DisplaySurface</span><span class=o>&gt;</span> <span class=n>mDisplaySurface</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>const</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>Fence</span><span class=o>&gt;&amp;</span> <span class=n>RenderSurface</span><span class=o>::</span><span class=n>getClientTargetAcquireFence</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>mDisplaySurface</span><span class=o>-&gt;</span><span class=n>getClientTargetAcquireFence</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h5 class=heading-element id=framebuffersurface-getclienttargetacquirefence><span>FramebufferSurface getClientTargetAcquireFence</span>
<a href=#framebuffersurface-getclienttargetacquirefence class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>调用mDisplaySurface(DisplaySurface)的prepareFrame方法，FramebufferSurface 继承于DisplaySurface，因此调用FramebufferSurface的getClientTargetAcquireFence方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/DisplayHardware/FramebufferSurface.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>const</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>Fence</span><span class=o>&gt;&amp;</span> <span class=n>FramebufferSurface</span><span class=o>::</span><span class=n>getClientTargetAcquireFence</span><span class=p>()</span> <span class=k>const</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>mCurrentFence</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h4 class=heading-element id=bufferqueuelayer-onlayerdisplayed><span>BufferQueueLayer onLayerDisplayed</span>
<a href=#bufferqueuelayer-onlayerdisplayed class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>调用Layer的onLayerDisplayed方法，BufferQueueLayer继承于BuffeLayer，BuffeLayer由继承于Layer，因此调用BufferQueueLayer的onLayerDisplayed方法：</p><p><a href=/Android13%20BufferQueueLayer%20onLayerDisplayed%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-CSDN%E5%8D%9A%E5%AE%A2>Android13 BufferQueueLayer onLayerDisplayed流程分析-CSDN博客</a></p><h3 class=heading-element id=output-rendercachedsets><span>Output renderCachedSets</span>
<a href=#output-rendercachedsets class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>调用Output的renderCachedSets方法，进行渲染缓存设置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=n>Output</span><span class=o>::</span><span class=n>renderCachedSets</span><span class=p>(</span><span class=k>const</span> <span class=n>CompositionRefreshArgs</span><span class=o>&amp;</span> <span class=n>refreshArgs</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>mPlanner</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mPlanner</span><span class=o>-&gt;</span><span class=n>renderCachedSets</span><span class=p>(</span><span class=n>getState</span><span class=p>(),</span> <span class=n>refreshArgs</span><span class=p>.</span><span class=n>scheduledFrameTime</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 class=heading-element id=output-dirtyentireoutput><span>Output dirtyEntireOutput</span>
<a href=#output-dirtyentireoutput class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>调用Output的dirtyEntireOutput方法，重置脏区：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>OutputCompositionState</span> <span class=n>outputState</span> <span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>Region</span> <span class=n>dirtyRegion</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>using</span> <span class=n>OutputCompositionState</span> <span class=o>=</span> <span class=n>compositionengine</span><span class=o>::</span><span class=n>impl</span><span class=o>::</span><span class=n>OutputCompositionState</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>Output</span><span class=o>::</span><span class=n>dirtyEntireOutput</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>auto</span><span class=o>&amp;</span> <span class=n>outputState</span> <span class=o>=</span> <span class=n>editState</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>outputState</span><span class=p>.</span><span class=n>dirtyRegion</span><span class=p>.</span><span class=n>set</span><span class=p>(</span><span class=n>outputState</span><span class=p>.</span><span class=n>displaySpace</span><span class=p>.</span><span class=n>getBoundsAsRect</span><span class=p>());</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h4 class=heading-element id=region-set><span>Region set</span>
<a href=#region-set class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>调用outputState(OutputCompositionState )内成员变量dirtyRegion(Region)的set方法，设置脏区：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/libs/ui/Region.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>FatVector</span><span class=o>&lt;</span><span class=n>Rect</span><span class=o>&gt;</span> <span class=n>mStorage</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>Region</span><span class=o>::</span><span class=n>set</span><span class=p>(</span><span class=k>const</span> <span class=n>Rect</span><span class=o>&amp;</span> <span class=n>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>mStorage</span><span class=p>.</span><span class=n>clear</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>mStorage</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>r</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 class=heading-element id=output-finishprepareframe><span>Output finishPrepareFrame</span>
<a href=#output-finishprepareframe class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>调用Output的finishPrepareFrame方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/Output.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=n>Output</span><span class=o>::</span><span class=n>finishPrepareFrame</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=n>state</span> <span class=o>=</span> <span class=n>getState</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>mPlanner</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mPlanner</span><span class=o>-&gt;</span><span class=n>reportFinalPlan</span><span class=p>(</span><span class=n>getOutputLayersOrderedByZ</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>mRenderSurface</span><span class=o>-&gt;</span><span class=n>prepareFrame</span><span class=p>(</span><span class=n>state</span><span class=p>.</span><span class=n>usesClientComposition</span><span class=p>,</span> <span class=n>state</span><span class=p>.</span><span class=n>usesDeviceComposition</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h4 class=heading-element id=planner-reportfinalplan><span>Planner reportFinalPlan</span>
<a href=#planner-reportfinalplan class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>调用mPlanner(Planner)的reportFinalPlan方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/Planner.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=n>Planner</span><span class=o>::</span><span class=n>reportFinalPlan</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=n>compositionengine</span><span class=o>::</span><span class=n>Output</span><span class=o>::</span><span class=n>OutputLayersEnumerator</span><span class=o>&lt;</span><span class=n>compositionengine</span><span class=o>::</span><span class=n>Output</span><span class=o>&gt;&amp;&amp;</span> <span class=n>layers</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>ATRACE_CALL</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>mPredictorEnabled</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>Plan</span> <span class=n>finalPlan</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=n>GraphicBuffer</span><span class=o>*</span> <span class=n>currentOverrideBuffer</span> <span class=o>=</span> <span class=k>nullptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>bool</span> <span class=n>hasSkippedLayers</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=k>auto</span> <span class=nl>layer</span> <span class=p>:</span> <span class=n>layers</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>layer</span><span class=o>-&gt;</span><span class=n>getState</span><span class=p>().</span><span class=n>overrideInfo</span><span class=p>.</span><span class=n>buffer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=n>GraphicBuffer</span><span class=o>*</span> <span class=n>overrideBuffer</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=n>layer</span><span class=o>-&gt;</span><span class=n>getState</span><span class=p>().</span><span class=n>overrideInfo</span><span class=p>.</span><span class=n>buffer</span><span class=o>-&gt;</span><span class=n>getBuffer</span><span class=p>().</span><span class=n>get</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>overrideBuffer</span> <span class=o>!=</span> <span class=k>nullptr</span> <span class=o>&amp;&amp;</span> <span class=n>overrideBuffer</span> <span class=o>==</span> <span class=n>currentOverrideBuffer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Skip this layer since it is part of a previous cached set
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>hasSkippedLayers</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=n>currentOverrideBuffer</span> <span class=o>=</span> <span class=n>overrideBuffer</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=kt>bool</span> <span class=n>forcedOrRequestedClient</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>                <span class=n>layer</span><span class=o>-&gt;</span><span class=n>getState</span><span class=p>().</span><span class=n>forceClientComposition</span> <span class=o>||</span> <span class=n>layer</span><span class=o>-&gt;</span><span class=n>requiresClientComposition</span><span class=p>();</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=n>finalPlan</span><span class=p>.</span><span class=n>addLayerType</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>forcedOrRequestedClient</span>
</span></span><span class=line><span class=cl>                        <span class=o>?</span> <span class=n>aidl</span><span class=o>::</span><span class=n>android</span><span class=o>::</span><span class=n>hardware</span><span class=o>::</span><span class=n>graphics</span><span class=o>::</span><span class=n>composer3</span><span class=o>::</span><span class=n>Composition</span><span class=o>::</span><span class=nl>CLIENT</span>
</span></span><span class=line><span class=cl>                        <span class=p>:</span> <span class=n>layer</span><span class=o>-&gt;</span><span class=n>getLayerFE</span><span class=p>().</span><span class=n>getCompositionState</span><span class=p>()</span><span class=o>-&gt;</span><span class=n>compositionType</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>mPredictor</span><span class=p>.</span><span class=n>recordResult</span><span class=p>(</span><span class=n>mPredictedPlan</span><span class=p>,</span> <span class=n>mFlattenedHash</span><span class=p>,</span> <span class=n>mCurrentLayers</span><span class=p>,</span> <span class=n>hasSkippedLayers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                            <span class=n>finalPlan</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>调用mPredictor(Predictor)的recordResult方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/Predictor.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kt>void</span> <span class=n>Predictor</span><span class=o>::</span><span class=n>recordResult</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>optional</span><span class=o>&lt;</span><span class=n>PredictedPlan</span><span class=o>&gt;</span> <span class=n>predictedPlan</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                             <span class=n>NonBufferHash</span> <span class=n>flattenedHash</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                             <span class=k>const</span> <span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=k>const</span> <span class=n>LayerState</span><span class=o>*&gt;&amp;</span> <span class=n>layers</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>hasSkippedLayers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                             <span class=n>Plan</span> <span class=n>result</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>predictedPlan</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>recordPredictedResult</span><span class=p>(</span><span class=o>*</span><span class=n>predictedPlan</span><span class=p>,</span> <span class=n>layers</span><span class=p>,</span> <span class=n>std</span><span class=o>::</span><span class=n>move</span><span class=p>(</span><span class=n>result</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=o>++</span><span class=n>mMissCount</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>hasSkippedLayers</span> <span class=o>&amp;&amp;</span> <span class=n>findSimilarPrediction</span><span class=p>(</span><span class=n>layers</span><span class=p>,</span> <span class=n>result</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>ALOGV</span><span class=p>(</span><span class=s>&#34;[%s] Adding novel candidate %zx&#34;</span><span class=p>,</span> <span class=n>__func__</span><span class=p>,</span> <span class=n>flattenedHash</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>mCandidates</span><span class=p>.</span><span class=n>emplace_front</span><span class=p>(</span><span class=n>flattenedHash</span><span class=p>,</span> <span class=n>Prediction</span><span class=p>(</span><span class=n>layers</span><span class=p>,</span> <span class=n>result</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>mCandidates</span><span class=p>.</span><span class=n>size</span><span class=p>()</span> <span class=o>&gt;</span> <span class=n>MAX_CANDIDATES</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mCandidates</span><span class=p>.</span><span class=n>pop_back</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h4 class=heading-element id=rendersurface-prepareframe><span>RenderSurface prepareFrame</span>
<a href=#rendersurface-prepareframe class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>调用RenderSurface的prepareFrame方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/CompositionEngin/src/RenderSurface.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>const</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>DisplaySurface</span><span class=o>&gt;</span> <span class=n>mDisplaySurface</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=n>RenderSurface</span><span class=o>::</span><span class=n>prepareFrame</span><span class=p>(</span><span class=kt>bool</span> <span class=n>usesClientComposition</span><span class=p>,</span> <span class=kt>bool</span> <span class=n>usesDeviceComposition</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=k>auto</span> <span class=n>compositionType</span> <span class=o>=</span> <span class=p>[</span><span class=o>=</span><span class=p>]</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>using</span> <span class=n>CompositionType</span> <span class=o>=</span> <span class=n>DisplaySurface</span><span class=o>::</span><span class=n>CompositionType</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>usesClientComposition</span> <span class=o>&amp;&amp;</span> <span class=n>usesDeviceComposition</span><span class=p>)</span> <span class=k>return</span> <span class=n>CompositionType</span><span class=o>::</span><span class=n>Mixed</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>usesClientComposition</span><span class=p>)</span> <span class=k>return</span> <span class=n>CompositionType</span><span class=o>::</span><span class=n>Gpu</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>usesDeviceComposition</span><span class=p>)</span> <span class=k>return</span> <span class=n>CompositionType</span><span class=o>::</span><span class=n>Hwc</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>        <span class=c1>// Nothing to do -- when turning the screen off we get a frame like
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// this. Call it a HWC frame since we won&#39;t be doing any GPU work but
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// will do a prepare/set cycle.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=k>return</span> <span class=n>CompositionType</span><span class=o>::</span><span class=n>Hwc</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}();</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>status_t</span> <span class=n>result</span> <span class=o>=</span> <span class=n>mDisplaySurface</span><span class=o>-&gt;</span><span class=n>prepareFrame</span><span class=p>(</span><span class=n>compositionType</span><span class=p>);</span> <span class=n>result</span> <span class=o>!=</span> <span class=n>NO_ERROR</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ALOGE</span><span class=p>(</span><span class=s>&#34;updateCompositionType failed for %s: %d (%s)&#34;</span><span class=p>,</span> <span class=n>mDisplay</span><span class=p>.</span><span class=n>getName</span><span class=p>().</span><span class=n>c_str</span><span class=p>(),</span> <span class=n>result</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=n>strerror</span><span class=p>(</span><span class=o>-</span><span class=n>result</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h5 class=heading-element id=virtualdisplaysurface-prepareframe><span>VirtualDisplaySurface prepareFrame</span>
<a href=#virtualdisplaysurface-prepareframe class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>调用mDisplaySurface(DisplaySurface)的prepareFrame方法，VirtualDisplaySurface继承于DisplaySurface，因此调用DisplaySurface的prepareFrame方法，DisplaySurface的prepareFrame方法用于准备帧</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/DisplayHardware/VirtualDisplaySurface.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>status_t</span> <span class=n>VirtualDisplaySurface</span><span class=o>::</span><span class=n>prepareFrame</span><span class=p>(</span><span class=n>CompositionType</span> <span class=n>compositionType</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>GpuVirtualDisplayId</span><span class=o>::</span><span class=n>tryCast</span><span class=p>(</span><span class=n>mDisplayId</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>NO_ERROR</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>VDS_LOGW_IF</span><span class=p>(</span><span class=n>mDebugState</span> <span class=o>!=</span> <span class=n>DebugState</span><span class=o>::</span><span class=n>Begun</span><span class=p>,</span> <span class=s>&#34;Unexpected %s in %s state&#34;</span><span class=p>,</span> <span class=n>__func__</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                <span class=n>ftl</span><span class=o>::</span><span class=n>enum_string</span><span class=p>(</span><span class=n>mDebugState</span><span class=p>).</span><span class=n>c_str</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=n>mDebugState</span> <span class=o>=</span> <span class=n>DebugState</span><span class=o>::</span><span class=n>Prepared</span><span class=p>;</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>mCompositionType</span> <span class=o>=</span> <span class=n>compositionType</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>mForceHwcCopy</span> <span class=o>&amp;&amp;</span> <span class=n>mCompositionType</span> <span class=o>==</span> <span class=n>CompositionType</span><span class=o>::</span><span class=n>Gpu</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// Some hardware can do RGB-&gt;YUV conversion more efficiently in hardware
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// controlled by HWC than in hardware controlled by the video encoder.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// Forcing GPU-composed frames to go through an extra copy by the HWC
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// allows the format conversion to happen there, rather than passing RGB
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// directly to the consumer.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// On the other hand, when the consumer prefers RGB or can consume RGB
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// inexpensively, this forces an unnecessary copy.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mCompositionType</span> <span class=o>=</span> <span class=n>CompositionType</span><span class=o>::</span><span class=n>Mixed</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>mCompositionType</span> <span class=o>!=</span> <span class=n>mDebugLastCompositionType</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>VDS_LOGV</span><span class=p>(</span><span class=s>&#34;%s: composition type changed to %s&#34;</span><span class=p>,</span> <span class=n>__func__</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                 <span class=n>toString</span><span class=p>(</span><span class=n>mCompositionType</span><span class=p>).</span><span class=n>c_str</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=n>mDebugLastCompositionType</span> <span class=o>=</span> <span class=n>mCompositionType</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>mCompositionType</span> <span class=o>!=</span> <span class=n>CompositionType</span><span class=o>::</span><span class=n>Gpu</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=n>mOutputFormat</span> <span class=o>!=</span> <span class=n>mDefaultOutputFormat</span> <span class=o>||</span> <span class=n>mOutputUsage</span> <span class=o>!=</span> <span class=n>GRALLOC_USAGE_HW_COMPOSER</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// We must have just switched from GPU-only to MIXED or HWC
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// composition. Stop using the format and usage requested by the GPU
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// driver; they may be suboptimal when HWC is writing to the output
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// buffer. For example, if the output is going to a video encoder, and
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// HWC can write directly to YUV, some hardware can skip a
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// memory-to-memory RGB-to-YUV conversion step.
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// If we just switched *to* GPU-only mode, we&#39;ll change the
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// format/usage and get a new buffer when the GPU driver calls
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// dequeueBuffer().
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>mOutputFormat</span> <span class=o>=</span> <span class=n>mDefaultOutputFormat</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>mOutputUsage</span> <span class=o>=</span> <span class=n>GRALLOC_USAGE_HW_COMPOSER</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>refreshOutputBuffer</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>NO_ERROR</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>调用VirtualDisplaySurface的refreshOutputBuffer方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/DisplayHardware/VirtualDisplaySurface.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>status_t</span> <span class=n>VirtualDisplaySurface</span><span class=o>::</span><span class=n>refreshOutputBuffer</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>LOG_ALWAYS_FATAL_IF</span><span class=p>(</span><span class=n>GpuVirtualDisplayId</span><span class=o>::</span><span class=n>tryCast</span><span class=p>(</span><span class=n>mDisplayId</span><span class=p>).</span><span class=n>has_value</span><span class=p>());</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>mOutputProducerSlot</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>mSource</span><span class=p>[</span><span class=n>SOURCE_SINK</span><span class=p>]</span><span class=o>-&gt;</span><span class=n>cancelBuffer</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>mapProducer2SourceSlot</span><span class=p>(</span><span class=n>SOURCE_SINK</span><span class=p>,</span> <span class=n>mOutputProducerSlot</span><span class=p>),</span>
</span></span><span class=line><span class=cl>                <span class=n>mOutputFence</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>sslot</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>status_t</span> <span class=n>result</span> <span class=o>=</span> <span class=n>dequeueBuffer</span><span class=p>(</span><span class=n>SOURCE_SINK</span><span class=p>,</span> <span class=n>mOutputFormat</span><span class=p>,</span> <span class=n>mOutputUsage</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=o>&amp;</span><span class=n>sslot</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>mOutputFence</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>mOutputProducerSlot</span> <span class=o>=</span> <span class=n>mapSource2ProducerSlot</span><span class=p>(</span><span class=n>SOURCE_SINK</span><span class=p>,</span> <span class=n>sslot</span><span class=p>);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=c1>// On GPU-only frames, we don&#39;t have the right output buffer acquire fence
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// until after GPU calls queueBuffer(). So here we just set the buffer
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// (for use in HWC prepare) but not the fence; we&#39;ll call this again with
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// the proper fence once we have it.
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>const</span> <span class=k>auto</span> <span class=n>halDisplayId</span> <span class=o>=</span> <span class=n>HalVirtualDisplayId</span><span class=o>::</span><span class=n>tryCast</span><span class=p>(</span><span class=n>mDisplayId</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>LOG_FATAL_IF</span><span class=p>(</span><span class=o>!</span><span class=n>halDisplayId</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>mHwc</span><span class=p>.</span><span class=n>setOutputBuffer</span><span class=p>(</span><span class=o>*</span><span class=n>halDisplayId</span><span class=p>,</span> <span class=n>Fence</span><span class=o>::</span><span class=n>NO_FENCE</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                  <span class=n>mProducerBuffers</span><span class=p>[</span><span class=n>mOutputProducerSlot</span><span class=p>]);</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h6 class=heading-element id=hwcomposer-setoutputbuffer-1><span>HWComposer setOutputBuffer</span>
<a href=#hwcomposer-setoutputbuffer-1 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h6><p>调用HWComposer的setOutputBuffer方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=c1>//frameworks/native/services/surfaceflinger/DisplayHardware/HWComposer.cpp
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>std</span><span class=o>::</span><span class=n>unordered_map</span><span class=o>&lt;</span><span class=n>HalDisplayId</span><span class=p>,</span> <span class=n>DisplayData</span><span class=o>&gt;</span> <span class=n>mDisplayData</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=n>HWC2</span><span class=o>::</span><span class=n>Display</span><span class=o>&gt;</span> <span class=n>hwcDisplay</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>status_t</span> <span class=n>HWComposer</span><span class=o>::</span><span class=n>setOutputBuffer</span><span class=p>(</span><span class=n>HalVirtualDisplayId</span> <span class=n>displayId</span><span class=p>,</span> <span class=k>const</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>Fence</span><span class=o>&gt;&amp;</span> <span class=n>acquireFence</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                     <span class=k>const</span> <span class=n>sp</span><span class=o>&lt;</span><span class=n>GraphicBuffer</span><span class=o>&gt;&amp;</span> <span class=n>buffer</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>RETURN_IF_INVALID_DISPLAY</span><span class=p>(</span><span class=n>displayId</span><span class=p>,</span> <span class=n>BAD_INDEX</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>const</span> <span class=k>auto</span><span class=o>&amp;</span> <span class=n>displayData</span> <span class=o>=</span> <span class=n>mDisplayData</span><span class=p>[</span><span class=n>displayId</span><span class=p>];</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=k>auto</span> <span class=n>error</span> <span class=o>=</span> <span class=n>displayData</span><span class=p>.</span><span class=n>hwcDisplay</span><span class=o>-&gt;</span><span class=n>setOutputBuffer</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span> <span class=n>acquireFence</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>RETURN_IF_HWC_ERROR</span><span class=p>(</span><span class=n>error</span><span class=p>,</span> <span class=n>displayId</span><span class=p>,</span> <span class=n>UNKNOWN_ERROR</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>NO_ERROR</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h6 class=heading-element id=hwc2display-setoutputbuffer-2><span>HWC2::Display setOutputBuffer</span>
<a href=#hwc2display-setoutputbuffer-2 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h6><p>调用HWC2::Display的setOutputBuffer方法，之后就是HWC的处理了。</p></div><div class=collection-card><div class="collection-title text-secondary">收录于 <a href=/collections/%E5%9B%BE%E5%BD%A2%E6%98%BE%E7%A4%BA/><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i> <span>合集・图形显示</span></span></a> 43</div><div class=collection-nav><a href=/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/ class=collection-nav-item rel=prev title="Android13 SurfaceFlinger Commit(提交)流程分析_surfaceflinger::commit-CSDN博客"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i><span>Android13 SurfaceFlinger Commit(提交)流程分析_surfaceflinger::commit-CSDN博客</span>
</a><a href=/posts/android13-surfaceflinger-oncomposerhalhotplug%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/ class=collection-nav-item rel=next title="Android13 SurfaceFlinger OnComposerHalHotplug流程分析-CSDN博客"><span>Android13 SurfaceFlinger OnComposerHalHotplug流程分析-CSDN博客</span><i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2024-11-05 01:33:58">更新于 2024-11-05&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://huang8604.github.io/posts/android13-surfaceflinger-composite%E5%90%88%E6%88%90%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/ data-title="Android13 SurfaceFlinger Composite(合成)流程分析-CSDN博客"><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/clippings/ class=post-tag title="标签 - Clippings">Clippings</a><a href=/tags/%E8%BD%AC%E8%BD%BD/ class=post-tag title="标签 - 转载">转载</a><a href=/tags/blog/ class=post-tag title="标签 - Blog">Blog</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/android13-surfaceflinger-oncomposerhalhotplug%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/ class=post-nav-item rel=prev title="Android13 SurfaceFlinger OnComposerHalHotplug流程分析-CSDN博客"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>Android13 SurfaceFlinger OnComposerHalHotplug流程分析-CSDN博客</a><a href=/posts/android13-surfaceflinger-commit%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-csdn%E5%8D%9A%E5%AE%A2/ class=post-nav-item rel=next title="Android13 SurfaceFlinger Commit(提交)流程分析_surfaceflinger::commit-CSDN博客">Android13 SurfaceFlinger Commit(提交)流程分析_surfaceflinger::commit-CSDN博客<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div class=post-reward><div class=comment></div><input type=checkbox class=reward-input name=reward id=fi-reward hidden>
<label class=reward-button for=fi-reward><i class="fa-solid fa-qrcode fa-fw" aria-hidden=true></i>赞赏</label><div class=reward-ways data-mode=static></div></div><div id=comments><div id=giscus class=comment><script src=https://giscus.app/client.js data-repo=huang8604/huang8604.github.io data-repo-id=R_kgDOMx3bEg data-category=Announcements data-category-id=DIC_kwDOMx3bEs4CigIp data-mapping=pathname data-strict=0 data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-loading=lazy crossorigin=anonymous async defer></script></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></article><aside class=toc id=toc-auto aria-label=目录><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside></main><footer class=footer><div class=footer-container><div class="footer-line powered">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.152.2"><img class=hugo-icon src=/images/hugo.min.svg alt="Hugo logo"> Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.3.20"><img class=fixit-icon src=/images/fixit.min.svg alt="FixIt logo"> FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2021 - 2025</span><span class=author itemprop=copyrightHolder>
<a href=https://github.com/huang8604 target=_blank rel="external nofollow noopener noreferrer">wentao</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class="variant-numeric d-none">0%</span></div><div class="fixed-button view-comments d-none" role=button aria-label=查看评论><i class="fa-solid fa-comment fa-fw" aria-hidden=true></i></div></div><div id=mask></div><noscript><div class=noscript-warning>该网站在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=preload href=/lib/katex/katex.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/katex/katex.min.css></noscript><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/fuse/fuse.min.js defer></script><script src=/lib/instant-page/instantpage.min.js async defer type=module></script><script src=/lib/lightgallery/lightgallery.min.js defer></script><script src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js defer></script><script src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:199},comment:{enable:!0,expired:!1,giscus:{darkTheme:"dark",lightTheme:"light",origin:"https://giscus.app"}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/search.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:50,threshold:.3,type:"fuse",useExtendedSearch:!1},version:"v0.3.20"}</script><script src=/js/theme.min.js defer></script><script src=/js/custom.min.js defer></script></body></html>