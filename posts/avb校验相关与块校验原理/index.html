<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>Avb校验相关与块校验原理 - 文韬的文档</title><meta name=author content="wentao"><meta name=description content="文章详细阐述了Linux系统在启动过程中针对块设备的校验流程，涉及到VerifiedBoot.c和LinuxLoader.c等关键组件。通用块设备层处理I/O请求，包括扇区、块、段和数据页的概念。动态校验流程中，verity_end_io函数用于处理错误并触发工作队列进行校验。dm-verity用于保证数据完整性，通过创建哈希树并配置目标表来验证块设备上的数据。此外，文章还提到了init用户态流程和清除panic标识的方法。
"><meta name=keywords content='clippings,blog,转载'><meta itemprop=name content="avb校验相关与块校验原理"><meta itemprop=description content="文章详细阐述了Linux系统在启动过程中针对块设备的校验流程，涉及到VerifiedBoot.c和LinuxLoader.c等关键组件。通用块设备层处理I/O请求，包括扇区、块、段和数据页的概念。动态校验流程中，verity_end_io函数用于处理错误并触发工作队列进行校验。dm-verity用于保证数据完整性，通过创建哈希树并配置目标表来验证块设备上的数据。此外，文章还提到了init用户态流程和清除panic标识的方法。"><meta itemprop=datePublished content="2025-11-04T03:27:12+00:00"><meta itemprop=dateModified content="2025-11-04T04:20:27+00:00"><meta itemprop=wordCount content="3826"><meta itemprop=keywords content="Clippings,Blog,转载"><meta property="og:url" content="https://huang8604.github.io/posts/avb%E6%A0%A1%E9%AA%8C%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%9D%97%E6%A0%A1%E9%AA%8C%E5%8E%9F%E7%90%86/"><meta property="og:site_name" content="文韬的文档"><meta property="og:title" content="avb校验相关与块校验原理"><meta property="og:description" content="文章详细阐述了Linux系统在启动过程中针对块设备的校验流程，涉及到VerifiedBoot.c和LinuxLoader.c等关键组件。通用块设备层处理I/O请求，包括扇区、块、段和数据页的概念。动态校验流程中，verity_end_io函数用于处理错误并触发工作队列进行校验。dm-verity用于保证数据完整性，通过创建哈希树并配置目标表来验证块设备上的数据。此外，文章还提到了init用户态流程和清除panic标识的方法。"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-11-04T03:27:12+00:00"><meta property="article:modified_time" content="2025-11-04T04:20:27+00:00"><meta property="article:tag" content="Clippings"><meta property="article:tag" content="Blog"><meta property="article:tag" content="转载"><meta name=twitter:card content="summary"><meta name=twitter:title content="avb校验相关与块校验原理"><meta name=twitter:description content="文章详细阐述了Linux系统在启动过程中针对块设备的校验流程，涉及到VerifiedBoot.c和LinuxLoader.c等关键组件。通用块设备层处理I/O请求，包括扇区、块、段和数据页的概念。动态校验流程中，verity_end_io函数用于处理错误并触发工作队列进行校验。dm-verity用于保证数据完整性，通过创建哈希树并配置目标表来验证块设备上的数据。此外，文章还提到了init用户态流程和清除panic标识的方法。"><meta name=application-name content="文涛的记录"><meta name=apple-mobile-web-app-title content="文涛的记录"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical type=text/html href=https://huang8604.github.io/posts/avb%E6%A0%A1%E9%AA%8C%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%9D%97%E6%A0%A1%E9%AA%8C%E5%8E%9F%E7%90%86/ title="avb校验相关与块校验原理 - 文韬的文档"><link rel=prev type=text/html href=https://huang8604.github.io/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/ title="Linux 下使用 tar 与 pigz 进行多核压缩"><link rel=next type=text/html href=https://huang8604.github.io/posts/fh20gms-120-vtsmr1vts_generic_boot_image_test-gms-confluence/ title="FH20GMS-120    [VTS][MR1]vts_generic_boot_image_test - GMS - Confluence"><link rel=alternate type=text/markdown href=https://huang8604.github.io/posts/avb%E6%A0%A1%E9%AA%8C%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%9D%97%E6%A0%A1%E9%AA%8C%E5%8E%9F%E7%90%86/index.md title="avb校验相关与块校验原理 - 文韬的文档"><link rel=stylesheet href=/css/config.min.css><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"avb校验相关与块校验原理","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/huang8604.github.io\/posts\/avb%E6%A0%A1%E9%AA%8C%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%9D%97%E6%A0%A1%E9%AA%8C%E5%8E%9F%E7%90%86\/"},"genre":"posts","keywords":"clippings, blog, 转载","wordcount":3826,"url":"https:\/\/huang8604.github.io\/posts\/avb%E6%A0%A1%E9%AA%8C%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%9D%97%E6%A0%A1%E9%AA%8C%E5%8E%9F%E7%90%86\/","datePublished":"2025-11-04T03:27:12+00:00","dateModified":"2025-11-04T04:20:27+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"wentao"},"description":""}</script><script src=/js/head/color-scheme.min.js></script></head><body data-instant-intensity=viewport data-header-desktop=sticky data-header-mobile=auto><div class=wrapper data-page-style=wide><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=文韬的文档><img class=logo src=/images/doc.jpg alt=文韬的文档 height=32 width=32><span class=header-title-text>文韬的文档</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/archives/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 归档</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/collections/><i class="fa-solid fa-group fa-fw fa-sm" aria-hidden=true></i> 合集</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容…… id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" role=button aria-label=切换主题 title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=文韬的文档><img class=logo src=/images/doc.jpg alt=文韬的文档 height=26 width=26><span class=header-title-text>文韬的文档</span></a><span class=header-subtitle></span></div><div class=theme-switch role=button aria-label=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></div><div class=menu-toggle id=menu-toggle-mobile role=button aria-labelledby=menu-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容…… id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/archives/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 归档</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/collections/><i class="fa-solid fa-group fa-fw fa-sm" aria-hidden=true></i> 合集</a></li><li class="menu-item menu-system"></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=fi-container><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label=合集></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>Avb校验相关与块校验原理</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/huang8604 title=作者 target=_blank rel="external nofollow noopener noreferrer author" class=author><img class=avatar src='https://www.gravatar.com/avatar/b89538cdbc35c279ce1df9f3435f42a1?s=32&d=' alt=wentao height=16 width=16>&nbsp;wentao</a></span></div><div class=post-meta-line><span title="发布于 2025-11-04 03:27:12"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden=true></i><time datetime=2025-11-04>2025-11-04</time></span>&nbsp;<span title="更新于 2025-11-04 04:20:27"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden=true></i><time datetime=2025-11-04>2025-11-04</time></span>&nbsp;<span title="3826 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 3900 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 8 分钟</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#一启动校验流程>一、启动校验流程</a></li><li><a href=#二通用块设备层对请求的处理>二、通用块设备层对请求的处理</a><ul><li><a href=#21-块设备概述>2.1 块设备概述</a></li><li><a href=#22向通用块设备层发送请求>2.2向通用块设备层发送请求</a></li><li><a href=#23-动态校验流程>2.3 动态校验流程</a></li><li><a href=#24-核心校验数据>2.4 核心校验数据</a></li></ul></li><li><a href=#三init用户态流程>三、init用户态流程</a></li><li><a href=#四-清除panic标识>四 清除panic标识</a></li><li><a href=#五-dm-verity建立过程>五 dm-verity建立过程</a></li></ul></li></ul></nav></div></div><div class=content id=content><p>文章详细阐述了Linux系统在启动过程中针对块设备的校验流程，涉及到VerifiedBoot.c和LinuxLoader.c等关键组件。通用块设备层处理I/O请求，包括扇区、块、段和数据页的概念。动态校验流程中，verity_end_io函数用于处理错误并触发工作队列进行校验。dm-verity用于保证数据完整性，通过创建哈希树并配置目标表来验证块设备上的数据。此外，文章还提到了init用户态流程和清除panic标识的方法。</p><h3 class=heading-element id=一启动校验流程><span>一、启动校验流程</span>
<a href=#%e4%b8%80%e5%90%af%e5%8a%a8%e6%a0%a1%e9%aa%8c%e6%b5%81%e7%a8%8b class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-c"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=2 style=--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>edk2</span><span class=o>/</span><span class=n>QcomModulePkg</span><span class=o>/</span><span class=n>Library</span><span class=o>/</span><span class=n>avb</span><span class=o>/</span><span class=n>VerifiedBoot</span><span class=p>.</span><span class=n>c</span>
</span></span><span class=line><span class=cl><span class=nf>DEBUG</span> <span class=p>((</span><span class=n>EFI_D_ERROR</span><span class=p>,</span> <span class=s>&#34;LoadImageAndAuth failed %r</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>Status</span><span class=p>));</span> <span class=n>in</span> <span class=nf>LoadImageAndAuth</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>edk2</span><span class=o>/</span><span class=n>QcomModulePkg</span><span class=o>/</span><span class=n>Application</span><span class=o>/</span><span class=n>LinuxLoader</span><span class=o>/</span><span class=n>LinuxLoader</span><span class=p>.</span><span class=n>c</span>
</span></span><span class=line><span class=cl><span class=nf>DEBUG</span> <span class=p>((</span><span class=n>EFI_D_ERROR</span><span class=p>,</span> <span class=s>&#34;LoadImageAndAuth failed: %r</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>Status</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>BootLib</span><span class=o>/</span><span class=n>PartitionTableUpdate</span><span class=p>.</span><span class=n>c</span>
</span></span><span class=line><span class=cl><span class=o>/</span><span class=n>QcomModulePkg</span><span class=o>/</span><span class=n>Library</span><span class=o>/</span><span class=n>avb</span><span class=o>/</span><span class=n>libavb</span><span class=o>/</span><span class=n>avb_slot_verify</span><span class=p>.</span><span class=n>c</span>
</span></span><span class=line><span class=cl><span class=n>LinuxLoaderEntry</span>
</span></span><span class=line><span class=cl>    <span class=n>Status</span> <span class=o>=</span> <span class=nf>GetRebootReason</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>BootReason</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=err>校验启动原因</span>
</span></span><span class=line><span class=cl>    <span class=nf>EnumeratePartitions</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>FindPtnActiveSlot</span>
</span></span><span class=line><span class=cl>    <span class=nf>UpdatePartitionEntries</span><span class=p>()</span>   <span class=o>-----</span>   <span class=err>加载</span><span class=n>avb分区</span>
</span></span><span class=line><span class=cl>    <span class=n>LoadImageAndAuth</span>      <span class=o>---------------</span>                  <span class=n>VerifiedBoot</span><span class=p>.</span><span class=n>c</span> 
</span></span><span class=line><span class=cl>        <span class=n>FindBootableSlot</span>    <span class=o>--------------</span>         <span class=n>PartitionTableUpdate</span><span class=p>.</span><span class=n>c</span><span class=c1>//error
</span></span></span><span class=line><span class=cl>            <span class=n>GetBootPartitionEntry</span> 
</span></span><span class=line><span class=cl>            <span class=n>HandleActiveSlotUnbootable</span>          <span class=c1>//一直返回错误
</span></span></span><span class=line><span class=cl>                <span class=n>GetBootPartitionEntry</span>             <span class=c1>// BootEntry       检测没过
</span></span></span><span class=line><span class=cl>                <span class=n>GetActiveSlot</span>                     <span class=c1>//success
</span></span></span><span class=line><span class=cl>                    <span class=n>GetBootPartitionEntry</span>    <span class=o>-----</span>    <span class=k>for</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=n>LoadImageAndAuthVB2</span>  <span class=o>---------------</span>           <span class=n>VerifiedBoot</span><span class=p>.</span><span class=n>c</span> 
</span></span><span class=line><span class=cl>            <span class=n>avb_should_update_rollback</span>
</span></span><span class=line><span class=cl>                <span class=n>IsCurrentSlotBootable</span>
</span></span><span class=line><span class=cl>            <span class=n>avb_slot_verify</span>    <span class=o>------------------</span>      <span class=n>avb_slot_verify</span><span class=p>.</span><span class=n>c</span>
</span></span><span class=line><span class=cl>                <span class=n>load_and_verify_vbmeta</span>
</span></span><span class=line><span class=cl>                    <span class=n>ops</span><span class=o>-&gt;</span><span class=nf>read_from_partition</span><span class=p>(</span><span class=n>ops</span><span class=p>,</span>  
</span></span><span class=line><span class=cl>                        <span class=n>AvbReadFromPartition</span>
</span></span><span class=line><span class=cl>                           <span class=s>&#34;Load Image %a total time: %lu ms </span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>                    <span class=n>avb_vbmeta_image_verify</span>
</span></span><span class=line><span class=cl>                        <span class=n>avb_rsa_verify</span>
</span></span><span class=line><span class=cl>                            <span class=n>iavb_parse_key_data</span>                 <span class=c1>//Unexpected key length
</span></span></span><span class=line><span class=cl>                <span class=n>avb_manage_hashtree_error_mode</span>
</span></span><span class=line><span class=cl>                <span class=n>avb_append_options</span>   <span class=c1>//avb 根据resolved_hashtree_error_mode 设置verity_mode
</span></span></span><span class=line><span class=cl>                    <span class=n>cmdline_append_option</span>    <span class=c1>//设置verity_mode到slot_data-&gt;cmdline
</span></span></span><span class=line><span class=cl>                <span class=n>avb_sub_cmdline</span>
</span></span><span class=line><span class=cl>            <span class=n>HandleActiveSlotUnbootable</span>                <span class=c1>//当前槽置为unbootable
</span></span></span><span class=line><span class=cl>            <span class=n>AppendVBCmdLine</span>      <span class=c1>//cmdline赋值到VBCmdLine
</span></span></span><span class=line><span class=cl>        <span class=n>DisplayVerifiedBootScreen</span>
</span></span><span class=line><span class=cl>            <span class=n>DisplayVerifiedBootMenu</span>
</span></span><span class=line><span class=cl>    <span class=nf>BootLinux</span> <span class=p>(</span><span class=o>&amp;</span><span class=n>Info</span><span class=p>);</span>
</span></span><span class=line><span class=cl>         <span class=n>UpdateCmdLine</span>
</span></span><span class=line><span class=cl>             <span class=n>AddtoBootConfigList</span>   <span class=c1>//gBS = SystemTable-&gt;BootServices;这里会利用uefi boot服务记录map
</span></span></span><span class=line><span class=cl><span class=n>c12345678910111213141516171819202122232425262728293031323334353637383940414243</span></span></span></code></pre></td></tr></table></div><div class=code-expand-btn aria-label=展开或折叠代码块 role=button><i class="fa-solid fa-angles-down" aria-hidden=true></i></div></div></div><h3 class=heading-element id=二通用块设备层对请求的处理><span>二、通用块设备层对请求的处理</span>
<a href=#%e4%ba%8c%e9%80%9a%e7%94%a8%e5%9d%97%e8%ae%be%e5%a4%87%e5%b1%82%e5%af%b9%e8%af%b7%e6%b1%82%e7%9a%84%e5%a4%84%e7%90%86 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><h4 class=heading-element id=21-块设备概述><span>2.1 块设备概述</span>
<a href=#21-%e5%9d%97%e8%ae%be%e5%a4%87%e6%a6%82%e8%bf%b0 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a7e546.png title=5e00f2e29c3ca54ef8bcc80bf046188f\_MD5 data-thumbnail=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a7e546.png data-sub-html="<h2>5e00f2e29c3ca54ef8bcc80bf046188f\_MD5</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a7e546.png alt=5e00f2e29c3ca54ef8bcc80bf046188f\_MD5></a></p><p><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a5a748.png title=acc3989c58db48303c93909ac34381b5\_MD5 data-thumbnail=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a5a748.png data-sub-html="<h2>acc3989c58db48303c93909ac34381b5\_MD5</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a5a748.png alt=acc3989c58db48303c93909ac34381b5\_MD5></a><br>• 块设备的 <a href="https://so.csdn.net/so/search?q=%E6%8E%A7%E5%88%B6%E5%99%A8%5c&amp;spm=1001.2101.3001.7020" target=_blank rel="external nofollow noopener noreferrer">控制器</a> 传输的固定数据单元大小称为扇区（sector）。因此I/O调度器<br>和块 <a href="https://so.csdn.net/so/search?q=%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8%5c&amp;spm=1001.2101.3001.7020" target=_blank rel="external nofollow noopener noreferrer">设备驱动</a> 必须以扇区为单位管理数据。<br>• <a href="https://so.csdn.net/so/search?q=%E8%99%9A%E6%8B%9F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%5c&amp;spm=1001.2101.3001.7020" target=_blank rel="external nofollow noopener noreferrer">虚拟文件系统</a> 、映射层（mapping layer）管理磁盘数据的逻辑单元大小称为块<br>（block）。对于文件系统来说，块是最小的磁盘数据存储单元。<br>• 前面在分散/聚合DMA中，我们提到块设备驱动应该能够处理称为“段”的数据<br>单元；每个“段”是内存中的一页或页的一部分，“段”中的数据在磁盘上是<br>连续的。<br>• 磁盘缓冲区处理的数据单元大小为“页”，每个对应一个页帧。（注1）<br>• 通用块设备层粘合所有上层和底层的部分，这样它就知道扇区、块、段和数据<br>页。</p><p><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a9b14c.png title=954834b855425f1c294027430bc33a92\_MD5 data-thumbnail=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a9b14c.png data-sub-html="<h2>954834b855425f1c294027430bc33a92\_MD5</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a9b14c.png alt=954834b855425f1c294027430bc33a92\_MD5></a><br>bi_io_vecs指向一个bio_vec 结构体 数组，该结构体链表包含了一个特定I/O操作所需要<br>使用到的所有段（segment）。每个bio_vec结构都是一个形式为&lt;page, offset, len>的向量，<br>它描述的是一个特定的段：段所在的物理页、块在物理页中的偏移量、从给定偏移量开始的<br>块长度。整个bio_io_vec结构体数组表示了一个完整的缓冲区。bio_vec结构体定义在文件<br>include/linux/bio.h中。</p><p>内核使用gendisk结构，定义在include/linux/genhd.h中，来表示一个独立的磁盘设备。<br>实际上内核还使用gendisk表示分区，但是驱动程序不需要了解这些。在gendisk结构中的许<br>多成员必须由驱动程序进行初始化。<br>物理磁盘通常被分成多个逻辑分区。每个块设备文件可以表示一个整个物理磁盘或者其<br>中的一个分区。如/dev/sda、/dev/sda1、/dev/sda2等。若一个物理磁盘有多个分区，则磁<br>盘的布局保存在hd_struct数据结构数组中，数组的地址由gendisk结构体中的part成员保存。<br>hd_struct数据结构的定义在文件include/linux/genhd.h中。<br><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a5898c.png title=1fc10005749f6d7feb2679226952a87e\_MD5 data-thumbnail=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a5898c.png data-sub-html="<h2>1fc10005749f6d7feb2679226952a87e\_MD5</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a5898c.png alt=1fc10005749f6d7feb2679226952a87e\_MD5></a><br>当内核在系统中发现一个新磁盘时，调用alloc_disk（）分配相关数据结构，如gendisk，<br>hd_struct等，然后调用add_disk（）将磁盘添加到系统中。注意：一旦调用了add_disk，<br>磁盘设备就被“激活“，表示可以使用，并随时会调用它们提供的方法。</p><h4 class=heading-element id=22向通用块设备层发送请求><span>2.2向通用块设备层发送请求</span>
<a href=#22%e5%90%91%e9%80%9a%e7%94%a8%e5%9d%97%e8%ae%be%e5%a4%87%e5%b1%82%e5%8f%91%e9%80%81%e8%af%b7%e6%b1%82 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><ol><li>上层下发磁盘数据请求</li><li>通用块层申请bio结构，将请求的数据分段记录到bio中</li><li>如果请求的数据大于一个bio允许的最大数据量，则将请求分成多个bio</li><li>调用submit_bio提交bio请求</li><li>submit_bio函数经过层层调用，最终调用块设备请求队列中的make_request_fn成员函数将bio提交给I/O调度层进行处理</li></ol><p>generic_make_request函数将bio连接到current->bio_list链表中，并调用__generic_make_request函数提交链表中所有的bio。<br><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a53dd6.png title=42e5e295f7c8fdf163477337556cd667\_MD5 data-thumbnail=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a53dd6.png data-sub-html="<h2>42e5e295f7c8fdf163477337556cd667\_MD5</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a53dd6.png alt=42e5e295f7c8fdf163477337556cd667\_MD5></a><br>__generic_make_request函数最终会调用块设备的请求队列中的make_request_fn成员函数将bio请求发送给I/O调度层，至此对磁盘的数据请求离开通用块层，进入下一层——I/O调度层<br><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a9cc7b.png title=8eb9347c4d3a718659464cbfdb6eb4ff\_MD5 data-thumbnail=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a9cc7b.png data-sub-html="<h2>8eb9347c4d3a718659464cbfdb6eb4ff\_MD5</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a9cc7b.png alt=8eb9347c4d3a718659464cbfdb6eb4ff\_MD5></a></p><h4 class=heading-element id=23-动态校验流程><span>2.3 动态校验流程</span>
<a href=#23-%e5%8a%a8%e6%80%81%e6%a0%a1%e9%aa%8c%e6%b5%81%e7%a8%8b class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-c"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=2 style=--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>verity_map</span>
</span></span><span class=line><span class=cl>    <span class=n>bio</span><span class=o>-&gt;</span><span class=n>bi_end_io</span> <span class=o>=</span> <span class=n>verity_end_io</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>verity_end_io</span>
</span></span><span class=line><span class=cl>    <span class=nf>INIT_WORK</span><span class=p>(</span><span class=o>&amp;</span><span class=n>io</span><span class=o>-&gt;</span><span class=n>work</span><span class=p>,</span> <span class=n>verity_work</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nf>queue_work</span><span class=p>(</span><span class=n>io</span><span class=o>-&gt;</span><span class=n>v</span><span class=o>-&gt;</span><span class=n>verify_wq</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>io</span><span class=o>-&gt;</span><span class=n>work</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>verity_work</span>
</span></span><span class=line><span class=cl>    <span class=n>verity_finish_io</span>
</span></span><span class=line><span class=cl>        <span class=n>verity_verify_io</span>
</span></span><span class=line><span class=cl>            <span class=k>struct</span> <span class=n>bio</span> <span class=o>*</span><span class=n>bio</span> <span class=o>=</span> <span class=n>dm_bio_from_per_bio_data</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=p>(</span><span class=n>b</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>b</span> <span class=o>&lt;</span> <span class=n>io</span><span class=o>-&gt;</span><span class=n>n_blocks</span><span class=p>;</span> <span class=n>b</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=n>verity_fec_decode</span>
</span></span><span class=line><span class=cl>                    <span class=nf>DMWARN_LIMIT</span><span class=p>(</span><span class=s>&#34;%s: FEC: recursion too deep&#34;</span><span class=p>,</span> <span class=n>v</span><span class=o>-&gt;</span><span class=n>data_dev</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=n>verity_handle_err</span>
</span></span><span class=line><span class=cl>                    <span class=nf>DMERR_LIMIT</span><span class=p>(</span><span class=s>&#34;%s: %s block %llu is corrupted&#34;</span><span class=p>,</span> <span class=n>v</span><span class=o>-&gt;</span><span class=n>data_dev</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>,</span>
</span></span><span class=line><span class=cl>                                <span class=n>type_str</span><span class=p>,</span> <span class=n>block</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>__submit_bio</span>
</span></span><span class=line><span class=cl>    <span class=n>blk_mq_submit_bio</span>
</span></span><span class=line><span class=cl>        <span class=n>bio_endio</span>                                        <span class=c1>///kernel_platform/msm-kernel/block/bio.c
</span></span></span><span class=line><span class=cl>            <span class=n>bio</span><span class=o>-&gt;</span><span class=n>bi_end_io</span>
</span></span><span class=line><span class=cl><span class=n>c12345678910111213141516171819202122</span></span></span></code></pre></td></tr></table></div><div class=code-expand-btn aria-label=展开或折叠代码块 role=button><i class="fa-solid fa-angles-down" aria-hidden=true></i></div></div></div><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-c"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=2 style=--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>dm_verity_io</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>72</span>      <span class=k>struct</span> <span class=n>dm_verity</span> <span class=o>*</span><span class=n>v</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>73</span>  
</span></span><span class=line><span class=cl><span class=mi>74</span>      <span class=cm>/* original value of bio-&gt;bi_end_io */</span>
</span></span><span class=line><span class=cl><span class=mi>75</span>      <span class=kt>bio_end_io_t</span> <span class=o>*</span><span class=n>orig_bi_end_io</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>76</span>  
</span></span><span class=line><span class=cl><span class=mi>77</span>      <span class=kt>sector_t</span> <span class=n>block</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>78</span>      <span class=kt>unsigned</span> <span class=n>n_blocks</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>79</span>  
</span></span><span class=line><span class=cl><span class=mi>80</span>      <span class=k>struct</span> <span class=n>bvec_iter</span> <span class=n>iter</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>81</span>  
</span></span><span class=line><span class=cl><span class=mi>82</span>      <span class=k>struct</span> <span class=n>work_struct</span> <span class=n>work</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>83</span>  
</span></span><span class=line><span class=cl><span class=mi>84</span>      <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>85       * Three variably-size fields follow this struct:
</span></span></span><span class=line><span class=cl><span class=cm>86       *
</span></span></span><span class=line><span class=cl><span class=cm>87       * u8 hash_req[v-&gt;ahash_reqsize];
</span></span></span><span class=line><span class=cl><span class=cm>88       * u8 real_digest[v-&gt;digest_size];
</span></span></span><span class=line><span class=cl><span class=cm>89       * u8 want_digest[v-&gt;digest_size];
</span></span></span><span class=line><span class=cl><span class=cm>90       *
</span></span></span><span class=line><span class=cl><span class=cm>91       * To access them use: verity_io_hash_req(), verity_io_real_digest()
</span></span></span><span class=line><span class=cl><span class=cm>92       * and verity_io_want_digest().
</span></span></span><span class=line><span class=cl><span class=cm>93       */</span>
</span></span><span class=line><span class=cl><span class=mi>94</span>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=n>c123456789101112131415161718192021222324</span></span></span></code></pre></td></tr></table></div><div class=code-expand-btn aria-label=展开或折叠代码块 role=button><i class="fa-solid fa-angles-down" aria-hidden=true></i></div></div></div><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-c"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=2 style=--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>verity_hash_for_block</span><span class=p>(</span><span class=k>struct</span> <span class=n>dm_verity</span> <span class=o>*</span><span class=n>v</span><span class=p>,</span> <span class=k>struct</span> <span class=n>dm_verity_io</span> <span class=o>*</span><span class=n>io</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mi>335</span>                <span class=kt>sector_t</span> <span class=n>block</span><span class=p>,</span> <span class=n>u8</span> <span class=o>*</span><span class=n>digest</span><span class=p>,</span> <span class=kt>bool</span> <span class=o>*</span><span class=n>is_zero</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>336</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>337</span>      <span class=kt>int</span> <span class=n>r</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>339</span>      <span class=k>if</span> <span class=p>(</span><span class=nf>likely</span><span class=p>(</span><span class=n>v</span><span class=o>-&gt;</span><span class=n>levels</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>340</span>          <span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>341           * First, we try to get the requested hash for
</span></span></span><span class=line><span class=cl><span class=cm>342           * the current block. If the hash block itself is
</span></span></span><span class=line><span class=cl><span class=cm>343           * verified, zero is returned. If it isn&#39;t, this
</span></span></span><span class=line><span class=cl><span class=cm>344           * function returns 1 and we fall back to whole
</span></span></span><span class=line><span class=cl><span class=cm>345           * chain verification.
</span></span></span><span class=line><span class=cl><span class=cm>346           */</span>
</span></span><span class=line><span class=cl><span class=mi>347</span>          <span class=n>r</span> <span class=o>=</span> <span class=nf>verity_verify_level</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=n>io</span><span class=p>,</span> <span class=n>block</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>true</span><span class=p>,</span> <span class=n>digest</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>348</span>          <span class=k>if</span> <span class=p>(</span><span class=nf>likely</span><span class=p>(</span><span class=n>r</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=mi>349</span>              <span class=k>goto</span> <span class=n>out</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>350</span>      <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=mi>352</span>      <span class=nf>memcpy</span><span class=p>(</span><span class=n>digest</span><span class=p>,</span> <span class=n>v</span><span class=o>-&gt;</span><span class=n>root_digest</span><span class=p>,</span> <span class=n>v</span><span class=o>-&gt;</span><span class=n>digest_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>354</span>      <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=n>v</span><span class=o>-&gt;</span><span class=n>levels</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=n>i</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>--</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>355</span>          <span class=n>r</span> <span class=o>=</span> <span class=nf>verity_verify_level</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=n>io</span><span class=p>,</span> <span class=n>block</span><span class=p>,</span> <span class=n>i</span><span class=p>,</span> <span class=nb>false</span><span class=p>,</span> <span class=n>digest</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>356</span>          <span class=k>if</span> <span class=p>(</span><span class=nf>unlikely</span><span class=p>(</span><span class=n>r</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=mi>357</span>              <span class=k>goto</span> <span class=n>out</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>358</span>      <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=mi>359</span>  <span class=nl>out</span><span class=p>:</span>
</span></span><span class=line><span class=cl><span class=mi>360</span>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>r</span> <span class=o>&amp;&amp;</span> <span class=n>v</span><span class=o>-&gt;</span><span class=n>zero_digest</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>361</span>          <span class=o>*</span><span class=n>is_zero</span> <span class=o>=</span> <span class=o>!</span><span class=nf>memcmp</span><span class=p>(</span><span class=n>v</span><span class=o>-&gt;</span><span class=n>zero_digest</span><span class=p>,</span> <span class=n>digest</span><span class=p>,</span> <span class=n>v</span><span class=o>-&gt;</span><span class=n>digest_size</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>362</span>      <span class=k>else</span>
</span></span><span class=line><span class=cl><span class=mi>363</span>          <span class=o>*</span><span class=n>is_zero</span> <span class=o>=</span> <span class=nb>false</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>364</span>  
</span></span><span class=line><span class=cl><span class=mi>365</span>      <span class=k>return</span> <span class=n>r</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>366</span>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>c123456789101112131415161718192021222324252627282930</span></span></span></code></pre></td></tr></table></div><div class=code-expand-btn aria-label=展开或折叠代码块 role=button><i class="fa-solid fa-angles-down" aria-hidden=true></i></div></div></div><h4 class=heading-element id=24-核心校验数据><span>2.4 核心校验数据</span>
<a href=#24-%e6%a0%b8%e5%bf%83%e6%a0%a1%e9%aa%8c%e6%95%b0%e6%8d%ae class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-c"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=2 style=--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>dm_verity</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>35</span>      <span class=k>struct</span> <span class=n>dm_dev</span> <span class=o>*</span><span class=n>data_dev</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>36</span>      <span class=k>struct</span> <span class=n>dm_dev</span> <span class=o>*</span><span class=n>hash_dev</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>37</span>      <span class=k>struct</span> <span class=n>dm_target</span> <span class=o>*</span><span class=n>ti</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>38</span>      <span class=k>struct</span> <span class=n>dm_bufio_client</span> <span class=o>*</span><span class=n>bufio</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>39</span>      <span class=kt>char</span> <span class=o>*</span><span class=n>alg_name</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>40</span>      <span class=k>struct</span> <span class=n>crypto_ahash</span> <span class=o>*</span><span class=n>tfm</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>41</span>      <span class=n>u8</span> <span class=o>*</span><span class=n>root_digest</span><span class=p>;</span>    <span class=cm>/* digest of the root block */</span>
</span></span><span class=line><span class=cl><span class=mi>42</span>      <span class=n>u8</span> <span class=o>*</span><span class=n>salt</span><span class=p>;</span>        <span class=cm>/* salt: its size is salt_size */</span>
</span></span><span class=line><span class=cl><span class=mi>43</span>      <span class=n>u8</span> <span class=o>*</span><span class=n>zero_digest</span><span class=p>;</span>    <span class=cm>/* digest for a zero block */</span>
</span></span><span class=line><span class=cl><span class=mi>44</span>      <span class=kt>unsigned</span> <span class=n>salt_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>45</span>      <span class=kt>sector_t</span> <span class=n>data_start</span><span class=p>;</span>    <span class=cm>/* data offset in 512-byte sectors */</span>
</span></span><span class=line><span class=cl><span class=mi>46</span>      <span class=kt>sector_t</span> <span class=n>hash_start</span><span class=p>;</span>    <span class=cm>/* hash start in blocks */</span>
</span></span><span class=line><span class=cl><span class=mi>47</span>      <span class=kt>sector_t</span> <span class=n>data_blocks</span><span class=p>;</span>    <span class=cm>/* the number of data blocks */</span>
</span></span><span class=line><span class=cl><span class=mi>48</span>      <span class=kt>sector_t</span> <span class=n>hash_blocks</span><span class=p>;</span>    <span class=cm>/* the number of hash blocks */</span>
</span></span><span class=line><span class=cl><span class=mi>49</span>      <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>data_dev_block_bits</span><span class=p>;</span>    <span class=cm>/* log2(data blocksize) */</span>
</span></span><span class=line><span class=cl><span class=mi>50</span>      <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>hash_dev_block_bits</span><span class=p>;</span>    <span class=cm>/* log2(hash blocksize) */</span>
</span></span><span class=line><span class=cl><span class=mi>51</span>      <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>hash_per_block_bits</span><span class=p>;</span>    <span class=cm>/* log2(hashes in hash block) */</span>
</span></span><span class=line><span class=cl><span class=mi>52</span>      <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>levels</span><span class=p>;</span>    <span class=cm>/* the number of tree levels */</span>
</span></span><span class=line><span class=cl><span class=mi>53</span>      <span class=kt>unsigned</span> <span class=kt>char</span> <span class=n>version</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>54</span>      <span class=kt>unsigned</span> <span class=n>digest_size</span><span class=p>;</span>    <span class=cm>/* digest size for the current hash algorithm */</span>
</span></span><span class=line><span class=cl><span class=mi>55</span>      <span class=kt>unsigned</span> <span class=kt>int</span> <span class=n>ahash_reqsize</span><span class=p>;</span><span class=cm>/* the size of temporary space for crypto */</span>
</span></span><span class=line><span class=cl><span class=mi>56</span>      <span class=kt>int</span> <span class=n>hash_failed</span><span class=p>;</span>    <span class=cm>/* set to 1 if hash of any block failed */</span>
</span></span><span class=line><span class=cl><span class=mi>57</span>      <span class=k>enum</span> <span class=n>verity_mode</span> <span class=n>mode</span><span class=p>;</span>    <span class=cm>/* mode for handling verification errors */</span>
</span></span><span class=line><span class=cl><span class=mi>58</span>      <span class=kt>unsigned</span> <span class=n>corrupted_errs</span><span class=p>;</span><span class=cm>/* Number of errors for corrupted blocks */</span>
</span></span><span class=line><span class=cl><span class=mi>59</span>
</span></span><span class=line><span class=cl><span class=mi>60</span>      <span class=k>struct</span> <span class=n>workqueue_struct</span> <span class=o>*</span><span class=n>verify_wq</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>61</span>
</span></span><span class=line><span class=cl><span class=mi>62</span>      <span class=cm>/* starting blocks for each tree level. 0 is the lowest level. */</span>
</span></span><span class=line><span class=cl><span class=mi>63</span>      <span class=kt>sector_t</span> <span class=n>hash_level_block</span><span class=p>[</span><span class=n>DM_VERITY_MAX_LEVELS</span><span class=p>];</span>
</span></span><span class=line><span class=cl><span class=mi>64</span>
</span></span><span class=line><span class=cl><span class=mi>65</span>      <span class=k>struct</span> <span class=n>dm_verity_fec</span> <span class=o>*</span><span class=n>fec</span><span class=p>;</span>    <span class=cm>/* forward error correction */</span>
</span></span><span class=line><span class=cl><span class=mi>66</span>      <span class=kt>unsigned</span> <span class=kt>long</span> <span class=o>*</span><span class=n>validated_blocks</span><span class=p>;</span> <span class=cm>/* bitset blocks validated */</span>
</span></span><span class=line><span class=cl><span class=mi>67</span>
</span></span><span class=line><span class=cl><span class=mi>68</span>      <span class=kt>char</span> <span class=o>*</span><span class=n>signature_key_desc</span><span class=p>;</span> <span class=cm>/* signature keyring reference */</span>
</span></span><span class=line><span class=cl><span class=mi>69</span>  <span class=p>};</span>
</span></span><span class=line><span class=cl><span class=mi>70</span>
</span></span><span class=line><span class=cl><span class=n>c12345678910111213141516171819202122232425262728293031323334353637</span></span></span></code></pre></td></tr></table></div><div class=code-expand-btn aria-label=展开或折叠代码块 role=button><i class="fa-solid fa-angles-down" aria-hidden=true></i></div></div></div><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-c"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=1 style=--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=p>[</span><span class=o>???</span> <span class=mf>3.809367</span><span class=p>]</span> <span class=n>v</span><span class=o>-&gt;</span><span class=n>hash_blocks</span> <span class=o>=</span> <span class=mi>662070</span><span class=o>??</span> <span class=err>（</span><span class=mi>662070</span><span class=o>-</span><span class=mi>656896</span><span class=o>=</span><span class=mi>5174</span><span class=err>）</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>???</span> <span class=mf>3.812900</span><span class=p>]</span> <span class=n>v</span><span class=o>-&gt;</span><span class=n>data_dev_block_bits</span><span class=o>=</span><span class=mi>12</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>???</span> <span class=mf>3.816608</span><span class=p>]</span> <span class=n>v</span><span class=o>-&gt;</span><span class=n>hash_dev_block_bits</span><span class=o>=</span><span class=mi>12</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>???</span> <span class=mf>3.820279</span><span class=p>]</span> <span class=n>v</span><span class=o>-&gt;</span><span class=n>hash_per_block_bits</span><span class=o>=</span><span class=mi>7</span><span class=o>??</span> <span class=p>(</span><span class=mi>4096</span><span class=o>/</span><span class=mi>32</span> <span class=o>=</span> <span class=mi>128</span><span class=p>,</span> <span class=err>指一个</span><span class=mi>4</span><span class=n>K块上有128个哈希值</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>???</span> <span class=mf>3.823888</span><span class=p>]</span> <span class=n>v</span><span class=o>-&gt;</span><span class=n>levels</span><span class=o>=</span><span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>???</span> <span class=mf>3.826380</span><span class=p>]</span> <span class=n>v</span><span class=o>-&gt;</span><span class=n>version</span> <span class=o>=</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=o>???</span> <span class=mf>3.829033</span><span class=p>]</span> <span class=n>v</span><span class=o>-&gt;</span><span class=n>digest_size</span><span class=o>=</span><span class=mi>32</span>
</span></span><span class=line><span class=cl><span class=n>c1234567</span></span></span></code></pre></td></tr></table></div></div></div><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-c"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=1 style=--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=err>数据块有</span><span class=mi>656896</span><span class=n>X4X1024</span><span class=o>?</span> <span class=p>(</span><span class=err>超过了</span><span class=mi>2</span><span class=n>G</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Level</span> <span class=mi>0</span> <span class=o>:?</span> <span class=mi>656896</span><span class=o>/</span><span class=mi>128</span> <span class=o>=</span> <span class=mi>5132</span><span class=err>个</span><span class=mi>4</span><span class=n>k块</span>
</span></span><span class=line><span class=cl><span class=n>Level</span> <span class=mi>1</span> <span class=o>:?</span> <span class=mi>5132</span><span class=o>/</span><span class=mi>128</span><span class=o>=</span> <span class=mi>41</span><span class=err>个</span><span class=mi>4</span><span class=n>k块</span>
</span></span><span class=line><span class=cl><span class=n>Level</span> <span class=mi>2</span><span class=o>:?</span> <span class=mi>40</span> <span class=o>/</span><span class=mi>128</span> <span class=o>=</span> <span class=mi>0</span><span class=err>，即</span><span class=mi>1</span><span class=err>个</span><span class=mi>4</span><span class=n>k块</span>
</span></span><span class=line><span class=cl><span class=err>共</span> <span class=mi>5132</span><span class=o>+</span><span class=mi>41</span><span class=o>+</span><span class=mi>1</span> <span class=o>=</span> <span class=mi>5174</span> <span class=err>个块</span>
</span></span><span class=line><span class=cl><span class=n>c12345</span></span></span></code></pre></td></tr></table></div></div></div><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-c"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=2 style=--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>verity_hash_at_level</span><span class=p>(</span><span class=k>struct</span> <span class=n>dm_verity</span> <span class=o>*</span><span class=n>v</span><span class=p>,</span> <span class=kt>sector_t</span> <span class=n>block</span><span class=p>,</span> <span class=kt>int</span> <span class=n>level</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mi>193</span>                   <span class=kt>sector_t</span> <span class=o>*</span><span class=n>hash_block</span><span class=p>,</span> <span class=kt>unsigned</span> <span class=o>*</span><span class=n>offset</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>194</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>195</span>      <span class=kt>sector_t</span> <span class=n>position</span> <span class=o>=</span> <span class=nf>verity_position_at_level</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=n>block</span><span class=p>,</span> <span class=n>level</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>196</span>      <span class=kt>unsigned</span> <span class=n>idx</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>198</span>      <span class=o>*</span><span class=n>hash_block</span> <span class=o>=</span> <span class=n>v</span><span class=o>-&gt;</span><span class=n>hash_level_block</span><span class=p>[</span><span class=n>level</span><span class=p>]</span> <span class=o>+</span> <span class=p>(</span><span class=n>position</span> <span class=o>&gt;&gt;</span> <span class=n>v</span><span class=o>-&gt;</span><span class=n>hash_per_block_bits</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>200</span>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>offset</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>201</span>          <span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>203</span>      <span class=n>idx</span> <span class=o>=</span> <span class=n>position</span> <span class=o>&amp;</span> <span class=p>((</span><span class=mi>1</span> <span class=o>&lt;&lt;</span> <span class=n>v</span><span class=o>-&gt;</span><span class=n>hash_per_block_bits</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>204</span>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>v</span><span class=o>-&gt;</span><span class=n>version</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>205</span>          <span class=o>*</span><span class=n>offset</span> <span class=o>=</span> <span class=n>idx</span> <span class=o>*</span> <span class=n>v</span><span class=o>-&gt;</span><span class=n>digest_size</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=mi>206</span>      <span class=k>else</span>
</span></span><span class=line><span class=cl><span class=mi>207</span>          <span class=o>*</span><span class=n>offset</span> <span class=o>=</span> <span class=n>idx</span> <span class=o>&lt;&lt;</span> <span class=p>(</span><span class=n>v</span><span class=o>-&gt;</span><span class=n>hash_dev_block_bits</span> <span class=o>-</span> <span class=n>v</span><span class=o>-&gt;</span><span class=n>hash_per_block_bits</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>208</span>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>sector_t</span> <span class=nf>verity_position_at_level</span><span class=p>(</span><span class=k>struct</span> <span class=n>dm_verity</span> <span class=o>*</span><span class=n>v</span><span class=p>,</span> <span class=kt>sector_t</span> <span class=n>block</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=mi>92</span>                       <span class=kt>int</span> <span class=n>level</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>93</span>  <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=mi>94</span>      <span class=k>return</span> <span class=n>block</span> <span class=o>&gt;&gt;</span> <span class=p>(</span><span class=n>level</span> <span class=o>*</span> <span class=n>v</span><span class=o>-&gt;</span><span class=n>hash_per_block_bits</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=mi>95</span>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=n>c1234567891011121314151617181920</span></span></span></code></pre></td></tr></table></div><div class=code-expand-btn aria-label=展开或折叠代码块 role=button><i class="fa-solid fa-angles-down" aria-hidden=true></i></div></div></div><h3 class=heading-element id=三init用户态流程><span>三、init用户态流程</span>
<a href=#%e4%b8%89init%e7%94%a8%e6%88%b7%e6%80%81%e6%b5%81%e7%a8%8b class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-c"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=1 style=--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>FirstStageMain</span>
</span></span><span class=line><span class=cl>    <span class=n>FirstStageMount</span><span class=o>::</span><span class=n>DoFirstStageMount</span>
</span></span><span class=line><span class=cl>        <span class=n>FirstStageMount</span><span class=o>::</span><span class=n>MountPartitions</span>
</span></span><span class=line><span class=cl>            <span class=n>FirstStageMount</span><span class=o>::</span><span class=n>MountPartition</span>
</span></span><span class=line><span class=cl>                <span class=n>FirstStageMountVBootV2</span><span class=o>::</span><span class=n>SetUpDmVerity</span>
</span></span><span class=line><span class=cl>                    <span class=n>AvbHandle</span><span class=o>::</span><span class=n>LoadAndVerifyVbmeta</span>
</span></span><span class=line><span class=cl>                        <span class=n>Failed</span> <span class=n>to</span> <span class=n>load</span> <span class=n>offline</span> <span class=n>vbmeta</span> <span class=k>for</span>
</span></span><span class=line><span class=cl><span class=n>c1234567</span></span></span></code></pre></td></tr></table></div></div></div><h3 class=heading-element id=四-清除panic标识><span>四 清除panic标识</span>
<a href=#%e5%9b%9b-%e6%b8%85%e9%99%a4panic%e6%a0%87%e8%af%86 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-c"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=1 style=--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>adb</span> <span class=n>shell</span>
</span></span><span class=line><span class=cl><span class=n>reboot</span> <span class=s>&#34;dm-verity enforcing&#34;</span>
</span></span><span class=line><span class=cl><span class=n>reboot</span> <span class=s>&#34;dm-verity device corrupted&#34;</span>
</span></span><span class=line><span class=cl><span class=n>c123</span></span></span></code></pre></td></tr></table></div></div></div><h3 class=heading-element id=五-dm-verity建立过程><span>五 dm-verity建立过程</span>
<a href=#%e4%ba%94-dm-verity%e5%bb%ba%e7%ab%8b%e8%bf%87%e7%a8%8b class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>在Device Mapper （DM）中使用dm-verity时，需要配置一个哈希树（hash tree），以便验证块设备上的数据的完整性。这通常通过在dmsetup命令中的目标表（target table）参数中指定相关参数来完成。以下是如何为dm-mapper中的dm-verity构建一个哈希树配置表的一般步骤：</p><ol><li><strong>创建源块设备</strong> ：首先，你需要创建一个普通的块设备，通常是一个已经存在的块设备，例如硬盘分区或者一个镜像文件。</li><li><strong>选择哈希算法</strong> ：确定要使用的哈希算法。dm-verity支持多种哈希算法，包括SHA-256、SHA-1、SHA-512等。你需要选择一个适合你的需求的哈希算法。</li><li><strong>生成哈希表</strong> ：使用生成 哈希表 的工具，例如veritysetup工具，来为源块设备生成哈希表。这个哈希表包含了块设备中每个块的哈希值。通常，你可以运行以下命令来生成哈希表：</li></ol><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-c"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=1 style=--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>veritysetup</span> <span class=n>format</span> <span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>source_device</span> <span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>mapper</span><span class=o>/</span><span class=n>verity_device</span>
</span></span><span class=line><span class=cl><span class=n>c1</span></span></span></code></pre></td></tr></table></div></div></div><p>其中，/dev/source_device 是源块设备，/dev/mapper/verity_device 是dm-verity设备。这个命令将生成哈希表并将其存储在dm-verity设备上。</p><ol><li><strong>配置dm-verity目标</strong> ：使用dmsetup命令配置dm-verity目标。你需要提供哈希树的根哈希值、块大小、源块设备和dm-verity设备的名称。通常，配置表看起来像这样：</li></ol><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-c"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=1 style=--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>dmsetup</span> <span class=n>create</span> <span class=n>verity_device</span> <span class=o>--</span><span class=n>table</span> <span class=err>&#39;</span><span class=mi>0</span> <span class=o>&lt;</span><span class=n>block_size</span><span class=o>&gt;</span> <span class=n>verity</span> <span class=o>&lt;</span><span class=n>root_hash</span><span class=o>&gt;</span> <span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>source_device</span> <span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>mapper</span><span class=o>/</span><span class=n>verity_device</span><span class=err>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>c1</span></span></span></code></pre></td></tr></table></div></div></div><p>其中，&lt;block_size> 是块的大小，&lt;root_hash> 是哈希树的根哈希值。</p><ol><li><strong>使用dm-verity设备</strong> ：一旦dm-verity设备被创建，你可以像使用任何其他块设备一样使用它。数据将在读取时被验证，以确保其完整性。</li></ol><p>这里的关键是生成哈希表并配置dm-verity目标，以便验证数据的完整性。哈希表是dm-verity验证数据完整性所必需的，因为它包含了源数据块的哈希值，用于验证数据是否被篡改。配置表指定了如何使用哈希表以及其他相关参数。配置表的格式取决于dm-verity目标的实现和你的需求，但通常是一个包含所需参数的文本字符串。</p><p>ubuntu 上dm-mapper相关信息：</p><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-c"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=2 style=--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>astro</span><span class=err>@</span><span class=nl>astrox</span><span class=p>:</span><span class=o>~/</span><span class=n>code</span><span class=o>/</span><span class=n>test</span><span class=err>$</span> <span class=n>sudo</span> <span class=n>lvdisplay</span> <span class=o>--</span><span class=n>maps</span> <span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>mapper</span><span class=o>/</span><span class=n>ubuntu</span><span class=o>--</span><span class=n>vg</span><span class=o>-</span><span class=n>ubuntu</span><span class=o>--</span><span class=n>lv</span>
</span></span><span class=line><span class=cl>  <span class=o>---</span> <span class=n>Logical</span> <span class=n>volume</span> <span class=o>---</span>
</span></span><span class=line><span class=cl>  <span class=n>LV</span> <span class=n>Path</span>                <span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>ubuntu</span><span class=o>-</span><span class=n>vg</span><span class=o>/</span><span class=n>ubuntu</span><span class=o>-</span><span class=n>lv</span>
</span></span><span class=line><span class=cl>  <span class=n>LV</span> <span class=n>Name</span>                <span class=n>ubuntu</span><span class=o>-</span><span class=n>lv</span>
</span></span><span class=line><span class=cl>  <span class=n>VG</span> <span class=n>Name</span>                <span class=n>ubuntu</span><span class=o>-</span><span class=n>vg</span>
</span></span><span class=line><span class=cl>  <span class=n>LV</span> <span class=n>UUID</span>                <span class=n>fSgsCj</span><span class=o>-</span><span class=n>fCWR</span><span class=o>-</span><span class=n>JeiN</span><span class=o>-</span><span class=n>WWQL</span><span class=o>-</span><span class=n>xPdv</span><span class=o>-</span><span class=n>T1gZ</span><span class=o>-</span><span class=n>QO9f9M</span>
</span></span><span class=line><span class=cl>  <span class=n>LV</span> <span class=n>Write</span> <span class=n>Access</span>        <span class=n>read</span><span class=o>/</span><span class=n>write</span>
</span></span><span class=line><span class=cl>  <span class=n>LV</span> <span class=n>Creation</span> <span class=n>host</span><span class=p>,</span> <span class=n>time</span> <span class=n>ubuntu</span><span class=o>-</span><span class=n>server</span><span class=p>,</span> <span class=mi>2023</span><span class=o>-</span><span class=mo>05</span><span class=o>-</span><span class=mi>09</span> <span class=mi>09</span><span class=o>:</span><span class=mo>07</span><span class=o>:</span><span class=mi>38</span> <span class=o>+</span><span class=mo>0000</span>
</span></span><span class=line><span class=cl>  <span class=n>LV</span> <span class=n>Status</span>              <span class=n>available</span>
</span></span><span class=line><span class=cl>  <span class=cp># open                 1
</span></span></span><span class=line><span class=cl>  <span class=n>LV</span> <span class=n>Size</span>                <span class=mf>49.25</span> <span class=n>GiB</span>
</span></span><span class=line><span class=cl>  <span class=n>Current</span> <span class=n>LE</span>             <span class=mi>12608</span>
</span></span><span class=line><span class=cl>  <span class=n>Segments</span>               <span class=mi>1</span>
</span></span><span class=line><span class=cl>  <span class=n>Allocation</span>             <span class=n>inherit</span>
</span></span><span class=line><span class=cl>  <span class=n>Read</span> <span class=n>ahead</span> <span class=n>sectors</span>     <span class=k>auto</span>
</span></span><span class=line><span class=cl>  <span class=o>-</span> <span class=n>currently</span> <span class=n>set</span> <span class=n>to</span>     <span class=mi>256</span>
</span></span><span class=line><span class=cl>  <span class=n>Block</span> <span class=n>device</span>           <span class=mi>253</span><span class=o>:</span><span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=o>---</span> <span class=n>Segments</span> <span class=o>---</span>
</span></span><span class=line><span class=cl>  <span class=n>Logical</span> <span class=n>extents</span> <span class=mi>0</span> <span class=n>to</span> <span class=mi>12607</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=n>Type</span>                <span class=n>linear</span>
</span></span><span class=line><span class=cl>    <span class=n>Physical</span> <span class=n>volume</span>     <span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>sda3</span>
</span></span><span class=line><span class=cl>    <span class=n>Physical</span> <span class=n>extents</span>    <span class=mi>0</span> <span class=n>to</span> <span class=mi>12607</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>c123456789101112131415161718192021222324</span></span></span></code></pre></td></tr></table></div><div class=code-expand-btn aria-label=展开或折叠代码块 role=button><i class="fa-solid fa-angles-down" aria-hidden=true></i></div></div></div><p>参考：<br><a href=https://aliez22.github.io/posts/11537/ target=_blank rel="external nofollow noopener noreferrer">https://aliez22.github.io/posts/11537/</a><br><a href=https://www.shili8.cn/article/detail target=_blank rel="external nofollow noopener noreferrer">https://www.shili8.cn/article/detail</a>_20000194464.html</p><p><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a7e546.png title=5e00f2e29c3ca54ef8bcc80bf046188f\_MD5 data-thumbnail=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a7e546.png data-sub-html="<h2>5e00f2e29c3ca54ef8bcc80bf046188f\_MD5</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a7e546.png alt=5e00f2e29c3ca54ef8bcc80bf046188f\_MD5></a> <a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a5a748.png title=acc3989c58db48303c93909ac34381b5\_MD5 data-thumbnail=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a5a748.png data-sub-html="<h2>acc3989c58db48303c93909ac34381b5\_MD5</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a5a748.png alt=acc3989c58db48303c93909ac34381b5\_MD5></a> <a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a9b14c.png title=954834b855425f1c294027430bc33a92\_MD5 data-thumbnail=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a9b14c.png data-sub-html="<h2>954834b855425f1c294027430bc33a92\_MD5</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a9b14c.png alt=954834b855425f1c294027430bc33a92\_MD5></a> <a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a5898c.png title=1fc10005749f6d7feb2679226952a87e\_MD5 data-thumbnail=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a5898c.png data-sub-html="<h2>1fc10005749f6d7feb2679226952a87e\_MD5</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a5898c.png alt=1fc10005749f6d7feb2679226952a87e\_MD5></a> <a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a53dd6.png title=42e5e295f7c8fdf163477337556cd667\_MD5 data-thumbnail=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a53dd6.png data-sub-html="<h2>42e5e295f7c8fdf163477337556cd667\_MD5</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a53dd6.png alt=42e5e295f7c8fdf163477337556cd667\_MD5></a> <a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a9cc7b.png title=8eb9347c4d3a718659464cbfdb6eb4ff\_MD5 data-thumbnail=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a9cc7b.png data-sub-html="<h2>8eb9347c4d3a718659464cbfdb6eb4ff\_MD5</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2025/11/04/6909737a9cc7b.png alt=8eb9347c4d3a718659464cbfdb6eb4ff\_MD5></a></p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2025-11-04 04:20:27">更新于 2025-11-04&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/avb%E6%A0%A1%E9%AA%8C%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%9D%97%E6%A0%A1%E9%AA%8C%E5%8E%9F%E7%90%86/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://huang8604.github.io/posts/avb%E6%A0%A1%E9%AA%8C%E7%9B%B8%E5%85%B3%E4%B8%8E%E5%9D%97%E6%A0%A1%E9%AA%8C%E5%8E%9F%E7%90%86/ data-title=Avb校验相关与块校验原理><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/clippings/ class=post-tag title="标签 - Clippings">Clippings</a><a href=/tags/blog/ class=post-tag title="标签 - Blog">Blog</a><a href=/tags/%E8%BD%AC%E8%BD%BD/ class=post-tag title="标签 - 转载">转载</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/linux-%E4%B8%8B%E4%BD%BF%E7%94%A8-tar-%E4%B8%8E-pigz-%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%A0%B8%E5%8E%8B%E7%BC%A9/ class=post-nav-item rel=prev title="Linux 下使用 Tar 与 Pigz 进行多核压缩"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>Linux 下使用 Tar 与 Pigz 进行多核压缩</a><a href=/posts/fh20gms-120-vtsmr1vts_generic_boot_image_test-gms-confluence/ class=post-nav-item rel=next title="FH20GMS-120    [VTS][MR1]vts_generic_boot_image_test - GMS - Confluence">FH20GMS-120 [VTS][MR1]vts_generic_boot_image_test - GMS - Confluence<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div class=post-reward><div class=comment></div><input type=checkbox class=reward-input name=reward id=fi-reward hidden>
<label class=reward-button for=fi-reward><i class="fa-solid fa-qrcode fa-fw" aria-hidden=true></i>赞赏</label><div class=reward-ways data-mode=static></div></div><div id=comments><div id=giscus class=comment><script src=https://giscus.app/client.js data-repo=huang8604/huang8604.github.io data-repo-id=R_kgDOMx3bEg data-category=Announcements data-category-id=DIC_kwDOMx3bEs4CigIp data-mapping=pathname data-strict=0 data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-loading=lazy crossorigin=anonymous async defer></script></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></article><aside class=toc id=toc-auto aria-label=目录><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside><dialog id=toc-dialog aria-labelledby=toc-dialog-title role=dialog><div class=toc><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-drawer><nav><ul><li><ul><li><a href=#一启动校验流程>一、启动校验流程</a></li><li><a href=#二通用块设备层对请求的处理>二、通用块设备层对请求的处理</a><ul><li><a href=#21-块设备概述>2.1 块设备概述</a></li><li><a href=#22向通用块设备层发送请求>2.2向通用块设备层发送请求</a></li><li><a href=#23-动态校验流程>2.3 动态校验流程</a></li><li><a href=#24-核心校验数据>2.4 核心校验数据</a></li></ul></li><li><a href=#三init用户态流程>三、init用户态流程</a></li><li><a href=#四-清除panic标识>四 清除panic标识</a></li><li><a href=#五-dm-verity建立过程>五 dm-verity建立过程</a></li></ul></li></ul></nav></div></div></dialog></main><footer class=footer><div class=footer-container><div class="footer-line powered">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.154.4"><img class=hugo-icon src=/images/hugo.min.svg alt="Hugo logo"> Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.4.1"><img class=fixit-icon src=/images/fixit.min.svg alt="FixIt logo"> FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2021 - 2026</span><span class=author itemprop=copyrightHolder>
<a href=https://github.com/huang8604 target=_blank rel="external nofollow noopener noreferrer">wentao</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></span></div></div></footer></div><div class=widgets><div class=fixed-buttons><div class="fixed-button back-to-top animate__faster d-none" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i></div><div id=toc-drawer-button class="fixed-button toc-drawer-button d-none" role=button aria-label=目录><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></div><div class="fixed-button view-comments d-none" role=button aria-label=查看评论><i class="fa-solid fa-comment fa-fw" aria-hidden=true></i></div></div><div id=mask></div><noscript><div class=noscript-warning>该网站在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/fuse/fuse.min.js defer></script><script src=/lib/instant-page/instantpage.min.js async defer type=module></script><script src=/lib/lightgallery/lightgallery.min.js defer></script><script src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js defer></script><script src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script src=/js/config/afde13a169a849f5b7c266f309d5aeb7.js defer></script><script src=/js/theme.min.js defer></script><script src=/js/custom.min.js defer></script></body></html>