<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>Zygote进程相关 - 文韬的文档</title><meta name=author content="wentao"><meta name=description content="【Android Framework系列】第3章 Zygote进程相关_android zygote进程-CSDN博客
1 Zygote简介 Zygote是Android中最重要的一个进程，Zygote进程和Init进程、SystemServer进程是Android最重要的三大进程。Zygote是Android系统创建新进程的核心进程，负责启动Dalvik虚拟机，加载一些必要的系统资源和系统类，启动system_server进程，随后进入等待处理app应用请求。
在Android系统中，应用程序进程都是由Zygote进程孵化出来的，而Zygote进程是由Init进程启动的。Zygote进程在启动时会创建一个Dalvik虚拟机实例，每当它孵化一个新的应用程序进程时，都会将这个Dalvik虚拟机实例复制到新的应用程序进程里面去，从而使得每一个应用程序进程都有一个独立的Dalvik虚拟机实例。
"><meta name=keywords content='blog,Framework'><meta itemprop=name content="Zygote进程相关"><meta itemprop=description content="【Android Framework系列】第3章 Zygote进程相关_android zygote进程-CSDN博客
1 Zygote简介 Zygote是Android中最重要的一个进程，Zygote进程和Init进程、SystemServer进程是Android最重要的三大进程。Zygote是Android系统创建新进程的核心进程，负责启动Dalvik虚拟机，加载一些必要的系统资源和系统类，启动system_server进程，随后进入等待处理app应用请求。
在Android系统中，应用程序进程都是由Zygote进程孵化出来的，而Zygote进程是由Init进程启动的。Zygote进程在启动时会创建一个Dalvik虚拟机实例，每当它孵化一个新的应用程序进程时，都会将这个Dalvik虚拟机实例复制到新的应用程序进程里面去，从而使得每一个应用程序进程都有一个独立的Dalvik虚拟机实例。"><meta itemprop=datePublished content="2024-11-06T06:57:58+00:00"><meta itemprop=dateModified content="2024-11-05T01:34:05+00:00"><meta itemprop=wordCount content="10379"><meta itemprop=keywords content="Blog,Framework"><meta property="og:url" content="https://huang8604.github.io/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/"><meta property="og:site_name" content="文韬的文档"><meta property="og:title" content="Zygote进程相关"><meta property="og:description" content="【Android Framework系列】第3章 Zygote进程相关_android zygote进程-CSDN博客
1 Zygote简介 Zygote是Android中最重要的一个进程，Zygote进程和Init进程、SystemServer进程是Android最重要的三大进程。Zygote是Android系统创建新进程的核心进程，负责启动Dalvik虚拟机，加载一些必要的系统资源和系统类，启动system_server进程，随后进入等待处理app应用请求。
在Android系统中，应用程序进程都是由Zygote进程孵化出来的，而Zygote进程是由Init进程启动的。Zygote进程在启动时会创建一个Dalvik虚拟机实例，每当它孵化一个新的应用程序进程时，都会将这个Dalvik虚拟机实例复制到新的应用程序进程里面去，从而使得每一个应用程序进程都有一个独立的Dalvik虚拟机实例。"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-06T06:57:58+00:00"><meta property="article:modified_time" content="2024-11-05T01:34:05+00:00"><meta property="article:tag" content="Blog"><meta property="article:tag" content="Framework"><meta name=twitter:card content="summary"><meta name=twitter:title content="Zygote进程相关"><meta name=twitter:description content="【Android Framework系列】第3章 Zygote进程相关_android zygote进程-CSDN博客
1 Zygote简介 Zygote是Android中最重要的一个进程，Zygote进程和Init进程、SystemServer进程是Android最重要的三大进程。Zygote是Android系统创建新进程的核心进程，负责启动Dalvik虚拟机，加载一些必要的系统资源和系统类，启动system_server进程，随后进入等待处理app应用请求。
在Android系统中，应用程序进程都是由Zygote进程孵化出来的，而Zygote进程是由Init进程启动的。Zygote进程在启动时会创建一个Dalvik虚拟机实例，每当它孵化一个新的应用程序进程时，都会将这个Dalvik虚拟机实例复制到新的应用程序进程里面去，从而使得每一个应用程序进程都有一个独立的Dalvik虚拟机实例。"><meta name=application-name content="文涛的记录"><meta name=apple-mobile-web-app-title content="文涛的记录"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical type=text/html href=https://huang8604.github.io/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/ title="Zygote进程相关 - 文韬的文档"><link rel=prev type=text/html href=https://huang8604.github.io/posts/%E5%8F%8C%E5%B1%8F%E5%8A%A8%E7%94%BB/ title=双屏动画><link rel=next type=text/html href=https://huang8604.github.io/posts/cts-%E5%9C%A8%E5%86%85%E7%BD%91%E6%9C%BA%E5%99%A8%E5%A6%82%E4%BD%95%E6%B5%8B%E8%AF%95/ title="CTS 在内网机器如何测试"><link rel=alternate type=text/markdown href=https://huang8604.github.io/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/index.md title="Zygote进程相关 - 文韬的文档"><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Zygote进程相关","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/huang8604.github.io\/posts\/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3\/"},"genre":"posts","keywords":"blog, Framework","wordcount":10379,"url":"https:\/\/huang8604.github.io\/posts\/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3\/","datePublished":"2024-11-06T06:57:58+00:00","dateModified":"2024-11-05T01:34:05+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"wentao"},"description":""}</script><script src=/js/head/color-scheme.min.js></script></head><body data-header-desktop=sticky data-header-mobile=auto><div class=wrapper data-page-style=wide><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=文韬的文档><img class=logo src=/images/doc.jpg alt=文韬的文档 height=32 width=32><span class=header-title-text>文韬的文档</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/archives/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 归档</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/collections/><i class="fa-solid fa-group fa-fw fa-sm" aria-hidden=true></i> 合集</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容…… id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=文韬的文档><img class=logo src=/images/doc.jpg alt=文韬的文档 height=26 width=26><span class=header-title-text>文韬的文档</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容…… id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/archives/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 归档</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/collections/><i class="fa-solid fa-group fa-fw fa-sm" aria-hidden=true></i> 合集</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label=合集></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>Zygote进程相关</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/huang8604 title=作者 target=_blank rel="external nofollow noopener noreferrer author" class=author><img class=avatar src='https://www.gravatar.com/avatar/b89538cdbc35c279ce1df9f3435f42a1?s=32&d=' alt=wentao height=16 width=16>&nbsp;wentao</a></span><span class=post-included-in>&nbsp;收录于 <a href=/categories/%E5%AD%A6%E4%B9%A0%E6%80%BB%E7%BB%93/ class=post-category title="分类 - 学习总结"><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> 学习总结</a> 和 <a href=/collections/%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8/ class=post-collection title="合集 - 开机启动"><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i> 开机启动</a></span></div><div class=post-meta-line><span title="发布于 2024-11-06 06:57:58"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden=true></i><time datetime=2024-11-06>2024-11-06</time></span>&nbsp;<span title="更新于 2024-11-05 01:34:05"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden=true></i><time datetime=2024-11-05>2024-11-05</time></span>&nbsp;<span title="10379 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 10400 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 21 分钟</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#1-zygote简介>【Android Framework系列】第3章 Zygote进程相关_android zygote进程-CSDN博客<br>1 Zygote简介</a></li><li><a href=#2-zygote启动>2 Zygote启动</a><ul><li><a href=#21-init进程解析initrc脚本>2.1 init进程解析init.rc脚本</a></li><li><a href=#22-androidruntime启动zygoteinit>2.2 AndroidRuntime启动ZygoteInit</a></li><li><a href=#23-zygoteinit初始化>2.3 ZygoteInit初始化</a><ul><li><a href=#231-preload>2.3.1 preload()</a></li><li><a href=#232-zygoteserver>2.3.2 ZygoteServer</a></li><li><a href=#233-创建systemserver进程>2.3.3 创建SystemServer进程</a></li></ul></li><li><a href=#24-zygote启动流程图>2.4 Zygote启动流程图</a></li></ul></li><li><a href=#3-总结>3 总结</a></li><li><a href=#4-面试题>4 面试题</a><ul><li><a href=#1-init进程作用是什么>1 init进程作用是什么</a></li><li><a href=#2-zygote进程最原始的进程是什么进程或者zygote进程由来>2 Zygote进程最原始的进程是什么进程(或者Zygote进程由来)</a></li><li><a href=#3-zygote-是在内核空间还是在用户空间>3 Zygote 是在内核空间还是在用户空间？</a></li><li><a href=#4-zygote为什么需要用到socket通信而不是binder>4 Zygote为什么需要用到Socket通信而不是Binder</a></li><li><a href=#5-每个app都会将系统的资源系统的类都加载一遍吗>5 每个App都会将系统的资源，系统的类都加载一遍吗</a></li></ul></li></ul></nav></div></div><div class=content id=content><h2 class=heading-element id=1-zygote简介><span><a href=https://blog.csdn.net/u010687761/article/details/131404918 target=_blank rel="external nofollow noopener noreferrer">【Android Framework系列】第3章 Zygote进程相关_android zygote进程-CSDN博客</a><br>1 Zygote简介</span>
<a href=#1-zygote%e7%ae%80%e4%bb%8b class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>Zygote是Android中最重要的一个进程，<code>Zygote进程和Init进程、SystemServer进程是Android最重要的三大进程</code>。<strong>Zygote是Android系统创建新进程的核心进程，负责启动Dalvik虚拟机，加载一些必要的系统资源和系统类，启动system_server进程，随后进入等待处理app应用请求。</strong><br>在Android系统中，应用程序进程都是由Zygote进程孵化出来的，而Zygote进程是由Init进程启动的。Zygote进程在启动时会创建一个Dalvik虚拟机实例，每当它孵化一个新的应用程序进程时，都会将这个Dalvik虚拟机实例复制到新的应用程序进程里面去，从而使得每一个应用程序进程都有一个独立的Dalvik虚拟机实例。</p><p><strong>Zygote涉及的类：</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>    frameworks/base/cmds/app_process/app_main.cpp
</span></span><span class=line><span class=cl>    frameworks/base/core/jni/AndroidRuntime.cpp
</span></span><span class=line><span class=cl>    frameworks/base/core/java/com/android/internal/os/
</span></span><span class=line><span class=cl>      - Zygote.java
</span></span><span class=line><span class=cl>      - ZygoteInit.java
</span></span><span class=line><span class=cl>      - ZygoteServer.java
</span></span><span class=line><span class=cl>      - ZygoteConnection.java
</span></span><span class=line><span class=cl>    </span></span></code></pre></td></tr></table></div></div><h2 class=heading-element id=2-zygote启动><span>2 Zygote启动</span>
<a href=#2-zygote%e5%90%af%e5%8a%a8 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p><strong>本文基于<code>Android10（Q）</code>的源码做分析</strong></p><h3 class=heading-element id=21-init进程解析initrc脚本><span>2.1 init进程解析init.rc脚本</span>
<a href=#21-init%e8%bf%9b%e7%a8%8b%e8%a7%a3%e6%9e%90initrc%e8%84%9a%e6%9c%ac class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>Zygote由<code>init进程</code>解析<code>init.rc</code>脚本启动的。脚本传入<code>app_process的main方法</code>做分割，根据字符串命令做相应逻辑。</p><blockquote><p>现在机器分为32位和64位，Zygote的启动脚本init.rc也各有区别:</p><ul><li>init.zygote32.rc：zygote进程对应的执行程序是app_process(纯32bit模式)</li><li>init.zygote64.rc：zygote进程对应的执行程序是app_process64(纯64bit模式)</li><li>init.zygote32_64.rc：启动两个zygote进程，对应的执行程序分别是app_process32(主模式)、app_process64</li><li>init.zygote64_32.rc：启动两个zygote进程，对应的执行程序分别是app_process64(主模式)、app_process32</li></ul></blockquote><p>zygote要执行的程序便是<code>system/bin/app_process</code>，它的源代码在<code>app_main.cpp</code>。我们先来看看app_main是如何处理脚本命令：<br>frameworks/base/cmds/app_process/app_main.cpp</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=n>165</span><span class=w>  </span><span class=err>#</span><span class=k>if</span><span class=w> </span><span class=n>defined</span><span class=p>(</span><span class=n>__LP64__</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>166</span><span class=w>  </span><span class=kd>static</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=n>ABI_LIST_PROPERTY</span><span class=o>[]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;ro.product.cpu.abilist64&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>167</span><span class=w>  </span><span class=kd>static</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=n>ZYGOTE_NICE_NAME</span><span class=o>[]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;zygote64&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>168</span><span class=w>  </span><span class=err>#</span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>169</span><span class=w>  </span><span class=kd>static</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=n>ABI_LIST_PROPERTY</span><span class=o>[]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;ro.product.cpu.abilist32&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>170</span><span class=w>  </span><span class=kd>static</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=n>ZYGOTE_NICE_NAME</span><span class=o>[]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;zygote&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>171</span><span class=w>  </span><span class=err>#</span><span class=n>endif</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>172</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>173</span><span class=w>  </span><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>argc</span><span class=p>,</span><span class=w> </span><span class=kt>char</span><span class=o>*</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=n>argv</span><span class=o>[]</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>174</span><span class=w>  </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>256</span><span class=w>      </span><span class=c1>// Parse runtime arguments.  Stop at first unrecognized option.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>257</span><span class=w>      </span><span class=n>bool</span><span class=w> </span><span class=n>zygote</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>258</span><span class=w>      </span><span class=n>bool</span><span class=w> </span><span class=n>startSystemServer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>259</span><span class=w>      </span><span class=n>bool</span><span class=w> </span><span class=n>application</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>260</span><span class=w>      </span><span class=n>String8</span><span class=w> </span><span class=n>niceName</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>261</span><span class=w>      </span><span class=n>String8</span><span class=w> </span><span class=n>className</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>262</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>263</span><span class=w>      </span><span class=o>++</span><span class=n>i</span><span class=p>;</span><span class=w>  </span><span class=c1>// Skip unused &#34;parent dir&#34; argument.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>264</span><span class=w>      </span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>argc</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>265</span><span class=w>          </span><span class=kd>const</span><span class=w> </span><span class=kt>char</span><span class=o>*</span><span class=w> </span><span class=n>arg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>argv</span><span class=o>[</span><span class=n>i</span><span class=o>++]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>266</span><span class=w>          </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>arg</span><span class=p>,</span><span class=w> </span><span class=s>&#34;--zygote&#34;</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>267</span><span class=w>              </span><span class=n>zygote</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>268</span><span class=w>              </span><span class=n>niceName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ZYGOTE_NICE_NAME</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>269</span><span class=w>          </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>arg</span><span class=p>,</span><span class=w> </span><span class=s>&#34;--start-system-server&#34;</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>270</span><span class=w>              </span><span class=n>startSystemServer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>271</span><span class=w>          </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>strcmp</span><span class=p>(</span><span class=n>arg</span><span class=p>,</span><span class=w> </span><span class=s>&#34;--application&#34;</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>272</span><span class=w>              </span><span class=n>application</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>273</span><span class=w>          </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>strncmp</span><span class=p>(</span><span class=n>arg</span><span class=p>,</span><span class=w> </span><span class=s>&#34;--nice-name=&#34;</span><span class=p>,</span><span class=w> </span><span class=n>12</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>274</span><span class=w>              </span><span class=n>niceName</span><span class=p>.</span><span class=na>setTo</span><span class=p>(</span><span class=n>arg</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>12</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>275</span><span class=w>          </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>strncmp</span><span class=p>(</span><span class=n>arg</span><span class=p>,</span><span class=w> </span><span class=s>&#34;--&#34;</span><span class=p>,</span><span class=w> </span><span class=n>2</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>276</span><span class=w>              </span><span class=n>className</span><span class=p>.</span><span class=na>setTo</span><span class=p>(</span><span class=n>arg</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>277</span><span class=w>              </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>278</span><span class=w>          </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>279</span><span class=w>              </span><span class=o>--</span><span class=n>i</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>280</span><span class=w>              </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>281</span><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>282</span><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>309</span><span class=w>          </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>startSystemServer</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>310</span><span class=w>              </span><span class=n>args</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>String8</span><span class=p>(</span><span class=s>&#34;start-system-server&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>311</span><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>331</span><span class=w>      </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>niceName</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>332</span><span class=w>          </span><span class=n>runtime</span><span class=p>.</span><span class=na>setArgv0</span><span class=p>(</span><span class=n>niceName</span><span class=p>.</span><span class=na>string</span><span class=p>(),</span><span class=w> </span><span class=kc>true</span><span class=w> </span><span class=cm>/* setProcName */</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>333</span><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>334</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>335</span><span class=w>      </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>zygote</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>336</span><span class=w>          </span><span class=n>runtime</span><span class=p>.</span><span class=na>start</span><span class=p>(</span><span class=s>&#34;com.android.internal.os.ZygoteInit&#34;</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=p>,</span><span class=w> </span><span class=n>zygote</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>337</span><span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>className</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>338</span><span class=w>          </span><span class=n>runtime</span><span class=p>.</span><span class=na>start</span><span class=p>(</span><span class=s>&#34;com.android.internal.os.RuntimeInit&#34;</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=p>,</span><span class=w> </span><span class=n>zygote</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>339</span><span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>340</span><span class=w>          </span><span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Error: no class name or --zygote supplied.\n&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>341</span><span class=w>          </span><span class=nf>app_usage</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>342</span><span class=w>          </span><span class=nf>LOG_ALWAYS_FATAL</span><span class=p>(</span><span class=s>&#34;app_process: no class name or --zygote supplied.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>343</span><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>344</span><span class=w>  </span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>我们拿<code>init.zygote64.rc</code>为例：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=n>1</span><span class=w> </span><span class=n>service</span><span class=w> </span><span class=n>zygote</span><span class=w> </span><span class=o>/</span><span class=n>system</span><span class=o>/</span><span class=n>bin</span><span class=o>/</span><span class=n>app_process64</span><span class=w> </span><span class=o>-</span><span class=n>Xzygote</span><span class=w> </span><span class=o>/</span><span class=n>system</span><span class=o>/</span><span class=n>bin</span><span class=w> </span><span class=o>--</span><span class=n>zygote</span><span class=w> </span><span class=o>--</span><span class=n>start</span><span class=o>-</span><span class=n>system</span><span class=o>-</span><span class=n>server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>2</span><span class=w>     </span><span class=kd>class</span> <span class=nc>main</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>3</span><span class=w>     </span><span class=n>priority</span><span class=w> </span><span class=o>-</span><span class=n>20</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>4</span><span class=w>     </span><span class=n>user</span><span class=w> </span><span class=n>root</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>5</span><span class=w>     </span><span class=n>group</span><span class=w> </span><span class=n>root</span><span class=w> </span><span class=n>readproc</span><span class=w> </span><span class=n>reserved_disk</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>6</span><span class=w>     </span><span class=n>socket</span><span class=w> </span><span class=n>zygote</span><span class=w> </span><span class=n>stream</span><span class=w> </span><span class=n>660</span><span class=w> </span><span class=n>root</span><span class=w> </span><span class=n>system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>7</span><span class=w>     </span><span class=n>socket</span><span class=w> </span><span class=n>usap_pool_primary</span><span class=w> </span><span class=n>stream</span><span class=w> </span><span class=n>660</span><span class=w> </span><span class=n>root</span><span class=w> </span><span class=n>system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>8</span><span class=w>     </span><span class=n>onrestart</span><span class=w> </span><span class=n>write</span><span class=w> </span><span class=o>/</span><span class=n>sys</span><span class=o>/</span><span class=n>android_power</span><span class=o>/</span><span class=n>request_state</span><span class=w> </span><span class=n>wake</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>9</span><span class=w>     </span><span class=n>onrestart</span><span class=w> </span><span class=n>write</span><span class=w> </span><span class=o>/</span><span class=n>sys</span><span class=o>/</span><span class=n>power</span><span class=o>/</span><span class=n>state</span><span class=w> </span><span class=n>on</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>10</span><span class=w>     </span><span class=n>onrestart</span><span class=w> </span><span class=n>restart</span><span class=w> </span><span class=n>audioserver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>11</span><span class=w>     </span><span class=n>onrestart</span><span class=w> </span><span class=n>restart</span><span class=w> </span><span class=n>cameraserver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>12</span><span class=w>     </span><span class=n>onrestart</span><span class=w> </span><span class=n>restart</span><span class=w> </span><span class=n>media</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>13</span><span class=w>     </span><span class=n>onrestart</span><span class=w> </span><span class=n>restart</span><span class=w> </span><span class=n>netd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>14</span><span class=w>     </span><span class=n>onrestart</span><span class=w> </span><span class=n>restart</span><span class=w> </span><span class=n>wificond</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>15</span><span class=w>     </span><span class=n>writepid</span><span class=w> </span><span class=o>/</span><span class=n>dev</span><span class=o>/</span><span class=n>cpuset</span><span class=o>/</span><span class=n>foreground</span><span class=o>/</span><span class=n>tasks</span></span></span></code></pre></td></tr></table></div></div><p>主要是这个脚本命令：<code>service zygote /system/bin/app_process64 -Xzygote /system/bin --zygote --start-system-server</code></p><blockquote><p>实际上会被分割成：<br>service：服务标识<br>zygote：表示要开启的服务名字<br>/system/bin/app_process64：服务对应的路径<br>-Xzygote：作为虚拟机启动时所需要的参数,在AndroidRuntime.cpp中的 startVm() 中调用JNI_CreateJavaVM 使用到<br>/system/bin：代表虚拟机程序所在目录,因为 app_process 可以不和虚拟机在一个目录,所以 app_process 需要知道虚拟机所在的目录<br>–zygote ：指明以 ZygoteInit 类作为入口,否则需要指定需要执行的类名<br>–start-system-server：仅在有 &ndash;zygote 参数时可用,告知 ZygoteInit 启动完毕后孵化出的第一个进程是 SystemServer</p></blockquote><ol><li>第一个if中<code>"--zygote"</code>命中，<code>zygote变量</code>置为<code>true</code>表示要启动<code>zygote进程</code>，并将<code>进程名</code>改成了<code>zygote</code>或<code>zygote64</code></li><li>第二个if中<code>"--start-system-server"</code>命中，<code>startSystemServer变量</code>置为<code>true</code>表示要启动<code>SystemServer进程</code></li></ol><p><code>app_main.cpp</code>的<code>main方法</code>执行后，<code>ZygoteInit</code>已经通过<code>runtime.start("com.android.internal.os.ZygoteInit", args, zygote);</code>被启动了</p><h3 class=heading-element id=22-androidruntime启动zygoteinit><span>2.2 AndroidRuntime启动ZygoteInit</span>
<a href=#22-androidruntime%e5%90%af%e5%8a%a8zygoteinit class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>其中<code>runtime</code>就是<code>AndroidRuntime</code>类，我们来看看<code>AndroidRuntime</code>的<code>start方法</code>：<br>/frameworks/base/core/<a href="https://so.csdn.net/so/search?q=jni%5c&amp;spm=1001.2101.3001.7020" target=_blank rel="external nofollow noopener noreferrer">jni</a>/AndroidRuntime.cpp</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=n>1112</span><span class=w>  </span><span class=n>java</span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>    1113   * Start the Android runtime.  This involves starting the virtual machine
</span></span></span><span class=line><span class=cl><span class=cm>    1114   * and calling the &#34;static void main(String[] args)&#34; method in the class
</span></span></span><span class=line><span class=cl><span class=cm>    1115   * named by &#34;className&#34;.
</span></span></span><span class=line><span class=cl><span class=cm>    1116   *
</span></span></span><span class=line><span class=cl><span class=cm>    1117   * Passes the main function two arguments, the class name and the specified
</span></span></span><span class=line><span class=cl><span class=cm>    1118   * options string.
</span></span></span><span class=line><span class=cl><span class=cm>    1119   */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1120</span><span class=w>  </span><span class=kt>void</span><span class=w> </span><span class=n>AndroidRuntime</span><span class=p>::</span><span class=n>start</span><span class=p>(</span><span class=kd>const</span><span class=w> </span><span class=kt>char</span><span class=o>*</span><span class=w> </span><span class=n>className</span><span class=p>,</span><span class=w> </span><span class=kd>const</span><span class=w> </span><span class=n>Vector</span><span class=o>&lt;</span><span class=n>String8</span><span class=o>&gt;&amp;</span><span class=w> </span><span class=n>options</span><span class=p>,</span><span class=w> </span><span class=n>bool</span><span class=w> </span><span class=n>zygote</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1121</span><span class=w>  </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1164</span><span class=w>      </span><span class=cm>/* start the virtual machine */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1165</span><span class=w>      </span><span class=n>JniInvocation</span><span class=w> </span><span class=n>jni_invocation</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1166</span><span class=w>      </span><span class=n>jni_invocation</span><span class=p>.</span><span class=na>Init</span><span class=p>(</span><span class=n>NULL</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1167</span><span class=w>      </span><span class=n>JNIEnv</span><span class=o>*</span><span class=w> </span><span class=n>env</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1168</span><span class=w>      </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>startVm</span><span class=p>(</span><span class=o>&amp;</span><span class=n>mJavaVM</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=n>zygote</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1169</span><span class=w>          </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1170</span><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1171</span><span class=w>      </span><span class=nf>onVmCreated</span><span class=p>(</span><span class=n>env</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1172</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1173</span><span class=w>      </span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>    1174       * Register android functions.
</span></span></span><span class=line><span class=cl><span class=cm>    1175       */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1176</span><span class=w>      </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>startReg</span><span class=p>(</span><span class=n>env</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1177</span><span class=w>          </span><span class=nf>ALOGE</span><span class=p>(</span><span class=s>&#34;Unable to register all android natives\n&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1178</span><span class=w>          </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1179</span><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1203</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1204</span><span class=w>      </span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>    1205       * Start VM.  This thread becomes the main thread of the VM, and will
</span></span></span><span class=line><span class=cl><span class=cm>    1206       * not return until the VM exits.
</span></span></span><span class=line><span class=cl><span class=cm>    1207       */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1208</span><span class=w>      </span><span class=kt>char</span><span class=o>*</span><span class=w> </span><span class=n>slashClassName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>toSlashClassName</span><span class=p>(</span><span class=n>className</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>NULL</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>className</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1209</span><span class=w>      </span><span class=n>jclass</span><span class=w> </span><span class=n>startClass</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>env</span><span class=o>-&gt;</span><span class=n>FindClass</span><span class=p>(</span><span class=n>slashClassName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1210</span><span class=w>      </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>startClass</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>NULL</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1211</span><span class=w>          </span><span class=nf>ALOGE</span><span class=p>(</span><span class=s>&#34;JavaVM unable to locate class &#39;%s&#39;\n&#34;</span><span class=p>,</span><span class=w> </span><span class=n>slashClassName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1212</span><span class=w>          </span><span class=cm>/* keep going */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1213</span><span class=w>      </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1214</span><span class=w>          </span><span class=n>jmethodID</span><span class=w> </span><span class=n>startMeth</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>env</span><span class=o>-&gt;</span><span class=n>GetStaticMethodID</span><span class=p>(</span><span class=n>startClass</span><span class=p>,</span><span class=w> </span><span class=s>&#34;main&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1215</span><span class=w>              </span><span class=s>&#34;([Ljava/lang/String;)V&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1216</span><span class=w>          </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>startMeth</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>NULL</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1217</span><span class=w>              </span><span class=nf>ALOGE</span><span class=p>(</span><span class=s>&#34;JavaVM unable to find main() in &#39;%s&#39;\n&#34;</span><span class=p>,</span><span class=w> </span><span class=n>className</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1218</span><span class=w>              </span><span class=cm>/* keep going */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1219</span><span class=w>          </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1220</span><span class=w>              </span><span class=n>env</span><span class=o>-&gt;</span><span class=n>CallStaticVoidMethod</span><span class=p>(</span><span class=n>startClass</span><span class=p>,</span><span class=w> </span><span class=n>startMeth</span><span class=p>,</span><span class=w> </span><span class=n>strArray</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1226</span><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1227</span><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>1235</span><span class=w>  </span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>对虚拟机和JNI方法的一些注册后，通过<code>CallStaticVoidMethod</code>来调用传过来的类名的<code>main函数</code>，我们传递过来的类名是<code>com.android.internal.os.ZygoteInit</code><br><strong>AndroidRuntime中主要做了这三件事：</strong></p><blockquote><ol><li>startVm() 创建虚拟机</li><li>startReg() 动态注册 java 调用 native 的 jni</li><li>反射调用 ZygoteInit 的 main()</li></ol></blockquote><h3 class=heading-element id=23-zygoteinit初始化><span>2.3 ZygoteInit初始化</span>
<a href=#23-zygoteinit%e5%88%9d%e5%a7%8b%e5%8c%96 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p><code>AndroidRuntime</code>在<code>Native层</code>创建了<code>Zygote</code>，并且通过<code>AndroidRuntime.start()</code>从<code>Native层</code>转到<code>Java层ZygoteInit的main()</code>入口，<code>ZygoteInit的main()方法</code>是Android启动的<code>第一个Java进程主方法</code><br>/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=n>818</span><span class=w>      </span><span class=nd>@UnsupportedAppUsage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>819</span><span class=w>      </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>main</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>argv</span><span class=o>[]</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>820</span><span class=w>          </span><span class=n>ZygoteServer</span><span class=w> </span><span class=n>zygoteServer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>833</span><span class=w>          </span><span class=n>Runnable</span><span class=w> </span><span class=n>caller</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>834</span><span class=w>          </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>847</span><span class=w>              </span><span class=kt>boolean</span><span class=w> </span><span class=n>startSystemServer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>848</span><span class=w>              </span><span class=n>String</span><span class=w> </span><span class=n>zygoteSocketName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;zygote&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>849</span><span class=w>              </span><span class=n>String</span><span class=w> </span><span class=n>abiList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>850</span><span class=w>              </span><span class=kt>boolean</span><span class=w> </span><span class=n>enableLazyPreload</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>851</span><span class=w>              </span><span class=nf>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>argv</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>852</span><span class=w>                  </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=s>&#34;start-system-server&#34;</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>argv</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>853</span><span class=w>                      </span><span class=n>startSystemServer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>854</span><span class=w>                  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=s>&#34;--enable-lazy-preload&#34;</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>argv</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>855</span><span class=w>                      </span><span class=n>enableLazyPreload</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>856</span><span class=w>                  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>argv</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=n>ABI_LIST_ARG</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>857</span><span class=w>                      </span><span class=n>abiList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>argv</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>.</span><span class=na>substring</span><span class=p>(</span><span class=n>ABI_LIST_ARG</span><span class=p>.</span><span class=na>length</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>858</span><span class=w>                  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>argv</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=n>SOCKET_NAME_ARG</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>859</span><span class=w>                      </span><span class=n>zygoteSocketName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>argv</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>.</span><span class=na>substring</span><span class=p>(</span><span class=n>SOCKET_NAME_ARG</span><span class=p>.</span><span class=na>length</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>860</span><span class=w>                  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>861</span><span class=w>                      </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=nf>RuntimeException</span><span class=p>(</span><span class=s>&#34;Unknown command line argument: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>argv</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>862</span><span class=w>                  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>863</span><span class=w>              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>864</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>865</span><span class=w>              </span><span class=kd>final</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>isPrimaryZygote</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>zygoteSocketName</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>Zygote</span><span class=p>.</span><span class=na>PRIMARY_SOCKET_NAME</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>866</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>867</span><span class=w>              </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>abiList</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>868</span><span class=w>                  </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=nf>RuntimeException</span><span class=p>(</span><span class=s>&#34;No ABI list supplied.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>869</span><span class=w>              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>870</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>871</span><span class=w>              </span><span class=c1>// In some configurations, we avoid preloading resources and classes eagerly.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>872</span><span class=w>              </span><span class=c1>// In such cases, we will preload things prior to our first fork.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>873</span><span class=w>              </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>enableLazyPreload</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>877</span><span class=w>                  </span><span class=nf>preload</span><span class=p>(</span><span class=n>bootTimingsTraceLog</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>881</span><span class=w>              </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>882</span><span class=w>                  </span><span class=n>Zygote</span><span class=p>.</span><span class=na>resetNicePriority</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>883</span><span class=w>              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>896</span><span class=w>              </span><span class=n>Zygote</span><span class=p>.</span><span class=na>initNativeState</span><span class=p>(</span><span class=n>isPrimaryZygote</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>897</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>898</span><span class=w>              </span><span class=n>ZygoteHooks</span><span class=p>.</span><span class=na>stopZygoteNoThreadCreation</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>899</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>900</span><span class=w>              </span><span class=n>zygoteServer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ZygoteServer</span><span class=p>(</span><span class=n>isPrimaryZygote</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>901</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>902</span><span class=w>              </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>startSystemServer</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>903</span><span class=w>                  </span><span class=n>Runnable</span><span class=w> </span><span class=n>r</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>forkSystemServer</span><span class=p>(</span><span class=n>abiList</span><span class=p>,</span><span class=w> </span><span class=n>zygoteSocketName</span><span class=p>,</span><span class=w> </span><span class=n>zygoteServer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>904</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>905</span><span class=w>                  </span><span class=c1>// {@code r == null} in the parent (zygote) process, and {@code r != null} in the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>906</span><span class=w>                  </span><span class=c1>// child (system_server) process.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>907</span><span class=w>                  </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>r</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>908</span><span class=w>                      </span><span class=n>r</span><span class=p>.</span><span class=na>run</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>909</span><span class=w>                      </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>910</span><span class=w>                  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>911</span><span class=w>              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>912</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>913</span><span class=w>              </span><span class=n>Log</span><span class=p>.</span><span class=na>i</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Accepting command socket connections&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>914</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>915</span><span class=w>              </span><span class=c1>// The select loop returns early in the child process after a fork and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>916</span><span class=w>              </span><span class=c1>// loops forever in the zygote.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>917</span><span class=w>              </span><span class=n>caller</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>zygoteServer</span><span class=p>.</span><span class=na>runSelectLoop</span><span class=p>(</span><span class=n>abiList</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>918</span><span class=w>          </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>919</span><span class=w>              </span><span class=n>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;System zygote died with exception&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>920</span><span class=w>              </span><span class=k>throw</span><span class=w> </span><span class=n>ex</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>921</span><span class=w>          </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>922</span><span class=w>              </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>zygoteServer</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>923</span><span class=w>                  </span><span class=n>zygoteServer</span><span class=p>.</span><span class=na>closeServerSocket</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>924</span><span class=w>              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>925</span><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>926</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>927</span><span class=w>          </span><span class=c1>// We&#39;re in the child process and have exited the select loop. Proceed to execute the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>928</span><span class=w>          </span><span class=c1>// command.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>929</span><span class=w>          </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>caller</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>930</span><span class=w>              </span><span class=n>caller</span><span class=p>.</span><span class=na>run</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>931</span><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>932</span><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span></span></span></code></pre></td></tr></table></div></div><p>主要做了3件事：</p><blockquote><ol><li><code>preload()预先加载系统资源，如系统类、资源、系统共享库等</code></li><li><code>创建 ZygoteServer，其实就是 ServerSocket 循环等待通知 fork 子进程</code></li><li><code>创建 SystemServer进程</code></li></ol></blockquote><h4 class=heading-element id=231-preload><span>2.3.1 preload()</span>
<a href=#231-preload class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p><code>preload()</code>：资源准备，包括<a href="https://so.csdn.net/so/search?q=%E7%B1%BB%E5%8A%A0%E8%BD%BD%5c&amp;spm=1001.2101.3001.7020" target=_blank rel="external nofollow noopener noreferrer">类加载</a>，资源加载等</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=n>135</span><span class=w>      </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>preload</span><span class=p>(</span><span class=n>TimingsTraceLog</span><span class=w> </span><span class=n>bootTimingsTraceLog</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>138</span><span class=w>          </span><span class=nf>beginPreload</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>141</span><span class=w>          </span><span class=nf>preloadClasses</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>144</span><span class=w>          </span><span class=nf>cacheNonBootClasspathClassLoaders</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>147</span><span class=w>          </span><span class=nf>preloadResources</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>150</span><span class=w>          </span><span class=nf>nativePreloadAppProcessHALs</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>153</span><span class=w>          </span><span class=nf>maybePreloadGraphicsDriver</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>155</span><span class=w>          </span><span class=nf>preloadSharedLibraries</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>156</span><span class=w>          </span><span class=nf>preloadTextResources</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>157</span><span class=w>          </span><span class=c1>// Ask the WebViewFactory to do any initialization that must run in the zygote process,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>158</span><span class=w>          </span><span class=c1>// for memory sharing purposes.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>159</span><span class=w>          </span><span class=n>WebViewFactory</span><span class=p>.</span><span class=na>prepareWebViewInZygote</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>160</span><span class=w>          </span><span class=nf>endPreload</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>161</span><span class=w>          </span><span class=nf>warmUpJcaProviders</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>164</span><span class=w>          </span><span class=n>sPreloadComplete</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>165</span><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>244</span><span class=w>      </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>    245       * Performs Zygote process initialization. Loads and initializes commonly used classes.
</span></span></span><span class=line><span class=cl><span class=cm>    246       *
</span></span></span><span class=line><span class=cl><span class=cm>    247       * Most classes only cause a few hundred bytes to be allocated, but a few will allocate a dozen
</span></span></span><span class=line><span class=cl><span class=cm>    248       * Kbytes (in one case, 500+K).
</span></span></span><span class=line><span class=cl><span class=cm>    249       */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>250</span><span class=w>      </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>preloadClasses</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>251</span><span class=w>          </span><span class=kd>final</span><span class=w> </span><span class=n>VMRuntime</span><span class=w> </span><span class=n>runtime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>VMRuntime</span><span class=p>.</span><span class=na>getRuntime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>252</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>253</span><span class=w>          </span><span class=n>InputStream</span><span class=w> </span><span class=n>is</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>254</span><span class=w>          </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>255</span><span class=w>              </span><span class=n>is</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FileInputStream</span><span class=p>(</span><span class=n>PRELOADED_CLASSES</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>256</span><span class=w>          </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>FileNotFoundException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>257</span><span class=w>              </span><span class=n>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Couldn&#39;t find &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>PRELOADED_CLASSES</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>258</span><span class=w>              </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>259</span><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>260</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>261</span><span class=w>          </span><span class=n>Log</span><span class=p>.</span><span class=na>i</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Preloading classes...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>262</span><span class=w>          </span><span class=kt>long</span><span class=w> </span><span class=n>startTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SystemClock</span><span class=p>.</span><span class=na>uptimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>263</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>264</span><span class=w>          </span><span class=c1>// Drop root perms while running static initializers.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>265</span><span class=w>          </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>reuid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Os</span><span class=p>.</span><span class=na>getuid</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>266</span><span class=w>          </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>regid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Os</span><span class=p>.</span><span class=na>getgid</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>267</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>268</span><span class=w>          </span><span class=c1>// We need to drop root perms only if we&#39;re already root. In the case of &#34;wrapped&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>269</span><span class=w>          </span><span class=c1>// processes (see WrapperInit), this function is called from an unprivileged uid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>270</span><span class=w>          </span><span class=c1>// and gid.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>271</span><span class=w>          </span><span class=kt>boolean</span><span class=w> </span><span class=n>droppedPriviliges</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>272</span><span class=w>          </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>reuid</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>ROOT_UID</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>regid</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>ROOT_GID</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>273</span><span class=w>              </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>274</span><span class=w>                  </span><span class=n>Os</span><span class=p>.</span><span class=na>setregid</span><span class=p>(</span><span class=n>ROOT_GID</span><span class=p>,</span><span class=w> </span><span class=n>UNPRIVILEGED_GID</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>275</span><span class=w>                  </span><span class=n>Os</span><span class=p>.</span><span class=na>setreuid</span><span class=p>(</span><span class=n>ROOT_UID</span><span class=p>,</span><span class=w> </span><span class=n>UNPRIVILEGED_UID</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>276</span><span class=w>              </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>ErrnoException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>277</span><span class=w>                  </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=nf>RuntimeException</span><span class=p>(</span><span class=s>&#34;Failed to drop root&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>278</span><span class=w>              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>279</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>280</span><span class=w>              </span><span class=n>droppedPriviliges</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>281</span><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>282</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>283</span><span class=w>          </span><span class=c1>// Alter the target heap utilization.  With explicit GCs this</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>284</span><span class=w>          </span><span class=c1>// is not likely to have any effect.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>285</span><span class=w>          </span><span class=kt>float</span><span class=w> </span><span class=n>defaultUtilization</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>runtime</span><span class=p>.</span><span class=na>getTargetHeapUtilization</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>286</span><span class=w>          </span><span class=n>runtime</span><span class=p>.</span><span class=na>setTargetHeapUtilization</span><span class=p>(</span><span class=n>0</span><span class=p>.</span><span class=na>8f</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>287</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>288</span><span class=w>          </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>289</span><span class=w>              </span><span class=n>BufferedReader</span><span class=w> </span><span class=n>br</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>290</span><span class=w>                      </span><span class=k>new</span><span class=w> </span><span class=nf>BufferedReader</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>InputStreamReader</span><span class=p>(</span><span class=n>is</span><span class=p>),</span><span class=w> </span><span class=n>Zygote</span><span class=p>.</span><span class=na>SOCKET_BUFFER_SIZE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>291</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>292</span><span class=w>              </span><span class=kt>int</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>293</span><span class=w>              </span><span class=n>String</span><span class=w> </span><span class=n>line</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>294</span><span class=w>              </span><span class=nf>while</span><span class=w> </span><span class=p>((</span><span class=n>line</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>br</span><span class=p>.</span><span class=na>readLine</span><span class=p>())</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>295</span><span class=w>                  </span><span class=c1>// Skip comments and blank lines.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>296</span><span class=w>                  </span><span class=n>line</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>line</span><span class=p>.</span><span class=na>trim</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>297</span><span class=w>                  </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>line</span><span class=p>.</span><span class=na>startsWith</span><span class=p>(</span><span class=s>&#34;#&#34;</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>line</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>298</span><span class=w>                      </span><span class=k>continue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>299</span><span class=w>                  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>300</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>301</span><span class=w>                  </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceBegin</span><span class=p>(</span><span class=n>Trace</span><span class=p>.</span><span class=na>TRACE_TAG_DALVIK</span><span class=p>,</span><span class=w> </span><span class=n>line</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>302</span><span class=w>                  </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>303</span><span class=w>                      </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=kc>false</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>304</span><span class=w>                          </span><span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Preloading &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>line</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>305</span><span class=w>                      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>306</span><span class=w>                      </span><span class=c1>// Load and explicitly initialize the given class. Use</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>307</span><span class=w>                      </span><span class=c1>// Class.forName(String, boolean, ClassLoader) to avoid repeated stack lookups</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>308</span><span class=w>                      </span><span class=c1>// (to derive the caller&#39;s class-loader). Use true to force initialization, and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>309</span><span class=w>                      </span><span class=c1>// null for the boot classpath class-loader (could as well cache the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>310</span><span class=w>                      </span><span class=c1>// class-loader of this class in a variable).</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>311</span><span class=w>                      </span><span class=n>Class</span><span class=p>.</span><span class=na>forName</span><span class=p>(</span><span class=n>line</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>312</span><span class=w>                      </span><span class=n>count</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>313</span><span class=w>                  </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>ClassNotFoundException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>314</span><span class=w>                      </span><span class=n>Log</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Class not found for preloading: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>line</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>315</span><span class=w>                  </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>UnsatisfiedLinkError</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>316</span><span class=w>                      </span><span class=n>Log</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Problem preloading &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>line</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>317</span><span class=w>                  </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Throwable</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>318</span><span class=w>                      </span><span class=n>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Error preloading &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>line</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.&#34;</span><span class=p>,</span><span class=w> </span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>319</span><span class=w>                      </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>Error</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>320</span><span class=w>                          </span><span class=nf>throw</span><span class=w> </span><span class=p>(</span><span class=n>Error</span><span class=p>)</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>321</span><span class=w>                      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>322</span><span class=w>                      </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=k>instanceof</span><span class=w> </span><span class=n>RuntimeException</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>323</span><span class=w>                          </span><span class=nf>throw</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=p>)</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>324</span><span class=w>                      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>325</span><span class=w>                      </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=nf>RuntimeException</span><span class=p>(</span><span class=n>t</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>326</span><span class=w>                  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>327</span><span class=w>                  </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceEnd</span><span class=p>(</span><span class=n>Trace</span><span class=p>.</span><span class=na>TRACE_TAG_DALVIK</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>328</span><span class=w>              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>329</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>330</span><span class=w>              </span><span class=n>Log</span><span class=p>.</span><span class=na>i</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;...preloaded &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>count</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; classes in &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>331</span><span class=w>                      </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>SystemClock</span><span class=p>.</span><span class=na>uptimeMillis</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>startTime</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;ms.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>332</span><span class=w>          </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>333</span><span class=w>              </span><span class=n>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Error reading &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>PRELOADED_CLASSES</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;.&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>334</span><span class=w>          </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>335</span><span class=w>              </span><span class=n>IoUtils</span><span class=p>.</span><span class=na>closeQuietly</span><span class=p>(</span><span class=n>is</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>336</span><span class=w>              </span><span class=c1>// Restore default.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>337</span><span class=w>              </span><span class=n>runtime</span><span class=p>.</span><span class=na>setTargetHeapUtilization</span><span class=p>(</span><span class=n>defaultUtilization</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>338</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>339</span><span class=w>              </span><span class=c1>// Fill in dex caches with classes, fields, and methods brought in by preloading.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>340</span><span class=w>              </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceBegin</span><span class=p>(</span><span class=n>Trace</span><span class=p>.</span><span class=na>TRACE_TAG_DALVIK</span><span class=p>,</span><span class=w> </span><span class=s>&#34;PreloadDexCaches&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>341</span><span class=w>              </span><span class=n>runtime</span><span class=p>.</span><span class=na>preloadDexCaches</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>342</span><span class=w>              </span><span class=n>Trace</span><span class=p>.</span><span class=na>traceEnd</span><span class=p>(</span><span class=n>Trace</span><span class=p>.</span><span class=na>TRACE_TAG_DALVIK</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>343</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>344</span><span class=w>              </span><span class=c1>// Bring back root. We&#39;ll need it later if we&#39;re in the zygote.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>345</span><span class=w>              </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>droppedPriviliges</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>346</span><span class=w>                  </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>347</span><span class=w>                      </span><span class=n>Os</span><span class=p>.</span><span class=na>setreuid</span><span class=p>(</span><span class=n>ROOT_UID</span><span class=p>,</span><span class=w> </span><span class=n>ROOT_UID</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>348</span><span class=w>                      </span><span class=n>Os</span><span class=p>.</span><span class=na>setregid</span><span class=p>(</span><span class=n>ROOT_GID</span><span class=p>,</span><span class=w> </span><span class=n>ROOT_GID</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>349</span><span class=w>                  </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>ErrnoException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>350</span><span class=w>                      </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=nf>RuntimeException</span><span class=p>(</span><span class=s>&#34;Failed to restore root&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>351</span><span class=w>                  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>352</span><span class=w>              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>353</span><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>354</span><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>382</span><span class=w>      </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>    383       * Load in commonly used resources, so they can be shared across processes.
</span></span></span><span class=line><span class=cl><span class=cm>    384       *
</span></span></span><span class=line><span class=cl><span class=cm>    385       * These tend to be a few Kbytes, but are frequently in the 20-40K range, and occasionally even
</span></span></span><span class=line><span class=cl><span class=cm>    386       * larger.
</span></span></span><span class=line><span class=cl><span class=cm>    387       */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>388</span><span class=w>      </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>preloadResources</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>389</span><span class=w>          </span><span class=kd>final</span><span class=w> </span><span class=n>VMRuntime</span><span class=w> </span><span class=n>runtime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>VMRuntime</span><span class=p>.</span><span class=na>getRuntime</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>390</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>391</span><span class=w>          </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>392</span><span class=w>              </span><span class=n>mResources</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Resources</span><span class=p>.</span><span class=na>getSystem</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>393</span><span class=w>              </span><span class=n>mResources</span><span class=p>.</span><span class=na>startPreloading</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>394</span><span class=w>              </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>PRELOAD_RESOURCES</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>395</span><span class=w>                  </span><span class=n>Log</span><span class=p>.</span><span class=na>i</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Preloading resources...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>396</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>397</span><span class=w>                  </span><span class=kt>long</span><span class=w> </span><span class=n>startTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SystemClock</span><span class=p>.</span><span class=na>uptimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>398</span><span class=w>                  </span><span class=n>TypedArray</span><span class=w> </span><span class=n>ar</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mResources</span><span class=p>.</span><span class=na>obtainTypedArray</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>399</span><span class=w>                          </span><span class=n>com</span><span class=p>.</span><span class=na>android</span><span class=p>.</span><span class=na>internal</span><span class=p>.</span><span class=na>R</span><span class=p>.</span><span class=na>array</span><span class=p>.</span><span class=na>preloaded_drawables</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>400</span><span class=w>                  </span><span class=kt>int</span><span class=w> </span><span class=n>N</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>preloadDrawables</span><span class=p>(</span><span class=n>ar</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>401</span><span class=w>                  </span><span class=n>ar</span><span class=p>.</span><span class=na>recycle</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>402</span><span class=w>                  </span><span class=n>Log</span><span class=p>.</span><span class=na>i</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;...preloaded &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>N</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; resources in &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>403</span><span class=w>                          </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>SystemClock</span><span class=p>.</span><span class=na>uptimeMillis</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>startTime</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;ms.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>404</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>405</span><span class=w>                  </span><span class=n>startTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SystemClock</span><span class=p>.</span><span class=na>uptimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>406</span><span class=w>                  </span><span class=n>ar</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mResources</span><span class=p>.</span><span class=na>obtainTypedArray</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>407</span><span class=w>                          </span><span class=n>com</span><span class=p>.</span><span class=na>android</span><span class=p>.</span><span class=na>internal</span><span class=p>.</span><span class=na>R</span><span class=p>.</span><span class=na>array</span><span class=p>.</span><span class=na>preloaded_color_state_lists</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>408</span><span class=w>                  </span><span class=n>N</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>preloadColorStateLists</span><span class=p>(</span><span class=n>ar</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>409</span><span class=w>                  </span><span class=n>ar</span><span class=p>.</span><span class=na>recycle</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>410</span><span class=w>                  </span><span class=n>Log</span><span class=p>.</span><span class=na>i</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;...preloaded &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>N</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; resources in &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>411</span><span class=w>                          </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>SystemClock</span><span class=p>.</span><span class=na>uptimeMillis</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>startTime</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;ms.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>412</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>413</span><span class=w>                  </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>mResources</span><span class=p>.</span><span class=na>getBoolean</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>414</span><span class=w>                          </span><span class=n>com</span><span class=p>.</span><span class=na>android</span><span class=p>.</span><span class=na>internal</span><span class=p>.</span><span class=na>R</span><span class=p>.</span><span class=na>bool</span><span class=p>.</span><span class=na>config_freeformWindowManagement</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>415</span><span class=w>                      </span><span class=n>startTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SystemClock</span><span class=p>.</span><span class=na>uptimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>416</span><span class=w>                      </span><span class=n>ar</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mResources</span><span class=p>.</span><span class=na>obtainTypedArray</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>417</span><span class=w>                              </span><span class=n>com</span><span class=p>.</span><span class=na>android</span><span class=p>.</span><span class=na>internal</span><span class=p>.</span><span class=na>R</span><span class=p>.</span><span class=na>array</span><span class=p>.</span><span class=na>preloaded_freeform_multi_window_drawables</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>418</span><span class=w>                      </span><span class=n>N</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>preloadDrawables</span><span class=p>(</span><span class=n>ar</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>419</span><span class=w>                      </span><span class=n>ar</span><span class=p>.</span><span class=na>recycle</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>420</span><span class=w>                      </span><span class=n>Log</span><span class=p>.</span><span class=na>i</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;...preloaded &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>N</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; resource in &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>421</span><span class=w>                              </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>SystemClock</span><span class=p>.</span><span class=na>uptimeMillis</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>startTime</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;ms.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>422</span><span class=w>                  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>423</span><span class=w>              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>424</span><span class=w>              </span><span class=n>mResources</span><span class=p>.</span><span class=na>finishPreloading</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>425</span><span class=w>          </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>RuntimeException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>426</span><span class=w>              </span><span class=n>Log</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Failure preloading resources&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>427</span><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>428</span><span class=w>      </span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p><code>preloadClasses()</code>方法主要是从/system/etc/preloaded-classes文件中读取需要预加载的类名，然后通过Class.forname将该类加载到内存中，并会执行其中的一些静态方法(Java的<a href="https://so.csdn.net/so/search?q=%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6%5c&amp;spm=1001.2101.3001.7020" target=_blank rel="external nofollow noopener noreferrer">类加载机制</a>)。这里的重点是preloaded-classes文件，这个文件一般使用Android原生的文件，其路径在frameworks/base/config/preloaded-classes。</p><p><code>preloadResources()</code>方法主要是做了以下几件事：<br>1.在Resources.startPreloading()方法中，调用updateConfiguration()方法为系统创建Configuration，这是后面应用和系统的一些配置来源。<br>2.从preloaded_drawables中获取预加载的drawables资源，并将其加载到内存中。preloaded_drawables字段在frameworks/base/core/res/res/values/arrays.xml中定义。<br>3.从preloaded_color_state_lists中获取预加载的color资源，并将其加载到内存中，preloaded_color_state_lists字段也是定义在frameworks/base/core/res/res/values/arrays.xml中。<br>4.如果支持自由窗口模式，则将preloaded_freeform_multi_window_drawables字段中定义的预加载的freeform drawables也加载进来。</p><h4 class=heading-element id=232-zygoteserver><span>2.3.2 ZygoteServer</span>
<a href=#232-zygoteserver class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>ZygoteInit的main方法内实例化了ZygoteServer对象，并调用了其中<code>runSelectLoop()</code>、<code>closeServerSocket()</code>方法。<br>/frameworks/base/core/java/com/android/internal/os/ZygoteServer.java</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span><span class=lnt>196
</span><span class=lnt>197
</span><span class=lnt>198
</span><span class=lnt>199
</span><span class=lnt>200
</span><span class=lnt>201
</span><span class=lnt>202
</span><span class=lnt>203
</span><span class=lnt>204
</span><span class=lnt>205
</span><span class=lnt>206
</span><span class=lnt>207
</span><span class=lnt>208
</span><span class=lnt>209
</span><span class=lnt>210
</span><span class=lnt>211
</span><span class=lnt>212
</span><span class=lnt>213
</span><span class=lnt>214
</span><span class=lnt>215
</span><span class=lnt>216
</span><span class=lnt>217
</span><span class=lnt>218
</span><span class=lnt>219
</span><span class=lnt>220
</span><span class=lnt>221
</span><span class=lnt>222
</span><span class=lnt>223
</span><span class=lnt>224
</span><span class=lnt>225
</span><span class=lnt>226
</span><span class=lnt>227
</span><span class=lnt>228
</span><span class=lnt>229
</span><span class=lnt>230
</span><span class=lnt>231
</span><span class=lnt>232
</span><span class=lnt>233
</span><span class=lnt>234
</span><span class=lnt>235
</span><span class=lnt>236
</span><span class=lnt>237
</span><span class=lnt>238
</span><span class=lnt>239
</span><span class=lnt>240
</span><span class=lnt>241
</span><span class=lnt>242
</span><span class=lnt>243
</span><span class=lnt>244
</span><span class=lnt>245
</span><span class=lnt>246
</span><span class=lnt>247
</span><span class=lnt>248
</span><span class=lnt>249
</span><span class=lnt>250
</span><span class=lnt>251
</span><span class=lnt>252
</span><span class=lnt>253
</span><span class=lnt>254
</span><span class=lnt>255
</span><span class=lnt>256
</span><span class=lnt>257
</span><span class=lnt>258
</span><span class=lnt>259
</span><span class=lnt>260
</span><span class=lnt>261
</span><span class=lnt>262
</span><span class=lnt>263
</span><span class=lnt>264
</span><span class=lnt>265
</span><span class=lnt>266
</span><span class=lnt>267
</span><span class=lnt>268
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=n>48</span><span class=w>  </span><span class=kd>class</span> <span class=nc>ZygoteServer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>.......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>88</span><span class=w>      </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>    89       * Listening socket that accepts new server connections.
</span></span></span><span class=line><span class=cl><span class=cm>    90       */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>91</span><span class=w>      </span><span class=kd>private</span><span class=w> </span><span class=n>LocalServerSocket</span><span class=w> </span><span class=n>mZygoteSocket</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>142</span><span class=w>      </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>    143       * Initialize the Zygote server with the Zygote server socket, USAP pool server socket, and USAP
</span></span></span><span class=line><span class=cl><span class=cm>    144       * pool event FD.
</span></span></span><span class=line><span class=cl><span class=cm>    145       *
</span></span></span><span class=line><span class=cl><span class=cm>    146       * @param isPrimaryZygote  If this is the primary Zygote or not.
</span></span></span><span class=line><span class=cl><span class=cm>    147       */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>148</span><span class=w>      </span><span class=nf>ZygoteServer</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>isPrimaryZygote</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>151</span><span class=w>          </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>isPrimaryZygote</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>152</span><span class=w>              </span><span class=n>mZygoteSocket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Zygote</span><span class=p>.</span><span class=na>createManagedSocketFromInitSocket</span><span class=p>(</span><span class=n>Zygote</span><span class=p>.</span><span class=na>PRIMARY_SOCKET_NAME</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>153</span><span class=w>              </span><span class=n>mUsapPoolSocket</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>154</span><span class=w>                      </span><span class=n>Zygote</span><span class=p>.</span><span class=na>createManagedSocketFromInitSocket</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>155</span><span class=w>                              </span><span class=n>Zygote</span><span class=p>.</span><span class=na>USAP_POOL_PRIMARY_SOCKET_NAME</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>156</span><span class=w>          </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>157</span><span class=w>              </span><span class=n>mZygoteSocket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Zygote</span><span class=p>.</span><span class=na>createManagedSocketFromInitSocket</span><span class=p>(</span><span class=n>Zygote</span><span class=p>.</span><span class=na>SECONDARY_SOCKET_NAME</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>158</span><span class=w>              </span><span class=n>mUsapPoolSocket</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>159</span><span class=w>                      </span><span class=n>Zygote</span><span class=p>.</span><span class=na>createManagedSocketFromInitSocket</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>160</span><span class=w>                              </span><span class=n>Zygote</span><span class=p>.</span><span class=na>USAP_POOL_SECONDARY_SOCKET_NAME</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>161</span><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>166</span><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>176</span><span class=w>      </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>    177       * Registers a server socket for zygote command connections. This opens the server socket
</span></span></span><span class=line><span class=cl><span class=cm>    178       * at the specified name in the abstract socket namespace.
</span></span></span><span class=line><span class=cl><span class=cm>    179       */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>180</span><span class=w>      </span><span class=kt>void</span><span class=w> </span><span class=nf>registerServerSocketAtAbstractName</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>socketName</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>181</span><span class=w>          </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>mZygoteSocket</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>182</span><span class=w>              </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>183</span><span class=w>                  </span><span class=n>mZygoteSocket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LocalServerSocket</span><span class=p>(</span><span class=n>socketName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>184</span><span class=w>                  </span><span class=n>mCloseSocketFd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>185</span><span class=w>              </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>186</span><span class=w>                  </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=nf>RuntimeException</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>187</span><span class=w>                          </span><span class=s>&#34;Error binding to abstract socket &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>socketName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39;&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>188</span><span class=w>              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>189</span><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>190</span><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>210</span><span class=w>      </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>    211       * Close and clean up zygote sockets. Called on shutdown and on the
</span></span></span><span class=line><span class=cl><span class=cm>    212       * child&#39;s exit path.
</span></span></span><span class=line><span class=cl><span class=cm>    213       */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>214</span><span class=w>      </span><span class=kt>void</span><span class=w> </span><span class=nf>closeServerSocket</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>215</span><span class=w>          </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>216</span><span class=w>              </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>mZygoteSocket</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>217</span><span class=w>                  </span><span class=n>FileDescriptor</span><span class=w> </span><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mZygoteSocket</span><span class=p>.</span><span class=na>getFileDescriptor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>218</span><span class=w>                  </span><span class=n>mZygoteSocket</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>219</span><span class=w>                  </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>fd</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mCloseSocketFd</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>220</span><span class=w>                      </span><span class=n>Os</span><span class=p>.</span><span class=na>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>221</span><span class=w>                  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>222</span><span class=w>              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>223</span><span class=w>          </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>224</span><span class=w>              </span><span class=n>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Zygote:  error closing sockets&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>225</span><span class=w>          </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>ErrnoException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>226</span><span class=w>              </span><span class=n>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Zygote:  error closing descriptor&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>227</span><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>228</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>229</span><span class=w>          </span><span class=n>mZygoteSocket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>230</span><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>368</span><span class=w>      </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>    369       * Runs the zygote process&#39;s select loop. Accepts new connections as
</span></span></span><span class=line><span class=cl><span class=cm>    370       * they happen, and reads commands from connections one spawn-request&#39;s
</span></span></span><span class=line><span class=cl><span class=cm>    371       * worth at a time.
</span></span></span><span class=line><span class=cl><span class=cm>    372       */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>373</span><span class=w>      </span><span class=n>Runnable</span><span class=w> </span><span class=nf>runSelectLoop</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>abiList</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>374</span><span class=w>          </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>FileDescriptor</span><span class=o>&gt;</span><span class=w> </span><span class=n>socketFDs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>FileDescriptor</span><span class=o>&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>375</span><span class=w>          </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>ZygoteConnection</span><span class=o>&gt;</span><span class=w> </span><span class=n>peers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>ZygoteConnection</span><span class=o>&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>376</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>377</span><span class=w>          </span><span class=n>socketFDs</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>mZygoteSocket</span><span class=p>.</span><span class=na>getFileDescriptor</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>378</span><span class=w>          </span><span class=n>peers</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>379</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>380</span><span class=w>          </span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>381</span><span class=w>              </span><span class=nf>fetchUsapPoolPolicyPropsWithMinInterval</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>382</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>383</span><span class=w>              </span><span class=kt>int</span><span class=o>[]</span><span class=w> </span><span class=n>usapPipeFDs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>384</span><span class=w>              </span><span class=n>StructPollfd</span><span class=o>[]</span><span class=w> </span><span class=n>pollFDs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>385</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>386</span><span class=w>              </span><span class=c1>// Allocate enough space for the poll structs, taking into account</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>387</span><span class=w>              </span><span class=c1>// the state of the USAP pool for this Zygote (could be a</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>388</span><span class=w>              </span><span class=c1>// regular Zygote, a WebView Zygote, or an AppZygote).</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>389</span><span class=w>              </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>mUsapPoolEnabled</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>390</span><span class=w>                  </span><span class=n>usapPipeFDs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Zygote</span><span class=p>.</span><span class=na>getUsapPipeFDs</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>391</span><span class=w>                  </span><span class=n>pollFDs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StructPollfd</span><span class=o>[</span><span class=n>socketFDs</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>usapPipeFDs</span><span class=p>.</span><span class=na>length</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>392</span><span class=w>              </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>393</span><span class=w>                  </span><span class=n>pollFDs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StructPollfd</span><span class=o>[</span><span class=n>socketFDs</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>394</span><span class=w>              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>395</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>396</span><span class=w>              </span><span class=cm>/*
</span></span></span><span class=line><span class=cl><span class=cm>    397               * For reasons of correctness the USAP pool pipe and event FDs
</span></span></span><span class=line><span class=cl><span class=cm>    398               * must be processed before the session and server sockets.  This
</span></span></span><span class=line><span class=cl><span class=cm>    399               * is to ensure that the USAP pool accounting information is
</span></span></span><span class=line><span class=cl><span class=cm>    400               * accurate when handling other requests like API blacklist
</span></span></span><span class=line><span class=cl><span class=cm>    401               * exemptions.
</span></span></span><span class=line><span class=cl><span class=cm>    402               */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>403</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>404</span><span class=w>              </span><span class=kt>int</span><span class=w> </span><span class=n>pollIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>405</span><span class=w>              </span><span class=nf>for</span><span class=w> </span><span class=p>(</span><span class=n>FileDescriptor</span><span class=w> </span><span class=n>socketFD</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>socketFDs</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>406</span><span class=w>                  </span><span class=n>pollFDs</span><span class=o>[</span><span class=n>pollIndex</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StructPollfd</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>407</span><span class=w>                  </span><span class=n>pollFDs</span><span class=o>[</span><span class=n>pollIndex</span><span class=o>]</span><span class=p>.</span><span class=na>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>socketFD</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>408</span><span class=w>                  </span><span class=n>pollFDs</span><span class=o>[</span><span class=n>pollIndex</span><span class=o>]</span><span class=p>.</span><span class=na>events</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>short</span><span class=p>)</span><span class=w> </span><span class=n>POLLIN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>409</span><span class=w>                  </span><span class=o>++</span><span class=n>pollIndex</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>410</span><span class=w>              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>411</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>412</span><span class=w>              </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>usapPoolEventFDIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pollIndex</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>413</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>414</span><span class=w>              </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>mUsapPoolEnabled</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>415</span><span class=w>                  </span><span class=n>pollFDs</span><span class=o>[</span><span class=n>pollIndex</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StructPollfd</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>416</span><span class=w>                  </span><span class=n>pollFDs</span><span class=o>[</span><span class=n>pollIndex</span><span class=o>]</span><span class=p>.</span><span class=na>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mUsapPoolEventFD</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>417</span><span class=w>                  </span><span class=n>pollFDs</span><span class=o>[</span><span class=n>pollIndex</span><span class=o>]</span><span class=p>.</span><span class=na>events</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>short</span><span class=p>)</span><span class=w> </span><span class=n>POLLIN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>418</span><span class=w>                  </span><span class=o>++</span><span class=n>pollIndex</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>419</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>420</span><span class=w>                  </span><span class=nf>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>usapPipeFD</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>usapPipeFDs</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>421</span><span class=w>                      </span><span class=n>FileDescriptor</span><span class=w> </span><span class=n>managedFd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FileDescriptor</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>422</span><span class=w>                      </span><span class=n>managedFd</span><span class=p>.</span><span class=na>setInt$</span><span class=p>(</span><span class=n>usapPipeFD</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>423</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>424</span><span class=w>                      </span><span class=n>pollFDs</span><span class=o>[</span><span class=n>pollIndex</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StructPollfd</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>425</span><span class=w>                      </span><span class=n>pollFDs</span><span class=o>[</span><span class=n>pollIndex</span><span class=o>]</span><span class=p>.</span><span class=na>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>managedFd</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>426</span><span class=w>                      </span><span class=n>pollFDs</span><span class=o>[</span><span class=n>pollIndex</span><span class=o>]</span><span class=p>.</span><span class=na>events</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>short</span><span class=p>)</span><span class=w> </span><span class=n>POLLIN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>427</span><span class=w>                      </span><span class=o>++</span><span class=n>pollIndex</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>428</span><span class=w>                  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>429</span><span class=w>              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>430</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>431</span><span class=w>              </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>432</span><span class=w>                  </span><span class=n>Os</span><span class=p>.</span><span class=na>poll</span><span class=p>(</span><span class=n>pollFDs</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>433</span><span class=w>              </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>ErrnoException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>434</span><span class=w>                  </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=nf>RuntimeException</span><span class=p>(</span><span class=s>&#34;poll failed&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>435</span><span class=w>              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>436</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>437</span><span class=w>              </span><span class=kt>boolean</span><span class=w> </span><span class=n>usapPoolFDRead</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>438</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>439</span><span class=w>              </span><span class=nf>while</span><span class=w> </span><span class=p>(</span><span class=o>--</span><span class=n>pollIndex</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>440</span><span class=w>                  </span><span class=nf>if</span><span class=w> </span><span class=p>((</span><span class=n>pollFDs</span><span class=o>[</span><span class=n>pollIndex</span><span class=o>]</span><span class=p>.</span><span class=na>revents</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>POLLIN</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>441</span><span class=w>                      </span><span class=k>continue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>442</span><span class=w>                  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>443</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>444</span><span class=w>                  </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>pollIndex</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>445</span><span class=w>                      </span><span class=c1>// Zygote server socket</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>446</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>447</span><span class=w>                      </span><span class=n>ZygoteConnection</span><span class=w> </span><span class=n>newPeer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>acceptCommandPeer</span><span class=p>(</span><span class=n>abiList</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>448</span><span class=w>                      </span><span class=n>peers</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>newPeer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>449</span><span class=w>                      </span><span class=n>socketFDs</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>newPeer</span><span class=p>.</span><span class=na>getFileDescriptor</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>450</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>451</span><span class=w>                  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>pollIndex</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>usapPoolEventFDIndex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>452</span><span class=w>                      </span><span class=c1>// Session socket accepted from the Zygote server socket</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>453</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>454</span><span class=w>                      </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>455</span><span class=w>                          </span><span class=n>ZygoteConnection</span><span class=w> </span><span class=n>connection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>peers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>pollIndex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>456</span><span class=w>                          </span><span class=kd>final</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=n>command</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connection</span><span class=p>.</span><span class=na>processOneCommand</span><span class=p>(</span><span class=k>this</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>457</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>458</span><span class=w>                          </span><span class=c1>// TODO (chriswailes): Is this extra check necessary?</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>459</span><span class=w>                          </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>mIsForkChild</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>460</span><span class=w>                              </span><span class=c1>// We&#39;re in the child. We should always have a command to run at this</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>461</span><span class=w>                              </span><span class=c1>// stage if processOneCommand hasn&#39;t called &#34;exec&#34;.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>462</span><span class=w>                              </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>command</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>463</span><span class=w>                                  </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=nf>IllegalStateException</span><span class=p>(</span><span class=s>&#34;command == null&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>464</span><span class=w>                              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>465</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>466</span><span class=w>                              </span><span class=k>return</span><span class=w> </span><span class=n>command</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>467</span><span class=w>                          </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>468</span><span class=w>                              </span><span class=c1>// We&#39;re in the server - we should never have any commands to run.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>469</span><span class=w>                              </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>command</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>470</span><span class=w>                                  </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=nf>IllegalStateException</span><span class=p>(</span><span class=s>&#34;command != null&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>471</span><span class=w>                              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>472</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>473</span><span class=w>                              </span><span class=c1>// We don&#39;t know whether the remote side of the socket was closed or</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>474</span><span class=w>                              </span><span class=c1>// not until we attempt to read from it from processOneCommand. This</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>475</span><span class=w>                              </span><span class=c1>// shows up as a regular POLLIN event in our regular processing loop.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>476</span><span class=w>                              </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>connection</span><span class=p>.</span><span class=na>isClosedByPeer</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>477</span><span class=w>                                  </span><span class=n>connection</span><span class=p>.</span><span class=na>closeSocket</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>478</span><span class=w>                                  </span><span class=n>peers</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>pollIndex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>479</span><span class=w>                                  </span><span class=n>socketFDs</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>pollIndex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>480</span><span class=w>                              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>481</span><span class=w>                          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>482</span><span class=w>                      </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>483</span><span class=w>                          </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mIsForkChild</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>484</span><span class=w>                              </span><span class=c1>// We&#39;re in the server so any exception here is one that has taken place</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>485</span><span class=w>                              </span><span class=c1>// pre-fork while processing commands or reading / writing from the</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>486</span><span class=w>                              </span><span class=c1>// control socket. Make a loud noise about any such exceptions so that</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>487</span><span class=w>                              </span><span class=c1>// we know exactly what failed and why.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>488</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>489</span><span class=w>                              </span><span class=n>Slog</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Exception executing zygote command: &#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>490</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>491</span><span class=w>                              </span><span class=c1>// Make sure the socket is closed so that the other end knows</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>492</span><span class=w>                              </span><span class=c1>// immediately that something has gone wrong and doesn&#39;t time out</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>493</span><span class=w>                              </span><span class=c1>// waiting for a response.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>494</span><span class=w>                              </span><span class=n>ZygoteConnection</span><span class=w> </span><span class=n>conn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>peers</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>pollIndex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>495</span><span class=w>                              </span><span class=n>conn</span><span class=p>.</span><span class=na>closeSocket</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>496</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>497</span><span class=w>                              </span><span class=n>socketFDs</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>pollIndex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>498</span><span class=w>                          </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>499</span><span class=w>                              </span><span class=c1>// We&#39;re in the child so any exception caught here has happened post</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>500</span><span class=w>                              </span><span class=c1>// fork and before we execute ActivityThread.main (or any other main()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>501</span><span class=w>                              </span><span class=c1>// method). Log the details of the exception and bring down the process.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>502</span><span class=w>                              </span><span class=n>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Caught post-fork exception in child process.&#34;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>503</span><span class=w>                              </span><span class=k>throw</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>504</span><span class=w>                          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>505</span><span class=w>                      </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>506</span><span class=w>                          </span><span class=c1>// Reset the child flag, in the event that the child process is a child-</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>507</span><span class=w>                          </span><span class=c1>// zygote. The flag will not be consulted this loop pass after the Runnable</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>508</span><span class=w>                          </span><span class=c1>// is returned.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>509</span><span class=w>                          </span><span class=n>mIsForkChild</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>510</span><span class=w>                      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>511</span><span class=w>                  </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>512</span><span class=w>                      </span><span class=c1>// Either the USAP pool event FD or a USAP reporting pipe.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>513</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>514</span><span class=w>                      </span><span class=c1>// If this is the event FD the payload will be the number of USAPs removed.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>515</span><span class=w>                      </span><span class=c1>// If this is a reporting pipe FD the payload will be the PID of the USAP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>516</span><span class=w>                      </span><span class=c1>// that was just specialized.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>517</span><span class=w>                      </span><span class=kt>long</span><span class=w> </span><span class=n>messagePayload</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>518</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>519</span><span class=w>                      </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>520</span><span class=w>                          </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>buffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[</span><span class=n>Zygote</span><span class=p>.</span><span class=na>USAP_MANAGEMENT_MESSAGE_BYTES</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>521</span><span class=w>                          </span><span class=kt>int</span><span class=w> </span><span class=n>readBytes</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Os</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>pollFDs</span><span class=o>[</span><span class=n>pollIndex</span><span class=o>]</span><span class=p>.</span><span class=na>fd</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=w> </span><span class=n>buffer</span><span class=p>.</span><span class=na>length</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>522</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>523</span><span class=w>                          </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>readBytes</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Zygote</span><span class=p>.</span><span class=na>USAP_MANAGEMENT_MESSAGE_BYTES</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>524</span><span class=w>                              </span><span class=n>DataInputStream</span><span class=w> </span><span class=n>inputStream</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>525</span><span class=w>                                      </span><span class=k>new</span><span class=w> </span><span class=nf>DataInputStream</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ByteArrayInputStream</span><span class=p>(</span><span class=n>buffer</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>526</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>527</span><span class=w>                              </span><span class=n>messagePayload</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>inputStream</span><span class=p>.</span><span class=na>readLong</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>528</span><span class=w>                          </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>529</span><span class=w>                              </span><span class=n>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Incomplete read from USAP management FD of size &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>530</span><span class=w>                                      </span><span class=o>+</span><span class=w> </span><span class=n>readBytes</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>531</span><span class=w>                              </span><span class=k>continue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>532</span><span class=w>                          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>533</span><span class=w>                      </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>534</span><span class=w>                          </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>pollIndex</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>usapPoolEventFDIndex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>535</span><span class=w>                              </span><span class=n>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Failed to read from USAP pool event FD: &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>536</span><span class=w>                                      </span><span class=o>+</span><span class=w> </span><span class=n>ex</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>537</span><span class=w>                          </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>538</span><span class=w>                              </span><span class=n>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Failed to read from USAP reporting pipe: &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>539</span><span class=w>                                      </span><span class=o>+</span><span class=w> </span><span class=n>ex</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>540</span><span class=w>                          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>541</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>542</span><span class=w>                          </span><span class=k>continue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>543</span><span class=w>                      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>544</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>545</span><span class=w>                      </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>pollIndex</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>usapPoolEventFDIndex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>546</span><span class=w>                          </span><span class=n>Zygote</span><span class=p>.</span><span class=na>removeUsapTableEntry</span><span class=p>((</span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=n>messagePayload</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>547</span><span class=w>                      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>548</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>549</span><span class=w>                      </span><span class=n>usapPoolFDRead</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>550</span><span class=w>                  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>551</span><span class=w>              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>552</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>553</span><span class=w>              </span><span class=c1>// Check to see if the USAP pool needs to be refilled.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>554</span><span class=w>              </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>usapPoolFDRead</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>555</span><span class=w>                  </span><span class=kt>int</span><span class=o>[]</span><span class=w> </span><span class=n>sessionSocketRawFDs</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>556</span><span class=w>                          </span><span class=n>socketFDs</span><span class=p>.</span><span class=na>subList</span><span class=p>(</span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>socketFDs</span><span class=p>.</span><span class=na>size</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>557</span><span class=w>                                  </span><span class=p>.</span><span class=na>stream</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>558</span><span class=w>                                  </span><span class=p>.</span><span class=na>mapToInt</span><span class=p>(</span><span class=n>fd</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>fd</span><span class=p>.</span><span class=na>getInt$</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>559</span><span class=w>                                  </span><span class=p>.</span><span class=na>toArray</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>560</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>561</span><span class=w>                  </span><span class=kd>final</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=n>command</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fillUsapPool</span><span class=p>(</span><span class=n>sessionSocketRawFDs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>562</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>563</span><span class=w>                  </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>command</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>564</span><span class=w>                      </span><span class=k>return</span><span class=w> </span><span class=n>command</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>565</span><span class=w>                  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>566</span><span class=w>              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>567</span><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>568</span><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>569</span><span class=w>  </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span></span></span></code></pre></td></tr></table></div></div><p>主要做3件事：</p><ol><li><code>创建ZygoteServer</code>：ZygoteServer初始化，内部对ServerSocket进行了初始化，为Zygote提供了通信的能力。</li><li><code>zygoteServer.runSelectLoop()</code>：当zygote进程返回到main()方法后执行，从名字上和注释来看，这个方法应该是一个死循环，是不断进行循环执行命令的方法，主要做了两件事：​<br>1.每次循环都重新构建监听文件列表，主要是ZygoteServer的socket文件(ZygoteServer的socket和其他应用进程连接过来的socket)和usap文件节点(目前看来，zygote默认是没有使用，作用未明，不做分析)。<br>​2.监听文件列表，并从中获取命令执行。</li><li><code>zygoteServer.closeServerSocket()</code>：在循环后，关闭ServerSocket</li></ol><h4 class=heading-element id=233-创建systemserver进程><span>2.3.3 创建SystemServer进程</span>
<a href=#233-%e5%88%9b%e5%bb%basystemserver%e8%bf%9b%e7%a8%8b class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=n>718</span><span class=w>      </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>    719       * Prepare the arguments and forks for the system server process.
</span></span></span><span class=line><span class=cl><span class=cm>    720       *
</span></span></span><span class=line><span class=cl><span class=cm>    721       * @return A {@code Runnable} that provides an entrypoint into system_server code in the child
</span></span></span><span class=line><span class=cl><span class=cm>    722       * process; {@code null} in the parent.
</span></span></span><span class=line><span class=cl><span class=cm>    723       */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>724</span><span class=w>      </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Runnable</span><span class=w> </span><span class=nf>forkSystemServer</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>abiList</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>socketName</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>725</span><span class=w>              </span><span class=n>ZygoteServer</span><span class=w> </span><span class=n>zygoteServer</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>726</span><span class=w>          </span><span class=kt>long</span><span class=w> </span><span class=n>capabilities</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>posixCapabilitiesAsBits</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>727</span><span class=w>                  </span><span class=n>OsConstants</span><span class=p>.</span><span class=na>CAP_IPC_LOCK</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>728</span><span class=w>                  </span><span class=n>OsConstants</span><span class=p>.</span><span class=na>CAP_KILL</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>729</span><span class=w>                  </span><span class=n>OsConstants</span><span class=p>.</span><span class=na>CAP_NET_ADMIN</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>730</span><span class=w>                  </span><span class=n>OsConstants</span><span class=p>.</span><span class=na>CAP_NET_BIND_SERVICE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>731</span><span class=w>                  </span><span class=n>OsConstants</span><span class=p>.</span><span class=na>CAP_NET_BROADCAST</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>732</span><span class=w>                  </span><span class=n>OsConstants</span><span class=p>.</span><span class=na>CAP_NET_RAW</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>733</span><span class=w>                  </span><span class=n>OsConstants</span><span class=p>.</span><span class=na>CAP_SYS_MODULE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>734</span><span class=w>                  </span><span class=n>OsConstants</span><span class=p>.</span><span class=na>CAP_SYS_NICE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>735</span><span class=w>                  </span><span class=n>OsConstants</span><span class=p>.</span><span class=na>CAP_SYS_PTRACE</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>736</span><span class=w>                  </span><span class=n>OsConstants</span><span class=p>.</span><span class=na>CAP_SYS_TIME</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>737</span><span class=w>                  </span><span class=n>OsConstants</span><span class=p>.</span><span class=na>CAP_SYS_TTY_CONFIG</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>738</span><span class=w>                  </span><span class=n>OsConstants</span><span class=p>.</span><span class=na>CAP_WAKE_ALARM</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>739</span><span class=w>                  </span><span class=n>OsConstants</span><span class=p>.</span><span class=na>CAP_BLOCK_SUSPEND</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>740</span><span class=w>          </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>741</span><span class=w>          </span><span class=cm>/* Containers run without some capabilities, so drop any caps that are not available. */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>742</span><span class=w>          </span><span class=n>StructCapUserHeader</span><span class=w> </span><span class=n>header</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>StructCapUserHeader</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>743</span><span class=w>                  </span><span class=n>OsConstants</span><span class=p>.</span><span class=na>_LINUX_CAPABILITY_VERSION_3</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>744</span><span class=w>          </span><span class=n>StructCapUserData</span><span class=o>[]</span><span class=w> </span><span class=n>data</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>745</span><span class=w>          </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>746</span><span class=w>              </span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Os</span><span class=p>.</span><span class=na>capget</span><span class=p>(</span><span class=n>header</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>747</span><span class=w>          </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>ErrnoException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>748</span><span class=w>              </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=nf>RuntimeException</span><span class=p>(</span><span class=s>&#34;Failed to capget()&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>749</span><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>750</span><span class=w>          </span><span class=n>capabilities</span><span class=w> </span><span class=o>&amp;=</span><span class=w> </span><span class=p>((</span><span class=kt>long</span><span class=p>)</span><span class=w> </span><span class=n>data</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>.</span><span class=na>effective</span><span class=p>)</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=p>(((</span><span class=kt>long</span><span class=p>)</span><span class=w> </span><span class=n>data</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>.</span><span class=na>effective</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>32</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>751</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>752</span><span class=w>          </span><span class=cm>/* Hardcoded command line to start the system server */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>753</span><span class=w>          </span><span class=n>String</span><span class=w> </span><span class=n>args</span><span class=o>[]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>754</span><span class=w>                  </span><span class=s>&#34;--setuid=1000&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>755</span><span class=w>                  </span><span class=s>&#34;--setgid=1000&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>756</span><span class=w>                  </span><span class=s>&#34;--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1023,&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>757</span><span class=w>                          </span><span class=o>+</span><span class=w> </span><span class=s>&#34;1024,1032,1065,3001,3002,3003,3006,3007,3009,3010&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>758</span><span class=w>                  </span><span class=s>&#34;--capabilities=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>capabilities</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;,&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>capabilities</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>759</span><span class=w>                  </span><span class=s>&#34;--nice-name=system_server&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>760</span><span class=w>                  </span><span class=s>&#34;--runtime-args&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>761</span><span class=w>                  </span><span class=s>&#34;--target-sdk-version=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>VMRuntime</span><span class=p>.</span><span class=na>SDK_VERSION_CUR_DEVELOPMENT</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>762</span><span class=w>                  </span><span class=s>&#34;com.android.server.SystemServer&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>763</span><span class=w>          </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>764</span><span class=w>          </span><span class=n>ZygoteArguments</span><span class=w> </span><span class=n>parsedArgs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>765</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>766</span><span class=w>          </span><span class=kt>int</span><span class=w> </span><span class=n>pid</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>767</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>768</span><span class=w>          </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>769</span><span class=w>              </span><span class=n>parsedArgs</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ZygoteArguments</span><span class=p>(</span><span class=n>args</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>770</span><span class=w>              </span><span class=n>Zygote</span><span class=p>.</span><span class=na>applyDebuggerSystemProperty</span><span class=p>(</span><span class=n>parsedArgs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>771</span><span class=w>              </span><span class=n>Zygote</span><span class=p>.</span><span class=na>applyInvokeWithSystemProperty</span><span class=p>(</span><span class=n>parsedArgs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>772</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>773</span><span class=w>              </span><span class=kt>boolean</span><span class=w> </span><span class=n>profileSystemServer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SystemProperties</span><span class=p>.</span><span class=na>getBoolean</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>774</span><span class=w>                      </span><span class=s>&#34;dalvik.vm.profilesystemserver&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>775</span><span class=w>              </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>profileSystemServer</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>776</span><span class=w>                  </span><span class=n>parsedArgs</span><span class=p>.</span><span class=na>mRuntimeFlags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>Zygote</span><span class=p>.</span><span class=na>PROFILE_SYSTEM_SERVER</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>777</span><span class=w>              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>778</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>779</span><span class=w>              </span><span class=cm>/* Request to fork the system server process */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>780</span><span class=w>              </span><span class=n>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Zygote</span><span class=p>.</span><span class=na>forkSystemServer</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>781</span><span class=w>                      </span><span class=n>parsedArgs</span><span class=p>.</span><span class=na>mUid</span><span class=p>,</span><span class=w> </span><span class=n>parsedArgs</span><span class=p>.</span><span class=na>mGid</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>782</span><span class=w>                      </span><span class=n>parsedArgs</span><span class=p>.</span><span class=na>mGids</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>783</span><span class=w>                      </span><span class=n>parsedArgs</span><span class=p>.</span><span class=na>mRuntimeFlags</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>784</span><span class=w>                      </span><span class=kc>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>785</span><span class=w>                      </span><span class=n>parsedArgs</span><span class=p>.</span><span class=na>mPermittedCapabilities</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>786</span><span class=w>                      </span><span class=n>parsedArgs</span><span class=p>.</span><span class=na>mEffectiveCapabilities</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>787</span><span class=w>          </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IllegalArgumentException</span><span class=w> </span><span class=n>ex</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>788</span><span class=w>              </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=nf>RuntimeException</span><span class=p>(</span><span class=n>ex</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>789</span><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>790</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>791</span><span class=w>          </span><span class=cm>/* For child process */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>792</span><span class=w>          </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>pid</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>793</span><span class=w>              </span><span class=nf>if</span><span class=w> </span><span class=p>(</span><span class=n>hasSecondZygote</span><span class=p>(</span><span class=n>abiList</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>794</span><span class=w>                  </span><span class=nf>waitForSecondaryZygote</span><span class=p>(</span><span class=n>socketName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>795</span><span class=w>              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>796</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>797</span><span class=w>              </span><span class=n>zygoteServer</span><span class=p>.</span><span class=na>closeServerSocket</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>798</span><span class=w>              </span><span class=k>return</span><span class=w> </span><span class=nf>handleSystemServerProcess</span><span class=p>(</span><span class=n>parsedArgs</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>799</span><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>800</span><span class=w>  
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>801</span><span class=w>          </span><span class=k>return</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>802</span><span class=w>      </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span></span></span></code></pre></td></tr></table></div></div><p><code>forkSystemServer()</code>：<br>①调用Zygote.forkSystemServer()方法去fork一个新的进程出来。<br>②fork()后的子进程是SystemServer进程，则等待zygote的启动完成，并执行真正的SystemServer代码。</p><h3 class=heading-element id=24-zygote启动流程图><span>2.4 Zygote启动流程图</span>
<a href=#24-zygote%e5%90%af%e5%8a%a8%e6%b5%81%e7%a8%8b%e5%9b%be class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p><a class=lightgallery href=https://i-blog.csdnimg.cn/blog_migrate/0674ab183da8c133a06e37b63270d0e4.png title=在这里插入图片描述 data-thumbnail=https://i-blog.csdnimg.cn/blog_migrate/0674ab183da8c133a06e37b63270d0e4.png data-sub-html="<h2>在这里插入图片描述</h2>"><img loading=lazy src=https://i-blog.csdnimg.cn/blog_migrate/0674ab183da8c133a06e37b63270d0e4.png alt=在这里插入图片描述></a></p><h2 class=heading-element id=3-总结><span>3 总结</span>
<a href=#3-%e6%80%bb%e7%bb%93 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>所有的进程都由Zygote创建，zygote主要用来孵化<code>system_server进程</code>和<code>应用程序进程</code>。在孵化出第一个进程system_server后通过<code>runSelectLoop</code>等待并处理消息，分裂应用程序进程仍由system_server控制，<code>等待 AMS 给他发消息（告诉 zygote 创建进程）</code>，如app启动时创建子进程。</p><p>从AndroidRuntime到ZygoteInit，主要分为3大过程：</p><blockquote><p>1、<code>创建虚拟机——startVm()</code>:调用JNI虚拟机创建函数<br>2、<code>注册JNI函数——startReg()</code>：前面已经创建虚拟机，这里给这个虚拟机注册一些JNI函数（后续java世界用到的函数是native实现，这里需要提前注册注册这些函数）<br>3、此时就要<code>执行CallStaticViodMethod</code>，通过这个函数将进入android精心打造的java世界，这个函数将调用com.android.internal.os.ZygoteInit的main函数</p></blockquote><p>在 ZygoteInit.main函数中进入Java世界，主要有4个关键步骤：</p><blockquote><p>1、<code>预加载类和资源——preload()</code><br>主要是preloadClasses和preloadResources，其中preloadClasses一般是加载时间超过1250ms的类，因而需要在zygote预加载<br>2、<code>建立IPC通信服务——初始化ZygoteServer，内部初始化了ZygoteSocket</code><br>zygote及系统中其他程序的通信并没有使用Binder，而是采用基于AF_UNIX类型的Socket，作用正是建立这个Socket<br>3、<code>启动system_server——forkSystemServer()</code><br>这个函数会创建Java世界中系统Service所驻留的进程system_server,该进程是framework的核心，也是zygote孵化出的第一个进程。如果它死了，就会导致zygote自杀。<br>4、<code>等待请求——runSelectLoop()</code><br>zygote从startSystemServer返回后，将进入第四个关键函数runSelectLoop，在第一个函数ZygoteServer中注册了一个用于IPC的Socket将在这里使用，这里Zygote采用高效的I/O多路复用机制，保证在没有客户端请求时或者数据处理时休眠，否则响应客户端的请求。<code>等待 AMS 给他发消息（告诉 zygote 创建进程）</code>。此时zygote完成了java世界的初创工作，调用runSelectLoop便开始休眠了，当收到请求或者数据处理便会随时醒来，继续工作。</p></blockquote><h2 class=heading-element id=4-面试题><span>4 面试题</span>
<a href=#4-%e9%9d%a2%e8%af%95%e9%a2%98 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 class=heading-element id=1-init进程作用是什么><span>1 init进程作用是什么</span>
<a href=#1-init%e8%bf%9b%e7%a8%8b%e4%bd%9c%e7%94%a8%e6%98%af%e4%bb%80%e4%b9%88 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>init进程起着承上启下的作用，Android本身是基于Linux而来的，init进程是Linux系统中用户空间的第一个进程。init进程属于一个守护进程，准确的说，它是Linux系统中用户控制的第一个进程，它的进程号为1（进程号为0的为内核进程），它的生命周期贯穿整个Linux内核运行的始终。Android中所有其它的进程共同的鼻祖均为init进程。<br>Android Q(10.0) 的init入口函数由原先的init.cpp 调整到了main.cpp，把各个阶段的操作分离开来，使代码更加简洁命令。<br>作为天子第1号进程，init被赋予了很多重要的职责，主要分为三个阶段：</p><blockquote><ol><li>init进程第一阶段做的主要工作是<code>挂载分区</code>，创建设备节点和一些关键目录，初始化日志输出系统,启用SELinux安全策略。</li><li>init进程第二阶段主要工作是<code>初始化属性系统</code>，解析SELinux的匹配规则，处理子进程终止信号，启动系统属性服务，可以说每一项都很关键，如果说第一阶段是为属性系统，SELinux做准备，那么第二阶段就是真正去把这些功能落实。</li><li>init进行第三阶段主要是<code>解析init.rc来启动其他进程</code>，进入无限循环，进行<code>子进程实时监控(守护)</code>。</li></ol></blockquote><p>其中第三阶段通过initrc启动其他进程，我们常见的比如<code>启动Zygote进程</code>、<code>启动SeviceManager进程</code>等。</p><h3 class=heading-element id=2-zygote进程最原始的进程是什么进程或者zygote进程由来><span>2 Zygote进程最原始的进程是什么进程(或者Zygote进程由来)</span>
<a href=#2-zygote%e8%bf%9b%e7%a8%8b%e6%9c%80%e5%8e%9f%e5%a7%8b%e7%9a%84%e8%bf%9b%e7%a8%8b%e6%98%af%e4%bb%80%e4%b9%88%e8%bf%9b%e7%a8%8b%e6%88%96%e8%80%85zygote%e8%bf%9b%e7%a8%8b%e7%94%b1%e6%9d%a5 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>Zygote最开始是<code>app_process</code>，它是在 init 进程启动时被启动的，在<code>app_main.cpp</code>才被修改为 Zygote。</p><h3 class=heading-element id=3-zygote-是在内核空间还是在用户空间><span>3 Zygote 是在内核空间还是在用户空间？</span>
<a href=#3-zygote-%e6%98%af%e5%9c%a8%e5%86%85%e6%a0%b8%e7%a9%ba%e9%97%b4%e8%bf%98%e6%98%af%e5%9c%a8%e7%94%a8%e6%88%b7%e7%a9%ba%e9%97%b4 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>因为 init 进程的创建在用户空间，而 Zygote 是由 init 进程创建启动的，所以<code>Zygote是在用户空间。</code></p><h3 class=heading-element id=4-zygote为什么需要用到socket通信而不是binder><span>4 Zygote为什么需要用到Socket通信而不是Binder</span>
<a href=#4-zygote%e4%b8%ba%e4%bb%80%e4%b9%88%e9%9c%80%e8%a6%81%e7%94%a8%e5%88%b0socket%e9%80%9a%e4%bf%a1%e8%80%8c%e4%b8%8d%e6%98%afbinder class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>Zygote是Android中的一个重要进程，它是启动应用程序进程的父进程。Zygote使用Socket来与应用程序进程进行通信，而不是使用Android中的IPC机制Binder，这是因为Socket和Binder有不同的优缺点，而在Zygote进程中使用Socket可以更好地满足Zygote进程的需求。</p><ol><li><code>Zygote 用 binder 通信会导致死锁</code><br>假设 Zygote 使用 Binder 通信，因为 Binder 是支持多线程的，存在并发问题，而并发问题的解决方案就是加锁，如果进程 fork 是在多线程情况下运行，Binder 等待锁在锁机制下就可能会出现死锁。</li><li><code>Zygote 用 binder 通信会导致读写错误</code><br>根本原因在于要 new 一个 ProcessState 用于 Binder 通信时，需要 mmap 申请一片内存用以提供给内核进行数据交换使用。而如果直接 fork 了的话，子进程在进行 binder 通信时，内核还是会继续使用父进程申请的地址写数据，而此时会触发子进程 COW（Copy on Write），从而导致地址空间已经重新映射，而子进程还尝试访问之前父进程 mmap 的地址，会导致 SIGSEGV、SEGV_MAPERR段错误。</li><li><code>Zygote初始化时，Binder还没开始初始化。</code></li><li><code>Socket具有良好的跨平台性</code>，能够在不同的操作系统和语言之间进行通信。这对于Zygote进程来说非常重要，因为它需要在不同的设备和架构上运行，并且需要与不同的应用程序进程进行通信。使用Socket可以让Zygote进程更加灵活和可扩展，因为它不需要考虑Binder所带来的特定限制和要求。</li><li><code>Socket具有简单的API和易于使用的特点</code>。Zygote进程需要快速启动并与应用程序进程建立通信，Socket提供了快速、可靠的通信方式，并且使用Socket API也很容易实现。相比之下，Binder需要更多的配置和维护工作，这对于Zygote进程来说可能会增加不必要的复杂性和开销。</li><li><code>Socket在数据传输时具有更低的延迟和更高的吞吐量</code>，这对于Zygote进程来说非常重要。Zygote进程需要在较短的时间内启动应用程序进程，并且需要传输大量的数据和代码，Socket的高性能和低延迟使其成为更好的选择。</li></ol><p><strong>总之，Zygote进程使用Socket而不是Binder是基于其优点和需求而做出的选择。虽然Binder在Android中扮演着重要的角色，但在某些情况下，使用Socket可以提供更好的性能和更大的灵活性。再者，Binder当初并不成熟，团队成员对于进程间通讯更倾向于用Socket，后面为了做了很多优化，才使得Binder通讯变得成熟稳定。</strong></p><h3 class=heading-element id=5-每个app都会将系统的资源系统的类都加载一遍吗><span>5 每个App都会将系统的资源，系统的类都加载一遍吗</span>
<a href=#5-%e6%af%8f%e4%b8%aaapp%e9%83%bd%e4%bc%9a%e5%b0%86%e7%b3%bb%e7%bb%9f%e7%9a%84%e8%b5%84%e6%ba%90%e7%b3%bb%e7%bb%9f%e7%9a%84%e7%b1%bb%e9%83%bd%e5%8a%a0%e8%bd%bd%e4%b8%80%e9%81%8d%e5%90%97 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>zygote进程的作用：<br>1.创建一个Service端的Socket，开启一个ServerSocket实现和别的进程通信。<br>2.加载系统类，系统资源。<br>3.启动System Server进程</p><p><strong>Zygote进程预加载系统资源后，然后通过它孵化出其他的虚拟机进程，进而共享虚拟机内存和框架层资源<code>（共享内存）</code>，这样大幅度提高应用程序的启动和运行速度。</strong></p></div><div class=collection-card><div class="collection-title text-secondary">收录于 <a href=/collections/%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8/><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i> <span>合集・开机启动</span></span></a> 3</div><div class=collection-nav><a href=/posts/%E5%BC%80%E6%9C%BA%E4%BC%98%E5%8C%96/ class=collection-nav-item rel=next title=开机优化><span>开机优化</span><i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2024-11-05 01:34:05">更新于 2024-11-05&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://huang8604.github.io/posts/zygote%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3/ data-title=Zygote进程相关><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/blog/ class=post-tag title="标签 - Blog">Blog</a><a href=/tags/framework/ class=post-tag title="标签 - Framework">Framework</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/%E5%8F%8C%E5%B1%8F%E5%8A%A8%E7%94%BB/ class=post-nav-item rel=prev title=双屏动画><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>双屏动画</a><a href=/posts/cts-%E5%9C%A8%E5%86%85%E7%BD%91%E6%9C%BA%E5%99%A8%E5%A6%82%E4%BD%95%E6%B5%8B%E8%AF%95/ class=post-nav-item rel=next title="CTS 在内网机器如何测试">CTS 在内网机器如何测试<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div class=post-reward><div class=comment></div><input type=checkbox class=reward-input name=reward id=fi-reward hidden>
<label class=reward-button for=fi-reward><i class="fa-solid fa-qrcode fa-fw" aria-hidden=true></i>赞赏</label><div class=reward-ways data-mode=static></div></div><div id=comments><div id=giscus class=comment><script src=https://giscus.app/client.js data-repo=huang8604/huang8604.github.io data-repo-id=R_kgDOMx3bEg data-category=Announcements data-category-id=DIC_kwDOMx3bEs4CigIp data-mapping=pathname data-strict=0 data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-loading=lazy crossorigin=anonymous async defer></script></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></article><aside class=toc id=toc-auto aria-label=目录><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside></main><footer class=footer><div class=footer-container><div class="footer-line powered">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.152.2"><img class=hugo-icon src=/images/hugo.min.svg alt="Hugo logo"> Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.3.20"><img class=fixit-icon src=/images/fixit.min.svg alt="FixIt logo"> FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2021 - 2025</span><span class=author itemprop=copyrightHolder>
<a href=https://github.com/huang8604 target=_blank rel="external nofollow noopener noreferrer">wentao</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class="variant-numeric d-none">0%</span></div><div class="fixed-button view-comments d-none" role=button aria-label=查看评论><i class="fa-solid fa-comment fa-fw" aria-hidden=true></i></div></div><div id=mask></div><noscript><div class=noscript-warning>该网站在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=preload href=/lib/katex/katex.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/katex/katex.min.css></noscript><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/fuse/fuse.min.js defer></script><script src=/lib/instant-page/instantpage.min.js async defer type=module></script><script src=/lib/lightgallery/lightgallery.min.js defer></script><script src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js defer></script><script src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:199},comment:{enable:!0,expired:!1,giscus:{darkTheme:"dark",lightTheme:"light",origin:"https://giscus.app"}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/search.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:50,threshold:.3,type:"fuse",useExtendedSearch:!1},version:"v0.3.20"}</script><script src=/js/theme.min.js defer></script><script src=/js/custom.min.js defer></script></body></html>