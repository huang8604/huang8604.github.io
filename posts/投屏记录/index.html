<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>投屏记录 - 文韬的文档</title><meta name=author content="wentao"><meta name=description content="git clone &ndash;recursive https://github.com/huang8604/huang8604.github.io.git
录屏传输 录屏方法 "><meta name=keywords content='blog'><meta itemprop=name content="投屏记录"><meta itemprop=description content="git clone –recursive https://github.com/huang8604/huang8604.github.io.git
录屏传输 录屏方法"><meta itemprop=datePublished content="2024-11-06T06:57:59+00:00"><meta itemprop=dateModified content="2024-11-05T01:34:06+00:00"><meta itemprop=wordCount content="3122"><meta itemprop=keywords content="Blog"><meta property="og:url" content="https://huang8604.github.io/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/"><meta property="og:site_name" content="文韬的文档"><meta property="og:title" content="投屏记录"><meta property="og:description" content="git clone –recursive https://github.com/huang8604/huang8604.github.io.git
录屏传输 录屏方法"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-06T06:57:59+00:00"><meta property="article:modified_time" content="2024-11-05T01:34:06+00:00"><meta property="article:tag" content="Blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="投屏记录"><meta name=twitter:description content="git clone –recursive https://github.com/huang8604/huang8604.github.io.git
录屏传输 录屏方法"><meta name=application-name content="文涛的记录"><meta name=apple-mobile-web-app-title content="文涛的记录"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical type=text/html href=https://huang8604.github.io/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/ title="投屏记录 - 文韬的文档"><link rel=prev type=text/html href=https://huang8604.github.io/posts/%E7%BD%91%E7%BB%9C%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88/ title=网络博客配置方案><link rel=next type=text/html href=https://huang8604.github.io/posts/%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/ title=启动流程分析><link rel=alternate type=text/markdown href=https://huang8604.github.io/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/index.md title="投屏记录 - 文韬的文档"><link rel=stylesheet href=/css/config.min.css><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"投屏记录","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/huang8604.github.io\/posts\/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95\/"},"genre":"posts","keywords":"blog","wordcount":3122,"url":"https:\/\/huang8604.github.io\/posts\/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95\/","datePublished":"2024-11-06T06:57:59+00:00","dateModified":"2024-11-05T01:34:06+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"wentao"},"description":""}</script><script src=/js/head/color-scheme.min.js></script></head><body data-instant-intensity=viewport data-header-desktop=sticky data-header-mobile=auto><div class=wrapper data-page-style=wide><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=文韬的文档><img class=logo src=/images/doc.jpg alt=文韬的文档 height=32 width=32><span class=header-title-text>文韬的文档</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/archives/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 归档</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/collections/><i class="fa-solid fa-group fa-fw fa-sm" aria-hidden=true></i> 合集</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容…… id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" role=button aria-label=切换主题 title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=文韬的文档><img class=logo src=/images/doc.jpg alt=文韬的文档 height=26 width=26><span class=header-title-text>文韬的文档</span></a><span class=header-subtitle></span></div><div class=theme-switch role=button aria-label=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></div><div class=menu-toggle id=menu-toggle-mobile role=button aria-labelledby=menu-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容…… id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/archives/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 归档</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/collections/><i class="fa-solid fa-group fa-fw fa-sm" aria-hidden=true></i> 合集</a></li><li class="menu-item menu-system"></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=fi-container><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label=合集></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>投屏记录</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/huang8604 title=作者 target=_blank rel="external nofollow noopener noreferrer author" class=author><img class=avatar src='https://www.gravatar.com/avatar/b89538cdbc35c279ce1df9f3435f42a1?s=32&d=' alt=wentao height=16 width=16>&nbsp;wentao</a></span></div><div class=post-meta-line><span title="发布于 2024-11-06 06:57:59"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden=true></i><time datetime=2024-11-06>2024-11-06</time></span>&nbsp;<span title="更新于 2024-11-05 01:34:06"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden=true></i><time datetime=2024-11-05>2024-11-05</time></span>&nbsp;<span title="3122 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 3200 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 7 分钟</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><ul><li><a href=#录屏传输>录屏传输</a><ul><li><a href=#录屏方法>录屏方法</a><ul><li><a href=#1-创建虚拟屏幕把内容绘制到屏幕绑定的-surface-中>1 创建虚拟屏幕，把内容绘制到屏幕绑定的 surface 中</a></li><li><a href=#2-surface-由-mediacodec-创建>2 surface 由 mediacodec 创建</a></li><li><a href=#3-把-surface-内容输入到-mediacodec然后编码>3 把 surface 内容输入到 MediaCodec，然后编码</a></li></ul></li><li><a href=#录屏保存为文件>录屏保存为文件</a></li><li><a href=#录屏数据编码传输>录屏数据编码传输</a></li><li><a href=#录屏数据解码显示>录屏数据解码显示</a></li></ul></li><li><a href=#投屏相关>投屏相关</a><ul><li><a href=#同显模式-mirror>同显模式 mirror</a></li><li><a href=#异显模式-own_content>异显模式 OWN_CONTENT</a></li><li><a href=#不同尺寸的投屏>不同尺寸的投屏</a></li></ul></li><li><a href=#异屏幕启动方式>异屏幕启动方式</a><ul><li><a href=#一-dialog>一 Dialog</a></li><li><a href=#二>二</a></li><li><a href=#三-activity>三 Activity</a></li></ul></li><li><a href=#触摸部分>触摸部分</a><ul><li><a href=#触摸事件注入>触摸事件注入</a></li></ul></li><li><a href=#音频部分>音频部分</a><ul><li><a href=#服务端>服务端</a><ul><li><a href=#audirecord-版本>AudiRecord 版本</a></li><li><a href=#优化版本>优化版本：</a></li></ul></li><li><a href=#客户端>客户端</a></li></ul></li><li><a href=#bytebuffer-介绍>ByteBuffer 介绍</a></li><li><a href=#功能再优化>功能再优化</a><ul><li><a href=#视频延时测试验证>视频延时测试验证</a></li><li><a href=#悬浮窗口>悬浮窗口</a></li><li><a href=#音频延迟测试方案>音频延迟测试方案</a></li><li><a href=#优化方案>优化方案</a><ul><li><a href=#视频方面>视频方面</a></li><li><a href=#音频方面>音频方面</a></li></ul></li></ul></li><li><a href=#强制桌面模式>强制桌面模式</a></li></ul></li></ul></li></ul></nav></div></div><div class=content id=content><p>git clone &ndash;recursive <a href=https://github.com/huang8604/huang8604.github.io.git target=_blank rel="external nofollow noopener noreferrer">https://github.com/huang8604/huang8604.github.io.git</a></p><h4 class=heading-element id=录屏传输><span>录屏传输</span>
<a href=#%e5%bd%95%e5%b1%8f%e4%bc%a0%e8%be%93 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><h5 class=heading-element id=录屏方法><span>录屏方法</span>
<a href=#%e5%bd%95%e5%b1%8f%e6%96%b9%e6%b3%95 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2024/09/12/66e29fd7e5a89.png title=1726128089259.png data-thumbnail=https://picgo.myjojo.fun:666/i/2024/09/12/66e29fd7e5a89.png data-sub-html="<h2>1726128089259.png</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2024/09/12/66e29fd7e5a89.png alt=1726128089259.png></a></p><p>录屏原理</p><h6 class=heading-element id=1-创建虚拟屏幕把内容绘制到屏幕绑定的-surface-中><span>1 创建虚拟屏幕，把内容绘制到屏幕绑定的 surface 中</span>
<a href=#1-%e5%88%9b%e5%bb%ba%e8%99%9a%e6%8b%9f%e5%b1%8f%e5%b9%95%e6%8a%8a%e5%86%85%e5%ae%b9%e7%bb%98%e5%88%b6%e5%88%b0%e5%b1%8f%e5%b9%95%e7%bb%91%e5%ae%9a%e7%9a%84-surface-%e4%b8%ad class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h6><p>针对第三方的应用，由于缺少权限。</p><p>需要通过 MediaProjection 的方式创建</p><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-java"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=1 style=--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>projectionManager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>MediaProjectionManager</span><span class=p>)</span><span class=w> </span><span class=n>getSystemService</span><span class=p>(</span><span class=n>MEDIA_PROJECTION_SERVICE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>meidaProjection</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>projectionManager</span><span class=p>.</span><span class=na>getMediaProjection</span><span class=p>(</span><span class=n>resultCode</span><span class=p>,</span><span class=n>data</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//创建前台通知</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//mediac 创建的surface</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//创建虚拟屏幕</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>virtualDisplay</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mediaProjection</span><span class=p>.</span><span class=na>createVirtualDisplay</span><span class=p>(</span><span class=s>&#34;name&#34;</span><span class=p>,</span><span class=n>width</span><span class=p>,</span><span class=n>height</span><span class=p>,</span><span class=n>dpi</span><span class=p>,</span><span class=n>flag</span><span class=p>..</span><span class=na>mirro</span><span class=p>,</span><span class=n>surface</span><span class=p>,</span><span class=kc>null</span><span class=p>,</span><span class=kc>null</span><span class=p>);</span></span></span></code></pre></td></tr></table></div></div></div><p>对于系统应用，可以直接创建虚拟屏幕</p><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-java"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=1 style=--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>virtualDisplay</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>DisplayManager</span><span class=p>)</span><span class=n>getsystemservice</span><span class=p>(</span><span class=n>DISPLAY_SERVIcE</span><span class=p>)).</span><span class=na>createvirtualDisplay</span><span class=p>(</span><span class=s>&#34;Mainscreen&#34;</span><span class=p>,</span><span class=w> </span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=n>height</span><span class=p>,</span><span class=w> </span><span class=n>dpi</span><span class=p>,</span><span class=n>surface</span><span class=p>,</span><span class=n>flgs</span><span class=p>:</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>10</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>DisPlayManager</span><span class=p>.</span><span class=na>VIRTUAL_DISPLAY_FLAG</span><span class=w> </span><span class=n>PRESENTATION</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>DisPlayManage</span><span class=w> </span><span class=n>r</span><span class=p>.</span><span class=na>VIRTUAL_DISPLAY_FLKG_PUBLIC</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>DisPlayManager</span><span class=p>.</span><span class=na>VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY</span><span class=p>);</span></span></span></code></pre></td></tr></table></div></div></div><h6 class=heading-element id=2-surface-由-mediacodec-创建><span>2 surface 由 mediacodec 创建</span>
<a href=#2-surface-%e7%94%b1-mediacodec-%e5%88%9b%e5%bb%ba class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h6><h6 class=heading-element id=3-把-surface-内容输入到-mediacodec然后编码><span>3 把 surface 内容输入到 MediaCodec，然后编码</span>
<a href=#3-%e6%8a%8a-surface-%e5%86%85%e5%ae%b9%e8%be%93%e5%85%a5%e5%88%b0-mediacodec%e7%84%b6%e5%90%8e%e7%bc%96%e7%a0%81 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h6><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-java"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=2 style=--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>MediaFormat</span><span class=w> </span><span class=n>format</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createFormate</span><span class=p>(...</span><span class=w> </span><span class=n>bit</span><span class=p>,</span><span class=n>fps</span><span class=p>,);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>MediaCodec</span><span class=w> </span><span class=n>codec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createMediaCodec</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>SurfactControl</span><span class=p>.</span><span class=na>createDisplay</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>configure</span><span class=p>(</span><span class=n>codec</span><span class=p>,</span><span class=n>format</span><span class=p>);</span><span class=c1>//codec.configure(format)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>Surface</span><span class=w> </span><span class=n>surface</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>codec</span><span class=p>.</span><span class=na>createInputSurface</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>setDisplaySurface</span><span class=p>(</span><span class=n>display</span><span class=p>,</span><span class=n>surface</span><span class=p>,...)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>codec</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//开启循环</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>alive</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>encode</span><span class=p>(</span><span class=n>codec</span><span class=p>,</span><span class=n>fd</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>code</span><span class=p>.</span><span class=na>stop</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>destoryDisplay</span><span class=p>(</span><span class=n>diaplay</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>codec</span><span class=p>.</span><span class=na>release</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>surface</span><span class=p>.</span><span class=na>release</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>encode</span><span class=p>(</span><span class=n>MediaCodec</span><span class=w> </span><span class=n>codec</span><span class=p>,</span><span class=w> </span><span class=n>FileDescriptor</span><span class=w> </span><span class=n>fd</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>eof</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>MediaCodec</span><span class=p>.</span><span class=na>BufferInfo</span><span class=w> </span><span class=n>bufferInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MediaCodec</span><span class=p>.</span><span class=na>BufferInfo</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>consumeRotationChange</span><span class=p>()</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>eof</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>outputBufferId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>codec</span><span class=p>.</span><span class=na>dequeueOutputBuffer</span><span class=p>(</span><span class=n>bufferInfo</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>eof</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>bufferInfo</span><span class=p>.</span><span class=na>flags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>MediaCodec</span><span class=p>.</span><span class=na>BUFFER_FLAG_END_OF_STREAM</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>consumeRotationChange</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// must restart encoding with new size</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>outputBufferId</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ByteBuffer</span><span class=w> </span><span class=n>codecBuffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>codec</span><span class=p>.</span><span class=na>getOutputBuffer</span><span class=p>(</span><span class=n>outputBufferId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sendFrameMeta</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=c1>//写入文件头</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>writeFrameMeta</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>bufferInfo</span><span class=p>,</span><span class=w> </span><span class=n>codecBuffer</span><span class=p>.</span><span class=na>remaining</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=c1>//写入帧数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>IO</span><span class=p>.</span><span class=na>writeFully</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>codecBuffer</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>outputBufferId</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>codec</span><span class=p>.</span><span class=na>releaseOutputBuffer</span><span class=p>(</span><span class=n>outputBufferId</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=o>!</span><span class=n>eof</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setDisplaySurface</span><span class=p>(</span><span class=n>IBinder</span><span class=w> </span><span class=n>display</span><span class=p>,</span><span class=w> </span><span class=n>Surface</span><span class=w> </span><span class=n>surface</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>orientation</span><span class=p>,</span><span class=w> </span><span class=n>Rect</span><span class=w> </span><span class=n>deviceRect</span><span class=p>,</span><span class=w> </span><span class=n>Rect</span><span class=w> </span><span class=n>displayRect</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>layerStack</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>SurfaceControl</span><span class=p>.</span><span class=na>openTransaction</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SurfaceControl</span><span class=p>.</span><span class=na>setDisplaySurface</span><span class=p>(</span><span class=n>display</span><span class=p>,</span><span class=w> </span><span class=n>surface</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SurfaceControl</span><span class=p>.</span><span class=na>setDisplayProjection</span><span class=p>(</span><span class=n>display</span><span class=p>,</span><span class=w> </span><span class=n>orientation</span><span class=p>,</span><span class=w> </span><span class=n>deviceRect</span><span class=p>,</span><span class=w> </span><span class=n>displayRect</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SurfaceControl</span><span class=p>.</span><span class=na>setDisplayLayerStack</span><span class=p>(</span><span class=n>display</span><span class=p>,</span><span class=w> </span><span class=n>layerStack</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>finally</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>SurfaceControl</span><span class=p>.</span><span class=na>closeTransaction</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=nf>MediaCodec</span><span class=w>  </span><span class=p>(</span><span class=n>Codec</span><span class=w> </span><span class=n>codec</span><span class=p>,</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>encoderName</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>IOException</span><span class=p>,</span><span class=w> </span><span class=n>ConfigurationException</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>encoderName</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Ln</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=s>&#34;Creating encoder by name: &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>encoderName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>MediaCodec</span><span class=p>.</span><span class=na>createByCodecName</span><span class=p>(</span><span class=n>encoderName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IllegalArgumentException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Ln</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=s>&#34;Video encoder &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>encoderName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39; for &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>codec</span><span class=p>.</span><span class=na>getName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34; not found\n&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>LogUtils</span><span class=p>.</span><span class=na>buildVideoEncoderListMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ConfigurationException</span><span class=p>(</span><span class=s>&#34;Unknown encoder: &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>encoderName</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Ln</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=s>&#34;Could not create video encoder &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>encoderName</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39; for &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>codec</span><span class=p>.</span><span class=na>getName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\n&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>LogUtils</span><span class=p>.</span><span class=na>buildVideoEncoderListMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>MediaCodec</span><span class=w> </span><span class=n>mediaCodec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MediaCodec</span><span class=p>.</span><span class=na>createEncoderByType</span><span class=p>(</span><span class=n>codec</span><span class=p>.</span><span class=na>getMimeType</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Ln</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=s>&#34;Using video encoder: &#39;&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mediaCodec</span><span class=p>.</span><span class=na>getName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;&#39;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>mediaCodec</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>IOException</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Ln</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=s>&#34;Could not create default video encoder for &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>codec</span><span class=p>.</span><span class=na>getName</span><span class=p>()</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;\n&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>LogUtils</span><span class=p>.</span><span class=na>buildVideoEncoderListMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=n>e</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div><div class=code-expand-btn aria-label=展开或折叠代码块 role=button><i class="fa-solid fa-angles-down" aria-hidden=true></i></div></div></div><h5 class=heading-element id=录屏保存为文件><span>录屏保存为文件</span>
<a href=#%e5%bd%95%e5%b1%8f%e4%bf%9d%e5%ad%98%e4%b8%ba%e6%96%87%e4%bb%b6 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-java"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=2 style=--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>String</span><span class=w> </span><span class=n>rootDir</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Applistion</span><span class=p>.</span><span class=na>getInstance</span><span class=p>().</span><span class=na>getExternalCacheDir</span><span class=p>()</span><span class=o>+</span><span class=s>&#34;...&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>File</span><span class=w> </span><span class=n>file</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>File</span><span class=p>(</span><span class=n>path</span><span class=o>+</span><span class=s>&#34;test.h264&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>FileOutputStream</span><span class=w> </span><span class=n>fileOutputStream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>fileOutputStream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FileOutputStream</span><span class=p>(</span><span class=n>file</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>fileOutputStream</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=n>data</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>fileOutstream</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>fileOutStream</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>fileOutStream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>file</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span></span></span></code></pre></td></tr></table></div><div class=code-expand-btn aria-label=展开或折叠代码块 role=button><i class="fa-solid fa-angles-down" aria-hidden=true></i></div></div></div><h5 class=heading-element id=录屏数据编码传输><span>录屏数据编码传输</span>
<a href=#%e5%bd%95%e5%b1%8f%e6%95%b0%e6%8d%ae%e7%bc%96%e7%a0%81%e4%bc%a0%e8%be%93 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>服务端</p><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-java"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=2 style=--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>ServerSocket</span><span class=w> </span><span class=n>mServer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>Socket</span><span class=w> </span><span class=n>mSocket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kt>void</span><span class=w> </span><span class=nf>init</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=w> </span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Runnable</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=p>(</span><span class=kc>true</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=p>(</span><span class=n>mServer</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>//新建服务socket 服务</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mServer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ServerSocker</span><span class=p>(</span><span class=n>6666</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mSocket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mServer</span><span class=p>.</span><span class=na>accept</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>//建立连接后写入数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mSocket</span><span class=p>.</span><span class=na>getOutputStream</span><span class=p>().</span><span class=na>write</span><span class=p>(</span><span class=n>66</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=k>catch</span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>pri</span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Socket</span><span class=w> </span><span class=nf>getSocket</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>mSocket</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>ConnectionManager</span><span class=p>.</span><span class=na>getInstance</span><span class=p>().</span><span class=na>getSocket</span><span class=p>().</span><span class=na>getOutPutStream</span><span class=p>().</span><span class=na>write</span><span class=p>(</span><span class=n>data</span><span class=p>);</span></span></span></code></pre></td></tr></table></div><div class=code-expand-btn aria-label=展开或折叠代码块 role=button><i class="fa-solid fa-angles-down" aria-hidden=true></i></div></div></div><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-java"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=2 style=--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>MediaCodeec</span><span class=p>.</span><span class=na>BufferInfo</span><span class=w> </span><span class=n>buffInfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MediaCode</span><span class=p>.</span><span class=na>BufferInfo</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>while</span><span class=p>(</span><span class=n>running</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>eof</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>outputBufferId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>codec</span><span class=p>.</span><span class=na>dequeueOutputBuffer</span><span class=p>(</span><span class=n>bufferInfo</span><span class=p>,</span><span class=n>timeouts</span><span class=o>-</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>eof</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>bufferInfo</span><span class=p>.</span><span class=na>flags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>MediaCodec</span><span class=p>.</span><span class=na>BUFFER_FLAG_END_OF_STREAM</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>outBufferId</span><span class=w> </span><span class=o>&gt;=</span><span class=n>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ByteBuffer</span><span class=w> </span><span class=n>codeBuffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>codec</span><span class=p>.</span><span class=na>getoutputBuffer</span><span class=p>(</span><span class=n>outputBufferId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[</span><span class=n>codecBuffer</span><span class=p>.</span><span class=na>remaining</span><span class=p>()</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>codecBuffer</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>data</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>h264Len</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=na>length</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ByteBuffer</span><span class=w> </span><span class=n>dataBuffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ByteBuffer</span><span class=p>.</span><span class=na>allocate</span><span class=p>(</span><span class=n>4</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>dataBuffer</span><span class=p>.</span><span class=na>putInt</span><span class=p>(</span><span class=n>h264Len</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>dataBuffer</span><span class=p>.</span><span class=na>flip</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>dataLen</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=p>(</span><span class=n>4</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>dataLenBuf</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>dataLen</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ConnectionManager</span><span class=p>.</span><span class=na>getInstance</span><span class=p>().</span><span class=na>getSocket</span><span class=p>().</span><span class=na>getOutputStream</span><span class=p>().</span><span class=na>write</span><span class=p>(</span><span class=n>dataLen</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ConnectionManager</span><span class=p>.</span><span class=na>getInstance</span><span class=p>().</span><span class=na>getSocket</span><span class=p>().</span><span class=na>getOutputStream</span><span class=p>().</span><span class=na>write</span><span class=p>(</span><span class=n>data</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=k>finally</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>outBufferId</span><span class=w> </span><span class=o>&gt;=</span><span class=n>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>codec</span><span class=p>.</span><span class=na>releaseOutputBuffer</span><span class=p>(</span><span class=n>outBufferId</span><span class=p>,</span><span class=kc>false</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div><div class=code-expand-btn aria-label=展开或折叠代码块 role=button><i class="fa-solid fa-angles-down" aria-hidden=true></i></div></div></div><p>客户端的接受</p><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-java"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=2 style=--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Socket</span><span class=w> </span><span class=n>mClientSocket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Runnable</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=nd>@Overrride</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     	</span><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mClientSocket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Socket</span><span class=p>(</span><span class=n>ip</span><span class=p>,</span><span class=n>port</span><span class=w> </span><span class=n>6666</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>int</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mClientSocket</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>data</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>//接受一个头字节</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>len</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>data</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>66</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//ok</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>runOnUiThread</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Runnable</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>//...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=p>(</span><span class=n>running</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>headLen</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[</span><span class=n>4</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>readLen</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>while</span><span class=p>(</span><span class=n>readLen</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>headLen</span><span class=p>.</span><span class=na>length</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>readLen</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>readLen</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mClientSocket</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>headLen</span><span class=p>,</span><span class=n>readLen</span><span class=p>,</span><span class=n>headLen</span><span class=p>.</span><span class=na>length</span><span class=o>-</span><span class=n>readLen</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//读取的数组 转为 长度</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=kt>int</span><span class=w> </span><span class=n>h264Len</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>byteArrayToInt</span><span class=p>(</span><span class=n>headLen</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>rawData</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[</span><span class=n>h264Len</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>rawDataLen</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>while</span><span class=p>(</span><span class=n>rawDataLen</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>h264Len</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>rawDataLen</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>rawDataLen</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mClientSocket</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>rawData</span><span class=p>,</span><span class=n>rawDataLen</span><span class=p>,</span><span class=n>h264Len</span><span class=o>-</span><span class=n>rawDataLen</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//rawData 就是每一帧的图像数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//生产放入数组</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>mH264List</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mH264List</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>rawData</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=c1>//消费者可能在等待</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mH264List</span><span class=p>.</span><span class=na>notify</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//保存文件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// fileOutputStream.write(h264Data,0,readLen1);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>             </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=k>catch</span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>e</span><span class=p>.</span><span class=na>pritStack</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>byteArrayToInt</span><span class=p>(</span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>bytes</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 确保输入的byte数组长度为4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>bytes</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>4</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;Byte array must be 4 bytes long&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>bytes</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>0xFF</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>24</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=p>(</span><span class=n>bytes</span><span class=o>[</span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>0xFF</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>16</span><span class=w> </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=p>(</span><span class=n>bytes</span><span class=o>[</span><span class=n>2</span><span class=o>]</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>0xFF</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>8</span><span class=w>  </span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>           </span><span class=p>(</span><span class=n>bytes</span><span class=o>[</span><span class=n>3</span><span class=o>]</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>0xFF</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>byteArrayToInt</span><span class=p>(</span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>bytes</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 确保输入的byte数组长度为4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>bytes</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>4</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;Byte array must be 4 bytes long&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 使用 ByteBuffer 将 byte[] 转换为 int</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>ByteBuffer</span><span class=w> </span><span class=n>buffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ByteBuffer</span><span class=p>.</span><span class=na>wrap</span><span class=p>(</span><span class=n>bytes</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>buffer</span><span class=p>.</span><span class=na>getInt</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>byteToInt2</span><span class=p>(</span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>src</span><span class=p>,</span><span class=kt>int</span><span class=w> </span><span class=n>offset</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div><div class=code-expand-btn aria-label=展开或折叠代码块 role=button><i class="fa-solid fa-angles-down" aria-hidden=true></i></div></div></div><h5 class=heading-element id=录屏数据解码显示><span>录屏数据解码显示</span>
<a href=#%e5%bd%95%e5%b1%8f%e6%95%b0%e6%8d%ae%e8%a7%a3%e7%a0%81%e6%98%be%e7%a4%ba class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2024/09/12/66e2b8711e6e9.jpg title=1726134395165.jpg data-thumbnail=https://picgo.myjojo.fun:666/i/2024/09/12/66e2b8711e6e9.jpg data-sub-html="<h2>1726134395165.jpg</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2024/09/12/66e2b8711e6e9.jpg alt=1726134395165.jpg></a></p><ol><li><p>client 先从 codec 请求 <strong>空的</strong> input buffer，填满</p></li><li><p>送给 codec，codec 内部再解码</p></li><li><p>显示端从 codec 取出 outputbuffer ，opengl 绘制，或者调用接口处理</p></li></ol><p><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2024/09/12/66e2b98133964.jpg title=1726134667073.jpg data-thumbnail=https://picgo.myjojo.fun:666/i/2024/09/12/66e2b98133964.jpg data-sub-html="<h2>1726134667073.jpg</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2024/09/12/66e2b98133964.jpg alt=1726134667073.jpg></a></p><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-java"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=2 style=--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>MediaCodec</span><span class=w> </span><span class=n>mediaCodec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kt>void</span><span class=w> </span><span class=nf>inintMediaCode</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mediaCodec</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MediaCodec</span><span class=p>.</span><span class=na>createDecoderByType</span><span class=p>(</span><span class=n>MediaFormat</span><span class=p>.</span><span class=na>MIMETYE_VIDEO_AVC</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    	</span><span class=n>MediaFormat</span><span class=w> </span><span class=n>format</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MediaFormat</span><span class=p>.</span><span class=na>createVideoFormat</span><span class=p>(</span><span class=n>MediaFormat</span><span class=p>.</span><span class=na>MIMETYPE_VIDEO_AVC</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mediaCodec</span><span class=p>.</span><span class=na>configure</span><span class=p>(</span><span class=n>format</span><span class=p>,</span><span class=n>surface</span><span class=p>,</span><span class=kc>null</span><span class=p>,</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mediaCodec</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>e</span><span class=p>.</span><span class=na>print</span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>ArrayList</span><span class=o>&lt;</span><span class=kt>byte</span><span class=o>[]&gt;</span><span class=w> </span><span class=n>mH264List</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kt>void</span><span class=w> </span><span class=nf>decodeH264</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Runnable</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=k>if</span><span class=p>(</span><span class=n>mediacode</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=k>while</span><span class=p>(</span><span class=n>running</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>               	</span><span class=c1>//消费</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>rawH264</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kd>synchronized</span><span class=w> </span><span class=p>(</span><span class=n>mH264List</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=p>(</span><span class=n>mH264List</span><span class=p>,</span><span class=n>size</span><span class=p>()</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>rawH264</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mH264List</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>mH264List</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=p>(</span><span class=n>rawH264</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=c1>//wait的时候，锁回释放掉</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>mH264List</span><span class=p>.</span><span class=na>wait</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=k>catch</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>continue</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//解码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ByteBuffer</span><span class=o>[]</span><span class=w> </span><span class=n>intputBuffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mediaCode</span><span class=p>.</span><span class=na>getInputBuffers</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>inputIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>while</span><span class=p>(</span><span class=n>inputIndex</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>inputIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mediaCode</span><span class=p>.</span><span class=na>deququeInputBuffer</span><span class=p>(</span><span class=n>timeouts</span><span class=w> </span><span class=n>10000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>ByteBuffer</span><span class=w> </span><span class=n>bytebuffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>inputBuffers</span><span class=o>[</span><span class=n>inputIndex</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>bytebuffer</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>bytebuffer</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>rawH264</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mediaCode</span><span class=p>.</span><span class=na>queueInputBuffer</span><span class=p>(</span><span class=n>inputIndex</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>rawH264</span><span class=p>.</span><span class=na>lenth</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//渲染到surface</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>MediaCodec</span><span class=p>.</span><span class=na>BufferInfo</span><span class=w> </span><span class=n>info</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MediaCodec</span><span class=p>.</span><span class=na>BufferInfo</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>outputIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mediaCode</span><span class=p>.</span><span class=na>dequeueOutputBuffer</span><span class=p>(</span><span class=n>info</span><span class=p>,</span><span class=n>timeout</span><span class=w> </span><span class=n>10000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=p>(</span><span class=n>outputIndex</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mediaCode</span><span class=p>.</span><span class=na>releaseOutputBuffer</span><span class=p>(</span><span class=n>outputIndex</span><span class=p>,</span><span class=kc>true</span><span class=p>);</span><span class=c1>//render = true ,就会渲染</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//创建一个SurfaceView</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>SurfaceView</span><span class=w> </span><span class=n>surfaceView</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>findViewById</span><span class=p>(...);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>SurfaceView</span><span class=p>.</span><span class=na>getHolder</span><span class=p>().</span><span class=na>addCallback</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>SurfaceHolder</span><span class=p>.</span><span class=na>callback</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>surfaceChanged</span><span class=p>(</span><span class=w> </span><span class=n>holder</span><span class=p>,</span><span class=n>format</span><span class=p>,</span><span class=n>width</span><span class=p>,</span><span class=n>height</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>initMeidaCodec</span><span class=p>(</span><span class=n>holder</span><span class=p>.</span><span class=na>getSurface</span><span class=p>(),</span><span class=n>w</span><span class=p>,</span><span class=n>h</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=p>});</span></span></span></code></pre></td></tr></table></div><div class=code-expand-btn aria-label=展开或折叠代码块 role=button><i class="fa-solid fa-angles-down" aria-hidden=true></i></div></div></div><h4 class=heading-element id=投屏相关><span>投屏相关</span>
<a href=#%e6%8a%95%e5%b1%8f%e7%9b%b8%e5%85%b3 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>创建虚拟屏幕有一些FLAG</p><h5 class=heading-element id=同显模式-mirror><span>同显模式 mirror</span>
<a href=#%e5%90%8c%e6%98%be%e6%a8%a1%e5%bc%8f-mirror class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><h5 class=heading-element id=异显模式-own_content><span>异显模式 OWN_CONTENT</span>
<a href=#%e5%bc%82%e6%98%be%e6%a8%a1%e5%bc%8f-own_content class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-java"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=1 style=--fi-max-shown-lines:10;--fi-line-digit:1;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>virtualDisplay</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>((</span><span class=n>DisplayManager</span><span class=p>)</span><span class=n>getsystemservice</span><span class=p>(</span><span class=n>DISPLAY_SERVIcE</span><span class=p>)).</span><span class=na>createvirtualDisplay</span><span class=p>(</span><span class=s>&#34;Mainscreen&#34;</span><span class=p>,</span><span class=w> </span><span class=n>width</span><span class=p>,</span><span class=w> </span><span class=n>height</span><span class=p>,</span><span class=w> </span><span class=n>dpi</span><span class=p>,</span><span class=n>surfaceHags</span><span class=p>:</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>10</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>DisPlayManager</span><span class=p>.</span><span class=na>VIRTUAL_DISPLAY_FLAG</span><span class=w> </span><span class=n>PRESENTATION</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>DisPlayManager</span><span class=p>.</span><span class=na>VIRTUAL_DISPLAY_FLKG_PUBLIC</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>DisPlayManager</span><span class=p>.</span><span class=na>VIRTUAL_DISPLAY_FLAG_OWN_CONTENT_ONLY</span><span class=p>);</span></span></span></code></pre></td></tr></table></div></div></div><p>surfaceHags: 1 &lt; 10 其实为VIRTUAL_DISPLAY_FLAG_TRUSTED flag</p><p>VIRTUAL_DISPLAY_FLAG_SECURE ,没有该flag，截图或者支付等界面是不允许打开在该屏幕</p><h5 class=heading-element id=不同尺寸的投屏><span>不同尺寸的投屏</span>
<a href=#%e4%b8%8d%e5%90%8c%e5%b0%ba%e5%af%b8%e7%9a%84%e6%8a%95%e5%b1%8f class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-java"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=2 style=--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//服务端</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>Config</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>sWidth</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1280</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>sHeight</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>720</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>sDpi</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>213</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>createvirtualDisplay</span><span class=w> </span><span class=n>有相应的参数</span><span class=err>，</span><span class=n>宽</span><span class=w> </span><span class=n>高</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=c1>//客户端</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>获取屏幕宽高</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>DisplayMetries</span><span class=w> </span><span class=n>metries</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>getResource</span><span class=p>().</span><span class=na>getDisplayMetrics</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kt>int</span><span class=w> </span><span class=n>widthDiplay</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>metrics</span><span class=p>.</span><span class=na>widthPixels</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kt>int</span><span class=w> </span><span class=n>heightDiplay</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>metrics</span><span class=p>.</span><span class=na>heightPixels</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>ViewGroup</span><span class=p>.</span><span class=na>LayoutParams</span><span class=w> </span><span class=n>layoutParams</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>surfaceView</span><span class=p>.</span><span class=na>getLayoutParams</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>layoutParams</span><span class=p>.</span><span class=na>width</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>w</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>layoutParams</span><span class=p>.</span><span class=na>height</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>h</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>surfaceView</span><span class=p>.</span><span class=na>setLayoutParams</span><span class=p>(</span><span class=n>layoutParams</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=n>runOnUiThread</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Runnable</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Overrride</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>resize</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>});</span></span></span></code></pre></td></tr></table></div><div class=code-expand-btn aria-label=展开或折叠代码块 role=button><i class="fa-solid fa-angles-down" aria-hidden=true></i></div></div></div><h4 class=heading-element id=异屏幕启动方式><span>异屏幕启动方式</span>
<a href=#%e5%bc%82%e5%b1%8f%e5%b9%95%e5%90%af%e5%8a%a8%e6%96%b9%e5%bc%8f class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><h5 class=heading-element id=一-dialog><span>一 Dialog</span>
<a href=#%e4%b8%80-dialog class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><h5 class=heading-element id=二><span>二</span>
<a href=#%e4%ba%8c class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><h5 class=heading-element id=三-activity><span>三 Activity</span>
<a href=#%e4%b8%89-activity class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-fallback"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=2 style=--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>void startActivityOtherDisplay(Context context){
</span></span><span class=line><span class=cl>	DisplayManager mDisplayManager = (DisplayManager) context.getSystemService(Context.DISPLAY_SERVICE);
</span></span><span class=line><span class=cl>	Display[] displays = mDisplayManger.getDisplays();
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	if(display.length &gt; 1){
</span></span><span class=line><span class=cl>	  Intent intent = new Intent();
</span></span><span class=line><span class=cl>		intent.setClass(context,MainActivity.class);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	  AcitivityOptions options = ActivityOptions.makeBasic();
</span></span><span class=line><span class=cl>	  //设置最后一个屏幕的id，这里可以根据name等特征值设置ID
</span></span><span class=line><span class=cl>	  options.setLaunchDisplayId(displays[displays.length -1].getDisplayId());
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	  context.startActivity(intent,options.toBunndle());
</span></span><span class=line><span class=cl>	}else{
</span></span><span class=line><span class=cl>		Log.d(&#34;test&#34;,&#34;only one display&#34;);
</span></span><span class=line><span class=cl>	}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>}</span></span></code></pre></td></tr></table></div><div class=code-expand-btn aria-label=展开或折叠代码块 role=button><i class="fa-solid fa-angles-down" aria-hidden=true></i></div></div></div><h4 class=heading-element id=触摸部分><span>触摸部分</span>
<a href=#%e8%a7%a6%e6%91%b8%e9%83%a8%e5%88%86 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><h5 class=heading-element id=触摸事件注入><span>触摸事件注入</span>
<a href=#%e8%a7%a6%e6%91%b8%e4%ba%8b%e4%bb%b6%e6%b3%a8%e5%85%a5 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-java"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=2 style=--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>MotionEvent</span><span class=w> </span><span class=n>event</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MotionEvent</span><span class=p>.</span><span class=na>obtain</span><span class=p>(</span><span class=n>now</span><span class=p>,</span><span class=n>now</span><span class=p>,</span><span class=n>action</span><span class=p>,</span><span class=n>pointCount</span><span class=p>,</span><span class=n>coords</span><span class=p>,</span><span class=n>metaState</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=n>buttonState</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=n>xPrecision</span><span class=w> </span><span class=n>1</span><span class=w> </span><span class=p>,</span><span class=n>yPresision</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=n>deviceID</span><span class=p>:</span><span class=n>0</span><span class=p>,</span><span class=n>edgeFlags</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=n>InputDevice</span><span class=p>.</span><span class=na>SOURCE_TOUCHSCREEN</span><span class=p>,</span><span class=n>flags</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//hide 方法，apk需要通过反射调用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>MotionEvent</span><span class=p>.</span><span class=na>setDisplayId</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//反射方法 begin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setDisplayId</span><span class=p>(</span><span class=n>MotionEvent</span><span class=w> </span><span class=n>event</span><span class=p>,</span><span class=kt>int</span><span class=w> </span><span class=n>displayId</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>try</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>Mothed</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MotionEvent</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>getMethod</span><span class=p>(</span><span class=s>&#34;setDisplayId&#34;</span><span class=p>,</span><span class=kt>int</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	  </span><span class=n>method</span><span class=p>.</span><span class=na>invoke</span><span class=p>(</span><span class=n>event</span><span class=p>,</span><span class=n>displayId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=k>catch</span><span class=p>(){}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//反射方法 end</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=n>Instrumentation</span><span class=w> </span><span class=n>instrumentation</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Instrumentation</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>instrumentaion</span><span class=p>.</span><span class=na>sendPointerSync</span><span class=p>(</span><span class=n>MotionEvent</span><span class=p>)</span></span></span></code></pre></td></tr></table></div><div class=code-expand-btn aria-label=展开或折叠代码块 role=button><i class="fa-solid fa-angles-down" aria-hidden=true></i></div></div></div><h4 class=heading-element id=音频部分><span>音频部分</span>
<a href=#%e9%9f%b3%e9%a2%91%e9%83%a8%e5%88%86 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><h5 class=heading-element id=服务端><span>服务端</span>
<a href=#%e6%9c%8d%e5%8a%a1%e7%ab%af class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><h6 class=heading-element id=audirecord-版本><span>AudiRecord 版本</span>
<a href=#audirecord-%e7%89%88%e6%9c%ac class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h6><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-java"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=2 style=--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>int</span><span class=w> </span><span class=n>AUDIO_SOURCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MediaRecorder</span><span class=p>.</span><span class=na>AudioSOURCE</span><span class=p>.</span><span class=na>REMOTE_SUBMIX</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>publicint</span><span class=w> </span><span class=n>CHANNEL</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AUdiOFORMAT</span><span class=p>.</span><span class=na>CHANNEL_IN_STEREO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>static</span><span class=w> </span><span class=n>finalint</span><span class=w> </span><span class=n>AUDIO_FORMAT</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AUdioFOrmat</span><span class=p>.</span><span class=na>ENCODING_PCM_16BIT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>finalint</span><span class=w> </span><span class=n>SAMPLE</span><span class=w> </span><span class=n>RATE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>44100</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>AudioDataManager</span><span class=w> </span><span class=n>sAudioDataManager</span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AudioDataManager</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kt>boolean</span><span class=w> </span><span class=n>mRecording</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>AudioRecord</span><span class=w> </span><span class=n>audioRecord</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=kt>int</span><span class=w> </span><span class=n>buffersize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kt>void</span><span class=w> </span><span class=nf>startRecord</span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>Socket</span><span class=w> </span><span class=n>socket</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mRecording</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>buffersize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AudioRecord</span><span class=p>.</span><span class=na>getMinBUfferSiZe</span><span class=p>(</span><span class=n>SAMPLE</span><span class=w> </span><span class=n>RATE</span><span class=p>,</span><span class=w> </span><span class=n>CHANNEL</span><span class=w> </span><span class=p>,</span><span class=n>AUDIO</span><span class=w> </span><span class=n>FORMAT</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>audioRecord</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AudioRecord</span><span class=p>(</span><span class=n>AUDIO</span><span class=w> </span><span class=n>SOURCE</span><span class=p>,</span><span class=n>SAMPLE</span><span class=w> </span><span class=n>RATE</span><span class=p>,</span><span class=w> </span><span class=n>CHANNEL</span><span class=p>,</span><span class=n>AUDIO_FORMAT</span><span class=p>,</span><span class=n>buffersize</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>audioRecord</span><span class=p>.</span><span class=na>startRecording</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Runnable</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@0verride</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>while</span><span class=p>(</span><span class=n>mRecording</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>bytel</span><span class=o>]</span><span class=w> </span><span class=n>buffer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[</span><span class=n>buffersize</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>int</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>audioRecord</span><span class=p>.</span><span class=na>read</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=n>offsetinBytes</span><span class=p>:</span><span class=w> </span><span class=n>o</span><span class=p>,</span><span class=n>buffer</span><span class=p>.</span><span class=na>length</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>len</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                	</span><span class=k>if</span><span class=p>(</span><span class=n>socket</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>socket</span><span class=p>.</span><span class=na>getoutputstream</span><span class=p>().</span><span class=na>write</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span><span class=w> </span><span class=n>off</span><span class=p>:</span><span class=w> </span><span class=n>0</span><span class=p>,</span><span class=n>len</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                	</span><span class=n>e</span><span class=p>.</span><span class=na>printstackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}).</span><span class=na>start</span><span class=p>();</span></span></span></code></pre></td></tr></table></div><div class=code-expand-btn aria-label=展开或折叠代码块 role=button><i class="fa-solid fa-angles-down" aria-hidden=true></i></div></div></div><h6 class=heading-element id=优化版本><span>优化版本：</span>
<a href=#%e4%bc%98%e5%8c%96%e7%89%88%e6%9c%ac class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h6><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-java"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=2 style=--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>String</span><span class=w> </span><span class=n>ADDRESS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;audio.send&#34;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>LocalserverSocket</span><span class=w> </span><span class=n>mLocalServerSocket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=n>Localsocket</span><span class=w> </span><span class=n>msocket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=kt>void</span><span class=w> </span><span class=nf>startRecordsocket</span><span class=p>(</span><span class=n>Socket</span><span class=w> </span><span class=n>socket</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>testplay</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>mRecording</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>bufferSize</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AudioRecord</span><span class=p>.</span><span class=na>getMinBUfferSiZe</span><span class=p>(</span><span class=n>SAMPLE</span><span class=w> </span><span class=n>RATE</span><span class=p>,</span><span class=n>CHANNEL</span><span class=p>,</span><span class=n>AUDIO</span><span class=w> </span><span class=n>FORMAT</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>audioRecord</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>NeW</span><span class=w> </span><span class=nf>AUdIOReCOrd</span><span class=p>(</span><span class=n>AUDIO</span><span class=w> </span><span class=n>SOURCE</span><span class=p>,</span><span class=n>SAMPLE</span><span class=w> </span><span class=n>RATE</span><span class=p>,</span><span class=w> </span><span class=n>CHANNEL</span><span class=p>,</span><span class=n>AUDIO</span><span class=w> </span><span class=n>FORMAT</span><span class=p>,</span><span class=n>buffersize</span><span class=p>);</span><span class=n>audioRecord</span><span class=p>.</span><span class=na>startRecording</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(((</span><span class=n>Runnable</span><span class=p>)()</span><span class=err>→</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>        
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=p>(</span><span class=n>mLocalserverSocket</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mLocalserverSocket</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mLocalserverSocket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=p>(</span><span class=n>mSocket</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=n>mSocket</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=n>mLocalserverSocket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>LocalServerSocket</span><span class=p>(</span><span class=n>ADDRESS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mSocket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mLocalserverSocket</span><span class=p>.</span><span class=na>accept</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//组塞式读取数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>while</span><span class=p>(</span><span class=n>mRecording</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[</span><span class=n>1024</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>4</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=kt>int</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>len</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=na>length</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=c1>//获取数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>len</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mSocket</span><span class=p>.</span><span class=na>getInputstream</span><span class=p>().</span><span class=na>read</span><span class=p>(</span><span class=n>data</span><span class=p>,</span><span class=n>len</span><span class=p>,</span><span class=w> </span><span class=n>len</span><span class=p>:</span><span class=w> </span><span class=n>data</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=n>len</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>if</span><span class=p>(</span><span class=n>len</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=k>if</span><span class=p>(</span><span class=n>socket</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=c1>//将获取的数据发送到客户端</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                                </span><span class=n>socket</span><span class=p>.</span><span class=na>getOutputStream</span><span class=p>().</span><span class=na>write</span><span class=p>(</span><span class=n>data</span><span class=p>,</span><span class=n>off</span><span class=p>:</span><span class=n>0</span><span class=p>,</span><span class=n>len</span><span class=w> </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>          
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>				</span><span class=n>e</span><span class=p>.</span><span class=na>printstackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=p>).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div><div class=code-expand-btn aria-label=展开或折叠代码块 role=button><i class="fa-solid fa-angles-down" aria-hidden=true></i></div></div></div><p>av/services/audioflinger/THreads.cpp</p><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-java"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=2 style=--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>int</span><span class=w> </span><span class=n>connect_fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=err>#</span><span class=n>define</span><span class=w>  </span><span class=n>ADDRESS</span><span class=w>  </span><span class=s>&#34;audio.send&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=n>sizz_t</span><span class=w> </span><span class=n>AudioFLinger</span><span class=p>::</span><span class=n>PlaybackThread</span><span class=p>::</span><span class=n>threadLoop_write</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=n>sszie_t</span><span class=w> </span><span class=n>frameWritten</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mNormalSink</span><span class=o>-</span><span class=n>write</span><span class=w> </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//add begin </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//include &lt;sys/socket.h&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//include &lt;sys/un.h&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//需要区分 REMOTE_SUBMIX     </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>// isSingleDeviceTyep(outDevices,AUDIO_DEVICE_OUT_REMOTE_SUBMIX)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=n>connect_fd</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>connect_fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SOCket</span><span class=p>(</span><span class=n>AF</span><span class=w> </span><span class=n>UNIX</span><span class=p>,</span><span class=n>SOCK</span><span class=w> </span><span class=n>STREAM</span><span class=p>,</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>connect</span><span class=w> </span><span class=n>fd</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>ALoGI</span><span class=p>(</span><span class=s>&#34;init socket fail&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=k>return</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	 </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sockaddr_un</span><span class=w> </span><span class=n>srv_addr</span><span class=p>{};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>memset</span><span class=p>(</span><span class=o>&amp;</span><span class=n>srv</span><span class=w> </span><span class=n>addr</span><span class=p>,</span><span class=n>0</span><span class=p>,</span><span class=n>sizeof</span><span class=p>(</span><span class=n>srv</span><span class=w> </span><span class=n>addr</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>srv_ddr</span><span class=p>.</span><span class=na>sun_path</span><span class=o>[</span><span class=n>0</span><span class=o>]=</span><span class=sc>&#39;\0&#39;</span><span class=p>;</span><span class=w> </span><span class=c1>//注意</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>strcpy</span><span class=p>(</span><span class=n>srv_addr</span><span class=p>.</span><span class=na>sun_path</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>ADDRESS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>srv_addr</span><span class=p>.</span><span class=na>sun_family</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AF_UNIX</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>nameLen</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>strlen</span><span class=p>(</span><span class=n>ADDRESS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=o>=</span><span class=n>1</span><span class=o>+</span><span class=w> </span><span class=n>nameLen</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>offsetof</span><span class=p>(</span><span class=n>struct</span><span class=w> </span><span class=n>sockaddr_un</span><span class=p>,</span><span class=w> </span><span class=n>sun_path</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>connect</span><span class=p>(</span><span class=n>connect_fd</span><span class=p>,(</span><span class=n>struct</span><span class=w> </span><span class=n>sockaddr</span><span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>srv</span><span class=w> </span><span class=n>addr</span><span class=p>,</span><span class=w> </span><span class=n>len</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=k>if</span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>ALOGI</span><span class=p>(</span><span class=s>&#34;connect socket fail:%d&#34;</span><span class=p>,</span><span class=n>ret</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=n>connect</span><span class=w> </span><span class=n>fd</span><span class=o>=-</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AL0GI</span><span class=p>(</span><span class=s>&#34;connect success,start thread&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=k>else</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>framesWritten</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>result</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>::</span><span class=n>send</span><span class=p>(</span><span class=n>connect_fd</span><span class=p>,(</span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=p>)</span><span class=n>mSinkBuffer</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>offset</span><span class=p>,</span><span class=n>framesWriiten</span><span class=o>*</span><span class=n>mFrameSize</span><span class=p>,</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>result</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>::</span><span class=n>close</span><span class=p>(</span><span class=n>connect_fd</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>connect_fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ALOGI</span><span class=p>(</span><span class=s>&#34;debug this &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=c1>//add end</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=k>if</span><span class=p>(</span><span class=n>frameWritten</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span></span></span></code></pre></td></tr></table></div><div class=code-expand-btn aria-label=展开或折叠代码块 role=button><i class="fa-solid fa-angles-down" aria-hidden=true></i></div></div></div><p><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2024/09/13/66e40d3fd8909.png title=1726221633561.png data-thumbnail=https://picgo.myjojo.fun:666/i/2024/09/13/66e40d3fd8909.png data-sub-html="<h2>1726221633561.png</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2024/09/13/66e40d3fd8909.png alt=1726221633561.png></a></p><h5 class=heading-element id=客户端><span>客户端</span>
<a href=#%e5%ae%a2%e6%88%b7%e7%ab%af class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2024/09/13/66e410d434a2a.png title=1726222556642.png data-thumbnail=https://picgo.myjojo.fun:666/i/2024/09/13/66e410d434a2a.png data-sub-html="<h2>1726222556642.png</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2024/09/13/66e410d434a2a.png alt=1726222556642.png></a></p><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-java"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=2 style=--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>void</span><span class=w> </span><span class=nf>receiveData</span><span class=p>(</span><span class=kd>final</span><span class=w> </span><span class=n>socket</span><span class=w> </span><span class=n>socket</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>socket</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>buf</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>byte</span><span class=o>[</span><span class=n>buffersize</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>new</span><span class=w> </span><span class=n>Thread</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Runnable</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nd>@override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>       		</span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>run</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>while</span><span class=p>(</span><span class=n>mRunning</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>int</span><span class=w> </span><span class=n>len</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>socket</span><span class=p>.</span><span class=na>getInputstream</span><span class=p>().</span><span class=na>read</span><span class=p>(</span><span class=n>buf</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>playAudio</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=n>len</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>e</span><span class=p>.</span><span class=na>printstackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}).</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                
</span></span></span><span class=line><span class=cl><span class=kt>void</span><span class=w> </span><span class=nf>playAudio</span><span class=p>(</span><span class=kt>byte</span><span class=o>[]</span><span class=w> </span><span class=n>data</span><span class=p>,</span><span class=kt>int</span><span class=w> </span><span class=n>len</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=n>mAudioTrack</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mAudioTrack</span><span class=p>.</span><span class=na>play</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mAudioTrack</span><span class=p>.</span><span class=na>writ</span><span class=p>(</span><span class=n>data</span><span class=p>,</span><span class=n>offset</span><span class=p>:</span><span class=n>0</span><span class=p>,</span><span class=n>len</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div><div class=code-expand-btn aria-label=展开或折叠代码块 role=button><i class="fa-solid fa-angles-down" aria-hidden=true></i></div></div></div><h4 class=heading-element id=bytebuffer-介绍><span>ByteBuffer 介绍</span>
<a href=#bytebuffer-%e4%bb%8b%e7%bb%8d class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2024/09/12/66e2b4386866a.jpg title=1726133220888.jpg data-thumbnail=https://picgo.myjojo.fun:666/i/2024/09/12/66e2b4386866a.jpg data-sub-html="<h2>1726133220888.jpg</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2024/09/12/66e2b4386866a.jpg alt=1726133220888.jpg></a><br><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2024/09/12/66e2b439ec372.jpg title=1726133235968.jpg data-thumbnail=https://picgo.myjojo.fun:666/i/2024/09/12/66e2b439ec372.jpg data-sub-html="<h2>1726133235968.jpg</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2024/09/12/66e2b439ec372.jpg alt=1726133235968.jpg></a><br><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2024/09/12/66e2b43b2f618.jpg title=1726133244889.jpg data-thumbnail=https://picgo.myjojo.fun:666/i/2024/09/12/66e2b43b2f618.jpg data-sub-html="<h2>1726133244889.jpg</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2024/09/12/66e2b43b2f618.jpg alt=1726133244889.jpg></a><br><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2024/09/12/66e2b43cb6ab0.jpg title=1726133272357.jpg data-thumbnail=https://picgo.myjojo.fun:666/i/2024/09/12/66e2b43cb6ab0.jpg data-sub-html="<h2>1726133272357.jpg</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2024/09/12/66e2b43cb6ab0.jpg alt=1726133272357.jpg></a><br><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2024/09/12/66e2b444386ac.jpg title=1726133287900.jpg data-thumbnail=https://picgo.myjojo.fun:666/i/2024/09/12/66e2b444386ac.jpg data-sub-html="<h2>1726133287900.jpg</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2024/09/12/66e2b444386ac.jpg alt=1726133287900.jpg></a></p><h4 class=heading-element id=功能再优化><span>功能再优化</span>
<a href=#%e5%8a%9f%e8%83%bd%e5%86%8d%e4%bc%98%e5%8c%96 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><h5 class=heading-element id=视频延时测试验证><span>视频延时测试验证</span>
<a href=#%e8%a7%86%e9%a2%91%e5%bb%b6%e6%97%b6%e6%b5%8b%e8%af%95%e9%aa%8c%e8%af%81 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2024/09/13/66e3e66039007.jpg title=1726211690491.jpg data-thumbnail=https://picgo.myjojo.fun:666/i/2024/09/13/66e3e66039007.jpg data-sub-html="<h2>1726211690491.jpg</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2024/09/13/66e3e66039007.jpg alt=1726211690491.jpg></a></p><h5 class=heading-element id=悬浮窗口><span>悬浮窗口</span>
<a href=#%e6%82%ac%e6%b5%ae%e7%aa%97%e5%8f%a3 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><div class="code-block highlight" data-mode=classic data-copyable=true><div class=chroma><div class="code-header language-java"><span class=code-title><i class="arrow fa-solid fa-chevron-down fa-fw" aria-hidden=true></i></span><span class=ellipses-btn aria-label="Show more options" role=button><i class="fa-solid fa-ellipsis-h fa-fw" aria-hidden=true></i></span><span class=line-nos-btn aria-label=切换行号 role=button title=切换行号><i class="fa-solid fa-list-ol fa-fw" aria-hidden=true></i></span><span class=line-wrap-btn aria-label=切换自动换行 role=button title=切换自动换行><i class="fa-solid fa-right-left fa-fw" aria-hidden=true></i></span><span class=copy-btn aria-label=复制到剪贴板 role=button title=复制到剪贴板><i class="fa-regular fa-clone fa-fw" aria-hidden=true></i></span></div><div class=code-wrapper data-max=10 data-line-digit=2 style=--fi-max-shown-lines:10;--fi-line-digit:2;--fi-line-start:1><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w> </span><span class=n>SytemTimeDialog</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=nf>SystemTimeDialog</span><span class=p>(</span><span class=n>Contextcontext</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>mContext</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>context</span><span class=p>;</span><span class=c1>// 取得系统窗体</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>mWindowManager</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>WindowManager</span><span class=p>)</span><span class=n>context</span><span class=p>.</span><span class=na>getSystemservice</span><span class=p>(</span><span class=n>ConteXt</span><span class=p>.</span><span class=na>WINDOW</span><span class=w> </span><span class=n>SERVICE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 窗体的布局样式</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mLayoutParams</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParams</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mLayoutParams</span><span class=p>.</span><span class=na>setTitle</span><span class=p>(</span><span class=s>&#34;TimeShow&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//设置窗体显示类型-TYPE APPLICATION OVERLAY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mLayoutparams</span><span class=p>.</span><span class=na>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Windowanager</span><span class=p>.</span><span class=na>LayoutParamS</span><span class=p>.</span><span class=na>TYPE_APPLICATION_OVERLAY</span><span class=p>;</span><span class=c1>//2018; //windowManager.LayoutParams.TYPE POINTER;mLayoutParams.flags = windowanager.LayoutParamS.FLAG NOT TOUCH MODAL| WindowManager.LayoutParaMS.FLAG NOT FOCUSABLE;mLayoutParams.width = WindowManager.LayoutParamS.WRAP CONTENT;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mLayoutParams</span><span class=p>.</span><span class=na>height</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>WindowManager</span><span class=p>.</span><span class=na>LayoutParamS</span><span class=p>.</span><span class=na>WRAP_CONTENT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mLayoutParams</span><span class=p>.</span><span class=na>gravity</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Gravity</span><span class=p>.</span><span class=na>LEFT</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>Gravity</span><span class=p>.</span><span class=na>TOP</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//mLayoutParams.privateFlags = mLayoutParams.priVateFLagS | PRIVATE FLAG SYSTEM APPLICATION OVERLAY;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>timeTextView</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>TextView</span><span class=p>(</span><span class=n>mContext</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>timeTextView</span><span class=p>.</span><span class=na>setTextColor</span><span class=p>(</span><span class=n>Color</span><span class=p>.</span><span class=na>RED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>timeTextView</span><span class=p>.</span><span class=na>setTextsize</span><span class=p>(</span><span class=n>20</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>timeTextView</span><span class=p>.</span><span class=na>setText</span><span class=p>(</span><span class=s>&#34;HelloWorld&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>timeTextView</span><span class=p>.</span><span class=na>setOnTouchListener</span><span class=p>(</span><span class=n>onTouchDrawListener</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=c1>//更新拖拽</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>mWindowManager</span><span class=p>.</span><span class=na>updateViewLayout</span><span class=p>(</span><span class=n>v</span><span class=p>.</span><span class=na>mLayoutParams</span><span class=p>);</span><span class=w>   
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>     
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=c1>//更新显示毫秒的悬浮窗    </span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>show</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=n>ValueAnimator</span><span class=w> </span><span class=n>animator</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ValueAnimator</span><span class=p>.</span><span class=na>ofInt</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=n>100</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>animator</span><span class=p>.</span><span class=na>addUpdateListener</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>ValueAnimator</span><span class=p>.</span><span class=na>AnimatorUpdateListener</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nd>@0verride</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onAnimationUpdate</span><span class=p>(</span><span class=n>ValueAnimator</span><span class=w> </span><span class=n>animation</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>long</span><span class=w> </span><span class=n>time</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        	</span><span class=n>SimpleDateFormat</span><span class=w> </span><span class=n>simpleDateFormat</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SimpleDateFormat</span><span class=p>(</span><span class=w> </span><span class=n>pattern</span><span class=p>:</span><span class=w> </span><span class=s>&#34;HH:mm:ss :SSS&#34;</span><span class=w> </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>showTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>simpleDateFormat</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=n>time</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>timeTextView</span><span class=p>.</span><span class=na>setText</span><span class=p>(</span><span class=n>showTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        	</span><span class=n>timeTextView</span><span class=p>.</span><span class=na>setBackgroundcolor</span><span class=p>(</span><span class=n>Color</span><span class=p>.</span><span class=na>BLACK</span><span class=p>)</span><span class=o>|</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>});</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>animator</span><span class=p>.</span><span class=na>setDuration</span><span class=p>(</span><span class=n>2000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>animator</span><span class=p>.</span><span class=na>setRepeatCount</span><span class=p>(</span><span class=o>-</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>animator</span><span class=p>.</span><span class=na>start</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> 	</span><span class=n>mWindowManager</span><span class=p>.</span><span class=na>addView</span><span class=p>(</span><span class=n>timeTextView</span><span class=p>,</span><span class=n>mLayoutParams</span><span class=p>);</span><span class=w>       
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=p>}</span><span class=w>       </span></span></span></code></pre></td></tr></table></div><div class=code-expand-btn aria-label=展开或折叠代码块 role=button><i class="fa-solid fa-angles-down" aria-hidden=true></i></div></div></div><h5 class=heading-element id=音频延迟测试方案><span>音频延迟测试方案</span>
<a href=#%e9%9f%b3%e9%a2%91%e5%bb%b6%e8%bf%9f%e6%b5%8b%e8%af%95%e6%96%b9%e6%a1%88 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><p>source 端和 sink端 同时发声，再录音，分析波峰的间隔时间。</p><p>内录的方案改造成播放声音。</p><p>audiopolicy/enginedefault/src/Engine.cpp</p><p><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2024/09/13/66e3f65b885d3.png title=1726215782660.png data-thumbnail=https://picgo.myjojo.fun:666/i/2024/09/13/66e3f65b885d3.png data-sub-html="<h2>1726215782660.png</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2024/09/13/66e3f65b885d3.png alt=1726215782660.png></a></p><p>选择合适的音源播放，比如拨号。声音大小要有区分</p><p>录制投屏的声音文件。</p><p>通过 audacity软件 进行mp3波形分析</p><p><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2024/09/13/66e3f79a703d6.png title=1726216100637.png data-thumbnail=https://picgo.myjojo.fun:666/i/2024/09/13/66e3f79a703d6.png data-sub-html="<h2>1726216100637.png</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2024/09/13/66e3f79a703d6.png alt=1726216100637.png></a></p><p>竞品的数据如何采集</p><p>adb shell dumpsys meida_audio_flinger > 1.txt</p><p>查看 standby 为 no，查看发声output devices</p><h5 class=heading-element id=优化方案><span>优化方案</span>
<a href=#%e4%bc%98%e5%8c%96%e6%96%b9%e6%a1%88 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h5><h6 class=heading-element id=视频方面><span>视频方面</span>
<a href=#%e8%a7%86%e9%a2%91%e6%96%b9%e9%9d%a2 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h6><ol><li><p>尽量多线程，数据生产，解码，渲染单独运行</p><p><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2024/09/13/66e3ec2c29a35.jpg title=1726213175003.jpg data-thumbnail=https://picgo.myjojo.fun:666/i/2024/09/13/66e3ec2c29a35.jpg data-sub-html="<h2>1726213175003.jpg</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2024/09/13/66e3ec2c29a35.jpg alt=1726213175003.jpg></a></p></li><li><p>多线程 生产者的数据集合需要进行统计集合大小。在卡顿的时候，可以方便定位。</p></li><li><p>a. 更加体验和硬件性能选择 码率和分辨率。</p><p>b. 根据生产者消费者模型，定位挤压数据位置。 针对瓶颈考虑丢帧。比如网络卡顿，突然来了很多帧，可以考虑跳过数据</p><p>c. 如果是软解码，如使用ffmpeg等，可以考虑多线程解码</p></li></ol><h6 class=heading-element id=音频方面><span>音频方面</span>
<a href=#%e9%9f%b3%e9%a2%91%e6%96%b9%e9%9d%a2 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h6><p>AudioRecord 自带100ms延时</p><p><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2024/09/13/66e3fc9ef3a85.png title=1726217384446.png data-thumbnail=https://picgo.myjojo.fun:666/i/2024/09/13/66e3fc9ef3a85.png data-sub-html="<h2>1726217384446.png</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2024/09/13/66e3fc9ef3a85.png alt=1726217384446.png></a></p><ol><li><p>在 AudioTrack 中拦截，直接发送出去</p><p>优点：速度快</p><p>缺点 ： AudioTrack 有多数据源的写入。数据源参数采样率声道等都不一样</p><p>复杂度比较高</p></li><li><p>在AudioFlinger 中进行拦截，不走 AudioRecord</p></li></ol><p><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2024/09/13/66e3febfdf986.png title=1726217928099.png data-thumbnail=https://picgo.myjojo.fun:666/i/2024/09/13/66e3febfdf986.png data-sub-html="<h2>1726217928099.png</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2024/09/13/66e3febfdf986.png alt=1726217928099.png></a></p><p><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2024/09/13/66e3fffcaa011.png title=1726218239318.png data-thumbnail=https://picgo.myjojo.fun:666/i/2024/09/13/66e3fffcaa011.png data-sub-html="<h2>1726218239318.png</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2024/09/13/66e3fffcaa011.png alt=1726218239318.png></a></p><p><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2024/09/13/66e400bd11019.png title=1726218375306.png data-thumbnail=https://picgo.myjojo.fun:666/i/2024/09/13/66e400bd11019.png data-sub-html="<h2>1726218375306.png</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2024/09/13/66e400bd11019.png alt=1726218375306.png></a></p><p><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2024/09/13/66e400be62d59.png title=1726218413560.png data-thumbnail=https://picgo.myjojo.fun:666/i/2024/09/13/66e400be62d59.png data-sub-html="<h2>1726218413560.png</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2024/09/13/66e400be62d59.png alt=1726218413560.png></a></p><p><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2024/09/13/66e4014717ed0.png title=1726218576997.png data-thumbnail=https://picgo.myjojo.fun:666/i/2024/09/13/66e4014717ed0.png data-sub-html="<h2>1726218576997.png</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2024/09/13/66e4014717ed0.png alt=1726218576997.png></a><br><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2024/09/13/66e401891a286.png title=1726218638822.png data-thumbnail=https://picgo.myjojo.fun:666/i/2024/09/13/66e401891a286.png data-sub-html="<h2>1726218638822.png</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2024/09/13/66e401891a286.png alt=1726218638822.png></a></p><p>还需要保持REMOTE_SUB_MIX，让OutputThread 合成一个音轨。</p><p><a class=lightgallery target=_blank href=https://picgo.myjojo.fun:666/i/2024/09/13/66e402e283826.png title=1726218976299.png data-thumbnail=https://picgo.myjojo.fun:666/i/2024/09/13/66e402e283826.png data-sub-html="<h2>1726218976299.png</h2>"><img loading=lazy src=https://picgo.myjojo.fun:666/i/2024/09/13/66e402e283826.png alt=1726218976299.png></a></p><h4 class=heading-element id=强制桌面模式><span>强制桌面模式</span>
<a href=#%e5%bc%ba%e5%88%b6%e6%a1%8c%e9%9d%a2%e6%a8%a1%e5%bc%8f class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>可以强制异显屏幕显示出桌面</p><p>-&ndash;end&ndash;</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2024-11-05 01:34:06">更新于 2024-11-05&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://huang8604.github.io/posts/%E6%8A%95%E5%B1%8F%E8%AE%B0%E5%BD%95/ data-title=投屏记录><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/blog/ class=post-tag title="标签 - Blog">Blog</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/%E7%BD%91%E7%BB%9C%E5%8D%9A%E5%AE%A2%E9%85%8D%E7%BD%AE%E6%96%B9%E6%A1%88/ class=post-nav-item rel=prev title=网络博客配置方案><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>网络博客配置方案</a><a href=/posts/%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/ class=post-nav-item rel=next title=启动流程分析>启动流程分析<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div class=post-reward><div class=comment></div><input type=checkbox class=reward-input name=reward id=fi-reward hidden>
<label class=reward-button for=fi-reward><i class="fa-solid fa-qrcode fa-fw" aria-hidden=true></i>赞赏</label><div class=reward-ways data-mode=static></div></div><div id=comments><div id=giscus class=comment><script src=https://giscus.app/client.js data-repo=huang8604/huang8604.github.io data-repo-id=R_kgDOMx3bEg data-category=Announcements data-category-id=DIC_kwDOMx3bEs4CigIp data-mapping=pathname data-strict=0 data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-loading=lazy crossorigin=anonymous async defer></script></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></article><aside class=toc id=toc-auto aria-label=目录><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside><dialog id=toc-dialog aria-labelledby=toc-dialog-title role=dialog><div class=toc><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-drawer><nav><ul><li><ul><li><ul><li><a href=#录屏传输>录屏传输</a><ul><li><a href=#录屏方法>录屏方法</a><ul><li><a href=#1-创建虚拟屏幕把内容绘制到屏幕绑定的-surface-中>1 创建虚拟屏幕，把内容绘制到屏幕绑定的 surface 中</a></li><li><a href=#2-surface-由-mediacodec-创建>2 surface 由 mediacodec 创建</a></li><li><a href=#3-把-surface-内容输入到-mediacodec然后编码>3 把 surface 内容输入到 MediaCodec，然后编码</a></li></ul></li><li><a href=#录屏保存为文件>录屏保存为文件</a></li><li><a href=#录屏数据编码传输>录屏数据编码传输</a></li><li><a href=#录屏数据解码显示>录屏数据解码显示</a></li></ul></li><li><a href=#投屏相关>投屏相关</a><ul><li><a href=#同显模式-mirror>同显模式 mirror</a></li><li><a href=#异显模式-own_content>异显模式 OWN_CONTENT</a></li><li><a href=#不同尺寸的投屏>不同尺寸的投屏</a></li></ul></li><li><a href=#异屏幕启动方式>异屏幕启动方式</a><ul><li><a href=#一-dialog>一 Dialog</a></li><li><a href=#二>二</a></li><li><a href=#三-activity>三 Activity</a></li></ul></li><li><a href=#触摸部分>触摸部分</a><ul><li><a href=#触摸事件注入>触摸事件注入</a></li></ul></li><li><a href=#音频部分>音频部分</a><ul><li><a href=#服务端>服务端</a><ul><li><a href=#audirecord-版本>AudiRecord 版本</a></li><li><a href=#优化版本>优化版本：</a></li></ul></li><li><a href=#客户端>客户端</a></li></ul></li><li><a href=#bytebuffer-介绍>ByteBuffer 介绍</a></li><li><a href=#功能再优化>功能再优化</a><ul><li><a href=#视频延时测试验证>视频延时测试验证</a></li><li><a href=#悬浮窗口>悬浮窗口</a></li><li><a href=#音频延迟测试方案>音频延迟测试方案</a></li><li><a href=#优化方案>优化方案</a><ul><li><a href=#视频方面>视频方面</a></li><li><a href=#音频方面>音频方面</a></li></ul></li></ul></li><li><a href=#强制桌面模式>强制桌面模式</a></li></ul></li></ul></li></ul></nav></div></div></dialog></main><footer class=footer><div class=footer-container><div class="footer-line powered">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.154.4"><img class=hugo-icon src=/images/hugo.min.svg alt="Hugo logo"> Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.4.1"><img class=fixit-icon src=/images/fixit.min.svg alt="FixIt logo"> FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2021 - 2026</span><span class=author itemprop=copyrightHolder>
<a href=https://github.com/huang8604 target=_blank rel="external nofollow noopener noreferrer">wentao</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></span></div></div></footer></div><div class=widgets><div class=fixed-buttons><div class="fixed-button back-to-top animate__faster d-none" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i></div><div id=toc-drawer-button class="fixed-button toc-drawer-button d-none" role=button aria-label=目录><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></div><div class="fixed-button view-comments d-none" role=button aria-label=查看评论><i class="fa-solid fa-comment fa-fw" aria-hidden=true></i></div></div><div id=mask></div><noscript><div class=noscript-warning>该网站在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/fuse/fuse.min.js defer></script><script src=/lib/instant-page/instantpage.min.js async defer type=module></script><script src=/lib/lightgallery/lightgallery.min.js defer></script><script src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js defer></script><script src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script src=/js/config/f10dafb2670f32a9a071262614817d35.js defer></script><script src=/js/theme.min.js defer></script><script src=/js/custom.min.js defer></script></body></html>