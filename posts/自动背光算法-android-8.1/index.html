<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>自动背光算法-Android 8.1 - 文韬的文档</title><meta name=author content="wentao"><meta name=description content="本文基于工作中自动背光笔记扩充了下，记录下自动背光算法。
基于Android 8.1, 代码可参看 http://androidxref.com/8.1.0_&mldr;
Android 9加入了所谓的机器学习算法，根据用户调节时亮度和光感重新生成曲线，
自动背光时的滑动条不再是调节adjustment值，暂时不想写了。。。
Android 10简单看了下，加入了对foreground应用的微调支持，暂时不想写了。。。
"><meta name=keywords content='clippings,转载,blog'><meta itemprop=name content="自动背光算法-Android 8.1"><meta itemprop=description content="本文基于工作中自动背光笔记扩充了下，记录下自动背光算法。
基于Android 8.1, 代码可参看 http://androidxref.com/8.1.0_…
Android 9加入了所谓的机器学习算法，根据用户调节时亮度和光感重新生成曲线，
自动背光时的滑动条不再是调节adjustment值，暂时不想写了。。。
Android 10简单看了下，加入了对foreground应用的微调支持，暂时不想写了。。。"><meta itemprop=datePublished content="2025-08-21T07:29:37+00:00"><meta itemprop=dateModified content="2025-10-23T08:23:27+00:00"><meta itemprop=wordCount content="7042"><meta itemprop=keywords content="Clippings,转载,Blog"><meta property="og:url" content="https://huang8604.github.io/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/"><meta property="og:site_name" content="文韬的文档"><meta property="og:title" content="自动背光算法-Android 8.1"><meta property="og:description" content="本文基于工作中自动背光笔记扩充了下，记录下自动背光算法。
基于Android 8.1, 代码可参看 http://androidxref.com/8.1.0_…
Android 9加入了所谓的机器学习算法，根据用户调节时亮度和光感重新生成曲线，
自动背光时的滑动条不再是调节adjustment值，暂时不想写了。。。
Android 10简单看了下，加入了对foreground应用的微调支持，暂时不想写了。。。"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-08-21T07:29:37+00:00"><meta property="article:modified_time" content="2025-10-23T08:23:27+00:00"><meta property="article:tag" content="Clippings"><meta property="article:tag" content="转载"><meta property="article:tag" content="Blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="自动背光算法-Android 8.1"><meta name=twitter:description content="本文基于工作中自动背光笔记扩充了下，记录下自动背光算法。
基于Android 8.1, 代码可参看 http://androidxref.com/8.1.0_…
Android 9加入了所谓的机器学习算法，根据用户调节时亮度和光感重新生成曲线，
自动背光时的滑动条不再是调节adjustment值，暂时不想写了。。。
Android 10简单看了下，加入了对foreground应用的微调支持，暂时不想写了。。。"><meta name=application-name content="文涛的记录"><meta name=apple-mobile-web-app-title content="文涛的记录"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical type=text/html href=https://huang8604.github.io/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/ title="自动背光算法-Android 8.1 - 文韬的文档"><link rel=prev type=text/html href=https://huang8604.github.io/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/ title=开发中常用到的一些调试命令><link rel=next type=text/html href=https://huang8604.github.io/posts/%E6%80%BB%E7%BB%93-%E5%88%A4%E6%96%ADuwb%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E9%97%AE%E9%A2%98/ title="总结  判断uwb服务启动问题"><link rel=alternate type=text/markdown href=https://huang8604.github.io/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/index.md title="自动背光算法-Android 8.1 - 文韬的文档"><link rel=stylesheet href=/css/style.min.css><link rel=preload href=/lib/fontawesome-free/all.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload href=/lib/animate/animate.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"自动背光算法-Android 8.1","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/huang8604.github.io\/posts\/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1\/"},"genre":"posts","keywords":"clippings, 转载, blog","wordcount":7042,"url":"https:\/\/huang8604.github.io\/posts\/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1\/","datePublished":"2025-08-21T07:29:37+00:00","dateModified":"2025-10-23T08:23:27+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"wentao"},"description":""}</script><script src=/js/head/color-scheme.min.js></script></head><body data-header-desktop=sticky data-header-mobile=auto><div class=wrapper data-page-style=wide><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title=文韬的文档><img class=logo src=/images/doc.jpg alt=文韬的文档 height=32 width=32><span class=header-title-text>文韬的文档</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/archives/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 归档</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/collections/><i class="fa-solid fa-group fa-fw fa-sm" aria-hidden=true></i> 合集</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容…… id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=文韬的文档><img class=logo src=/images/doc.jpg alt=文韬的文档 height=26 width=26><span class=header-title-text>文韬的文档</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容…… id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><a class=menu-link href=/archives/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 归档</a></li><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li><li class=menu-item><a class=menu-link href=/collections/><i class="fa-solid fa-group fa-fw fa-sm" aria-hidden=true></i> 合集</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=container><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label=合集></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>自动背光算法-Android 8.1</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/huang8604 title=作者 target=_blank rel="external nofollow noopener noreferrer author" class=author><img class=avatar src='https://www.gravatar.com/avatar/b89538cdbc35c279ce1df9f3435f42a1?s=32&d=' alt=wentao height=16 width=16>&nbsp;wentao</a></span><span class=post-included-in>&nbsp;收录于 <a href=/collections/%E5%9B%BE%E5%BD%A2%E6%98%BE%E7%A4%BA/ class=post-collection title="合集 - 图形显示"><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i> 图形显示</a></span></div><div class=post-meta-line><span title="发布于 2025-08-21 07:29:37"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden=true></i><time datetime=2025-08-21>2025-08-21</time></span>&nbsp;<span title="更新于 2025-10-23 08:23:27"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden=true></i><time datetime=2025-10-23>2025-10-23</time></span>&nbsp;<span title="7042 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 7100 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 15 分钟</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#一简单说说>一、简单说说</a><ul><li><a href=#1-建曲线>1. 建曲线</a></li><li><a href=#2-采样去抖>2. 采样去抖</a></li><li><a href=#3-计算亮度>3. 计算亮度</a></li></ul></li><li><a href=#二说点代码>二、说点代码</a><ul><li><a href=#1-建曲线配置>1. 建曲线配置</a></li><li><a href=#2-曲线初始化>2. 曲线初始化</a></li><li><a href=#3-采样去抖>3. 采样去抖</a><ul><li><a href=#31-采样>3.1 采样</a></li><li><a href=#31-防抖>3.1 防抖</a></li></ul></li><li><a href=#4-更新亮度-updateautobrightness>4. 更新亮度 updateAutoBrightness()</a></li><li><a href=#5-用户微调>5. 用户微调</a></li><li><a href=#6-总结>6. 总结:</a></li></ul></li><li><a href=#三一些调试命令>三、一些调试命令</a></li></ul></nav></div></div><div class=content id=content><p>本文基于工作中自动背光笔记扩充了下，记录下自动背光算法。<br>基于Android 8.1, 代码可参看 <a href="https://link.segmentfault.com/?enc=S%2FVnvVcbfiJWLu1xPNnWoQ%3D%3D.L2VvVVv78YDcKnviPVlOdjS3H7uSKqzygibjxQLrLdLb%2BAreqZCsVQ2EcdiTwPlq" target=_blank rel="external nofollow noopener noreferrer">http://androidxref.com/8.1.0_&mldr;</a><br>Android 9加入了所谓的机器学习算法，根据用户调节时亮度和光感重新生成曲线，<br>自动背光时的滑动条不再是调节adjustment值，暂时不想写了。。。<br>Android 10简单看了下，加入了对foreground应用的微调支持，暂时不想写了。。。</p><h2 class=heading-element id=一简单说说><span>一、简单说说</span>
<a href=#%e4%b8%80%e7%ae%80%e5%8d%95%e8%af%b4%e8%af%b4 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>简单的说，其实背光调节就三大步，建曲线，采样去抖，计算亮度</p><h3 class=heading-element id=1-建曲线><span>1. 建曲线</span>
<a href=#1-%e5%bb%ba%e6%9b%b2%e7%ba%bf class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Brightness
</span></span><span class=line><span class=cl> 1 ^
</span></span><span class=line><span class=cl>   |
</span></span><span class=line><span class=cl>   |
</span></span><span class=line><span class=cl>   |             。
</span></span><span class=line><span class=cl>   |            。
</span></span><span class=line><span class=cl>   |           。
</span></span><span class=line><span class=cl>   +       。
</span></span><span class=line><span class=cl>min+   。
</span></span><span class=line><span class=cl>   |
</span></span><span class=line><span class=cl>   0---+---+-------------------&gt; lux 
</span></span><span class=line><span class=cl>          min</span></span></code></pre></td></tr></table></div></div><p>建曲线这个其实就是建立一个lux对应的brightness的曲线，这样就可以根据光感传来的lux值，计算出对应的亮度为多少。<br>（安卓的算法需要Brightness比lux多一个值，所以上图曲线两者的min值不对应。另外需要严格单调递增，组数看需要，上图只是个示意）</p><h3 class=heading-element id=2-采样去抖><span>2. 采样去抖</span>
<a href=#2-%e9%87%87%e6%a0%b7%e5%8e%bb%e6%8a%96 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>这个就是采集一段时间内的lux值，然后根据这段时间的lux,算出这段时间的lux值。<br>当然考虑到抖动(如有闪电等突然变化很大，然后又恢复的情况;或者周期性的明暗明暗变化等情况），所以需要去抖，<br>默认安卓是要求光照稳定在0.8~1.1倍之间，并且持续一段时间（由暗到亮是4秒，由亮到暗是8s）</p><h3 class=heading-element id=3-计算亮度><span>3. 计算亮度</span>
<a href=#3-%e8%ae%a1%e7%ae%97%e4%ba%ae%e5%ba%a6 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>安卓的算法流程<br>1). 开自动背光时，下拉通知条为一系数，假设为x,其区间为[-1.0, 1.0], 应用层为除以1024,浮点精度</p><p>2). 计算背光时，先计算出lux对应的亮度，假设为y,其区间为[0.0, 1.0], 考虑为用户会微调，所以然后再处理用户微调(1中的x)</p><p>3). 最终计算屏幕亮度z向下取整</p><p>4). 然后再处理z的极值区间，例如我们设置的11<del>255, 18</del>255</p><p>用公式表示即为</p><p>$$
\mathbf{z = y^{3^{-x}}*255, x\in[-1.0, 1.0], y\in[0.0, 1.0], z\in[min, 255]}
$$</p><p>公式中3表示为gamma3.0,后面是3的-x次方,即$3^{-x}$</p><p>举个例子，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/
</span></span><span class=line><span class=cl>出地库        光照稳定在0.8~1.1倍之间4S   /
</span></span><span class=line><span class=cl>  |         |                       |/
</span></span><span class=line><span class=cl>  +---------+-----------------------+--------------
</span></span><span class=line><span class=cl>10lux   5000lux         开始改变屏幕，假设屏幕亮度从55 -&gt; 255, 
</span></span><span class=line><span class=cl>                        那么亮度调节完需要时间为((255-55)/rampRate)*16.6ms, 约3.3S
</span></span><span class=line><span class=cl>                     (16.6ms是一个vsync时间，rampRate默认为1，可以更改进行速率调节)</span></span></code></pre></td></tr></table></div></div><h2 class=heading-element id=二说点代码><span>二、说点代码</span>
<a href=#%e4%ba%8c%e8%af%b4%e7%82%b9%e4%bb%a3%e7%a0%81 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>代码分析其实基本也是按照前面的三点来说的，</p><h3 class=heading-element id=1-建曲线配置><span>1. 建曲线配置</span>
<a href=#1-%e5%bb%ba%e6%9b%b2%e7%ba%bf%e9%85%8d%e7%bd%ae class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl>frameworks/base/core/res/res/values/config.xml
</span></span><span class=line><span class=cl><span class=nt>&lt;bool</span> <span class=na>name=</span><span class=s>&#34;config_automatic_brightness_available&#34;</span><span class=nt>&gt;</span>false<span class=nt>&lt;/bool&gt;</span> <span class=c>&lt;!-- 自动背光功能是否可用开关 --&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;integer-array</span> <span class=na>name=</span><span class=s>&#34;config_autoBrightnessLevels&#34;</span><span class=nt>&gt;</span> <span class=c>&lt;!-- lux 数组 --&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/integer-array&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;integer-array</span> <span class=na>name=</span><span class=s>&#34;config_autoBrightnessLcdBacklightValues&#34;</span><span class=nt>&gt;</span> <span class=c>&lt;!-- 对应lcd brightness 数组 --&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/integer-array&gt;</span></span></span></code></pre></td></tr></table></div></div><p>曲线的配置为如上面的代码里，默认安卓是没有配置的，需要自己修改或者overlay,<br>另外还有个是否使用自动背光的开关 config_automatic_brightness_available，默认关的，需要打开。<br>代码里都有详细的注释和说明可看看，我这儿就没贴出来了。<br>config_autoBrightnessLevels为lux数组<br>config_autoBrightnessLcdBacklightValues为对应的lcd亮度值，<br>比lux数组多一个，组成和曲线需要严格单调递增。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>config_autoBrightnessLevels -&gt; lux
</span></span><span class=line><span class=cl>config_autoBrightnessLcdBacklightValues -&gt; brightness
</span></span><span class=line><span class=cl>       --&gt; brightness[0]
</span></span><span class=line><span class=cl>lux[0] --&gt; brightness[1]
</span></span><span class=line><span class=cl>lux[1] --&gt; brightness[2]
</span></span><span class=line><span class=cl>lux[2] --&gt; brightness[3]
</span></span><span class=line><span class=cl>.....</span></span></code></pre></td></tr></table></div></div><h3 class=heading-element id=2-曲线初始化><span>2. 曲线初始化</span>
<a href=#2-%e6%9b%b2%e7%ba%bf%e5%88%9d%e5%a7%8b%e5%8c%96 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>曲线设置好了，就应该扔代码里跑起来，模型建起来了，这个过程是咋样的呢？<br>通过搜索配置关键词(<br>config_automatic_brightness_available<br>config_autoBrightnessLevels<br>config_autoBrightnessLcdBacklightValues<br>) 或知道其在DisplayPowerController()构造的时候初始化的。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>frameworks</span><span class=o>/</span><span class=n>base</span><span class=o>/</span><span class=n>services</span><span class=o>/</span><span class=n>core</span><span class=o>/</span><span class=n>java</span><span class=o>/</span><span class=n>com</span><span class=o>/</span><span class=n>android</span><span class=o>/</span><span class=n>server</span><span class=o>/</span><span class=n>display</span><span class=o>/</span><span class=n>DisplayPowerController</span><span class=p>.</span><span class=na>java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=nf>DisplayPowerController</span><span class=p>(......)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 使能开关</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mUseSoftwareAutoBrightnessConfig</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>resources</span><span class=p>.</span><span class=na>getBoolean</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>com</span><span class=p>.</span><span class=na>android</span><span class=p>.</span><span class=na>internal</span><span class=p>.</span><span class=na>R</span><span class=p>.</span><span class=na>bool</span><span class=p>.</span><span class=na>config_automatic_brightness_available</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mUseSoftwareAutoBrightnessConfig</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 光感数组</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=o>[]</span><span class=w> </span><span class=n>lux</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>resources</span><span class=p>.</span><span class=na>getIntArray</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>com</span><span class=p>.</span><span class=na>android</span><span class=p>.</span><span class=na>internal</span><span class=p>.</span><span class=na>R</span><span class=p>.</span><span class=na>array</span><span class=p>.</span><span class=na>config_autoBrightnessLevels</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 背光亮度数组</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=o>[]</span><span class=w> </span><span class=n>screenBrightness</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>resources</span><span class=p>.</span><span class=na>getIntArray</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>com</span><span class=p>.</span><span class=na>android</span><span class=p>.</span><span class=na>internal</span><span class=p>.</span><span class=na>R</span><span class=p>.</span><span class=na>array</span><span class=p>.</span><span class=na>config_autoBrightnessLcdBacklightValues</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 其它一些配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>lightSensorWarmUpTimeConfig</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>resources</span><span class=p>.</span><span class=na>getInteger</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>com</span><span class=p>.</span><span class=na>android</span><span class=p>.</span><span class=na>internal</span><span class=p>.</span><span class=na>R</span><span class=p>.</span><span class=na>integer</span><span class=p>.</span><span class=na>config_lightSensorWarmupTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=n>dozeScaleFactor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>resources</span><span class=p>.</span><span class=na>getFraction</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>com</span><span class=p>.</span><span class=na>android</span><span class=p>.</span><span class=na>internal</span><span class=p>.</span><span class=na>R</span><span class=p>.</span><span class=na>fraction</span><span class=p>.</span><span class=na>config_screenAutoBrightnessDozeScaleFactor</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>1</span><span class=p>,</span><span class=w> </span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 创建自动背光样条</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Spline</span><span class=w> </span><span class=n>screenAutoBrightnessSpline</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>createAutoBrightnessSpline</span><span class=p>(</span><span class=n>lux</span><span class=p>,</span><span class=w> </span><span class=n>screenBrightness</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>screenAutoBrightnessSpline</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 如果lux, brightness不合要求，禁用自动背光</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Slog</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Error in config.xml.  config_autoBrightnessLcdBacklightValues &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34;(size &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>screenBrightness</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;) &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34;must be monotic and have exactly one more entry than &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34;config_autoBrightnessLevels (size &#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>lux</span><span class=p>.</span><span class=na>length</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;) &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34;which must be strictly increasing.  &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34;Auto-brightness will be disabled.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mUseSoftwareAutoBrightnessConfig</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>false</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mAutomaticBrightnessController</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AutomaticBrightnessController</span><span class=p>(</span><span class=k>this</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                   </span><span class=n>handler</span><span class=p>.</span><span class=na>getLooper</span><span class=p>(),</span><span class=w> </span><span class=n>sensorManager</span><span class=p>,</span><span class=w> </span><span class=n>screenAutoBrightnessSpline</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                   </span><span class=p>...</span><span class=c1>// gamma, 最大最小值等其他配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>如果打开了自动背光功能，会根据lux和brightness数组，创建样条曲线（以得到一条光滑曲线，安卓采用的是三次样条插值，有兴趣的可以搜索下学习学习），<br>如果数组不满足要求，会禁用自动背光功能。<br>创建样条曲线成功后赋值给 AutomaticBrightnessController(),后面背光控制的主体逻辑就转到 AutomaticBrightnessController类里了。<br>AutomaticBrightnessController()构造就一些赋值，没啥可看的，重点看下 createAutoBrightnessSpline()</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Spline</span><span class=w> </span><span class=nf>createAutoBrightnessSpline</span><span class=p>(</span><span class=kt>int</span><span class=o>[]</span><span class=w> </span><span class=n>lux</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=o>[]</span><span class=w> </span><span class=n>brightness</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 归一化brightness[0]作为y[0]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>y</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>normalizeAbsoluteBrightness</span><span class=p>(</span><span class=n>brightness</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 处理对应的lux和brightness</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>n</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>x</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lux</span><span class=o>[</span><span class=n>i</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>y</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>normalizeAbsoluteBrightness</span><span class=p>(</span><span class=n>brightness</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Spline</span><span class=w> </span><span class=n>spline</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Spline</span><span class=p>.</span><span class=na>createSpline</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>创建样条时会做brightness归一化，即除以255,将背光值0<del>255限定在0</del>1之间，<br>lux为横坐标x轴,<br>归一化的亮度为y轴，<br>之后再调用createSpline()创建样条。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>frameworks</span><span class=o>/</span><span class=n>base</span><span class=o>/</span><span class=n>core</span><span class=o>/</span><span class=n>java</span><span class=o>/</span><span class=n>android</span><span class=o>/</span><span class=n>util</span><span class=o>/</span><span class=n>Spline</span><span class=p>.</span><span class=na>java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Spline</span><span class=w> </span><span class=nf>createSpline</span><span class=p>(</span><span class=kt>float</span><span class=o>[]</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=kt>float</span><span class=o>[]</span><span class=w> </span><span class=n>y</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 是否严格单调递增</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>isStrictlyIncreasing</span><span class=p>(</span><span class=n>x</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;The control points must all have strictly &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>+</span><span class=w> </span><span class=s>&#34;increasing X values.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 单调的还是线性的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>isMonotonic</span><span class=p>(</span><span class=n>y</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 创建单调三次样条插值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>createMonotoneCubicSpline</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>createLinearSpline</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>createSpline()先检查是否严格单调递增，然后看是单调的还是线性的，如果是线性的，那这好说，就一条直线，计算也方便，<br>没啥可看的，所以可以继续看下 createMonotoneCubicSpline()。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Spline</span><span class=w> </span><span class=nf>createMonotoneCubicSpline</span><span class=p>(</span><span class=kt>float</span><span class=o>[]</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=kt>float</span><span class=o>[]</span><span class=w> </span><span class=n>y</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MonotoneCubicSpline</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>MonotoneCubicSpline</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Spline</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 主要的就是这三个数组，横坐标x,纵坐标y,以及相邻点的斜率</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>float</span><span class=o>[]</span><span class=w> </span><span class=n>mX</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>float</span><span class=o>[]</span><span class=w> </span><span class=n>mY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>float</span><span class=o>[]</span><span class=w> </span><span class=n>mM</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=nf>MonotoneCubicSpline</span><span class=p>(</span><span class=kt>float</span><span class=o>[]</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=kt>float</span><span class=o>[]</span><span class=w> </span><span class=n>y</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>....</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// d存放相邻点的斜率，m存放相邻两斜率的平均值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>float</span><span class=o>[]</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>float</span><span class=o>[</span><span class=n>n</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=o>]</span><span class=p>;</span><span class=w> </span><span class=c1>// could optimize this out</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>float</span><span class=o>[]</span><span class=w> </span><span class=n>m</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=kt>float</span><span class=o>[</span><span class=n>n</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Compute slopes of secant lines between successive points.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kt>float</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>x</span><span class=o>[</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>x</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 相邻点斜率</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>d</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>y</span><span class=o>[</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>y</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>h</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Initialize the tangents as the average of the secants.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>m</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>d</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 相邻两斜率的平均值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>m</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>d</span><span class=o>[</span><span class=n>i</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>d</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>0</span><span class=p>.</span><span class=na>5f</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>m</span><span class=o>[</span><span class=n>n</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>d</span><span class=o>[</span><span class=n>n</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>2</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Update the tangents to preserve monotonicity.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 再次更新m以保持单调性</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>d</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>0f</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=c1>// successive Y values are equal</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>m</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0f</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>m</span><span class=o>[</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0f</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>float</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>m</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>d</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>float</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>m</span><span class=o>[</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>d</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0f</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0f</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&#34;The control points must have &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=o>+</span><span class=w> </span><span class=s>&#34;monotonic Y values.&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=kt>float</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>float</span><span class=p>)</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>hypot</span><span class=p>(</span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=n>b</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>h</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>3f</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=kt>float</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>3f</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>h</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>m</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>*=</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>m</span><span class=o>[</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>*=</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mX</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>y</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mM</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>m</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>createMonotoneCubicSpline() 里new了个 MonotoneCubicSpline, 主要是为了得到横纵坐标及相邻斜率均值mX,mY,mM<br>这个需要先研究下三次样条插值算法原理才能更好的理解。</p><p>至此呢，Spline就创建好了，那什么时候用到呢？<br>MonotoneCubicSpline类里有个方法 interpolate(float x)，我们猜测最终根据光感值x计算出背光时就会用到该函数，<br>但是讲这个函数之前，还是让我们来看看数据流向吧，<br>即看下光传感器数据上来后数据处理流程，如何去抖，选出x,然后再计算亮度，之后再进一步的看看如何处理用户微调(adjustment),<br>然后亮度调节就生效了&mldr;</p><h3 class=heading-element id=3-采样去抖><span>3. 采样去抖</span>
<a href=#3-%e9%87%87%e6%a0%b7%e5%8e%bb%e6%8a%96 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>前面看了样条曲线的建立过程，这节我们先看下lux采集处理过程。</p><h4 class=heading-element id=31-采样><span>3.1 采样</span>
<a href=#31-%e9%87%87%e6%a0%b7 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>要有数据肯定先把sensor打通，</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>frameworks</span><span class=o>/</span><span class=n>base</span><span class=o>/</span><span class=n>services</span><span class=o>/</span><span class=n>core</span><span class=o>/</span><span class=n>java</span><span class=o>/</span><span class=n>com</span><span class=o>/</span><span class=n>android</span><span class=o>/</span><span class=n>server</span><span class=o>/</span><span class=n>display</span><span class=o>/</span><span class=n>DisplayPowerController</span><span class=p>.</span><span class=na>java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>updatePowerState</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>brightness</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PowerManager</span><span class=p>.</span><span class=na>BRIGHTNESS_DEFAULT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 检查是否使能自动背光</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>autoBrightnessEnabled</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mPowerRequest</span><span class=p>.</span><span class=na>useAutoBrightness</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=p>(</span><span class=n>state</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>Display</span><span class=p>.</span><span class=na>STATE_ON</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>autoBrightnessEnabledInDoze</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 这个brightness与Doze模式是否允许使用自动背光配置有关，不是表示屏幕亮度&lt;0,默认是BRIGHTNESS_DEFAULT为-1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>brightness</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mAutomaticBrightnessController</span><span class=p>.</span><span class=na>configure</span><span class=p>(</span><span class=n>autoBrightnessEnabled</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>mPowerRequest</span><span class=p>.</span><span class=na>screenAutoBrightnessAdjustment</span><span class=p>,</span><span class=w> </span><span class=n>state</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>Display</span><span class=p>.</span><span class=na>STATE_ON</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>userInitiatedChange</span><span class=p>);</span></span></span></code></pre></td></tr></table></div></div><p>其中updatePowerState()时会根据状态和条件看是否使能自动背光，<br>这条条件是 电源请求是否使用自动背光，显示状态是否为开，Doze模式是否允许</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>frameworks</span><span class=o>/</span><span class=n>base</span><span class=o>/</span><span class=n>services</span><span class=o>/</span><span class=n>core</span><span class=o>/</span><span class=n>java</span><span class=o>/</span><span class=n>com</span><span class=o>/</span><span class=n>android</span><span class=o>/</span><span class=n>server</span><span class=o>/</span><span class=n>display</span><span class=o>/</span><span class=n>AutomaticBrightnessController</span><span class=p>.</span><span class=na>java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>configure</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>enable</span><span class=p>,</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=n>adjustment</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>dozing</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>boolean</span><span class=w> </span><span class=n>userInitiatedChange</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>boolean</span><span class=w> </span><span class=n>changed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>setLightSensorEnabled</span><span class=p>(</span><span class=n>enable</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=o>!</span><span class=n>dozing</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>如果自动背光使能了且非dozing中，会将光感使能，这里面就是sensor listener的注册，之后有就可以得到lux数据了,<br>setLightSensorEnabled() 注册listener就不贴代码了，贴下数据回调</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kd>final</span><span class=w> </span><span class=n>SensorEventListener</span><span class=w> </span><span class=n>mLightSensorListener</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>SensorEventListener</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onSensorChanged</span><span class=p>(</span><span class=n>SensorEvent</span><span class=w> </span><span class=n>event</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mLightSensorEnabled</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>time</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SystemClock</span><span class=p>.</span><span class=na>uptimeMillis</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=kd>final</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=n>lux</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>event</span><span class=p>.</span><span class=na>values</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>handleLightSensorEvent</span><span class=p>(</span><span class=n>time</span><span class=p>,</span><span class=w> </span><span class=n>lux</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>};</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>handleLightSensorEvent</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>time</span><span class=p>,</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=n>lux</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果有 MSG_UPDATE_AMBIENT_LUX 消息，则移除</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mHandler</span><span class=p>.</span><span class=na>removeMessages</span><span class=p>(</span><span class=n>MSG_UPDATE_AMBIENT_LUX</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 更新缓冲区</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>applyLightSensorMeasurement</span><span class=p>(</span><span class=n>time</span><span class=p>,</span><span class=w> </span><span class=n>lux</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 更新数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>updateAmbientLux</span><span class=p>(</span><span class=n>time</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>applyLightSensorMeasurement</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>time</span><span class=p>,</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=n>lux</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 将多少周期(默认10s)前的数据删掉</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mAmbientLightRingBuffer</span><span class=p>.</span><span class=na>prune</span><span class=p>(</span><span class=n>time</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>mAmbientLightHorizon</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 将当前数据放到缓冲中</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mAmbientLightRingBuffer</span><span class=p>.</span><span class=na>push</span><span class=p>(</span><span class=n>time</span><span class=p>,</span><span class=w> </span><span class=n>lux</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>.....</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>handleLightSensorEvent()首先取消了 MSG_UPDATE_AMBIENT_LUX 消息，<br>该消息的作用是当传感器长时间没有数据上报时，周期性的更新一把缓冲区，<br>把过期的数据删除(但需要保留最后个值，并把时间更新为当前时间)(这部分是不是可以优化下)<br>然后调用 applyLightSensorMeasurement()将过期的数据删掉，并将当前的值加入到缓冲中。<br>默认的周期为10s</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;integer</span> <span class=na>name=</span><span class=s>&#34;config_autoBrightnessAmbientLightHorizon&#34;</span><span class=nt>&gt;</span>10000<span class=nt>&lt;/integer&gt;</span></span></span></code></pre></td></tr></table></div></div><p>即缓冲只最多保留10秒的数据，<br><strong>注意这里还只是数据的一个简单记录</strong><br>之后再调用updateAmbientLux() 更新值，<br><strong>注意该函数已经进入到防抖过程了</strong></p><h4 class=heading-element id=31-防抖><span>3.1 防抖</span>
<a href=#31-%e9%98%b2%e6%8a%96 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>防抖的流程都在updateAmbientLux()函数里，<br>然后用HysteresisLevels类辅助计算明暗光感的阀值。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>updateAmbientLux</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>time</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// If the light sensor was just turned on then immediately update our initial</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// estimate of the current ambient light level.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mAmbientLuxValid</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 打开sensor后第一次更新数据情况，略过...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 计算明暗变化的时间点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>nextBrightenTransition</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nextAmbientLightBrighteningTransition</span><span class=p>(</span><span class=n>time</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>nextDarkenTransition</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nextAmbientLightDarkeningTransition</span><span class=p>(</span><span class=n>time</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 计算10s和2s内的lux</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>float</span><span class=w> </span><span class=n>slowAmbientLux</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>calculateAmbientLux</span><span class=p>(</span><span class=n>time</span><span class=p>,</span><span class=w> </span><span class=n>AMBIENT_LIGHT_LONG_HORIZON_MILLIS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>float</span><span class=w> </span><span class=n>fastAmbientLux</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>calculateAmbientLux</span><span class=p>(</span><span class=n>time</span><span class=p>,</span><span class=w> </span><span class=n>AMBIENT_LIGHT_SHORT_HORIZON_MILLIS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果满足去抖的要求，会进行lux和亮度的计算更新</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>slowAmbientLux</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>mBrighteningLuxThreshold</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>fastAmbientLux</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>mBrighteningLuxThreshold</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>nextBrightenTransition</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>time</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>||</span><span class=w> </span><span class=n>slowAmbientLux</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>mDarkeningLuxThreshold</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>fastAmbientLux</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>mDarkeningLuxThreshold</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>nextDarkenTransition</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>time</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 更新lux和明暗lux阀值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setAmbientLux</span><span class=p>(</span><span class=n>fastAmbientLux</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 这个log应该放在setAmbientLux()前面，不然 fastAmbientLux &gt; mAmbientLux永远为false</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>DEBUG</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>Slog</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;updateAmbientLux: &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=p>((</span><span class=n>fastAmbientLux</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>mAmbientLux</span><span class=p>)</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=s>&#34;Brightened&#34;</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s>&#34;Darkened&#34;</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;: &#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34;mBrighteningLuxThreshold=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mBrighteningLuxThreshold</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, mAmbientLightRingBuffer=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mAmbientLightRingBuffer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=o>+</span><span class=w> </span><span class=s>&#34;, mAmbientLux=&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mAmbientLux</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 更新亮度</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>updateAutoBrightness</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mHandler</span><span class=p>.</span><span class=na>sendEmptyMessageAtTime</span><span class=p>(</span><span class=n>MSG_UPDATE_AMBIENT_LUX</span><span class=p>,</span><span class=w> </span><span class=n>nextTransitionTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>整个流程大体为</p><ul><li>计算明暗变化的时间点 防止周期性的大幅度抖动</li><li>计算2s和10s内的lux 用于去抖比较，使光照稳定在0.8~1.1倍之间</li><li>如果满足去抖的要求，会进行lux、明暗阀值和亮度的计算更新</li></ul><p>上面代码都有注释，下面我们看一些方法的具体代码</p><p>计算明暗变化(由暗到亮场景，由亮到暗场景)时间点</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=nf>nextAmbientLightBrighteningTransition</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>time</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>N</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mAmbientLightRingBuffer</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>earliestValidTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>time</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 从后往前找到离当前时间第一个大于阀值的点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>N</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>--</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mAmbientLightRingBuffer</span><span class=p>.</span><span class=na>getLux</span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>mBrighteningLuxThreshold</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>earliestValidTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mAmbientLightRingBuffer</span><span class=p>.</span><span class=na>getTime</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 找到的点时间加上去抖时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>earliestValidTime</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mBrighteningLightDebounceConfig</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=nf>nextAmbientLightDarkeningTransition</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>time</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>N</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mAmbientLightRingBuffer</span><span class=p>.</span><span class=na>size</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>earliestValidTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>time</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>从后往前找到离当前时间第一个小于阀值的点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nf>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>N</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>--</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mAmbientLightRingBuffer</span><span class=p>.</span><span class=na>getLux</span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>mDarkeningLuxThreshold</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>earliestValidTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mAmbientLightRingBuffer</span><span class=p>.</span><span class=na>getTime</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 找到的点时间加上去抖时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>earliestValidTime</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>mDarkeningLightDebounceConfig</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>由暗变亮 nextAmbientLightBrighteningTransition()<br>从后往前找到离当前时间第一个大于阀值的点，然后加上去抖时间 mBrighteningLightDebounceConfig ，即为next Brightening的时间点，<br>默认为4s</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;integer</span> <span class=na>name=</span><span class=s>&#34;config_autoBrightnessBrighteningLightDebounce&#34;</span><span class=nt>&gt;</span>4000<span class=nt>&lt;/integer&gt;</span></span></span></code></pre></td></tr></table></div></div><p>由亮变暗 nextAmbientLightDarkeningTransition()<br>从后往前找到离当前时间第一个小于阀值的点，然后加上去抖时间 mDarkeningLightDebounceConfig ，即为next Darkening的时间点，<br>默认为8s</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;integer</span> <span class=na>name=</span><span class=s>&#34;config_autoBrightnessDarkeningLightDebounce&#34;</span><span class=nt>&gt;</span>8000<span class=nt>&lt;/integer&gt;</span></span></span></code></pre></td></tr></table></div></div><p><strong>通过此方法，就可以防止数据周期性或者最近有大幅度波动的状况</strong></p><p>计算2s和10s内的lux<br>用到的函数为calculateAmbientLux(),<br>该函数用于计算当前时间，多少周期前内的lux值，采用的是加权平均算法。<br>具体的代码可看下注释，我也没明白权值计算weightIntegral()为什么要用那个算法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=nf>calculateAmbientLux</span><span class=p>(</span><span class=kt>long</span><span class=w> </span><span class=n>now</span><span class=p>,</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>horizon</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// Find the first measurement that is just outside of the horizon.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>endIndex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 计算出指定时间的开始下标</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>horizonStartTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>now</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>horizon</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>N</span><span class=o>-</span><span class=n>1</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>++</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mAmbientLightRingBuffer</span><span class=p>.</span><span class=na>getTime</span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=p>)</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>horizonStartTime</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>endIndex</span><span class=o>++</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>break</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>float</span><span class=w> </span><span class=n>sum</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>float</span><span class=w> </span><span class=n>totalWeight</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>endTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AMBIENT_LIGHT_PREDICTION_TIME_MILLIS</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>N</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>endIndex</span><span class=p>;</span><span class=w> </span><span class=n>i</span><span class=o>--</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>long</span><span class=w> </span><span class=n>eventTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mAmbientLightRingBuffer</span><span class=p>.</span><span class=na>getTime</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>i</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>endIndex</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>eventTime</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>horizonStartTime</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// If we&#39;re at the final value, make sure we only consider the part of the sample</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// within our desired horizon.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>eventTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>horizonStartTime</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>startTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>eventTime</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>now</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 权值计算</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>float</span><span class=w> </span><span class=n>weight</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>calculateWeight</span><span class=p>(</span><span class=n>startTime</span><span class=p>,</span><span class=w> </span><span class=n>endTime</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>float</span><span class=w> </span><span class=n>lux</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mAmbientLightRingBuffer</span><span class=p>.</span><span class=na>getLux</span><span class=p>(</span><span class=n>i</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>totalWeight</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>weight</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sum</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>mAmbientLightRingBuffer</span><span class=p>.</span><span class=na>getLux</span><span class=p>(</span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>weight</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>endTime</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>startTime</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 加权平均</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>sum</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>totalWeight</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>接下来，如果2s和10s内都大于(或小于阀值)，且达到了防抖时间要求，则更新lux,阈值，亮度</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>if (slowAmbientLux &gt;= mBrighteningLuxThreshold &amp;&amp;
</span></span><span class=line><span class=cl>            fastAmbientLux &gt;= mBrighteningLuxThreshold &amp;&amp; nextBrightenTransition &lt;= time
</span></span><span class=line><span class=cl>            || slowAmbientLux &lt;= mDarkeningLuxThreshold
</span></span><span class=line><span class=cl>            &amp;&amp; fastAmbientLux &lt;= mDarkeningLuxThreshold &amp;&amp; nextDarkenTransition &lt;= time)</span></span></code></pre></td></tr></table></div></div><p>更新lux和阀值 (<strong>以2s的加权平均lux更新</strong>)</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>setAmbientLux</span><span class=p>(</span><span class=n>fastAmbientLux</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>setAmbientLux</span><span class=p>(</span><span class=kt>float</span><span class=w> </span><span class=n>lux</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 更新lux</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mAmbientLux</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lux</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 更新阀值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mBrighteningLuxThreshold</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mDynamicHysteresis</span><span class=p>.</span><span class=na>getBrighteningThreshold</span><span class=p>(</span><span class=n>lux</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>mDarkeningLuxThreshold</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mDynamicHysteresis</span><span class=p>.</span><span class=na>getDarkeningThreshold</span><span class=p>(</span><span class=n>lux</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>更新阀值getBrighteningThreshold() getDarkeningThreshold()的主要计算为</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kt>float</span><span class=w> </span><span class=n>brightThreshold</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lux</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>.</span><span class=na>0f</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>brightConstant</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kt>float</span><span class=w> </span><span class=n>darkThreshold</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lux</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>.</span><span class=na>0f</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>darkConstant</span><span class=p>);</span></span></span></code></pre></td></tr></table></div></div><p>Constant涉及到配置</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;integer-array</span> <span class=na>name=</span><span class=s>&#34;config_dynamicHysteresisBrightLevels&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;item&gt;</span>100<span class=nt>&lt;/item&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/integer-array&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;integer-array</span> <span class=na>name=</span><span class=s>&#34;config_dynamicHysteresisDarkLevels&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;item&gt;</span>200<span class=nt>&lt;/item&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/integer-array&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;integer-array</span> <span class=na>name=</span><span class=s>&#34;config_dynamicHysteresisLuxLevels&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/integer-array&gt;</span></span></span></code></pre></td></tr></table></div></div><p>因为没有配置config_dynamicHysteresisLuxLevels，所以最终<br>即由暗到亮场景，需要&lt;0.8*lux<br>即由暗到亮场景，需要>1.1*lux<br><strong>即可以简单认为数据在0.8~1.1倍之间波动都认为是OK的。这也是去抖一部分</strong></p><p><strong>至此，去抖功能就完成了，简单的说就是</strong><br><strong>通过 nextAmbient&mldr;Transition 找到防抖完成时间 (稳定4/8秒)，</strong><br><strong>然后在2～10s内加权平均lux在0.8~1.1倍阀值。</strong></p><h3 class=heading-element id=4-更新亮度-updateautobrightness><span>4. 更新亮度 updateAutoBrightness()</span>
<a href=#4-%e6%9b%b4%e6%96%b0%e4%ba%ae%e5%ba%a6-updateautobrightness class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>setAmbientLux()完成后就该updateAutoBrightness(true)了，<br>参数true表示最终会调用 DisplayPowerController 进行实际的亮度更新</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>updateAutoBrightness</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>sendUpdate</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果自动光感没数据，直接返回了。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>mAmbientLuxValid</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 从建模的曲线中算出对应的brightness，这只是初步的亮度值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>float</span><span class=w> </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mScreenAutoBrightnessSpline</span><span class=p>.</span><span class=na>interpolate</span><span class=p>(</span><span class=n>mAmbientLux</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>float</span><span class=w> </span><span class=n>gamma</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>1</span><span class=p>.</span><span class=na>0f</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 如果用户有调整，处理用户的adjustment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>USE_SCREEN_AUTO_BRIGHTNESS_ADJUSTMENT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>mScreenAutoBrightnessAdjustment</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>0</span><span class=p>.</span><span class=na>0f</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// mScreenAutoBrightnessAdjustmentMaxGamma 配置里用的是300%</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 即我们前面列的公式的 3^(-x) x为-1.0~1.0之间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=n>adjGamma</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MathUtils</span><span class=p>.</span><span class=na>pow</span><span class=p>(</span><span class=n>mScreenAutoBrightnessAdjustmentMaxGamma</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=n>1</span><span class=p>.</span><span class=na>0f</span><span class=p>,</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>max</span><span class=p>(</span><span class=o>-</span><span class=n>1</span><span class=p>.</span><span class=na>0f</span><span class=p>,</span><span class=w> </span><span class=o>-</span><span class=n>mScreenAutoBrightnessAdjustment</span><span class=p>)));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>gamma</span><span class=w> </span><span class=o>*=</span><span class=w> </span><span class=n>adjGamma</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.....</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// gamma不为1.0f表示用户有调整</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>gamma</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>1</span><span class=p>.</span><span class=na>0f</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>final</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// value^gamma</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MathUtils</span><span class=p>.</span><span class=na>pow</span><span class=p>(</span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=n>gamma</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>....</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// value*255向下取整并使值在mScreenBrightnessRangeMinimum～mScreenBrightnessRangeMaximum区间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>// 这样就得出了最终亮度</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>newScreenAutoBrightness</span><span class=w> </span><span class=o>=</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>clampScreenBrightness</span><span class=p>(</span><span class=n>Math</span><span class=p>.</span><span class=na>round</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>PowerManager</span><span class=p>.</span><span class=na>BRIGHTNESS_ON</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mScreenAutoBrightness</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>newScreenAutoBrightness</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>sendUpdate</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 通知更新</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>mCallbacks</span><span class=p>.</span><span class=na>updateBrightness</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>更新亮度的流程也挺简单的，就是</p><ul><li>从建模的曲线中算出对应的初步亮度值</li><li>如果用户有调整，进一步处理用户调整</li><li>处理最终的亮度值，使其在极值区间里</li></ul><p>对应的就是我们前面列的公式</p><p>$$
\mathbf{z = y^{3^{-x}}*255, x\in[-1.0, 1.0], y\in[0.0, 1.0], z\in[min, 255]}
$$</p><p>具体的就不分步讲了，可看下我的注释，这里只贴下Spline interpolate()代码<br>我们之前建模时讲了，创建spline可能是线性的，也可能是MonotoneCubicSpline，<br>我们这只看看MonotoneCubicSpline的，所以对应代码为</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>frameworks</span><span class=o>/</span><span class=n>base</span><span class=o>/</span><span class=n>core</span><span class=o>/</span><span class=n>java</span><span class=o>/</span><span class=n>android</span><span class=o>/</span><span class=n>util</span><span class=o>/</span><span class=n>Spline</span><span class=p>.</span><span class=na>java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=kd>class</span> <span class=nc>MonotoneCubicSpline</span><span class=w> </span><span class=kd>extends</span><span class=w> </span><span class=n>Spline</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=nf>interpolate</span><span class=p>(</span><span class=kt>float</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>......</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 小于最小lux，直接反回brightness[0]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>x</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=n>mX</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>mY</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 大于最大的lux, 直接返回最大的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>x</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>mX</span><span class=o>[</span><span class=n>n</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=o>]</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>mY</span><span class=o>[</span><span class=n>n</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Find the index &#39;i&#39; of the last point with smaller X.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// We know this will be within the spline due to the boundary tests.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>0</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 刚好落在采样点上</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>x</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>mX</span><span class=o>[</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=o>]</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>i</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>x</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>mX</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>mY</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// Perform cubic Hermite spline interpolation.</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>float</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mX</span><span class=o>[</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>mX</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kt>float</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>x</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>mX</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>h</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 三次插值计算</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=n>mY</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>2</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>mM</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>mY</span><span class=o>[</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=p>(</span><span class=n>3</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>2</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>h</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>mM</span><span class=o>[</span><span class=n>i</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>1</span><span class=o>]</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=p>(</span><span class=n>t</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>1</span><span class=p>))</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>t</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>t</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>插值时，大于最大小于最小或者落在点上的情况都好说，直接返回就行了<br>注意 mX[0] 并不是 config_autoBrightnessLevels 中的第一个lux,<br>实际上 createAutoBrightnessSpline() 时 float[] x = new float[n];<br>其实mX[0] = 0;</p><p>若点都不在极值和采样点上，那就得插值计算了，这个具体的算法原理我也没了解。</p><p>关于背光算法就说到这儿吧，大体上就这么多东西。<br>之后的DisplayPowerController更新亮度也不说了，需要了解有个<br>mBrightnessRampRateSlow //自动背光用的这个<br>mBrightnessRampRateFast<br>可以控制背光开始变化时的变化快慢就行了</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=c>&lt;!-- Fast brightness animation ramp rate in brightness units per second--&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;integer</span> <span class=na>translatable=</span><span class=s>&#34;false&#34;</span> <span class=na>name=</span><span class=s>&#34;config_brightness_ramp_rate_fast&#34;</span><span class=nt>&gt;</span>180<span class=nt>&lt;/integer&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c>&lt;!-- Slow brightness animation ramp rate in brightness units per second--&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;integer</span> <span class=na>translatable=</span><span class=s>&#34;false&#34;</span> <span class=na>name=</span><span class=s>&#34;config_brightness_ramp_rate_slow&#34;</span><span class=nt>&gt;</span>60<span class=nt>&lt;/integer&gt;</span></span></span></code></pre></td></tr></table></div></div><h3 class=heading-element id=5-用户微调><span>5. 用户微调</span>
<a href=#5-%e7%94%a8%e6%88%b7%e5%be%ae%e8%b0%83 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>当自动背光开时，背光亮度条变成了个调节系数，值在[-1.0f, 1.0f], 默认在0.0f,<br>当用户拖动这个条时，最终会写到 Settings.System.SCREEN_AUTO_BRIGHTNESS_ADJ 数据库里，<br>然后 PowerManagerService 监测到数据库变更，最终给了 mPowerRequest.screenAutoBrightnessAdjustment，<br>DisplayPowerController.java updatePowerState() 时</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>mAutomaticBrightnessController</span><span class=p>.</span><span class=na>configure</span><span class=p>(....</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>mPowerRequest</span><span class=p>.</span><span class=na>screenAutoBrightnessAdjustment</span><span class=p>....</span></span></span></code></pre></td></tr></table></div></div><p>最终赋值给了 mScreenAutoBrightnessAdjustment，计算亮度时就用到了该值</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>AutomaticBrightnessController</span><span class=p>.</span><span class=na>java</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>configure</span><span class=p>(</span><span class=kt>boolean</span><span class=w> </span><span class=n>enable</span><span class=p>,</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=n>adjustment</span><span class=p>,</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=n>dozing</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>....</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>changed</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>setScreenAutoBrightnessAdjustment</span><span class=p>(</span><span class=n>adjustment</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=kt>boolean</span><span class=w> </span><span class=nf>setScreenAutoBrightnessAdjustment</span><span class=p>(</span><span class=kt>float</span><span class=w> </span><span class=n>adjustment</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>....</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>mScreenAutoBrightnessAdjustment</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>adjustment</span><span class=p>;</span></span></span></code></pre></td></tr></table></div></div><h3 class=heading-element id=6-总结><span>6. 总结:</span>
<a href=#6-%e6%80%bb%e7%bb%93 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><ul><li>涉及到的一些配置</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>frameworks/base/core/res/res/values/config.xml
</span></span><span class=line><span class=cl>// 自动背光功能是否可用开关, 默认关，需要打开
</span></span><span class=line><span class=cl>config_automatic_brightness_available
</span></span><span class=line><span class=cl>// lux 数组 
</span></span><span class=line><span class=cl>config_autoBrightnessLevels
</span></span><span class=line><span class=cl>// 对应lcd brightness 数组
</span></span><span class=line><span class=cl>config_autoBrightnessLcdBacklightValues
</span></span><span class=line><span class=cl>// 光感数据缓冲区周期，即采集多少时间内的数据
</span></span><span class=line><span class=cl>config_autoBrightnessAmbientLightHorizon
</span></span><span class=line><span class=cl>// 由暗到亮场景防抖时间，注意不要超过 config_autoBrightnessAmbientLightHorizon
</span></span><span class=line><span class=cl>config_autoBrightnessBrighteningLightDebounce
</span></span><span class=line><span class=cl>// 由亮到暗场景防抖时间，注意不要超过 config_autoBrightnessAmbientLightHorizon
</span></span><span class=line><span class=cl>config_autoBrightnessDarkeningLightDebounce
</span></span><span class=line><span class=cl>// 计算变亮变暗场景阀值时的Constant
</span></span><span class=line><span class=cl>config_dynamicHysteresisBrightLevels
</span></span><span class=line><span class=cl>config_dynamicHysteresisDarkLevels
</span></span><span class=line><span class=cl>config_dynamicHysteresisLuxLevels
</span></span><span class=line><span class=cl>// 屏幕亮度变化时的ramp rate
</span></span><span class=line><span class=cl>config_brightness_ramp_rate_slow</span></span></code></pre></td></tr></table></div></div><ul><li>创建 Spline</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>DisplayPowerController.java
</span></span><span class=line><span class=cl>public DisplayPowerController()
</span></span><span class=line><span class=cl>    + Spline screenAutoBrightnessSpline = createAutoBrightnessSpline(lux, screenBrightness);
</span></span><span class=line><span class=cl>    |                                        + normalize
</span></span><span class=line><span class=cl>    |                                        + createSpline()
</span></span><span class=line><span class=cl>    |                                            + createMonotoneCubicSpline()
</span></span><span class=line><span class=cl>    |                                                + new MonotoneCubicSpline(x, y)
</span></span><span class=line><span class=cl>    |                                                    + mX = x;
</span></span><span class=line><span class=cl>    |                                                    + mY = y;
</span></span><span class=line><span class=cl>    |                                                    + mM = m;
</span></span><span class=line><span class=cl>    + mAutomaticBrightnessController = new AutomaticBrightnessController(...screenAutoBrightnessSpline,...)</span></span></code></pre></td></tr></table></div></div><ul><li>使能自动背光功能并注册光感listener</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>updatePowerState() DisplayPowerController.java
</span></span><span class=line><span class=cl>  + mAutomaticBrightnessController.configure(autoBrightnessEnabled,
</span></span><span class=line><span class=cl>      + configure() AutomaticBrightnessController.java
</span></span><span class=line><span class=cl>          + setLightSensorEnabled()
</span></span><span class=line><span class=cl>              + registerListener(mLightSensorListener</span></span></code></pre></td></tr></table></div></div><ul><li>当有光感数据上来时, 处理数据，删掉过期数据，并将数据加入到缓冲中，然后去抖，更新lux, 更新亮度<br>当然，如果没新数据还上，还会周期性的 MSG_UPDATE_AMBIENT_LUX</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>mLightSensorListener</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nf>onSensorChanged</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>+</span><span class=w> </span><span class=n>handleLightSensorEvent</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>   </span><span class=o>+</span><span class=w> </span><span class=n>applyLightSensorMeasurement</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>+</span><span class=w> </span><span class=n>mAmbientLightRingBuffer</span><span class=p>.</span><span class=na>prune</span><span class=p>(</span><span class=n>time</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>mAmbientLightHorizon</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>+</span><span class=w> </span><span class=n>mAmbientLightRingBuffer</span><span class=p>.</span><span class=na>push</span><span class=p>(</span><span class=n>time</span><span class=p>,</span><span class=w> </span><span class=n>lux</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>   </span><span class=o>+</span><span class=w> </span><span class=n>updateAmbientLux</span><span class=p>(</span><span class=n>time</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>+</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>nextBrightenTransition</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nextAmbientLightBrighteningTransition</span><span class=p>(</span><span class=n>time</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>+</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>nextDarkenTransition</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>nextAmbientLightDarkeningTransition</span><span class=p>(</span><span class=n>time</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>+</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=n>slowAmbientLux</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>calculateAmbientLux</span><span class=p>(</span><span class=n>time</span><span class=p>,</span><span class=w> </span><span class=n>AMBIENT_LIGHT_LONG_HORIZON_MILLIS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>+</span><span class=w> </span><span class=kt>float</span><span class=w> </span><span class=n>fastAmbientLux</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>calculateAmbientLux</span><span class=p>(</span><span class=n>time</span><span class=p>,</span><span class=w> </span><span class=n>AMBIENT_LIGHT_SHORT_HORIZON_MILLIS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>+</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>slowAmbientLux</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>mBrighteningLuxThreshold</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=p>...</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>+</span><span class=w> </span><span class=n>setAmbientLux</span><span class=p>(</span><span class=n>fastAmbientLux</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>|</span><span class=w>   </span><span class=o>+</span><span class=w> </span><span class=n>mAmbientLux</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>lux</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>|</span><span class=w>   </span><span class=o>+</span><span class=w> </span><span class=n>mBrighteningLuxThreshold</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mDynamicHysteresis</span><span class=p>.</span><span class=na>getBrighteningThreshold</span><span class=p>(</span><span class=n>lux</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>                              </span><span class=o>+</span><span class=w> </span><span class=n>lux</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>.</span><span class=na>0f</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>brightConstant</span><span class=p>);</span><span class=w> </span><span class=c1>// 1.1lux</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>|</span><span class=w>   </span><span class=o>+</span><span class=w> </span><span class=n>mDarkeningLuxThreshold</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mDynamicHysteresis</span><span class=p>.</span><span class=na>getDarkeningThreshold</span><span class=p>(</span><span class=n>lux</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>|</span><span class=w>                                  </span><span class=o>+</span><span class=w> </span><span class=n>lux</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=p>(</span><span class=n>1</span><span class=p>.</span><span class=na>0f</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>brightConstant</span><span class=p>);</span><span class=w> </span><span class=c1>// 0.8lux</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>+</span><span class=w> </span><span class=n>updateAutoBrightness</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>|</span><span class=w>   </span><span class=o>+</span><span class=w> </span><span class=n>mScreenAutoBrightnessSpline</span><span class=p>.</span><span class=na>interpolate</span><span class=p>(</span><span class=n>mAmbientLux</span><span class=p>)</span><span class=w> </span><span class=c1>// 计算出y</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>|</span><span class=w>   </span><span class=o>+</span><span class=w> </span><span class=n>MathUtils</span><span class=p>.</span><span class=na>pow</span><span class=p>(</span><span class=n>mScreenAutoBrightnessAdjustmentMaxGamma</span><span class=p>...</span><span class=w> </span><span class=o>-</span><span class=n>mScreenAutoBrightnessAdjustment</span><span class=p>)</span><span class=w> </span><span class=c1>// 3^(-x)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>|</span><span class=w>   </span><span class=o>+</span><span class=w> </span><span class=n>MathUtils</span><span class=p>.</span><span class=na>pow</span><span class=p>(</span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=n>gamma</span><span class=p>);</span><span class=w> </span><span class=c1>// y^{3^{-x}}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>   </span><span class=o>|</span><span class=w>     </span><span class=o>|</span><span class=w>   </span><span class=o>+</span><span class=w> </span><span class=n>clampScreenBrightness</span><span class=p>(</span><span class=n>Math</span><span class=p>.</span><span class=na>round</span><span class=p>(</span><span class=n>value</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>PowerManager</span><span class=p>.</span><span class=na>BRIGHTNESS_ON</span><span class=p>));</span><span class=w> </span><span class=c1>// y^{3^{-x}} * 255</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=o>+</span><span class=w>   </span><span class=o>+</span><span class=w>   </span><span class=o>+</span><span class=w>     </span><span class=o>+</span><span class=w>   </span><span class=o>+</span><span class=w> </span><span class=n>mCallbacks</span><span class=p>.</span><span class=na>updateBrightness</span><span class=p>()</span></span></span></code></pre></td></tr></table></div></div><h2 class=heading-element id=三一些调试命令><span>三、一些调试命令</span>
<a href=#%e4%b8%89%e4%b8%80%e4%ba%9b%e8%b0%83%e8%af%95%e5%91%bd%e4%bb%a4 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><ul><li>打开自动背光</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>adb shell settings put system screen_brightness_mode <span class=m>1</span></span></span></code></pre></td></tr></table></div></div><ul><li>背光系数调整</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>adb shell settings put system screen_auto_brightness_adj 0.0</span></span></code></pre></td></tr></table></div></div><ul><li>dump display, 可查看dump信息，包括建模的一些点值等&mldr;</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>adb shell dumpsys display</span></span></code></pre></td></tr></table></div></div></div><div class=collection-card><div class="collection-title text-secondary">收录于 <a href=/collections/%E5%9B%BE%E5%BD%A2%E6%98%BE%E7%A4%BA/><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i> <span>合集・图形显示</span></span></a> 43</div><div class=collection-nav><a href=/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/ class=collection-nav-item rel=prev title=开发中常用到的一些调试命令><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i><span>开发中常用到的一些调试命令</span>
</a><a href=/posts/fh20gms-120-vtsmr1vts_generic_boot_image_test-gms-confluence/ class=collection-nav-item rel=next title="FH20GMS-120    [VTS][MR1]vts_generic_boot_image_test - GMS - Confluence"><span>FH20GMS-120 [VTS][MR1]vts_generic_boot_image_test - GMS - Confluence</span><i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2025-10-23 08:23:27">更新于 2025-10-23&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://huang8604.github.io/posts/%E8%87%AA%E5%8A%A8%E8%83%8C%E5%85%89%E7%AE%97%E6%B3%95-android-8.1/ data-title="自动背光算法-Android 8.1"><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/clippings/ class=post-tag title="标签 - Clippings">Clippings</a><a href=/tags/%E8%BD%AC%E8%BD%BD/ class=post-tag title="标签 - 转载">转载</a><a href=/tags/blog/ class=post-tag title="标签 - Blog">Blog</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/%E5%BC%80%E5%8F%91%E4%B8%AD%E5%B8%B8%E7%94%A8%E5%88%B0%E7%9A%84%E4%B8%80%E4%BA%9B%E8%B0%83%E8%AF%95%E5%91%BD%E4%BB%A4/ class=post-nav-item rel=prev title=开发中常用到的一些调试命令><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>开发中常用到的一些调试命令</a><a href=/posts/%E6%80%BB%E7%BB%93-%E5%88%A4%E6%96%ADuwb%E6%9C%8D%E5%8A%A1%E5%90%AF%E5%8A%A8%E9%97%AE%E9%A2%98/ class=post-nav-item rel=next title="总结  判断uwb服务启动问题">总结 判断uwb服务启动问题<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div class=post-reward><div class=comment></div><input type=checkbox class=reward-input name=reward id=fi-reward hidden>
<label class=reward-button for=fi-reward><i class="fa-solid fa-qrcode fa-fw" aria-hidden=true></i>赞赏</label><div class=reward-ways data-mode=static></div></div><div id=comments><div id=giscus class=comment><script src=https://giscus.app/client.js data-repo=huang8604/huang8604.github.io data-repo-id=R_kgDOMx3bEg data-category=Announcements data-category-id=DIC_kwDOMx3bEs4CigIp data-mapping=pathname data-strict=0 data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-loading=lazy crossorigin=anonymous async defer></script></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></article><aside class=toc id=toc-auto aria-label=目录><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside></main><footer class=footer><div class=footer-container><div class="footer-line powered">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.152.2"><img class=hugo-icon src=/images/hugo.min.svg alt="Hugo logo"> Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.3.20"><img class=fixit-icon src=/images/fixit.min.svg alt="FixIt logo"> FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2021 - 2025</span><span class=author itemprop=copyrightHolder>
<a href=https://github.com/huang8604 target=_blank rel="external nofollow noopener noreferrer">wentao</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class="variant-numeric d-none">0%</span></div><div class="fixed-button view-comments d-none" role=button aria-label=查看评论><i class="fa-solid fa-comment fa-fw" aria-hidden=true></i></div></div><div id=mask></div><noscript><div class=noscript-warning>该网站在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/lightgallery/css/lightgallery-bundle.min.css><link rel=preload href=/lib/katex/katex.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=/lib/katex/katex.min.css></noscript><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script src=/lib/autocomplete/autocomplete.min.js defer></script><script src=/lib/fuse/fuse.min.js defer></script><script src=/lib/instant-page/instantpage.min.js async defer type=module></script><script src=/lib/lightgallery/lightgallery.min.js defer></script><script src=/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js defer></script><script src=/lib/lightgallery/plugins/zoom/lg-zoom.min.js defer></script><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script>window.config={code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:199},comment:{enable:!0,expired:!1,giscus:{darkTheme:"dark",lightTheme:"light",origin:"https://giscus.app"}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{distance:100,findAllMatches:!1,fuseIndexURL:"/search.json",highlightTag:"em",ignoreFieldNorm:!1,ignoreLocation:!1,isCaseSensitive:!1,location:0,maxResultLength:10,minMatchCharLength:2,noResultsFound:"没有找到结果",snippetLength:50,threshold:.3,type:"fuse",useExtendedSearch:!1},version:"v0.3.20"}</script><script src=/js/theme.min.js defer></script><script src=/js/custom.min.js defer></script></body></html>