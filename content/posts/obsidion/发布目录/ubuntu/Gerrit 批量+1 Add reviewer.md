---
tags:
  - blog
  - å·¥å…·
  - å®æˆ˜
title: Gerrit æ‰¹é‡+1 Add reviewer
date: 2025-11-27T02:36:48.000Z
lastmod: 2025-11-27T02:36:48.000Z
---
å¾ˆé«˜å…´èƒ½å¸®ä½ è§£å†³é—®é¢˜ï¼è¿™æ®µç»å†éå¸¸å…¸å‹ï¼Œæ¶µç›–äº† **Gerrit å‘½ä»¤è¡Œæ“ä½œ**ã€**SSH äº¤äº’æœºåˆ¶**ä»¥åŠ **Shell è„šæœ¬ç¼–ç¨‹**çš„å‡ ä¸ªæ ¸å¿ƒå‘ç‚¹ã€‚

ä»¥ä¸‹æ˜¯æ•´ä¸ªè¿‡ç¨‹çš„å¤ç›˜ä¸æŠ€æœ¯æ€»ç»“ï¼Œæ–¹ä¾¿ä½ æ—¥åæŸ¥é˜…ï¼š

### ğŸš€ æœ€ç»ˆå¯è¿è¡Œçš„å®Œæ•´å‘½ä»¤

username æ›¿æ¢è‡ªå·±çš„ç”¨æˆ·å,éœ€è¦sshæäº¤å…¬é’¥

æè®®é€šè¿‡ä¸‹é¢æŸ¥çœ‹æ˜¯å¦å¯ä»¥

```
ssh -p 29418 username@172.17.2.20 gerrit query "owner:self status:open" --format=JSON
```

æœ€ç»ˆå‘½ä»¤

```bash
ssh -p 29418 username@172.17.2.20 gerrit query \
  "owner:self status:open NOT label:Code-Review<=-1" \
  --current-patch-set --format=JSON \
| jq -r 'select(.currentPatchSet) | "\(.id) \(.currentPatchSet.revision)"' \
| while read -r changeId commitSha; do
    echo "æ­£åœ¨å¤„ç†: $changeId"
    
    # 1. æ‰“åˆ† (ä½¿ç”¨ Commit SHA ç¡®ä¿å”¯ä¸€å®šä½)
    ssh -n -p 29418 username@172.17.2.20 gerrit review --code-review +1 "$commitSha"
    
    # 2. åŠ äºº (ä½¿ç”¨ Change-Id ç¡®ä¿å…¼å®¹æ€§)
    ssh -n -p 29418 username@172.17.2.20 gerrit set-reviewers \
      -a xxx@AAA.com \
      -a yyy@AAA.com \
      -a zzz@AAA.com \
      "$changeId"
done
```

***

### ğŸ’¡ é‡åˆ°çš„å‘ä¸è§£å†³æ–¹æ¡ˆ (Technical Retrospective)

æˆ‘ä»¬åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­è§£å†³äº†ä»¥ä¸‹ä¸‰ä¸ªä¸»è¦æŠ€æœ¯éšœç¢ï¼š

#### 1. æŸ¥è¯¢è¯­æ³•çš„å‚æ•°å†²çª

* **é—®é¢˜**ï¼šä½¿ç”¨ `-label:Code-Review<=-1` æ—¶æŠ¥é”™ `fatal: is not a valid option`ã€‚
* **åŸå› **ï¼šSSH è¿œç¨‹æ‰§è¡Œå‘½ä»¤æ—¶ï¼Œä¼šå°†ä»¥ `-` å¼€å¤´çš„å­—ç¬¦ä¸²è¯¯åˆ¤ä¸ºå‘½ä»¤è¡Œé€‰é¡¹ï¼ˆOptionsï¼‰ï¼Œè€Œä¸æ˜¯æŸ¥è¯¢è¯­å¥ã€‚
* **âœ… è§£å†³**ï¼šå°† `-` æ›¿æ¢ä¸ºå¤§å†™çš„ **`NOT`** å…³é”®å­—ï¼ˆGerrit æŸ¥è¯¢è¯­è¨€æ”¯æŒï¼‰ï¼Œé¿å…æ­§ä¹‰ã€‚

#### 2. Gerrit ç‰ˆæœ¬å…¼å®¹æ€§ä¸ ID å®šä½

* **é—®é¢˜**ï¼š
  * Gerrit v2.16 çš„ `gerrit review` å‘½ä»¤ä¸æ”¯æŒåŒæ—¶åŠ  Reviewer (`--reviewer` å‚æ•°æ— æ•ˆ)ã€‚
  * ä½¿ç”¨æ•°å­— ID (å¦‚ `83376`) æˆ– `ID,PatchSet` æ ¼å¼æ—¶ï¼ŒæŠ¥ `no such change/patch set`ã€‚
* **åŸå› **ï¼šæ—§ç‰ˆæœ¬ API é™åˆ¶ï¼›ä¸”æ•°å­— ID åœ¨æŸäº›æƒ…å†µä¸‹æ— æ³•ç²¾å‡†æ˜ å°„åˆ°å½“å‰çš„ Patch Setã€‚
* **âœ… è§£å†³**ï¼š
  * **æ‹†åˆ†åŠ¨ä½œ**ï¼šå°†æ“ä½œæ‹†åˆ†ä¸º `gerrit review` (æ‰“åˆ†) å’Œ `gerrit set-reviewers` (åŠ äºº)ã€‚
  * **ç²¾å‡†å®šä½**ï¼šæ‰“åˆ†æ—¶ä½¿ç”¨ **Commit SHA**ï¼ˆç‰©ç†å”¯ä¸€ï¼‰ï¼ŒåŠ äººæ—¶ä½¿ç”¨ **Change-Id**ï¼ˆé€»è¾‘å”¯ä¸€ï¼‰ã€‚

#### 3. SSH åå™¬æ ‡å‡†è¾“å…¥ (The SSH Loop Trap)

* **é—®é¢˜**ï¼šè„šæœ¬åªå¤„ç†äº†åˆ—è¡¨ä¸­çš„ç¬¬ä¸€æ¡è®°å½•å°±åœæ­¢äº†ã€‚
* **åŸå› **ï¼šåœ¨ `while` å¾ªç¯å†…éƒ¨æ‰§è¡Œ `ssh` æ—¶ï¼ŒSSH é»˜è®¤ä¼šè¯»å–æ‰€æœ‰çš„ Standard Input (stdin)ã€‚è¿™æ„å‘³ç€å¾ªç¯é‡Œçš„ç¬¬ä¸€ä¸ª `ssh` æŠŠç®¡é“é‡Œå‰©ä¸‹çš„ Change åˆ—è¡¨å…¨â€œåƒâ€å…‰äº†ï¼Œå¯¼è‡´ `while` å¾ªç¯ä»¥ä¸ºæ²¡æœ‰æ•°æ®äº†ã€‚
* **âœ… è§£å†³**ï¼šç»™å¾ªç¯å†…éƒ¨çš„ `ssh` å‘½ä»¤æ·»åŠ  **`-n`** å‚æ•°ã€‚è¿™å‘Šè¯‰ SSHï¼šâ€œä¸è¦è¯»å–æ ‡å‡†è¾“å…¥ï¼Œåªç®¡æ‰§è¡Œå‘½ä»¤â€ã€‚è¿™æ · stdin é‡Œçš„æ•°æ®å°±èƒ½ä¿ç•™ç»™ `while` å¾ªç¯ç»§ç»­è¯»å–ã€‚

#### 4. **æ•°æ®è§£æéƒ¨åˆ† (`| jq ...`)**ï¼š

* **é—®é¢˜**ï¼š
  * `jq -r 'select(.number) | .number'`ï¼š`gerrit query` æœ€åä¼šè¾“å‡ºä¸€è¡Œç»Ÿè®¡ä¿¡æ¯ï¼ˆstatsï¼‰ï¼Œè¿™è¡Œæ²¡æœ‰ `number` å­—æ®µã€‚è¿™æ®µä»£ç ä¼šè¿‡æ»¤æ‰ç»Ÿè®¡è¡Œï¼Œåªæå–å‡ºå˜æ›´ç¼–å· (Change Number)ã€‚
  * *æ³¨æ„ï¼šå¦‚æœæ²¡æœ‰å®‰è£… `jq`ï¼Œä½ éœ€è¦å…ˆå®‰è£…å®ƒ (å¦‚ `sudo apt-get install jq` æˆ– `brew install jq`)ï¼Œæˆ–è€…ä½¿ç”¨å¤æ‚çš„ grep/awk æ›¿æ¢ã€‚*

### ğŸ“š æ ¸å¿ƒé€»è¾‘æµç¨‹å›¾

1. **Query**: ç­›é€‰å‡º Owner æ˜¯ä½ ã€Open çŠ¶æ€ã€ä¸”æ²¡æœ‰è´Ÿåˆ†çš„æäº¤ã€‚
   * å‚æ•° `--current-patch-set` æ‹¿åˆ°äº†å…³é”®çš„ Commit SHAã€‚
2. **Parse (jq)**: æå–å‡ºæ¯ä¸€è¡Œçš„ `Change-Id` (Ixxxx...) å’Œ `Commit SHA` (9e36...)ã€‚
3. **Loop**:
   * **Step A**: `ssh -n ... review` -> é’ˆå¯¹ SHA æ‰“ +1ã€‚
   * **Step B**: `ssh -n ... set-reviewers` -> é’ˆå¯¹ Change-Id åŠ äººã€‚

è¿™æ¡å‘½ä»¤ç°åœ¨éå¸¸å¥å£®ï¼Œå³ä½¿ä»¥åä½ è¦æ‰¹é‡æ“ä½œå‡ ç™¾ä¸ªæäº¤ï¼Œå®ƒä¹Ÿèƒ½ç¨³å®šè¿è¡Œï¼
